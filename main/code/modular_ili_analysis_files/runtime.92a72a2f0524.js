(()=>{var e,t,s,i={42540:()=>{},35358:(e,t,s)=>{var i={"./af":25177,"./af.js":25177,"./ar":61509,"./ar-dz":41488,"./ar-dz.js":41488,"./ar-kw":58676,"./ar-kw.js":58676,"./ar-ly":42353,"./ar-ly.js":42353,"./ar-ma":2115,"./ar-ma.js":2115,"./ar-ps":6947,"./ar-ps.js":6947,"./ar-sa":82682,"./ar-sa.js":82682,"./ar-tn":89756,"./ar-tn.js":89756,"./ar.js":61509,"./az":95533,"./az.js":95533,"./be":28959,"./be.js":28959,"./bg":47777,"./bg.js":47777,"./bm":54903,"./bm.js":54903,"./bn":61290,"./bn-bd":17357,"./bn-bd.js":17357,"./bn.js":61290,"./bo":31545,"./bo.js":31545,"./br":11470,"./br.js":11470,"./bs":44429,"./bs.js":44429,"./ca":7306,"./ca.js":7306,"./cs":56464,"./cs.js":56464,"./cv":73635,"./cv.js":73635,"./cy":64226,"./cy.js":64226,"./da":93601,"./da.js":93601,"./de":77853,"./de-at":26111,"./de-at.js":26111,"./de-ch":54697,"./de-ch.js":54697,"./de.js":77853,"./dv":60708,"./dv.js":60708,"./el":54691,"./el.js":54691,"./en-au":53872,"./en-au.js":53872,"./en-ca":28298,"./en-ca.js":28298,"./en-gb":56195,"./en-gb.js":56195,"./en-ie":66584,"./en-ie.js":66584,"./en-il":65543,"./en-il.js":65543,"./en-in":9033,"./en-in.js":9033,"./en-nz":79402,"./en-nz.js":79402,"./en-sg":43004,"./en-sg.js":43004,"./eo":32934,"./eo.js":32934,"./es":97650,"./es-do":20838,"./es-do.js":20838,"./es-mx":17730,"./es-mx.js":17730,"./es-us":56575,"./es-us.js":56575,"./es.js":97650,"./et":3035,"./et.js":3035,"./eu":3508,"./eu.js":3508,"./fa":119,"./fa.js":119,"./fi":90527,"./fi.js":90527,"./fil":95995,"./fil.js":95995,"./fo":52477,"./fo.js":52477,"./fr":85498,"./fr-ca":26435,"./fr-ca.js":26435,"./fr-ch":37892,"./fr-ch.js":37892,"./fr.js":85498,"./fy":37071,"./fy.js":37071,"./ga":41734,"./ga.js":41734,"./gd":70217,"./gd.js":70217,"./gl":77329,"./gl.js":77329,"./gom-deva":32124,"./gom-deva.js":32124,"./gom-latn":93383,"./gom-latn.js":93383,"./gu":95050,"./gu.js":95050,"./he":11713,"./he.js":11713,"./hi":43861,"./hi.js":43861,"./hr":26308,"./hr.js":26308,"./hu":90609,"./hu.js":90609,"./hy-am":17160,"./hy-am.js":17160,"./id":74063,"./id.js":74063,"./is":89374,"./is.js":89374,"./it":88383,"./it-ch":21827,"./it-ch.js":21827,"./it.js":88383,"./ja":23827,"./ja.js":23827,"./jv":89722,"./jv.js":89722,"./ka":41794,"./ka.js":41794,"./kk":27088,"./kk.js":27088,"./km":96870,"./km.js":96870,"./kn":84451,"./kn.js":84451,"./ko":63164,"./ko.js":63164,"./ku":98174,"./ku-kmr":6181,"./ku-kmr.js":6181,"./ku.js":98174,"./ky":78474,"./ky.js":78474,"./lb":79680,"./lb.js":79680,"./lo":15867,"./lo.js":15867,"./lt":45766,"./lt.js":45766,"./lv":69532,"./lv.js":69532,"./me":58076,"./me.js":58076,"./mi":41848,"./mi.js":41848,"./mk":30306,"./mk.js":30306,"./ml":73739,"./ml.js":73739,"./mn":99053,"./mn.js":99053,"./mr":86169,"./mr.js":86169,"./ms":73386,"./ms-my":92297,"./ms-my.js":92297,"./ms.js":73386,"./mt":77075,"./mt.js":77075,"./my":72264,"./my.js":72264,"./nb":99893,"./nb.js":99893,"./ne":8235,"./ne.js":8235,"./nl":92572,"./nl-be":43784,"./nl-be.js":43784,"./nl.js":92572,"./nn":54566,"./nn.js":54566,"./oc-lnc":69330,"./oc-lnc.js":69330,"./pa-in":29849,"./pa-in.js":29849,"./pl":94418,"./pl.js":94418,"./pt":79834,"./pt-br":48303,"./pt-br.js":48303,"./pt.js":79834,"./ro":24457,"./ro.js":24457,"./ru":82271,"./ru.js":82271,"./sd":1221,"./sd.js":1221,"./se":33478,"./se.js":33478,"./si":17538,"./si.js":17538,"./sk":5784,"./sk.js":5784,"./sl":46637,"./sl.js":46637,"./sq":86794,"./sq.js":86794,"./sr":45719,"./sr-cyrl":3322,"./sr-cyrl.js":3322,"./sr.js":45719,"./ss":56e3,"./ss.js":56e3,"./sv":41011,"./sv.js":41011,"./sw":40748,"./sw.js":40748,"./ta":11025,"./ta.js":11025,"./te":11885,"./te.js":11885,"./tet":28861,"./tet.js":28861,"./tg":86571,"./tg.js":86571,"./th":55802,"./th.js":55802,"./tk":59527,"./tk.js":59527,"./tl-ph":29231,"./tl-ph.js":29231,"./tlh":31052,"./tlh.js":31052,"./tr":85096,"./tr.js":85096,"./tzl":79846,"./tzl.js":79846,"./tzm":81765,"./tzm-latn":97711,"./tzm-latn.js":97711,"./tzm.js":81765,"./ug-cn":48414,"./ug-cn.js":48414,"./uk":16618,"./uk.js":16618,"./ur":57777,"./ur.js":57777,"./uz":57609,"./uz-latn":72475,"./uz-latn.js":72475,"./uz.js":57609,"./vi":21135,"./vi.js":21135,"./x-pseudo":64051,"./x-pseudo.js":64051,"./yo":82218,"./yo.js":82218,"./zh-cn":52648,"./zh-cn.js":52648,"./zh-hk":1632,"./zh-hk.js":1632,"./zh-mo":31541,"./zh-mo.js":31541,"./zh-tw":50304,"./zh-tw.js":50304};function n(e){var t=a(e);return s(t)}function a(e){if(!s.o(i,e)){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}return i[e]}n.keys=function(){return Object.keys(i)},n.resolve=a,e.exports=n,n.id=35358},57292:(e,t,s)=>{"use strict";s.d(t,{$:()=>r});var i=s(91326),n=s(37363),a=s(99217),o=s(2430);class r{constructor(e){this.theme=i.A.theme,this.config=e,this.button=null,this.svgPathData=e.svgPathData||null,this.svgViewBox=e.svgViewBox||"0 0 512 512",this.onClickCallback=null,this.enableEnterKey=e.enableEnterKey||!1,this.loading=!1,this.iconDiv=null,this.textDiv=null,this.originalIconElement=null,this.data={},Object.keys(e).forEach((t=>{["text","type","size","disabled","icon","image","iconHeightAndWidth","truncateMobile","enableEnterKey","svgPathData","svgViewBox","ariaLabel","ariaPressed"].includes(t)||(this.data[t]=e[t])})),this.init()}init(){this.buildButton(),this.addButtonClickHandler()}buildButton(){this.button=document.createElement("button"),this.button.type="button",this.config.ariaLabel&&this.button.setAttribute("aria-label",this.config.ariaLabel),this.config.ariaPressed&&this.button.setAttribute("aria-pressed",this.config.ariaPressed);const e=this.getButtonSize(),t=this.getButtonStyle(),s=this.getButtonWidth(),i=[t,e,"flex gap-1 items-center justify-center","select-none"];this.config.iconHeightAndWidth?i.push(this.config.iconHeightAndWidth):i.push(s),this.config.additionalClasses&&i.push(...this.config.additionalClasses.split(" ").filter(Boolean)),this.button.className=i.filter(Boolean).join(" "),this.config.hoverText&&(this.button.classList.contains("relative")||this.button.classList.add("relative"));const o=this.config.icon||this.config.image||this.svgPathData;if(o&&this.config.text){if(this.iconDiv=document.createElement("div"),this.iconDiv.className="flex items-center justify-center",this.svgPathData){const e={pathData:this.svgPathData,viewBox:this.svgViewBox,sizeClasses:this.getIconSizeForSvg()};"link"===this.config.type&&(e.colorClass="fill-current");const t=new a.I(e);this.originalIconElement=t.element.cloneNode(!0),this.iconDiv.appendChild(t.element)}else if(this.config.image){const e=document.createElement("img");e.src=this.config.image,e.classList.add("rounded-full","object-cover",...this.getImageSize().split(" ")),e.alt="button image",this.originalIconElement=e.cloneNode(!0),this.iconDiv.appendChild(e)}this.textDiv=document.createElement("div"),this.textDiv.innerText=this.config.text,this.config.truncateMobile?this.textDiv.className="hidden sm:block max-w-[80px] sm:max-w-[100px] truncate":this.config.containerResponsive&&(this.textDiv.className="max-w-[80px] sm:max-w-[100px] truncate"),this.button.appendChild(this.iconDiv),this.button.appendChild(this.textDiv)}else if(o&&!this.config.text){if(this.iconDiv=document.createElement("div"),this.iconDiv.className="flex items-center justify-center",this.svgPathData){const e={pathData:this.svgPathData,viewBox:this.svgViewBox,sizeClasses:this.getIconSizeForSvg()};"link"===this.config.type&&(e.colorClass="fill-current");const t=new a.I(e);this.originalIconElement=t.element.cloneNode(!0),this.iconDiv.appendChild(t.element)}else if(this.config.icon){const e=document.createElement("i");e.className=this.config.icon,this.originalIconElement=e.cloneNode(!0),this.iconDiv.appendChild(e)}else if(this.config.image){const e=document.createElement("img");e.src=this.config.image,e.classList.add("rounded-full","object-cover",...this.getImageSize().split(" ")),e.alt="button image",this.originalIconElement=e.cloneNode(!0),this.iconDiv.appendChild(e)}this.button.appendChild(this.iconDiv)}else this.textDiv=document.createElement("div"),this.textDiv.innerText=this.config.text,this.config.containerResponsive?this.textDiv.className="max-w-[80px] sm:max-w-[100px] truncate":this.config.truncateMobile?this.textDiv.className="hidden sm:block max-w-[80px] sm:max-w-[100px] truncate":this.textDiv.className="inline-block",this.button.appendChild(this.textDiv);if(this.config.hoverText&&!n.K.isMobile()){let e;this.hoverTextContainer=document.createElement("div"),this.hoverTextContainer.classList=`absolute flex items-center justify-center px-1.5 py-1 rounded-md ${this.theme.background} ring-1 ${this.theme.memoryItemRing} max-w-[200px] truncate overflow-hidden opacity-0 invisible z-50 transition-opacity duration-300 ease-in-out`,this.hoverText=document.createElement("div"),this.hoverText.classList="flex flex-col text-sm font-medium w-full truncate",this.hoverText.textContent=this.config.hoverText,this.hoverTextContainer.appendChild(this.hoverText),this.positionHoverText=()=>{const e=this.button.getBoundingClientRect();this.hoverTextContainer.style.visibility="hidden",this.hoverTextContainer.style.display="block";const t=this.hoverTextContainer.getBoundingClientRect();this.hoverTextContainer.style.visibility="",this.hoverTextContainer.style.display="";let s=e.left,i=e.bottom+5;s+t.width>window.innerWidth-5&&(s=Math.min(e.right-t.width,window.innerWidth-t.width-5)),i+t.height>window.innerHeight-5&&(i=e.top-t.height-5),s=Math.max(5,s),i=Math.max(5,i),this.hoverTextContainer.style.position="fixed",this.hoverTextContainer.style.left=`${s}px`,this.hoverTextContainer.style.top=`${i}px`};const t=400;this.button.addEventListener("mouseenter",(()=>{clearTimeout(e),this.hoverTextContainer.classList.contains("invisible")&&(e=setTimeout((()=>{this.hoverTextContainer.classList.remove("invisible"),this.positionHoverText(),requestAnimationFrame((()=>{this.hoverTextContainer.classList.remove("opacity-0")}))}),t))})),this.button.addEventListener("mouseleave",(()=>{clearTimeout(e),this.hoverTextContainer.classList.add("opacity-0"),setTimeout((()=>{this.button.matches(":hover")||(this.hoverTextContainer.classList.add("invisible"),this.hoverTextContainer.style.position="",this.hoverTextContainer.style.left="",this.hoverTextContainer.style.top="")}),300)})),document.body.appendChild(this.hoverTextContainer)}return this.button.disabled=this.config.disabled,this.config.disabled&&this.button.classList.add("opacity-50"),this.button}render(e){e&&e.appendChild(this.button)}addButtonClickHandler(){this.button.addEventListener("click",(e=>{e.stopPropagation(),this.clickButton()}))}getButtonStyle(){switch(this.config.type){case"primary":return`${i.A.theme.primaryButton} rounded-md `;case"secondary":return`${i.A.theme.secondaryButton} rounded-md`;case"primaryTransparent":return`rounded-md ${i.A.theme.primaryButtonTransparent} ${i.A.theme.text}`;case"secondaryTransparent":return`rounded-md ${i.A.theme.secondaryButtonTransparent}`;case"ringPrimary":return`rounded-md ring-2 ${i.A.theme.ringButton} ${i.A.theme.text}`;case"ringSecondary":return`rounded-md ring-2 ${i.A.theme.ringSecondaryButton}`;case"ringInput":return`rounded-md ring-1 ${i.A.theme.ringSecondaryButton}`;case"focus":return`rounded-md ${i.A.theme.focusButton} opacity-80 hover:opacity-100 text-xs ${i.A.theme.text}`;case"link":return`${i.A.theme.linkButton}`;case"linkText":return`${i.A.theme.text}`}}getButtonSize(){switch(this.config.size){case"icon":case"link-xs":return"text-xs font-medium";case"icon-lg":case"link-sm":return"text-sm font-medium";case"extraSmall":return"px-2 py-0.5 text-sm font-medium";case"small":return"px-2 py-1 text-sm font-medium";case"xSmallMobile":case"smallMobile":return"px-2 py-1 text-sm font-medium h-7";case"topMenu":return"px-1.5 py-1 text-sm font-medium h-7";case"medium":default:return"px-3 py-1.5 text-sm font-medium";case"large":return"px-3 py-2 text-base font-medium";case"extraLarge":return"px-4 py-2 text-lg font-medium";case"link-base":return"text-base font-medium";case"link-lg":return"text-lg font-medium"}}set image(e){this.iconDiv&&(this.iconDiv.innerHTML=`<img src="${e}" class="rounded-full object-cover ${this.getImageSize()}" alt="button image">`)}getImageSize(){switch(this.config.size){case"icon":case"extraSmall":return"w-4";case"small":case"smallMobile":case"medium":case"topMenu":default:return"w-5";case"large":return"w-6"}}getButtonWidth(){return"full"===this.config.width?"w-full":"w-auto"}set text(e){this.textDiv&&(this.textDiv.textContent=e)}set icon(e){this.iconDiv&&(this.iconDiv.innerHTML=`<i class="${e}"></i>`)}setSvgIcon(e,t=null){if(!this.iconDiv)return;this.svgPathData=e,this.svgViewBox=t||this.svgViewBox||"0 0 512 512",this.iconDiv.innerHTML="";const s={pathData:this.svgPathData,viewBox:this.svgViewBox,sizeClasses:this.getIconSizeForSvg(),additionalClasses:""};"link"===this.config.type&&(s.colorClass="fill-current");const i=new a.I(s);this.iconDiv.appendChild(i.element),this.originalIconElement=i.element.cloneNode(!0),this.loading&&this.toggleLoading()}hideButton(){this.button.style.display="none"}showButton(){this.button.style.display="block"}disableButton(){this.button.disabled||(this.button.disabled=!0,this.button.classList.add("opacity-50"))}setDisabled(e){e?this.disableButton():this.enableButton()}enableButton(){this.button.disabled&&(this.button.disabled=!1,this.button.classList.remove("opacity-50"))}toggleLoading(e=null){if(this.button)if(this.loading){if(this.iconDiv&&this.originalIconElement)this.iconDiv.innerHTML="",this.iconDiv.appendChild(this.originalIconElement.cloneNode(!0));else if(this.iconDiv&&!this.originalIconElement&&(this.config.icon||this.config.image||this.svgPathData))if(this.svgPathData){const e=new a.I({pathData:this.svgPathData,viewBox:this.svgViewBox,sizeClasses:this.getIconSizeForSvg()});this.iconDiv.innerHTML="",this.iconDiv.appendChild(e.element)}else this.config.icon?this.iconDiv.innerHTML=`<i class="${this.config.icon}"></i>`:this.config.image&&(this.iconDiv.innerHTML=`<img src="${this.config.image}" class="rounded-full object-cover ${this.getImageSize()}" alt="button image">`);this.textDiv&&(this.textDiv.innerHTML=this.config.text||""),this.config.disabled||this.enableButton(),this.loading=!1}else{const t=o.A.name("spinner");if(!t||!t.path||!t.viewBox)return;const s=`<svg viewBox="${t.viewBox}" class="${this.getIconSizeForSvg()} inline-block fill-current animate-spin" aria-hidden="true" focusable="false"><path d="${t.path}"></path></svg>`;if(this.iconDiv&&(!this.originalIconElement&&this.iconDiv.firstChild&&(this.originalIconElement=this.iconDiv.firstChild.cloneNode(!0)),this.iconDiv.innerHTML=s),this.textDiv){let t=this.config.text||"";"string"==typeof e&&e&&(t=e),this.textDiv.innerHTML=this.iconDiv?t:`${s} ${t}`}else this.iconDiv||this.textDiv||(this.button.innerHTML=s);this.disableButton(),this.loading=!0}}getBoundingClientRect(){return this.button?this.button.getBoundingClientRect():new DOMRect}contains(e){return!!this.button&&this.button.contains(e)}get element(){return this.button}clickButton(){this.hoverTextContainer&&this.hoverTextContainer.classList.add("opacity-0","invisible"),"function"==typeof this.onClickCallback&&this.onClickCallback()}onClick(e){"function"==typeof e&&(this.onClickCallback=e)}destroy(){this.hoverTextContainer?.remove(),this.hoverTextContainer=null,this.hoverText=null,this.button?.remove(),this.button=null,this.onClickCallback=null,this.loading=!1,this.iconDiv=null,this.textDiv=null,this.originalIconElement=null,this.data={}}getData(e){return this.data[e]}setData(e,t){this.data[e]=t}getIconSizeForSvg(){switch(this.config.size){case"icon":case"extraSmall":case"xSmallMobile":case"link-xs":return"w-3.5 h-3.5";case"small":return"w-3 h-3";case"smallMobile":case"topMenu":case"link-sm":case"medium":default:return"w-4 h-4";case"link-base":case"large":case"link-lg":case"icon-lg":return"w-5 h-5"}}set ariaLabel(e){this.button&&(this.config.ariaLabel=e,this.button.setAttribute("aria-label",e))}get ariaLabel(){return this.button?this.button.getAttribute("aria-label"):this.config.ariaLabel}set ariaPressed(e){if(this.button){const t=String(e);this.config.ariaPressed=t,this.button.setAttribute("aria-pressed",t)}}get ariaPressed(){return this.button?this.button.getAttribute("aria-pressed"):this.config.ariaPressed}}},51308:(e,t,s)=>{"use strict";s.d(t,{N:()=>o});class i{constructor(e=0,t=0){this.x=e,this.y=t}}class n{constructor(e){this.size=new i(16*Math.random()+4,4*Math.random()+4),this.position=new i(e.x-this.size.x/2,e.y-this.size.y/2),this.velocity=n.generateVelocity(),this.rotation=360*Math.random(),this.rotationSpeed=10*(Math.random()-.5),this.hue=360*Math.random(),this.opacity=100,this.lifetime=Math.random()+.25}static generateVelocity(){const e=Math.random()-.5,t=Math.random()-.7,s=Math.sqrt(e*e+t*t);return new i(e/s*Math.random()*o.config.explosionPower,t/s*Math.random()*o.config.explosionPower)}update(e){this.velocity.y+=o.config.gravity*(this.size.y/(10*o.config.particleSize))*e,this.velocity.x+=25*(Math.random()-.5)*e,this.velocity.y*=.98,this.velocity.x*=.98,this.position.x+=this.velocity.x,this.position.y+=this.velocity.y,this.rotation+=this.rotationSpeed,o.config.fade&&(this.opacity-=this.lifetime)}checkBounds(){return this.position.y-2*this.size.x>2*window.innerHeight}draw(e){e.save(),e.beginPath(),e.translate(this.position.x+this.size.x/2,this.position.y+this.size.y/2),e.rotate(this.rotation*Math.PI/180),e.rect(-this.size.x/2,-this.size.y/2,this.size.x,this.size.y),e.fillStyle=`hsla(${this.hue}deg, 90%, 65%, ${this.opacity}%)`,e.fill(),e.restore()}}class a{constructor(e){this.particles=Array.from({length:o.config.particleCount},(()=>new n(e)))}update(e){for(let t=this.particles.length-1;t>=0;t--)this.particles[t].update(e),this.particles[t].checkBounds()&&this.particles.splice(t,1)}draw(e){this.particles.forEach((t=>t.draw(e)))}}class o{static config={gravity:10,particleCount:75,particleSize:1,explosionPower:25,fade:!1};constructor(){this.bursts=[],this.ctx=this.setupCanvasContext(),this.time=(new Date).getTime(),this.deltaTime=0,this.update(this.time),window.requestAnimationFrame(this.update.bind(this)),setTimeout((()=>{this.showConfetti()}),500)}setupCanvasContext(){const e=document.createElement("canvas"),t=e.getContext("2d");return e.width=window.innerWidth,e.height=window.innerHeight,e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="calc(100%)",e.style.height="calc(100%)",e.style.margin="0",e.style.padding="0",e.style.zIndex="999999999",e.style.pointerEvents="none",document.body.appendChild(e),window.addEventListener("resize",(()=>{e.width=2*window.innerWidth,e.height=2*window.innerHeight})),t}showConfetti(){let e,t;e=window.innerWidth/2,t=window.innerHeight/2;const s=new i(e,t);this.bursts.push(new a(s))}update(e){this.deltaTime=(e-this.time)/1e3,this.time=e,this.ctx.clearRect(0,0,2*window.innerWidth,2*window.innerHeight);for(let e=this.bursts.length-1;e>=0;e--)this.bursts[e].update(this.deltaTime),0===this.bursts[e].particles.length&&this.bursts.splice(e,1);this.bursts.forEach((e=>e.draw(this.ctx))),window.requestAnimationFrame(this.update.bind(this))}}},99217:(e,t,s)=>{"use strict";s.d(t,{I:()=>n});var i=s(91326);class n{constructor(e){i.A.theme;this.config={viewBox:"0 0 512 512",sizeClasses:"w-5 h-5",colorClass:e.colorClass||"fill-current",additionalClasses:"",...e},this.config.pathData?(this.svgElement=null,this.init()):this.svgElement=null}init(){this.buildIcon()}buildIcon(){this.svgElement=document.createElementNS("http://www.w3.org/2000/svg","svg"),this.svgElement.setAttribute("viewBox",this.config.viewBox),this.svgElement.setAttribute("aria-hidden","true"),this.svgElement.setAttribute("focusable","false");const e=[this.config.sizeClasses,this.config.colorClass,"fill-current","pointer-events-none",...this.config.additionalClasses?this.config.additionalClasses.split(" "):[]].filter(Boolean).join(" ");e&&this.svgElement.setAttribute("class",e);const t=document.createElementNS("http://www.w3.org/2000/svg","path");t.setAttribute("d",this.config.pathData),this.svgElement.appendChild(t)}get element(){return this.svgElement}render(e){e&&this.svgElement&&e.appendChild(this.svgElement)}}},99273:(e,t,s)=>{"use strict";s.d(t,{y:()=>o});var i=s(91326),n=s(99217),a=s(2430);class o{static container=null;static ensureContainer(){o.container||(o.container=document.createElement("div"),o.container.classList.add("fixed","top-[50px]","z-50","space-y-2","max-w-[600px]","w-full","px-4","flex","flex-col","left-1/2","transform","-translate-x-1/2","items-center","md:left-auto","md:right-3","md:transform-none","md:items-end","md:w-auto","md:px-0"),document.body.appendChild(o.container))}constructor(e,t="success",s=!0,n=!0,a=5e3){this.message=e,this.type=t,this.allowClose=s,this.autoClose=n,this.duration=a,this.theme=i.A.theme,this.init()}init(){o.ensureContainer(),this.toast=document.createElement("div"),this.toast.classList=`rounded-md p-2 shadow-md ${this.getToastType()} inline-flex justify-between items-center align-middle gap-4`,this.iconAndMessageContainer=document.createElement("div"),this.iconAndMessageContainer.classList.add("flex","gap-2","items-center");const e=this.getToastIconName(),t=a.A.name(e),s=new n.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-5 h-5",colorClass:"fill-current"});if(this.messageContainer=document.createElement("div"),this.messageContainer.classList.add("max-w-[600px]","min-w-[200px]"),this.messageContainer.innerHTML=this.message,this.allowClose){this.closeButton=document.createElement("button"),this.closeButton.type="button",this.closeButton.classList.add("text-sm","rounded-full","p-1","flex","items-center","justify-center");const e=a.A.name("tabClose"),t=new n.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",colorClass:"fill-current"});this.closeButton.appendChild(t.element),this.closeButton.addEventListener("click",(()=>this.close()))}this.iconAndMessageContainer.appendChild(s.element),this.iconAndMessageContainer.appendChild(this.messageContainer),this.toast.appendChild(this.iconAndMessageContainer),this.allowClose&&this.toast.appendChild(this.closeButton),o.container.appendChild(this.toast),this.autoClose&&setTimeout((()=>this.close()),this.duration||5e3)}close(){this.toast.remove(),o.container&&!o.container.hasChildNodes()&&(o.container.remove(),o.container=null)}getToastType(){switch(this.type){case"success":return this.theme.toastSuccess;case"error":return this.theme.toastError;case"warning":return this.theme.toastWarning;default:return this.theme.toastInfo}}getToastIconName(){switch(this.type){case"success":return"success";case"error":return"error";case"warning":return"warning";default:return"info"}}}},57093:(e,t,s)=>{"use strict";s.d(t,{g:()=>a});var i=s(14574),n=s(37363);class a{constructor(){this.modalElement=null,this.formElements={},this.hasUnsavedChanges=!1,this.showSalesModal()}showSalesModal(){const e="enterprise-sales-modal";if(document.getElementById(e))return;this.modalElement=document.createElement("div"),this.modalElement.id=e,this.modalElement.className="fixed inset-0 z-50 flex items-center justify-center p-4",this.modalElement.innerHTML='\n            <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm"></div>\n            <div class="relative w-full max-w-3xl bg-white rounded-lg shadow-xl flex flex-col max-h-[90vh]">\n                <div class="flex justify-between items-center p-6 border-b border-gray-200">\n                    <h2 class="text-2xl font-semibold text-gray-900">Enterprise sales</h2>\n                    <button id="modal-close-x" class="text-gray-400 hover:text-gray-600 transition-colors">\n                        <i class="fa-solid fa-times fa-lg"></i>\n                    </button>\n                </div>\n                <div id="modal-body" class="p-6 overflow-y-auto"></div>\n                <div class="flex justify-between items-center p-6 border-t border-gray-200 bg-gray-50 rounded-b-lg">\n                    <div id="modal-notification" class="text-sm font-medium"></div>\n                    <button id="modal-submit" class="w-full sm:w-auto px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors disabled:bg-gray-400">\n                        Submit\n                    </button>\n                </div>\n            </div>\n        ',document.body.appendChild(this.modalElement);this.modalElement.querySelector("#modal-body").appendChild(this.createSalesModalBody()),this.modalElement.querySelector("#modal-backdrop").addEventListener("click",(()=>this.close())),this.modalElement.querySelector("#modal-close-x").addEventListener("click",(()=>this.close())),this.modalElement.querySelector("#modal-submit").addEventListener("click",(()=>this.submitForm()))}createSalesModalBody(){const e=document.createElement("div");e.className="flex flex-col gap-6",e.id="sales-inquiry-form";const t=document.createElement("p");t.className="text-gray-600 text-base",t.textContent="Please provide the following information to help us understand your needs. Our team will review your requirements and contact you to discuss custom pricing and deployment options.",e.appendChild(t);const s=n.K._user;return[{id:"companyName",label:"Company name",placeholder:"Enter your company name",required:!0},{id:"productInterest",label:"Which workspace type are you interested in?",type:"select",required:!0,options:[{value:"",label:"Select workspace type",disabled:!0},{value:"enterprise",label:"Enterprise Workspace"},{value:"education",label:"Education Workspace"},{value:"government",label:"Government Workspace"},{value:"nonprofit",label:"Not-for-profit Workspace"}]},{id:"companySize",label:"Company size",type:"select",required:!0,options:[{value:"",label:"Select company size",disabled:!0},{value:"100-500",label:"100-500 employees"},{value:"501-1000",label:"501-1,000 employees"},{value:"1001-5000",label:"1,001-5,000 employees"},{value:"5001-10000",label:"5,001-10,000 employees"},{value:"10000+",label:"10,000+ employees"}]},{id:"seatsRequired",label:"How many seats do you need?",type:"select",required:!0,options:[{value:"",label:"Select number of seats",disabled:!0},{value:"100-250",label:"100-250 seats"},{value:"251-500",label:"251-500 seats"},{value:"501-1000",label:"501-1,000 seats"},{value:"1000+",label:"1,000+ seats"}]},{id:"deploymentPreference",label:"Deployment preference",type:"select",required:!0,helpText:"Choose between our secure cloud solution or a dedicated deployment",options:[{value:"",label:"Select deployment type",disabled:!0},{value:"cloud",label:"Secure Cloud (Multi-tenant)"},{value:"dedicated",label:"Dedicated Deployment (Single tenant)"},{value:"undecided",label:"Not sure yet - need more information"}]},{id:"budgetRange",label:"Project budget range",type:"select",required:!0,options:[{value:"",label:"Select budget range",disabled:!0},{value:"50k-100k",label:"$50,000 - $100,000"},{value:"100k-250k",label:"$100,000 - $250,000"},{value:"250k-500k",label:"$250,000 - $500,000"},{value:"500k-1m",label:"$500,000 - $1,000,000"},{value:"1m+",label:"$1,000,000+"}]},{id:"trainingInterest",label:"Are you interested in professional training for your team?",type:"select",required:!0,helpText:"To improve adoption and productivity we can provide professional short courses and certification for your team.",options:[{value:"",label:"Select training preference",disabled:!0},{value:"yes_comprehensive",label:"Yes - Comprehensive training program"},{value:"yes_basic",label:"Yes - Basic onboarding training"},{value:"maybe",label:"Maybe - Would like to discuss options"},{value:"no",label:"No - Not needed at this time"}]},{id:"projectGoals",label:"Project goals & requirements",type:"textarea",rows:4,placeholder:"Please describe your project goals, timeline, and any specific requirements or questions you have",required:!0,helpText:"Include details about your use case, timeline, and any specific requirements"},{id:"contactDetailsTitle",type:"title",label:"Contact details"},{id:"contactName",label:"Full name",placeholder:"Enter your full name",required:!0,value:s?`${s.first_name||""} ${s.last_name||""}`.trim():""},{id:"contactRole",label:"Role",placeholder:"e.g. AI Leadership, CTO, IT Director",required:!0},{id:"contactEmail",label:"Work email",type:"email",placeholder:"Enter your work email",required:!0,value:s?s.email:""},{id:"contactPhone",label:"Best contact number",type:"tel",placeholder:"Enter your phone number",required:!0}].forEach((t=>{e.appendChild(this._createField(t))})),e}_createField(e){const t=document.createElement("div");if("title"===e.type)return t.className="text-lg font-semibold text-gray-900 pt-4 border-t border-gray-200",t.textContent=e.label,t;t.className="flex flex-col gap-1";const s=document.createElement("label");let i;s.htmlFor=e.id,s.className="block text-sm font-medium text-gray-700",s.textContent=e.label,e.required&&(s.innerHTML+=' <span class="text-red-500">*</span>'),t.appendChild(s);const n="block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm";if("select"===e.type?(i=document.createElement("select"),i.className=n,e.options.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,e.disabled&&(t.disabled=!0),""===e.value&&(t.selected=!0),i.appendChild(t)}))):"textarea"===e.type?(i=document.createElement("textarea"),i.className=n,i.rows=e.rows||4,i.placeholder=e.placeholder||""):(i=document.createElement("input"),i.className=n,i.type=e.type||"text",i.placeholder=e.placeholder||"",i.value=e.value||""),i.id=e.id,i.dataset.label=e.label,e.required&&(i.required=!0),t.appendChild(i),this.formElements[e.id]=i,e.helpText){const s=document.createElement("p");s.className="text-xs text-gray-500",s.textContent=e.helpText,t.appendChild(s)}const a=document.createElement("p");return a.id=`${e.id}-error`,a.className="text-red-600 text-xs mt-1 hidden",t.appendChild(a),i.addEventListener("input",(()=>{this.hasUnsavedChanges=!0,i.classList.remove("border-red-500"),a.classList.add("hidden")})),t}async submitForm(){if(this._clearNotification(),!this.validateForm())return void this._showNotification("Please fill out all required fields.","error");const e=this.modalElement.querySelector("#modal-submit");e.disabled=!0,e.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Submitting...';const t=Object.keys(this.formElements).reduce(((e,t)=>(e[t.replace(/([A-Z])/g,"_$1").toLowerCase()]=this.formElements[t].value,e)),{});try{const s=await i.G.postData("/accounts/submit-enterprise-sales-form/",t);if("success"!==s.status)throw new Error(s.message||"Submission failed.");this.hasUnsavedChanges=!1,this._showNotification("Thanks! We'll be in touch soon.","success"),e.innerHTML='<i class="fa-solid fa-check"></i> Success!',setTimeout((()=>this.close()),2e3)}catch(t){this._showNotification("We could not submit the form. Please try again or email support@simtheory.ai","error"),e.disabled=!1,e.textContent="Submit"}}validateForm(){let e=!0;for(const t in this.formElements){const s=this.formElements[t],i=document.getElementById(`${t}-error`);s.classList.remove("border-red-500"),i&&i.classList.add("hidden"),s.required&&!s.value.trim()?(e=!1,s.classList.add("border-red-500"),i&&(i.textContent=`${s.dataset.label} is required.`,i.classList.remove("hidden"))):"email"===s.type&&s.value&&!/^\S+@\S+\.\S+$/.test(s.value)&&(e=!1,s.classList.add("border-red-500"),i&&(i.textContent="Please enter a valid email address.",i.classList.remove("hidden")))}return e}_showNotification(e,t="error"){const s=this.modalElement.querySelector("#modal-notification");s&&(s.textContent=e,s.className="success"===t?"text-sm font-medium text-green-600":"text-sm font-medium text-red-600")}_clearNotification(){const e=this.modalElement.querySelector("#modal-notification");e&&(e.textContent="")}close(){this.hasUnsavedChanges&&!window.confirm("You have unsaved changes. Are you sure you want to close?")||this.modalElement&&(this.modalElement.remove(),this.modalElement=null)}}},14574:(e,t,s)=>{"use strict";s.d(t,{G:()=>n});var i=s(85113);class n{static async fetchData(e,t={}){try{const s=await fetch(e,t),i=s.headers.get("content-type");if(i&&-1!==i.indexOf("application/json")){return await s.json()}return await s.text()}catch(e){throw e}}static async postData(e,t){const s={method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":(0,i.R)("csrftoken")},body:JSON.stringify(t),json:!0};return this.fetchData(e,s)}static async postDataWithBlob(e,t){const s=await fetch(e,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":(0,i.R)("csrftoken"),Accept:"text/csv"},body:JSON.stringify(t),credentials:"same-origin"});if(!s.ok){const e=await s.text();throw new Error(`Network response was not ok: ${s.status} ${s.statusText} - ${e}`)}return s.blob()}static async uploadFile(e){const t={method:"POST",headers:{"X-CSRFToken":(0,i.R)("csrftoken")},body:e};return this.fetchData("/chat/upload_files/",t)}}},99687:(e,t,s)=>{"use strict";var i=s(91326),n=s(57292);class a{constructor(e,t){this.title=e,this.body=t,this.confirm=null,this.cancel=null,this.init()}init(){this.modal=new l({size:"small",title:this.title,body:this.body,closeX:!1,confirm:!0,cancel:!0,confirmText:"Confirm",cancelText:"Cancel",buttonWidth:"full",buttonSize:"large"}),this.modal.onConfirm((()=>{"function"==typeof this.confirmCallback&&this.confirmCallback()})),this.modal.onClose((()=>{"function"==typeof this.cancelCallback&&this.cancelCallback()}))}confirmCallback(){"function"==typeof this.confirm&&this.confirm()}cancelCallback(){"function"==typeof this.cancel&&this.cancel()}onConfirm(e){this.confirm=e}onCancel(e){this.cancel=e}}var o=s(2430),r=s(99217);class l{static modalCount=0;constructor(e){l.modalCount++,this.theme=i.A.theme,this.size=e.size,"small"!==this.size&&"medium"!==this.size&&"large"!==this.size&&"extraLarge"!==this.size&&(this.size="medium"),this.confirmButtonEnabled=!0,this.disableScroll=e.disableScroll,this.disableXPadding=e.disableXPadding,this.disableBPadding=e.disableBPadding,this.closeX=e.closeX,this.confirmOnExit=e.confirmOnExit,this.confirmButton=e.confirm,this.cancelButton=e.cancel,this.confirmText=e.confirmText,this.cancelText=e.cancelText,this.higherX=e.higherX||!1,this.centerTitle=e.centerTitle||!1,this.manualCloseOnConfirm=e.manualCloseOnConfirm||!1,this.buttonWidth=e.buttonWidth,this.buttonStyleConfirm=e.buttonStyleConfirm,this.buttonStyleCancel=e.buttonStyleCancel,this.buttonSize=e.buttonSize,this.onCloseCallback=e.onClose||null,this.onConfirmCallback=e.onConfirm||null,this.validationFunction=e.validationFunction||null,this.title=e.title,this.body=e.body,this.modalContainer=null,this.modalBackground=null,this.modal=null,this.modalContent=null,this.closeButton=null,this.modalTitle=null,this.modalBody=null,this.modalButtonContainer=null,this.unSavedChanges=!1,this.waiting=!1,this.isConfirmLoading=!1,this.boundClose=this.close.bind(this),this.boundConfirm=this.confirm.bind(this),this.boundHandleKeyDown=this.handleKeyDown.bind(this),this.render()}render(){switch(this.size){case"small":this.size="max-w-[400px]";break;case"medium":this.size="max-w-[600px]";break;case"large":this.size="max-w-[720px]";break;case"extraLarge":this.size="max-w-[900px]"}if(this.modalContainer=document.createElement("div"),this.modalBackground=document.createElement("div"),this.modalBackground.className=`fixed top-0 right-0 bottom-0 left-0 w-full h-screen ${this.theme.modalFadeBackground} backdrop-blur-xs flex items-center justify-center`,this.modalBackground.style.zIndex=40+2*l.modalCount,this.modal=document.createElement("div"),this.modal.className=`absolute top-1/4 left-1/2 transform -translate-x-1/2 -translate-y-1/4 ${this.theme.modalBackground} rounded-md w-[calc(100%-1rem)] md:w-[calc(100%-5rem)] ${this.size} flex drop-shadow-lg`,this.modal.style.zIndex=41+2*l.modalCount,this.modalContent=document.createElement("div"),this.modalContent.className=`my-auto w-full ${this.theme.text} relative`,this.closeX){this.closeButton=document.createElement("div"),this.closeButton.className="absolute top-4 right-3 z-10";const e=o.A.name("tabClose"),t=new n.$({svgPathData:e.path,svgViewBox:e.viewBox,type:"focus",size:"small",iconHeightAndWidth:"h-6 w-6"});t.onClick(this.boundClose),t.render(this.closeButton)}this.modalTitle=document.createElement("div"),this.modalTitle.classList.add("font-bold","text-lg","leading-6","pt-5","pb-2","px-6"),this.centerTitle&&this.modalTitle.classList.add("text-center"),this.modalTitle.innerHTML=this.title,this.modalBody=document.createElement("div"),this.modalBody.classList.add("break-words"),this.disableBPadding||this.modalBody.classList.add("pb-4"),this.disableXPadding||this.modalBody.classList.add("px-6"),this.disableScroll||this.modalBody.classList.add("max-h-[calc(60vh)]","overflow-y-auto"),this.confirmButton&&this.cancelButton&&(this.modalButtonContainer=document.createElement("div"),this.modalButtonContainer.classList.add("flex","gap-2","justify-end","px-6","pb-6","mt-2"),this.modalContent.appendChild(this.modalButtonContainer)),this.confirmButton&&!this.cancelButton&&(this.modalButtonContainer=document.createElement("div"),this.modalButtonContainer.classList.add("flex","gap-2","justify-center","px-6","py-4","w-full")),this.confirmButton&&(this.confirmButton=new n.$({text:this.confirmText,type:this.buttonStyleConfirm||"ringPrimary",size:this.buttonSize||"medium",width:this.buttonWidth||"auto"})),this.cancelButton&&(this.cancelButton=new n.$({text:this.cancelText,type:this.buttonStyleCancel||"ringSecondary",size:this.buttonSize||"medium",width:this.buttonWidth||"auto"})),this.body instanceof HTMLElement?this.modalBody.appendChild(this.body):this.modalBody.innerHTML=this.body,this.modalContainer.appendChild(this.modalBackground),this.modalContainer.appendChild(this.modal),this.modal.appendChild(this.modalContent),this.closeX&&this.modalContent.appendChild(this.closeButton),this.modalContent.appendChild(this.modalTitle),this.modalContent.appendChild(this.modalBody),this.confirmButton&&!this.cancelButton?(this.confirmButton.render(this.modalButtonContainer),this.modalContent.appendChild(this.modalButtonContainer),this.confirmButton.onClick(this.boundConfirm)):this.confirmButton&&this.cancelButton&&(this.cancelButton.render(this.modalButtonContainer),this.confirmButton.render(this.modalButtonContainer),this.modalContent.appendChild(this.modalButtonContainer),this.confirmButton.onClick(this.boundConfirm),this.cancelButton.onClick(this.boundClose)),document.body.appendChild(this.modalContainer),document.addEventListener("keydown",this.boundHandleKeyDown)}onClose(e){this.onCloseCallback=e}onConfirm(e){this.onConfirmCallback=e}confirm(){this.validationFunction&&!this.validationFunction()||("function"==typeof this.onConfirmCallback&&this.onConfirmCallback(),this.manualCloseOnConfirm||this.closeProcess())}close(){if(this.confirmOnExit&&this.unSavedChanges){new a("Are you sure?","You have unsaved changes that will be lost.").onConfirm((()=>{this.closeProcess()}))}else this.closeProcess()}closeProcess(){this.removeModal()}removeModal(){this.closeButton&&this.closeButton.removeEventListener("click",this.boundClose),document.removeEventListener("keydown",this.boundHandleKeyDown),this.modalContainer.remove(),l.modalCount--,"function"==typeof this.onCloseCallback&&this.onCloseCallback()}hasUnSavedChanges(e){this.unSavedChanges=e}waitingOnData(e){this.waiting=e,this.waiting?this.confirmButton.disableButton():this.confirmButton.enableButton()}enableConfirmButton(){this.confirmButton&&!this.confirmButtonEnabled&&(this.confirmButton.enableButton(),this.confirmButtonEnabled=!0)}disableConfirmButton(){this.confirmButton&&this.confirmButtonEnabled&&(this.confirmButton.disableButton(),this.confirmButtonEnabled=!1)}hideCloseButton(){this.closeButton&&(this.closeButton.style.display="none")}showCloseButton(){this.closeButton&&(this.closeButton.style.display="block")}hideConfirmCancelButtons(){this.modalButtonContainer&&(this.modalButtonContainer.style.display="none")}showConfirmCancelButtons(){this.modalButtonContainer&&(this.modalButtonContainer.style.display="block")}scrollToTop(){this.modalBody&&!this.disableScroll&&this.modalBody.scrollTo({top:0})}updateConfirmButtonText(e){this.confirmButton&&(this.confirmButton.text=e)}toggleConfirmLoading(e=null){this.confirmButton&&(this.confirmButton.toggleLoading(e),this.isConfirmLoading=!this.isConfirmLoading,this.closeX&&this.closeButton&&(this.isConfirmLoading?(this.closeButton.style.pointerEvents="none",this.closeButton.style.opacity="0.5"):(this.closeButton.style.pointerEvents="auto",this.closeButton.style.opacity="1")))}isConfirmButtonLoading(){return this.isConfirmLoading}setConfirmLoading(e,t=null){this.confirmButton&&(e&&!this.isConfirmLoading?this.toggleConfirmLoading(t):!e&&this.isConfirmLoading&&this.toggleConfirmLoading())}handleKeyDown(e){const t=41+2*l.modalCount;if(this.modal&&parseInt(this.modal.style.zIndex)===t&&!this.isConfirmLoading)if("Escape"!==e.key){if("Enter"===e.key){const t=document.activeElement;let s=!0;if(t){const e=t.tagName.toLowerCase();("textarea"===e||t.isContentEditable||this.modal.contains(t)&&("button"===e||"input"===e&&/^(button|submit|reset)$/i.test(t.type))&&t!==(this.confirmButton&&this.confirmButton.button))&&(s=!1)}if(s){const t=this.confirmButton;t&&t.button&&this.confirmButtonEnabled&&!this.isConfirmLoading&&(e.preventDefault(),this.confirm())}}}else{const t=this.cancelButton,s=t&&t.button&&!t.button.disabled;(this.closeX||s)&&(e.preventDefault(),this.close())}}}var c=s(99273);class d{constructor(e){this.config=e,this.inputContainer=null,this.inputField=null,this.label=null,this.copyButton=null,this.searchIcon=null,this.width=e.width||null,this.onChangeCallback=null,this.validate=this.validate.bind(this),this.init()}init(){this.inputContainer=document.createElement("div"),this.inputContainer.classList.add("space-y-2"),this.config.label&&(this.label=document.createElement("label"),this.label.classList=`${i.A.theme.text} font-medium`,this.label.textContent=this.config.label,this.inputContainer.appendChild(this.label));const e=document.createElement("div");e.classList.add("relative"),this.inputField=document.createElement("input"),this.inputField.type=this.config.type||"text",this.config.id&&(this.inputField.id=this.config.id),"tel"===this.inputField.type&&(this.inputField.pattern="[0-9]*",this.inputField.inputmode="numeric"),this.inputField.placeholder=this.config.placeholder||"",this.inputField.value=this.config.value||"",this.inputField.required=!!this.config.required,this.inputField.disabled=!!this.config.disabled,this.inputField.readOnly=!!this.config.readonly;let t=`rounded-md ring-1 ring-inset ${i.A.theme.inputRing} ${i.A.theme.inputBackground} ${i.A.theme.inputText} focus:outline-none focus:ring-2 focus:ring-inset ${i.A.theme.inputFocus} w-full ${i.A.theme.placeholderText} appearance-none border-0`;if("small"===this.config.size?t+=" px-2 py-1 text-sm":t+=" px-3 py-3",this.config.enableCopy&&(t+=" pr-10"),"search"===this.config.type&&(t+=" pl-10"),this.width?this.inputField.style.width=this.width:t+=" w-full",this.inputField.className=t,this.config.enableCopy&&(this.inputField.classList.add("cursor-pointer"),this.inputField.addEventListener("click",this.selectAndCopyText.bind(this))),e.appendChild(this.inputField),"search"===this.config.type){this.searchIcon=document.createElement("span"),this.searchIcon.classList.add("absolute","inset-y-0","left-0","flex","items-center","pl-3",i.A.theme.text);const t=o.A.name("search"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});this.searchIcon.appendChild(s.element),e.appendChild(this.searchIcon)}if(this.config.enableCopy){this.copyButton=document.createElement("button"),this.copyButton.type="button",this.copyButton.classList.add("absolute","inset-y-0","right-0","flex","items-center","pr-3",i.A.theme.text);const t=o.A.name("copy"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});this.copyButton.appendChild(s.element),this.copyButton.addEventListener("click",this.selectAndCopyText.bind(this)),e.appendChild(this.copyButton)}this.inputContainer.appendChild(e),"function"==typeof this.config.onChange&&this.inputContainer.addEventListener("input",(e=>{this.config.onChange(e.target.value)}))}selectAndCopyText(e){e.preventDefault(),this.inputField.select(),this.copyInputText()}copyInputText(){navigator.clipboard.writeText(this.inputField.value).then((()=>{new c.y("Copied to clipboard","success",!0,!0)})).catch((e=>{new c.y("Failed to copy text","error",!0,!0)}))}render(e){e&&e.appendChild(this.inputContainer)}validate(){if(!this.config.required&&0===this.inputField.value.length)return!0;const e=this.inputField.value.trim();e!==this.inputField.value&&(this.inputField.value=e);const t=e.length;if(this.config.required&&0===t)return new c.y(this.config.error||"This field is required","error",!0,!0),!1;if(this.config.minChar&&t<this.config.minChar){let e="this field";return this.config&&this.config.label&&(e=this.config.label),new c.y(`Please enter at least ${this.config.minChar} characters for ${this.config.label}`,"error",!0,!0),!1}if(this.config.maxChar&&t>this.config.maxChar)return new c.y(`Please enter no more than ${this.config.maxChar} characters.`,"error",!0,!0),!1;switch(this.config.type){case"email":if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e))return new c.y("Please enter a valid email address","error",!0,!0),!1;break;case"number":if(isNaN(e))return new c.y("Please enter a valid number","error",!0,!0),!1;break;case"tel":if(!/^\+?([0-9]{1,3})[-. ]?([0-9]{1,4})[-. ]?([0-9]{1,})$/.test(e))return new c.y("Please enter a valid phone number","error",!0,!0),!1;break;case"url":if(!/^(http(s)?:\/\/).*$/.test(e))return new c.y("Please enter a valid URL","error",!0,!0),!1}return!0}onChange(e){"function"==typeof e&&(this.onChangeCallback=e,this.inputField.addEventListener("input",(e=>{this.onChangeCallback(e.target.value)})))}disable(){this.inputField.disabled=!0}enable(){this.inputField.disabled=!1}focus(){this.inputField.select(),this.inputField.focus()}selectAll(){this.inputField.focus(),this.inputField.setSelectionRange(0,this.inputField.value.length)}get placeholder(){return this.inputField.placeholder}set placeholder(e){this.inputField.placeholder=e}get value(){return this.inputField.value}set value(e){this.inputField.value=e}}class h{constructor(e){if(this.options=e.options,this.menuMode=e.menuMode||!1,this.enableCreate=e.enableCreate,this.createPermission=e.createPermission,this.createText=e.createText,this.maxSelections=e.maxSelections,this.emptyCreateText=e.emptyCreateText||"Create",this.container=null,this.theme=i.A.theme,this.onFolderClickCallback=null,this.multiple=e.multiple||!1,this.selectedValues=new Set,this.multiple&&(!this.maxSelections||this.maxSelections<=1)&&(this.maxSelections=1/0),this.multiple){const e=t=>{t.forEach((t=>{t.selected&&this.selectedValues.add(t.value.toString()),t.nested&&e(t.nested)}))};e(this.options)}this.onSelectCallback=null,this.onSaveCallback=null,this.onCreateCallback=null,this.onCloseCallback=null,this.enableSearch=e.enableSearch||!1,this.searchPlaceholder=e.searchPlaceholder||"Search...",this.filteredOptions=[...this.options],this.searchInput=null,this.optionsContainer=null,this.navigationStack=[],this.currentOptions=this.options,this.selectContainer=null,this.temporaryOptions=null}_getIconKey(e){if(!e)return null;let t=e.split(" ").pop();return t.startsWith("fa-")&&(t=t.substring(3)),t}_createStyledButton(e){const t=document.createElement("button");t.className=`${this.theme.unselectedSelector} rounded-md px-4 py-3 flex gap-4 align-middle items-center w-full mb-2`;const s=document.createElement("div");s.className=`rounded-full w-10 h-10 ring-2 ${this.theme.secondaryRingColor} flex justify-center align-middle items-center flex-shrink-0`;const i=o.A.name(e.iconName);if(i&&i.path){const e=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.iconColor});s.appendChild(e.element)}else s.textContent="?";t.appendChild(s);const n=document.createElement("div");return n.className="font-medium text-left",n.textContent=e.text,t.appendChild(n),t.addEventListener("click",e.onClick),t}create(){if(this.reset(),this.navigationStack=[],this.currentOptions=this.options,this.enableSearch&&this.resetSearch(),this.container&&this.container.remove(),this.selectContainer=document.createElement("div"),this.selectContainer.classList.add("py-2"),this.enableSearch){const e=this.renderSearchBox();this.searchContainer=e.container,this.searchInput=e.inputElement,this.selectContainer.appendChild(this.searchContainer)}return this.optionsContainer=document.createElement("div"),this.selectContainer.appendChild(this.optionsContainer),this.renderOptions(),this.container=this.selectContainer,setTimeout((()=>{if(this.selectContainer){const e=this.selectContainer.offsetHeight;this.selectContainer.style.minHeight=`${e}px`}}),0),this.enableSearch&&this.searchInput&&setTimeout((()=>{this.searchInput.focus()}),0),this.selectContainer}renderSearchBox(){const e=document.createElement("div");e.classList.add("mb-2","mx-1");const t=new d({type:"text",placeholder:this.searchPlaceholder,onChange:e=>{""===e?this.resetSearch():this.filterOptions(e)}});return t.render(e),{container:e,inputElement:t.input}}renderOptions(){let e=0;if(this.optionsContainer&&(e=this.optionsContainer.scrollTop),this.optionsContainer.innerHTML="",this.optionsContainer.classList.add("space-y-2","overflow-y-auto","px-1","py-1"),this.enableSearch&&this.searchInput&&this.searchInput.value)return void this.renderSearchResults();let t=[...this.currentOptions];const s=t.find((e=>e.selected));if(s&&(t=t.filter((e=>e!==s)),t.unshift(s)),this.navigationStack.length>0){const e=this.renderBackButton();this.optionsContainer.appendChild(e)}if(this.enableCreate&&this.createPermission&&0===this.navigationStack.length){const e=this._createStyledButton({iconName:"plus",text:this.createText,onClick:()=>{"function"==typeof this.onCloseCallback&&this.onCloseCallback(),"function"==typeof this.onCreateCallback&&this.onCreateCallback()}});this.optionsContainer.appendChild(e)}if(t.forEach((e=>{this.optionsContainer.appendChild(this.renderItem(e.name,e.subtext,e.value,e.selected,e.icon,e.image,e.imageSize,e.nested))})),this.optionsContainer.scrollTop=e,!(0!==t.length||this.enableCreate&&this.createPermission&&0===this.navigationStack.length)){const e=document.createElement("div");if(e.className="flex flex-col justify-center items-center pt-4",this.enableCreate&&this.createPermission){const t=new n.$({text:this.emptyCreateText||"Create",size:"link-lg",type:"link"});t.render(e),t.onClick((()=>{"function"==typeof this.onCloseCallback&&this.onCloseCallback(),"function"==typeof this.onCreateCallback&&this.onCreateCallback()}))}const t=document.createElement("div");t.className=`text-center ${this.enableCreate&&this.createPermission?"pb-4 pt-0":"py-4"} ${this.theme.fadedText}`,t.textContent="No matching options found",e.appendChild(t),this.optionsContainer.appendChild(e)}}filterOptions(e){e=e.toLowerCase();const t=e=>{let s=[];return e.forEach((e=>{e.nested&&e.nested.length>0?s=[...s,...t(e.nested)]:s.push(e)})),s},s=t(this.options);this.currentOptions=s.filter((t=>!(t.nested&&t.nested.length>0)&&(t.name.toLowerCase().includes(e)||t.subtext&&t.subtext.toLowerCase().includes(e)))),this.navigationStack=[],this.renderOptions()}renderItem(e,t,s,i,n=null,a=null,l="default",c=null){const d=document.createElement("button");d.className=i?`${this.theme.backgroundSelected} rounded-md px-4 py-2 ring-2 ${this.theme.ringSelected} flex gap-4 align-middle items-center w-full min-h-[60px]`:`${this.theme.unselectedSelector} rounded-md px-4 py-2 flex gap-4 align-middle items-center w-full min-h-[60px]`,d.dataset.value=String(s);const h=document.createElement("div");if(h.setAttribute("draggable",!1),h.className="flex-shrink-0 flex items-center justify-center w-8 h-8",n){const e=this._getIconKey(n),t=o.A.name(e);if(t&&t.path){const e=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.iconColor});h.appendChild(e.element)}else h.textContent="?"}else if(a){let t="";"default"===l?t="w-8 h-8":"small"===l?t="w-6 h-6":"large"===l?t="w-12 h-12":l&&(t=l);const s=document.createElement("img");s.src=a,s.alt=e,s.className=`${t} rounded-full object-cover`,s.setAttribute("draggable",!1),h.innerHTML="",h.className=`rounded-full flex-shrink-0 ${t}`,h.appendChild(s)}const m=document.createElement("div");m.className="leading-5 break-words whitespace-normal w-full flex flex-col text-left";const u=document.createElement("div");u.className="font-bold break-words whitespace-normal line-clamp-2 truncate text-ellipsis",u.textContent=e;const p=document.createElement("div");if(p.className="text-sm break-words whitespace-normal line-clamp-2 truncate text-ellipsis",p.style.wordBreak="break-word",p.textContent=t,d.appendChild(h),d.appendChild(m),m.appendChild(u),m.appendChild(p),c&&c.length>0){const e=o.A.name("chevronRight");if(e&&e.path){const t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"ml-auto flex-shrink-0"});d.appendChild(t.element)}}return d.addEventListener("click",(()=>{c&&c.length>0?this.showNestedOptions(String(s),c):this.select(String(s))})),d}showNestedOptions(e,t){if(!t||0===t.length)return void this.select(e);const s=(e,t)=>{for(let i of e){if(String(i.value)===t)return i;if(i.nested){const e=s(i.nested,t);if(e)return e}}return null},i=s(this.options,e);"function"==typeof this.onFolderClickCallback&&i&&this.onFolderClickCallback(i),this.navigationStack.push(this.currentOptions),this.currentOptions=t,this.renderOptions()}renderBackButton(){const e=document.createElement("button");e.className=`${this.theme.unselectedSelector} rounded-md px-4 py-2 flex gap-2 align-middle items-center w-full mb-2`,e.innerHTML="";const t=o.A.name("chevronLeft");if(t&&t.path){const s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});e.appendChild(s.element)}const s=document.createTextNode("Back");return e.appendChild(s),e.addEventListener("click",(()=>this.navigateBack())),e}navigateBack(){this.navigationStack.length>0&&(this.currentOptions=this.navigationStack.pop(),this.renderOptions())}save(){this.temporaryOptions&&(this.options=JSON.parse(JSON.stringify(this.temporaryOptions)));const e=this.getSelected(),t=this.multiple?e:e.length>0?e[0]:null;return"function"==typeof this.onSaveCallback&&this.onSaveCallback(t),t}select(e){if(this.temporaryOptions||(this.temporaryOptions=JSON.parse(JSON.stringify(this.options))),this.multiple)this.handleMultipleSelectLogic(e);else{let t=null;const s=(e,i)=>{for(let n of e)String(n.value)===i?(n.selected=!0,t=n):n.selected=!1,n.nested&&s(n.nested,i)};if(s(this.temporaryOptions,e),t&&this.container){this.container.querySelectorAll("button[data-value]").forEach((t=>{const s=t.dataset.value===e;t.className=s?`${this.theme.backgroundSelected} rounded-md px-4 py-2 ring-2 ${this.theme.ringSelected} flex gap-4 align-middle items-center w-full min-h-[60px]`:`${this.theme.unselectedSelector} rounded-md px-4 py-2 flex gap-4 align-middle items-center w-full min-h-[60px]`,s&&t.scrollIntoView({behavior:"smooth",block:"nearest"})})),"function"==typeof this.onSelectCallback&&this.onSelectCallback(t)}}}handleMultipleSelectLogic(e){let t=null;const s=(e,i)=>{for(let n of e){if(String(n.value)===i){if(n.selected)n.selected=!1,this.selectedValues.delete(i);else{if(!(this.selectedValues.size<this.maxSelections))return;n.selected=!0,this.selectedValues.add(i)}return void(t=n)}if(n.nested&&(s(n.nested,i),t))return}};if(s(this.temporaryOptions,e),t&&this.container){this.container.querySelectorAll("button[data-value]").forEach((e=>{const t=e.dataset.value,s=this.selectedValues.has(t);e.className=s?`${this.theme.backgroundSelected} rounded-md px-4 py-2 ring-2 ${this.theme.ringSelected} flex gap-4 align-middle items-center w-full min-h-[60px]`:`${this.theme.unselectedSelector} rounded-md px-4 py-2 flex gap-4 align-middle items-center w-full min-h-[60px]`})),"function"==typeof this.onSelectCallback&&this.onSelectCallback(this.getSelected())}}getSelected(){const e=t=>{let s=[];if(t)for(let i of t)i.selected&&s.push(i),i.nested&&(s=[...s,...e(i.nested)]);return s};return e(this.temporaryOptions||this.options)}getSelectedValue(){const e=this.getSelected();return!this.multiple&&e.length>0?e[0].value:this.multiple&&e.length>0?e.map((e=>e.value)):null}getOptions(){return this.options}onSelect(e){this.onSelectCallback=e}onSave(e){this.onSaveCallback=e}onCreate(e){this.onCreateCallback=e}onClose(e){this.onCloseCallback=e}onFolderClick(e){this.onFolderClickCallback=e}reset(){if(this.menuMode){const e=t=>{t&&t.forEach((t=>{t.selected=!1,t.nested&&e(t.nested)}))};e(this.options),this.temporaryOptions&&e(this.temporaryOptions)}if(this.selectedValues.clear(),this.navigationStack=[],this.currentOptions=this.options,this.enableSearch){const e=this.searchInput&&this.searchInput.value;this.resetSearch(),!e&&this.optionsContainer&&this.renderOptions()}else this.optionsContainer&&this.renderOptions()}destroy(){this.reset(),this.container&&this.container.remove(),this.onSelectCallback=null,this.onSaveCallback=null,this.onCreateCallback=null,this.onCloseCallback=null,this.onFolderClickCallback=null,this.container=null,this.selectContainer=null,this.optionsContainer=null,this.searchContainer=null,this.searchInput=null,this.temporaryOptions=null}resetSearch(){this.searchInput&&(this.searchInput.value=""),this.currentOptions=this.options,this.navigationStack=[],this.optionsContainer&&this.renderOptions()}renderSearchResults(){if(this.enableCreate&&this.createPermission){const e=this._createStyledButton({iconName:"plus",text:this.createText,onClick:()=>{"function"==typeof this.onCloseCallback&&this.onCloseCallback(),"function"==typeof this.onCreateCallback&&this.onCreateCallback()}});this.optionsContainer.appendChild(e)}if(this.currentOptions.forEach((e=>{this.optionsContainer.appendChild(this.renderItem(e.name,e.subtext,e.value,this.selectedValues.has(String(e.value)),e.icon,e.image,e.imageSize,e.nested))})),!(0!==this.currentOptions.length||this.enableCreate&&this.createPermission)){const e=document.createElement("div");e.className=`text-center py-4 ${this.theme.fadedText}`,e.textContent="No matching options found",this.optionsContainer.appendChild(e)}}}var m=s(85113),u=s(37363);class p{constructor(e){this.config=e,this.textAreaContainer=null,this.textAreaField=null,this.label=null,this.validate=this.validate.bind(this),this.onChangeCallback=null,this.init()}get textarea(){return this.textAreaField}init(){this.textAreaContainer=document.createElement("div"),this.textAreaContainer.classList.add("space-y-2"),this.config.label&&(this.label=document.createElement("label"),this.label.classList=`${i.A.theme.text} font-medium`,this.label.textContent=this.config.label,this.config.id&&(this.label.htmlFor=this.config.id),this.textAreaContainer.appendChild(this.label));const e=document.createElement("div");if(this.textAreaField=document.createElement("textarea"),this.textAreaField.id=this.config.id||"",this.textAreaField.placeholder=this.config.placeholder||"",this.textAreaField.rows=this.config.rows||3,this.textAreaField.value=this.config.value||"",this.textAreaField.required=!!this.config.required,this.textAreaField.disabled=!!this.config.disabled,this.textAreaField.readOnly=!!this.config.readonly,this.textAreaField.style.resize=this.config.canGrow?"vertical":"none",this.textAreaField.classList=`rounded-md ring-1 ring-inset ${i.A.theme.inputRing} ${i.A.theme.inputBackground} ${i.A.theme.inputText} focus:outline-none focus:ring-2 focus:ring-inset ${i.A.theme.inputFocus} w-full ${i.A.theme.placeholderText} px-3 py-3 appearance-none border-0`,e.appendChild(this.textAreaField),this.config.helpText){const t=document.createElement("p");t.className=`${i.A.theme.fadedText} text-sm mt-2`,t.textContent=this.config.helpText,e.appendChild(t)}this.textAreaContainer.appendChild(e)}render(e){e&&e.appendChild(this.textAreaContainer)}validate(){const e=this.textAreaField.value.length;if(this.config.required&&0===e){new c.y(this.config.error||"This field is required","error");return!1}if(this.config.minChar&&e<this.config.minChar){let e="this field";return this.config&&this.config.label&&(e=this.config.label),new c.y(`Please enter at least ${this.config.minChar} characters for ${this.config.label}`,"error",!0,!0),!1}if(this.config.maxChar&&e>this.config.maxChar){let e="this field";return this.config&&this.config.label&&(e=this.config.label),new c.y(`Please enter no more than ${this.config.maxChar} characters for ${this.config.label}`,"error"),!1}return!0}onChange(e){"function"==typeof e&&(this.onChangeCallback=e,this.textAreaField.addEventListener("input",(e=>{this.onChangeCallback(e.target.value)})))}disable(){this.textAreaField.disabled=!0}enable(){this.textAreaField.disabled=!1}focus(){this.textAreaField.focus()}get value(){return this.textAreaField.value}set value(e){this.textAreaField.value=e}}var g=s(14574);class f{constructor(e="",t="",s=!1){this.theme=i.A.theme,this.ticketModal=null,this.subject=e||"",this.body=t||"",this.workspaceTicket=s,this.render()}render(){this.body.length>0&&this.subject.length>0||this.workspaceTicket?this.createTicketMenu():(this.modalConfig={size:"small",title:"How can we help?",closeX:!0,confirmOnExit:!1,body:this.createModalBody()},this.modal=new l(this.modalConfig))}createModalBody(){const e=document.createElement("div");let t;e.classList="flex flex-col gap-3 pt-4",window.workspace_context&&(t=`Support is managed by Simtheory on behalf of ${window.workspace.name}`,window.workspace_support&&window.workspace_support.state&&(t=`Support is managed by ${window.workspace.name}`));const s=new n.$({text:"Submit a ticket",size:"large",type:"ringSecondary"});s.render(e);const a=new n.$({text:"Documentation",size:"large",type:"ringSecondary"});if(a.render(e),window.workspace_context){const s=document.createElement("div");s.classList=`${i.A.theme.fadedText} text-xs text-center`,s.innerHTML=t,e.appendChild(s)}return s.onClick((()=>{this.createTicketMenu(),this.modal.close()})),a.onClick((()=>{if(window.workspace_context&&window.workspace_support&&window.workspace_support.documentation_url)return window.open(window.workspace_support.documentation_url,"_blank"),void this.modal.close();window.open("https://help.simtheory.ai","_blank"),this.modal.close()})),e}createTicketMenu(){this.modalConfig={size:"large",title:this.workspaceTicket?"Submit a workspace ticket":"Submit a ticket",closeX:!0,confirmOnExit:!0,confirm:!0,confirmText:"Submit ticket",cancel:!1,buttonWidth:"full",buttonStyleConfirm:"ringPrimary",buttonSize:"large",body:this.createTicketForm(),validationFunction:()=>this.subject.validate()&&this.ticketDescription.validate()},this.ticketModal=new l(this.modalConfig),this.ticketModal.onConfirm((()=>{this.fileUpload.isUploadInProgress?new c.y("Please wait for the file upload to complete before submitting","info"):(this.payload={subject:this.subject.value,description:this.ticketDescription.value,files:this.fileUpload.value,workspaceTicket:this.workspaceTicket},this.sendTicket(this.payload),this.ticketModal.close())}))}createTicketForm(){const e=document.createElement("div");e.classList="flex flex-col gap-3",e.id="ticket-form";const t=document.createElement("div");t.classList=`${i.A.theme.text} text-base `,this.workspaceTicket?t.innerHTML="Please provide as much detail as possible. Workspace tickets are automatically prioritized by our team.":t.innerHTML="Please provide as much detail as possible.",e.appendChild(t),this.subject=new d({label:"Subject:",placeholder:"A brief description of your issue",type:"text",minChar:2,maxChar:150,required:!0,error:"Subject is required",helpText:"Please enter a subject for your ticket",value:this.subject}),this.subject.render(e),this.ticketDescription=new p({label:"Description:",type:"text",placeholder:"Please describe your issue in detail and steps to reproduce the problem.",rows:4,canGrow:!0,minChar:10,maxChar:5e4,required:!0,error:"Description is required",helpText:"Please enter a description for your ticket",value:this.body}),this.ticketDescription.render(e),this.fileUpload=new J({uiType:"uploadBox",label:"Upload screenshots (optional):",maxFiles:5,maxSizePerFile:10,maxTotalSize:50,allowedTypes:["image/*","image/jpeg","image/png","image/gif"],required:!1,showUploadButton:!0}),this.fileUpload.render(e);let s=!1,n=!1;this.body.length>0&&this.subject.length>0&&(s=!0,n=!0);const a=()=>{s=this.subject.value.length>1,n=this.ticketDescription.value.length>1,s&&n?(this.ticketModal.hasUnSavedChanges(!0),this.ticketModal.waitingOnData(!1)):this.ticketModal.waitingOnData(!0)};return this.subject.onChange((()=>{this.ticketModal.hasUnSavedChanges(!0),a()})),this.ticketDescription.onChange((()=>{this.ticketModal.hasUnSavedChanges(!0),a()})),e}async sendTicket(e){new c.y("We've got your ticket! We'll respond soon.","success"),this.ticketModal.hasUnSavedChanges(!1);await g.G.postData("/chat/send-ticket/",e)}}class v{static view(e){const t=new CustomEvent("routeChange",{detail:{path:e}});document.dispatchEvent(t)}}var y=s(37131);class w{constructor(e){this.config=e,this.tabs=this.config.tabs,this.theme=i.A.theme,this.container=null,this.indicator=null,this.tabElements=[],this.init()}init(){this.container=document.createElement("div"),this.container.classList=`inline-flex rounded-full ${this.theme.tabBackground} text-sm ring-1 ${this.theme.tabOuterRing} p-1 relative`,this.tabs.forEach(((e,t)=>{const s=document.createElement("button");s.classList=`rounded-full px-2 py-0.5 relative z-10 transition-colors duration-300 ease-in-out ${this.theme.tabTextColor}`,s.textContent=e.title,s.addEventListener("click",(()=>this.switchTab(e,t))),this.container.appendChild(s),this.tabElements.push(s)})),this.indicator=document.createElement("div"),this.indicator.classList=`absolute ${this.theme.tabSelectedBackground} ring-1 ${this.theme.tabSelectedRing} rounded-full transition-all duration-300 ease-in-out ${this.theme.tabSelectedTextColor}`,this.container.appendChild(this.indicator),this.setInitialState()}setInitialState(){const e=this.tabs.find((e=>e.selected)),t=e?this.tabs.indexOf(e):0;this.switchTab(this.tabs[t],t,!1),requestAnimationFrame((()=>{requestAnimationFrame((()=>{const e=this.tabElements[t];this.container.offsetHeight,this.updateIndicatorPosition(e,!1),setTimeout((()=>{this.updateIndicatorPosition(e,!1)}),50)}))}))}updateIndicatorPosition(e,t=!0){if(e){const s=()=>{e.offsetHeight,this.indicator.style.width=`${e.offsetWidth}px`,this.indicator.style.height=`${e.offsetHeight}px`,this.indicator.style.left=`${e.offsetLeft}px`,this.indicator.style.top=`${e.offsetTop}px`,this.indicator.style.opacity="1"};t?(this.indicator.style.transition="all 300ms ease-in-out",requestAnimationFrame(s)):(this.indicator.style.transition="none",s(),this.indicator.offsetHeight,this.indicator.style.transition="")}else this.indicator.style.opacity="0"}switchTab(e,t,s=!0){const i=this.tabs.findIndex((e=>e.selected));this.tabs.forEach(((e,s)=>{e.selected=s===t})),this.tabElements.forEach(((e,s)=>{s===t?(this.theme?.tabTextColor&&e?.classList.remove(...this.theme.tabTextColor.split(" ")),this.theme?.tabSelectedTextColor&&e?.classList.add(...this.theme.tabSelectedTextColor.split(" "))):(this.theme?.tabSelectedTextColor&&e?.classList.remove(...this.theme.tabSelectedTextColor.split(" ")),this.theme?.tabTextColor&&e?.classList.add(...this.theme.tabTextColor.split(" ")))}));const n=this.tabElements[t];this.updateIndicatorPosition(n,i!==t),s&&this.config.onTabChange&&this.config.onTabChange(e.value)}manualSwitchTab(e,t=!0){const s=this.tabs.find((t=>t.value===e));if(!s)return;const i=this.tabs.indexOf(s),n=this.tabs.findIndex((e=>e.selected));this.tabs.forEach(((e,t)=>{e.selected=t===i}));const a=this.tabElements[i];a&&this.updateIndicatorPosition(a,n!==i),t&&this.config.onTabChange&&this.config.onTabChange(s.value)}onTabChange(e){if("function"!=typeof e)throw new Error("onTabChange must be a function");this.config.onTabChange=e}get value(){return this.tabs.find((e=>e.selected)).value}render(e){if(!e)throw new Error("Parent element is required");e.appendChild(this.container)}}class b{constructor(){this.theme=i.A.theme,this.modal=null,this.currentTab="link",this.contentContainer=null,this.referralData=null,this.render()}render(){const e=this.createModalBody();this.modalConfig={size:"medium",title:"Referral Program",closeX:!0,centerTitle:!0,body:e,disableScroll:!1,disableXPadding:!0,disableBPadding:!0},this.modal=new l(this.modalConfig),this.getData()}async getData(){try{const e=await g.G.fetchData("/accounts/get-referral-data/");this.referralData=e}catch(e){return new c.y("Failed to fetch referral data","error"),null}}createModalBody(){const e=document.createElement("div");e.className="flex flex-col px-6 pb-6 min-h-[600px]";const t=document.createElement("div");t.className="flex justify-center w-full pt-3";const s={tabs:[{title:"Promote",value:"link",selected:!0},{title:"Invite",value:"invite",selected:!1},{title:"Rewards",value:"rewards",selected:!1},{title:"My points",value:"stats",selected:!1},{title:"Earn",value:"earnings",selected:!1}],onTabChange:e=>this.handleTabChange(e)};return this.tabs=new w(s),this.tabs.render(t),e.appendChild(t),this.contentContainer=document.createElement("div"),this.contentContainer.className="mt-6",e.appendChild(this.contentContainer),this.renderTabContent(this.contentContainer,"link"),e}handleTabChange(e){this.currentTab=e,this.contentContainer.innerHTML="",this.renderTabContent(this.contentContainer,e)}renderTabContent(e,t){switch(t){case"link":this.renderLinkTab(e);break;case"invite":this.renderInviteTab(e);break;case"stats":this.renderStatsTab(e);break;case"rewards":this.renderRewardsTab(e);break;case"earnings":this.renderEarningsTab(e)}}renderLinkTab(e){const t=document.createElement("div"),s=document.createElement("div");s.className="text-xl font-bold pb-2",s.textContent="Refer new members and earn rewards",t.appendChild(s);const i=document.createElement("div");i.className=`${this.theme.secondaryBackground} p-6 rounded-lg`;const a=document.createElement("div");a.className="flex items-center gap-1 pb-2",a.innerHTML='\n            <i class="fa-solid fa-link text-lg"></i>\n            <span class="font-medium">Share your unique link:</span>\n        ';const o=new d({label:"",value:"https://simtheory.ai/invite/"+window.user.referral_code,readonly:!0,enableCopy:!0}),r=document.createElement("div");r.className="flex items-center gap-3 pt-4";const l=encodeURIComponent("Introducing Simtheory: The AI workspace\n\nChatGPT on steroids. ALL models, voice-enabled agents, screen sharing, and full customization.\n\nI'm 10x more productive. Teams are switching fast.\n\nUse my link for $10 off your first month. Experience the future of work:"),c=encodeURIComponent("https://simtheory.ai/a/JHG765"),h=new n.$({text:"Get QR Code",icon:"fa-solid fa-qrcode",type:"ringSecondary",size:"medium"});h.onClick((()=>{this.showQRCode()}));const m=[{icon:"fa-brands fa-x-twitter",text:"Share",type:"ringSecondary",onClick:()=>{window.open(`https://x.com/intent/tweet?text=${l}&url=${c}`,"_blank")}},{icon:"fa-brands fa-linkedin",text:"Post",type:"ringSecondary",onClick:()=>{window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${c}`,"_blank")}}];i.appendChild(a),o.render(i),h.render(r),m.forEach((e=>{const t=new n.$({text:e.text,icon:e.icon,type:e.type,size:"medium"});t.onClick(e.onClick),t.render(r)})),i.appendChild(r),t.appendChild(i);const u=document.createElement("div");u.className="space-y-4";const p=document.createElement("div");p.className=`${this.theme.toastInfo} p-4 mt-4 rounded-lg flex items-center gap-3`,p.innerHTML=`\n            <div class="w-10 h-10 rounded-full bg-blue-100 dark:bg-blue-900 flex items-center justify-center flex-shrink-0">\n                <i class="fa-solid fa-gift fa-xl text-blue-500 dark:text-blue-400"></i>\n            </div>\n            <div>\n                <div class="font-medium">New members get $10 off their first payment</div>\n                <div class="text-base ${this.theme.fadedText}">When they use your referral link</div>\n            </div>\n        `,u.appendChild(p),t.appendChild(u),e.appendChild(t)}async showQRCode(){if(!this.referralData&&(await this.getData(),!this.referralData))return;new l({size:"small",title:"QR Code",closeX:!0,body:`\n                <div class="flex flex-col items-center p-4">\n                    <div id="qrcode" class="bg-white p-4 rounded-lg flex items-center justify-center">\n                        ${this.referralData.qr_code_url?`<img class="w-48 h-48" src="${this.referralData.qr_code_url}" alt="QR Code" />`:`<div class="text-center ${this.theme.fadedText}">\n                                <i class="fa-solid fa-circle-exclamation text-2xl mb-2"></i>\n                                <div>QR code not available</div>\n                            </div>`}\n                    </div>\n                    <div id="download-button-container"></div>\n                </div>\n            `});if(this.referralData.qr_code_url){const e=new n.$({text:"Download QR Code PNG",type:"primary",size:"medium",icon:"fa-solid fa-qrcode"});e.onClick((async()=>{try{e.toggleLoading("Downloading...");const t=await fetch(this.referralData.qr_code_url),s=await t.blob(),i=window.URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=`referral-qr-${this.referralData.referral_code}.png`,document.body.appendChild(n),n.click(),document.body.removeChild(n),window.URL.revokeObjectURL(i)}catch(e){new c.y("Failed to download QR code","error")}finally{e.toggleLoading()}}));const t=document.getElementById("download-button-container");e.render(t)}}renderInviteTab(e){const t=document.createElement("div"),s=document.createElement("div");s.className="text-xl font-medium",s.textContent="Invite friends via email";const i=document.createElement("div");i.className=`text-base ${this.theme.fadedText} pb-2`,i.textContent="Each friend will receive an email invitation with your referral link.",this.emailInputs={},this.emailInputsContainer=document.createElement("div"),this.emailInputsContainer.className="flex flex-col gap-2";const a=()=>{const e=`email-input-${Object.keys(this.emailInputs).length}`,t=new d({label:"",placeholder:"friend@email.com",type:"email",required:!0});return t.render(this.emailInputsContainer),this.emailInputs[e]=t,t};for(let e=0;e<2;e++)a();const o=new n.$({text:"Add another",type:"link",icon:"fa-solid fa-plus",size:"link-sm"});o.onClick((()=>{a().focus()}));const r=document.createElement("div");r.className="flex items-center pt-2",o.render(r);const l=document.createElement("div");l.className="pt-6";const h=new p({label:"Add a personal message (optional)",placeholder:"Hey! I've been using Simtheory and thought you might find it useful...",rows:3,canGrow:!0,maxChar:500});h.render(l);const m=new n.$({text:"Send Invites",type:"primary",size:"large",width:"full"});m.onClick((()=>{this.sendInvites(h.value)})),t.appendChild(s),t.appendChild(i),t.appendChild(this.emailInputsContainer),t.appendChild(r),t.appendChild(l),t.appendChild(document.createElement("div")).className="h-4",m.render(t),e.appendChild(t),setTimeout((()=>{Object.values(this.emailInputs)[0].focus()}),10),this.sendInvites=async(e="")=>{const t=Object.values(this.emailInputs).filter((e=>""!==e.value.trim()));if(0===t.length)return void new c.y("Please enter at least one email address","error");if(t.filter((e=>!e.validate())).length>0)return;const s=t.map((e=>e.value.trim()));try{const t={emails:s,message:e},i=await g.G.postData("/accounts/send-referral-invites/",t);i.success?(new c.y(`Successfully sent ${s.length} invitation${s.length>1?"s":""}`,"success"),Object.values(this.emailInputs).forEach((e=>e.value="")),await this.getData(),this.tabs.manualSwitchTab("stats",!0),this.inviteModal&&this.inviteModal.close()):i.error&&new c.y(i.error,"error")}catch(e){new c.y("Failed to send invites","error")}}}async renderStatsTab(e){this.referralData||await this.getData();const t=this.referralData.stats,s=this.referralData.ledger,i=document.createElement("div");i.className="space-y-6";const n=document.createElement("div");n.className="grid grid-cols-2 gap-4",n.innerHTML=`\n            <div class="${this.theme.listTableItem} p-4 rounded-lg text-center">\n                <div class="text-2xl font-bold">${t.points_balance.toLocaleString()}</div>\n                <div class="text-base ${this.theme.fadedText}">Points balence</div>\n            </div>\n            <div class="${this.theme.listTableItem} p-4 rounded-lg text-center">\n                <div class="text-2xl font-bold">${t.successful_referrals.toLocaleString()}</div>\n                <div class="text-base ${this.theme.fadedText}">Successful referrals</div>\n            </div>\n            <div class="${this.theme.listTableItem} p-4 rounded-lg text-center">\n                <div class="text-2xl font-bold">${t.lifetime_points.toLocaleString()}</div>\n                <div class="text-base ${this.theme.fadedText}">Lifetime points</div>\n            </div>\n            <div class="${this.theme.listTableItem} p-4 rounded-lg text-center">\n                <div class="text-2xl font-bold">${t.rewards_claimed.toLocaleString()}</div>\n                <div class="text-base ${this.theme.fadedText}">Rewards claimed</div>\n            </div>\n        `;const a=document.createElement("div");a.className=`${this.theme.listTableItem} rounded-lg overflow-hidden`;const o=document.createElement("div");o.className=`p-4 border-b ${this.theme.borderColor}`,o.innerHTML='\n            <div class="font-medium">Activity</div>\n        ';const r=document.createElement("div");if(r.className="divide-y divide-gray-100 dark:divide-gray-800",s.forEach((e=>{const t=document.createElement("div");let s,i;switch(t.className="p-4 flex items-center justify-between",e.type){case"REFERRAL_JOINED":s="fa-solid fa-user-plus",i=this.theme.iconColor;break;case"REWARD_CLAIMED":s="fa-solid fa-gift",i=this.theme.iconColor;break;case"REFERRAL_REFUNDED":s="fa-solid fa-user-minus",i=this.theme.iconColor;break;case"REFERRAL_SUBSCRIBED":s="fa-solid fa-medal",i=this.theme.iconColor;break;case"INVITE_SENT":s="fa-solid fa-envelope",i=this.theme.iconColor}const n=this.theme.iconColor;let a="";a=e.points?`${e.points.toLocaleString()} points`:"",t.innerHTML=`\n                <div class="flex items-center gap-4">\n                    <div class="w-10 h-10 flex flex-shrink-0 rounded-full ${this.theme.toastInfo} flex items-center justify-center">\n                        <i class="${s} ${i}"></i>\n                    </div>\n                    <div>\n                        <div class="text-sm font-medium">${e.description}</div>\n                        <div class="text-xs ${this.theme.fadedText}">${new Date(e.date).toLocaleDateString()}</div>\n                    </div>\n                </div>\n                <div class="text-sm font-medium ${n} min-w-[90px] pl-2">\n                    ${a}\n                </div>\n            `,r.appendChild(t)})),0===s.length){const e=document.createElement("div");e.className="p-8 text-center",e.innerHTML=`\n                <div class="text-sm ${this.theme.fadedText}">No activity yet</div>\n            `,r.appendChild(e)}a.appendChild(o),a.appendChild(r),i.appendChild(n),i.appendChild(a),e.appendChild(i)}async renderRewardsTab(e){this.referralData||await this.getData();const t=this.referralData.rewards;if(!document.getElementById("image-preview-container")){const e=document.createElement("div");e.id="image-preview-container",e.className="fixed hidden z-50 shadow-lg rounded-lg overflow-hidden",document.body.appendChild(e)}const s=document.createElement("div");s.className="space-y-6";const i=document.createElement("div");i.className=`${this.theme.toastInfo} p-4 rounded-lg text-center`,i.innerHTML=`\n            <div class="text-2xl font-bold">${this.referralData.stats.points_balance.toLocaleString()} Points</div>\n            <div class="text-sm ${this.theme.fadedText}">Available to redeem</div>\n        `;const a=document.createElement("div");a.className="space-y-4",t.forEach((e=>{const t=document.createElement("div");t.className=`${this.theme.listTableItem} p-4 rounded-lg flex justify-between items-center`;const s=document.createElement("div");s.className="flex items-center gap-4";const i=document.createElement("div");if(i.className="w-20 h-20 rounded-md flex items-center justify-center",e.image){i.className+=` ${this.theme.background} cursor-zoom-in`;const t=document.createElement("img");t.src=e.image,t.className="w-full h-full object-cover rounded-md",i.addEventListener("mouseenter",(t=>{const s=document.getElementById("image-preview-container"),n=document.createElement("img");n.src=e.image,n.className="max-w-[400px] max-h-[400px] object-contain bg-white",s.innerHTML="",s.appendChild(n);const a=i.getBoundingClientRect();s.style.left=`${a.right+10}px`,s.style.top=`${a.top}px`,s.classList.remove("hidden")})),i.addEventListener("mouseleave",(()=>{document.getElementById("image-preview-container").classList.add("hidden")})),i.appendChild(t)}else if(e.icon){i.className+=` ${this.theme.toastInfo}`;const t=document.createElement("i");t.className=`${e.icon} text-xl`,i.appendChild(t)}const o=document.createElement("div");o.innerHTML=`\n                <div class="font-bold">${e.name}</div>\n                <div class="text-sm ${this.theme.fadedText}">${e.points.toLocaleString()} points</div>\n            `;const r=new n.$({text:"Redeem",type:"primary",size:"medium"});r.onClick((()=>this.redeemReward(e))),s.appendChild(i),s.appendChild(o),t.appendChild(s),r.render(t),a.appendChild(t)})),s.appendChild(i),s.appendChild(a),e.appendChild(s);const o=()=>{const e=document.getElementById("image-preview-container");e&&e.remove()};this.modal&&this.modal.onClose&&this.modal.onClose(o)}async redeemReward(e){this.referralData.stats.points_balance<e.points?new c.y("You do not have enough points to redeem this reward","info"):new a("Redeem Reward",`Are you sure you want to redeem the ${e.name} reward for ${e.points} points?`).onConfirm((async()=>{try{const t=await g.G.postData("/accounts/redeem-reward/",{reward_id:e.id});t.success?(new c.y("Reward redeemed successfully, we've emailed you a confirmation.","success"),await this.getData(),this.tabs.manualSwitchTab("stats",!0)):t.error&&new c.y(t.error,"error")}catch(e){return void new c.y("Failed to redeem reward","error")}}))}renderEarningsTab(e){const t=document.createElement("div"),s=document.createElement("div");s.className="space-y-4";const i=document.createElement("div");i.className="text-xl font-bold",i.textContent="How to earn points:";const n=document.createElement("div");n.className=`${this.theme.listTableItem} p-6 rounded-lg space-y-4`,n.innerHTML=`\n            <div class="flex items-start gap-3">\n                <i class="fa-solid fa-user-plus mt-1 ${this.theme.iconColor}"></i>\n                <div>\n                    <div class="font-medium">Refer your friends, school or class</div>\n                    <div class="text-sm ${this.theme.fadedText}">Share your link with friends and colleagues</div>\n                </div>\n            </div>\n            <div class="flex items-start gap-3">\n                <i class="fa-solid fa-buildings mt-1 ${this.theme.iconColor}"></i>\n                <div>\n                    <div class="font-medium">Enterprise referrals</div>\n                    <div class="text-sm ${this.theme.fadedText}">Introduce Simtheory to your company or organization</div>\n                </div>\n            </div>\n            <div class="flex items-start gap-3">\n                <i class="fa-solid fa-share-nodes mt-1 ${this.theme.iconColor}"></i>\n                <div>\n                    <div class="font-medium">Social media promotion</div>\n                    <div class="text-sm ${this.theme.fadedText}">Share your experience on X, LinkedIn, YouTube, Reddit or your blog</div>\n                </div>\n            </div>\n            <div class="flex items-start gap-3">\n                <i class="fa-solid fa-video mt-1 ${this.theme.iconColor}"></i>\n                <div>\n                    <div class="font-medium">Create content</div>\n                    <div class="text-sm ${this.theme.fadedText}">Make tutorials or showcase your how you use Simtheory</div>\n                </div>\n            </div>\n        `;const a=document.createElement("div");a.className="text-xl font-bold pt-6 pb-2",a.textContent="Points earned per referral:";const o=document.createElement("div");o.className=`${this.theme.listTableItem} rounded-lg overflow-hidden`;const r=document.createElement("div");r.className=`grid grid-cols-3 gap-4 p-4 ${this.theme.fadedText} font-bold text-sm border-b ${this.theme.borderColor}`,r.innerHTML="\n            <div>Plan</div>\n            <div>Points (Monthly)</div>\n            <div>Points (Annual)</div>\n        ";const l=[{name:"Member",monthly:15,annual:9},{name:"Pro",monthly:29,annual:20},{name:"Max",monthly:49,annual:40},{name:"Workspace",annual:125}].map((e=>{let t=Math.round(.1*e.monthly*100);const s=Math.round(12*e.annual*.1*100);return t=t?`${t.toLocaleString()} points`:"N/A","Workspace"===e.name?`\n                    <div class="grid grid-cols-3 gap-4 p-4 border-b ${this.theme.borderColor} last:border-b-0 text-sm">\n                        <div class="font-medium">${e.name}</div>\n                        <div>N/A</div>\n                        <div>From ${s.toLocaleString()} points*</div>\n                    </div>`:`\n                    <div class="grid grid-cols-3 gap-4 p-4 border-b ${this.theme.borderColor} last:border-b-0 text-sm">\n                        <div class="font-medium">${e.name}</div>\n                        <div>${t}</div>\n                        <div>${s.toLocaleString()} points</div>\n                    </div>\n                `})).join("");o.innerHTML=r.outerHTML+l;const c=document.createElement("div");c.className=`mt-6 ${this.theme.fadedText} text-sm space-y-2`,c.innerHTML='\n            <div class="font-bold text-base mb-2">When are new points added?</div>\n            <ul class="list-disc pl-4 space-y-1.5">\n                <li>After first successful payment verification</li>\n                <li>Points will be revoked for accounts that are refunded or fraudulent</li>\n                <li>Referral must be a new customer who hasn\'t previously had an account</li>\n            </ul>\n            <div class="font-bold text-base pt-2">How do workspace referrals work?</div>\n            <ul class="list-disc pl-4 space-y-1.5">\n                <li>Points are awarded when a workspace plan is created by a member you referred</li>\n                <li>If you create a workspace for your company you will automatically be rewarded with referral points</li>\n                <li>A minimum of 15,000 points is awarded and an additional 3,000 points per seat based on the total number of seats at the time of purchase</li>\n                <li>ISV partners are not eligible for referral points</li>\n            </ul>\n        ',s.appendChild(i),s.appendChild(n),t.appendChild(s),t.appendChild(a),t.appendChild(o),t.appendChild(c),e.appendChild(t)}}class C{constructor(e){this.size=e.size||"normal",this.config=e,this._value=e.value,this.disabled=e.disabled,this.labelPosition=e.labelPosition,this.helpText=e.helpText,this.helpTextPosition=e.helpTextPosition||e.helpTextPostion,this.observers=[],this.onSwitchOnCallback=null,this.onSwitchOffCallback=null,this.container=null,this.element=null,this.indicatorSpan=null,this.label=null,this.initToggle=!0,this.init()}init(){const e="switch-"+Math.random().toString(36).substr(2,9),t=this.getSizeClasses();if(this.element=document.createElement("button"),this.element.id=e,this.element.setAttribute("type","button"),this.element.setAttribute("role","switch"),this.element.className=`ring-1 ring-outset-1 ${i.A.theme.switchRing} ${i.A.theme.switchOff} relative inline-flex flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ${t.switch}`,this.indicatorSpan=document.createElement("span"),this.indicatorSpan.setAttribute("aria-hidden","true"),this.indicatorSpan.className=`translate-x-0 pointer-events-none inline-block transform rounded-full ${i.A.theme.switchIndicator} shadow ring-0 transition duration-200 ease-in-out ${t.indicator}`,this.element.appendChild(this.indicatorSpan),this.element.addEventListener("click",(()=>{this.disabled||this.toggle()})),!this.config.label&&!this.helpText)return this.config.ariaLabel&&this.element.setAttribute("aria-label",this.config.ariaLabel),void this.update();this.container=document.createElement("div"),this.container.className="left"===this.labelPosition?"flex gap-4 justify-between items-start":"space-y-2";const s=document.createElement("div");"below"===this.helpTextPosition&&(s.className="flex flex-col"),this.config.label&&(this.label=document.createElement("label"),this.label.id=e+"-label",this.label.htmlFor=e,this.label.className=`${i.A.theme.text} font-medium flex items-center pb-0.5 select-none`,this.label.textContent=this.config.label,s.appendChild(this.label),this.element.setAttribute("aria-labelledby",this.label.id));const n=this.createHelpText();n&&(n.id=e+"-help",s.appendChild(n),this.element.setAttribute("aria-describedby",n.id));const a=document.createElement("div");a.appendChild(this.element),this.container.appendChild(s),this.container.appendChild(a),this.update()}getSizeClasses(){switch(this.size){case"tiny":return{switch:"h-3.5 w-6",indicator:"h-2.5 w-2.5"};case"small":return{switch:"h-4 w-7",indicator:"h-3 w-3"};default:return{switch:"h-6 w-11",indicator:"h-5 w-5"}}}render(e){const t=this.container||this.element;e&&t&&e.appendChild(t)}onSwitchTrue(e){"function"==typeof e&&(this.onSwitchOnCallback=e)}onSwitchFalse(e){"function"==typeof e&&(this.onSwitchOffCallback=e)}get value(){return this._value}createHelpText(){if(this.helpText){const e=document.createElement("span");return e.className="below"===this.helpTextPosition?`${i.A.theme.fadedText}`:`text-sm ${i.A.theme.fadedText}`,e.textContent=this.helpText,e}return null}onChange(e){"function"==typeof e&&this.observers.push(e)}toggle(){this._value=!this._value,this.update()}setDisabled(e){this.disabled=e,this.element.classList.toggle("cursor-not-allowed",e),this.element.classList.toggle("opacity-50",e)}setValue(e,t=!1){if(this._value=e,t){const e=this.getSizeClasses();this._value?(this.element.className=`ring-1 ring-outset-1 ${i.A.theme.switchRing} ${i.A.theme.switchOn} relative inline-flex flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ${e.switch}`,this.indicatorSpan.style.transform="tiny"===this.size?"translateX(10px)":"small"===this.size?"translateX(12px)":"translateX(20px)",this.element.setAttribute("aria-checked","true")):(this.element.className=`ring-1 ring-outset-1 ${i.A.theme.switchRing} ${i.A.theme.switchOff} relative inline-flex flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ${e.switch}`,this.indicatorSpan.style.transform="translateX(0px)",this.element.setAttribute("aria-checked","false"))}else this.update()}update(){const e=this.getSizeClasses();this._value?("function"!=typeof this.onSwitchOnCallback||this.initToggle||this.onSwitchOnCallback(),this.element.className=`ring-1 ring-outset-1 ${i.A.theme.switchRing} ${i.A.theme.switchOn} relative inline-flex flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ${e.switch}`,this.indicatorSpan.style.transform="tiny"===this.size?"translateX(10px)":"small"===this.size?"translateX(12px)":"translateX(20px)",this.element.setAttribute("aria-checked","true")):("function"!=typeof this.onSwitchOffCallback||this.initToggle||this.onSwitchOffCallback(),this.element.className=`ring-1 ring-outset-1 ${i.A.theme.switchRing} ${i.A.theme.switchOff} relative inline-flex flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out ${e.switch}`,this.indicatorSpan.style.transform="translateX(0px)",this.element.setAttribute("aria-checked","false")),this.indicatorSpan.className=`pointer-events-none inline-block transform rounded-full ${i.A.theme.switchIndicator} shadow ring-0 transition duration-200 ease-in-out ${e.indicator}`,this.observers.forEach((e=>e(this._value))),this.initToggle=!1}set ariaLabel(e){this.element&&(this.config.ariaLabel=e,this.config.label||this.element.setAttribute("aria-label",e))}get ariaLabel(){return this.config.ariaLabel||(this.element?this.element.getAttribute("aria-label"):null)}}class x{constructor(e){this.config={label:e.label||"",placeholder:e.placeholder||"Select...",required:e.required||!1,width:e.width||"100%",error:e.error||"This field is required",items:e.items||[],maxItems:e.maxItems||null,minItems:e.minItems||null,autoBlur:e.autoBlur||!1},this.theme=i.A.theme,this.selectedItems=new Set,this.isOpen=!1,this.focusedItemIndex=-1,this.onChangeCallback=null,this.container=null,this.selectContainer=null,this.searchInput=null,this.dropdownContainer=null,this.handleKeydown=this.handleKeydown.bind(this),this.handleClickOutside=this.handleClickOutside.bind(this),this.handleSearchInput=this.handleSearchInput.bind(this),this.init(),e.value&&(this.value=e.value)}init(){this.createMainContainer(),this.createLabel(),this.createSelectContainer(),this.createSearchInput(),this.createDropdownContainer(),this.setupEventListeners()}normalizeId(e){return e?.toString()}createMainContainer(){this.container=document.createElement("div"),this.container.classList.add("relative","space-y-1","text-sm"),this.config.width&&(this.container.style.width=this.config.width)}createLabel(){if(this.config.label){const e=document.createElement("label");e.classList=`block ${this.theme.text} font-medium text-base`,e.textContent=this.config.label,this.container.appendChild(e)}}createSelectContainer(){this.selectContainer=document.createElement("div"),this.selectContainer.setAttribute("tabindex","0"),this.selectContainer.setAttribute("role","combobox"),this.selectContainer.setAttribute("aria-expanded","false"),this.selectContainer.setAttribute("aria-haspopup","listbox"),this.selectContainer.classList=`flex flex-wrap gap-2 min-h-[50px] max-h-[80px] py-2 px-3 rounded-md ring-1 ring-inset ${this.theme.inputRing} cursor-pointer overflow-y-auto align-middle items-center focus:ring-2 focus:outline-none ${this.theme.inputBackground} ${this.theme.inputText} ${this.theme.inputFocus}`,this.container.appendChild(this.selectContainer)}createSearchInput(){this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder=this.config.placeholder,this.searchInput.classList=`\n            border-0 \n            bg-transparent \n            focus:outline-none \n            flex-1 \n            min-w-[100px]\n            focus:ring-0\n            p-0\n            h-[28px]\n            ${this.theme.inputText} \n            ${this.theme.placeholderText}\n        `,this.selectContainer.appendChild(this.searchInput)}createDropdownContainer(){this.dropdownContainer=document.createElement("div"),this.dropdownContainer.classList=`\n            absolute \n            z-50 \n            w-full \n            mt-1 \n            ${this.theme.selectMenuBackground} \n            rounded-md \n            shadow-lg \n            ring-1\n            ${this.theme.selectMenuRing}\n            ring-opacity-20 \n            hidden \n            max-h-40\n            overflow-auto\n        `,this.container.appendChild(this.dropdownContainer)}setupEventListeners(){this.selectContainer.addEventListener("mousedown",(e=>{e.preventDefault(),e.target===this.selectContainer&&(this.isOpen||this.openDropdown(),setTimeout((()=>this.searchInput.focus()),0))})),this.searchInput.addEventListener("focus",(()=>{this.isOpen||this.openDropdown()})),this.searchInput.addEventListener("mousedown",(e=>{e.stopPropagation()})),this.selectContainer.addEventListener("focus",(()=>{this.searchInput.focus()})),this.searchInput.addEventListener("input",this.handleSearchInput),this.searchInput.addEventListener("keydown",this.handleKeydown),document.addEventListener("mousedown",this.handleClickOutside)}handleSearchInput(e){const t=e.target.value.trim();this.renderDropdownItems(t),this.isOpen||this.openDropdown()}handleKeydown(e){switch(e.key){case"Escape":e.preventDefault(),this.closeDropdown();break;case"ArrowDown":case"ArrowUp":e.preventDefault(),this.handleArrowNavigation("ArrowDown"===e.key);break;case"Enter":e.preventDefault(),this.handleEnterKey();break;case"Backspace":this.searchInput.value||(e.preventDefault(),this.handleBackspace())}}handleArrowNavigation(e){const t=Array.from(this.dropdownContainer.querySelectorAll(".dropdown-item"));if(!t.length)return;t.forEach((e=>e.classList.remove(this.theme.selectFocusedItemBackground))),-1===this.focusedItemIndex?this.focusedItemIndex=e?0:t.length-1:this.focusedItemIndex=e?(this.focusedItemIndex+1)%t.length:(this.focusedItemIndex-1+t.length)%t.length;const s=t[this.focusedItemIndex];s.classList.add(this.theme.selectFocusedItemBackground),s.scrollIntoView({block:"nearest"})}handleEnterKey(){const e=Array.from(this.dropdownContainer.querySelectorAll(".dropdown-item"));if(this.focusedItemIndex>=0&&this.focusedItemIndex<e.length){const t=e[this.focusedItemIndex].dataset.itemId,s=this.config.items.find((e=>this.normalizeId(e.id)===t));s&&this.toggleItem(s)}}handleBackspace(){const e=Array.from(this.selectedItems);if(e.length>0){const t=e[e.length-1],s=this.config.items.find((e=>this.normalizeId(e.id)===this.normalizeId(t)));s&&this.removeItem(s)}}handleClickOutside(e){this.isOpen&&!this.container.contains(e.target)&&this.closeDropdown()}createAvatar(e){if(e.image){const t=document.createElement("img");return t.src=e.image,t.alt=e.label,t.classList="w-6 h-6 rounded-full object-cover",t.onerror=()=>{t.replaceWith(this.createInitialAvatar(e))},t}if(e.icon){const t=document.createElement("div");t.classList=`w-6 h-6 rounded-full ${this.theme.selectIconBackground} flex items-center justify-center`;const s=o.A.name(e.icon),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-3 h-3"});return i.element&&t.appendChild(i.element),t}return this.createInitialAvatar(e)}createInitialAvatar(e){const t=document.createElement("div");t.classList=`w-6 h-6 rounded-full ${this.theme.selectIconBackground} flex items-center justify-center ${this.theme.text}`;const s=document.createElement("span");return s.textContent=e.label.charAt(0).toUpperCase(),s.style.fontSize="0.875rem",t.appendChild(s),t}createSelectedItem(e){const t=document.createElement("div");t.classList.add("flex","items-center","gap-2",this.theme.selectItemBackground,"rounded-lg","px-1.5","h-[30px]","shrink-0"),t.addEventListener("click",(e=>{e.stopPropagation()}));const s=this.createAvatar(e);t.appendChild(s);const i=document.createElement("span");i.textContent=e.label,i.classList.add("text-sm","whitespace-nowrap"),t.appendChild(i);const n=document.createElement("button");n.type="button",n.classList.add("ml-1",this.theme.selectRemoveButton,this.theme.RemoveButtonHover,"focus:outline-none");const a=o.A.name("xmark"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-3.5 h-3.5"});return l.element&&n.appendChild(l.element),n.addEventListener("click",(t=>{t.stopPropagation(),this.removeItem(e),this.isOpen&&setTimeout((()=>{this.searchInput.focus()}),0)})),t.appendChild(n),t}renderDropdownItems(e=""){this.dropdownContainer.innerHTML="";const t=this.config.items.filter((t=>(t.label||t.name||"").toLowerCase().includes(e.toLowerCase())));if(0===t.length){const e=document.createElement("div");return e.classList.add("p-2",this.theme.placeholderText,"text-center"),e.textContent="No results found",void this.dropdownContainer.appendChild(e)}t.forEach((e=>{const t=document.createElement("div"),s=this.selectedItems.has(this.normalizeId(e.id));t.className=`dropdown-item flex items-center gap-2 px-4 py-2 ${this.theme.selectBackgroundHoverColor} cursor-pointer\n                ${s?this.theme.selectSelectedItemBackground:""}`,t.dataset.itemId=this.normalizeId(e.id);const i=this.createAvatar(e);i.classList.remove("w-6","h-6"),i.classList.add("w-6","h-6"),t.appendChild(i);const n=document.createElement("span");n.textContent=e.label||e.name||"Unnamed",t.appendChild(n);const a=document.createElement("div");if(a.className=`ml-auto ${s?this.theme.selectCheckColor:""}`,s){const e=o.A.name("check"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4"});t.element&&a.appendChild(t.element)}else a.innerHTML="";t.appendChild(a),t.addEventListener("click",(t=>{t.stopPropagation(),this.toggleItem(e)})),this.dropdownContainer.appendChild(t)}))}toggleDropdown(){this.isOpen=!this.isOpen,this.dropdownContainer.classList.toggle("hidden"),this.isOpen&&(this.renderDropdownItems(this.searchInput.value),this.focusedItemIndex=-1)}openDropdown(){this.isOpen||(this.isOpen=!0,this.dropdownContainer.classList.remove("hidden"),this.renderDropdownItems(this.searchInput.value),this.focusedItemIndex=-1,this.selectContainer.setAttribute("aria-expanded","true"))}closeDropdown(){this.isOpen&&(this.isOpen=!1,this.dropdownContainer.classList.add("hidden"),this.searchInput.value="",this.focusedItemIndex=-1,this.selectContainer.setAttribute("aria-expanded","false"))}toggleItem(e){if(this.selectedItems.has(this.normalizeId(e.id)))this.removeItem(e);else{if(this.config.maxItems&&this.selectedItems.size>=this.config.maxItems)return void new c.y(`Maximum ${this.config.maxItems} items allowed`,"error");this.addItem(e)}this.config.autoBlur&&this.blur()}addItem(e){this.selectedItems.add(this.normalizeId(e.id)),this.renderSelectedItems(),this.renderDropdownItems(this.searchInput.value),this.triggerChange()}removeItem(e){this.selectedItems.delete(this.normalizeId(e.id)),this.renderSelectedItems(),this.renderDropdownItems(this.searchInput.value),this.triggerChange()}renderSelectedItems(){this.selectContainer.querySelectorAll("div:not(.relative)").forEach((e=>e.remove()));Array.from(this.selectedItems).length>0?this.searchInput.placeholder="":this.searchInput.placeholder=this.config.placeholder,this.config.items.filter((e=>this.selectedItems.has(this.normalizeId(e.id)))).forEach((e=>{const t=this.createSelectedItem(e);this.selectContainer.insertBefore(t,this.searchInput)})),this.selectContainer.scrollTop=this.selectContainer.scrollHeight}triggerChange(){if(this.onChangeCallback){const e=this.config.items.filter((e=>this.selectedItems.has(this.normalizeId(e.id))));this.onChangeCallback(e)}}validate(){return this.config.required&&0===this.selectedItems.size?(new c.y(this.config.error,"error"),!1):!(this.config.minItems&&this.selectedItems.size<this.config.minItems)||(new c.y(`Please select at least ${this.config.minItems} items`,"error"),!1)}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}get value(){return this.config.items.filter((e=>this.selectedItems.has(this.normalizeId(e.id))))}get selectedIds(){return this.config.items.filter((e=>this.selectedItems.has(this.normalizeId(e.id)))).map((e=>e.id))}set value(e){this.selectedItems.clear(),Array.isArray(e)&&e.forEach((e=>{e&&void 0!==e.id&&null!==e.id&&this.selectedItems.add(this.normalizeId(e.id))})),this.renderSelectedItems(),this.renderDropdownItems()}blur(){this.searchInput.blur(),this.closeDropdown(),this.selectContainer.blur(),this.searchInput.value="",this.focusedItemIndex=-1}setItems(e){this.config.items=e||[];const t=new Set(e.map((e=>this.normalizeId(e.id))));for(let e of this.selectedItems)t.has(e)||this.selectedItems.delete(e);this.renderSelectedItems(),this.isOpen&&this.renderDropdownItems(this.searchInput.value)}render(e){e&&e instanceof HTMLElement&&e.appendChild(this.container)}destroy(){document.removeEventListener("click",this.handleClickOutside),this.container.remove()}}class k extends x{constructor(e){super({...e}),this.isSingleSelect=!0;if(e&&void 0!==e.value&&null!==e.value){const t="object"==typeof e.value?e.value.id:e.value;null!=t&&(this.selectedItems.add(this.normalizeId(t)),this.renderSelectedItems())}}toggleItem(e){if(this.isSingleSelect){const t=this.normalizeId(e.id),s=this.selectedItems.has(t);this.selectedItems.clear(),s?(this.renderSelectedItems(),this.renderDropdownItems(this.searchInput.value),this.triggerChange()):this.addItem(e),this.config.autoBlur&&this.blur()}else super.toggleItem(e)}get value(){return this.isSingleSelect?this.config.items.find((e=>this.selectedItems.has(this.normalizeId(e.id))))||null:super.value}set value(e){this.isSingleSelect?(this.selectedItems.clear(),e&&void 0!==e.id&&null!==e.id&&this.selectedItems.add(this.normalizeId(e.id))):super.value=e,this.renderSelectedItems(),this.renderDropdownItems()}}class E{constructor(e){this.config=e,this.container=null,this.field=null,this.label=null,this.helpText=e.helpText,this.onChangeCallback=null,this.validate=this.validate.bind(this),this.init()}init(){if(this.container=document.createElement("div"),this.config.label&&(this.label=document.createElement("label"),this.label.textContent=this.config.label,this.label.classList=`block ${i.A.theme.text} font-medium mb-1`,this.container.appendChild(this.label)),this.field=document.createElement("select"),this.field.classList=`rounded-md ring-inset ring-1 ${i.A.theme.inputRing} ${i.A.theme.inputBackground} ${i.A.theme.inputText} focus:outline-none focus:ring-2 focus:ring-inset ${i.A.theme.inputFocus} w-full ${i.A.theme.placeholderText} appearance-none border-0`,"small"===this.config.size?(this.label?.classList.add("text-xs"),this.field.classList.add("text-xs","px-2","py-1")):"medium"===this.config.size?(this.label?.classList.add("text-sm"),this.field.classList.add("text-sm","px-2.5","py-2")):this.field.classList.add("px-3","py-3"),this.config.placeholder){const e=document.createElement("option");e.value="",e.textContent=this.config.placeholder,e.disabled=!0,e.selected=!0,this.field.appendChild(e)}this.config.options.forEach((e=>{const t=document.createElement("option");t.value=e.value,t.textContent=e.label,this.field.appendChild(t)})),this.container.appendChild(this.field);const e=this.createHelpText();e&&this.container.appendChild(e),this.config.value&&(this.field.value=this.config.value),this.field.addEventListener("change",(()=>{"function"==typeof this.onChangeCallback&&this.onChangeCallback(this.value)}))}render(e){e&&e.appendChild(this.container)}createHelpText(){if(this.helpText){const e=document.createElement("div");let t="text-sm";return"small"!==this.config.size&&"medium"!==this.config.size||(t="text-xs"),e.classList=`mt-1 ${t} ${i.A.theme.fadedText}`,e.textContent=this.helpText,e}return null}validate(){const e=this.field.value;if(""===e||"disabled"===e){new c.y(this.config.error||`Please make a valid selection for ${this.config.label}`,"error");return!1}return!0}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}disable(){this.field.disabled=!0}enable(){this.field.disabled=!1}get value(){return this.field.value}set value(e){this.field.value=e}}class S{constructor(e=null,t=null,s=null,n=null,a="rounded-full",o=null,r=!1){this.avatarDesc=e,this.avatarModalTitle=s,this.createOptions=n,this.shape="rounded-md"===a||"rounded-full"===a?a:"rounded-full",this.rhsHelperTextContent=o,this.internalUIOnly=r,this.onChangeCallback=null,this.baseUrl=this.getCleanUrl(t),this.uploadId=null,this.theme=i.A.theme,this.container=null,this.avatarContainer=null,this.avatarButtonWrapper=null,this.removeButton=null,this.avatar=null,this.avatarIconComponent=null,this.avatarImage=null,this.leftHelperTextContainer=null,this.leftHelperText=null,this.cancelButtonContainer=null,this.cancelButton=null,this.rhsHelperTextElement=null,this.toggleLoadingState=!1,this.generationCancelled=!1,this.previousState={avatarURL:null,avatarIconPresent:!1},this.init()}getCleanUrl(e){return e?e.replace(/\/upload\/(?:w_\d+,h_\d+,c_\w+\/)+/,"/upload/"):null}init(){if(this.container=document.createElement("div"),this.container.classList="flex flex-col py-2",this.avatarDesc&&(this.avatarDescDiv=document.createElement("div"),this.avatarDescDiv.classList="text-base font-medium pb-2 cursor-default",this.avatarDescDiv.textContent=this.avatarDesc,this.container.appendChild(this.avatarDescDiv)),this.avatarContainer=document.createElement("div"),this.internalUIOnly?this.avatarContainer.classList="flex items-center":this.avatarContainer.classList="flex gap-3 items-center",this.avatarButtonWrapper=document.createElement("div"),this.avatarButtonWrapper.className="relative group w-16 h-16",this.avatar=document.createElement("button"),this.avatar.type="button",this.avatar.classList=`${this.shape} flex flex-shrink-0 flex-grow-0 w-16 h-16 ring-2 ${this.theme.inputRing} justify-center align-middle items-center ${this.theme.text} ${this.theme.inputBackground} ${this.theme.ringHover} ${this.theme.backgroundHover}`,this.avatarButtonWrapper.appendChild(this.avatar),this.avatarContainer.appendChild(this.avatarButtonWrapper),this.baseUrl)this.avatarImage=document.createElement("img"),this.avatarImage.classList=`${this.shape} w-16 h-16 flex flex-shrink-0 object-cover`,this.avatarImage.src=this.displayUrl,this.avatar.appendChild(this.avatarImage),this.addRemoveButton();else{const e=o.A.name("plus");this.avatarIconComponent=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-6 h-6",colorClass:this.theme.iconColor}),this.avatar.appendChild(this.avatarIconComponent.element)}if(!this.internalUIOnly){const e=document.createElement("div");e.className="flex flex-col justify-center",this.rhsHelperTextContent&&(this.rhsHelperTextElement=document.createElement("div"),this.rhsHelperTextElement.classList=`text-sm ${this.theme.fadedText} mb-1`,this.rhsHelperTextElement.textContent=this.rhsHelperTextContent,e.appendChild(this.rhsHelperTextElement)),this.leftHelperTextContainer=document.createElement("div"),this.leftHelperText=document.createElement("div"),this.leftHelperText.classList=`text-sm ${this.theme.fadedText}`,this.leftHelperTextContainer.appendChild(this.leftHelperText),e.appendChild(this.leftHelperTextContainer),this.cancelButtonContainer=document.createElement("div"),this.cancelButtonContainer.className="mt-1",e.appendChild(this.cancelButtonContainer),this.avatarContainer.appendChild(e)}this.container.appendChild(this.avatarContainer),this.addEventListeners()}addRemoveButton(){this.removeButton&&this.removeButton.remove();const e="ontouchstart"in window||navigator.maxTouchPoints>0?"flex":"hidden group-hover:flex";this.removeButton=document.createElement("button"),this.removeButton.type="button",this.removeButton.className=`absolute -top-1 -right-1 ${this.theme.dangerBackground} rounded-full w-5 h-5 items-center justify-center ${this.theme.modalBackground} ${e} transition-opacity`;const t=o.A.name("tabClose");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.dangerText}).render(this.removeButton),this.removeButton.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),new a("Remove avatar?","Are you sure you want to remove the current avatar?").onConfirm((()=>{this.clearAvatar()}))})),this.avatarButtonWrapper.appendChild(this.removeButton)}clearAvatar(){this.baseUrl=null,this.uploadId=null,this.avatarDesc=null,this.avatar.innerHTML="",this.avatarImage=null,this.removeButton&&(this.removeButton.remove(),this.removeButton=null);const e=o.A.name("plus");this.avatarIconComponent=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-6 h-6",colorClass:this.theme.iconColor}),this.avatar.appendChild(this.avatarIconComponent.element),this.triggerOnChange()}showAvatarMenu(){const e=[{name:"Upload image",subtext:"Select an image from your desktop",icon:"upload",value:"image",selected:!1},{name:"Create with prompt",subtext:"Use AI to generate an avatar",icon:"sparkles",value:"prompt",selected:!1}];this.createOptions&&Array.isArray(this.createOptions)?this.avatarOptions=e.filter((e=>this.createOptions.includes(e.value))):this.avatarOptions=e,this.avatarSelector=new h({enableCreate:!1,maxSelections:1,options:this.avatarOptions}),this.avatarMenu=new l({size:"small",title:this.avatarModalTitle||"Create avatar",body:this.avatarSelector.create(),closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1}),this.avatarSelector.onSelect((()=>{const e=this.avatarSelector.getSelectedValue();switch(this.avatarSelector.destroy(),this.avatarMenu.close(),e){case"image":this.uploadImage();break;case"prompt":this.createAvatarWithPrompt()}}))}addEventListeners(){this.avatar.addEventListener("click",(()=>{this.showAvatarMenu()}))}revertToPreviousState(){if(this.avatar.innerHTML="",this.avatarImage=null,this.avatarIconComponent=null,this.previousState.avatarURL)this.baseUrl=this.getCleanUrl(this.previousState.avatarURL),this.avatarImage=document.createElement("img"),this.avatarImage.classList=`${this.shape} w-16 h-16 flex flex-shrink-0 object-cover`,this.avatarImage.src=this.displayUrl,this.avatar.appendChild(this.avatarImage),this.addRemoveButton();else{this.baseUrl=null,this.removeButton&&(this.removeButton.remove(),this.removeButton=null);const e=o.A.name("plus");this.avatarIconComponent=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-6 h-6",colorClass:this.theme.iconColor}),this.avatar.appendChild(this.avatarIconComponent.element)}this.internalUIOnly||(this.leftHelperText.textContent="",this.rhsHelperTextElement&&(this.rhsHelperTextElement.style.display="block")),this.avatar.disabled=!1,this.avatar.classList=`${this.shape} flex flex-shrink-0 flex-grow-0 w-16 h-16 ring-2 ${this.theme.inputRing} justify-center align-middle items-center ${this.theme.text} ${this.theme.inputBackground} ${this.theme.ringHover} ${this.theme.backgroundHover}`}uploadImage(){this.fileUpload=new J({uiType:"uploadBox",label:"1:1 aspect ratio",allowedTypes:["image/jpeg","image/png","image/gif","image/svg+xml","image/webp"],maxFiles:1,maxSizePerFile:20,maxTotalSize:20,required:!0});const e=document.createElement("div");e.classList="py-2",this.fileUpload.render(e),this.fileUploadModal=new l({size:"small",title:"Upload image",body:e,closeX:!1,confirmOnExit:!0,confirm:!0,confirmText:"Save",cancel:!0,cancelText:"Cancel",buttonWidth:"auto",buttonStyleConfirm:"ringPrimary",buttonSize:"medium",skipFade:!0}),this.fileUploadModal.waitingOnData(!0),this.fileUpload.onChange((()=>{this.fileUploadModal.hasUnSavedChanges(!1),(this.fileUpload.isUploadInProgress||this.fileUpload.files.length>0)&&this.fileUploadModal.hasUnSavedChanges(!0),this.fileUpload.files.length>0&&!this.fileUpload.isUploadInProgress?this.fileUploadModal.waitingOnData(!1):this.fileUploadModal.waitingOnData(!0)})),this.fileUploadModal.onConfirm((async()=>{if(0===this.fileUpload.files.length)return;this.toggleLoading(!0);const e=this.fileUpload.files[0],t=new FileReader;t.onload=e=>{const t=e.target.result;this.updateAvatar(t);const s=this.fileUpload.fileUploadIds||[];this.uploadId=s.length?String(s[0]):null,this.triggerOnChange()},t.readAsDataURL(e)}))}createAvatarWithPrompt(){const e=document.createElement("div");e.classList="space-y-2 py-2";const t={label:"",placeholder:"e.g. A happy robot, cartoon",value:"",required:!0,minChar:10,maxChar:150,error:"Description is required",helpText:"Please enter a description (10-150 characters)"},s=new d(t);s.render(e),this.promptModal=new l({size:"small",title:"Create with prompt",body:e,closeX:!1,confirmOnExit:!0,confirm:!0,confirmText:"Create",cancelText:"Cancel",cancel:!0,buttonWidth:"auto",buttonStyleConfirm:"ringPrimary",buttonSize:"medium",skipFade:!0,manualCloseOnConfirm:!0}),this.promptModal.waitingOnData(!0),s.onChange((()=>{const e=s.value.length;e>=t.minChar&&e<=t.maxChar?(this.promptModal.hasUnSavedChanges(!0),this.promptModal.waitingOnData(!1)):(this.promptModal.hasUnSavedChanges(s.value.length>0),this.promptModal.waitingOnData(!0))})),this.promptModal.onConfirm((async()=>{if(!s.validate())return;const e=s.value;this.promptModal.hasUnSavedChanges(!1),this.toggleLoading(!0),this.promptModal.close();try{const t=await g.G.postData("/chat/assistants/profile/generate/",{mode:"prompt",prompt:e});if(this.generationCancelled)return;t&&t.url?(this.updateAvatar(t.url),this.uploadId=null,this.triggerOnChange()):(new c.y("Failed to create profile image. No URL returned.","error"),this.toggleLoading(!1),this.revertToPreviousState())}catch(e){if(this.generationCancelled)return;new c.y("Error creating avatar. Please try again.","error"),this.toggleLoading(!1),this.revertToPreviousState()}}))}async generateAvatarFromName(e){if(e){this.toggleLoading(!0);try{const t=await g.G.postData("/chat/assistants/profile/generate/",{mode:"name",name:e});if(this.generationCancelled)return;t&&t.url?(this.updateAvatar(t.url),this.uploadId=null,this.triggerOnChange()):(new c.y("Failed to automatically create profile image.","error"),this.toggleLoading(!1),this.revertToPreviousState())}catch(e){if(this.generationCancelled)return;new c.y("Error creating avatar. Please try again.","error"),this.toggleLoading(!1),this.revertToPreviousState()}}}updateAvatar(e){this.toggleLoading(!1),this.baseUrl=this.getCleanUrl(e),this.avatarIconComponent&&(this.avatarIconComponent.element.remove(),this.avatarIconComponent=null),this.avatarImage||(this.avatarImage=document.createElement("img"),this.avatarImage.classList=`${this.shape} w-16 h-16 flex flex-shrink-0 object-cover`,this.avatar.appendChild(this.avatarImage)),this.avatarImage.src=this.displayUrl,this.addRemoveButton()}toggleLoading(e){if(e){this.toggleLoadingState=!0,this.generationCancelled=!1,this.previousState.avatarURL=this.baseUrl,this.avatar.innerHTML="",this.avatarImage=null,this.avatarIconComponent=null,this.removeButton&&(this.removeButton.style.display="none");const e=o.A.name("sparkles");this.avatarIconComponent=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-6 h-6 beat-fade",colorClass:this.theme.iconColor}),this.avatar.appendChild(this.avatarIconComponent.element),this.avatar.disabled=!0,this.avatar.classList=`${this.shape} flex flex-shrink-0 flex-grow-0 w-16 h-16 ring-2 ${this.theme.inputRing} justify-center align-middle items-center ${this.theme.text} ${this.theme.inputBackground}`,this.internalUIOnly||(this.leftHelperText.textContent="Generating image...",this.rhsHelperTextElement&&(this.rhsHelperTextElement.style.display="none"),this.cancelButtonContainer.innerHTML="",this.cancelButton=new n.$({text:"Cancel",type:"link",size:"link-sm"}),this.cancelButton.render(this.cancelButtonContainer),this.cancelButton.onClick((()=>{this.cancelGeneration()})))}else this.toggleLoadingState=!1,this.removeButton&&(this.removeButton.style.display="flex"),this.internalUIOnly||(this.cancelButtonContainer.innerHTML="",this.leftHelperText.textContent="",this.rhsHelperTextElement&&(this.rhsHelperTextElement.style.display="block")),this.avatar.disabled=!1,this.avatar.classList=`${this.shape} flex flex-shrink-0 flex-grow-0 w-16 h-16 ring-2 ${this.theme.inputRing} justify-center align-middle items-center ${this.theme.text} ${this.theme.inputBackground} ${this.theme.ringHover} ${this.theme.backgroundHover}`,this.avatarIconComponent&&this.avatarIconComponent.element.parentNode===this.avatar&&(this.avatarIconComponent.element.remove(),this.avatarIconComponent=null)}cancelGeneration(){this.generationCancelled=!0,this.toggleLoading(!1),this.revertToPreviousState()}validate(){return!this.toggleLoadingState||(new c.y("Please wait for avatar image to generate","warning",!0,!0),!1)}get displayUrl(){if(!this.baseUrl)return"";if(this.baseUrl.startsWith("data:image"))return this.baseUrl;const e=this.baseUrl.indexOf("/upload/");if(-1===e)return this.baseUrl;return`${this.baseUrl.substring(0,e+8)}w_128,h_128,c_fit/${this.baseUrl.substring(e+8)}`}get value(){const e=this.uploadId?null:this.baseUrl;return{imgUploadId:this.uploadId,imgUrl:e,imgPrompt:this.avatarDesc}}get isGenerating(){return this.toggleLoadingState}render(e){e&&e.appendChild(this.container)}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}triggerOnChange(){"function"==typeof this.onChangeCallback&&this.onChangeCallback(this.value)}}class T{constructor(){this.theme=i.A.theme,this.modal=null,this.personalizationData=null,this.avatar=null,this.nameInput=null,this.roleInput=null,this.geoInput=null,this.remember=null,this.renderModal()}async renderModal(){this.personalizationData=await u.K.getPersonalizationData(),this.modal=new l({size:"medium",title:"Settings",body:this.renderContent(),confirmOnExit:!0,confirm:!0,cancel:!1,closeX:!0,manualCloseOnConfirm:!0,confirmText:"Save",buttonWidth:"full",buttonStyle:"primary",buttonSize:"large"}),this.modal.hasUnSavedChanges(!1),this.modal.waitingOnData(!0),this.modal.onConfirm((()=>{this.saveUpdates()}))}renderContent(){this.modalContent=document.createElement("div"),this.infoContainer=document.createElement("div"),this.infoContainer.innerHTML="Get more relevant responses from assistants and personalize your experience",this.infoContainer.classList="text-sm pb-4",this.modalContent.appendChild(this.infoContainer),this.avatarContainer=document.createElement("div"),this.avatarContainer.classList="pb-2",this.avatarContainer.innerHTML='<div">Profile picture</div>';const e=this.personalizationData.picture_url?this.personalizationData.picture_url:null;this.avatar=new S(null,e,"Select an option:",null),this.avatar.render(this.avatarContainer),this.modalContent.appendChild(this.avatarContainer),this.nameContainer=document.createElement("div"),this.nameContainer.classList="pb-4",this.nameInput=new d({label:"What should assistants call you?",placeholder:"e.g. Imogen",value:this.personalizationData.call_me_name||""}),this.nameInput.render(this.nameContainer),this.modalContent.appendChild(this.nameContainer),this.roleContainer=document.createElement("div"),this.roleContainer.classList="pb-4",this.roleInput=new d({label:"What do you do?",placeholder:"e.g. teacher, student, software developer",value:this.personalizationData.occupation?this.personalizationData.occupation:""}),this.roleInput.render(this.roleContainer),this.modalContent.appendChild(this.roleContainer),this.geoContainer=document.createElement("div"),this.geoContainer.classList="pb-4",this.geoInput=new d({label:"Where are you located?",placeholder:"e.g. Sydney, Australia",value:this.personalizationData.location?this.personalizationData.location:""}),this.geoInput.render(this.geoContainer),this.modalContent.appendChild(this.geoContainer),this.rememberContainer=document.createElement("div"),this.rememberContainer.classList="pb-4",this.remember=new p({label:"What do you want every assistant to know about you?",type:"text",placeholder:"Share interests, preferences, or anything else you want every assistant to know about you",rows:3,canGrow:!0,maxChar:2e3,required:!1,value:this.personalizationData.remember?this.personalizationData.remember:""}),this.remember.render(this.rememberContainer),this.modalContent.appendChild(this.rememberContainer),this.firstLastNameHeading=document.createElement("div"),this.firstLastNameHeading.innerHTML='<div class="pb-2 text-lg">User details</div>',this.firstLastNameHeading.classList=`border-t ${this.theme.modalSeperationBorderColor} pt-6 pb-2`,this.modalContent.appendChild(this.firstLastNameHeading),this.firstLastNameContainer=document.createElement("div"),this.firstLastNameContainer.classList="pb-6 flex flex-col gap-2",this.firstNameInput=new d({label:"First name",placeholder:"e.g. Imogen",value:this.personalizationData.first_name?this.personalizationData.first_name:"",width:"w-full"}),this.firstNameInput.render(this.firstLastNameContainer),this.lastNameInput=new d({label:"Last name",placeholder:"e.g. Smith",value:this.personalizationData.last_name?this.personalizationData.last_name:"",width:"w-full"}),this.lastNameInput.render(this.firstLastNameContainer),this.modalContent.appendChild(this.firstLastNameContainer),this.preferenceHeading=document.createElement("div"),this.preferenceHeading.innerHTML='<div class="pb-2 text-lg">General preferences</div>',this.preferenceHeading.classList=`border-t ${this.theme.modalSeperationBorderColor} pt-6 pb-2`,this.modalContent.appendChild(this.preferenceHeading),this.preferenceContainer=document.createElement("div"),this.preferenceContainer.classList="pb-4 flex flex-col gap-4";const t=document.createElement("div");t.classList=`${this.theme.secondaryBackground} rounded-md p-4`,this.personalizeOnOffSwitch=new C({label:"Share personalization data with assistants",value:this.personalizationData.usePersonalizationData}),this.personalizeOnOffSwitch.render(t),this.preferenceContainer.appendChild(t);const s=document.createElement("div");s.classList=`${this.theme.secondaryBackground} rounded-md p-4`,this.useTimeSwitch=new C({label:"Allow the assistant to use your local time",value:this.personalizationData.useTime}),this.useTimeSwitch.render(s),this.preferenceContainer.appendChild(s);const i=document.createElement("div");i.classList=`${this.theme.secondaryBackground} rounded-md p-4`,this.textWrapSwitch=new C({label:"Word wrap in code blocks by default",value:this.personalizationData.wrapCodeBlocks}),this.textWrapSwitch.render(i),this.preferenceContainer.appendChild(i),this.modalContent.appendChild(this.preferenceContainer);return document.createElement("div").classList=`${this.theme.secondaryBackground} rounded-md p-4`,this.addFieldChangeListeners(),this.modalContent}addFieldChangeListeners(){this.avatar.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.nameInput.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.roleInput.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.geoInput.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.remember.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.firstNameInput.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.lastNameInput.onChange((e=>{this.modal.hasUnSavedChanges(!0),e&&this.modal.waitingOnData(!1)})),this.personalizeOnOffSwitch.onChange((()=>{this.modal.hasUnSavedChanges(!0),this.modal.waitingOnData(!1)})),this.useTimeSwitch.onChange((()=>{this.modal.hasUnSavedChanges(!0),this.modal.waitingOnData(!1)})),this.textWrapSwitch.onChange((()=>{this.modal.hasUnSavedChanges(!0),this.modal.waitingOnData(!1)}))}validate(){let e=!0;return this.nameInput.validate()||(e=!1),this.roleInput.validate()||(e=!1),this.geoInput.validate()||(e=!1),this.remember.validate()||(e=!1),this.firstNameInput.validate()||(e=!1),this.lastNameInput.validate()||(e=!1),e}saveUpdates(){if(!this.validate())return;this.modal.hasUnSavedChanges(!1);let e=null;try{e=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}const t={picture_url:this.avatar.value,occupation:this.roleInput.value,location:this.geoInput.value,remember:this.remember.value,first_name:this.firstNameInput.value,last_name:this.lastNameInput.value,call_me_name:this.nameInput.value,usePersonalizationData:!!this.personalizeOnOffSwitch.value,useTime:!!this.useTimeSwitch.value,wrapCodeBlocks:!!this.textWrapSwitch.value,latestTimezone:e,useTools:!1};this.modal.close(),u.K.savePersonalizationData(t).then((e=>{e.success?(new c.y("Personalization settings updated successfully","success",!0,!0),this.modal.hasUnSavedChanges(!1),this.updateStuff()):new c.y("Failed to save personalization data","error",!0,!0)})).catch((e=>{new c.y("Failed to save personalization data","error",!0,!0)}))}updateStuff(){const e=document.querySelectorAll(".profile-image"),t=this.avatar.value.imgUrl||this.avatar.value.picture_url;e.length>0&&e.forEach((e=>{e.src=t})),window.user.preferences.usePersonalizationData=this.personalizeOnOffSwitch.value,window.user.preferences.useTime=this.useTimeSwitch.value,window.user.preferences.wrapCodeBlocks=this.textWrapSwitch.value,window.user.preferences.useTools=!1}}class L{constructor(){u.K.hasPermission("theme:switch")?(this.theme=i.A.theme,this.currentMode=window.theme_pref||"auto",this.primaryThemeSelectionContainer=null,this.customThemeSelectorContainer=null,this.customThemeSelectorInstance=null,this.themeOptions=[],this.selectionConfig=[{name:"Auto",value:"auto",icon:"lightSwitch"},{name:"Light",value:"light",icon:"sun"},{name:"Dark",value:"dark",icon:"moon"},{name:"Custom",value:"custom",icon:"paintbrushPencil"}],this.showThemeModal()):new c.y("You do not have permission to switch themes","error")}renderThemeModeButtons(){this.primaryThemeSelectionContainer&&(this.primaryThemeSelectionContainer.innerHTML="",this.selectionConfig.forEach((e=>{const t=document.createElement("button");t.setAttribute("type","button"),t.setAttribute("data-theme-value",e.value),t.addEventListener("click",(()=>this.handleModeButtonClick(e.value)));const s="flex flex-col items-center justify-center p-4 rounded-lg transition-colors duration-150 ease-in-out focus:outline-none space-y-2";let i,n;this.currentMode===e.value?(t.className=`${s} ${this.theme.selectSelectedItemBackground||""} ${this.theme.ringSelected||""} ring-2`,i=this.theme.selectSelectedIconColor,n=this.theme.selectSelectedLabelColor):(t.className=`${s} ${this.theme.selectItemBackground||""} ${this.theme.selectMenuRing||""} ${this.theme.selectBackgroundHoverColor||""} ring-1`,i=this.theme.fadedText,n=this.theme.fadedText);const a=o.A.name(e.icon),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-8 h-8",colorClass:i});l.element&&t.appendChild(l.element);const c=document.createElement("span");c.textContent=e.name,c.className=`text-xs font-medium ${n}`,c.className=c.className.replace(/\s+/g," ").trim(),t.appendChild(c),this.primaryThemeSelectionContainer.appendChild(t)})))}handleModeButtonClick(e){this.currentMode=e,this.renderThemeModeButtons(),"custom"===e?this.showCustomThemeSelector():this.hideCustomThemeSelector()}showCustomThemeSelector(){if(this.customThemeSelectorContainer){if(!this.customThemeSelectorInstance){this.customThemeSelectorInstance=new h({enableCreate:!1,maxSelections:1,options:this.themeOptions,enableSearch:!0,searchPlaceholder:"Search custom themes..."});const e=this.customThemeSelectorInstance.create();e.classList.add("mt-4"),this.customThemeSelectorContainer.appendChild(e)}this.customThemeSelectorContainer.style.display="block"}}hideCustomThemeSelector(){this.customThemeSelectorContainer&&(this.customThemeSelectorContainer.style.display="none")}async showThemeModal(){const e=await u.K.getAvailableThemes();this.themeOptions=e.map((e=>({name:e.name,subtext:e.description,value:(e.theme_id||e.id).toString(),selected:e.current,icon:"paintbrushPencil",theme_id:e.theme_id})));const t=e.find((e=>e.current));t&&(["auto","light","dark"].includes(t.value)?this.currentMode=t.value:t.theme_id&&(this.currentMode="custom")),this.currentMode=this.currentMode||"auto",this.primaryThemeSelectionContainer=document.createElement("div"),this.primaryThemeSelectionContainer.className="grid grid-cols-4 gap-2 m-0.5 pt-4",this.renderThemeModeButtons(),this.customThemeSelectorContainer=document.createElement("div"),this.customThemeSelectorContainer.className="custom-theme-selector-area",this.customThemeSelectorContainer.style.display="none","custom"===this.currentMode&&this.showCustomThemeSelector();const s=document.createElement("div");s.className="pb-1",s.appendChild(this.primaryThemeSelectionContainer),s.appendChild(this.customThemeSelectorContainer);const n=new l({size:"medium",title:"Select theme",body:s,closeX:!0,confirmOnExit:!1,confirm:!0,cancel:!1,confirmText:"Switch theme",buttonStyleConfirm:"primary",buttonSize:"large",buttonWidth:"full",manualCloseOnConfirm:!0});n.onConfirm((async()=>{let e=null;const t=this.currentMode;if("custom"===t){if(!this.customThemeSelectorInstance)return void new c.y("Custom theme selector not available.","error");{const t=this.customThemeSelectorInstance.getSelected();if(!t||0===t.length){const e=this.primaryThemeSelectionContainer.querySelector('button[data-theme-value="custom"]');return void(e&&(e.classList.add("shake-animation"),setTimeout((()=>{e.classList.remove("shake-animation")}),500)))}e=t[0].value}}try{n.close(),await i.S.setTheme(e,t)}catch(e){new c.y("Failed to change theme","error")}}))}}var _=s(22130);const I=new WeakMap;class A{constructor(e="store"){this.theme=i.A.theme,this.activeCategory="all",this.searchQuery="",this.view=e,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleSearch=this.handleSearch.bind(this),this.toggleSidebar=this.toggleSidebar.bind(this),this.handleResize=this.handleResize.bind(this),this.showMcpDetails=this.showMcpDetails.bind(this),this.closeMcpDetails=this.closeMcpDetails.bind(this),this.showManagementOptions=this.showManagementOptions.bind(this),this.closeManagementOptions=this.closeManagementOptions.bind(this),this.filterByCategory=this.filterByCategory.bind(this),this.switchView=this.switchView.bind(this),this.handleMcpAction=this.handleMcpAction.bind(this),this.installMcp=this.installMcp.bind(this),this.uninstallMcp=this.uninstallMcp.bind(this),this.addConnection=this.addConnection.bind(this),this.removeConnection=this.removeConnection.bind(this),this.editConnection=this.editConnection.bind(this),this.testConnection=this.testConnection.bind(this),this.refreshToken=this.refreshToken.bind(this),this.renderConnectionForm=this.renderConnectionForm.bind(this),this.cancelConnectionForm=this.cancelConnectionForm.bind(this),this.handleOAuthSubmit=this.handleOAuthSubmit.bind(this),this.handleApiKeySubmit=this.handleApiKeySubmit.bind(this),this.checkingConnections=new Set,this.pollConnections=this.pollConnections.bind(this),this.categories=[],this.mcps=[],this.currentMcpDetails=null,this.currentMcpConnections=[],this.pollConnections=this.pollConnections.bind(this),this.currentFormMcp=null,this.currentFormConnection=null,this.isLoading=!1,this.isLoadingDetails=!1,this.isLoadingConnections=!1,this.container=null,this.storeEl=null,this.sidebarEl=null,this.contentEl=null,this.searchInput=null,this.mobileSearchInput=null,this.mobileMenuButton=null,this.sidebarVisible=!1,this.previousView=null,this.connectionPollingInterval=null,this.addConnectionButtonInstance=null,this.uninstallButtonInstance=null,this.detailViewActionButtonInstance=null,this.connectionFormType=null,this.apiKeyModal=null,this.loadInitialData(),window.addEventListener("resize",this.handleResize),this.handleResize()}async loadInitialData(){this.isLoading=!0,this.renderShell(),this.show(),this.renderLoadingState();try{const e="/chat/mcp/store/data/",t=await g.G.fetchData(e);if(this.categories=t.categories||[],"installed"===this.view){const e="/chat/mcp/store/data/?view=installed",t=await g.G.fetchData(e);this.mcps=t.mcps||[]}else this.mcps=t.mcps||[];this.isLoading=!1,this.render()}catch(e){new c.y("Failed to load MCP Store data.","error"),this.isLoading=!1,this.renderErrorState(`Could not load ${this.view} MCPs.`)}}renderShell(){this.container=document.createElement("div"),this.container.className="mcp-store-container fixed inset-0 z-40 flex items-start justify-center backdrop-blur-xs pt-5 sm:pt-10",this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.storeEl=document.createElement("div"),this.storeEl.className=`${this.theme.modalBackground} w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] h-[90dvh] sm:h-[80dvh] md:h-[75dvh] rounded-lg shadow-xl flex overflow-hidden ring-1 ${this.theme.ringColor} relative`;const e=document.createElement("div");e.className="absolute top-4 right-3 z-10";const t=o.A.name("tabClose"),s=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"focus",size:"small",iconHeightAndWidth:"h-6 w-6"});s.onClick((()=>this.close())),s.render(e),this.storeEl.appendChild(e),this.sidebarEl=document.createElement("div"),this.sidebarEl.className=`${this.theme.secondaryBackground} w-64 flex-shrink-0 flex flex-col border-r ${this.theme.tableBorder} hidden md:flex`,this.sidebarEl.dataset.id="desktop-sidebar",this.contentEl=document.createElement("div"),this.contentEl.className="flex-1 flex flex-col overflow-hidden",this.contentEl.dataset.id="content-area",this.sidebarOverlay=document.createElement("div"),this.sidebarOverlay.className="absolute inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden",this.sidebarOverlay.addEventListener("click",(()=>this.toggleSidebar(!1))),this.mobileSidebar=document.createElement("div"),this.mobileSidebar.className=`${this.theme.modalBackground} absolute inset-0 z-30 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden`,this.mobileSidebar.dataset.id="mobile-sidebar",this.storeEl.appendChild(this.sidebarEl),this.storeEl.appendChild(this.contentEl),this.storeEl.appendChild(this.sidebarOverlay),this.storeEl.appendChild(this.mobileSidebar),this.container.appendChild(this.storeEl),document.body.appendChild(this.container)}renderLoadingState(){if(!this.contentEl)return;this.contentEl.innerHTML="";const e=document.createElement("div");e.className=`p-3 sm:p-4 border-b ${this.theme.tableBorder} ${this.theme.modalBackground} flex items-center gap-2 sm:gap-4 animate-pulse`,e.innerHTML=`\n            <div class="md:hidden w-6 h-6 ${this.theme.loadBackground} rounded"></div>\n            <div class="h-6 ${this.theme.loadBackground} rounded flex-1"></div>\n        `;const t=document.createElement("div");t.className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6";const s=document.createElement("div");s.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3 sm:gap-4";for(let e=0;e<6;e++)s.appendChild(this.createLoadingGridItem());t.appendChild(s),this.contentEl.appendChild(e),this.contentEl.appendChild(t),this.sidebarEl.innerHTML=`<div class="p-4 border-b ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse"></div></div><div class="flex-1 p-4 space-y-3"><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse"></div><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-5/6"></div><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-4/6"></div></div><div class="p-4 border-t ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse"></div></div>`,this.mobileSidebar.innerHTML=`<div class="p-4 border-b ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse w-1/4"></div></div><div class="p-4 border-b ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse"></div></div><div class="flex-1 p-4 space-y-3"><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse"></div><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-5/6"></div><div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-4/6"></div></div><div class="p-4 border-t ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse"></div></div>`}renderErrorState(e="An error occurred."){if(!this.contentEl)return;this.contentEl.innerHTML="";const t=document.createElement("div");t.className="flex flex-col items-center justify-center h-full p-6 text-center";const s=o.A.name("error"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-12 h-12",colorClass:"text-red-500",additionalClasses:"mb-4"}),n=document.createElement("p");n.className=`text-lg font-medium ${this.theme.text} mb-2`,n.textContent="Oops! Something went wrong.";const a=document.createElement("p");a.className=this.theme.fadedText,a.textContent=e,t.appendChild(i.element),t.appendChild(n),t.appendChild(a),this.contentEl.appendChild(t)}createLoadingGridItem(){const e=document.createElement("div");e.classList.add("animate-pulse",`${this.theme.tableCardBackground}`,"rounded-lg","border",`${this.theme.tableCardBorder}`,"overflow-hidden","h-[180px]");const t=document.createElement("div");t.className="p-3 sm:p-4 flex flex-col h-full";const s=document.createElement("div");s.className="flex items-center mb-3";const i=document.createElement("div");i.className=`w-12 h-12 ${this.theme.loadBackground} rounded-md mr-3 flex-shrink-0`;const n=document.createElement("div");n.className=`h-5 ${this.theme.loadBackground} rounded w-3/5`,s.appendChild(i),s.appendChild(n);const a=document.createElement("div");a.className=`h-4 ${this.theme.loadBackground} rounded w-1/3 mb-3`;const o=document.createElement("div");o.className=`h-3 ${this.theme.loadBackground} rounded w-full mb-2`;const r=document.createElement("div");r.className=`h-3 ${this.theme.loadBackground} rounded w-5/6 mb-3`;const l=document.createElement("div");l.className="flex justify-between items-center mt-auto";const c=document.createElement("div");c.className=`h-4 ${this.theme.loadBackground} rounded w-1/4`;const d=document.createElement("div");return d.className=`h-8 ${this.theme.loadBackground} rounded w-1/3`,l.appendChild(c),l.appendChild(d),t.appendChild(s),t.appendChild(a),t.appendChild(o),t.appendChild(r),t.appendChild(l),e.appendChild(t),e}render(){if(this.isLoading||!this.storeEl)return;this.sidebarEl.innerHTML="";const e=document.createElement("div");e.className=`p-4 flex items-center justify-between border-b ${this.theme.tableBorder}`;const t=document.createElement("div");t.className="w-full";const s={type:"search",placeholder:"Search...",size:"small",onChange:this.handleSearch,value:this.searchQuery};this.searchInput=new d(s),this.searchInput.render(t),e.appendChild(t);const i=document.createElement("div");i.className="flex-1 overflow-y-auto";const a=document.createElement("ul");a.className="py-2",this.categories.forEach((e=>{const t=document.createElement("li"),s=document.createElement("button");s.dataset.categoryId=e.id,s.className="w-full text-left px-4 py-2 flex items-center transition-colors duration-150";const i=document.createElement("span");i.textContent=e.name,s.appendChild(i),s.addEventListener("click",(()=>this.filterByCategory(e.id))),t.appendChild(s),a.appendChild(t)})),i.appendChild(a);const r=document.createElement("div");r.className=`p-4 border-t ${this.theme.tableBorder}`;const l=o.A.name("cog"),c=new n.$({text:"Manage",svgPathData:l.path,svgViewBox:l.viewBox,type:"link",size:"link-sm",width:"full"});c.onClick((()=>this.switchView("installed"))),c.render(r),this.sidebarEl.appendChild(e),this.sidebarEl.appendChild(i),this.sidebarEl.appendChild(r),this.mobileSidebar.innerHTML="";const h=document.createElement("div");h.className=`p-4 flex items-center justify-between border-b ${this.theme.tableBorder}`;const m=o.A.name("chevronLeft"),u=new n.$({text:"Back",svgPathData:m.path,svgViewBox:m.viewBox,type:"secondaryTransparent",size:"small",iconHeightAndWidth:"w-4 h-4"});u.onClick((()=>this.toggleSidebar(!1))),u.render(h);const p=document.createElement("div");p.className=`p-4 border-b ${this.theme.tableBorder}`;const g=document.createElement("div");g.className="w-full",this.mobileSearchInput=new d(s),this.mobileSearchInput.render(g),p.appendChild(g);const f=document.createElement("div");f.className="flex-1 overflow-y-auto";const v=document.createElement("ul");v.className="py-2",this.categories.forEach((e=>{const t=document.createElement("li"),s=document.createElement("button");s.dataset.categoryId=e.id,s.className="w-full text-left px-4 py-3 flex items-center transition-colors duration-150";const i=document.createElement("span");i.textContent=e.name,s.appendChild(i),s.addEventListener("click",(()=>{this.filterByCategory(e.id),this.toggleSidebar(!1)})),t.appendChild(s),v.appendChild(t)})),f.appendChild(v);const y=document.createElement("div");y.className=`p-4 border-t ${this.theme.tableBorder}`;const w=new n.$({text:"Manage",svgPathData:l.path,svgViewBox:l.viewBox,type:"link",size:"link-sm",width:"full"});w.onClick((()=>{this.switchView("installed"),this.toggleSidebar(!1)})),w.render(y),this.mobileSidebar.appendChild(h),this.mobileSidebar.appendChild(p),this.mobileSidebar.appendChild(f),this.mobileSidebar.appendChild(y),this.contentEl.querySelector('[data-id="content-header"]')||this.renderContentArea(),this.refreshContent()}renderContentArea(){if(!this.contentEl)return;this.contentEl.innerHTML="";const e=document.createElement("div");e.className=`p-3 sm:p-4 border-b ${this.theme.tableBorder} ${this.theme.modalBackground} flex flex-wrap sm:flex-nowrap items-center gap-2 sm:gap-0`,e.dataset.id="content-header";const t=o.A.name("bars");this.mobileMenuButton=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"secondaryTransparent",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden"}),this.mobileMenuButton.onClick((()=>this.toggleSidebar()));const s=document.createElement("h3");s.className=`font-medium ${this.theme.text} flex-1`,s.textContent=this.getContentTitle(),s.dataset.id="content-title",e.appendChild(this.mobileMenuButton.element),e.appendChild(s);const i=document.createElement("div");i.className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6",i.dataset.id="content-body",this.contentEl.appendChild(e),this.contentEl.appendChild(i)}toggleSidebar(e=null){const t=null!==e?e:!this.sidebarVisible;this.sidebarVisible=t,this.mobileSidebar&&this.sidebarOverlay&&(t?(this.mobileSidebar.classList.remove("-translate-x-full"),this.mobileSidebar.classList.add("translate-x-0"),this.sidebarOverlay.classList.remove("hidden")):(this.mobileSidebar.classList.remove("translate-x-0"),this.mobileSidebar.classList.add("-translate-x-full"),this.sidebarOverlay.classList.add("hidden")))}handleResize(){window.innerWidth>=768&&this.sidebarVisible&&this.toggleSidebar(!1)}createMcpCard(e){const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} overflow-hidden shadow-sm hover:shadow-md transition-shadow`,t.classList.add(...this.theme.ringHover.split(" ")),t.dataset.mcpId=e.id;const s=document.createElement("div");s.className="p-3 sm:p-4 flex flex-col h-full";const i=document.createElement("div");i.className="flex items-center mb-2 sm:mb-3";const a=document.createElement("div");a.className="w-10 h-10 sm:w-12 sm:h-12 rounded-md overflow-hidden mr-2 sm:mr-3 flex-shrink-0 drop-shadow-md";const o=document.createElement("img");o.src=e.image||"https://via.placeholder.com/48",o.alt=`${e.name} logo`,o.className="w-full h-full object-cover",a.appendChild(o);const r=document.createElement("h5");r.className=`font-medium text-base ${this.theme.tablePrimaryColumnText} line-clamp-2`,r.textContent=e.name,i.appendChild(a),i.appendChild(r);const l=document.createElement("div");l.className="flex mb-2 sm:mb-3";const c=document.createElement("span");c.className=`${this.theme.skillTag} text-xs px-2 py-1 rounded-full`,c.textContent=this.categories.find((t=>t.id===e.category))?.name||e.category||"Custom MCP",l.appendChild(c);const d=document.createElement("p");d.className=`${this.theme.fadedText} text-xs sm:text-sm mb-3 sm:mb-4 line-clamp-2`,d.textContent=e.description;const h=document.createElement("div");h.className="flex justify-between items-center align-middle gap-2 w-full mt-auto";const m=document.createElement("div");m.className="flex items-start";const u=new n.$({text:"Learn more",type:"link",size:"link-sm",width:"auto"});u.onClick((()=>this.showMcpDetails(e))),u.render(m);const p=document.createElement("div");p.className="flex items-center";const g=new n.$({text:e.installed?"Manage":"Install",type:e.installed?"ringSecondary":"ringPrimary",size:"small",width:"auto",disabled:!e.enabled});return g.onClick((()=>this.handleMcpAction(e))),g.render(p),I.set(t,g),h.appendChild(m),h.appendChild(p),s.appendChild(i),s.appendChild(l),s.appendChild(d),s.appendChild(h),t.appendChild(s),t}getFilteredMcps(){let e=[...this.mcps];if("installed"===this.view?e=e.filter((e=>e.is_custom||e.installed)):"all"!==this.activeCategory&&"whats-new"!==this.activeCategory&&(e=e.filter((e=>e.category===this.activeCategory))),this.searchQuery){const t=this.searchQuery.toLowerCase();e=e.filter((e=>e.name.toLowerCase().includes(t)||e.description.toLowerCase().includes(t)))}return e}getContentTitle(){if("installed"===this.view)return"Manage";if("detail"===this.view||"management"===this.view)return"";const e=this.categories.find((e=>e.id===this.activeCategory));return e?e.name:"MCPs"}_stopConnectionPolling(){this.connectionPollingInterval&&(clearInterval(this.connectionPollingInterval),this.connectionPollingInterval=null)}async filterByCategory(e){"detail"===this.view?this.closeMcpDetails():"management"===this.view&&this.closeManagementOptions(),this.activeCategory=e,this.view="store",this.searchQuery="",this.searchInput&&(this.searchInput.value=""),this.mobileSearchInput&&(this.mobileSearchInput.value=""),this.isLoading=!0,this.refreshContent(),this.updateCategoryHighlighting(e);try{const t=await g.G.fetchData(`/chat/mcp/store/data/?category=${e}`);this.mcps=t.mcps||[],this.isLoading=!1,this.refreshContent()}catch(t){const s=this.categories.find((t=>t.id===e))?.name||"category";new c.y(`Failed to load MCPs for ${s}.`,"error"),this.isLoading=!1,this.renderErrorState(`Could not load MCPs for ${s}.`)}}async handleSearch(e){"detail"===this.view?this.closeMcpDetails():"management"===this.view&&this.closeManagementOptions(),this.searchQuery=e,this.view="store",this.activeCategory="all",this.isLoading=!0,this.refreshContent(),this.updateCategoryHighlighting("all");try{const t=`/chat/mcp/store/data/?search=${encodeURIComponent(e)}`,s=await g.G.fetchData(t);this.mcps=s.mcps||[],this.isLoading=!1,this.refreshContent()}catch(e){new c.y("Failed to perform search.","error"),this.isLoading=!1,this.renderErrorState("Could not perform search.")}}async switchView(e){if(this.view!==e){"detail"===this.view&&this.closeMcpDetails(),this.view=e,this.searchQuery="",this.searchInput&&(this.searchInput.value=""),this.mobileSearchInput&&(this.mobileSearchInput.value=""),this.isLoading=!0,this.refreshContent(),this.updateCategoryHighlighting("installed"===e?null:this.activeCategory);try{let t="/chat/mcp/store/data/";"installed"===e?t+="?view=installed":(this.activeCategory="all",this.updateCategoryHighlighting("all"));const s=await g.G.fetchData(t);this.mcps=s.mcps||[],this.isLoading=!1,this.refreshContent()}catch(t){new c.y(`Failed to load ${e} MCPs.`,"error"),this.isLoading=!1,this.renderErrorState(`Could not load ${e} MCPs.`)}}}updateCategoryHighlighting(e){const t=t=>{t.forEach((t=>{const s=t.dataset.categoryId;t.classList.remove(...this.theme.menuSelectedItem.split(" "),...this.theme.backgroundHover.split(" ")),t.classList.remove("font-medium"),e===s?(t.className="w-full text-left px-4 py-2 flex items-center font-medium",t.classList.add(...this.theme.menuSelectedItem.split(" "))):(t.className=`w-full text-left px-4 py-2 ${this.theme.text} flex items-center`,t.classList.add(...this.theme.backgroundHover.split(" ")))}))};this.sidebarEl&&t(this.sidebarEl.querySelectorAll("ul button")),this.mobileSidebar&&t(this.mobileSidebar.querySelectorAll("ul button"))}refreshContent(){let e=this.contentEl?.querySelector('[data-id="content-header"]'),t=this.contentEl?.querySelector('[data-id="content-body"]');if(e&&t||(this.renderContentArea(),e=this.contentEl.querySelector('[data-id="content-header"]'),t=this.contentEl.querySelector('[data-id="content-body"]')),!e||!t)return;const s=e.querySelector('[data-id="content-title"]');if(s&&(s.textContent=this.getContentTitle()),this.updateCategoryHighlighting("installed"===this.view?null:this.activeCategory),t.innerHTML="","installed"===this.view&&u.K.hasPermission("feature:mcps-custom")){const e=document.createElement("div");e.dataset.id="add-custom-mcp-button-row",e.className=`pt-0 pb-2 flex justify-between items-center ${this.theme.modalBackground} mb-4`;const s=document.createElement("h4");s.className=`text-lg font-medium ${this.theme.text}`,s.textContent="Connections",e.appendChild(s);const i=o.A.name("plus"),a=new n.$({text:"Add custom",svgPathData:i?i.path:"",svgViewBox:i?i.viewBox:"0 0 24 24",type:"ringSecondary",size:"small"});a.onClick((()=>{this.showAddCustomMcpDialog()}));const r=document.createElement("div");a.render(r),e.appendChild(r),t.appendChild(e)}if(this.isLoading){const e=document.createElement("div");e.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3 sm:gap-4";for(let t=0;t<6;t++)e.appendChild(this.createLoadingGridItem());return void t.appendChild(e)}const i=this.getFilteredMcps(),a="store"===this.view&&"all"===this.activeCategory&&!this.searchQuery,l=a?i.filter((e=>e.popular)):[];if(a&&l.length>0){const e=document.createElement("div");e.className="mb-6 sm:mb-8";const s=document.createElement("h4");s.className=`text-lg font-medium mb-3 sm:mb-4 ${this.theme.text}`,s.textContent="Popular";const i=document.createElement("div");i.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3 sm:gap-4",l.forEach((e=>i.appendChild(this.createMcpCard(e)))),e.appendChild(s),e.appendChild(i),t.appendChild(e)}const c=document.createElement("div"),d=document.createElement("div");d.className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-2 gap-3 sm:gap-4";let h=i;if(a&&(h=i.filter((e=>!e.popular))),"store"===this.view&&"all"===this.activeCategory&&l.length>0&&h.length>0&&!this.searchQuery){const e=document.createElement("h4");e.className=`text-lg font-medium mb-3 sm:mb-4 ${this.theme.text}`,e.textContent="All",c.appendChild(e)}if(h.length>0)h.forEach((e=>d.appendChild(this.createMcpCard(e))));else if(0===i.length){const e=document.createElement("div");e.className="col-span-1 sm:col-span-2 lg:col-span-2 text-center py-8 sm:py-12";const t=document.createElement("div");t.className=`text-2xl sm:text-4xl mb-2 ${this.theme.iconColor} flex justify-center`;const s=o.A.name("boxOpen"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-10 h-10 sm:w-12 sm:h-12"});t.appendChild(i.element);const n=document.createElement("p");n.className=this.theme.fadedText,n.textContent="installed"===this.view?"No MCPs installed yet.":"No MCPs found matching your criteria.",e.appendChild(t),e.appendChild(n),d.appendChild(e)}c.appendChild(d),t.appendChild(c)}async handleMcpAction(e){e.installed?await this.showManagementOptions(e):await this.installMcp(e)}async installMcp(e){const t=this.contentEl?.querySelector(`[data-mcp-id="${e.id}"]`),s=t?I.get(t):null,i=this.detailViewActionButtonInstance,n=s||i;n&&n.toggleLoading("Installing...");try{const t=await g.G.postData(`/chat/mcp/store/install/${e.id}/`);if(t.success||t.installed){const s=this.mcps.findIndex((t=>t.id===e.id));if(-1!==s&&(this.mcps[s].installed=!0,t.connection_config&&(this.mcps[s].connection_config=t.connection_config,e.connection_config=t.connection_config)),"detail"===this.view&&this.currentMcpDetails&&this.currentMcpDetails.id===e.id&&(this.currentMcpDetails.installed=!0,t.connection_config&&(this.currentMcpDetails.connection_config=t.connection_config)),n){n.text="Manage",n.config.type="ringSecondary",n.element.className=`${n.getButtonStyle()} ${n.getButtonSize()} flex gap-1 align-middle items-center justify-center ${n.getButtonWidth()}`;const e=n.element.querySelector("div:last-child");e&&(e.textContent="Manage")}const i=this.mcps.find((t=>t.id===e.id))||this.currentMcpDetails||e;this.addConnection(i,"install")}else new c.y(t.error||`Failed to install ${e.name}.`,"error")}catch(t){new c.y(`Error installing ${e.name}. Please try again.`,"error")}finally{n&&n.loading&&n.toggleLoading()}}handleKeyDown(e){if("Escape"===e.key){const e=document.querySelector(".connection-options-dropdown");if(e)return void e.remove();if("installation-settings"===this.view)return void this.cancelInstallationSettingsForm();if("connection-form"===this.view)return void this.cancelConnectionForm();"detail"===this.view?this.closeMcpDetails():"management"===this.view?this.closeManagementOptions():this.sidebarVisible?this.toggleSidebar(!1):this.close()}}async showMcpDetails(e){if(e&&"object"==typeof e&&e.id&&e.name){this.isLoadingDetails=!0,this.previousView={view:this.view,activeCategory:this.activeCategory,searchQuery:this.searchQuery},this.view="detail",this.renderDetailLoadingState(e);try{const t=`/chat/mcp/store/details/${e.id}/`,s=await g.G.fetchData(t);if(!s||"object"!=typeof s||!s.name)throw new Error(`Invalid details received for ${e.name}`);this.currentMcpDetails=s,this.isLoadingDetails=!1,this.renderMcpDetailView()}catch(t){try{new c.y(`Failed to load details for ${e.name}. Please try again.`,"error")}catch(e){}this.isLoadingDetails=!1,this.closeMcpDetails()}}else try{new c.y("Cannot show details: Invalid MCP data provided.","error")}catch(e){alert("Cannot show details: Invalid MCP data provided.")}}renderDetailLoadingState(e){const t=this.contentEl?.querySelector('[data-id="content-header"]'),s=this.contentEl?.querySelector('[data-id="content-body"]');if(t&&s||(this.renderContentArea(),t=this.contentEl.querySelector('[data-id="content-header"]'),s=this.contentEl.querySelector('[data-id="content-body"]')),!t||!s)return;t.innerHTML="";const i=document.createElement("div");i.className="flex items-center";const a=o.A.name("bars"),r=new n.$({svgPathData:a.path,svgViewBox:a.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden mr-2"});r.onClick((()=>this.toggleSidebar()));const l=o.A.name("chevronLeft"),c=new n.$({svgPathData:l.path,svgViewBox:l.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5 mx-2"});c.onClick((()=>this.closeMcpDetails())),i.appendChild(r.element),i.appendChild(c.element),t.appendChild(i);const d=document.createElement("span");d.className=`ml-2 font-medium ${this.theme.text} truncate`,d.textContent=e.name,t.appendChild(d),s.innerHTML="",s.classList.add("animate-pulse");const h=document.createElement("div");h.className="flex items-start mb-6";const m=document.createElement("div");m.className=`w-20 h-20 ${this.theme.loadBackground} rounded-lg mr-4 flex-shrink-0`;const u=document.createElement("div");u.className="flex-1 space-y-2";const p=document.createElement("div");p.className=`h-6 ${this.theme.loadBackground} rounded w-1/2`;const g=document.createElement("div");g.className=`h-4 ${this.theme.loadBackground} rounded w-1/3`;const f=document.createElement("div");f.className=`h-5 ${this.theme.loadBackground} rounded w-1/4`,u.appendChild(p),u.appendChild(g),u.appendChild(f);const v=document.createElement("div");v.className=`w-24 h-8 ${this.theme.loadBackground} rounded ml-auto self-start`,h.appendChild(m),h.appendChild(u),h.appendChild(v),s.appendChild(h);const y=document.createElement("div");y.className="mb-6 space-y-2";const w=document.createElement("div");w.className=`h-5 ${this.theme.loadBackground} rounded w-1/4 mb-2`;const b=document.createElement("div");b.className=`h-4 ${this.theme.loadBackground} rounded w-full`;const C=document.createElement("div");C.className=`h-4 ${this.theme.loadBackground} rounded w-full`;const x=document.createElement("div");x.className=`h-4 ${this.theme.loadBackground} rounded w-5/6`,y.appendChild(w),y.appendChild(b),y.appendChild(C),y.appendChild(x),s.appendChild(y);const k=document.createElement("div");k.className="mb-6 space-y-3";const E=document.createElement("div");E.className=`h-5 ${this.theme.loadBackground} rounded w-1/3 mb-3`,k.appendChild(E);for(let e=0;e<3;e++){const e=document.createElement("div");e.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-3 space-y-2`;const t=document.createElement("div");t.className=`h-4 ${this.theme.loadBackground} rounded w-1/2`;const s=document.createElement("div");s.className=`h-3 ${this.theme.loadBackground} rounded w-full`,e.appendChild(t),e.appendChild(s),k.appendChild(e)}s.appendChild(k)}renderMcpDetailView(){const e=this.currentMcpDetails;if(this.isLoadingDetails||!e||!this.contentEl)return;const t=this.contentEl.querySelector('[data-id="content-header"]'),s=this.contentEl.querySelector('[data-id="content-body"]');if(!t||!s)return;s.classList.remove("animate-pulse"),s.innerHTML="";const i=t.querySelector("span");i&&(i.textContent=e.name);const a=document.createElement("div");a.className="flex items-start mb-6";const l=document.createElement("div");l.className="w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden mr-4 flex-shrink-0 drop-shadow-md";const c=document.createElement("img");c.src=e.image||"https://via.placeholder.com/80",c.alt=`${e.name} logo`,c.className="w-full h-full object-cover",l.appendChild(c);const d=document.createElement("div");d.className="flex-1 min-w-0";const h=document.createElement("h2");h.className=`text-xl font-medium ${this.theme.text} truncate`,h.textContent=e.name,d.appendChild(h);const m=document.createElement("div");m.className="flex items-center mt-1 mb-2";const u=document.createElement("span");if(u.className=`${this.theme.fadedText} text-sm truncate`,u.textContent=`By ${e.author?.name||"Unknown Publisher"}`,m.appendChild(u),e.author?.verified){const e=document.createElement("span");e.className="ml-2 text-blue-500 dark:text-blue-400 cursor-help flex-shrink-0",e.title="Verified Publisher";const t=o.A.name("badgeCheck"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});e.appendChild(s.element),m.appendChild(e)}d.appendChild(m);const p=document.createElement("div");p.className="mt-1 flex items-center gap-2 flex-wrap";const g=document.createElement("span");g.className=`${this.theme.skillTag} text-xs px-2 py-1 rounded-full`,g.textContent=e.category_name||(e.is_custom?"Custom":"Uncategorized"),p.appendChild(g),d.appendChild(p);const f=document.createElement("div");if(f.className="flex items-center self-start ml-auto pl-4 gap-2 flex-shrink-0",e.is_custom&&e.can_delete_custom_mcp){const t=o.A.name("trash"),s=new n.$({text:"Remove",svgPathData:t.path,svgViewBox:t.viewBox,type:"ringDanger",size:"small",width:"auto"});s.onClick((()=>this.removeCustomMcpDefinition(e))),s.render(f)}this.detailViewActionButtonInstance=new n.$({text:e.installed?"Manage":"Install",type:e.installed?"ringSecondary":"ringPrimary",size:"small",width:"auto",disabled:!e.enabled}),this.detailViewActionButtonInstance.onClick((()=>this.handleMcpAction(e))),this.detailViewActionButtonInstance.render(f),a.appendChild(l),a.appendChild(d),a.appendChild(f),s.appendChild(a);const v=document.createElement("div");v.className="mb-6";const y=document.createElement("h3");y.className=`text-lg font-medium ${this.theme.text} mb-2`,y.textContent="Description";const w=document.createElement("p");w.className=`${this.theme.text} text-sm sm:text-base whitespace-pre-wrap`,w.textContent=e.longDescription||e.short_description||"No description available.",v.appendChild(y),v.appendChild(w),s.appendChild(v);const b=document.createElement("div");b.className="mb-6";const C=document.createElement("h3");if(C.className=`text-lg font-medium ${this.theme.text} mb-3`,C.textContent="What can it do?",b.appendChild(C),e.tools&&e.tools.length>0){const t=document.createElement("div");t.className="space-y-3",e.tools.forEach((e=>{const s=document.createElement("div");s.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-3`;const i=document.createElement("h4");i.className=`font-medium ${this.theme.text} mb-1`,i.textContent=e.name;const n=document.createElement("p");n.className=`${this.theme.fadedText} text-sm`,n.textContent=e.description,s.appendChild(i),s.appendChild(n),t.appendChild(s)})),b.appendChild(t)}else{const e=document.createElement("p");e.className=`${this.theme.fadedText} text-sm`,e.textContent="No specific tools listed for this MCP.",b.appendChild(e)}if(s.appendChild(b),e.pricing&&e.pricing.length>0){const t=document.createElement("div");t.className="mb-6";const i=document.createElement("h3");i.className=`text-lg font-medium ${this.theme.text} mb-3`,i.textContent="How many premium tokens does it cost?",t.appendChild(i);const n=document.createElement("div");n.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} px-4 py-2`;const a=document.createElement("div");a.className="space-y-2",e.pricing.forEach((e=>{const t=document.createElement("div");t.className="flex items-center justify-between py-2";const s=document.createElement("div");s.className="flex-1";const i=document.createElement("span");i.className=`${this.theme.fadedText} text-base`,i.textContent=e.description,s.appendChild(i);const n=document.createElement("div");n.className="flex items-center gap-2";const o=document.createElement("span");o.className="font-semibold text-sm";const r=e.tokens;o.textContent=`${r}`,n.appendChild(o);const l=document.createElement("span");l.className=`${this.theme.fadedText} text-sm`,l.textContent=`per ${e.unit.replace("per_","").replace(/_/g," ")}`,n.appendChild(l),t.appendChild(s),t.appendChild(n),a.appendChild(t)})),n.appendChild(a),t.appendChild(n),s.appendChild(t)}const x=document.createElement("div");if(x.className="mb-6",e.sample_prompts&&e.sample_prompts.length>0){const t=document.createElement("h3");t.className=`text-lg font-medium ${this.theme.text} mb-3`,t.textContent="Sample prompts",x.appendChild(t);const s=document.createElement("div");s.className="space-y-2",e.sample_prompts.forEach((e=>{const t=document.createElement("div");t.className=`${this.theme.secondaryBackground} ${this.theme.fadedText} text-sm px-4 py-2 rounded border ${this.theme.tableCardBorder}`,t.textContent=e,s.appendChild(t)})),x.appendChild(s)}s.appendChild(x)}closeMcpDetails(){this.previousView?(this.view=this.previousView.view,this.activeCategory=this.previousView.activeCategory,this.searchQuery=this.previousView.searchQuery,this.previousView=null,this.currentMcpDetails=null,this.detailViewActionButtonInstance=null,this.renderContentArea(),this.refreshContent()):this.switchView("store")}async showManagementOptions(e){this.isLoadingConnections=!0,this.previousView={view:this.view,activeCategory:this.activeCategory,searchQuery:this.searchQuery},this.view="management",this.renderManagementLoadingState(e);try{const t=await g.G.fetchData(`/chat/mcp/connections/${e.id}/`);this.currentMcpDetails=t.mcp,this.currentMcpConnections=t.connections||[],this.isLoadingConnections=!1,this.renderManagementView(),this.connectionPollingInterval||(this.connectionPollingInterval=setInterval(this.pollConnections,5e3))}catch(t){new c.y(`Failed to load connections for ${e.name}.`,"error"),this.isLoadingConnections=!1,this.closeManagementOptions()}}async pollConnections(){if("management"!==this.view||!this.currentMcpDetails)return;const e=this.currentMcpDetails.id;try{const t=await g.G.fetchData(`/chat/mcp/connections/${e}/`);if("management"===this.view&&this.currentMcpDetails?.id===e){const e=t.connections||[];let s=!1;if(e.length!==this.currentMcpConnections.length)s=!0;else for(const t of e){const e=this.currentMcpConnections.find((e=>e.id===t.id));if(!e||e.status!==t.status||e.last_error!==t.last_error){s=!0;break}}s&&(this.currentMcpConnections=e,this.refreshConnectionsList(this.currentMcpDetails))}}catch(e){}}renderManagementLoadingState(e){const t=this.contentEl?.querySelector('[data-id="content-header"]'),s=this.contentEl?.querySelector('[data-id="content-body"]');if(t&&s||(this.renderContentArea(),t=this.contentEl.querySelector('[data-id="content-header"]'),s=this.contentEl.querySelector('[data-id="content-body"]')),!t||!s)return;t.innerHTML="";const i=document.createElement("div");i.className="flex items-center";const a=o.A.name("bars"),r=new n.$({svgPathData:a.path,svgViewBox:a.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden mr-2"});r.onClick((()=>this.toggleSidebar()));const l=o.A.name("chevronLeft"),c=new n.$({svgPathData:l.path,svgViewBox:l.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5 mx-2"});c.onClick((()=>this.closeManagementOptions())),i.appendChild(r.element),i.appendChild(c.element),t.appendChild(i);const d=document.createElement("span");d.className=`ml-2 font-medium ${this.theme.text} truncate`,d.textContent=e.name,t.appendChild(d),s.innerHTML="",s.classList.add("animate-pulse");const h=document.createElement("div");h.className="flex items-start mb-6";const m=document.createElement("div");m.className=`w-20 h-20 ${this.theme.loadBackground} rounded-lg mr-4 flex-shrink-0`;const u=document.createElement("div");u.className="flex-1 space-y-2";const p=document.createElement("div");p.className=`h-6 ${this.theme.loadBackground} rounded w-1/2`;const g=document.createElement("div");g.className=`h-5 ${this.theme.loadBackground} rounded w-1/4`,u.appendChild(p),u.appendChild(g);const f=document.createElement("div");f.className=`w-24 h-8 ${this.theme.loadBackground} rounded ml-auto self-start`,h.appendChild(m),h.appendChild(u),h.appendChild(f),s.appendChild(h);const v=document.createElement("div");v.className="mb-6";const y=document.createElement("div");y.className="flex justify-between items-center mb-3";const w=document.createElement("div");w.className=`h-5 ${this.theme.loadBackground} rounded w-1/3`;const b=document.createElement("div");b.className=`h-8 ${this.theme.loadBackground} rounded w-1/4`,y.appendChild(w),y.appendChild(b),v.appendChild(y);const C=document.createElement("div");C.className="space-y-3";for(let e=0;e<2;e++){const e=document.createElement("div");e.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex items-center justify-between gap-4`;const t=document.createElement("div");t.className="flex-1 space-y-1";const s=document.createElement("div");s.className=`h-4 ${this.theme.loadBackground} rounded w-3/5`;const i=document.createElement("div");i.className=`h-3 ${this.theme.loadBackground} rounded w-4/5`,t.appendChild(s),t.appendChild(i);const n=document.createElement("div");n.className=`w-6 h-6 ${this.theme.loadBackground} rounded-md flex-shrink-0`,e.appendChild(t),e.appendChild(n),C.appendChild(e)}v.appendChild(C),s.appendChild(v)}renderManagementView(){const e=this.currentMcpDetails||this.currentFormMcp,t=this.currentMcpConnections;if(this.isLoadingConnections||!e||!this.contentEl)return;const s=this.contentEl.querySelector('[data-id="content-header"]'),i=this.contentEl.querySelector('[data-id="content-body"]');if(!s||!i)return;i.classList.remove("animate-pulse"),i.innerHTML="";const a=s.querySelector("span");a&&(a.textContent=e.name);const l=document.createElement("div");l.className="flex items-start mb-6";const c=document.createElement("div");c.className="w-16 h-16 sm:w-20 sm:h-20 rounded-lg overflow-hidden mr-4 flex-shrink-0 drop-shadow-md";const d=document.createElement("img");d.src=e.image,d.alt=`${e.name} logo`,d.className="w-full h-full object-cover",c.appendChild(d);const h=document.createElement("div");h.className="flex-1 min-w-0";const m=document.createElement("h2");m.className=`text-xl font-medium ${this.theme.text} truncate`,m.textContent=e.name,h.appendChild(m);const u=document.createElement("div");u.className="mt-1";const p=document.createElement("span");p.className=`${this.theme.skillTag} text-xs px-2 py-1 rounded-full`,p.textContent=e.category_name||"Custom MCP",u.appendChild(p),h.appendChild(u);const g=document.createElement("div");g.className="flex items-center self-start ml-auto pl-4 gap-4",this.uninstallButtonInstance=new n.$({text:"Uninstall",type:"link",size:"link-sm"}),this.uninstallButtonInstance.onClick((()=>this.uninstallMcp(e))),this.uninstallButtonInstance.render(g);const f=new n.$({text:"Settings",type:"ringSecondary",size:"small"});f.onClick((()=>this.showInstallationSettings(e))),f.render(g),l.appendChild(c),l.appendChild(h),l.appendChild(g),i.appendChild(l);const v=document.createElement("div");v.className="mb-6";const y=document.createElement("div");y.className="flex justify-between items-center mb-3";const w=document.createElement("h3");w.className=`text-lg font-medium ${this.theme.text}`,w.textContent="Connections",y.appendChild(w);let b="Add connection";e.connection_config&&"oauth2"===e.connection_config.type?b=`Connect ${e.connection_config.label||e.name}`:e.connection_config&&"apikey"===e.connection_config.type&&(b="Add API key");const C=o.A.name("plus");this.addConnectionButtonInstance=new n.$({text:b,svgPathData:C.path,svgViewBox:C.viewBox,type:"ringPrimary",size:"small",width:"auto",disabled:!e.allow_multiple_connections&&t.length>0}),this.addConnectionButtonInstance.onClick((()=>this.addConnection(e))),this.addConnectionButtonInstance.render(y),v.appendChild(y);if(!t.some((e=>"active"===e.status))){const t=document.createElement("div");t.className=`mcp-info-banner flex items-center justify-between mt-1 mb-4 p-4 ${this.theme.toastWarning} rounded-md text-base`,t.textContent=`To complete your installation and use ${e.name}, you need at least one valid (active) connection.`,v.appendChild(t)}if(t.length>0){const s=document.createElement("div");s.className="space-y-3",s.dataset.id="connections-list",t.forEach((t=>{s.appendChild(this.createConnectionCard(t,e))})),v.appendChild(s)}else{const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-6 text-center`,t.dataset.id="no-connections-state";const s=document.createElement("div");s.className=`text-3xl mb-2 ${this.theme.iconColor} flex flex-col items-center justify-center`;const i=o.A.name("boxOpen"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-10 h-10 sm:w-12 sm:h-12"});s.appendChild(n.element);const a=document.createElement("p");a.className=this.theme.fadedText,a.textContent=`No connections configured for ${e.name}. ${e.connection_config?.type?"Add one to get started.":""}`,t.appendChild(s),t.appendChild(a),v.appendChild(t)}i.appendChild(v)}showInstallationSettings(e){this.previousView={view:this.view,activeCategory:this.activeCategory,searchQuery:this.searchQuery},this.view="installation-settings",this.renderInstallationSettingsForm(e)}renderInstallationSettingsForm(e){const t=this.contentEl?.querySelector('[data-id="content-header"]'),s=this.contentEl?.querySelector('[data-id="content-body"]');if(!t||!s)return;t.innerHTML="";const i=document.createElement("div");i.className="flex items-center";const a=o.A.name("chevronLeft"),r=new n.$({svgPathData:a.path,svgViewBox:a.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5 mx-2"});r.onClick((()=>this.cancelInstallationSettingsForm())),i.appendChild(r.element),t.appendChild(i);const l=document.createElement("span");l.className=`ml-2 font-medium ${this.theme.text} truncate`,l.textContent=`Settings for ${e.name}`,t.appendChild(l),s.innerHTML="",s.className="flex-1 overflow-y-auto p-4 md:p-6";const c=document.createElement("div");c.className="flex flex-col mt-4";const d=document.createElement("div");d.className="flex items-center mb-6";const h=document.createElement("div");h.className="w-16 h-16 rounded-lg overflow-hidden mr-3 flex-shrink-0 drop-shadow-md";const m=document.createElement("img");m.src=e.image||"https://via.placeholder.com/48",m.alt=`${e.name} logo`,m.className="w-full h-full object-cover",h.appendChild(m);const u=document.createElement("div");u.className="flex-1";const g=document.createElement("h2");g.className=`text-lg font-medium ${this.theme.text}`,g.textContent=e.name,u.appendChild(g);const f=document.createElement("p");f.className=`${this.theme.fadedText} text-base mt-1`,f.textContent="These instructions apply to all connections for this MCP.",u.appendChild(f),d.appendChild(h),d.appendChild(u),c.appendChild(d);const v=document.createElement("div");v.className="space-y-5",v.dataset.id="installation-settings-form-fields";const y=document.createElement("div"),w=new p({id:"installation-instructions-input",label:"MCP Instructions",placeholder:"e.g., Always use this MCP when I ask to create an image unless I specify otherwise.",rows:8,canGrow:!0,value:e.prompt_instructions||""});w.render(y),v.appendChild(y);const b=document.createElement("div");b.className="mt-6 flex gap-2 justify-end";const C=document.createElement("div"),x=new n.$({text:"Cancel",type:"secondary",size:"medium"});x.onClick((()=>this.cancelInstallationSettingsForm())),x.render(C);const k=document.createElement("div"),E=new n.$({text:"Save",type:"primary",size:"medium"});E.onClick((()=>{this.handleUpdateInstallationSettings(e,w.value,E)})),E.render(k),b.appendChild(C),b.appendChild(k),v.appendChild(b),c.appendChild(v),s.appendChild(c)}async handleUpdateInstallationSettings(e,t,s){s.toggleLoading("Saving...");try{const i={installation_id:e.id,prompt_instructions:t},n=await g.G.postData("/chat/mcp/installation/update/",i);n.success?await this.showManagementOptions(this.currentMcpDetails):(new c.y(n.error||"Failed to update instructions.","error"),s.toggleLoading(!1))}catch(e){new c.y("An unexpected error occurred.","error"),s.toggleLoading(!1)}}async cancelInstallationSettingsForm(){await this.showManagementOptions(this.currentMcpDetails)}createConnectionCard(e,t){const s=document.createElement("div");s.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex items-center justify-between gap-4`,s.dataset.connectionId=e.id;const i=document.createElement("div");i.className="flex-1 min-w-0";const a=document.createElement("h4");a.className=`font-medium ${this.theme.text} truncate`,a.textContent=e.name,i.appendChild(a);const l=document.createElement("div");l.className=`${this.theme.fadedText} text-sm mt-1 flex items-center flex-wrap gap-x-3`;const c=document.createElement("span");c.className="text-xs px-2 py-0.5 rounded-full whitespace-nowrap inline-flex items-center gap-1 text-sm";let d="help",h="Unknown";switch(e.status&&(h=e.status.charAt(0).toUpperCase()+e.status.slice(1)),e.status){case"active":c.classList.add("bg-green-100","text-green-800","dark:bg-green-900/50","dark:text-green-300"),d="check";break;case"launching":const e=o.A.name("spinner"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3",additionalClasses:"animate-spin"}),s=document.createElement("span");s.textContent="Creating server...",c.appendChild(t.element),c.appendChild(s),c.className=`text-xs px-2 py-0.5 rounded-full whitespace-nowrap inline-flex items-center gap-1 ${this.theme.fadedText}`;break;case"pending":c.classList.add("bg-blue-100","text-blue-800","dark:bg-blue-900/50","dark:text-blue-300"),d="clock",h="Pending MCP launch";break;case"pending_auth":c.classList.add("bg-blue-100","text-blue-800","dark:bg-blue-900/50","dark:text-blue-300"),d="clock",h="Pending authentication";break;case"pending_manual":c.classList.add("bg-yellow-100","text-yellow-800","dark:bg-yellow-900/50","dark:text-yellow-400"),d="clock",h="Pending approval";break;case"error":c.classList.add("bg-red-100","text-red-800","dark:bg-red-900/50","dark:text-red-300"),d="warning";break;default:c.classList.add("bg-gray-100","text-gray-800","dark:bg-gray-700/50","dark:text-gray-300"),d="powerOff"}if("launching"!==e.status){const e=o.A.name(d),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3"}),s=document.createElement("span");s.textContent=h,c.appendChild(t.element),c.appendChild(s)}l.appendChild(c);const m=document.createElement("span");m.className="inline-flex items-center gap-1";let u="lock",p="API key";if("oauth2"===e.type?(u="lock",p="OAuth 2.0"):"none"===e.type&&(u="puzzle",p="None"),"None"!==p){const e=o.A.name(u),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3"}),s=document.createElement("span");s.textContent=p,m.appendChild(t.element),m.appendChild(s),l.appendChild(m)}let g="";if(e.config?.workspace?g=`(${e.config.workspace})`:e.createdAt&&(g=`Created ${new Date(e.createdAt).toLocaleDateString()}`),g){const e=document.createElement("span");e.className="truncate hidden sm:inline",e.textContent=g,l.appendChild(e)}i.appendChild(l);const f=document.createElement("div");f.className="flex items-center flex-shrink-0";const v=o.A.name("ellipsisVertical"),y=new n.$({svgPathData:v.path,svgViewBox:v.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"ml-2"});return y.element.setAttribute("aria-label","Connection options"),y.onClick((s=>{const i=document.querySelector(".connection-options-dropdown");i&&i.remove(),this.showConnectionOptions(e,t,y.element)})),y.render(f),s.appendChild(i),s.appendChild(f),s}async handleDiscoveryOAuthSubmit(e,t,s=null){try{let i,n;if(s)i=s.id,n=s.name;else{const s=this._getAndValidateFormData(e);if(!s)return void t?.toggleLoading(!1);n=s.name;const a={mcp_id:e.id,name:s.name,prompt_instructions:s.prompt_instructions,options:s.options},o=await g.G.postData("/chat/mcp/connections/create_discovery/",a);if(!o.success||!o.connection)return new c.y(o.error||`Failed to initiate connection for ${e.name}.`,"error"),void t?.toggleLoading(!1);i=o.connection.id;const r=this.currentMcpConnections.findIndex((e=>e.id===i));-1!==r?this.currentMcpConnections[r]=o.connection:this.currentMcpConnections.push(o.connection)}if(!i)return new c.y("Could not determine a connection ID to authorize.","error"),void t?.toggleLoading(!1);const a=`/api/mcp/oauth/discover/${i}/`,o=window.open(a,"_blank","width=600,height=700,scrollbars=yes");if(!o||o.closed||void 0===o.closed)return new c.y("Popup window blocked. Please allow popups for this site.","error"),void t?.toggleLoading(!1);this.currentMcpDetails=e,this.view="management",this.renderManagementView(),this.connectionPollingInterval||(this.connectionPollingInterval=setInterval(this.pollConnections,5e3))}catch(e){new c.y("Error starting connection. Please try again.","error"),t&&t.toggleLoading(!1)}}async handleOAuthSubmit(e,t,s){let i={};if(!s&&(i=this._getAndValidateFormData(e),!i))return void t?.toggleLoading(!1);const n=this.formComponentInstances&&this.formComponentInstances.oauth_email?.value?.trim();if(e.requires_oauth_test_user&&!s){if(!n)return new c.y("Please enter the email address for your OAuth provider account.","warning"),t?.toggleLoading(!1),void this.formComponentInstances.oauth_email?.element.focus();if(!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(n))return new c.y("Please enter a valid email address.","warning"),t?.toggleLoading(!1),void this.formComponentInstances.oauth_email?.element.focus()}this.currentMcpDetails=e;let a=null,o=null,r=null,l=!1,d=null;try{const h={name:s?s.name:i.name,prompt_instructions:i.prompt_instructions,options:i.options};s&&(h.connection_id=s.id),n&&e.requires_oauth_test_user&&(h.oauth_email=n);const m=await g.G.postData(`/chat/mcp/connections/add/${e.id}/`,h);if(m.success&&m.connection){const s=this.currentMcpConnections.findIndex((e=>e.id===m.connection.id));if(-1!==s?this.currentMcpConnections[s]=m.connection:this.currentMcpConnections.push(m.connection),d=m.connection.id,m.auth_url){const s=new URL(window.location.href).origin;if(o=async i=>{if(i.origin===s&&i.data&&"oauthCallback"===i.data.type)if(l=!0,clearInterval(r),window.removeEventListener("message",o),a&&!a.closed&&a.close(),i.data.success){const{code:s,state:n}=i.data.payload;try{const t=await g.G.postData(`/chat/mcp/connections/complete_oauth/${d}/`,{code:s,state:n});if(t.success&&t.connection){const e=this.currentMcpConnections.findIndex((e=>e.id===d));-1!==e?this.currentMcpConnections[e]=t.connection:this.currentMcpConnections.push(t.connection),this.view="management",this.renderManagementView()}else new c.y(`Failed to finalize connection for ${e.name}.`,"error"),this.currentMcpConnections=this.currentMcpConnections.filter((e=>e.id!==d)),this.view="management",this.renderManagementView()}catch(e){this.pollConnections(),new c.y("Error finalizing connection. Please try again.","error"),this.currentMcpConnections=this.currentMcpConnections.filter((e=>e.id!==d)),this.view="management",this.renderManagementView()}finally{t&&t.loading&&t.toggleLoading(!1)}}else{const{error:e}=i.data.payload;new c.y("Authorization failed or was cancelled","warning"),this.currentMcpConnections=this.currentMcpConnections.filter((e=>e.id!==d)),this.view="management",this.renderManagementView(),t&&t.loading&&t.toggleLoading(!1)}},window.addEventListener("message",o),a=window.open(m.auth_url,"_blank","width=600,height=700,scrollbars=yes"),!a||a.closed||void 0===a.closed)return window.removeEventListener("message",o),new c.y("Popup window blocked or failed to open. Please allow popups for this site.","error"),t.toggleLoading(!1),void(this.currentMcpConnections=this.currentMcpConnections.filter((e=>e.id!==d)));this.view="management",this.renderManagementView(),this.connectionPollingInterval||(this.connectionPollingInterval=setInterval(this.pollConnections,5e3))}else new c.y(`Connection for ${e.name} requires manual approval. We'll notify you when it's ready.`,"info"),this.view="management",this.renderManagementView(),this.connectionPollingInterval||(this.connectionPollingInterval=setInterval(this.pollConnections,5e3)),t.toggleLoading(!1)}else new c.y(m.error||`Failed to initiate connection for ${e.name}.`,"error"),t?.toggleLoading(!1)}catch(e){new c.y("Error starting connection. Please try again.","error"),t?.toggleLoading(!1),o&&window.removeEventListener("message",o),a&&!a.closed&&a.close(),d&&(this.currentMcpConnections=this.currentMcpConnections.filter((e=>e.id!==d)))}}showConnectionOptions(e,t,s){const i=document.querySelector(".connection-options-dropdown");i&&i.remove();const n=document.createElement("div");n.className=`connection-options-dropdown absolute z-50 mt-1 ${this.theme.selectMenuBackground} rounded-md shadow-lg ring-1 ${this.theme.ringColor} py-1`,n.style.minWidth="160px";let a=[];if("pending_manual"===e.status)a.push({text:"Remove",iconName:"trash",action:()=>this.removeConnection(e,t),danger:!0});else if("pending_auth"===e.status){const s=()=>{t.connection_config?.discovery?this.handleDiscoveryOAuthSubmit(t,null,e):this.handleOAuthSubmit(t,null,e)};a.push({text:"Authorize",iconName:"globe",action:s}),a.push({text:"Remove",iconName:"trash",action:()=>this.removeConnection(e,t),danger:!0})}else"pending"===e.status||(a.push({text:"Edit",iconName:"edit",action:()=>this.editConnection(e,t)}),a.push({text:"Test connection",iconName:"play",action:()=>this.testConnection(e,t)}),"oauth2"===e.type&&["pending_auth","pending_manual","pending"].includes(e.status)),a.push({text:"Remove",iconName:"trash",action:()=>this.removeConnection(e,t),danger:!0});const l=e=>{n.contains(e.target)||s.contains(e.target)||(n.parentNode&&n.remove(),document.removeEventListener("click",l))};if(0===a.length){const e=document.createElement("div");e.className=`px-4 py-2 text-sm ${this.theme.fadedText}`,e.textContent="No actions available",n.appendChild(e)}else a.forEach((e=>{const t=document.createElement("button"),s=e.danger?this.theme.selectDangerHoverColor:this.theme.selectBackgroundHoverColor,i=e.danger?this.theme.dangerText:this.theme.text;t.className=`w-full text-left px-4 py-2 text-sm flex items-center transition-colors duration-150 ${i} ${s}`;const a=o.A.name(e.iconName),c=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"mr-3 text-center"}),d=document.createElement("span");d.textContent=e.text,t.appendChild(c.element),t.appendChild(d),t.addEventListener("click",(t=>{t.stopPropagation(),n.remove(),document.removeEventListener("click",l),e.action()})),n.appendChild(t)}));const c=s.getBoundingClientRect();let d=c.bottom+window.scrollY+4,h=window.innerWidth-c.right-window.scrollX;n.style.position="absolute",n.style.top=`${d}px`,n.style.right=`${h}px`,document.body.appendChild(n),requestAnimationFrame((()=>{const e=n.getBoundingClientRect();e.right>window.innerWidth-10&&(n.style.right="10px",n.style.left="auto"),e.left<10&&(n.style.left="10px",n.style.right="auto"),e.bottom>window.innerHeight-10&&(n.style.top=c.top+window.scrollY-e.height-4+"px")})),setTimeout((()=>document.addEventListener("click",l)),0)}async editConnection(e,t){this.currentFormMcp=t,this.currentFormConnection=e,this.view="connection-form",this.connectionFormType="edit",this.renderEditConnectionForm(t,e)}_renderConnectionOptions(e,t,s={}){e&&Array.isArray(e)&&0!==e.length&&e.forEach((e=>{const i=document.createElement("div");i.className="flex flex-col";const n=s[e.id]??e.default;let a;switch(e.type){case"multiselect":const s=(e.options||[]).filter((e=>(n||[]).includes(e.id)));a=new x({id:`connection-option-${e.id}`,label:e.label,items:e.options||[],required:e.required||!1,helpText:e.help_text||"",placeholder:e.placeholder||"Select..."}),a.value=s;break;case"select":a=new E({id:`connection-option-${e.id}`,label:e.label,options:e.options,value:n,required:e.required||!1,helpText:e.help_text||""});break;case"textarea":a=new p({id:`connection-option-${e.id}`,label:e.label,placeholder:e.placeholder||"",value:n,required:e.required||!1,helpText:e.help_text||"",rows:3});break;case"checkbox":const o=document.createElement("label");o.className=`flex items-center gap-2 ${this.theme.text} cursor-pointer`;const r=document.createElement("input");r.type="checkbox",r.id=`connection-option-${e.id}`,r.checked=n,r.className=`h-4 w-4 rounded ${this.theme.primaryAccentRing} ${this.theme.primaryAccentBackground} ${this.theme.tableBorder}`;const l=document.createElement("span");if(l.textContent=e.label,o.appendChild(r),o.appendChild(l),i.appendChild(o),e.help_text){const t=document.createElement("p");t.className=`${this.theme.fadedText} text-sm mt-1`,t.textContent=e.help_text,i.appendChild(t)}return this.formComponentInstances[e.id]=r,void t.appendChild(i);default:a=new d({id:`connection-option-${e.id}`,label:e.label,type:e.type||"text",placeholder:e.placeholder||"",value:n,required:e.required||!1,helpText:e.help_text||""})}a&&(a.render(i),this.formComponentInstances[e.id]=a,t.appendChild(i))}))}renderEditConnectionForm(e,t){const s=this.contentEl?.querySelector('[data-id="content-header"]'),i=this.contentEl?.querySelector('[data-id="content-body"]');if(!s||!i)return;this.formComponentInstances={},s.innerHTML="";const a=document.createElement("div");a.className="flex items-center";const r=o.A.name("chevronLeft"),l=new n.$({svgPathData:r.path,svgViewBox:r.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5 mx-2"});l.onClick((()=>this.cancelConnectionForm())),a.appendChild(l.element),s.appendChild(a);const c=document.createElement("span");c.className=`ml-2 font-medium ${this.theme.text} truncate`,c.textContent=`Edit connection for ${e.name}`,s.appendChild(c),i.innerHTML="",i.className="flex-1 overflow-y-auto p-4 md:p-6";const h=document.createElement("div");h.className="flex flex-col mt-4";const m=document.createElement("div");m.className="flex items-center mb-6";const u=document.createElement("div");u.className="w-16 h-16 rounded-lg overflow-hidden mr-3 flex-shrink-0 drop-shadow-md";const g=document.createElement("img");g.src=e.image||"https://via.placeholder.com/48",g.alt=`${e.name} logo`,g.className="w-full h-full object-cover",u.appendChild(g);const f=document.createElement("div");f.className="flex-1";const v=document.createElement("h2");v.className=`text-lg font-medium ${this.theme.text}`,v.textContent=e.name,f.appendChild(v);const y=e.connection_config||{};if(y.help_text){const e=document.createElement("p");e.className=`${this.theme.fadedText} text-base mt-1`,e.textContent=y.help_text,f.appendChild(e)}m.appendChild(u),m.appendChild(f),h.appendChild(m);const w=document.createElement("div");w.className="space-y-5",w.dataset.id="connection-form-fields";const b=document.createElement("div"),C=new d({id:"connection-name-input",label:"Connection name",type:"text",placeholder:"e.g., Personal account",required:!0,value:t.name||""});C.render(b),w.appendChild(b),this.formComponentInstances.connection_name=C;const x=document.createElement("div"),k=new p({id:"connection-instructions-input",label:"Connection instructions (optional)",placeholder:"e.g., This is my work account. Always respond in a professional tone.",rows:3,canGrow:!0,value:t.prompt_instructions||""});k.render(x),w.appendChild(x),this.formComponentInstances.prompt_instructions=k,this._renderConnectionOptions(e.connection_options,w,t.options||{});const E=document.createElement("div");E.className="mt-6 flex gap-2 justify-end";const S=document.createElement("div"),T=new n.$({text:"Cancel",type:"secondary",size:"medium"});T.onClick((()=>this.cancelConnectionForm())),T.render(S);const L=document.createElement("div"),_=new n.$({text:"Save",type:"primary",size:"medium"});_.onClick((()=>{_.toggleLoading("Saving..."),this.handleUpdateConnectionSubmit(e,t,_)})),_.render(L),E.appendChild(S),E.appendChild(L),w.appendChild(E),h.appendChild(w),i.appendChild(h)}async handleUpdateConnectionSubmit(e,t,s){const i=this.formComponentInstances.connection_name?.value?.trim(),n=this.formComponentInstances.prompt_instructions?.value?.trim();if(!i)return new c.y("Please enter a name for this connection.","warning"),this.formComponentInstances.connection_name?.element.focus(),void s.toggleLoading(!1);const a={};let o=!0;if((e.connection_options||[]).forEach((e=>{if(!o)return;const t=this.formComponentInstances[e.id];if(!t)return;let s,i=!1;switch(e.type){case"multiselect":s=t.selectedIds,i=t.config.required;break;case"checkbox":s=t.checked,i=t.required;break;default:s=t.value,i=t.config.required}!i||s&&0!==s.length||(new c.y(`Please provide a value for "${e.label}".`,"warning"),t.element?.focus(),o=!1),a[e.id]=s})),o)try{const o={connection_id:t.id,name:i,prompt_instructions:n,options:a},r=await g.G.postData("/chat/mcp/connections/update/",o);if(r.success&&r.connection){const s=this.currentMcpConnections.findIndex((e=>e.id===t.id));-1!==s&&(this.currentMcpConnections[s]=r.connection),await this.showManagementOptions(e)}else new c.y(r.error||"Failed to update connection.","error"),s.toggleLoading(!1)}catch(e){new c.y("An error occurred while updating the connection.","error"),s.toggleLoading(!1)}else s.toggleLoading(!1)}closeManagementOptions(){this.previousView?(this.view=this.previousView.view,this.activeCategory=this.previousView.activeCategory,this.searchQuery=this.previousView.searchQuery,this.previousView=null,this.currentMcpDetails=null,this.currentMcpConnections=[],this.addConnectionButtonInstance=null,this.uninstallButtonInstance=null,this.renderContentArea(),this.refreshContent()):this.switchView("installed")}async addConnection(e,t=null){const s=e.connection_config?.type||"none";this.currentFormMcp=e,this.view="connection-form",this.connectionFormType=s,this.renderConnectionForm(e,t)}renderConnectionForm(e,t=null){const s=this.contentEl?.querySelector('[data-id="content-header"]'),i=this.contentEl?.querySelector('[data-id="content-body"]');if(s&&i||(this.renderContentArea(),s=this.contentEl.querySelector('[data-id="content-header"]'),i=this.contentEl.querySelector('[data-id="content-body"]')),!s||!i)return;this.formComponentInstances={},s.innerHTML="";const a=document.createElement("div");a.className="flex items-center";const r=o.A.name("bars"),l=new n.$({svgPathData:r.path,svgViewBox:r.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden mr-2"});l.onClick((()=>this.toggleSidebar()));const c=o.A.name("chevronLeft"),h=new n.$({svgPathData:c.path,svgViewBox:c.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5 mx-2"});h.onClick((()=>this.cancelConnectionForm())),a.appendChild(l.element),a.appendChild(h.element),s.appendChild(a);const m=document.createElement("span");m.className=`ml-2 font-medium ${this.theme.text} truncate`;const u=e.connection_config||{};"oauth2"===this.connectionFormType?m.textContent=`Connect to ${e.name}`:"apikey"===this.connectionFormType?m.textContent=`Add ${u.label||"connection"} for ${e.name}`:m.textContent=`Add connection for ${e.name}`,s.appendChild(m),i.innerHTML="",i.className="flex-1 overflow-y-auto p-4 md:p-6";const g=document.createElement("div");g.className="flex flex-col mt-4";const f=document.createElement("div");f.className="flex items-center mb-6";const v=document.createElement("div");v.className="w-16 h-16 rounded-lg overflow-hidden mr-3 flex-shrink-0 drop-shadow-md";const y=document.createElement("img");y.src=e.image||"https://via.placeholder.com/48",y.alt=`${e.name} logo`,y.className="w-full h-full object-cover",v.appendChild(y);const w=document.createElement("div");w.className="flex-1";const b=document.createElement("h2");if(b.className=`text-lg font-medium ${this.theme.text}`,b.textContent=e.name,w.appendChild(b),u.help_text){const e=document.createElement("p");e.className=`${this.theme.fadedText} text-base mt-1`,e.textContent=u.help_text,w.appendChild(e)}if(f.appendChild(v),f.appendChild(w),g.appendChild(f),"install"===t){const t=document.createElement("div");t.className=`flex items-center justify-between mt-1 mb-4 p-4 ${this.theme.toastInfo} rounded-md`,t.textContent=`This is your first connection to ${e.name}. To complete the installation you need at least one connection. The name of each connection is important. It helps your assistant understand which connection to use if you have multiple. For example you could have "Personal account" and "Work account" as connection names.`,g.appendChild(t)}const C=document.createElement("div");C.className="space-y-5",C.dataset.id="connection-form-fields";const x=document.createElement("div"),k=new d({id:"connection-name-input",label:"Connection name",type:"text",placeholder:"e.g. Personal account",required:!0,value:`${e.name} account`});k.render(x),C.appendChild(x),this.formComponentInstances.connection_name=k;const E=document.createElement("div"),S=new p({id:"connection-instructions-input",label:"Connection instructions (optional)",placeholder:"e.g., Always respond in a formal tone. Summarize emails to be less than 100 words.",rows:3,canGrow:!0});if(S.render(E),C.appendChild(E),this.formComponentInstances.prompt_instructions=S,"oauth2"===this.connectionFormType&&e.requires_oauth_test_user){const t=document.createElement("div"),s=new d({id:"connection-oauth-email-input",label:`${u.label||e.name} email address`,type:"email",placeholder:`Enter the email for your ${u.label||e.name}`,required:!0,value:window.simtheoryUser?.email||"",helpText:`Since ${u.label||e.name} oAuth requires manual approval for new users during our beta, please provide the email address associated with the account you wish to connect. This email will be sent to our team to grant you access. This is the email for the account you wish to connect. We will email you to continue the setup process once you have been added.`});s.render(t),C.appendChild(t),this.formComponentInstances.oauth_email=s}"apikey"===this.connectionFormType&&u.fields&&Array.isArray(u.fields)&&u.fields.forEach((e=>{const t=document.createElement("div"),s=new d({id:`connection-field-${e.id}`,label:e.label||e.id,type:e.type||"text",placeholder:e.placeholder||"",required:e.required||!1,value:e.default||"",helpText:e.help_text||""});s.render(t),t.querySelector("label").classList.add("text-base"),C.appendChild(t),this.formComponentInstances[e.id]=s})),this._renderConnectionOptions(e.connection_options,C);const T=document.createElement("div");T.className="mt-6 flex gap-3 justify-end";const L=document.createElement("div"),_=new n.$({text:"Cancel",type:"secondary",size:"medium",width:"auto"});_.onClick((()=>this.cancelConnectionForm())),_.render(L);let I="oauth2"===this.connectionFormType?"Proceed to authorization":"Add connection";e.requires_oauth_test_user&&"oauth2"===this.connectionFormType&&(I="Request access");const A=document.createElement("div"),M=new n.$({id:"connection-form-submit",text:I,type:"primary",size:"medium",width:"auto"});"oauth2"===this.connectionFormType?M.onClick((()=>{M.toggleLoading("Connecting..."),e.connection_config?.discovery?this.handleDiscoveryOAuthSubmit(e,M):this.handleOAuthSubmit(e,M)})):M.onClick((()=>{M.toggleLoading("Adding connection..."),this.handleApiKeySubmit(e,M)})),M.render(A),T.appendChild(L),T.appendChild(A),C.appendChild(T),g.appendChild(C),i.appendChild(g),setTimeout((()=>{const e=this.formComponentInstances.connection_name?.element;e&&e.focus&&(e.focus(),e.select())}),100)}async cancelConnectionForm(){const e=this.currentFormMcp;this.currentFormMcp=null,this.currentFormConnection=null,e?await this.showManagementOptions(e):await this.switchView("installed")}_getAndValidateFormData(e){const t={name:this.formComponentInstances.connection_name?.value?.trim(),prompt_instructions:this.formComponentInstances.prompt_instructions?.value?.trim(),options:{}};if(!t.name)return new c.y("Please enter a name for this connection.","warning"),this.formComponentInstances.connection_name?.element.focus(),null;const s=e.connection_options||[];for(const e of s){const s=this.formComponentInstances[e.id];if(!s)continue;let i,n=e.required||!1;switch(e.type){case"multiselect":i=s.selectedIds;break;case"checkbox":i=s.checked;break;default:i=s.value}if(n&&(!i||0===i.length))return new c.y(`Please provide a value for "${e.label}".`,"warning"),s.element?.focus(),null;t.options[e.id]=i}return t}async handleApiKeySubmit(e,t){const s=this._getAndValidateFormData(e);if(!s)return void t.toggleLoading(!1);const i={};let n=!0;const a=e.connection_config||{};if(a.fields&&Array.isArray(a.fields))for(const e of a.fields){const t=this.formComponentInstances[e.id],s=t?.value?.trim();if(e.required&&!s){new c.y(`Please enter a value for "${e.label||e.id}".`,"warning"),t?.element.focus(),n=!1;break}!s&&e.required||(i[e.id]=s)}if(n)try{const n={name:s.name,prompt_instructions:s.prompt_instructions,options:s.options,config:i},a=await g.G.postData(`/chat/mcp/connections/add/${e.id}/`,n);a.success&&a.connection?(this.currentMcpConnections.push(a.connection),await this.showManagementOptions(e)):(new c.y(a.error||`Failed to add connection for ${e.name}.`,"error"),t.toggleLoading(!1))}catch(e){new c.y("Error adding connection. Please try again.","error"),t.toggleLoading(!1)}else t.toggleLoading(!1)}refreshConnectionsList(e){if("management"!==this.view||!this.contentEl)return;const t=this.contentEl.querySelector('[data-id="connections-list"]'),s=this.contentEl.querySelector('[data-id="no-connections-state"]'),i=t?.parentElement||s?.parentElement;if(!i)return;const n=this.currentMcpConnections||[];t&&t.remove(),s&&s.remove();i.querySelectorAll(".mcp-info-banner").forEach((e=>e.remove()));if(!n.some((e=>"active"===e.status))){const t=document.createElement("div");t.className=`mcp-info-banner flex items-center justify-between mt-1 mb-4 p-4 ${this.theme.toastWarning} rounded-md text-base`,t.textContent=`To complete your installation and use ${e.name}, you need at least one valid (active) connection.`;const s=i.querySelector(".flex.justify-between.items-center.mb-3");s?s.insertAdjacentElement("afterend",t):i.prepend(t)}if(n.length>0){const t=document.createElement("div");t.className="space-y-3",t.dataset.id="connections-list",n.forEach((s=>{t.appendChild(this.createConnectionCard(s,e))})),i.appendChild(t)}else{const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-6 text-center`,t.dataset.id="no-connections-state";const s=document.createElement("div");s.className=`text-3xl mb-2 ${this.theme.iconColor} flex justify-center items-center`;const n=o.A.name("boxOpen"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-10 h-10 sm:w-12 sm:h-12"});s.appendChild(a.element);const l=document.createElement("p");l.className=this.theme.fadedText;const c=e?.name||"this MCP";l.textContent=`No connections configured for ${c}. ${e?.connection_config?.type?"Add one to get started.":""}`,t.appendChild(s),t.appendChild(l),i.appendChild(t)}}async testConnection(e,t,s={}){const i=s.suppressToast||!1;if("launching"===e.status&&!i)return new c.y("Connection is still launching. Please wait a moment before testing.","warning"),!1;const n=this.contentEl?.querySelector(`[data-connection-id="${e.id}"]`),a=n?.querySelector(".text-xs.rounded-full"),l=a?a.innerHTML:"",d=a?a.className:"";if(a&&!i){a.innerHTML="";const e=o.A.name("spinner"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3",additionalClasses:"animate-spin"}),s=document.createElement("span");s.textContent="Testing...",a.appendChild(t.element),a.appendChild(s),a.className=`text-xs px-2 py-0.5 rounded-full whitespace-nowrap inline-flex items-center gap-1 ${this.theme.fadedText}`}try{const s=await g.G.postData(`/chat/mcp/connections/test/${e.id}/`);i||(s.success?new c.y(`Connection to ${e.name} successful!`,"success"):new c.y(`Connection test failed for ${e.name}: ${s.message||"Unknown error"}`,"error"));const n=this.currentMcpConnections.findIndex((t=>t.id===e.id));if(-1!==n&&s.new_status){const e=this.currentMcpConnections[n].status!==s.new_status;if(this.currentMcpConnections[n].status=s.new_status,this.currentMcpConnections[n].last_error=s.success?null:s.message,this.currentMcpConnections[n].last_tested_at=s.success?(new Date).toISOString():this.currentMcpConnections[n].last_tested_at,e||i?this.refreshConnectionsList(t):a&&(a.innerHTML=l,a.className=d),i)return"active"===s.new_status}else if(a){const e=a.querySelector("span");e&&"Testing..."===e.textContent&&(a.innerHTML=l,a.className=d)}if(i&&!s.success)return!1}catch(s){if(i||new c.y("Error testing connection. Please try again.","error"),a){const e=a.querySelector("span");e&&"Testing..."===e.textContent&&(a.innerHTML=l,a.className=d)}const n=this.currentMcpConnections.findIndex((t=>t.id===e.id));return-1!==n&&(this.currentMcpConnections[n].status="error",this.currentMcpConnections[n].last_error="Testing failed due to an unexpected error.",this.refreshConnectionsList(t)),!1}}async refreshToken(e,t){const s=this.contentEl?.querySelector(`[data-connection-id="${e.id}"]`),i=s?.querySelector(".text-xs.rounded-full"),n=i?i.innerHTML:"",a=i?i.className:"";if(i){i.innerHTML="";const e=o.A.name("spinner"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3",additionalClasses:"animate-spin"}),s=document.createElement("span");s.textContent="Refreshing...",i.appendChild(t.element),i.appendChild(s),i.className=`text-xs px-2 py-0.5 rounded-full whitespace-nowrap inline-flex items-center gap-1 ${this.theme.fadedText}`}else new c.y(`Refreshing token for ${e.name}...`,"info");try{const s=await g.G.postData(`/chat/mcp/connections/refresh/${e.id}/`);s.success?new c.y(`Token refreshed successfully for ${e.name}`,"success"):new c.y(`Failed to refresh token for ${e.name}: ${s.message||"Unknown error"}`,"error");const o=this.currentMcpConnections.findIndex((t=>t.id===e.id));if(-1!==o&&s.new_status){const e=this.currentMcpConnections[o].status!==s.new_status;this.currentMcpConnections[o].status=s.new_status,this.currentMcpConnections[o].last_error=s.success?null:s.message,this.currentMcpConnections[o].last_tested_at=s.success?(new Date).toISOString():this.currentMcpConnections[o].last_tested_at,e?this.refreshConnectionsList(t):i&&(i.innerHTML=n,i.className=a)}else i&&(i.innerHTML=n,i.className=a)}catch(s){new c.y("Error refreshing token. Please try again.","error"),i&&(i.innerHTML=n,i.className=a);const o=this.currentMcpConnections.findIndex((t=>t.id===e.id));-1!==o&&(this.currentMcpConnections[o].status="error",this.currentMcpConnections[o].last_error="Token refresh failed due to an unexpected error.",this.refreshConnectionsList(t))}}async removeConnection(e,t){new a("Are you sure?",`Are you sure you want to remove the connection "${e.name}"? This action cannot be undone.`).onConfirm((async()=>{const s=this.contentEl?.querySelector(`[data-connection-id="${e.id}"]`);s&&(s.style.opacity="0.5");try{const i=await g.G.postData(`/chat/mcp/connections/remove/${e.id}/`);i.success?(new c.y(`Connection "${e.name}" removed`,"success"),this.currentMcpConnections=this.currentMcpConnections.filter((t=>t.id!==e.id)),this.addConnectionButtonInstance&&!t.allow_multiple_connections&&0===this.currentMcpConnections.length&&(this.addConnectionButtonInstance.config.disabled=!1,this.addConnectionButtonInstance.element.disabled=!1,this.addConnectionButtonInstance.element.classList.remove("opacity-50","cursor-not-allowed")),this.refreshConnectionsList(t)):(new c.y(`Failed to remove connection "${e.name}". ${i.error||""}`,"error"),s&&(s.style.opacity="1"))}catch(e){new c.y("Error removing connection. Please try again.","error"),s&&(s.style.opacity="1")}}))}async uninstallMcp(e){new a("Are you sure?",`Are you sure you want to uninstall ${e.name}? This will remove all associated connections and configurations.`).onConfirm((async()=>{const t=this.uninstallButtonInstance;t&&t.toggleLoading("Uninstalling...");try{const s=await g.G.postData(`/chat/mcp/store/uninstall/${e.id}/`);if(s.success){const t=this.mcps.findIndex((t=>t.id===e.id));-1!==t&&(this.mcps[t].installed=!1),this.closeManagementOptions()}else new c.y(`Failed to uninstall ${e.name}. ${s.error||""}`,"error"),t&&t.loading&&t.toggleLoading()}catch(s){new c.y(`Error uninstalling ${e.name}. Please try again.`,"error"),t&&t.loading&&t.toggleLoading()}}))}show(){this.container&&(document.addEventListener("keydown",this.handleKeyDown),document.body.classList.add("overflow-hidden"),this.container.style.opacity="0",this.storeEl.style.transform="scale(0.95)",this.storeEl.style.opacity="0",this.container.style.display="flex",requestAnimationFrame((()=>{this.container.style.opacity="1",this.storeEl.style.opacity="1",this.storeEl.style.transform="scale(1)",this.container.style.transition="opacity 0.2s ease-out",this.storeEl.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out"})))}close(){this.container&&(this._stopConnectionPolling(),document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),this.container.style.opacity="0",this.storeEl.style.opacity="0",this.storeEl.style.transform="scale(0.95)",this.container.style.transition="opacity 0.2s ease-in",this.storeEl.style.transition="opacity 0.2s ease-in, transform 0.2s ease-in",setTimeout((()=>{document.body.classList.remove("overflow-hidden"),this.destroy()}),200))}destroy(){this._stopConnectionPolling(),this.container?.parentNode&&this.container.parentNode.removeChild(this.container),this.addConnectionButtonInstance?.destroy(),this.uninstallButtonInstance?.destroy(),this.detailViewActionButtonInstance?.destroy(),this.apiKeyModal?.close(),this.apiKeyModal=null,this.container=null,this.storeEl=null,this.sidebarEl=null,this.contentEl=null,this.searchInput=null,this.mobileSearchInput=null,this.mobileMenuButton=null,this.mobileSidebar=null,this.sidebarOverlay=null,this.categories=[],this.mcps=[],this.currentMcpDetails=null,this.currentMcpConnections=[],this.currentFormMcp=null,this.currentFormConnection=null,this.addConnectionButtonInstance=null,this.uninstallButtonInstance=null,this.detailViewActionButtonInstance=null,document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),document.body.classList.remove("overflow-hidden")}static create(e="store"){if(document.querySelector(".mcp-store-container"))return null;return new A(e)}_showApiKeyModal(e){this.apiKeyModal&&(this.apiKeyModal.close(),this.apiKeyModal=null);const t=document.createElement("div");t.className="space-y-4 p-1";const s=document.createElement("h3");s.className=`text-lg font-medium ${this.theme.text}`,s.textContent=`Add ${e.connection_config.label||"API key"} for ${e.name}`,t.appendChild(s);const i=document.createElement("div"),n=document.createElement("label");n.className=`block text-sm font-medium ${this.theme.fadedText} mb-1`,n.textContent="Connection name";const a=new d({type:"text",placeholder:`e.g., My ${e.name} key`,required:!0,value:`My ${e.name} key`});i.appendChild(n),a.render(i),t.appendChild(i);const o=document.createElement("div"),r=document.createElement("label");r.className=`block text-sm font-medium ${this.theme.fadedText} mb-1`,r.textContent=e.connection_config.label||"API key";const h=new d({type:"password",placeholder:`Enter your ${e.connection_config.label||"API key"}`,required:!0});if(o.appendChild(r),h.render(o),t.appendChild(o),e.connection_config.help_text){const t=document.createElement("p");t.className=`${this.theme.fadedText} text-xs mt-1`,t.textContent=e.connection_config.help_text,o.appendChild(t)}this.apiKeyModal=new l({title:`Add ${e.connection_config.label||"API key"} for ${e.name}`,body:t,size:"medium",showConfirmButton:!0,confirmText:"Add connection",buttonStyleConfirm:"primary",showCancelButton:!0,manualCloseOnConfirm:!0,onConfirm:async()=>{const t=a.value,s=h.value;if(!t||!s)return new c.y("Please enter both a name and the API key.","warning"),!1;this.apiKeyModal&&this.apiKeyModal.toggleConfirmLoading(!0);const i=await this._handleAddApiKey(e,t,s);return this.apiKeyModal&&(this.apiKeyModal.toggleConfirmLoading(!1),i&&this.apiKeyModal.close()),i},onClose:()=>{this.apiKeyModal=null}})}async _handleAddApiKey(e,t,s){const i=this.addConnectionButtonInstance;i&&i.toggleLoading("Adding...");try{const i={name:t,config:{[e.connection_config?.fields?.[0]?.id||"api_key"]:s}},n=await g.G.postData(`/chat/mcp/connections/add/${e.id}/`,i);return n.success&&n.connection?(this.currentMcpConnections.push(n.connection),this.refreshConnectionsList(e),!0):(new c.y(n.error||`Failed to add connection for ${e.name}.`,"error"),!1)}catch(e){return new c.y("Error adding connection. Please try again.","error"),!1}}async showAddCustomMcpDialog(){const e=document.createElement("div");e.className="space-y-5 py-2";const t={},s=new S("MCP icon",null,"Set MCP icon",["image","prompt"],"rounded-md","Recommended: 128x128px, JPG or PNG"),i=document.createElement("div");s.render(i),t.avatar=s,e.appendChild(i);const n=new d({label:"MCP name",placeholder:"e.g. Internal Knowledgebase",required:!0,minChar:3,error:"MCP name is required and must be at least 3 characters."}),a=document.createElement("div");n.render(a),t.name=n,e.appendChild(a);const o=new p({label:"Description",placeholder:"Describe what this MCP does...",rows:2,required:!0,minChar:10,error:"Description is required and must be at least 10 characters."}),r=document.createElement("div");o.render(r),t.description=o,e.appendChild(r);const h=new d({label:"MCP URL",type:"url",placeholder:"https://mcp-server.com/mcp",required:!0,error:"A valid MCP Server URL is required (e.g., https://...)"}),m=document.createElement("div");h.render(m),t.serverUrl=h,e.appendChild(m);const u=new E({label:"Authentication",placeholder:"Select authentication type",required:!0,options:[{value:"apikey",label:"HTTP headers"},{value:"none",label:"No authentication"}],error:"Please select an authentication type."}),f=document.createElement("div");u.render(f),t.authType=u,e.appendChild(f);const v=new E({label:"Connection mode",placeholder:"Select connection mode",required:!1,value:"false",options:[{value:"false",label:"Allow single connection"},{value:"true",label:"Allow multiple connections"}],helpText:"Multiple connections are for services supporting multiple accounts (e.g., via OAuth).",error:"Please select a connection mode."}),y=document.createElement("div");v.render(y),t.allowMultipleConnections=v,e.appendChild(y),y.style.display="none",u.onChange((e=>{"oauth2"===e?(y.style.display="block",v.config.required=!0):(y.style.display="none",v.value="false",v.config.required=!1)}));const w=new l({title:"Add custom MCP",body:e,size:"medium",closeX:!0,confirm:!0,confirmText:"Add MCP",cancel:!0,cancelText:"Cancel",buttonStyleConfirm:"primary",buttonStyleCancel:"secondary",manualCloseOnConfirm:!0,onConfirm:async()=>{let e=!0;for(const s in t){const i=t[s];if(i&&"function"==typeof i.validate){if("allowMultipleConnections"===s&&"none"===y.style.display)continue;if(!i.validate()){e=!1;break}}}if(!e)return void w.setConfirmLoading(!1);w.toggleConfirmLoading("Adding MCP...");const s=t.avatar.value;let i="false";"oauth2"===t.authType.value&&(i=t.allowMultipleConnections.value);const n={name:t.name.value,description:t.description.value,server_url:t.serverUrl.value,authentication_type:t.authType.value,icon_url:s.imgUrl||null,allow_multiple_connections:i};try{const e=await g.G.postData("/chat/mcp/add-custom/",n);if(e.success){w.close(),this.isLoading=!0,this.refreshContent();try{const e=await g.G.fetchData("/chat/mcp/store/data/?view=installed");this.mcps=e.mcps||[],this.isLoading=!1,this.refreshContent()}catch(e){this.isLoading=!1,this.renderErrorState("Could not refresh MCP list.")}}else if(e.invalid_mcp_url)new c.y("Please check the MCP URL; it appears to be invalid.","warning"),w.setConfirmLoading(!1);else{let t=e.error||`Failed to add ${n.name}.`;if(e.errors){t=`${t} ${Object.values(e.errors).join(" ")}`}new c.y(t,"error"),w.setConfirmLoading(!1)}}catch(e){new c.y("An error occurred while adding the MCP.","error"),w.setConfirmLoading(!1)}}})}async removeCustomMcpDefinition(e){e&&e.id?new a("Remove custom MCP?",`Are you sure you want to permanently remove the Custom MCP definition for "${e.name}"? This will also remove its listing and any installations or connections associated with it. This action cannot be undone.`).onConfirm((async()=>{try{const t=await g.G.postData(`/chat/mcp/custom/remove/${e.id}/`);t.success?(new c.y(t.message||`Custom MCP "${e.name}" removed successfully.`,"success"),this.mcps=this.mcps.filter((t=>t.id!==e.id)),"installed"===this.view?this.closeMcpDetails():this.switchView("installed")):new c.y(t.error||`Failed to remove Custom MCP "${e.name}".`,"error")}catch(e){new c.y("An error occurred while removing the Custom MCP.","error")}})):new c.y("Cannot remove: Invalid MCP data.","error")}}class M{static menuItems=[{id:"new-conversation",icon:"fa-comment",hoverText:"New",mobileText:"Previous session"},{id:"history",icon:"fa-inbox-full",hoverText:"History"},{id:"assistants",icon:"fa-grid-round-2",hoverText:"Assistants"}];constructor(e=null){this.selected=e||"new-conversation",this.theme=i.A.theme,this.isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,this.menuContainer=null,window.talkWidgetShowing=!1,this.render(),this.addEventListeners(),this.workspaces=[],this.getWorkspaces()}async getWorkspaces(){this.workspaces=await y.a.getWorkspaces()}deselect(){const e=this.menuContainer.querySelector(".selected");e&&(e.classList=`flex items-center align-middle justify-center w-full px-2 py-2 ${this.theme.secondaryButton} transition-opacity duration-300`);const t=this.menuContainer.querySelectorAll(".menu-item button");t.forEach(((e,s)=>{e.classList.remove("rounded-t-md","rounded-b-md"),0===s&&e.classList.add("rounded-t-md"),s===t.length-1&&e.classList.add("rounded-b-md")}))}select(e,t=!1){if("new-conversation"!==e){const e=this.menuContainer.querySelector("#outer-new-conversation div");e&&(e.textContent="Previous")}this.selected=e;const s=this.menuContainer.querySelector(".selected");s&&(s.classList=`flex items-center align-middle justify-center w-full px-2 py-2 ${this.theme.secondaryButton} transition-opacity duration-300`);const i=document.getElementById(e);if(i){if("new-conversation"!==e){i.classList=`flex items-center align-middle justify-center w-full px-2 py-2 ${this.theme.menuSelectedItem} selected`;document.getElementById("new-conversation").innerHTML='<i class="fa-solid fa-comment fa-lg"></i>'}else if("new-conversation"===e){i.innerHTML='<i class="fa-solid fa-plus fa-lg"></i>';const e=i.parentElement.querySelector("div");e&&(e.textContent="New"),u.K._user.preferences.hideMenu&&this.hideMenuItems()}const s=this.menuContainer.querySelectorAll(".menu-item button");s.forEach(((e,t)=>{e.classList.remove("rounded-t-md","rounded-b-md"),0===t&&e.classList.add("rounded-t-md"),t===s.length-1&&e.classList.add("rounded-b-md")})),t||this.menuContainer.dispatchEvent(new CustomEvent("menuSelect",{detail:{selection:e}}))}}handleButtonClick(e,t){e.metaKey||e.ctrlKey?(e.preventDefault(),"new-conversation"!==t?window.open(`/chat/${t}`,"_blank"):window.open("/chat","_blank")):this.select(t)}addHoverEffect(){if(u.K.isMobile())return;this.menuContainer.querySelectorAll(".menu-item").forEach((e=>{const t=e.querySelector("button");t.style.opacity="0.7",t.addEventListener("mouseenter",(()=>{t.style.opacity="1"})),t.addEventListener("mouseleave",(()=>{t.classList.contains("selected")||(t.style.opacity="0.7")}))}))}render(){this.menuContainer=document.createElement("div"),this.menuContainer.id="chat-menu",this.menuContainer.className="px-6 absolute top-0 left-0 hidden lg:block h-full flex flex-col";const e=document.createElement("div");if(e.className=`flex w-10 flex-col align-middle items-center ${this.theme.menuIconColor} h-full pt-6`,window.workspace&&window.workspace.brand){const t=document.createElement("img");t.src=window.workspace.brand,t.className="absolute left-[22px] top-4 h-[45px] w-[45px] rounded-md select-none",t.draggable=!1,this.menuContainer.appendChild(t),e.classList.remove("pt-6"),e.classList.add("pt-20")}const t=document.createElement("div");t.className=`flex flex-col ${this.theme.background} rounded-md shadow-md opacity-70 transition-opacity duration-300`,t.id="menuItemsContainer";const s=M.menuItems;s.forEach(((e,i)=>{if("assistants"===e.id&&window.workspace_context&&!u.K.hasPermission("assistants:crud"))return;const n=document.createElement("div");n.className="relative menu-item",n.id="outer-"+e.id;const a=document.createElement("div");a.className=`absolute top-1.5 left-12 ${this.theme.helperHoverState} px-2 py-1 rounded-md items-start align-middle justify-start text-sm flex flex-grow hidden`,a.innerHTML=e.hoverText,n.appendChild(a);const o=document.createElement("button");o.type="button",o.className=`flex items-center align-middle justify-center w-full px-2 py-2 ${this.theme.secondaryButton} transition-opacity duration-300`,o.innerHTML=`<i class="fa-solid ${e.icon} w-5 h-5"></i>`,o.id=e.id,0===i&&o.classList.add("rounded-t-md"),i===s.length-1&&o.classList.add("rounded-b-md"),n.appendChild(o),t.appendChild(n),n.addEventListener("mouseenter",(()=>{a.classList.remove("hidden")})),n.addEventListener("mouseleave",(()=>{a.classList.add("hidden")}))})),e.appendChild(t);const i=this.renderProfileButton();e.appendChild(i),this.menuContainer.appendChild(e),document.body.appendChild(this.menuContainer),this.selected&&this.select(this.selected)}addEventListeners(){this.menuContainer.addEventListener("click",(e=>{const t=e.target.closest("button");t&&this.handleButtonClick(e,t.id)})),u.K._user.preferences.hideMenu&&(this.isTouchDevice||(this.menuContainer.addEventListener("mouseleave",(()=>{"new-conversation"===this.selected&&this.hideMenuItems()})),this.menuContainer.addEventListener("mouseenter",(()=>{this.showMenuItems()}))))}hideMenuItems(){setTimeout((()=>{if("new-conversation"===this.selected&&!this.isTouchDevice){this.menuContainer.querySelectorAll(".menu-item").forEach((e=>{e.classList.add("menu-hidden"),e.classList.remove("menu-visible")}));const e=document.getElementById("bottomButtons");e.classList.add("menu-hidden"),e.classList.remove("menu-visible")}}),2e3)}showMenuItems(){this.menuContainer.querySelectorAll(".menu-item").forEach((e=>{e.classList.add("menu-visible"),e.classList.remove("menu-hidden")}));const e=document.getElementById("bottomButtons");e.classList.add("menu-visible"),e.classList.remove("menu-hidden")}selectMenuItem(e){e&&this.select(e,!0)}renderProfileButton(){const e=document.createElement("button");return e.type="button",e.className=`${this.theme.secondaryButton} rounded-full mt-auto mb-6 transition-opacity duration-300`,e.draggable=!1,e.id="profileButton",e.innerHTML=`<img src="${u.K.profileImage}" draggable="false" class="w-7 h-7 mx-auto rounded-full profile-image">`,e.addEventListener("click",(e=>{e.stopPropagation(),this.showProfileMenu(e)})),e}async showProfileMenu(e){e.stopPropagation();const t=document.querySelector(".profile-menu");if(t)return void t.remove();const s=document.createElement("div");s.className=`profile-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-30 text-sm`;const i=document.createElement("ul");if(i.className="py-1",0===this.workspaces.length){const e=document.createElement("div"),t=document.createElement("button");t.className="\n                rounded-md ring-indigo-600 ring-1 py-3 px-3 text-xs text-zinc-900 m-2 text-left\n                relative overflow-hidden group\n                transition duration-300 ease-in-out\n                shadow-md\n                bg-indigo-200\n            ",t.innerHTML='\n                <div class="font-medium text-sm text-black"><i class="fa-solid fa-users"></i> Add your team</div>\n                <div class="font-normal pt-1.5">Create an AI workspace</div>\n\n            ',e.appendChild(t),i.appendChild(e),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspace/new"),this.deselect(),s.remove()}}else{if(this.selectedWorkspace=await u.K.getSelectedWorkspace(),"None"!==window.personal_plan){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const o=document.createElement("i");o.innerHTML=`<img src="${u.K.profileImage}" class="w-7 h-7 mx-auto rounded-full profile-image">`,a.appendChild(o);const r=document.createElement("span");r.textContent="My workspace",a.appendChild(r),n.appendChild(a);const l=document.createElement("div");if(l.className="flex pl-2",n.appendChild(l),t.appendChild(n),!y.a.config){const e=document.createElement("div");e.className="fa-solid fa-check text-green-500",l.appendChild(e)}t.onclick=e=>{e.stopPropagation();const t=window.location.host;window.location.protocol,window.location.port&&window.location.port;let i;if(t.includes("localhost"))i="localhost";else{const e=t.split(":")[0].split(".");i=e.length>1?e.slice(1).join("."):t}const n=window.location.pathname;let a="/chat";if(n.startsWith("/chat/")){const e=n.substring(6);["history","assistants","settings"].some((t=>e.startsWith(t)))&&(a=n)}window.location.pathname="/accounts/switch/0/",this.deselect(),s.remove()},e.appendChild(t),i.appendChild(e)}const e=3;let t=[];if(this.selectedWorkspace&&this.selectedWorkspace.slug){const e=this.workspaces.find((e=>e.slug===this.selectedWorkspace.slug));e&&t.push(e)}if(this.workspaces.forEach((s=>{t.length<e&&(!this.selectedWorkspace?.slug||s.slug!==this.selectedWorkspace.slug)&&t.push(s)})),t.forEach((e=>{const t=document.createElement("li"),n=document.createElement("button");n.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const a=document.createElement("div");a.className="flex flex-grow justify-between align-middle items-center";const o=document.createElement("div");o.className="flex items-center gap-2";const r=document.createElement("div");if(r.className="w-7 h-7 rounded-full flex items-center justify-center",e.image)r.innerHTML=`<img src="${e.image}" class="w-7 h-7 rounded-full">`;else{r.className+=` ${this.theme.workspaceDefaultIcon}`;const e=document.createElement("i");e.className="fa-solid fa-buildings text-sm",r.appendChild(e)}o.appendChild(r);const l=document.createElement("span");l.textContent=e.workspace_name,o.appendChild(l),a.appendChild(o);const c=document.createElement("div");if(c.className="flex pl-2",a.appendChild(c),this.selectedWorkspace?.slug===e.slug){const e=document.createElement("div");e.className="fa-solid fa-check text-green-500",c.appendChild(e)}n.appendChild(a),n.onclick=t=>{t.stopPropagation();const i=`/accounts/workspace/login/${e.slug}/`;window.location.pathname=i,this.deselect(),s.remove()},t.appendChild(n),i.appendChild(t)})),this.workspaces.length>e){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const o=document.createElement("div");o.className=`w-7 h-7 rounded-full flex items-center justify-center ${this.theme.secondaryBackground}`;const r=document.createElement("i");r.className="fa-solid fa-ellipsis",o.appendChild(r),a.appendChild(o);const l=document.createElement("span");l.textContent="View all",a.appendChild(l),n.appendChild(a),t.appendChild(n),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspaces"),s.remove()},e.appendChild(t),i.appendChild(e)}else if("Personal"===y.a.workspace.name){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`,t.innerHTML='<i class="fa-solid fa-plus"></i> Create workspace',e.appendChild(t),i.appendChild(e),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspace/new"),s.remove()}}const n=this.workspaces.find((e=>e.slug===this.selectedWorkspace.slug));if("Personal"!==y.a.workspace.name&&n?.workspace_manage){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const o=document.createElement("div");o.className=`w-7 h-7 rounded-full flex items-center justify-center ${this.theme.secondaryBackground}`;const r=document.createElement("i");r.className="fa-solid fa-cog",o.appendChild(r),a.appendChild(o);const l=document.createElement("span");l.textContent="Manage",a.appendChild(l),n.appendChild(a),t.appendChild(n),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspace/admin"),s.remove()},e.appendChild(t),i.appendChild(e)}}const n=document.createElement("li");n.className=`border-t ${this.theme.tableDividerLine} my-1`,i.appendChild(n);const a=document.createElement("li"),o=document.createElement("button");o.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const r=document.createElement("i");r.className="fa-solid fa-sliders mr-2",o.appendChild(r);const l=document.createElement("span");if(l.textContent="Personalize",o.appendChild(l),o.onclick=e=>{e.stopPropagation(),this.deselect(),new T,s.remove()},a.appendChild(o),i.appendChild(a),window.hasFeature("mcps")&&u.K.hasPermission("feature:mcps")){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const n=document.createElement("i");n.className="fa-solid fa-store mr-2",t.appendChild(n);const a=document.createElement("span");a.textContent="MCP store",t.appendChild(a),t.onclick=e=>{e.stopPropagation(),this.deselect(),new A,s.remove()},e.appendChild(t),i.appendChild(e)}if("Personal"===y.a.workspace.name){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const n=document.createElement("i");n.className="fa-solid fa-crown mr-2",t.appendChild(n);const a=document.createElement("span");a.textContent="My plan",t.appendChild(a),t.onclick=e=>{e.stopPropagation(),this.deselect(),v.view("/chat/settings/billing"),s.remove()},e.appendChild(t),i.appendChild(e)}if(u.K.hasPermission("theme:switch")){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const n=document.createElement("i");n.className="fa-solid fa-paintbrush-pencil mr-2",t.appendChild(n);const a=document.createElement("span");a.textContent="Theme",t.appendChild(a),t.onclick=e=>{e.stopPropagation(),this.deselect(),new L,s.remove()},e.appendChild(t),i.appendChild(e)}const c=document.createElement("li");c.className=`border-t ${this.theme.tableDividerLine} my-1`,i.appendChild(c);const d=()=>{const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const n=document.createElement("i");n.className="fa-solid fa-life-ring mr-2",t.appendChild(n);const a=document.createElement("span");a.textContent="Support",t.appendChild(a),t.onclick=e=>{e.stopPropagation(),new f,s.remove()},e.appendChild(t),i.appendChild(e)};window.workspace_context&&window.workspace_support.state?window.workspace_support&&!window.workspace_support.disable_support&&d():d();const h=document.createElement("li"),m=document.createElement("button");m.className=`w-full text-left px-5 py-2 ${this.theme.tableMenuButtonHover} flex items-center`;const p=document.createElement("i");p.className="fa-solid fa-right-from-bracket mr-2",m.appendChild(p);const g=document.createElement("span");g.textContent="Logout",m.appendChild(g),m.onclick=e=>{e.stopPropagation(),u.K.signOut(),s.remove()},h.appendChild(m),i.appendChild(h),s.appendChild(i),s.appendChild(i),document.body.appendChild(s);const w=e.target.getBoundingClientRect(),b=s.getBoundingClientRect();let C=w.top-b.height-10,x=w.left+w.width-b.width;C<0&&(C=w.bottom+10),x<0?x=w.left:x+b.width>window.innerWidth&&(x=window.innerWidth-b.width-8),s.style.top=`${C+window.scrollY}px`,s.style.left=`${x+window.scrollX}px`;const k=t=>{s.contains(t.target)||t.target===e.target||(s.remove(),document.removeEventListener("click",k))};document.addEventListener("click",k)}static hide(){const e=document.getElementById("chat-menu");e&&(e.classList.add("lg:hidden"),e.classList.remove("lg:block"),e.style.display="none !important",e.style.visibility="hidden",e.style.opacity="0",e.style.pointerEvents="none",e.setAttribute("data-forcibly-hidden","true"))}static show(){const e=document.getElementById("chat-menu");e&&(e.classList.remove("lg:hidden"),e.classList.add("lg:block"),e.style.display="",e.style.visibility="",e.style.opacity="",e.style.pointerEvents="",e.removeAttribute("data-forcibly-hidden"))}}var B=s(60023);class D{constructor(e={}){this.theme=i.A.theme,this.options=e,this.activeDropdown=null,this.mode=this.options.mode||"",this.simpleModeTitle=this.options.simpleModeTitle||""}create(){this.menuElement=document.createElement("div");const e="focus"===this.mode?"rounded-tr-md":"rounded-t-md";return this.menuElement.className=`focus-window-menu ${e} ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} py-1 px-2 grid grid-cols-3 items-center`,this.simpleModeElement=this.createSimpleModeTitle(),this.lhsButtons=this.createLHSButtons(),this.centerTitle=this.createCenterTitle(),this.rhsButtons=this.createRHSButtons(),"focus"===this.mode?this.simpleMode(!1):this.simpleMode(!0),this.menuElement.appendChild(this.simpleModeElement),this.menuElement.appendChild(this.lhsButtons),this.menuElement.appendChild(this.centerTitle),this.menuElement.appendChild(this.rhsButtons),this.menuElement}createSimpleModeTitle(){const e=document.createElement("div");e.className="simple-mode-title hidden font-medium text-sm pl-1";const t=this.simpleModeTitle;return e.textContent=t,e}simpleMode(e=!1){e?(this.lhsButtons.classList.add("hidden"),this.centerTitle.classList.add("hidden"),this.simpleModeElement.classList.remove("hidden"),this.menuElement.classList.remove("justify-between"),this.menuElement.classList.add("justify-between")):(this.lhsButtons.classList.remove("hidden"),this.centerTitle.classList.remove("hidden"),this.simpleModeElement.classList.add("hidden"),this.menuElement.classList.remove("justify-end"),this.menuElement.classList.add("justify-between"))}createLHSButtons(){const e=document.createElement("div");if(e.className="flex gap-1 sm:gap-2 justify-start align-middle items-center col-start-1",this.options.fileMenu){const t=this.createButton("File",`rounded-md px-1 sm:px-2 py-0.5 text-sm ${this.theme.focusMenuHover}`);this.attachDropdownMenu(t,this.options.fileMenu),e.appendChild(t)}if(this.options.editMenu){const t=this.createButton("Edit",`rounded-md px-2 py-0.5 text-sm ${this.theme.focusMenuHover}`);this.attachDropdownMenu(t,this.options.editMenu),e.appendChild(t)}if(this.options.viewMenu){const t=this.createButton("View",`rounded-md px-2 py-0.5 text-sm ${this.theme.focusMenuHover}`);this.attachDropdownMenu(t,this.options.viewMenu),e.appendChild(t)}return e}createCenterTitle(){const e=document.createElement("div");e.className="flex justify-center align-middle text-center font-bold text-lg col-start-2";const t=document.createElement("input");t.type="text",t.value=this.options.title||"Untitled";let s=`font-medium rounded-md px-2 py-1 ${this.theme.focusMenuHover} text-sm cursor-pointer w-full bg-transparent border-none outline-none text-center truncate focus:ring-0 focus:outline-none no-select-menu lg:w-[300px] w-[200px]`;t.className=s;return this.options.disableTitleEdit?(t.readOnly=!0,t.classList.remove(this.theme.focusMenuHover),t.classList.remove("cursor-pointer"),t.classList.add("cursor-default")):(t.addEventListener("input",(e=>{t.value.length>150&&(t.value=t.value.slice(0,150)),this.options.onTitleChange&&this.options.onTitleChange(t.value)})),t.addEventListener("focus",(e=>{e.stopPropagation(),t.classList.remove("truncate","bg-transparent",this.theme.focusMenuHover),t.classList.add(this.theme.focusMenuItem,"no-hover"),this.selectAllText(t)})),t.addEventListener("blur",(()=>{this.updateTitleDisplay(t);const e=this.sanitizeFileName(t.value);t.value=e,this.options.onTitleChange&&this.options.onTitleChange(t.value),t.classList.remove(this.theme.focusMenuItem,"no-hover"),t.classList.add("bg-transparent",this.theme.focusMenuHover)})),t.addEventListener("mousedown",(e=>{e.stopPropagation()})),t.addEventListener("click",(e=>{e.stopPropagation(),this.selectAllText(t)})),t.addEventListener("keydown",(e=>{"Enter"===e.key&&(e.preventDefault(),t.blur())}))),e.appendChild(t),this.updateTitleDisplay(t),e}sanitizeFileName(e){return 0===(e=(e=(e=(e=(e=(e=e.split(".").shift()).replace(/[^a-zA-Z0-9 ._-]/g,"")).replace(/\s+/g," ")).trim()).replace(/^\.+/,"")).slice(0,255)).length&&(e="untitled"),e}createRHSButtons(){const e=document.createElement("div");e.className="flex gap-1 justify-end align-middle items-center col-start-3",this.options.quickActions&&this.options.quickActions.forEach((t=>{const s=this.createButton("",`relative rounded-md h-7 w-7 ${this.theme.focusMenuHover}`);s.innerHTML="";const i=o.A.name(t.icon);if(i&&i.path){const e=new r.I({pathData:i.path,viewBox:i.viewBox,colorClass:"text-current",sizeClasses:"w-4 h-4",additionalClasses:"inline-block align-middle"});e.element?s.appendChild(e.element):s.textContent="?"}else s.textContent="?";s.addEventListener("click",(e=>{if(e.stopPropagation(),t.onClick(),"copy"===t.icon&&i&&i.path){const e=o.A.name("check");if(e&&e.path){s.innerHTML="";const t=new r.I({pathData:e.path,viewBox:e.viewBox,colorClass:this.theme.successText||"text-green-600",sizeClasses:"w-4 h-4",additionalClasses:"inline-block align-middle transition-opacity duration-300 ease-in-out opacity-0"});t.element&&(s.appendChild(t.element),requestAnimationFrame((()=>{t.element.classList.remove("opacity-0"),t.element.classList.add("opacity-100")})),setTimeout((()=>{t.element.parentElement===s&&(t.element.classList.remove("opacity-100"),t.element.classList.add("opacity-0")),setTimeout((()=>{s.contains(t.element)&&(s.innerHTML="");const e=new r.I({pathData:i.path,viewBox:i.viewBox,colorClass:"text-current",sizeClasses:"w-4 h-4",additionalClasses:"inline-block align-middle transition-opacity duration-300 ease-in-out opacity-0"});e.element&&(s.appendChild(e.element),requestAnimationFrame((()=>{e.element.classList.remove("opacity-0"),e.element.classList.add("opacity-100")})))}),300)}),1200))}}})),e.appendChild(s)}));const t=this.createButton("",`relative rounded-md h-7 w-7 ${this.theme.focusMenuHover}`);t.innerHTML="";const s="focus"===this.options.mode?"minus":"focus",i=o.A.name(s);if(i&&i.path){const e=new r.I({pathData:i.path,viewBox:i.viewBox,colorClass:"text-current",sizeClasses:"w-4 h-4",additionalClasses:"inline-block align-middle"});e.element?t.appendChild(e.element):t.textContent="focus"===this.options.mode?"-":"+"}else t.textContent="focus"===this.options.mode?"-":"+";return t.addEventListener("click",(e=>{e.stopPropagation(),"focus"===this.mode?this.options.onExitFocus&&this.options.onExitFocus():this.options.onEnterFocus&&this.options.onEnterFocus()})),e.appendChild(t),e}createButton(e,t){const s=document.createElement("button");return s.textContent=e,s.className=t,s}attachDropdownMenu(e,t){let s=null;e.addEventListener("click",(i=>{i.stopPropagation();const n=document.querySelector(".focus-dropdown-menu");if(n&&s===e)return n.remove(),void(s=null);n&&n.remove();const a=document.createElement("div");a.className=`focus-dropdown-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md -50 text-sm`,s=e;const o=document.createElement("ul");o.className="py-1",t.forEach((e=>{if("divider"===e.type){const e=document.createElement("li");return e.className=`border-t ${this.theme.tableDividerLine} my-1`,void o.appendChild(e)}const t=document.createElement("li"),i=document.createElement("button");i.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover}`,i.textContent=e.label,i.onclick=t=>{t.stopPropagation(),e.onClick(),a.remove(),s=null},t.appendChild(i),o.appendChild(t)})),a.appendChild(o),document.body.appendChild(a);const r=e.getBoundingClientRect(),l=a.getBoundingClientRect(),c=window.innerWidth-r.right;let d,h;d=window.innerHeight-r.bottom<l.height&&r.top>l.height?r.top-l.height:r.bottom,h=c<l.width&&r.left>l.width?r.right-l.width:r.left,a.style.top=`${d+window.scrollY}px`,a.style.left=`${h+window.scrollX}px`,requestAnimationFrame((()=>{a.classList.add("show")}));const m=t=>{a.contains(t.target)||t.target===e||(a.classList.remove("show"),setTimeout((()=>{a.remove(),s=null}),150),document.removeEventListener("click",m))};document.addEventListener("click",m)}))}toggleDropdown(e){this.activeDropdown&&this.activeDropdown!==e&&this.hideDropdown(this.activeDropdown),e.classList.toggle("hidden"),e.classList.contains("hidden")?this.activeDropdown=null:this.activeDropdown=e}hideDropdown(e){e.classList.add("hidden"),this.activeDropdown===e&&(this.activeDropdown=null)}selectAllText(e){requestAnimationFrame((()=>{e.select()}))}updateTitleDisplay(e){e.classList.add("truncate"),e.scrollLeft=0}}class ${constructor(e){this.config=e,this.container=null,this.label=null,this.field=null,this.onChangeCallback=null,this.init()}init(){if(this.container=document.createElement("div"),this.container.classList.add("space-y-2"),this.titleAndHelptextContainer=document.createElement("div"),this.config.label&&(this.label=document.createElement("label"),this.label.classList="font-medium",this.label.textContent=this.config.label,this.titleAndHelptextContainer.appendChild(this.label)),this.config.helpText){const e=document.createElement("p");e.textContent=this.config.helpText,e.classList=`text-sm ${i.A.theme.fadedText}`,this.titleAndHelptextContainer.appendChild(e)}(this.config.label||this.config.helpText)&&this.container.appendChild(this.titleAndHelptextContainer),this.fieldOuterContainer=document.createElement("div"),this.fieldOuterContainer.classList="flex gap-2",this.fieldContainer=document.createElement("div"),this.fieldContainer.classList="w-full",this.field=document.createElement("input"),this.field.type="range",this.field.min=this.config.min||0,this.field.max=this.config.max||100,this.field.step=this.config.step||1,this.field.disabled=!!this.config.disabled,this.field.readOnly=!!this.config.readonly,this.field.classList=`w-full h-3 range-lg ${i.A.theme.sliderRailColor} rounded-lg appearance-none cursor-pointer`;const e=document.createElement("style");document.head.appendChild(e),e.textContent+=`\n            input[type='range'].w-full::-webkit-slider-thumb {\n                height: 1.25rem;\n                width: 1.25rem;\n                background-color: ${i.A.theme.sliderThumbColor};\n                border-radius: 9999px;\n                cursor: pointer;\n                appearance: none;\n            }\n            input[type='range'].w-full::-moz-range-thumb {\n                height: 1.25rem;\n                width: 1.25rem;\n                background-color: ${i.A.theme.sliderThumbColor};\n                border-radius: 9999px;\n                cursor: pointer;\n                appearance: none;\n            }\n            input[type='range'].w-full::-ms-thumb {\n                height: 1.25rem;\n                width: 1.25rem;\n                background-color: ${i.A.theme.sliderThumbColor};\n                border-radius: 9999px;\n                cursor: pointer;\n                appearance: none;\n            }\n        `,this.field.value=this.config.value,this.fieldContainer.appendChild(this.field),this.config.minLabel&&this.config.maxLabel&&(this.minMaxLabelContainer=document.createElement("div"),this.minMaxLabelContainer.classList="flex justify-between",this.minLabelDiv=document.createElement("div"),this.minLabelDiv.textContent=this.config.minLabel,this.minLabelDiv.classList=`text-sm ${i.A.theme.fadedText}`,this.minMaxLabelContainer.appendChild(this.minLabelDiv),this.maxLabelDiv=document.createElement("div"),this.maxLabelDiv.textContent=this.config.maxLabel,this.maxLabelDiv.classList=`text-sm ${i.A.theme.fadedText}`,this.minMaxLabelContainer.appendChild(this.maxLabelDiv),this.fieldContainer.appendChild(this.minMaxLabelContainer)),this.fieldOuterContainer.appendChild(this.fieldContainer),this.config.showValue&&(this.valueSpan=document.createElement("div"),this.valueSpan.textContent=this.config.value,this.valueSpan.classList="text-base font-medium w-12 text-center",this.fieldOuterContainer.appendChild(this.valueSpan)),this.container.appendChild(this.fieldOuterContainer),this.addEventListeners()}render(e){e&&e.appendChild(this.container)}addEventListeners(){const e=((e,t)=>{let s;return function(){const i=this,n=arguments;clearTimeout(s),s=setTimeout((()=>e.apply(i,n)),t)}})((e=>{const t=e.target.value;this.config.value=t,this.valueSpan&&(this.valueSpan.textContent=t),"function"==typeof this.onChangeCallback&&this.onChangeCallback(t)}),300);this.field.addEventListener("input",e)}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}get value(){return parseFloat(this.field.value)}set value(e){e=parseFloat(e),isNaN(e)||this.field.value===e||(this.field.value=e,this.config.value=e,this.valueSpan&&(this.valueSpan.textContent=e),"function"==typeof this.onChangeCallback&&this.onChangeCallback(e))}}class P{constructor(e,t,s,n){this.skill=e,this.fields=null,this.skillManifest=null,this.skillTag=null,this.skillContainer=null,this.skillWrapper=null,this.skillUI=null,this.hideShowArrowContainer=null,this.hideShowArrow=null,this.skillShowing=!0,this.onRemoveCallback=null,this.hasUI=null,this.chat=t,this.chatId=t.chat_id,this.chatInputObject=s,this.theme=i.A.theme,this.parentDiv=n,this.validate=this.validate.bind(this)}async init(){if(this.skillManifest=await u.K.getSkillManifest(this.skill),this.skillManifest){if(this.fields=this.skillManifest.fields,0===this.skillManifest.fields.length)return this.hasUI=!1,void this.selectFocus();this.hasUI=!0,this.skillWrapper=document.createElement("div"),this.skillWrapper.className="w-full relative",this.skillContainer=document.createElement("div"),this.skillContainer.className=`flex flex-grow px-4 py-4 ${i.A.theme.skillContainerBG} rounded-md mt-4 mx-4 max-h-[calc(var(--vh)*100-300px)] overflow-y-auto overflow-x-hidden`,this.skillManifest.show_UI_on_open?this.skillShowing=!0:(this.skillContainer.classList.add("hidden"),this.skillShowing=!1),this.skillUI=document.createElement("div"),this.skillUI.className="flex flex-col gap-3 w-full",this.skillContainer.appendChild(this.skillUI),this.skillWrapper.appendChild(this.skillContainer),this.skillManifest.fields.forEach((e=>{this.renderUIComponent(e)})),this.chatInputObject.focus(),this.render()}}selectFocus(){if(this.skillManifest.focusInConfig){for(const e in this.fields)if(this.fields[e].focus){requestAnimationFrame((()=>{this.fields[e].focus()}));break}}else this.chatInputObject.focus()}renderUIComponent(e){try{switch(e.field_type){case"input":const t=new d({label:e.label,type:e.type,placeholder:e.placeholder,value:e.value,minChar:e.minChar,maxChar:e.maxChar,required:e.required,disabled:e.disabled,readonly:e.readonly,error:e.error,helpText:e.help_text});t.render(this.skillUI),this.fields[e.name]=t;break;case"textarea":break;case"fileupload":const s=new J({label:"Upload files",uiType:e.uiType,label:e.label,allowedTypes:e.allowedTypes,maxFiles:e.maxFiles,maxSizePerFile:e.maxSizePerFile,maxTotalSize:e.maxTotalSize,required:e.required,chatId:this.chatId});s.render(this.skillUI),this.fields[e.name]=s;break;case"selectbox":const i=new E({label:e.label,placeholder:e.placeholder,value:e.value,required:e.required,disabled:e.disabled,readonly:e.readonly,error:e.error,helpText:e.help_text,options:e.options});i.render(this.skillUI),this.fields[e.name]=i;break;case"switch":const n=new C({size:e.size,label:e.label,value:e.value,disabled:e.disabled,helpText:e.help_text});n.render(this.skillUI),this.fields[e.name]=n;break;case"slider":const a=new $({label:e.label,value:e.value,showValue:e.showValue,min:e.min,max:e.max,minLabel:e.minLabel,maxLabel:e.maxLabel,step:e.step,disabled:e.disabled,helpText:e.help_text});a.render(this.skillUI),this.fields[e.name]=a}}catch(e){}}get placeholder(){if(this.skillManifest)return this.skillManifest.placeholder}toggleSkillUI(){this.skillShowing?this.close():this.open()}close(){this.hasUI&&this.skillShowing&&(this.skillUI.classList.add("hidden"),this.skillContainer.classList.add("hidden"),this.skillShowing=!1,this.chatInputObject.focus())}open(){this.hasUI&&!this.skillShowing&&(this.skillUI.classList.remove("hidden"),this.skillContainer.classList.remove("hidden"),this.skillShowing=!0,this.selectFocus())}validate(e){let t=!0;for(const s in this.fields){const i=this.fields[s];"function"==typeof i.validate&&(i.validate(e)||(t=!1))}return t}get values(){if(this.validate()){const e={};for(const t in this.fields)e[t]=this.fields[t].value;return e}}get fileRender(){if("upload"===this.skillManifest.value)return this.fields.upload.getFileViewRender(this.chat)}render(){this.parentDiv.appendChild(this.skillWrapper)}static renderSkillTag(e,t,s){const n=u.K.available_skills.find((t=>t.value===e));if(!n)return;const a=n,l=document.createElement("div");l.className="flex flex-col items-end w-full max-w-full gap-1";const c=document.createElement("div");if(c.className=`inline-flex items-center justify-end w-fit align-middle rounded-md px-2 py-1 ${i.A.theme.secondaryButtonTransparent} text-sm gap-1 self-end cursor-default`,a.icon){const e=document.createElement("div");e.className="flex-shrink-0";const t=o.A.name(a.icon),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-3.5 h-3.5"});s.element&&(e.appendChild(s.element),c.appendChild(e))}const d=document.createElement("div");d.className="flex-shrink-0",d.textContent=a.tag_name,c.appendChild(d),l.appendChild(c);let h="";if("youtube"===a.value&&s?h=`\n                <div class="skill-placeholder w-full" data-message-key="${t}" data-skill="${a.value}">\n                    <div class="rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-3 m-0.5 flex flex-col gap-3 truncate">\n                        <div class="w-[372px] h-[200px] bg-gray-300 animate-pulse rounded-md"></div>\n                        <div class="flex flex-col gap-2">\n                            <div class="h-4 ${i.A.theme.loadBackground} animate-pulse rounded w-3/4"></div>\n                            <div class="h-3 ${i.A.theme.loadBackground}  animate-pulse rounded w-1/2"></div>\n                        </div>\n                    </div>\n                </div>\n            `:"crawl"===a.value&&s&&(h=`\n                <div class="skill-placeholder w-full" data-message-key="${t}" data-skill="${a.value}">\n                    <div class="rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-3 m-0.5 flex items-center gap-3 w-[396px]">\n                        <div class="w-10 h-10 ${i.A.theme.loadBackground} animate-pulse rounded-md"></div>\n                        <div class="flex flex-col gap-2 flex-grow">\n                            <div class="h-4 ${i.A.theme.loadBackground} animate-pulse rounded w-3/4"></div>\n                            <div class="h-3 ${i.A.theme.loadBackground} animate-pulse rounded w-full"></div>\n                        </div>\n                    </div>\n                </div>\n            `),h){const e=document.createElement("div");e.innerHTML=h,l.appendChild(e.firstElementChild)}return l}}class N{constructor(){this.map=new Map,this.pending=new Map,this.adapters=new Map,this.typeConfig=new Map}static get instance(){return window.__compRegistry||(window.__compRegistry=new N),window.__compRegistry}registerType(e,t,s){this.typeConfig.set(e,t),this.adapters.set(e,s)}key(e,t){return`${e}:${String(t)}`}register(e,t,s){const i=this.key(e,t);this.map.set(i,s);const n=this.pending.get(i);n&&(this.update(e,t,n),this.pending.delete(i))}unregister(e){for(const[t,s]of this.map.entries())s===e&&this.map.delete(t)}get(e,t){return this.map.get(this.key(e,t))||null}update(e,t,s){const i=this.key(e,t),n=this.map.get(i);if(!n)return this.pending.set(i,s),!1;const a=this.adapters.get(e);return a&&"function"==typeof a.update&&a.update(n,s),!0}}const z={document:{tag:"output-document",idAttr:"document-id",singleton:!0}};window._msgSources||(window._msgSources={});class F{constructor(e,t,s,n=!1,a=null,o=!1){this.user=u.K.user,this.streamingBlocks=new Map,this.codeBlocks=new Map,this.scrollViewAttachedBottom=!1,this.initialScrollLag=!0,this.lastUserMessageElement=null,this.isLoadingHistory=!0,this.container=null,this.theme=i.A.theme,this._assistant=t,this._model=e,this._chat=s,this._chat_obj=a,this._thread=n,this.idsToUpdate=new Map,this.existingCodeBlocks=new Map,this.userMessageSet=new Set,this.processedAssistantMessages=new Set,this.assistantMessages=new Set,this.userMessages=new Set,this.seenRunIds=new Set,this.imageCount=0,this.messagesContainer=null,this.streamMsgIndex={},this.fileViewForRunId={},this.dragOverMessage=null,this.isDragging=!1,this.dragCounter=0,this.dragListenersEnabled=!1,this.onReplyToCallback=null,this.currentPreview=null,this.previewTimeout=null,this.hideTimeout=null,this.isShowingPreview=!1,this.placeholderShowing=!1,this.titleMenu=null,this.currentMessagePairWrapper=null,this.onFilesDropCallback=null,this.isFocused=!1,this.handleDragOverBound=this.handleDragOver.bind(this),this.handleDragEnterBound=this.handleDragEnter.bind(this),this.handleDragLeaveBound=this.handleDragLeave.bind(this),this.handleDropBound=this.handleDrop.bind(this),F.tellMeAboutFocus(this.handleFocusModeChange.bind(this)),this.isMobile=u.K.isMobile(),this.isPWA=u.K.isStandAlone(),this.isIpad=u.K.isIPad(),this.setupMarked(),this.init(),this.floatingMenu=null,this.selectedText="",this.createFloatingMenu(),this.addSelectionListeners(),this.currentAudioSource=null,this.audioContext=null,this.audioQueue=[],this.isPlaying=!1,this.isReading=!1}testThoughtStream(){setTimeout((()=>{const e=this.messagesContainer.querySelector('[data-type="assistant"]');if(e){const t=e.dataset.id;this.addThoughtStream(t)}else setTimeout((()=>this.testThoughtStream()),2e3)}),2e3)}init(){this.outerContainer=document.createElement("div");let e=this.isPWA&&this.isMobile?"h-[calc(var(--vh)*100-45px)]":"h-[calc(var(--vh)*100-38px)]";this.isIpad&&(e="h-[calc(var(--vh)*100-40px)]"),this.outerContainer.className=`overflow-hidden flex-grow flex flex-col w-full focus:outline-none relative ${e}`,this.outerContainer.id="outer-chat-session-container",this.container=document.createElement("div"),this.container.className="flex flex-grow justify-center overflow-y-auto overflow-x-hidden w-full pt-4 sm:px-8 focus:outline-none chat-session-top",this.container.id="chat-session-container",this.outerContainer.appendChild(this.container),this.messagesContainer=document.createElement("div"),this.messagesContainer.className=`px-6 pt-14 sm:pt-15 md:pt-14 lg:pt-14 session-bar-padding md:px-0 w-full md:max-w-[720px] leading-6 tracking-wide break-words ${this.theme.text}`,this.messagesContainer.id=`messages-for-chat-${this._chat.id}`,this.container.appendChild(this.messagesContainer),this._outObserver=new MutationObserver((e=>{const t=N.instance;for(const s of e)s.addedNodes.forEach((e=>{if(1!==e.nodeType)return;const s=e.tagName?.toLowerCase();for(const[i,n]of Object.entries(z)){if(n.tag!==s)continue;const a=e.getAttribute(n.idAttr);if(!a)continue;const o=t.get(i,a);n.singleton&&o&&o!==e?(o.replaceWith(e),t.register(i,a,e)):t.register(i,a,e)}}))})),this._outObserver.observe(this.messagesContainer,{childList:!0,subtree:!0}),this.history=[],this.container.addEventListener("scroll",this.handleScroll.bind(this));window.addEventListener("resize",((e,t)=>{let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>e.apply(this,i)),t)}})((()=>{this.updateScrollPosition()}),200)),this.createDragOverMessage(),this.enableDragAndDropFileUpload(),this.addKeyboardNavigation(),this.createNavigationButton(),this.enableDragAndDropFileUpload(),document.querySelectorAll("workspace-computer").forEach((e=>{e.cleanup(),e.remove()}))}handleFocusModeChange(e,t){this.repositionNavigationButtons(e)}toggleMoreMenu(){const e=document.createElement("div");e.classList="flex flex-col gap-3 overflow-y-auto py-2 px-0.5",this.modalConfig={size:"small",title:"Session overview",body:e,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1},this.modal=new l(this.modalConfig);const t=this.findAllBlocks();if(t.length>0){const s=document.createElement("div");s.className="text-lg tracking-tighter font-medium",e.appendChild(s);const i=document.createElement("div");i.className="space-y-2",t.forEach(((e,t)=>{let s;"image"===e.type?s={name:e.name,file_type:"image",type:"image",url:e.url,element:e.element}:"code"===e.type?s={name:e.name+"."+e.language||"Untitled",file_type:"code",type:"code",extension:e.language||"plain",preview:e.isPreviewEnabled,element:e.element}:"file"===e.type&&(s={name:e.name,file_type:e.file_type,type:"file",extension:e.extension,url:e.url,element:e.element});const n=document.createElement("div");n.className="menu-item-wrapper cursor-pointer";const a=new Y([s],this._chat,!1,!0).render();n.appendChild(a),n.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.modal.close(),"code"===s.type&&"function"==typeof s.element.handleFocus?s.element.handleFocus():"image"===s.type?setTimeout((()=>s.element.click()),0):"file"===s.type&&s.element.click()}),!0),i.appendChild(n)})),e.appendChild(i)}const s=new n.$({text:"Delete session",type:"ringPrimary",size:"large",width:"full"});s.render(e),s.onClick((()=>{this.modal.close();new a("Are your sure?","This will permanently delete this session.").onConfirm((()=>{this.deleteConversation(this._chat.id)}))}))}findAllBlocks(){const e=Array.from(this.messagesContainer.querySelectorAll("code-block, .internal-image, .file-item-detail")).map(((e,t)=>{if("code-block"===e.tagName.toLowerCase())return{index:t,element:e,type:"code",name:e.getAttribute("file-title"),language:e.getAttribute("language"),hasPreview:e.hasAttribute("preview"),isPreviewEnabled:"false"!==e.getAttribute("preview"),blockId:e.getAttribute("block-id"),code:e.code||"",isFocused:"focus"===e.getAttribute("mode")};if(e.classList.contains("internal-image"))return{index:t,element:e,type:"image",file_type:"image",name:`Image ${t+1}.png`,url:e.src};{const s=e.dataset.file,i=e.dataset.fileType,n=e.dataset.extension;return{index:t,element:e,type:"file",file_type:i||n,name:s,extension:n,url:e.querySelector("a")?.href||""}}}));return 0===e.length?[]:e}deleteConversation(e){g.G.postData("/chat/delete/",{uuid:e}).then((()=>{v.view("/chat");new c.y("Session deleted","success")})).catch((e=>{}))}debounce=(e,t)=>{let s;return(...i)=>{clearTimeout(s),s=setTimeout((()=>e.apply(this,i)),t)}};onSetConversationNameFail(e){}selectAllText(e){requestAnimationFrame((()=>{e.select()}))}updateTitleDisplay(e){e.classList.add("truncate"),e.scrollLeft=0}setLoadListener(){this.outerContainer.classList.add("opacity-0","transition-all","duration-300")}setupMarked(){const e=this._chat,t={name:"groupedImage",level:"block",start:e=>e.indexOf("!["),tokenizer(t,s){const i=/^\s*!\[(.*?)]\((.*?)\)\s*/;let n=t.match(i);if(!n)return!1;const a=(n[2]||"").trim();if((o=a)&&[".mp4",".webm","mov",".ogg"].some((e=>o.toLowerCase().endsWith(e))))return{type:"video",raw:n[0],href:a,text:(n[1]||"").trim(),chat:e};var o;if((e=>!!e&&[".mp3",".wav",".ogg"].some((t=>e.toLowerCase().endsWith(t))))(a))return{type:"audioPlayer",raw:n[0],href:a,audioName:(n[1]||"").trim(),audioURL:a,chat:e};if((e=>!!e&&[".glb",".gltf"].some((t=>e.toLowerCase().endsWith(t))))(a))return{type:"3dmodel",raw:n[0],href:a,text:(n[1]||"").trim(),chat:e};if((e=>{if(!e)return!1;const t=e.toLowerCase();return[".c",".cs",".cpp",".java",".md",".php",".py",".rb",".tex",".css",".js",".sh",".ts",".html",".doc",".docx",".pdf",".pptx",".txt",".xlsx",".csv",".json",".xml",".tar",".zip",".pkl"].some((e=>t.endsWith(e)))})(a)){const t=a.split(".").pop().toLowerCase(),s=(n[1]||"").trim(),i=a.substring(a.lastIndexOf("/")+1);return{type:"fileOutput",raw:n[0],fileName:s||i,fileUrl:a,fileExtension:t,chat:e}}const r=[];let l="",c=!1;for(;n;){const e=n[0],s=n[1]||"",a=n[2]||"";/\{full-width\}/.test(s)&&(c=!0),r.push({url:a.trim(),alt:s.replace(/\{full-width\}/g,"").trim(),filename:a.substring(a.lastIndexOf("/")+1)||"image.png"}),l+=e,n=(t=t.substring(e.length).trimStart()).match(i)}if(r.length>0){return{type:"groupedImage",raw:l,images:r,fullWidth:c,tokens:[]}}return!1},renderer(e){let t=`images='${JSON.stringify(e.images).replace(/'/g,"&#39;").replace(/"/g,"&quot;")}'`;return e.fullWidth&&(t+=" full-width"),`<output-image ${t}></output-image>`}},s={name:"outputProteinStructure",level:"block",start:e=>e.indexOf("<output-protein-structure"),tokenizer(e,t){const s=/^\s*<output-protein-structure.*?<\/output-protein-structure>/s.exec(e);if(s){const e=s[0],t={};try{const s=document.createElement("div");s.innerHTML=e;const i=s.firstElementChild;if(i)for(const e of i.attributes)t[e.name]=e.value}catch(e){}return{type:"outputProteinStructure",raw:e,attributes:t,text:""}}return!1},renderer:e=>e.raw},i={name:"outputDocument",level:"block",start:e=>e.indexOf("<output-document"),tokenizer(e,t){const s=/^\s*<output-document.*?(?:\/>|<\/output-document>)/s.exec(e);if(s){const e=s[0],t={};try{const s=document.createElement("div");s.innerHTML=e;const i=s.firstElementChild;if(i)for(const e of i.attributes)t[e.name]=e.value}catch(e){}return{type:"outputDocument",raw:e,attributes:t,text:""}}return!1},renderer:e=>e.raw},n={name:"versionTile",level:"block",start:e=>e.indexOf("<version-tile"),tokenizer(e){const t=/^\s*<version-tile\b([^>]*)>(?:<\/version-tile>)?/.exec(e);if(!t)return!1;const s=t[0],i={};try{const e=document.createElement("div");e.innerHTML=s.endsWith("</version-tile>")?s:`${s}</version-tile>`;const t=e.firstElementChild;if(t)for(const e of t.attributes)i[e.name]=e.value}catch(e){}return{type:"versionTile",raw:s,attributes:i,text:""}},renderer:e=>e.raw},a={name:"videoPlayer",level:"block",start:e=>e.indexOf("<output-video"),tokenizer(e){const t=e.match(/^\s*<output-video\b/);if(!t)return!1;let s=null,i=t[0].length;for(;i<e.length;i++){const t=e[i];if(s)t===s&&(s=null);else if('"'===t||"'"===t)s=t;else if(">"===t){const t=e.slice(0,i+1),s={},n=/([\w-]+)=(?:"([^"]*)"|'([^']*)')/g;let a;for(;null!==(a=n.exec(t));)s[a[1]]=a[2]||a[3];let o=i+1;const r=e.slice(o).match(/^\s*<\/output-video\s*>/);r&&(o+=r[0].length);return{type:"videoPlayer",raw:e.slice(0,o),attributes:s,callId:s.song_id||s.call_id||null,videoName:s["video-name"]||s.video_name||null,text:""}}}if(null!==s)return;const n=e.slice(t[0].length).trim();return n.length>0&&!n.includes(">")&&void 0},renderer:e=>e.raw},o={name:"audioPlayer",level:"block",start:e=>e.indexOf("<audio-player"),tokenizer(e){const t=e.match(/^\s*<audio-player\b/);if(!t)return!1;let s=null,i=t[0].length;for(;i<e.length;i++){const t=e[i];if(s)t===s&&(s=null);else if('"'===t||"'"===t)s=t;else if(">"===t){const t=e.slice(0,i+1),s={},n=/([\w-]+)=(?:"([^"]*)"|'([^']*)')/g;let a;for(;null!==(a=n.exec(t));)s[a[1]]=a[2]||a[3];let o=i+1;const r=e.slice(o).match(/^\s*<\/audio-player\s*>/);r&&(o+=r[0].length);return{type:"audioPlayer",raw:e.slice(0,o),attributes:s,callId:s.song_id||s.call_id||null,audioName:s["audio-name"]||s.audio_name||null,text:""}}}if(null!==s)return;const n=e.slice(t[0].length).trim();return n.length>0&&!n.includes(">")&&void 0},renderer:e=>e.raw},r={name:"outputMap",level:"block",start:e=>e.indexOf("<output-map"),tokenizer(e,t){const s=/^\s*<output-map.*?map-data=(['"])(.*?)\1.*?>.*?<\/output-map>/s.exec(e);if(s){const e=s[0],t=s[2];let i="{}";try{const e=document.createElement("textarea");e.innerHTML=t,i=e.value}catch(e){}return{type:"outputMap",raw:e,mapData:i,text:""}}return!1},renderer:e=>e.raw},l={name:"sourceTag",level:"inline",start:e=>e.indexOf("[so-"),tokenizer(e,t){const s=/^\s*\[so-([0-9]+)\]/i.exec(e);return s?{type:"sourceTag",raw:s[0],tokens:[]}:!(!e.trim().startsWith("[so-")||e.includes("]"))&&void 0},renderer:e=>e.raw},c={name:"allSources",level:"block",start:e=>e.match(/<all/i)?.index??-1,tokenizer(e,t){const s=/^<allsources>/i.exec(e);return!!s&&{type:"allSources",raw:s[0]}},renderer:e=>e.raw},d={extensions:[l,i,{name:"allSourcesEnd",level:"block",start:e=>e.match(/<\/allsources>/i)?.index??-1,tokenizer(e,t){const s=/^<\/allsources>/i.exec(e);return!!s&&{type:"allSourcesEnd",raw:s[0]}},renderer:e=>""},t,a,o,s,{name:"hr",level:"block",start:e=>e.match(/^(-{3,}|_{3,}|\*{3,})/)?.index??-1,tokenizer(e,t){const s=/^(?:[-*_]){3,}(?:\s*)(?:\n+|$)/.exec(e);return!!s&&{type:"hr",raw:s[0]}}},{name:"mcp-tool-usage",level:"block",start:e=>e.match(/<mcp-tool-usage/)?.index??-1,tokenizer(e,t){const s=/^<mcp-tool-usage\s+id="([^"]+)"><\/mcp-tool-usage>/.exec(e);return!!s&&{type:"mcp-tool-usage",raw:s[0],toolId:s[1]}},renderer:e=>e.raw},{name:"workspace-computer",level:"block",start:e=>e.match(/<workspace-computer/)?.index??-1,tokenizer(e,t){const s=/^<workspace-computer\s+uuid="([^"]+)"\s+chatid="([^"]+)"><\/workspace-computer>/.exec(e);return!!s&&{type:"workspace-computer",raw:s[0],uuid:s[1],chatId:s[2]}},renderer:e=>e.raw},{name:"latex-block",level:"block",start(e){const t=[e.indexOf("$$"),e.indexOf("\\["),e.indexOf("\\begin{")].filter((e=>-1!==e));return t.length?Math.min(...t):-1},tokenizer(e){let t=/^\$\$([\s\S]+?)\$\$/.exec(e);if(t)return{type:"latex-block",raw:t[0],formula:t[1]};if(t=/^\\\[([\s\S]+?)\\\]/.exec(e),t)return{type:"latex-block",raw:t[0],formula:t[1]};if(t=/^\\begin\{([a-zA-Z*]+)\}([\s\S]+?)\\end\{\1\}/.exec(e),t){const e=t[1],s=t[2],i=/^eqnarray\*?$/.test(e)?"aligned":e,n=`\\begin{${i}}${s}\\end{${i}}`;return{type:"latex-block",raw:t[0],formula:n}}},renderer:e=>`<div class="latex-block">${renderLatex(e.formula,!0)}</div>`},{name:"latex-inline",level:"inline",start(e){const t=[e.indexOf("$"),e.indexOf("\\(")].filter((e=>-1!==e));return t.length?Math.min(...t):-1},tokenizer(e){let t=/^\$([\s\S]+?)\$/.exec(e);if(t||(t=/^\\\(([\s\S]+?)\\\)/.exec(e)),!t)return;let s=t[1];const i=s.trim();return/^[-+]?\s*\d{1,3}(?:,\d{3})*(?:\.\d+)?\s*$/.test(i)?void 0:/[\r\n]|\\\\|\\begin\{[^}]+\}/.test(i)?(s=i.replace(/\\begin\{eqnarray\*?\}/g,"\\begin{aligned}").replace(/\\end\{eqnarray\*?\}/g,"\\end{aligned}"),{type:"latex-block",raw:t[0],formula:s}):i.includes("\\")||/[_^{}]/.test(i)||/^[a-zA-Z]$/.test(i)||/\\[a-zA-Z]+/.test(i)?{type:"latex-inline",raw:t[0],formula:i}:void 0},renderer:e=>`<span class="latex-inline">${renderLatex(e.formula,!0)}</span>`},c,r,n]};B.xI.use(d);const h=new B.xI.Renderer;B.xI.setOptions({renderer:h,sanitize:!0,gfm:!0,smartLists:!0,breaks:!0,pedantic:!1,fences:!0,sanitizer:e=>e.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))})}initialLoadComplete(){this.isLoadingHistory=!1,this.togglePlaceholder(!1);const e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`),setTimeout((()=>{this.updateScrollPosition()}),20),this._resizeObserver||(this._resizeObserver=new ResizeObserver((()=>{this.scrollViewAttachedBottom&&this.updateScrollPosition()})),this._resizeObserver.observe(this.messagesContainer));const t=document.getElementById("nav-buttons");t&&(t.classList.remove("opacity-0"),t.classList.add("opacity-50")),this.updateNavigationButtonVisibility()}render(e,t=null,s=null){e&&(e.appendChild(this.outerContainer),t&&this.outerContainer.appendChild(t),this.togglePlaceholder(),this.taskBar=s)}async modelChangeNotification(){return new Promise((e=>{const t=this.onChangeModel;this.onChangeModel=s=>{t.call(this,s),e(s),this.onChangeModel=t}}))}onChangeModel(e){if(this.placeholderShowing)return;let t=this.messagesContainer;this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair&&(t=this.currentMessagePairWrapper);const s=t?.querySelectorAll(".model-switch");s?.forEach((e=>e.remove()));const i=document.createElement("div");i.className=`flex w-full py-2 model-switch ${this.theme.switchText}`;const n=document.createElement("div");n.className=`text-sm ${this.theme.switchText}`,n.innerText=e,i.appendChild(n),t?.appendChild(i),this.scrollViewAttachedBottom=!1,this.updateScrollPosition()}onChangeAssistant(e,t=!1){const s=this.messagesContainer.querySelector(".chat-message-placeholder");if(this.placeholderShowing&&s){const t=s.querySelector("img");return t&&(t.src=e.image||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png",t.alt=`Assistant avatar for ${e.name}`),void(this._assistant=e)}let i=this.messagesContainer;this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair&&(i=this.currentMessagePairWrapper);const n=i?.lastElementChild;if(n&&n.classList.contains("assistant-switch")&&i.removeChild(n),t&&!this.placeholderShowing&&!this._chat_obj?.isInitializingFork){const t=document.createElement("div");t.className="flex w-full py-2 assistant-switch";const s=document.createElement("div");s.className=`text-sm ${this.theme.switchText}`,s.innerText=`You're now speaking with ${e.name}`,t.appendChild(s),i?.appendChild(t),this.scrollViewAttachedBottom=!1,this.updateScrollPosition()}this._assistant=e}reattachScrollToBottom(){this.scrollAttachedToBottom=!0,this.updateScrollPosition()}handleScroll(){const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.container;t-e-s<1?this.scrollViewAttachedBottom=!0:t-e-s>20&&(this.scrollViewAttachedBottom=!1),this.updateNavigationButtonVisibility()}updateScrollPosition(){const e=this.container.clientHeight,t=this.container.scrollHeight,s=this.container.scrollTop;if(this.userMessageSet.has(this.lastUserMessageElement?.dataset.id))return void(this.scrollViewAttachedBottom&&this.scrollToBottom());if(this.lastUserMessageElement){const e=this.lastUserMessageElement.getBoundingClientRect(),t=this.container.getBoundingClientRect(),s=e.top-t.top;if(this.lastUserMessageElement.classList.contains("truncated-user-msg"),s<80&&s>0)return this.userMessageSet.add(this.lastUserMessageElement.dataset.id),void(this.scrollViewAttachedBottom=!1);if(s>=80&&e.bottom<=t.bottom)return this.scrollViewAttachedBottom=!0,void this.scrollToBottom()}t-s-e<50?(this.scrollViewAttachedBottom=!0,this.scrollToBottom()):this.scrollViewAttachedBottom=!1}getLatestUserMessage(){const e=Array.from(this.messagesContainer.querySelectorAll('[data-type="user"]'));return e[e.length-1]}scrollToBottom(e=!1){this.container.scrollTo({top:this.container.scrollHeight,behavior:e?"smooth":"auto"})}scrollToMessageTop(e){const t=this.container.getBoundingClientRect(),s=e.getBoundingClientRect(),i=this.isMobile?80:40,n=s.top-t.top+this.container.scrollTop-i;this.container.scrollTo({top:n,behavior:"smooth"})}updateNavigationButtonVisibility(){const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.container,i=0===e,n=t-e<=s;this.upArrow.style.opacity=i?"0.5":"1",this.downArrow.style.opacity=n?"0.5":"1"}addHoverEffect(){u.K.isMobile()||(this.navButton.addEventListener("mouseenter",(()=>{this.navButton.classList.remove("opacity-50")})),this.navButton.addEventListener("mouseleave",(()=>{this.navButton.classList.add("opacity-50")})))}addKeyboardNavigation(){document.addEventListener("keydown",(e=>{window.user.preferences.enableKeyboardShortcuts&&e.altKey&&("ArrowUp"===e.key?(e.preventDefault(),this.navigateMessages("up")):"ArrowDown"===e.key&&(e.preventDefault(),this.navigateMessages("down")))}))}repositionNavigationButtons(e){this.navButton&&(e?this.navButton.classList.add("hidden"):this.navButton.classList.remove("hidden"))}createNavigationButton(){let e;e=u.K.isMobile()?"bottom-[150px]":"bottom-[130px]",this.navButton=document.createElement("div"),this.navButton.className=`absolute ${e} right-3 lg:bottom-5 lg:right-4 md:left-auto z-30 flex flex-col ${this.theme.background} shadow-md rounded-md opacity-0 transition-opacity duration-400 text-base`,this.navButton.id="nav-buttons";const t=o.A.name("chevronUp"),s=o.A.name("chevronDown"),i=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"}),n=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4"});this.upArrow=document.createElement("button"),i.element?this.upArrow.innerHTML=i.element.outerHTML:this.upArrow.innerHTML="",this.upArrow.className=`px-1.5 py-1 rounded-t-md ${this.theme.secondaryButton}`,this.upArrow.style.touchAction="manipulation",this.downArrow=document.createElement("button"),n.element?this.downArrow.innerHTML=n.element.outerHTML:this.downArrow.innerHTML="",this.downArrow.className=`px-1.5 py-1 rounded-b-md ${this.theme.secondaryButton}`,this.downArrow.style.touchAction="manipulation",this.navButton.appendChild(this.upArrow),this.navButton.appendChild(this.downArrow),this.outerContainer.appendChild(this.navButton),this._lastUpTap=0,this._lastDownTap=0,this.upArrow.addEventListener("click",(()=>{const e=Date.now();if(e-(this._lastUpTap||0)<300)return this.container.scrollTo({top:0,behavior:"smooth"}),void(this._lastUpTap=0);this._lastUpTap=e,this.navigateMessages("up"),this.scrollViewAttachedBottom=!1})),this.downArrow.addEventListener("click",(()=>{const e=Date.now();if(e-(this._lastDownTap||0)<300)return this.scrollToBottom(!0),void(this._lastDownTap=0);this._lastDownTap=e,this.navigateMessages("down"),this.scrollViewAttachedBottom=!1})),this.upArrow.addEventListener("dblclick",(()=>{this.container.scrollTo({top:0,behavior:"smooth"})})),this.downArrow.addEventListener("dblclick",(()=>{this.scrollToBottom(!0)})),this.addHoverEffect(),this.updateNavigationButtonVisibility()}navigateMessages(e){const t=Array.from(this.messagesContainer.querySelectorAll('[data-type="user"]')),{scrollTop:s,scrollHeight:i,clientHeight:n}=this.container,a=0===s,o=i-s<=n+1;if(0===t.length)return;const r=this.container.getBoundingClientRect();let l=null;if("down"===e){if(o)return void(this.scrollViewAttachedBottom=!0);for(let e=0;e<t.length;e++){if(t[e].getBoundingClientRect().top>=r.bottom-80){l=t[e];break}}if(!l)return void this.scrollToBottom(!0)}else if("up"===e){if(a)return;let e=-1;for(let s=0;s<t.length;s++){if(t[s].getBoundingClientRect().bottom>r.top+80){e=s;break}}if(-1===e)for(let s=t.length-1;s>=0;s--){if(t[s].getBoundingClientRect().bottom<=r.top+80){e=s+1;break}}const s=e>0?e-1:-1;if(!(s>=0))return void this.container.scrollTo({top:0,behavior:"smooth"});l=t[s]}if(l){const e=this.container.getBoundingClientRect(),t=l.getBoundingClientRect(),s=this.getTabsHeight(),i=this.container.scrollTop+(t.top-e.top)-s+10;this.container.scrollTo({top:Math.max(0,i),behavior:"smooth"})}}getScrollContainer(){return this.container}getScrollTop(){const e=this.getScrollContainer();return e?e.scrollTop:0}setScrollTop(e){const t=this.getScrollContainer();t&&(t.scrollTop=e)}getTabsHeight(){return 45}toggleAssistantMessageThinking(e){const t=Array.from(this.messagesContainer.querySelectorAll('[data-type="assistant"]'));if(0===t.length)return;const s=t[t.length-1].querySelector(".assistant-body-text, .agent-body-text");if(!s)return;const i=s.querySelector(".inline-thinking-indicator");if(i&&i.remove(),e){const e=document.createElement("div");e.className="inline-thinking-indicator flex items-center my-4",e.innerHTML='\n                <div class="thinking-dots-container-inline">\n                    <div class="thinking-dot-inline thinking-dot-1-inline"></div>\n                    <div class="thinking-dot-inline thinking-dot-2-inline"></div>\n                    <div class="thinking-dot-inline thinking-dot-3-inline"></div>\n                </div>\n            ',s.appendChild(e),this.scrollViewAttachedBottom&&this.scrollToBottom(!0)}}toggleUserVoiceInput(e){const t=this.messagesContainer.querySelector(".voice-input-placeholder");if(e){if(t)return;const e=document.createElement("div");e.className="flex gap-3 pt-3 pb-2 justify-end relative voice-input-placeholder",e.dataset.type="user";const s=document.createElement("div");s.className="flex flex-col overflow-hidden outer-message-container gap-2 w-full max-w-[80%] items-end";const i=document.createElement("div");i.className=`${this.theme.secondaryBackground} px-4 py-3 rounded-md max-w-full w-fit self-end`,i.innerHTML='\n                <div class="flex items-center gap-2 h-6">\n                    <div class="waveform-animation">\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                    </div>\n                </div>\n            ',s.appendChild(i),e.appendChild(s),this.messagesContainer.appendChild(e),this.scrollToBottom()}else t&&t.remove()}toggleAssistantThinking(e){if(e){this.loadDiv&&(this.loadDiv.remove(),this.loadDiv=""),this.loadDiv=document.createElement("div"),this.loadDiv.className="flex gap-3 pt-4 pb-2 w-full";const e=document.createElement("div");e.className="flex-shrink-0 flex flex-col relative items-end";const t=document.createElement("img");t.className="rounded-full w-8 h-8 flex flex-shrink-0",t.draggable=!1;const s=document.createElement("div");s.className="flex flex-col overflow-hidden px-0.5 w-full";const i=document.createElement("div");i.className="font-semibold";const n=document.createElement("div");n.className="markdown-style break-words w-full flex items-center loading-shimmer py-1",e.appendChild(t),this.loadDiv.appendChild(e),s.appendChild(i),s.appendChild(n),this.loadDiv.appendChild(s),i.innerText=this._assistant.name,t.src=this._assistant.image,n.innerHTML="",n.textContent="One moment...",n.style.webkitTextFillColor="currentColor",n.style.color="currentColor";window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches||requestAnimationFrame((()=>{requestAnimationFrame((()=>{n.style.webkitTextFillColor="",n.style.color=""}))}));(this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair?this.currentMessagePairWrapper:this.messagesContainer).appendChild(this.loadDiv),this.updateScrollPosition()}else this.loadDiv&&(this.loadDiv.innerHTML="",this.loadDiv.remove(),this.loadDiv="")}showAssistantError(e,t="",s=null,i="error",a){let r,l;switch(this._chat_obj&&this._chat_obj.chatInput&&(this._chat_obj.chatInput.toggleStopButton(!1),this._chat_obj.chatInput.toggleSendButton()),this.toggleAssistantThinking(!1,a),t||(t="An error occurred"),i){case"error":r=this.theme.toastError,l="Hmmm... something appears to have gone wrong.";break;case"censorship":r=this.theme.toastInfo,l="Your response was censored by the model provider.";break;case"model_rate_limit":r=this.theme.toastInfo,l="The model is over limit.";break;case"disconnected":r=this.theme.toastInfo,l="It looks like you're not connected to the internet."}this.errorDiv=document.createElement("div"),this.errorDiv.className="flex gap-3 pt-4 pb-4 w-full assistant-message-error-display",this.errorDiv.dataset.type="assistant";const c=document.createElement("div");c.className="flex-shrink-0 flex flex-col relative items-end";const d=document.createElement("img");d.className="rounded-full w-8 h-8 flex flex-shrink-0",d.draggable=!1;const h=document.createElement("div");h.className="flex flex-col overflow-hidden px-0.5 w-full";const m=document.createElement("div");m.className="font-semibold";const u=document.createElement("div");u.className="markdown-style break-words w-full pb-2",c.appendChild(d),this.errorDiv.appendChild(c),h.appendChild(m),h.appendChild(u),this.errorDiv.appendChild(h),m.innerText=this._assistant.name,d.src=this._assistant.image;const p=document.createElement("div");p.className="flex flex-col gap-2 w-full";const v=document.createElement("div");v.className=`${r} p-4 rounded-md w-full my-2`,v.innerHTML=`<div class="font-bold">${l}</div><div class="text-base">${t}</div>`,p.appendChild(v);const y=document.createElement("div");y.className="flex gap-1 items-center align-middle w-full pb-2 pt-0.5";const w=new n.$({type:"focus",svgPathData:o.A.icon.rotate.path,svgViewBox:o.A.icon.rotate.viewBox,size:"small",width:"auto",text:"Try again"});"censorship"!==i&&"computer"!==i&&w.render(y);const b=new n.$({type:"focus",svgPathData:o.A.icon.cube.path,svgViewBox:o.A.icon.cube.viewBox,size:"small",width:"auto",text:"Switch model"});let C;"computer"!==i&&b.render(y),"computer"===i&&(C=new n.$({type:"focus",svgPathData:o.A.icon.powerOff.path,svgViewBox:o.A.icon.powerOff.viewBox,size:"small",width:"auto",text:"Restart computer"}),C.render(y)),C?.onClick((()=>{}));const x=new n.$({type:"focus",svgPathData:o.A.icon.trash.path,svgViewBox:o.A.icon.trash.viewBox,size:"small",width:"auto",text:"Remove"});x.render(y);const k=new n.$({type:"focus",svgPathData:o.A.icon.help.path,svgViewBox:o.A.icon.help.viewBox,size:"small",width:"auto",text:"Get help"});window.workspace_context?(window.workspace_support&&window.workspace_support.state&&!window.workspace_support.disable_support||window.workspace_support&&!window.workspace_support.state)&&k.render(y):k.render(y),s||(s="No crash_id available"),p.appendChild(y),u.appendChild(p);let E=this.messagesContainer,S=null;if(this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair)S=this.currentMessagePairWrapper;else if(a){const e=`.message-pair-wrapper[data-pair-id="${a}"]`;S=this.messagesContainer.querySelector(e)}else{const e=this.messagesContainer.querySelectorAll(".message-pair-wrapper");e.length>0&&(S=e[e.length-1])}if(S){const e=S.querySelector('[data-type="assistant"], .assistant-message-error-display');e?.remove(),E=S}E.appendChild(this.errorDiv),S&&"true"===S.dataset.hasMinHeight&&(S.classList.remove("min-h-[calc(100vh-12rem)]"),S.removeAttribute("data-hasMinHeight")),x.onClick((()=>{if(S&&S.contains(this.errorDiv))S.remove();else if(this.errorDiv&&this.errorDiv.parentNode&&this.errorDiv.remove(),a){const e=this.messagesContainer?.querySelector(`.message-pair-wrapper[data-pair-id="${a}"]`);e?.remove()}else S&&S.remove();this._chat_obj.restoreLastInput()})),b.onClick((async()=>{try{const t=await this._chat_obj.switchAIModel();if(t.changed){this.errorDiv&&this.errorDiv.parentNode&&this.errorDiv.remove();const s={run_id:a,model:t.model};g.G.postData(`/chat/${e}/reprocess/`,s),this.toggleAssistantThinking(!0,a)}}catch(e){}})),k.onClick((()=>{let e="Unknown OS";if(navigator.userAgentData&&navigator.userAgentData.platform)e=navigator.userAgentData.platform;else if(navigator.userAgent){const t=navigator.userAgent;-1!==t.indexOf("Win")?e="Windows":-1!==t.indexOf("Mac")?e="MacOS":-1!==t.indexOf("X11")?e="UNIX":-1!==t.indexOf("Linux")?e="Linux":-1!==t.indexOf("Android")?e="Android":-1!==t.indexOf("like Mac")&&(e="iOS")}const t=navigator.userAgent,n=window.location.href;let a=/Mobi|Android/i.test(navigator.userAgent)?"Mobile":"Desktop",o="Unknown Device";const r=navigator.userAgent;/iPhone/.test(r)?o="iPhone":/iPad/.test(r)?o="iPad":/Android/.test(r)?o="Android Device":/Windows Phone/.test(r)?o="Windows Phone":/Mac/.test(r)?o="Mac":/Windows/.test(r)&&(o="Windows PC");const l=window.screen.width,c=window.screen.height,d=window.innerWidth,h=window.innerHeight;new f(`[${i}] Help request`,`I encountered an error and would like some help. \n                    \n        Here are the details:\n        \n        <PLEASE ENTER ANYTHING THAT WILL HELP US HELP YOU HERE, THE MORE DETAIL THE BETTER>\n        \n        ${"string"==typeof s&&"No crash_id available"!==s?`**Crash ID:**\n${s}\n\n`:""}**OS:**\n        ${e}\n        \n        **Browser:**\n        ${t}\n        \n        **User Assistant (User Agent String):**\n        ${r}\n        \n        **Page URL:**\n        ${n}\n        \n        **Screen Resolution:**\n        ${l}x${c}\n        \n        **Viewport Size:**\n        ${d}x${h}\n        \n        **Device Type:**\n        ${a}\n        \n        **Device:**\n        ${o}\n        `)})),w.onClick((()=>{this.errorDiv&&this.errorDiv.parentNode&&this.errorDiv.remove();const t={run_id:a};g.G.postData(`/chat/${e}/reprocess/`,t),this.toggleAssistantThinking(!0,a)}))}createTruncateEffect(e){e.style.position="relative",e.style.overflow="hidden";const t=document.createElement("div");t.className="absolute bottom-0 left-0 w-full h-12 flex items-center justify-center z-10 pointer-events-none";const s=this.theme.backgroundHEX||"#ffffff";t.style.background=`linear-gradient(to bottom, transparent 0%, ${s} 70%, ${s} 100%)`;const i=document.createElement("button");i.className=`${this.theme.secondaryButtonTransparent} ${this.theme.text} py-1 px-2 rounded-md flex items-center justify-center text-sm pointer-events-auto absolute bottom-1`;const n=o.A.name("chevronDown"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-3 h-3"});let l=a.element?a.element.outerHTML:"";return i.innerHTML=`\n        <div class="flex gap-2 items-center justify-center align-middle text-xs"><div>${l}</div><div>Show more</div></div>`,t.appendChild(i),i.addEventListener("click",(s=>{s.stopPropagation(),e.style.maxHeight="none",e.style.overflow="visible",t.remove();const i=e.closest('[data-type="user"].truncated-user-msg');i?.classList.remove("truncated-user-msg")})),t}isUpdatingAssistantMessage(e,t){return!("assistant"!==e.type||!e.id)&&this.assistantMessages.has(e.id)}isUpdatingUserMessage(e,t){return!("user"!==e.type||!t)&&this.userMessages.has(t)}createReplyTo(e){this.replyContainer=document.createElement("div"),this.replyContainer.className=`flex gap-3 p-2 ${i.A.theme.skillContainerBG} rounded-lg w-full max-h-[100px] my-2`,this.replyIcon=document.createElement("div"),this.replyIcon.className="flex flex-col justify-start align-middle items-center py-1 px-1";const t=o.A.name("reply"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});return this.replyIcon.appendChild(s.element),this.replyContainer.appendChild(this.replyIcon),this.replyPreview=document.createElement("div"),this.replyPreview.className="flex flex-grow line-clamp-3 text-sm overflow-hidden leading-5 w-full my-0.5",this.replyPreview.innerText=e,this.replyContainer.appendChild(this.replyPreview),this.replyContainer}createParentReferenceBlock(e){if(!e||!e.uuid)return null;const t=`.parent-reference-block[data-parent-uuid="${e.uuid}"]`;if(this.messagesContainer&&this.messagesContainer.querySelector(t))return this.messagesContainer.querySelector(t);const s=document.createElement("div");s.className=`flex items-center gap-3 p-4 mt-4 mb-12 rounded-lg cursor-pointer ${this.theme.secondaryBackground} parent-reference-block opacity-70 sm:hover:opacity-100 transition-opacity duration-300`,s.setAttribute("role","link"),s.setAttribute("tabindex","0"),s.setAttribute("aria-label",`Go to parent session: ${e.name}`),s.dataset.parentUuid=e.uuid;const i=document.createElement("div");i.className="flex-shrink-0";const n=document.createElement("img");n.className="rounded-full w-8 h-8 flex flex-shrink-0",n.draggable=!1,n.src=e.assistant_image||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png",i.appendChild(n);const a=document.createElement("div");a.className="flex flex-col overflow-hidden";const o=document.createElement("span");o.className=`text-sm ${this.theme.fadedText} leading-5`,o.textContent="Continued from";const r=document.createElement("span");r.className=`text-sm font-medium ${this.theme.text} truncate leading-5`,r.textContent=e.name||"Parent Session",r.title=e.name||"Parent Session",a.appendChild(o),a.appendChild(r),s.appendChild(i),s.appendChild(a);const l=()=>{const t={name:e.name||"Parent Session",assistantImage:e.assistant_image||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png"};ke.openChatFromHistory(e.uuid,t)};return s.addEventListener("click",l),s.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),l())})),this.messagesContainer?(this.messagesContainer.firstChild?this.messagesContainer.insertBefore(s,this.messagesContainer.firstChild):this.messagesContainer.appendChild(s),s):null}addMessage(e,t,s){const i=`${e.id}-${t||0}`,n="user"===e.type?t:e.id;if(this.scrollViewAttachedBottom=!1,e.transcripts){window._transcripts||(window._transcripts={});for(const t of Object.keys(e.transcripts))window._transcripts[t]||(window._transcripts[t]=e.transcripts[t])}if("user"!==e.type||this.isUpdatingUserMessage(e,t)||this.isLoadingHistory||(this.currentMessagePairWrapper&&(this.currentMessagePairWrapper.classList.remove("min-h-[calc(100vh-12rem)]"),this.currentMessagePairWrapper.removeAttribute("data-is-active-pair")),this.currentMessagePairWrapper=null),"assistant"===e.type&&!this.processedAssistantMessages.has(n)){this.processedAssistantMessages.add(n);const e=this.messagesContainer.querySelector(".chat-spacer");e&&e.remove(),s||this.toggleAssistantThinking(!1)}if(this.isUpdatingAssistantMessage(e,t)||this.isUpdatingUserMessage(e,t)){let a=this.messagesContainer;if("assistant"===e.type&&this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair){const e=this.currentMessagePairWrapper.dataset.pairId;this.lastUserMessageElement&&this.lastUserMessageElement.dataset.id===e&&(a=this.currentMessagePairWrapper)}else if("user"===e.type){const e=this.messagesContainer.querySelector(`.message-pair-wrapper[data-pair-id="${n}"]`);e&&(a=e)}return void this.updateMessage(e,i,t,s,a)}this.hidePlaceholder(),"user"===e.type&&e.run_id?this.userMessages.add(e.run_id):"assistant"===e.type&&n&&this.assistantMessages.add(n),"user"!==e.type&&(window._vrunId=null);const a=this.addNewMessage(e,i,t,s);if("assistant"!==e.type||e.finished||this.isLoadingHistory?"assistant"===e.type&&"true"===a.dataset.hasMinHeight&&e.finished&&(a.classList.remove("min-h-[calc(100vh-12rem)]"),a.removeAttribute("data-hasMinHeight")):this.currentMessagePairWrapper&&this.currentMessagePairWrapper.contains(a)||a.classList.contains("message-pair-wrapper")||(a.classList.add("min-h-[calc(100vh-12rem)]"),a.dataset.hasMinHeight="true"),"assistant"===e.type){let n=this.messagesContainer;this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair&&this.currentMessagePairWrapper.contains(a)&&(n=this.currentMessagePairWrapper),this.updateMessage(e,i,t,s,n)}this.isLoadingHistory?requestAnimationFrame((()=>{this.updateNavigationButtonVisibility()})):requestAnimationFrame((()=>{if("user"===e.type&&this.currentMessagePairWrapper){const e=this.currentMessagePairWrapper.querySelector('[data-type="user"]');if(e){const t=e.getBoundingClientRect(),s=this.container.getBoundingClientRect(),i=16,n=this.container.scrollTop+(t.top-s.top)-i;this.container.scrollTo({top:Math.max(0,n),behavior:"auto"}),this.scrollViewAttachedBottom=!1}}else this.updateScrollPosition();this.updateNavigationButtonVisibility()}))}addNewMessage(e,t,s,i){const n=this.messagesContainer?.querySelectorAll(".streaming-cursor");n?.forEach((e=>e.remove()));const a=document.createElement("div");a.className="assistant"===e.type?"flex gap-3 pt-4 pb-1 w-full":"flex gap-3 pt-3 pb-2 justify-end relative",i&&a.classList.add("loading-message"),a.dataset.timestamp=e.timestamp,a.dataset.type=e.type,a.dataset.messageId=e.final_msg_id||e.msg_id;const o=e.id||s;a.dataset.id=o,e.skill&&(a.dataset.skill=e.skill);const r=document.createElement("div");let l=!1;if("assistant"===e.type){const t=this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair?this.currentMessagePairWrapper:this.messagesContainer,s=Array.from(t.children).filter((e=>e.dataset&&e.dataset.type)).pop();if(l="assistant"===s?.dataset.type,l){r.className="flex flex-col overflow-hidden px-0.5 w-full outer-message-container pb-0";const e=document.createElement("div");e.classList="flex-shrink-0 flex flex-col relative items-end";const t=document.createElement("div");if(t.className="w-8 h-8 flex flex-shrink-0",e.appendChild(t),a.appendChild(e),s){const e=s.querySelector(".attach-bottom .message-footer");e&&e.remove()}}else{r.className="flex flex-col overflow-hidden px-0.5 w-full outer-message-container pb-2";const t=document.createElement("div");t.classList="flex-shrink-0 flex flex-col relative items-end";const s=document.createElement("img");s.className="rounded-full w-8 h-8 flex flex-shrink-0",s.draggable=!1,s.src=e.responses[0].modelImage,t.appendChild(s),a.appendChild(t);const i=document.createElement("div");i.className="font-semibold",i.innerText=e.nickname||this._assistant.name,r.appendChild(i)}}else r.className="flex flex-col overflow-hidden outer-message-container gap-2 w-full max-w-[80%] items-end";const c=document.createElement("div");c.className="relative overflow-hidden attach-top",r.appendChild(c);const d=document.createElement("div");d.classList="user"===e.type?`markdown-style break-words inline-block whitespace-pre-wrap user-body-text relative ${this.theme.secondaryBackground} px-4 py-2.5 rounded-md max-w-full w-fit self-end`:"markdown-style break-words leading-7 w-full assistant-body-text agent-body-text",r.appendChild(d);const h=document.createElement("div");if(h.className="relative overflow-hidden attach-bottom",r.appendChild(h),a.appendChild(r),"user"===e.type){if(this.lastUserMessageElement=a,e.action_context){const t=this.createActionContextBlock(e.action_context);t instanceof Node&&c.appendChild(t)}else if(e.in_reply_to){const t=this.createReplyTo(e.in_reply_to);t instanceof Node&&c.appendChild(t)}if(e.temp_files_render){const t=document.createElement("div");t.className="inline-flex gap-2 w-full",e.temp_files_render instanceof Node&&(t.appendChild(e.temp_files_render),c.appendChild(t))}if(e.files&&e.files.length>0){const t=new Y(e.files,this._chat,!0);this.fileViewForRunId[s]=t;const i=t.render();if(i instanceof Node){const e=document.createElement("div");e.className="flex flex-col items-end justify-end gap-2 w-full",e.appendChild(i),c?.appendChild(e)}}if(d&&"user"===e.type)if(e.body){d.textContent=e.body;const t=800;if(e.body.length>t){d.style.maxHeight="200px";const e=this.createTruncateEffect(d);e instanceof Node&&(d.appendChild(e),a.classList.add("truncated-user-msg"))}}else d.style.display="none";const t=this.createUserMessageFooter(e,r);t instanceof Node&&h?.appendChild(t)}return this.isLoadingHistory||"user"!==e.type?this.isLoadingHistory||"assistant"!==e.type?(this.messagesContainer.appendChild(a),this.isLoadingHistory&&1===this.messagesContainer.children.length&&!this.messagesContainer.querySelector(".message-pair-wrapper")?requestAnimationFrame((()=>{this.scrollToBottom(),this.updateNavigationButtonVisibility()})):this.isLoadingHistory&&requestAnimationFrame((()=>this.updateNavigationButtonVisibility())),a):(this.currentMessagePairWrapper&&"true"===this.currentMessagePairWrapper.dataset.isActivePair?this.currentMessagePairWrapper.appendChild(a):this.messagesContainer.appendChild(a),a):(this.currentMessagePairWrapper=document.createElement("div"),this.currentMessagePairWrapper.className="message-pair-wrapper min-h-[calc(100vh-12rem)]",this.currentMessagePairWrapper.dataset.isActivePair="true",this.currentMessagePairWrapper.dataset.pairId=o,this.currentMessagePairWrapper.appendChild(a),this.messagesContainer.appendChild(this.currentMessagePairWrapper),this.currentMessagePairWrapper)}normalizeHtmlWhitespace(e){return e}updateMessage(e,t,s,i,n=null){let a=e.id;"user"===e.type&&(a=e.run_id);const o=n||this.messagesContainer,r=o.querySelector(`[data-id="${a}"]`);if(r){const n=r.querySelector(".attach-top"),a=r.querySelector(".assistant-body-text"),l=r.querySelector(".user-body-text"),c=r.querySelector(".attach-bottom");if("assistant"===e.type){if(e.tool_calls&&"object"==typeof e.tool_calls&&Object.keys(e.tool_calls).length>0&&setTimeout((()=>{const t=(e,t,s)=>{null!=s?e.setAttribute(t,s):"progress"===t&&null==s&&e.setAttribute(t,-1)},s=(s,i,n,a)=>{if(t(s,"uuid",i),t(s,"block-id",a.block_id),t(s,"chat-id",a.chat_id),e.tool_call_group_data&&e.tool_call_group_data[i]){const n=e.tool_call_group_data[i];n&&n.group_summary&&(t(s,"state",n.group_state),t(s,"group-summary-message",n.group_summary))}const o=n.map((e=>({toolUuid:e.id,mcpId:e.mcp_id||(e.mcp_name?e.mcp_name.toLowerCase().replace(/\s+/g,"-"):`unknown-mcp-${e.tool_call_id}`),mcpName:e.mcp_name||"Unnamed tool",mcpIconUrl:e.mcp_img_url||"",toolCalled:e.tool_call_name||"",connectionName:e.mcp_connection_name||"",state:e.state||"pending",progress:void 0!==e.progress&&null!==e.progress?e.progress:-1,currentMessage:"loading"===e.state&&(e.current_message||e.status_update)||"",successSummary:"complete"===e.state&&(e.success_summary||e.status_update)||"",errorMessage:"failed"===e.state&&(e.error_message||e.status_update)||"",timelineEvents:e.timeline_events||[],isExpanded:e.isExpanded||!1})));s.setAttribute("tool-group",JSON.stringify(o))};for(const[o,r]of Object.entries(e.tool_calls)){if(!Array.isArray(r)||0===r.length)continue;const l=o,c=window._messageToolCalls[l];if(c){if(1===r.length){const s=r[0];a=e,t(i=c,"uuid",(n=s).id),t(i,"mcp-name",n.mcp_name),t(i,"state",n.state),t(i,"mcp-icon-url",n.mcp_img_url),t(i,"connection-name",n.mcp_connection_name),t(i,"tool-called",n.tool_call_name||""),t(i,"block-id",a.block_id),t(i,"chat-id",a.chat_id),i.removeAttribute("tool-group"),i.removeAttribute("group-summary-message"),"loading"===n.state?(t(i,"current-message",n.current_message||n.status_update||`Working on ${n.mcp_name||"task"}...`),t(i,"progress",n.progress),t(i,"success-summary",""),t(i,"error-message","")):"complete"===n.state?(t(i,"success-summary",n.success_summary||n.status_update||`${n.mcp_name||"Task"} completed!`),t(i,"current-message",""),t(i,"progress",100),t(i,"error-message","")):"failed"===n.state?(t(i,"error-message",n.error_message||n.status_update||`Oh no, ${n.mcp_name||"task"} failed.`),t(i,"current-message",""),t(i,"success-summary",""),void 0!==n.progress&&t(i,"progress",n.progress)):(t(i,"current-message",n.status_update||(n.mcp_name?`${n.mcp_name} is ${n.state||"pending"}`:"Status pending...")),t(i,"success-summary",""),t(i,"error-message",""),t(i,"progress",-1))}else s(c,l,r,e);c.style.display="block"}}var i,n,a}),10),e.thought_stream&&n){let t=n.querySelector(".thought-stream-container");t||(t=document.createElement("div"),t.className="thought-stream-container",n.insertBefore(t,n.firstChild));let s=t.querySelector("think-component");s||(s=document.createElement("think-component"),s.setAttribute("elapsed-time",e.think_time||"0"),t.appendChild(s)),s.content=e.thought_stream,s.streaming=!e.finished,void 0!==e.think_time&&s.setAttribute("elapsed-time",e.think_time),e.finished&&"true"!==s.getAttribute("data-finished")&&(s.setAttribute("data-finished","true"),setTimeout((()=>{s.streaming=!1}),500))}if(e.thinking_steps&&n){let t=n.querySelector(".thinking-steps-container");t||(t=document.createElement("div"),t.className="thinking-steps-container",n.insertBefore(t,n.firstChild));const s=t.getAttribute("data-current-step-id"),i=e.thinking_steps[e.thinking_steps.length-1],a=i?.id,o=i&&i.finished;if(o&&t.setAttribute("data-finished","true"),a&&(s!==a.toString()||e.finished||o)){const s=this.createThinkingSteps(e.thinking_steps,e.id,e.finished);t.children.length>0?(t.style.opacity="0",setTimeout((()=>{t.innerHTML="",s&&s.firstChild&&t.appendChild(s.firstChild),t.style.opacity="1",t.setAttribute("data-current-step-id",a)}),300)):(s&&s.firstChild&&t.appendChild(s.firstChild),t.style.opacity="1",t.setAttribute("data-current-step-id",a))}}if(this.streamMsgIndex[t]||(this.streamMsgIndex[t]=""),e.sources&&(window._msgSources||(window._msgSources={}),window._msgSourcesOrder||(window._msgSourcesOrder=[]),window._msgSources[s]=e.sources,window._msgSourcesOrder.push(s)),e.finished&&(r.dataset.messageId=e.final_msg_id||e.msg_id),e.responses&&a){const n=e.responses[0].response;if(e.finished){const o=this.normalizeHtmlWhitespace(n),l=this._chat.id||this._chat.uuid||e.chat_id||"WTF";if(this.applyMarkdownStyles(a,o,!1,i,e.msg_id||e.id,l,s),c&&!c.querySelector(".message-footer")){this.streamingBlocks.clear();const t=e.responses.length;c.appendChild(this.createMessageFooter(e,r,t-1)),this.makeLinksOpenInNewWindow()}this.streamMsgIndex[t]=""}else this.streamMsgIndex[t]||(this.streamMsgIndex[t]=""),n.length>0&&(this.streamMsgIndex[t]+=n),this.applyMarkdownStyles(a,this.streamMsgIndex[t],!0,i,e.msg_id||e.id,e.chat_id,s),this.lastMessage=e.responses[0]}}if(this.fileViewForRunId[s])this.fileViewForRunId[s].updateFiles(e.files);else if(e.files&&e.files.length>0){let i=new Y(e.files,this._chat,"user"===e.type);this.fileViewForRunId[s]=i;const a="user"===e.type?n:c;if("user"===e.type&&n){const s=o.querySelectorAll(".skill-placeholder");s?.forEach((e=>{e.dataset.messageKey.split("-")[1]===t.split("-")[1]&&e.remove()})),"upload"!==e.skill&&a?.appendChild(i.render())}else c&&a?.appendChild(i.render())}if(a&&!e?.loading){a.querySelectorAll('[data-streaming="true"]').forEach((e=>{e.scrollToBottom&&e.scrollToBottom()}))}if(e.finished&&c&&!c.querySelector(".message-footer")){if(this.streamingBlocks.clear(),"assistant"===e.type){const t=e.responses.length;c.appendChild(this.createMessageFooter(e,r,t-1))}this.makeLinksOpenInNewWindow()}if("user"===e.type&&l){const t=800;let s="";for(const e of l.childNodes)e.nodeType===Node.TEXT_NODE&&(s+=e.nodeValue);s=s.trim();const i=(e.body||"").trim();if(e.body)if(l.style.display="",s!==i){const s=l.querySelector(".absolute.bottom-0.left-0.w-full.h-12");if(s&&s.remove(),l.textContent=e.body,l.style.maxHeight="",l.style.overflow="visible",r.classList.remove("truncated-user-msg"),e.body.length>t){l.style.maxHeight="200px",l.style.overflow="hidden";const e=this.createTruncateEffect(l);e instanceof Node&&(l.appendChild(e),r.classList.add("truncated-user-msg"))}}else{const s=e.body.length>t,i=r.classList.contains("truncated-user-msg"),n=l.querySelector(".absolute.bottom-0.left-0.w-full.h-12");if(!s||i&&n)s||!i&&!n||(n&&n.remove(),l.style.maxHeight="",l.style.overflow="visible",r.classList.remove("truncated-user-msg"));else{l.style.maxHeight="200px",l.style.overflow="hidden",n&&n.remove();const e=this.createTruncateEffect(l);e instanceof Node&&(l.appendChild(e),r.classList.add("truncated-user-msg"))}}else{l.textContent="",l.style.display="none";const e=l.querySelector(".absolute.bottom-0.left-0.w-full.h-12");e&&e.remove(),r.classList.remove("truncated-user-msg"),l.style.maxHeight="",l.style.overflow="visible"}}if("true"===r.dataset.hasMinHeight&&e.finished&&"assistant"===e.type){const e=this.container,t=Math.abs(e.scrollHeight-e.clientHeight-e.scrollTop)<5;let s=0;if(!t){s=r.getBoundingClientRect().top}if(r.classList.remove("min-h-[calc(100vh-12rem)]"),r.removeAttribute("data-hasMinHeight"),!t){const t=r.getBoundingClientRect();e.scrollTop+=t.top-s}}this.updateNavigationButtonVisibility()}}updateName(e){}showThinkingStepsModal(e){const t=document.createElement("div");t.className="flex flex-col gap-4 py-3",e.forEach(((e,s)=>{const i=document.createElement("div");i.className="thinking-step-detail";const n=document.createElement("div");n.className="font-semibold mb-2",n.textContent=`${e.thought}`;const a=document.createElement("div");a.textContent=e.summary,i.appendChild(n),i.appendChild(a),t.appendChild(i)})),new l({title:"Reasoning",body:t,size:"medium",closeX:!0,confirm:!1})}markThinkingAsInterrupted(){if(!this.messagesContainer||0===this.messagesContainer.children.length)return;const e=this.messagesContainer.lastElementChild;if(!e)return;const t=e.querySelector(".thinking-step .relative.inline-block");t&&(t.textContent="Thinking interrupted",t.classList.remove("loading-shimmer"))}createThinkingSteps(e,t,s){const i=document.createElement("div");if(i.className="thinking-steps-container",!e||0===e.length)return i;const n=s&&e.filter((e=>e.complete)).pop()||e[e.length-1],a=document.createElement("div");a.className="thinking-step flex items-center gap-2 text-base opacity-0 transition-opacity duration-300 py-1",a.setAttribute("data-step-id",n.id),setTimeout((()=>a.classList.add("opacity-100")),50);const o=document.createElement("a");o.href="#",o.className=`${this.theme.fadedText} hover:underline relative`;const r=document.createElement("span");r.className="relative inline-block";const l=n.thought+(n.complete||n.last_step?"":"...");if(n.complete||n.last_step)r.textContent=l;else{r.classList.add("loading-shimmer"),r.textContent=l,r.style.webkitTextFillColor="currentColor",r.style.color="currentColor";window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches||requestAnimationFrame((()=>{requestAnimationFrame((()=>{r.style.webkitTextFillColor="",r.style.color=""}))}))}return o.appendChild(r),o.addEventListener("click",(t=>{t.preventDefault(),this.showThinkingStepsModal(e)})),a.appendChild(o),i.appendChild(a),i}showThinkingStepsModal(e){const t=document.createElement("div");t.className="flex flex-col gap-4 py-3",e.forEach(((e,s)=>{const i=document.createElement("div");i.className="thinking-step-detail";const n=document.createElement("div");n.className="font-bold mb-2",n.textContent=`${e.thought}`;const a=document.createElement("div");a.textContent=e.summary,i.appendChild(n),i.appendChild(a),t.appendChild(i)})),new l({title:"Reasoning",body:t,size:"medium",closeX:!0,confirm:!1})}updateLastMessage(){const e=this.messagesContainer.querySelectorAll('[data-type="assistant"]');if(0===e.length)return;const t=e[e.length-1],s=t.dataset.id,i=t.querySelector(".assistant-body-text"),n=t.querySelector(".attach-bottom");if(i&&n){t.dataset.finished="true",this.removeLoadingMessage();const e=i?.querySelectorAll(".streaming-cursor");e.forEach((e=>e.remove())),n.innerHTML="";const a={id:s,type:"assistant",responses:[{response:i?.textContent,model:this.lastMessage.model,modelImage:this.lastMessage.modelImage}]};n.appendChild(this.createMessageFooter(a,t,0)),this.makeLinksOpenInNewWindow()}}docDelta(e){const t=window.docEditors[e.run_id];t&&(t.applyDelta(e.content),this.updateScrollPosition())}createUserMessageFooter(e,t){const s=document.createElement("div");s.className="flex gap-1 justify-end items-center align-middle w-full pb-2 pt-1 opacity-0 transition-opacity duration-200 ease-in-out message-footer z-20";const i=document.createElement("div");i.className="flex gap-1 items-center",s.appendChild(i);const a=new n.$({type:"focus",svgPathData:o.A.name("copy").path,svgViewBox:o.A.name("copy").viewBox,size:"small",width:"auto",text:"Copy",truncateMobile:!0});return a.render(i),a.onClick((()=>{this.handleCopy(e.body,!0)})),u.K.isMobile()?(s.classList.remove("opacity-0"),s.classList.add("opacity-100")):(t.addEventListener("mouseenter",(()=>{s.classList.remove("opacity-0"),s.classList.add("opacity-100")})),t.addEventListener("mouseleave",(()=>{s.classList.add("opacity-0"),s.classList.remove("opacity-100")}))),s}handleReadAloud(e,t){this.stopReadAloud(),this.isReading=!0;const s=this.cleanTextForSpeech(t);g.G.postData("/chat/text-to-speech/",{text:s,chat_id:e,voice:"af"}).then((e=>{if(this.isReading&&!e.success)throw new Error(e.error||"Failed to generate speech")})).catch((e=>{new c.y("Error generating speech","error",!0,!0,2e3),this.stopReadAloud()}))}handleWebSocketMessage(e){if("voice_audio_chunk"===e.type){if(!this.isReading)return;this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioQueue=[],this.isPlaying=!1,this.currentReadAloudButton&&"loading"===this.currentReadAloudButton.getData("state")&&(this.currentReadAloudButton.setSvgIcon(o.A.icon.powerOff.path,o.A.icon.powerOff.viewBox),this.currentReadAloudButton.text="Stop reading",this.currentReadAloudButton.enableButton(),this.currentReadAloudButton.setData("state","playing")));const t=atob(e.data),s=new ArrayBuffer(t.length),i=new Uint8Array(s);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);this.audioQueue.push(s),this.isPlaying||this.playNextAudioChunk()}else"voice_audio_end"===e.type?this.audioQueue&&0===this.audioQueue.length&&!this.isPlaying&&this.stopReadAloud():"voice_audio_error"===e.type&&(new c.y("Error playing audio","error",!0,!0,2e3),this.stopReadAloud())}handleWebSocketMessage(e){if("voice_audio_chunk"===e.type){if(!this.isReading)return;this.audioContext||(this.audioContext=new(window.AudioContext||window.webkitAudioContext),this.audioQueue=[],this.isPlaying=!1);const t=atob(e.data),s=new ArrayBuffer(t.length),i=new Uint8Array(s);for(let e=0;e<t.length;e++)i[e]=t.charCodeAt(e);this.audioQueue.push(s),this.isPlaying||this.playNextAudioChunk()}else"voice_audio_end"===e.type?this.audioQueue&&0===this.audioQueue.length&&!this.isPlaying&&this.stopReadAloud():"voice_audio_error"===e.type&&(new c.y("Error playing audio","error",!0,!0,2e3),this.stopReadAloud())}playNextAudioChunk(){if(!this.isReading||!this.audioQueue||0===this.audioQueue.length)return this.isPlaying=!1,this.currentAudioSource=null,void(!this.isReading||this.audioQueue&&0!==this.audioQueue.length||this.stopReadAloud());this.isPlaying=!0;const e=this.audioQueue.shift();if(!this.audioContext||"closed"===this.audioContext.state)return this.isPlaying=!1,void this.stopReadAloud();this.audioContext.decodeAudioData(e).then((e=>{if(!this.isReading)return this.isPlaying=!1,void(this.currentAudioSource=null);const t=this.audioContext.createBufferSource();t.buffer=e,t.connect(this.audioContext.destination),this.currentAudioSource=t,t.start(0),t.onended=()=>{this.currentAudioSource===t&&(this.currentAudioSource=null),this.isReading?this.playNextAudioChunk():this.isPlaying=!1}})).catch((e=>{this.currentAudioSource=null,this.isPlaying=!1,this.playNextAudioChunk()}))}stopReadAloud(){this.isReading;if(this.isReading=!1,this.audioQueue&&(this.audioQueue=[]),this.currentAudioSource){try{this.currentAudioSource.stop()}catch(e){}this.currentAudioSource=null}this.isPlaying=!1,this.currentReadAloudButton&&(this.currentReadAloudButton.setSvgIcon(o.A.icon.play.path,o.A.icon.play.viewBox),this.currentReadAloudButton.text="Read",this.currentReadAloudButton.enableButton(),this.currentReadAloudButton.setData("state","idle"),this.currentReadAloudButton=null)}cleanTextForSpeech(e){if(!e)return"";return e.replace(/```[\s\S]*?```/g,"").replace(/`([^`]+)`/g,"$1").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/#+ (.+)/g,"$1").replace(/\n\s*[-*+] /g,"\n").replace(/\n\s*\d+\. /g,"\n").replace(/\!\[.*?\]\(.*?\)/g,"").replace(/\n{3,}/g,"\n\n").trim()}createMessageFooter(e,t,s=0,r=!1){let l=!1;["grokimage","imagen4","photomaker","stable_diffusion_xl","stability_ai","gptimg","dalle3","ideogram","ideogramimg2img","fluxultra","flux","fluximg2img","computer"].includes(e.skill)&&(l=!0);const d=document.createElement("div");d.className="flex flex-wrap gap-1 items-center align-middle w-full pb-2 pt-1 opacity-0 transition-opacity duration-200 ease-in-out message-footer";const h=document.createElement("div");h.className="flex gap-1 items-center",d?.appendChild(h);const m=new n.$({type:"focus",svgPathData:o.A.name("copy").path,svgViewBox:o.A.name("copy").viewBox,size:"small",width:"auto",text:"Copy",truncateMobile:!0});!l&&m.render(h);let p=s,f=e.responses.length;m.onClick((()=>{const s=t.querySelectorAll("markdown-content");if(s&&s.length>0)if(1===s.length)this.handleCopy(s[0].innerHTML);else{let e="";s.forEach((t=>{e+=t.innerHTML})),this.handleCopy(e)}else this.handleCopy(e.responses[p].response)}));const v=new n.$({type:"focus",svgPathData:o.A.name("reply").path,svgViewBox:o.A.name("reply").viewBox,size:"small",width:"auto",text:"Reply",truncateMobile:!0});!l&&v.render(h),v.onClick((()=>{const e=t.dataset.messageId;e?this.handleReplyToSession(e):new c.y("Error: No assistant message ID found.","error")}));const y=new n.$({type:"focus",svgPathData:o.A.name("circleDown").path,svgViewBox:o.A.name("circleDown").viewBox,size:"small",width:"auto",text:"Export",truncateMobile:!0});!l&&y.render(h),y.onClick((()=>{this.exportMenu(e)}));let w=null;if(r||(w=new n.$({type:"focus",svgPathData:o.A.name("trash").path,svgViewBox:o.A.name("trash").viewBox,text:"Remove",size:"small",width:"auto",truncateMobile:!0}),w.render(h)),w&&w.onClick((()=>{new a("Are you sure?","The assistant and user message will be removed and are not recoverable.").onConfirm((()=>{let s=t.dataset.id;"assistant"===e.type&&e.msg_id&&(s=e.msg_id);let i=null,n=!1;const a=t.closest(".message-pair-wrapper");if(a)i=a.dataset.pairId,n=a.parentNode&&a.parentNode.lastChild===a,a.remove();else{let e=t.previousElementSibling;for(;e&&"user"!==e.dataset.type;)e=e.previousElementSibling;if(n=t.parentNode&&t.parentNode.lastChild===t,t.parentNode&&t.remove(),e&&"user"===e.dataset.type){i=e.dataset.id;let t=e.previousElementSibling;for(;t&&(t.classList.contains("model-switch")||t.classList.contains("assistant-switch"));){const e=t;t=t.previousElementSibling,e.remove()}e.remove()}}g.G.postData(`/chat/${this._chat_obj.chat_id}/deletemsg/`,{assistant_message_id:s,user_message_id:i}),n&&this._chat_obj.restoreLastInput(),setTimeout((()=>{this.updateScrollPosition(),this.togglePlaceholder(),this._chat_obj.focusInChatInput()}),100)}))})),f>1){const t=document.createElement("div");t.className=`flex gap-1 items-center align-middle text-xs rounded-md ${i.A.theme.focusButton} opacity-80 hover:opacity-100 text-xs ${i.A.theme.text} p-1 cursor-pointer`;const s=document.createElement("div"),a=document.createElement("div"),o=document.createElement("div");a.className="max-w-[20px] truncate";const r=new n.$({type:"focus",icon:"fa-solid fa-chevron-left",iconHeightAndWidth:"w-4",size:"icon",width:"auto"});r.render(s),a.innerText=e.responses[p].model;const l=new n.$({type:"focus",icon:"fa-solid fa-chevron-right",size:"icon",iconHeightAndWidth:"w-4",width:"auto"});l.render(o),t.appendChild(s),t.appendChild(a),t.appendChild(o),d.appendChild(t);const c=()=>{0===p?r.hideButton():r.showButton(),p===f-1?l.hideButton():l.showButton()},h=()=>{a.innerText=e.responses[p].model,this.addResponse(e.id,e.responses[p],e.responses,e),f=e.responses.length,c()};c(),r.onClick((()=>{p>0&&(p--,h())})),l.onClick((()=>{p<f-1&&(p++,h())}))}else if(!l){const t=document.createElement("div");t.className=`inline-flex items-center text-xs rounded-md max-w-[150px] truncate ${i.A.theme.focusButton} ${i.A.theme.text} py-1 cursor-default px-2 select-none opacity-80`;const s=document.createElement("span");s.className="truncate",s.innerText=e.responses[p].model,t.appendChild(s),d.appendChild(t)}return u.K.isMobile()?(d.classList.remove("opacity-0"),d.classList.add("opacity-100")):(t.addEventListener("mouseenter",(e=>{d.classList.remove("opacity-0"),d.classList.add("opacity-100")})),t.addEventListener("mouseleave",(e=>{d.classList.add("opacity-0"),d.classList.remove("opacity-100")}))),d}async getModelResponseButton(e,t){try{const s=await this._chat_obj.generateNewModelReply(e.id);e.responses.push(s),this.updateMessageResponses(e,t),new c.y("New response generated successfully","success")}catch(e){}}handleReplyToSession(e){const t=this._chat_obj.getConversationName(),s=this._chat_obj.chat_id;this._chat_obj&&"function"==typeof this._chat_obj.showSessionReplyUI?this._chat_obj.showSessionReplyUI(t,s,e):new c.y("Cannot initiate session reply.","error")}addResponse(e,t,s){const i=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(!i)return;const n=i.querySelector(".assistant-body-text"),a=i.querySelector(".attach-bottom");if(n.innerHTML="",a.innerHTML="",this.streamingBlocks.clear(),this.streamMsgIndex[`${e}-${t.runId||0}`]="",t.files&&t.files.length>0){const s=`${e}-${t.runId}`;if(this.fileViewForRunId[s])this.fileViewForRunId[s].updateFiles(t.files);else{const e=new Y(t.files,this._chat);this.fileViewForRunId[s]=e,a.appendChild(e.render())}}const o={id:e,type:"assistant",responses:s},r=i.querySelector(".message-footer");r&&r.remove();const l=s.findIndex((e=>e===t));a.appendChild(this.createMessageFooter(o,i,l)),this.makeLinksOpenInNewWindow(),requestAnimationFrame((()=>{this.updateScrollPosition()}))}removeLoadingMessage(){this.toggleAssistantThinking(!1);const e=this.messagesContainer.querySelector(".loading-message");e&&e.remove()}applyMarkdownStyles(e,t,s=!1,i=!1,n=null,a=null,o=null){this._markdownContentCache||(this._markdownContentCache=new Map);let r=this._markdownContentCache.get(n);r||(r=e?.querySelector(`markdown-content[message-id="${n}"]`),r||(r=document.createElement("markdown-content"),r.setAttribute("message-id",n),r.setAttribute("chat-id",a),o&&r.setAttribute("run-id",o),e?.appendChild(r),this._markdownContentCache.set(n,r))),o&&r.getAttribute("run-id")!==o&&r.setAttribute("run-id",o),!s&&r.hasAttribute("data-content-set")&&""===t.trim()||(r.content=t,r.setAttribute("data-content-set","true")),r.streaming=s}addStreamingCursor(e){const t=e.querySelectorAll("#streaming-cursor");t?.forEach((e=>e.remove()));const s=document.createElement("span");s.id="streaming-cursor",s.className="streaming-cursor",s.innerHTML='<i class="fa-solid fa-rectangle-vertical fa-beat-fade h-4"></i>',e.appendChild(s)}handleStreamingAttributes(e,t){[e.querySelectorAll("code-block"),e.querySelectorAll("document-editor")].forEach((e=>{e?.forEach((e=>{e.setAttribute("data-streaming",t.toString())}))}))}codeLoad(){const e=this.messagesContainer?.querySelectorAll("code-block");e?.forEach((e=>{e.setAttribute("code-load","true")}))}makeLinksOpenInNewWindow(){const e=this.messagesContainer?.querySelectorAll(".markdown-style a");e?.forEach((function(e){e.setAttribute("target","_blank"),e.setAttribute("rel","noopener noreferrer")}))}escapeHTML(e){return e.replace(/(<pre[^>]*>[\s\S]*?<\/pre>)|(<code[^>]*>[\s\S]*?<\/code>)|([^<]+)|(<[^>]+>)/g,((e,t,s,i,n)=>t||s||n?e:i?i.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"}[e]))):""))}hidePlaceholder(){const e=this.messagesContainer.querySelector(".chat-message-placeholder"),t=document.getElementById("nav-buttons");t&&(t.classList.remove("opacity-0"),t.classList.add("opacity-50")),e&&(this.messagesContainer.contains(e)&&this.messagesContainer.removeChild(e),this.placeholderShowing=!1)}togglePlaceholder(){if(this._chat_obj&&this._chat_obj.isInitializingFork)return void this.hidePlaceholder();if(!this.messagesContainer)return;if(!this.messagesContainer.isConnected)return void requestAnimationFrame((()=>{this.messagesContainer.isConnected&&this.togglePlaceholder()}));const e=this.container,t=(e&&e.scrollTop,this.messagesContainer.children.length),s=t>0?this.messagesContainer.children[0]:null;let i;i=0===t||1===t&&(s.classList.contains("model-switch")||s.classList.contains("assistant-switch")||s.classList.contains("chat-message-placeholder"));const n=document.getElementById("nav-buttons"),a=this.messagesContainer.querySelector(".chat-message-placeholder");if(a&&i){n&&(n.classList.remove("opacity-50"),n.classList.add("opacity-0")),this.placeholderShowing=!0;const e=a.querySelector("img"),t=this._assistant?.image||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png";return this._assistant?.name?e.alt=`Assistant avatar for ${this._assistant?.name}`:e.alt="Assistant avatar",e&&e.src!==t&&(e.src=t),void(("hidden"===a.style.visibility||a.classList.contains("opacity-0"))&&(a.style.visibility="visible",a.classList.remove("opacity-0"),a.classList.add("opacity-100")))}if(i){this.placeholderShowing=!0,n&&(n.classList.remove("opacity-50"),n.classList.add("opacity-0")),a&&this.messagesContainer.removeChild(a);const e=document.createElement("div");e.className="chat-message-placeholder flex flex-col items-center justify-center w-full opacity-0 transition-opacity duration-200",e.style.minHeight="300px",e.style.position="absolute",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%, -50%)",e.style.visibility="hidden";const t=document.createElement("img");t.classList=`w-28 h-28 sm:w-28 sm:h-28 rounded-full ${this.theme.inputRing} drop-shadow-md`,t.draggable=!1;const s=this._assistant?.image?this._assistant.image:"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png";t.src=s,this._assistant?.name?t.alt=`Assistant avatar for ${this._assistant?.name}`:t.alt="Assistant avatar",e.appendChild(t);const i=this.createSuggestionTiles();e.appendChild(i),this.messagesContainer.appendChild(e),"static"===window.getComputedStyle(this.messagesContainer).position&&(this.messagesContainer.style.position="relative"),requestAnimationFrame((()=>{e.parentNode===this.messagesContainer&&(e.style.visibility="visible",e.classList.remove("opacity-0"),e.classList.add("opacity-100"))}))}else a&&(a.classList.remove("opacity-100"),a.classList.add("opacity-0"),setTimeout((()=>{a&&a.parentNode===this.messagesContainer&&this.messagesContainer.removeChild(a)}),200)),this.placeholderShowing=!1,n&&(n.classList.remove("opacity-0"),n.classList.add("opacity-50"))}createSuggestionTiles(){const e=document.createElement("div");e.className="flex flex-wrap gap-2 justify-center items-center align-middle w-full mt-4 sm:mt-8 max-w-2xl";let t=[];return t=(y.a.workspaceContext,[{icon:"search",text:"Search",action:"search"},{icon:"upload",text:"Upload files",action:"upload"},{icon:"code",text:"Vibe code",action:"code"},{icon:"image",text:"Create an image",action:"image"}]),t.forEach((t=>{const s=document.createElement("div");s.className=`flex gap-2 items-center justify-center align-middle cursor-pointer ${this.theme.secondaryButtonTransparent} rounded-lg px-3 py-1.5 text-sm sm:text-sm`;const i=o.A.name(t.icon),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4",colorClass:t.color||"",additionalClasses:""}),a=document.createElement("div");a.textContent=t.text,s.appendChild(n.element),s.appendChild(a),s.addEventListener("click",(()=>{this.onSuggestionTileClick(t.action)})),e.appendChild(s)})),e}onSuggestionTileClick(e){if("mcp_store"===e){const e=this._chat_obj.chatInput;return void(e&&"function"==typeof e.onMCPControlCallback&&e.onMCPControlCallback(e.mcpControlButton))}if("search"===e){const e=this._chat_obj.chatInput;return void(e&&e.inputTextArea&&(e.inputTextArea.value="Search for ",e.focus(),e.toggleSendButton(),e.adjustTextarea()))}if("image"===e){const e=this._chat_obj.chatInput;return void(e&&e.inputTextArea&&(e.inputTextArea.value="Create an image of ",e.focus(),e.toggleSendButton(),e.adjustTextarea()))}if("skills"===e)return void this._chat_obj.chatInput.toggleSkillsMenu();if("upload"===e)return void this._chat_obj.chatInput.triggerUploadSelectFile();const t=u.K.skills_menu.find((t=>t.value===e));t?this._chat_obj.openSkill(t):new c.y("Sorry, that skill is not available right now.","error")}set assistant(e){this._assistant=e,this.onChangeAssistant(e)}createDragOverMessage(){this.dragOverMessage=document.createElement("div"),this.dragOverMessage.className=`hidden absolute inset-0 flex flex-col items-center justify-center ${this.theme.overlayFadeBackground} text-white z-50`,this.dragOverMessage.innerHTML='\n        <div class="space-y-2 flex flex-col justify-center items-center align-middle">\n            <div class="drag-over-icon-container"></div>\n            <div class="text-2xl font-medium">Add any files</div>\n            <div class="text-base font-normal">Drag and drop files here.</div>\n        </div>\n        ',this.outerContainer.appendChild(this.dragOverMessage);const e=this.dragOverMessage.querySelector(".drag-over-icon-container");if(e){const t=o.A.name("upload"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-32 h-32",colorClass:this.theme.iconColor});e.appendChild(s.element)}}enableDragAndDropFileUpload(){this.dragListenersEnabled||(this.dragCounter=0,this.outerContainer.addEventListener("dragover",this.handleDragOverBound),this.outerContainer.addEventListener("dragenter",this.handleDragEnterBound),this.outerContainer.addEventListener("dragleave",this.handleDragLeaveBound),this.outerContainer.addEventListener("drop",this.handleDropBound),this.dragListenersEnabled=!0)}disableDragAndDropFileUpload(){this.outerContainer.removeEventListener("dragover",this.handleDragOverBound),this.outerContainer.removeEventListener("dragenter",this.handleDragEnterBound),this.outerContainer.removeEventListener("dragleave",this.handleDragLeaveBound),this.outerContainer.removeEventListener("drop",this.handleDropBound),this.dragListenersEnabled=!1}handleDragOver(e){this.isInternalImage(e)||this.checkIfTicketFormShowing()||e.dataTransfer.types.includes("application/x-moz-file-promise-url")||document.body.classList.contains("tab-dragging")||(e.preventDefault(),e.stopPropagation())}handleDragEnter(e){this.isInternalImage(e)||this.checkIfTicketFormShowing()||e.dataTransfer.types.includes("application/x-moz-file-promise-url")||document.body.classList.contains("tab-dragging")||(e.preventDefault(),e.stopPropagation(),this.dragCounter++,1===this.dragCounter&&this.toggleDragOverDialogue(!0))}handleDragLeave(e){this.isInternalImage(e)||this.checkIfTicketFormShowing()||e.dataTransfer.types.includes("application/x-moz-file-promise-url")||document.body.classList.contains("tab-dragging")||(e.preventDefault(),e.stopPropagation(),this.dragCounter--,0===this.dragCounter&&this.toggleDragOverDialogue(!1))}handleDrop(e){if(this.isInternalImage(e)||this.checkIfTicketFormShowing()||e.dataTransfer.types.includes("application/x-moz-file-promise-url")||document.body.classList.contains("tab-dragging"))return;e.preventDefault(),e.stopPropagation(),this.dragCounter=0,this.toggleDragOverDialogue(!1);const t=e.dataTransfer.files;t.length>0&&this.onFilesDropCallback&&this.onFilesDropCallback(t),this.initialScrollLag=!0,this.updateScrollPosition()}toggleDragOverDialogue(e){e?this.dragOverMessage.classList.remove("hidden"):this.dragOverMessage.classList.add("hidden")}isInternalImage(e){return e.target.closest(".ql-editor")||document.body.classList.contains("dragging-internal-image")}checkIfTicketFormShowing(){return!!document.getElementById("ticket-form")}onFilesDrop(e){"function"==typeof e&&(this.onFilesDropCallback=e)}static adjustScrollPosition(){}static setSkillMode(e){const t=document.getElementById("chat-container");t&&t.setAttribute("data-skill-mode",e)}static getCurrentSkillMode(){const e=document.getElementById("chat-container");return e?e.getAttribute("data-skill-mode"):null}static focusModeListeners=[];static tellMeAboutFocus(e){F.focusModeListeners.push(e)}focusMode(e,t){const s=F.focusModeListeners,i=this.outerContainer;if(e){i.classList.add("lg:flex"),i.classList.add("in-focus-mode"),i.classList.add("lg:block","hidden","lg:flex");for(let e=0;e<s.length;e++)s[e](!0,t)}else{i.style.opacity="0";for(let e=0;e<s.length;e++)s[e](!1);setTimeout((()=>{i.classList.remove("lg:flex"),i.classList.remove("in-focus-mode"),i.classList.remove("lg:block","hidden"),i.style.opacity="1"}),300)}}updateCode(e,t,s){const i=document.querySelector(`code-block[mode="focus"][block-id="${t}"]`);if(i)i.code=e;else{const s=this.messagesContainer?.querySelectorAll(`code-block[block-id="${t}"]`);s&&s.length>0&&s.forEach((t=>{t.code=e}))}}static isFocused(){return document.querySelector(".in-focus-mode")}createFloatingMenu(){this.floatingMenu=document.createElement("div"),this.floatingMenu.className=`hidden absolute ${this.theme.background} shadow-md rounded-md p-2 z-30 flex gap-2`;const e=o.A.name("reply");if(this.replyToButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",iconHeightAndWidth:"h-6 w-6",svgPathData:e.path,svgViewBox:e.viewBox,hoverText:"Reply to"}),u.K.hasPermission("feature:memory")){const e=o.A.name("brain");this.rememberButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",iconHeightAndWidth:"h-6 w-6",svgPathData:e.path,svgViewBox:e.viewBox,hoverText:"Save to memory"})}const t=o.A.name("search");this.researchButton=new n.$({text:"",type:"secondaryTransparent",size:"small",iconHeightAndWidth:"h-6 w-6",svgPathData:t.path,svgViewBox:t.viewBox,hoverText:"Search"});const s=o.A.name("copy");this.copyButton=new n.$({text:"",type:"secondaryTransparent",size:"small",iconHeightAndWidth:"h-6 w-6",svgPathData:s.path,svgViewBox:s.viewBox,hoverText:"Copy"}),u.K.hasPermission("feature:memory")&&this.rememberButton.render(this.floatingMenu),this.replyToButton.render(this.floatingMenu),this.copyButton.render(this.floatingMenu),this.copyButton.onClick(this.handleCopy.bind(this)),this.replyToButton.onClick(this.handleReply.bind(this)),u.K.hasPermission("feature:memory")&&this.rememberButton.onClick(this.handleMemorySave.bind(this)),document.body.appendChild(this.floatingMenu)}addSelectionListeners(){this.messagesContainer.addEventListener("mouseup",this.handleTextSelection.bind(this)),this.messagesContainer.addEventListener("touchend",this.handleTextSelection.bind(this)),document.addEventListener("mousedown",this.hideFloatingMenu.bind(this)),document.addEventListener("touchstart",this.hideFloatingMenu.bind(this))}handleTextSelection(e){this.selectionTimeout&&clearTimeout(this.selectionTimeout),this.selectionTimeout=setTimeout((()=>{const e=window.getSelection(),t=e.toString().trim();if(t){const s=document.activeElement;if("INPUT"===s.tagName||"TEXTAREA"===s.tagName||s.classList.contains("prose-no-menu"))return;this.selectedText=t;const i=e.getRangeAt(0).getBoundingClientRect();this.showFloatingMenu(i)}else this.hideFloatingMenu()}),300)}showFloatingMenu(e){const{left:t,top:s,bottom:i}=e;this.floatingMenu.classList.remove("hidden");const n=this.floatingMenu.offsetHeight,a=this.floatingMenu.offsetWidth;this.floatingMenu.classList.add("hidden");const o=window.innerHeight,r=window.innerWidth,l=window.scrollY,c=window.scrollX,d=o-(i-l),h=r-(t-c),m=t-c;let u,p;u=d>=n||d>s-l?Math.min(i,o+l-n-10):Math.max(s-n,l+10),p=h>=a?t:m>=a?t-a:Math.max(c+10,Math.min(t-a/2,r+c-a-10)),p=Math.max(c+10,Math.min(p,r+c-a-10)),u=Math.max(l+10,Math.min(u,o+l-n-10)),this.floatingMenu.style.top=`${u}px`,this.floatingMenu.style.left=`${p}px`,this.floatingMenu.style.right="auto",this.floatingMenu.style.bottom="auto",this.floatingMenu.classList.remove("hidden")}hideFloatingMenu(e){e&&this.floatingMenu.contains(e.target)||this.floatingMenu.classList.add("hidden")}handleReply(){"function"==typeof this.onReplyToCallback&&this.onReplyToCallback(this.selectedText),this.hideFloatingMenu()}onReplyTo(e){"function"==typeof e&&(this.onReplyToCallback=e)}handleResearch(){this.hideFloatingMenu();const e={id:Math.floor(1e6*Math.random()),type:"user",nickname:this.user.call_me_name,timestamp:(new Date).toISOString(),body:this.selectedText,skill:"search",skill_params:{}};e.run_id=Math.random().toString(36).substring(7),this.addMessage(e,e.run_id),this.toggleAssistantThinking(!0),this._chat_obj.chatInput.adjustHeight(),this.updateScrollPosition(),e.is_screen_sharing=!1,g.G.postData(`/chat/${this._chat.id}/message/`,e)}handleMemorySave(){if(this.hideFloatingMenu(),this.selectedText.length<20)return void new c.y("Please select at least 20 characters to save to knowledge graph.","info",!0,!0,2e3);const e={item:this.selectedText};g.G.postData(`/chat/assistants/${this._assistant.id}/knowledge-graph/add/`,e).then((e=>{new c.y("Saved to memory","success",!0,!0,2e3)})).catch((e=>{new c.y("Error saving to memory","error",!0,!0,2e3)}))}saveSnippet(){new c.y("This feature will be available soon.","info",!0,!0,2e3);this.hideFloatingMenu()}sanitizeClipboardDom(e){return e.querySelectorAll('[data-spacer="true"], .spacer, .streaming-cursor, .line-number').forEach((e=>e.remove())),e.querySelectorAll("*").forEach((e=>{e.removeAttribute("block-id"),e.removeAttribute("data-streaming")})),e.querySelectorAll("code-tag").forEach((e=>{const t=e.getAttribute("code"),s=e.getAttribute("language")||"";let i="";if(t)try{i=decodeURIComponent(atob(t))}catch{i=e.textContent||""}else{const t=e.querySelector("code");i=t?.textContent||e.textContent||""}const n=document.createElement("code");s&&"plaintext"!==s.toLowerCase()&&n.classList.add(`language-${s}`),n.textContent=i,e.replaceWith(n)})),e.querySelectorAll("code-block").forEach((e=>{const t=e.getAttribute("language")||"",s=e.textContent||"",i=document.createElement("pre"),n=document.createElement("code");t&&"plaintext"!==t.toLowerCase()&&n.classList.add(`language-${t}`),n.textContent=s,i.appendChild(n),e.replaceWith(i)})),e}handleCopy(e=!1,t=!1){let s,i;const n=e=>e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");if(t)s=e;else if(e){if("string"!=typeof e)return;const t=document.createElement("div");t.innerHTML=e,this.sanitizeClipboardDom(t),i=t.innerHTML,s=t.innerText.replace(/\u00A0/g," ").replace(/\n{3,}/g,"\n\n").trimEnd()}else{const e=window.getSelection();if(!e||0===e.rangeCount)return;const a=e.getRangeAt(0);let o=a.commonAncestorContainer;o.nodeType===Node.TEXT_NODE&&(o=o.parentElement);if(o?o.closest('[data-type="user"]'):null)s=e.toString(),t=!0;else{let t=null;if(o.nodeType===Node.TEXT_NODE?t=o.parentElement?.closest("pre, code, .hljs, code-block, code-tag"):o.nodeType===Node.ELEMENT_NODE&&(t=o.closest("pre, code, .hljs, code-block, code-tag")),t){const a=e.toString();if(a)s=a,i=`<pre><code>${n(a)}</code></pre>`;else{const e=t.textContent||"",a=t.getAttribute?.("language")||"";s=e,i=`<pre><code${a&&"plaintext"!==a?` class="language-${a}"`:""}>${n(e)}</code></pre>`}}else{const e=document.createElement("div");e.appendChild(a.cloneContents()),this.sanitizeClipboardDom(e),i=e.innerHTML,s=e.innerText.replace(/\u00A0/g," ").replace(/\n{3,}/g,"\n\n").trimEnd()}}}try{let e;e=t?new ClipboardItem({"text/plain":new Blob([s],{type:"text/plain"})}):new ClipboardItem({"text/plain":new Blob([s],{type:"text/plain"}),"text/html":new Blob([i],{type:"text/html"})}),navigator.clipboard.write([e]).then((()=>new c.y("Copied to clipboard","success",!0,!0,2e3))).catch((()=>this.fallbackCopy(s,i)))}catch{this.fallbackCopy(s,i)}this.hideFloatingMenu&&this.hideFloatingMenu()}fallbackCopy(e,t){const s=i=>{i.preventDefault(),i.clipboardData.setData("text/plain",e),i.clipboardData.setData("text/html",t),document.removeEventListener("copy",s)};document.addEventListener("copy",s),document.execCommand("copy"),new c.y("Copied to clipboard","success",!0,!0,2e3)}addThoughtStream(e){const t=this.messagesContainer.querySelector(`[data-id="${e}"]`);if(!t)return null;const s=t.querySelector(".attach-top");if(!s)return null;let i=s.querySelector(".thought-stream-container");i||(i=document.createElement("div"),i.className="thought-stream-container my-2",s.insertBefore(i,s.firstChild));const n=document.createElement("div");if(n.className=`${this.theme.secondaryBackground} rounded-md py-3 px-3 text-base w-full min-h-[60px]`,i.appendChild(n),n.innerHTML=`\n        <div>\n            <div class="flex justify-between gap-2">\n                <div class="flex gap-1 justify-center items-center thinking-container">\n                    <div class="thinking-dots-container flex items-center justify-center">\n                        <div class="thinking-dot thinking-dot-1"></div>\n                        <div class="thinking-dot thinking-dot-2"></div>\n                        <div class="thinking-dot thinking-dot-3"></div>\n                    </div>\n                    <div class="thinking-text">Thinking</div> \n                    <div class="text-sm text-gray-400">9s</div>\n                </div>\n                <div><button class="h-7 w-7 rounded-md p-0.5 ${this.theme.menuIconHoverColor}"><i class="fa-solid fa-chevron-down"></i></button></div>\n            </div>\n            <div class="thought-content-container">\n                <div class="thought-content max-h-[120px] overflow-hidden px-1 py-2 fade-mask">Black Holes: The Universe's Ultimate Enigmas\n    Black holes are more than just cosmic vacuum cleanersthey're the universe's way of testing the limits of our knowledge. These gravitational behemoths bend space, warp time, and challenge everything we think we know about physics. Let's explore the mind-bending aspects of black holes, the questions they raise, and why they might hold the key to unlocking the universe's deepest secrets.\n    The Anatomy of a Black Hole\n    To understand why black holes are so perplexing, let's break down their key components:\n    Event Horizon: The boundary beyond which nothing can escape. It's not a physical surface but a point of no return. Once you cross it, you're committed to the black hole's embrace.\n    Singularity: The core of the black hole, where gravity is infinitely strong, and spacetime curvature becomes infinite. It's a point where our current laws of physics break down.\n    Accretion Disk: Not all black holes have one, but when they do, it's a swirl of gas and dust spiraling into the black hole, heating up and emitting radiation before it disappears forever.\n    These elements make black holes both fascinating and frustratingfascinating because they're so extreme, frustrating because they hide their secrets so well.</div>\n            </div>\n        </div>`,!document.getElementById("thought-stream-fade-style")){const e=document.createElement("style");e.id="thought-stream-fade-style",e.textContent="\n                .fade-mask {\n                    -webkit-mask-image: linear-gradient(to bottom, transparent, black 50px, black calc(100% - 50px), transparent);\n                    mask-image: linear-gradient(to bottom, transparent, black 50px, black calc(100% - 50px), transparent);\n                }\n                \n                .thinking-dots-container {\n                    position: relative;\n                    width: 18px;\n                    height: 18px;\n                    margin-right: 4px;\n                }\n                \n                .thinking-dot {\n                    position: absolute;\n                    width: 5px;\n                    height: 5px;\n                    border-radius: 50%;\n                    background-color: currentColor;\n                    opacity: 0.8;\n                }\n                \n                .thinking-dot-1 {\n                    animation: thinking-dot-spin 1.5s infinite linear;\n                }\n                \n                .thinking-dot-2 {\n                    animation: thinking-dot-spin 1.5s infinite linear 0.5s;\n                }\n                \n                .thinking-dot-3 {\n                    animation: thinking-dot-spin 1.5s infinite linear 1s;\n                }\n                \n                @keyframes thinking-dot-spin {\n                    0% {\n                        transform: rotate(0deg) translate(6px) rotate(0deg);\n                    }\n                    100% {\n                        transform: rotate(360deg) translate(6px) rotate(-360deg);\n                    }\n                }\n            ",document.head.appendChild(e)}return n}exportMenu(e){const t=document.createElement("div");t.classList="flex flex-col gap-3 overflow-y-auto py-4 px-0.5";const s=e=>{let s="",i="";"pdf"===e&&(s="Exporting message as PDF...",i="PDF"),"word"===e&&(s="Exporting message as Word Doc...",i="Word Doc"),this.modal.hideCloseButton();const n=o.A.name("spinner"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-6 h-6",additionalClasses:"animate-spin"});t.innerHTML=`\n            <div class="flex flex-col items-center justify-center gap-0.5">\n                <div>${a.element.outerHTML}</div>\n                <div class="text-xl">${s}</div>\n                <div class="${this.theme.fadedText} text-sm text-center">We're turning this message into a ${i}. Won't be a moment.</div>\n            </div>`},i=(e,s)=>{t.innerHTML="";const i=document.createElement("div"),a="pdf"===e?"Your PDF is ready to download":"Your Word Document is ready to download";i.innerHTML=`\n            <div class="flex flex-col items-center justify-center gap-0.5">\n                <div class="text-xl flex flex-col">${a}</div>\n                <div id="download-button" class="flex flex-col pt-4 pb-3 w-full"></div>\n            </div>`,this.modal.showCloseButton(),t.appendChild(i);const o=new n.$({text:"Download",type:"primary",size:"large",width:"full",icon:"pdf"===e?"fa-solid fa-file-pdf":"fa-solid fa-file-word"});o.render(i.querySelector("#download-button")),o.onClick((()=>{window.open(s,"_blank"),this.modal.close()}))},a=async t=>{s(t);const n={message_id:e.id,type:t};try{const e=await g.G.postData("/chat/export-message/",{data:n});e.success&&e.download_url?i(t,e.download_url):(new c.y("Error exporting message","error",!0,!0,2e3),this.modal.close())}catch(e){new c.y("Error exporting message","error",!0,!0,2e3),this.modal.close()}};this.modalConfig={size:"small",title:"",body:t,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1},this.modal=new l(this.modalConfig);const d=new n.$({text:"Export as PDF",type:"ringPrimary",size:"large",width:"full"});d.render(t),d.onClick((async()=>{a("pdf")}));const h=new n.$({text:"Export as Word Doc",type:"ringPrimary",size:"large",width:"full"});h.render(t),h.onClick((()=>{a("word")}));const m=new n.$({text:"Copy Markdown",type:"ringPrimary",size:"large",width:"full"});m.render(t),m.onClick((()=>{const t=e.responses[0].response;navigator.clipboard.writeText(t).then((()=>{new c.y("Copied to clipboard","success",!0,!0,2e3)})).catch((e=>{new c.y("Error copying to clipboard","error",!0,!0,2e3)})),this.modal.close()}))}createActionContextBlock(e){const t=document.createElement("div");t.className=`flex gap-3 p-2 ${i.A.theme.skillContainerBG} rounded-lg w-full my-2`;const s=document.createElement("div");s.className="flex flex-col justify-start align-middle items-center py-1 px-1";const n=o.A.name("pen"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4"});s.appendChild(a.element),t.appendChild(s);const l=document.createElement("div");l.className="flex flex-col flex-grow overflow-hidden my-0.5 min-w-0 w-full";const c=document.createElement("div");if(c.className="text-sm font-medium leading-5 w-full line-clamp-1",c.innerText=`Editing: ${e.objectTitle}`,l.appendChild(c),e.contextText){const t=document.createElement("div");t.className="text-sm line-clamp-2 overflow-hidden leading-5 w-full mt-1 opacity-70",t.innerText=`"${e.contextText}"`,l.appendChild(t)}return t.appendChild(l),t}}class R{constructor(e,t,s,n=null){this.triggerElement=e,this.updateIconCallback=t,this.chatInputInstance=s,this.assistant=n,this.isAssistantSpecific=!!n,this.theme=i.A.theme,this.menuContainer=null,this.mcpListContainer=null,this.footerContainer=null,this.masterSwitch=null,this.askBeforeToolUseSwitch=null,this.mcpSwitches={},this.installedMCPs=[],this.isMasterEnabled=!0,this.isAskBeforeToolUseEnabled=!0,this.isLoading=!1,this.isClosing=!1,this._boundHandleOutsideClick=null,this._debouncedSavePreferences=function(e,t){let s;const i=function(...i){clearTimeout(s),s=setTimeout((()=>{clearTimeout(s),e.apply(this,i)}),t)};return i.cancel=()=>{clearTimeout(s)},i}(this._savePreferences.bind(this),1500),this._openMCPStoreBrowser=this._openMCPStoreBrowser.bind(this),this._openMCPStoreManager=this._openMCPStoreManager.bind(this),this.broadcastChannel=new BroadcastChannel("simtheory_mcp_status_channel"),this.init()}init(){if(document.querySelector(".mcp-control-menu"))this.removeExisting();else if(this.isAssistantSpecific)this.menuContainer=document.createElement("div"),this.menuContainer.className=`mcp-control-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-30 text-sm w-64 flex flex-col`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="opacity 0.2s ease-in-out",this.menuContainer.innerHTML=`<div class="flex justify-center items-center h-24"><div class="animate-spin rounded-full h-6 w-6 border-b-2 ${this.theme.textInputBorder}"></div></div>`,document.body.appendChild(this.menuContainer),this._positionMenu(),this.menuContainer.style.visibility="visible",this.menuContainer.style.opacity="1",this._loadAndPopulateMenu();else{const e=window.mcp_menu_data||{master_enabled:!0,ask_before_tool_use:!0,mcps:[],mcp_states:{}};this.isMasterEnabled=!1!==e.master_enabled,this.isAskBeforeToolUseEnabled=!1!==e.ask_before_tool_use,this.installedMCPs=e.mcps||[],window.mcp_menu_data=e,window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:"global"}})),this.menuContainer=document.createElement("div"),this.menuContainer.className=`mcp-control-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-30 text-sm w-64 flex flex-col max-h-[calc(100vh-theme(space.16))]`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="opacity 0.2s ease-in-out";const t=document.createElement("ul");t.className="flex-shrink-0";const s=this._createMasterSwitchItem();t.appendChild(s);const i=document.createElement("li");i.className=`border-t ${this.theme.tableDividerLine} mt-1 mb-0 mx-2`,t.appendChild(i),this.mcpListContainer=document.createElement("div"),this.mcpListContainer.className=`flex-grow overflow-y-auto max-h-60 py-1 transition-opacity duration-200 ease-in-out scrollbar-thin ${this.theme.scrollbarThumb} ${this.theme.scrollbarTrack}`,this.footerContainer=document.createElement("div"),this.footerContainer.className=`flex-shrink-0 border-t ${this.theme.tableDividerLine} p-2`,this.footerContainer.style.display="none",this.menuContainer.appendChild(t),this.menuContainer.appendChild(this.mcpListContainer),this.menuContainer.appendChild(this.footerContainer),document.body.appendChild(this.menuContainer),this._positionMenu(),this.menuContainer.style.visibility="visible",requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.opacity="1")})),this._addCloseListener(),this._renderMCPs(),this._updateAskSwitchAvailability(),this._fetchAndRefresh(),this._handleAccessibilityAndFocus()}}async _loadAndPopulateMenu(){const e=await R.refreshMCPData(this.assistant.id);if(!e||!this.menuContainer)return new c.y("Could not load skills.","error"),void this.remove();this.isAssistantSpecific=e.is_assistant_specific||!1,this.isMasterEnabled=!1!==e.master_enabled,this.isAskBeforeToolUseEnabled=!1!==e.ask_before_tool_use,this.installedMCPs=e.mcps||[],window.mcp_menu_data=e,window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:this.assistant.id}})),this.menuContainer.innerHTML="",this.menuContainer.classList.add("max-h-[calc(100vh-theme(space.16))]");const t=document.createElement("ul");t.className="flex-shrink-0";const s=this._createMasterSwitchItem();t.appendChild(s);const i=document.createElement("li");i.className=`border-t ${this.theme.tableDividerLine} mt-1 mb-0 mx-2`,t.appendChild(i),this.mcpListContainer=document.createElement("div"),this.mcpListContainer.className=`flex-grow overflow-y-auto max-h-60 py-1 transition-opacity duration-200 ease-in-out scrollbar-thin ${this.theme.scrollbarThumb} ${this.theme.scrollbarTrack}`,this.footerContainer=document.createElement("div"),this.footerContainer.className=`flex-shrink-0 border-t ${this.theme.tableDividerLine} p-2`,this.footerContainer.style.display="none",this.menuContainer.appendChild(t),this.menuContainer.appendChild(this.mcpListContainer),this.menuContainer.appendChild(this.footerContainer),this._addCloseListener(),this._renderMCPs(),this._updateAskSwitchAvailability(),this._positionMenu(),this._handleAccessibilityAndFocus()}static async refreshMCPData(e=null){try{const t=e?`/accounts/mcp/installed-with-status/?assistant_id=${e}`:"/accounts/mcp/installed-with-status/",s=await g.G.fetchData(t);return window.mcp_menu_data=s,window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:e||"global"}})),s}catch(e){return new c.y("Could not update skills list.","error"),null}}async _fetchAndRefresh(){try{const e=await R.refreshMCPData();if(!e||!this.menuContainer)return;(JSON.stringify(this.installedMCPs)!==JSON.stringify(e.mcps)||this.isMasterEnabled!==(!1!==e.master_enabled)||this.isAskBeforeToolUseEnabled!==(!1!==e.ask_before_tool_use))&&(this.isMasterEnabled=!1!==e.master_enabled,this.isAskBeforeToolUseEnabled=!1!==e.ask_before_tool_use,this.installedMCPs=e.mcps||[],this._renderMCPs(),window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:"global"}})))}catch(e){}}_createMasterSwitchItem(){const e=document.createElement("li");e.className="px-3 pt-3 pb-2 flex justify-between items-center";const t=document.createElement("span");t.className=`${this.theme.text} font-medium`,t.textContent=this.isAssistantSpecific?`${this.assistant.name||"Assistant's"} MCPs`:"Enable MCPs",e.appendChild(t);const s=document.createElement("div");return this.masterSwitch=new C({size:"small",value:this.isMasterEnabled,label:null,ariaLabel:"Enable MCPs"}),this.masterSwitch.render(s),e.appendChild(s),this.masterSwitch.onChange((e=>{this._handleMasterToggle(e),this._debouncedSavePreferences()})),e}_createAskBeforeToolUseItem(){}_renderMCPs(){if(this.isLoading=!0,this.mcpSwitches={},this.masterSwitch&&this.masterSwitch.setValue(this.isMasterEnabled,!0),this.askBeforeToolUseSwitch&&this.askBeforeToolUseSwitch.setValue(this.isAskBeforeToolUseEnabled,!0),this.mcpListContainer.innerHTML="",this.footerContainer.innerHTML="",this.installedMCPs&&0!==this.installedMCPs.length){this.masterSwitch&&this.masterSwitch.setDisabled(!1),this.installedMCPs.forEach((e=>{const t=this._createMCPItem(e);this.mcpListContainer.appendChild(t)}));const e=document.createElement("div"),t=new n.$({text:"Manage connections",icon:"",type:"link",size:"link-sm",width:"full"});t.onClick(this._openMCPStoreManager),t.render(e),this.footerContainer.appendChild(e),this.footerContainer.style.display="block",this._updateMasterSwitchState()}else{const e=document.createElement("div");e.className="px-3 py-3 flex flex-col items-center text-center";const t=document.createElement("div"),s=new n.$({text:"+ Add your first tool",type:"link",size:"link-sm",width:"auto"});s.onClick(this._openMCPStoreBrowser),s.render(t),e.appendChild(t),this.mcpListContainer.appendChild(e),this.footerContainer.style.display="none",this.masterSwitch&&this.masterSwitch.setDisabled(!0),this.updateIconCallback&&this.updateIconCallback(!1)}if(this._updateListOpacity(),this._updateAskSwitchAvailability(),this.menuContainer&&this._positionMenu(),this.isLoading=!1,this.masterSwitch){const e=this.installedMCPs&&this.installedMCPs.length>0;this.masterSwitch.setDisabled(!e)}}_createMCPItem(e){const t=document.createElement("div");t.className="px-3 h-8 py-1.5 flex justify-between items-center rounded mx-1 group";const s=document.createElement("div");s.className="flex items-center gap-2 overflow-hidden mr-2 flex-grow min-w-0";const i=document.createElement("div");i.className="w-5 h-5 flex-shrink-0 flex items-center justify-center drop-shadow-md",e.image_url&&(i.innerHTML=`<img src="${e.image_url}" class="w-full h-full rounded-sm object-contain" alt="${e.name} logo" draggable="false">`),s.appendChild(i);const n=document.createElement("span");n.className=`${this.theme.text} text-sm truncate select-none`,n.textContent=e.name,n.title=e.name,s.appendChild(n),t.appendChild(s);const a=document.createElement("div");a.className="flex items-center gap-2 flex-shrink-0";let l=null;const c=e.sample_prompts&&e.sample_prompts.length>0;if(c){l=document.createElement("button"),l.type="button",l.setAttribute("aria-label",`Show sample prompts for ${e.name}`),l.className=`prompt-icon opacity-0 pointer-events-none transition-opacity duration-150 ease-in-out ${this.theme.iconColor} ${this.theme.menuIconHoverColor} p-1 rounded inline-flex items-center justify-center`;const t=o.A.name("commentQuestion"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});l.appendChild(s.element);const i=t=>{t.stopPropagation(),this._showSamplePromptsModal(e)};l.addEventListener("click",i),a.appendChild(l)}const d=document.createElement("div"),h=new C({size:"tiny",value:e.enabled,label:null,ariaLabel:e.name});return h.render(d),a.appendChild(d),t.appendChild(a),this.mcpSwitches[e.mcp_id]={switch:h,icon:l,itemElement:t},c&&l&&(t.addEventListener("mouseenter",(()=>{const t=this.mcpSwitches[e.mcp_id],s=t?t.switch.value:e.enabled;this.isMasterEnabled&&s&&(l.style.opacity="1",l.style.pointerEvents="auto")})),t.addEventListener("mouseleave",(()=>{l.style.opacity="0",l.style.pointerEvents="none"}))),h.onChange((async t=>{const s=this.installedMCPs.find((t=>t.mcp_id===e.mcp_id));s&&(s.enabled=t),l&&!t&&(l.style.opacity="0",l.style.pointerEvents="none"),this._updateMasterSwitchState(),this._debouncedSavePreferences()})),t}_handleMasterToggle(e){this.isMasterEnabled=e,this._updateListOpacity(),this._updateAskSwitchAvailability(),this._updateMasterSwitchState(),e||Object.values(this.mcpSwitches).forEach((({icon:e})=>{e&&(e.style.opacity="0",e.style.pointerEvents="none")}))}_updateAskSwitchAvailability(){if(this.askBeforeToolUseSwitch){const e=this.installedMCPs&&this.installedMCPs.length>0,t=!this.isMasterEnabled||!e;this.askBeforeToolUseSwitch.setDisabled(t)}}_updateMasterSwitchState(){if(this.isLoading||!this.masterSwitch)return;const e=this.installedMCPs&&this.installedMCPs.length>0;this.masterSwitch.setDisabled(!e);const t=e&&this.installedMCPs.some((e=>{const t=this.mcpSwitches[e.mcp_id];return t?t.switch.value:e.enabled})),s=this.isMasterEnabled&&t;this.updateIconCallback&&this.updateIconCallback(s)}_updateListOpacity(){if(this.mcpListContainer){const e=this.installedMCPs&&this.installedMCPs.length>0;!this.isMasterEnabled&&e?this.mcpListContainer.classList.add("opacity-50","pointer-events-none"):this.mcpListContainer.classList.remove("opacity-50","pointer-events-none"),Object.values(this.mcpSwitches).forEach((({switch:e})=>{e.setDisabled(!this.isMasterEnabled)}))}}_getCurrentPreferences(){const e={};return this.installedMCPs.forEach((t=>{if(t&&t.mcp_id){const s=this.mcpSwitches[t.mcp_id];e[t.mcp_id]=s?s.switch.value:t.enabled}})),{master_enabled:this.isMasterEnabled,ask_before_tool_use:this.isAskBeforeToolUseEnabled,mcp_states:e}}async _savePreferences(e=!1){if(this.isLoading||this.isClosing&&!e)return;const t=this._getCurrentPreferences(),s=this.installedMCPs.some((e=>t.mcp_states[e.mcp_id])),i=t.master_enabled&&s;if(this.isAssistantSpecific){await g.G.postData("/chat/save-assistant-mcp-preferences/",{assistant_id:this.assistant.id,preferences:t});const s=await R.refreshMCPData(this.assistant.id);if(s&&(window.mcp_menu_data=s),window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:this.assistant.id}})),!e&&this.broadcastChannel&&this.broadcastChannel.postMessage)try{this.broadcastChannel.postMessage({assistantId:this.assistant.id,status:i})}catch(e){}}else{window.mcp_menu_data&&(window.mcp_menu_data.master_enabled=t.master_enabled,window.mcp_menu_data.mcps&&window.mcp_menu_data.mcps.forEach((e=>{t.mcp_states.hasOwnProperty(e.mcp_id)&&(e.enabled=t.mcp_states[e.mcp_id])})));try{await g.G.postData("/accounts/save-mcp-preferences/",t);const s=await R.refreshMCPData();if(s&&(window.mcp_menu_data=s),window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:"global"}})),!e&&this.broadcastChannel&&this.broadcastChannel.postMessage)try{this.broadcastChannel.postMessage({assistantId:"global",status:i})}catch(e){}}catch(e){new c.y("Error saving MCP settings","error")}}}_showSamplePromptsModal(e){if(!e||!e.sample_prompts||0===e.sample_prompts.length)return void new c.y("No sample prompts available for this skill.","info");const t=document.createElement("div");t.className="flex flex-col gap-2 py-2";let s=null;e.sample_prompts.forEach((e=>{const i=document.createElement("button");i.type="button",i.className=`block w-full text-left p-4 rounded ${this.theme.text} ${this.theme.menuIconHoverColor} text-base transition-colors duration-150 ease-in-out rounded-md ${this.theme.secondaryButtonTransparent}`,i.textContent=e,i.addEventListener("click",(()=>{if(this.chatInputInstance&&this.chatInputInstance.inputTextArea){const t=this.chatInputInstance.inputTextArea;t.value=e,t.dispatchEvent(new Event("input",{bubbles:!0,cancelable:!0})),"function"==typeof this.chatInputInstance.adjustTextarea&&setTimeout((()=>this.chatInputInstance.adjustTextarea()),50),this.chatInputInstance.focus(),s&&s.closeProcess()}else new c.y("Could not find chat input area.","warning"),s&&s.closeProcess()})),t.appendChild(i)})),this.remove(),s=new l({title:`Sample prompts for ${e.name}`,body:t,size:"medium",closeX:!0,confirm:!1,cancel:!1,disableScroll:e.sample_prompts.length<8})}_openMCPStoreBrowser(){this.remove(),A.create("store")}_openMCPStoreManager(){this.remove(),A.create("installed")}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect(),t=this.menuContainer.offsetHeight,s=this.menuContainer.offsetWidth;let i=e.top-t-8,n=e.left;i<8&&(i=e.bottom+8,i+t>window.innerHeight-8&&(i=window.innerHeight-t-8)),n<8?n=8:n+s>window.innerWidth-8&&(n=window.innerWidth-s-8),this.menuContainer.style.top=`${i+window.scrollY}px`,this.menuContainer.style.left=`${n+window.scrollX}px`}_addCloseListener(){this._boundHandleOutsideClick&&this._removeCloseListener(),setTimeout((()=>{this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),document.addEventListener("click",this._boundHandleOutsideClick,{capture:!0,once:!1})}),0)}_removeCloseListener(){this._boundHandleOutsideClick&&(document.removeEventListener("click",this._boundHandleOutsideClick,{capture:!0}),this._boundHandleOutsideClick=null)}_handleOutsideClick(e){const t=this.menuContainer&&!this.menuContainer.contains(e.target),s=this.triggerElement&&!this.triggerElement.contains(e.target);t&&s&&this.remove()}removeExisting(){document.querySelectorAll(".mcp-control-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(){if(!this.isClosing)if(this.isClosing=!0,this._debouncedSavePreferences&&(this._debouncedSavePreferences.cancel?.(),this._savePreferences(!0)),this._removeCloseListener(),this._removeAccessibilityListeners(),this._returnFocusToTrigger(),this.menuContainer){const e=this.menuContainer;this.menuContainer=null,this.footerContainer=null,this.masterSwitch=null,this.askBeforeToolUseSwitch=null,this.mcpSwitches={},this.installedMCPs=[],e.style.opacity="0";const t=setTimeout((()=>{e.parentNode&&e.remove(),this.broadcastChannel&&this.broadcastChannel.close()}),250);e.addEventListener("transitionend",(s=>{"opacity"===s.propertyName&&(clearTimeout(t),e.parentNode&&e.remove(),this.broadcastChannel&&this.broadcastChannel.close())}),{once:!0})}else this.masterSwitch=null,this.askBeforeToolUseSwitch=null,this.mcpSwitches={},this.installedMCPs=[],this.broadcastChannel&&this.broadcastChannel.close()}_handleAccessibilityAndFocus(){this.menuContainer&&(this.menuContainer.setAttribute("role","menu"),this.menuContainer.setAttribute("aria-label",this.isAssistantSpecific?`${this.assistant.name}'s MCP Menu`:"Global MCP Menu"),this._boundHandleKeyDown=this._handleKeyDown.bind(this),document.addEventListener("keydown",this._boundHandleKeyDown),setTimeout((()=>{this.masterSwitch&&this.masterSwitch.element&&this.masterSwitch.element.focus()}),100))}_handleKeyDown(e){"Escape"===e.key&&this.remove()}_removeAccessibilityListeners(){this._boundHandleKeyDown&&(document.removeEventListener("keydown",this._boundHandleKeyDown),this._boundHandleKeyDown=null)}_returnFocusToTrigger(){this.triggerElement&&"function"==typeof this.triggerElement.focus&&this.triggerElement.focus()}}var H=s(51308),O=s(53005);class q{constructor(e="personalization"){this.theme=i.A.theme,this.activeSection=e,this.view="settings",this.container=null,this.settingsEl=null,this.sidebarEl=null,this.contentEl=null,this.sidebarVisible=!1,this.isDirty=!1,this.pendingChanges={},this.saveTimeout=null,this.saveDelay=1500,this.isDestroyed=!1,this.planConfig=O.l.getPlans(!0).individual,this.currentPlanID=window.user.billing.plan_id||"member",this.billingCycle=window.user.billing.billing_cycle||"monthly",this.nextBillingDate=window.user.billing.next_billing_date,this.willCancelAtPeriodEnd=window.user.billing.will_cancel_at_period_end,this.isAnnual="annual"===this.billingCycle,this.planInfo=this.planConfig[this.currentPlanID],this.isLoading=!1,this.usageData=null,this.rechargeData=null,this.invoices=null,this.usageHistory=null,this.paymentMethods=null,this.personalizationData=null,this.upgradeButton=null,this.rechargeToggleTimeout=null,this.isRechargeEnabled=!1,this.isInitializingRechargeSwitch=!1,"Personal"===y.a.workspace.name?this.menuItems=[{id:"personalization",name:"Personalization",icon:"sparkles"},{id:"details",name:"Profile",icon:"user"},{id:"plan",name:"Account",icon:"userCircle"},{id:"usage",name:"Usage",icon:"coin"},{id:"payment",name:"Payment methods",icon:"creditCard"},{id:"invoices",name:"Invoices",icon:"receipt"},{id:"preferences",name:"Preferences",icon:"sliders"}]:this.menuItems=[{id:"personalization",name:"Personalization",icon:"sparkles"},{id:"details",name:"Profile",icon:"user"},{id:"preferences",name:"Preferences",icon:"sliders"},{id:"usage",name:"Usage",icon:"coin"}],this.init(),window.addEventListener("resize",this.handleResize),this.handleResize()}init=async()=>{this.renderShell(),this.show(),await this.loadInitialData()};renderShell=()=>{this.container=document.createElement("div"),this.container.className="user-settings-container fixed inset-0 z-40 flex items-start justify-center backdrop-blur-xs pt-10 sm:pt-20",this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.settingsEl=document.createElement("div"),this.settingsEl.className=`${this.theme.modalBackground} w-[75vw] sm:w-[80vw] md:w-[75vw] lg:w-[80vw] h-[90vh] sm:h-[80vh] md:h-[75vh] rounded-lg shadow-xl flex overflow-hidden ring-1 ${this.theme.ringColor} relative`;const e=document.createElement("div");e.className="absolute top-4 right-3 z-10";const t=o.A.name("tabClose"),s=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"focus",size:"small",iconHeightAndWidth:"h-6 w-6"});s.onClick(this.close),s.render(e),this.settingsEl.appendChild(e),this.sidebarEl=document.createElement("div"),this.sidebarEl.className=`${this.theme.secondaryBackground} w-64 flex-shrink-0 flex flex-col border-r ${this.theme.tableBorder} hidden md:flex`,this.contentEl=document.createElement("div"),this.contentEl.className="flex-1 flex flex-col overflow-hidden",this.sidebarOverlay=document.createElement("div"),this.sidebarOverlay.className="absolute inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden",this.sidebarOverlay.addEventListener("click",(()=>this.toggleSidebar(!1))),this.mobileSidebar=document.createElement("div"),this.mobileSidebar.className=`${this.theme.modalBackground} absolute inset-0 z-30 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden`,this.settingsEl.appendChild(this.sidebarEl),this.settingsEl.appendChild(this.contentEl),this.settingsEl.appendChild(this.sidebarOverlay),this.settingsEl.appendChild(this.mobileSidebar),this.container.appendChild(this.settingsEl),document.body.appendChild(this.container)};loadInitialData=async()=>{this.isLoading=!0,this.renderSidebar(),this.renderContentArea(),this.renderLoadingState();try{const e={details:this.loadPersonalizationData,personalization:this.loadPersonalizationData,preferences:this.loadPersonalizationData,plan:this.loadPlanData,usage:this.loadCombinedUsageData,payment:this.loadPaymentMethods,invoices:this.loadInvoicesData};e[this.activeSection]&&await e[this.activeSection](),this.isLoading=!1,this.refreshContent()}catch(e){new c.y("Failed to load settings data.","error"),this.isLoading=!1,this.renderErrorState("Could not load settings data.")}};loadPlanData=async()=>{const e=[];e.push(this.fetchPlanData()),this.usageData||e.push(this.loadUsageData()),this.personalizationData||e.push(this.loadPersonalizationData()),e.length>0&&await Promise.all(e)};loadCombinedUsageData=async()=>{if(!this.usageData||!this.usageHistory||this.targetMember)if("Personal"!==y.a.workspace.name)try{const e=await y.a.getMemberUsage(y.a.workspace.slug);if(!e.success)throw new Error(e.error||"Failed to load workspace usage data.");this.usageData=this.transformWorkspaceUsageData(e.data),this.usageHistory=e.data.history,this.rechargeData={tokens:{total_input_remaining:0,total_output_remaining:0},premium_images:{total_remaining:0}}}catch(e){throw e}else{const e=[];this.usageData||e.push(this.loadUsageData()),this.usageHistory||e.push(this.loadUsageHistoryData()),e.length>0&&await Promise.all(e)}};loadWorkspaceUsageData=async()=>{if(!this.usageData)try{const e=await y.a.getWorkspaceUsageLog();if(!e.success)throw new Error(e.error||"Failed to load workspace usage data.");this.usageData=e.data}catch(e){throw e}};renderSidebar=()=>{this.sidebarEl.innerHTML="";const e=document.createElement("div");e.className=`p-4 border-b ${this.theme.tableBorder}`;const t=document.createElement("h2");t.className=`text-base font-medium ${this.theme.text}`,t.textContent="Settings",e.appendChild(t);const s=document.createElement("div");s.className="flex-1 overflow-y-auto py-1";const i=document.createElement("ul");i.className="space-y-1",this.menuItems.forEach((e=>{const t=document.createElement("div"),s=document.createElement("button");s.dataset.sectionId=e.id,s.className="w-full text-left text-base px-4 py-1.5 flex items-center transition-colors duration-150";const n=o.A.name(e.icon),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"mr-3"}),l=document.createElement("span");l.textContent=e.name,a.render(s),s.appendChild(l),s.addEventListener("click",(()=>this.switchSection(e.id))),t.appendChild(s),i.appendChild(t)})),s.appendChild(i),this.sidebarEl.appendChild(e),this.sidebarEl.appendChild(s),this.mobileSidebar.innerHTML="";const a=document.createElement("div");a.className=`p-4 flex items-center justify-between border-b ${this.theme.tableBorder}`;const l=o.A.name("chevronLeft"),c=new n.$({text:"Back",svgPathData:l.path,svgViewBox:l.viewBox,type:"secondaryTransparent",size:"small",iconHeightAndWidth:"w-4 h-4"});c.onClick((()=>this.toggleSidebar(!1))),c.render(a);const d=document.createElement("h2");d.className=`text-lg font-medium ${this.theme.text}`,d.textContent="Settings",a.appendChild(d);const h=document.createElement("div");h.className="w-16",a.appendChild(h);const m=document.createElement("div");m.className="flex-1 overflow-y-auto py-1";const u=document.createElement("ul");u.className="space-y-1",this.menuItems.forEach((e=>{const t=document.createElement("li"),s=document.createElement("button");s.dataset.sectionId=e.id,s.className="w-full text-left text-base px-4 py-2 flex items-center transition-colors duration-150";const i=o.A.name(e.icon),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-5 h-5",additionalClasses:"mr-3"}),a=document.createElement("span");a.textContent=e.name,n.render(s),s.appendChild(a),s.addEventListener("click",(()=>{this.switchSection(e.id),this.toggleSidebar(!1)})),t.appendChild(s),u.appendChild(t)})),m.appendChild(u),this.mobileSidebar.appendChild(a),this.mobileSidebar.appendChild(m),this.updateMenuHighlighting()};renderContentArea=()=>{if(!this.contentEl)return;this.contentEl.innerHTML="";const e=document.createElement("div");e.className=`p-3 sm:p-4 border-b ${this.theme.tableBorder} ${this.theme.modalBackground} flex items-center gap-2 sm:gap-4`,e.dataset.id="content-header";const t=o.A.name("bars"),s=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"secondaryTransparent",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden"});s.onClick((()=>this.toggleSidebar()));const i=document.createElement("h3");i.className=`font-medium ${this.theme.text} flex-1`,i.textContent=this.getContentTitle(),i.dataset.id="content-title",s.render(e),e.appendChild(i);const a=document.createElement("div");a.className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6",a.dataset.id="content-body",this.contentEl.appendChild(e),this.contentEl.appendChild(a)};renderLoadingState=()=>{const e=this.contentEl?.querySelector('[data-id="content-body"]');if(!e)return;e.innerHTML="";const t=document.createElement("div");t.className="space-y-6 animate-pulse";for(let e=0;e<4;e++){const e=document.createElement("div");e.className=`h-8 ${this.theme.loadBackground} rounded w-full`,t.appendChild(e)}e.appendChild(t)};renderErrorState=(e="An error occurred.")=>{const t=this.contentEl?.querySelector('[data-id="content-body"]');if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className="flex flex-col items-center justify-center h-full p-6 text-center";const i=o.A.name("error"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-12 h-12",colorClass:"text-red-500",additionalClasses:"mb-4"}),a=document.createElement("p");a.className=`text-lg font-medium ${this.theme.text} mb-2`,a.textContent="Oops! Something went wrong.";const l=document.createElement("p");l.className=this.theme.fadedText,l.textContent=e,n.render(s),s.appendChild(a),s.appendChild(l),t.appendChild(s)};switchSection=async e=>{if(this.activeSection!==e||"invoices"===e){"invoices"===e&&(this.invoices=null),this.activeSection=e,this.updateMenuHighlighting(),this.updateContentTitle(),this.isLoading=!0,this.renderLoadingState();try{const t={details:this.loadPersonalizationData,personalization:this.loadPersonalizationData,preferences:this.loadPersonalizationData,plan:this.loadPlanData,usage:this.loadCombinedUsageData,payment:this.loadPaymentMethods,invoices:this.loadInvoicesData},s={details:!this.personalizationData,personalization:!this.personalizationData,preferences:!this.personalizationData,plan:!this.usageData||!this.personalizationData,usage:!this.usageData||!this.usageHistory,payment:!this.paymentMethods,invoices:!this.invoices};t[e]&&s[e]&&await t[e](),this.isLoading=!1,this.refreshContent()}catch(t){new c.y(`Failed to load ${e} data.`,"error"),this.isLoading=!1,this.renderErrorState(`Could not load ${e} data.`)}}};loadPersonalizationData=async()=>{if(!this.personalizationData)try{this.personalizationData=await u.K.getPersonalizationData()}catch(e){throw this.personalizationData=null,e}};loadPaymentMethods=async()=>{if(!this.paymentMethods)try{this.paymentMethods=await u.K.getPaymentMethods()}catch(e){throw this.paymentMethods=null,e}};loadUsageData=async()=>{if(!this.usageData)try{const e=await u.K.getUsageData();this.usageData=e,this.rechargeData=e.recharge_details,this.isRechargeEnabled=e.auto_token_recharge||!1}catch(e){throw e}};loadInvoicesData=async()=>{if(!this.invoices)try{this.invoices=await u.K.getInvoices()}catch(e){throw this.invoices=null,e}};updateMenuHighlighting=()=>{const e=(e,t=!1)=>{e.forEach((e=>{const s=e.dataset.sectionId;e.classList.remove(...this.theme.menuSelectedItem.split(" "),...this.theme.backgroundHover.split(" ")),e.classList.remove("font-medium");const i=`w-full text-left text-base px-4 ${t?"py-2":"py-1.5"} flex items-center transition-colors duration-150`;this.activeSection===s?(e.className=`${i} font-medium`,e.classList.add(...this.theme.menuSelectedItem.split(" "))):(e.className=`${i} ${this.theme.text}`,e.classList.add(...this.theme.backgroundHover.split(" ")))}))};this.sidebarEl&&e(this.sidebarEl.querySelectorAll("ul button"),!1),this.mobileSidebar&&e(this.mobileSidebar.querySelectorAll("ul button"),!0)};updateContentTitle=()=>{const e=this.contentEl?.querySelector('[data-id="content-title"]');e&&(e.textContent=this.getContentTitle())};getContentTitle=()=>{const e=this.menuItems.find((e=>e.id===this.activeSection));return e?e.name:"Settings"};refreshContent=()=>{if(this.isLoading)return void this.renderLoadingState();const e=this.contentEl?.querySelector('[data-id="content-body"]');if(e)switch(e.innerHTML="",this.activeSection){case"details":default:this.renderDetailsSection(e);break;case"personalization":this.renderPersonalizationSection(e);break;case"preferences":this.renderPreferencesSection(e);break;case"plan":this.renderPlanSection(e);break;case"payment":this.renderPaymentMethodsSection(e);break;case"invoices":this.renderInvoicesSection(e);break;case"usage":this.renderCombinedUsageSection(e)}};renderDetailsSection=e=>{if(!this.personalizationData)return void this.renderErrorState("Could not load user details.");const t=document.createElement("div");t.className="space-y-6";const s=document.createElement("div");s.innerHTML='<div class="text-base mb-2">Avatar</div>';const i=this.personalizationData.picture_url||null;this.avatar=new S(null,i,"Select an option:",null),this.avatar.onChange((e=>{this.scheduleSave({picture_url:e})})),this.avatar.render(s),t.appendChild(s);const n=document.createElement("div");n.className="grid grid-cols-1 sm:grid-cols-2 gap-6",this.firstNameInput=new d({label:"First name",value:this.personalizationData.first_name||""}),this.firstNameInput.render(n),this.firstNameInput.onChange((()=>{this.scheduleSave({first_name:this.firstNameInput.value})})),this.lastNameInput=new d({label:"Last name",value:this.personalizationData.last_name||""}),this.lastNameInput.render(n),this.lastNameInput.onChange((()=>{this.scheduleSave({last_name:this.lastNameInput.value})})),t.appendChild(n),e.appendChild(t)};renderPersonalizationSection=e=>{if(!this.personalizationData)return void this.renderErrorState("Could not load personalization data.");const t=document.createElement("div");t.className="space-y-6",this.callMeNameInput=new d({label:"What should assistants call you?",placeholder:"e.g. Mike",value:this.personalizationData.call_me_name||""}),this.callMeNameInput.render(t),this.callMeNameInput.onChange((()=>{this.scheduleSave({call_me_name:this.callMeNameInput.value})})),this.occupationInput=new d({label:"What do you do?",placeholder:"e.g. software developer",value:this.personalizationData.occupation||""}),this.occupationInput.render(t),this.occupationInput.onChange((()=>{this.scheduleSave({occupation:this.occupationInput.value})})),this.locationInput=new d({label:"Where are you located?",placeholder:"e.g. Newcastle, Australia",value:this.personalizationData.location||""}),this.locationInput.render(t),this.locationInput.onChange((()=>{this.scheduleSave({location:this.locationInput.value})})),this.rememberInput=new p({label:"What do you want every assistant to know about you?",placeholder:"Share interests, preferences, or anything else for assistants to remember.",rows:4,canGrow:!0,maxChar:2e3,value:this.personalizationData.remember||""}),this.rememberInput.render(t),this.rememberInput.onChange((()=>{this.scheduleSave({remember:this.rememberInput.value})})),e.appendChild(t)};renderPreferencesSection=e=>{if(!this.personalizationData)return void this.renderErrorState("Could not load preferences.");const t=document.createElement("div");t.className="space-y-4";const s=(e,t,s)=>{const i=document.createElement("div");i.className="py-2";const n=new C({label:e,value:t});return n.onChange((e=>{this.handleUpdatePreference(s,e)})),n.render(i),i};t.appendChild(s("Share personalization data with assistants",this.personalizationData.usePersonalizationData,"usePersonalizationData")),t.appendChild(s("Allow assistants to use your local time",this.personalizationData.useTime,"useTime")),t.appendChild(s("Word wrap in code blocks by default",this.personalizationData.wrapCodeBlocks,"wrapCodeBlocks")),t.appendChild(s("On desktop send messages with ENTER (SHIFT+ENTER new line)",this.personalizationData.sendMessageOnEnter,"sendMessageOnEnter"));const i=s("Enable keyboard shortcuts",this.personalizationData.enableKeyboardShortcuts,"enableKeyboardShortcuts"),n=i.querySelector("label");if(n){const e=this.createKeyboardShortcutTooltip();n.appendChild(e)}t.appendChild(i),e.appendChild(t)};createKeyboardShortcutTooltip=()=>{const e=document.createElement("div");e.className="relative flex items-center ml-1.5";const t=o.A.name("info");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fadedText,additionalClasses:"cursor-pointer"}).render(e);const s=document.createElement("div");s.className=`hidden absolute bottom-full left-1/2 -translate-x-1/2 mb-2 w-max max-w-xs p-3 rounded-md shadow-lg ${this.theme.modalBackground} ring-1 ${this.theme.ringColor} z-10 cursor-pointer`;s.innerHTML=`\n            <h4 class="font-medium ${this.theme.text} text-sm mb-2">Keyboard shortcuts</h4>\n            <ul class="space-y-1.5 text-sm">\n                ${[{key:"Alt + N",description:"New session"},{key:"Alt + Shift + ",description:"Previous tab"},{key:"Alt + Shift + ",description:"Next tab"},{key:"Alt + ",description:"Previous message"},{key:"Alt + ",description:"Next message"},{key:"Alt +  ",description:"Scroll to bottom"}].map((e=>`\n                    <li class="flex justify-between items-center gap-4">\n                        <span class="${this.theme.fadedText}">${e.description}</span>\n                        <code class="${this.theme.secondaryBackground} ${this.theme.fadedText} px-1.5 py-0.5 rounded-md text-xs">${e.key}</code>\n                    </li>\n                `)).join("")}\n            </ul>\n        `,e.appendChild(s),e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation();s.classList.toggle("hidden")||setTimeout((()=>document.addEventListener("click",i,{once:!0,capture:!0})),0)}));const i=t=>{e.contains(t.target)||s.classList.add("hidden")};return e};scheduleSave=e=>{this.isDirty=!0,this.pendingChanges={...this.pendingChanges,...e},clearTimeout(this.saveTimeout),this.saveTimeout=setTimeout((()=>{this.handleAutoSave()}),this.saveDelay)};handleAutoSave=async(e=!0)=>{if(!this.isDirty||0===Object.keys(this.pendingChanges).length)return;const t={...this.pendingChanges};this.pendingChanges={},this.isDirty=!1,clearTimeout(this.saveTimeout),this.saveTimeout=null;const s={...this.personalizationData,...t};try{const e=await u.K.savePersonalizationData(s);if(!e.success)throw new Error(e.error||"Failed to save settings.");this.personalizationData=s;Object.keys(t).includes("picture_url")&&this.updateUIAfterSave("details",e.picture_url)}catch(e){this.isDirty=!0,this.pendingChanges={...this.pendingChanges,...t},new c.y(e.message,"error")}};updateUIAfterSave=(e,t)=>{if("details"===e){const e=t||"/static/images/default_avatar.svg",s=document.querySelectorAll(".profile-image");s.length>0&&s.forEach((t=>{t.src=e}))}};handleUpdatePreference=async(e,t)=>{let s={...this.personalizationData,[e]:t};if("useTime"===e&&t)try{s.latestTimezone=Intl.DateTimeFormat().resolvedOptions().timeZone}catch(e){}try{const i=await u.K.savePersonalizationData(s);if(!i.success)throw new Error(i.error||"Failed to update preference.");this.personalizationData=s,window.user.preferences[e]=t}catch(e){new c.y(e.message,"error"),this.refreshContent()}};renderPlanSection=e=>{const t=document.createElement("div"),s=document.createElement("div");s.className=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full`;const i=document.createElement("div");i.className="flex justify-between items-start mb-4";const a=document.createElement("div");a.className="flex flex-col gap-0.5";const o=document.createElement("div");o.className="text-lg font-bold";let r="Member plan";if("admin"===this.currentPlanID)o.textContent="Admin plan",r="Admin plan";else{const e=O.l.getPlans(!0).individual[this.currentPlanID];e?(r=e.name,o.textContent=r):(o.textContent="Current Plan",r="Current Plan")}a.appendChild(o);const l=document.createElement("div");l.className=`text-sm ${this.theme.fadedText}`;let c="";"annual"===this.billingCycle?c="Annual billing":"quarterly"===this.billingCycle?c="Quarterly billing":"monthly"===this.billingCycle&&(c="Monthly billing"),l.textContent=c,a.appendChild(l);const d=document.createElement("div");if(d.className=`text-sm ${this.theme.fadedText}`,this.nextBillingDate){const e=new Date(this.nextBillingDate).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});this.willCancelAtPeriodEnd?d.textContent=`Your plan will be canceled on ${e}`:d.textContent=`Your plan will auto-renew on ${e}`}else d.textContent="N/A";a.appendChild(d);const h=document.createElement("div");if(h.className="flex flex-col gap-2 items-end","trial"!==this.currentPlanID&&"workspace"!==this.currentPlanID&&"admin"!==this.currentPlanID)if(this.willCancelAtPeriodEnd){const e=new n.$({text:"Reactivate",type:"primary",size:"medium"});e.onClick((()=>{window.location.href="/accounts/reactivate-plan/"})),e.render(h)}else{const e=new n.$({text:"Manage",type:"primary",size:"medium"});e.onClick((()=>{const t=e.element;document.querySelectorAll(".plan-context-menu").forEach((e=>e.remove()));const s=document.createElement("div");s.className=`plan-context-menu absolute ${this.theme.tableMenuBackground} shadow-lg rounded-lg z-50 text-sm min-w-[180px] flex flex-col overflow-hidden py-1`,s.style.visibility="hidden",s.style.opacity="0",s.style.transform="scale(0.95)",s.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out";const i=()=>{document.removeEventListener("click",n,!0),s&&(s.style.opacity="0",s.style.transform="scale(0.95)",s.addEventListener("transitionend",(()=>s.remove()),{once:!0}))},n=e=>{!s||s.contains(e.target)||t.contains(e.target)||i()},a=(e,t,n)=>{const a=document.createElement("button"),o=n||this.theme.text;a.className=`w-full text-left px-4 py-1.5 ${this.theme.tableMenuButtonHover} flex items-center`;const r=document.createElement("span");r.className=`${o} text-sm`,r.textContent=e,a.appendChild(r),a.addEventListener("click",(e=>{e.stopPropagation(),t&&t(),i()})),s.appendChild(a)},o=e=>{window.location.href=e};this.willCancelAtPeriodEnd?(a("View plans",(()=>o("/accounts/change-plan/"))),a(`Renew ${r}`,(()=>o("/accounts/reactivate-plan/")))):(a("Change plans",(()=>o("/accounts/change-plan/"))),a("Cancel plan",(()=>o("/accounts/cancel-plan/")),this.theme.textDanger)),document.body.appendChild(s),document.addEventListener("click",n,!0);const l=t.getBoundingClientRect(),c=s.getBoundingClientRect();let d=l.bottom+4,h=l.right-c.width;s.style.top=`${d+window.scrollY}px`,s.style.left=`${h+window.scrollX}px`,requestAnimationFrame((()=>{s.style.visibility="visible",s.style.opacity="1",s.style.transform="scale(1)"}))})),e.render(h)}i.appendChild(a),i.appendChild(h),s.appendChild(i),t.appendChild(s),this.renderRechargeSection(t),e.appendChild(t)};handleResumeCurrentPlan=()=>{this.resumePlan(this.currentPlanID)};showPlanChangeView=()=>{const e=document.createElement("div"),t=new l({title:"Change your plan",body:e,size:"large",closeX:!0,hideHeader:!0});new O.l({mode:"manage",container:e,currentPlan:this.currentPlanID,currentCycle:this.billingCycle,onPlanSelected:async(e,s)=>{t.close();const i="annual"===s;e===this.currentPlanID&&this.isAnnual,await this.upgradePlan(e,i)},onClose:()=>t.close()})};handleCancelPlan=()=>{new a("Are you sure you want to cancel?","Your plan will remain active until the end of your current billing period. You can resume your subscription at any time before then.").onConfirm((async()=>{const e=await u.K.cancelSubscription();e.success?(new c.y("Your subscription has been cancelled.","success"),this.willCancelAtPeriodEnd=!0,this.refreshContent()):new c.y(e.error||"Could not cancel subscription.","error")}))};renderPaymentMethodsSection=e=>{const t=document.createElement("div");if(t.className="space-y-4",null===this.paymentMethods)return this.renderErrorState("Could not load payment methods."),void e.appendChild(t);if(0===this.paymentMethods.length){const e=document.createElement("div");e.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-6 text-center`,e.innerHTML=`<p class="${this.theme.fadedText}">No payment methods on file.</p>`,t.appendChild(e)}else{const e=document.createElement("div");e.className="space-y-3",this.paymentMethods.forEach((t=>{const s=document.createElement("div");s.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`;const i=document.createElement("div");i.className="flex items-center gap-4";const a=o.A.name("creditCard");new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-8 h-8 flex-shrink-0"}).render(i);const l=document.createElement("div");l.className="flex flex-col";const c=document.createElement("span");c.className=this.theme.text,c.textContent=`${t.brand.charAt(0).toUpperCase()+t.brand.slice(1)} ending in ${t.last4}`;const d=document.createElement("span");if(d.className=`text-sm ${this.theme.fadedText}`,d.textContent=`Expires ${t.exp_month}/${t.exp_year}`,l.appendChild(c),l.appendChild(d),i.appendChild(l),t.is_default){const e=document.createElement("span");e.className=`${this.theme.skillTag} px-2 py-0.5 text-xs rounded-md font-medium ml-4`,e.textContent="Default",i.appendChild(e)}const h=document.createElement("div");if(h.className="flex items-center gap-3 self-end sm:self-center",!t.is_default){const e=new n.$({text:"Set as default",type:"link",size:"link-sm"});e.onClick((()=>this.handleSetDefault(t.id))),e.render(h);const s=new n.$({text:"Delete",type:"secondary",size:"medium"});s.onClick((()=>this.handleDeleteMethod(t.id,t.is_default))),s.render(h)}s.appendChild(i),s.appendChild(h),e.appendChild(s)})),t.appendChild(e)}const s=document.createElement("div");s.className="mt-6";const i=new n.$({text:"Add new payment method",type:"primary",size:"medium"});i.onClick((()=>this.showAddPaymentMethodModal())),i.render(s),t.appendChild(s),e.appendChild(t)};showAddPaymentMethodModal=async()=>{try{const e=await g.G.postData("/accounts/payment-methods/setup/",{});if(!e.success)return void new c.y(e.error||"Failed to setup payment method","error");e.stripe_publishable_key&&(window.stripePublishableKey=e.stripe_publishable_key);const t=document.createElement("div");t.className="space-y-4",t.innerHTML=`\n                <div class="text-base ${this.theme.fadedText} mb-4">\n                    Your credit card will be added and securely processed by Stripe.\n                </div>\n                <div id="card-element" class="p-3 border bg-white rounded-md">\n                    \x3c!-- Stripe Elements will create form elements here --\x3e\n                </div>\n                <div id="card-errors" class="text-red-500 text-sm hidden"></div>\n            `;const s=new l({title:"Add payment method",body:t,size:"medium",closeX:!0,confirm:!0,cancel:!0,confirmText:"Add credit card",cancelText:"Cancel",manualCloseOnConfirm:!0});setTimeout((()=>{this.initializeStripeElements(e.client_secret,e.setup_intent_id,s)}),100)}catch(e){new c.y("Failed to setup payment method","error")}};initializeStripeElements=async(e,t,s)=>{try{if(await this.loadStripe(),!window.Stripe)return new c.y("Payment system not loaded. Please refresh and try again.","error"),void s.close();if(!window.stripePublishableKey)return new c.y("Stripe configuration missing. Please refresh and try again.","error"),void s.close();const i=Stripe(window.stripePublishableKey),n=i.elements().create("card",{style:{base:{fontSize:"16px",color:"#1f2937",fontFamily:'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',fontSmoothing:"antialiased",fontWeight:"400",lineHeight:"1.5",backgroundColor:"#ffffff","::placeholder":{color:"#9ca3af",fontWeight:"400"},":-webkit-autofill":{color:"#1f2937",backgroundColor:"#ffffff"}},invalid:{color:"#dc2626",iconColor:"#dc2626"},complete:{color:"#059669",iconColor:"#059669"}},hidePostalCode:!0});n.mount("#card-element");const a=document.getElementById("card-element");n.on("focus",(()=>{a.classList.add("ring-2","ring-blue-400","ring-opacity-60")})),n.on("blur",(()=>{a.classList.remove("ring-2","ring-blue-400","ring-opacity-60")})),n.on("change",(({error:e,complete:t})=>{const s=document.getElementById("card-errors");e?(s.textContent=e.message,s.classList.remove("hidden"),a.classList.add("border-red-400"),a.classList.remove("border-green-400")):(s.textContent="",s.classList.add("hidden"),a.classList.remove("border-red-400"),t?a.classList.add("border-green-400"):a.classList.remove("border-green-400"))})),s.onConfirm((async()=>{s.updateConfirmButtonText("Processing...");const{error:a,setupIntent:o}=await i.confirmCardSetup(e,{payment_method:{card:n}});if(a)new c.y(a.message,"error"),s.updateConfirmButtonText("Add Payment Method");else try{const e=await g.G.postData("/accounts/payment-methods/confirm/",{setup_intent_id:t});e.success?(new c.y("Payment method added successfully!","success"),s.close(),this.paymentMethods=null,await this.loadPaymentMethods(),this.refreshContent()):(new c.y(e.error||"Failed to save payment method","error"),s.updateConfirmButtonText("Add Payment Method"))}catch(a){new c.y("Failed to save payment method","error"),s.updateConfirmButtonText("Add Payment Method")}}))}catch(e){new c.y("Failed to load payment system","error"),s.close()}};loadStripe=()=>new Promise(((e,t)=>{if(window.Stripe)return void e(window.Stripe);const s=document.createElement("script");s.src="https://js.stripe.com/v3/",s.onload=()=>{e(window.Stripe)},s.onerror=e=>{t(e)},document.head.appendChild(s)}));handleSetDefault=async e=>{try{const t=await g.G.postData("/accounts/payment-methods/set-default/",{payment_method_id:e});t.success?(this.paymentMethods=null,await this.loadPaymentMethods(),this.refreshContent()):new c.y(t.error||"Failed to update payment method.","error")}catch(e){new c.y("Failed to update payment method.","error")}};handleDeleteMethod=(e,t)=>{if(t)return void new c.y("You cannot delete your default payment method.","error");new a("Delete Payment Method?","Are you sure you want to delete this card? This action cannot be undone.").onConfirm((async()=>{try{const t=await g.G.postData("/accounts/payment-methods/delete/",{payment_method_id:e});t.success?(new c.y("Payment method deleted.","success"),this.paymentMethods=null,await this.loadPaymentMethods(),this.refreshContent()):new c.y(t.error||"Failed to delete payment method.","error")}catch(e){new c.y("Failed to delete payment method.","error")}}))};renderInvoicesSection=e=>{const t=document.createElement("div");if(t.className="space-y-4",this.invoices&&0!==this.invoices.length){const e=document.createElement("div");e.className="space-y-3";const s=o.A.name("circleDown");this.invoices.forEach((t=>{const i=document.createElement("div");i.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex justify-between items-center`;const a=document.createElement("div");a.className="flex-1";const o=document.createElement("div");o.className=`font-medium ${this.theme.text}`;const r=new Date(t.created);o.textContent=r.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});const l=document.createElement("div");l.className=`${this.theme.fadedText} text-sm mt-1`,l.textContent=`${t.description||"Invoice"}  $${t.amount_paid?t.amount_paid.toFixed(2):"0.00"}  ${t.status.charAt(0).toUpperCase()+t.status.slice(1)}`,a.appendChild(o),a.appendChild(l);const c=new n.$({svgPathData:s.path,svgViewBox:s.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-6 h-6"});t.invoice_pdf||t.hosted_invoice_url?c.onClick((()=>{window.open(t.invoice_pdf||t.hosted_invoice_url,"_blank")})):(c.config.disabled=!0,c.element.classList.add("opacity-50","cursor-not-allowed"));const d=document.createElement("div");c.render(d),i.appendChild(a),i.appendChild(d),e.appendChild(i)})),t.appendChild(e)}else{const e=document.createElement("div");e.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-6 text-center`;const s=document.createElement("p");s.className=this.theme.fadedText,s.textContent="No invoices available",e.appendChild(s),t.appendChild(e)}e.appendChild(t)};transformWorkspaceUsageData(e){const{usage:t,limits:s,limits_reset_date:i}=e,n=e=>null!=e?e.toLocaleString():"Unlimited";return{formatted:{current_usage:{frontier_input_tokens:t.input_tokens.toLocaleString(),frontier_output_tokens:t.output_tokens.toLocaleString(),premium_images:t.images.toLocaleString()},limits:{frontier_input_tokens:n(s.input_tokens),frontier_output_tokens:n(s.output_tokens),premium_images:n(s.images)},next_reset:i?new Date(i).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"}):"N/A"},percentages:{frontier_input_tokens:s.input_tokens>0?t.input_tokens/s.input_tokens*100:0,frontier_output_tokens:s.output_tokens>0?t.output_tokens/s.output_tokens*100:0,premium_images:s.images>0?t.images/s.images*100:0}}}renderUsageHistoryContent=e=>{const t=document.createElement("div");if(t.className="space-y-3",null===this.usageHistory)return t.innerHTML=`<div class="text-center ${this.theme.fadedText} p-4">Could not load usage history.</div>`,void e.appendChild(t);if(0===this.usageHistory.length)t.innerHTML=`<div class="text-center ${this.theme.fadedText} p-4">No usage history available.</div>`;else{const e={};this.usageHistory.forEach((t=>{const s=new Date(t.date_used).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});e[s]||(e[s]={entries:[],totals:{input:0,output:0,premium:0}}),e[s].entries.push(t),"token"===t.type&&t.frontier_model?(e[s].totals.input+=t.input_tokens,e[s].totals.output+=t.output_tokens):"image"===t.type&&t.frontier_model&&(e[s].totals.premium+=t.quantity||1)}));const s=Object.keys(e).sort(((e,t)=>new Date(t)-new Date(e)));let i=0;s.forEach((s=>{if(i>=200)return;const n=e[s],a=document.createElement("div");a.className=`${this.theme.listTableItem} ring-1 rounded-lg p-4`;const l=document.createElement("div");l.className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2";const c=document.createElement("h4");c.className=`font-medium ${this.theme.text}`,c.textContent=s;const d=document.createElement("div");d.className=`text-sm ${this.theme.fadedText} flex flex-wrap gap-4`,d.innerHTML=`\n                    <span>${n.totals.input.toLocaleString()} input</span>\n                    <span>${n.totals.output.toLocaleString()} output</span>\n                    <span>${n.totals.premium.toLocaleString()} premium</span>\n                `,l.appendChild(c),l.appendChild(d),a.appendChild(l),t.appendChild(a);const h=document.createElement("div");h.className="space-y-2 pt-2",n.entries.sort(((e,t)=>new Date(t.date_used)-new Date(e.date_used))).forEach((e=>{if(i>=200)return;i++;const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} border ${this.theme.tableCardBorder} rounded-lg p-3 ${this.theme.tableHoverBackground}`;const s=document.createElement("div");s.className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2";const n=document.createElement("div");n.className="flex items-center gap-3";const a=document.createElement("div");a.className=`text-sm ${this.theme.fadedText} min-w-[60px]`,a.textContent=new Date(e.date_used).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});const l=document.createElement("div");l.className="flex flex-col";const c=document.createElement("div");c.className="flex items-center flex-wrap gap-2";let d=e.model;"image"===e.type?d="dalle3"===d?"DALL-E 3":"ideogram"===d?"Ideogram":d.charAt(0).toUpperCase()+d.slice(1):d.startsWith("gpt-")?d=d.replace("gpt-","GPT ").toUpperCase():(d.includes("claude")||d.includes("gemini"))&&(d=d.replace(/-/g," "),d=d.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "));const m=document.createElement("span");if(m.className=`text-sm font-medium ${e.frontier_model?this.theme.text:this.theme.fadedText}`,m.textContent=d,c.appendChild(m),e.frontier_model){const e=document.createElement("span");e.className=`px-2 py-0.5 text-xs rounded-full ${this.theme.skillTag} font-medium`,e.textContent="Frontier",c.appendChild(e)}if(e.from_recharge||"token_recharge"===e.usage_type){const e=document.createElement("span");e.className=`px-2 py-0.5 text-xs rounded-full ${this.theme.cpuActionClick} font-medium flex items-center gap-1`;const t=o.A.name("bolt");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-2.5 h-2.5"}).render(e),e.appendChild(document.createTextNode("Recharge tokens used")),c.appendChild(e)}const u=document.createElement("div");u.className=`text-xs ${this.theme.fadedText}`;let p=e.usage_type||"";"token_recharge"===p&&(p="Chat");let g=p.replace(/_/g," ");u.textContent=g.charAt(0).toUpperCase()+g.slice(1),l.appendChild(c),u.textContent&&l.appendChild(u),n.appendChild(a),n.appendChild(l);const f=document.createElement("div");f.className="flex items-center gap-4 text-sm","token"===e.type?f.innerHTML=`\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Input</span>\n                                <span class="font-medium ${this.theme.text}">${e.input_tokens.toLocaleString()}</span>\n                            </div>\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Output</span>\n                                <span class="font-medium ${this.theme.text}">${e.output_tokens.toLocaleString()}</span>\n                            </div>\n                        `:f.innerHTML=`\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Premium</span>\n                                <span class="font-medium ${this.theme.text}">${e.quantity||1}</span>\n                            </div>\n                        `,s.appendChild(n),s.appendChild(f),t.appendChild(s),h.appendChild(t)})),t.appendChild(h)}));const n=document.createElement("div");n.className=`${this.theme.tableCardBackground} border ${this.theme.tableCardBorder} rounded-lg p-4`;const a=o.A.name("info"),l=document.createElement("div");l.className="flex items-start gap-3";const c=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-5 h-5 flex-shrink-0 mt-0.5",colorClass:this.theme.iconColor}),d=document.createElement("div");d.className=`text-sm ${this.theme.fadedText} leading-relaxed`,d.textContent="Last 200 items shown. Only frontier models and premium tokens (for images/video etc) count against your monthly limits. To conserve tokens, consider using non-frontier models for general conversation or tasks that require less intelligence.",c.render(l),l.appendChild(d),n.appendChild(l),t.appendChild(n)}e.appendChild(t)};renderCombinedUsageSection=e=>{if(!this.usageData)return void this.renderErrorState("Usage data not available");const t=document.createElement("div");t.className="space-y-2";const s=document.createElement("div"),i=document.createElement("div");i.className=`text-lg font-medium ${this.theme.text}`,i.textContent="Usage this period";const n=document.createElement("div");n.className=`${this.theme.fadedText} text-sm`,n.textContent=`Tokens next reset on ${this.usageData.formatted.next_reset}`,s.appendChild(i),s.appendChild(n);const a=document.createElement("div");a.className=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full space-y-4`;const l=this.usageData.recharge_details?.input_tokens_remaining||0,c=this.usageData.recharge_details?.output_tokens_remaining||0,d=this.usageData.recharge_details?.premium_images_remaining||0,h=[{label:"Frontier input tokens",current:this.usageData.formatted.current_usage.frontier_input_tokens,max:this.usageData.formatted.limits.frontier_input_tokens,percentage:this.usageData.percentages.frontier_input_tokens,additional:l,type:"input"},{label:"Frontier output tokens",current:this.usageData.formatted.current_usage.frontier_output_tokens,max:this.usageData.formatted.limits.frontier_output_tokens,percentage:this.usageData.percentages.frontier_output_tokens,additional:c,type:"output"},{label:"Premium tokens",current:this.usageData.formatted.current_usage.premium_images,max:this.usageData.formatted.limits.premium_images,percentage:this.usageData.percentages.premium_images,additional:d,type:"premium"}];h.forEach(((e,t)=>{const s=document.createElement("div");t<h.length-1&&(s.className="pb-4");const i=document.createElement("div");i.className="flex justify-between items-center text-base mb-2";const n=e.additional>0,l=n?e.additional.toLocaleString():"0",c=document.createElement("span");c.className=`font-medium ${this.theme.text}`,c.textContent=e.label;const d=document.createElement("div");d.className="flex items-center gap-1.5";const m=document.createElement("span");if(m.className=`text-sm ${this.theme.fadedText}`,m.textContent=`${e.current} / ${e.max}`,d.appendChild(m),n){const e=document.createElement("span");e.className=`${this.theme.skillTag} px-1.5 py-0.5 text-xs rounded-md font-medium flex items-center gap-1`;const t=o.A.name("plus");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-2.5 h-2.5"}).render(e),e.appendChild(document.createTextNode(l)),d.appendChild(e)}i.appendChild(c),i.appendChild(d);const u=document.createElement("div");u.className=`h-3 w-full ${this.theme.sliderRailColor} rounded-full overflow-hidden`;const p=document.createElement("div");if(p.className="h-full rounded-full transition-all duration-300",e.percentage>=90?p.className+=" bg-red-500":e.percentage>=75?p.className+=" bg-yellow-500":p.className+=` ${this.theme.progressBarBackground}`,p.style.width=`${Math.min(e.percentage,100)}%`,u.appendChild(p),s.appendChild(i),s.appendChild(u),n){const t=document.createElement("div");t.className=`text-xs ${this.theme.successText} mt-2`;const i="premium"===e.type?"premium image tokens":`${e.type} tokens`;t.textContent=`You have ${l} additional ${i} from recharges.`,s.appendChild(t)}a.appendChild(s)})),t.appendChild(s),t.appendChild(a);const m=document.createElement("h3");m.className=`text-lg font-medium ${this.theme.text} mb-1 mt-8 pt-2`,m.textContent="Usage history",t.appendChild(m),this.renderUsageHistoryContent(t),e.appendChild(t)};renderRechargeSection=e=>{this.isInitializingRechargeSwitch=!0;const t=document.createElement("h3");t.className=`text-lg font-medium ${this.theme.text} mb-3 mt-6`,t.textContent="Plan addons and recharge options",e.appendChild(t);const s=document.createElement("div");s.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 mb-3`;const i=document.createElement("div");i.className="flex justify-between items-start";const a=document.createElement("div");a.className="flex flex-col gap-1";const l=document.createElement("div");l.className=`text-base font-medium ${this.theme.text}`,l.textContent="Enable auto-recharge";const c=document.createElement("div");c.className=`text-sm ${this.theme.fadedText} mr-10`,c.textContent="When you are running low on tokens, we will automatically recharge your account with a new token pack using your primary payment method. You can disable this at any time.",a.appendChild(l),a.appendChild(c);const d=document.createElement("div");d.className="flex items-center";const h=this.isRechargeEnabled||!1,m=new C({label:"",value:h,size:"medium"});m.onChange((e=>{this.handleRechargeToggleChange(e)})),m.render(d),i.appendChild(a),i.appendChild(d),s.appendChild(i),e.appendChild(s);const u=document.createElement("div");u.className="space-y-3";const p=document.createElement("div");p.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`;const g=document.createElement("div");g.className="flex items-center gap-4";const f=o.A.name("coin");new r.I({pathData:f.path,viewBox:f.viewBox,sizeClasses:"w-8 h-8 flex-shrink-0",colorClass:this.theme.iconColor}).render(g);const v=document.createElement("div");v.className="flex flex-col";const y=document.createElement("span");y.className=`font-medium ${this.theme.text}`,y.textContent="Input/output credits";const w=document.createElement("span");w.className=`text-sm ${this.theme.fadedText}`,w.textContent="5M input tokens + 1M output tokens",v.appendChild(y),v.appendChild(w),g.appendChild(v);const b=document.createElement("div");b.className="flex flex-col items-end gap-2 self-end sm:self-center";const x=document.createElement("div");x.className=`text-base ${this.theme.text}`,x.textContent="$25 USD",b.appendChild(x);const k=new n.$({text:"Buy now",size:"medium",type:"secondary"});k.onClick((async()=>{try{await this.handleRecharge("tokens")}catch(e){}})),k.render(b),p.appendChild(g),p.appendChild(b);const E=document.createElement("div");E.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`;const S=document.createElement("div");S.className="flex items-center gap-4";const T=o.A.name("sparkles");new r.I({pathData:T.path,viewBox:T.viewBox,sizeClasses:"w-8 h-8 flex-shrink-0",colorClass:this.theme.iconColor}).render(S);const L=document.createElement("div");L.className="flex flex-col";const _=document.createElement("span");_.className=`font-medium ${this.theme.text}`,_.textContent="Premium tokens";const I=document.createElement("span");I.className=`text-sm ${this.theme.fadedText}`,I.textContent="1,500 tokens for images, videos, paid MCPs and more",L.appendChild(_),L.appendChild(I),S.appendChild(L);const A=document.createElement("div");A.className="flex flex-col items-end gap-2 self-end sm:self-center";const M=document.createElement("div");M.className=`text-base ${this.theme.text}`,M.textContent="$20 USD",A.appendChild(M);const B=new n.$({text:"Buy now",size:"medium",type:"secondary"});B.onClick((async()=>{try{await this.handleRecharge("premium")}catch(e){}})),B.render(A),E.appendChild(S),E.appendChild(A),u.appendChild(p),u.appendChild(E),e.appendChild(u);const D=document.createElement("div");D.className=`mt-4 p-3 rounded-md ${this.theme.toastInfo} text-sm`;const $=o.A.name("info"),P=document.createElement("div");P.className="flex items-start gap-2";const N=new r.I({pathData:$.path,viewBox:$.viewBox,sizeClasses:"w-4 h-4 flex-shrink-0 mt-0.5",colorClass:"text-blue-600"}),z=document.createElement("div");z.className="leading-relaxed recharge-info-text",h?z.innerHTML="<strong>Auto-recharge is enabled.</strong> We'll automatically purchase tokens when you're running low to prevent service interruptions. Recharge tokens expire 12 months from purchase and are non-refundable.":z.textContent="Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens cannot be refunded.",N.render(P),P.appendChild(z),D.appendChild(P),e.appendChild(D)};handleRechargeToggleChange=e=>{clearTimeout(this.rechargeToggleTimeout),this.rechargeToggleTimeout=setTimeout((async()=>{try{const t=await u.K.updateAutomaticRecharge(e);if(!t.success)throw new Error(t.error||"Failed to update auto-recharge setting.");{await this.fetchPlanData();const t=document.querySelector(".user-settings-container .recharge-info-text");t&&(e?t.innerHTML="<strong>Auto-recharge is enabled.</strong> We'll automatically purchase tokens when you're running low to prevent service interruptions. Recharge tokens expire 12 months from purchase and are non-refundable.":t.textContent="Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens cannot be refunded.")}}catch(e){new c.y(e.message,"error"),this.refreshContent()}}),500)};renderPlansComparison=e=>{const t=document.createElement("div");t.className="flex flex-col sm:flex-row gap-4 mt-6";let s=this.currentPlanID,i=!0,n=!1;"trial"===this.currentPlanID&&(s="member",i=!1,n=!0);const a=this.renderPlanCard(s,i,n);if(t.appendChild(a),"max"!==s){let e=this.getNextPlanID();if("trial"===this.currentPlanID&&(e="pro"),e){const s=this.renderPlanCard(e,!1,n);t.appendChild(s)}}else a.classList.remove("sm:w-1/2"),a.classList.add("sm:w-full");e.appendChild(t)};renderPlanCard=(e,t,s)=>{let i=this.planConfig[e];i||(i={name:"Unknown",monthly:{price:0},quarterly:{price:0},annual:{save:0},features:["Unknown"]});const a=document.createElement("div");a.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 flex flex-col w-full sm:w-1/2`;const l=document.createElement("div");if(l.className=s?"mb-2 flex items-start":"mb-2 h-6 flex items-start",t){const e=document.createElement("div");e.classList=`${this.theme.tabSelectedBackground} rounded-full px-2 py-0.5 text-xs font-medium flex items-center`,e.textContent=this.willCancelAtPeriodEnd?"Expiring this plan":"Current plan",l.appendChild(e)}a.appendChild(l);const c=document.createElement("div");c.className="flex justify-between items-center mb-3";const d=document.createElement("div");d.className="font-bold text-lg",d.textContent=i.name||"Unknown";const h=document.createElement("div");let m;if(h.className="text-xl font-bold",m="Creator plan (legacy)"===i.name?"":t?"annual"===this.billingCycle?i.annual.price:"quarterly"===this.billingCycle?i.quarterly.price:i.monthly.price:i.annual.price,h.textContent=m?`$${m}/mo`:"",c.appendChild(d),c.appendChild(h),a.appendChild(c),t){if(this.willCancelAtPeriodEnd){const e=document.createElement("div");e.className="flex items-center gap-2 mb-4";const t=new n.$({text:"Resume plan",size:"small",type:"primary"});t.onClick((async()=>{await this.resumePlan(this.currentPlanID),a.removeChild(e)})),t.render(e),a.appendChild(e)}else if(!this.isAnnual&&"trial"!==this.currentPlanID&&"creator"!==this.currentPlanID){const e=document.createElement("div");e.className="flex items-center gap-2 mb-4";const t=new n.$({text:"Switch to annual",size:"small",type:"primary"});t.onClick((async()=>{t.toggleLoading(),this.upgradeButton=t,await this.upgradePlan(this.currentPlanID,!0)}));const s=document.createElement("span");s.className=`text-sm ${this.theme.successText}`,s.textContent=`Save $${i.annual.save}`,t.render(e),e.appendChild(s),a.appendChild(e)}}else{this.nextPlanBillingCycle="annual";const t=document.createElement("div");t.className="flex items-center gap-2 mb-2";const o=new n.$({text:s?"Subscribe":"Upgrade plan",size:"small",type:"primary"});s?o.onClick((()=>{const e=window.location.hostname.match(/localhost/);if("annual"===this.nextPlanBillingCycle){const t=e?i.annual.pid:i.annual.prpid;window.location.href=`/accounts/account/pay/annual/${t}`}else{const t=e?i.monthly.pid:i.monthly.prpid;window.location.href=`/accounts/account/pay/monthly/${t}`}})):o.onClick((async()=>{o.toggleLoading(),this.upgradeButton=o,await this.upgradePlan(e)}));const r=document.createElement("span");r.className=`text-sm ${this.theme.successText}`,r.textContent=`Save $${i.annual.save}/year`,o.render(t),t.appendChild(r),a.appendChild(t)}const u=document.createElement("div");u.className="space-y-2 pt-6";const p=o.A.name("checkCircle");return i.features.forEach((e=>{const t=document.createElement("div");t.className="flex items-center gap-2 text-sm leading-5";const s=new r.I({pathData:p.path,viewBox:p.viewBox,sizeClasses:"w-3.5 h-3.5",colorClass:this.theme.iconColor}),i=document.createElement("span");i.textContent=e,s.render(t),t.appendChild(i),u.appendChild(t)})),a.appendChild(u),a};getNextPlanID=()=>{const e=["member","pro","max"];if("trial"===this.currentPlanID)return"member";if("creator"===this.currentPlanID)return"max";let t=e.indexOf(this.currentPlanID);return t<e.length-1?e[t+1]:null};handleRecharge=async e=>{const t=document.createElement("div");t.classList="py-3";const s="tokens"===e,i=s?"5M Input and 1M output token recharge":"Premium tokens",a=s?"$25":"$20",r=s?"By recharging you will be credited with an additional 5M input and 1M output tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when you are over your existing monthly limits.":"By recharging you will be credited with 1,500 additional premium tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when you are over your existing monthly limits.",c=o.A.name("info");t.innerHTML=`\n            <div class="flex flex-col gap-4"><div class="flex flex-row items-center gap-4"><div class="flex-1 ${this.theme.secondaryBackground} rounded-md p-4"><div class="font-bold mb-0.5">${i}</div><div class="text-sm ${this.theme.fadedText} mb-3">${r}</div><div class="font-bold text-lg">${a} USD</div></div></div><div class="p-3 rounded-md ${this.theme.toastInfo} text-sm"><div class="flex items-start gap-2"><div><svg viewBox="${c.viewBox}" class="w-4 h-4 fill-current"><path d="${c.path}"></path></svg></div><div>Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens can not be refunded.</div></div></div><div id="recharge-error" class="hidden p-3 rounded-md bg-red-100 text-red-800 text-sm"></div></div>\n        `;const d=new l({size:"small",title:"Recharge now",body:t,closeX:!0,confirm:!0,cancel:!1,confirmText:`Recharge now for ${a}`,buttonWidth:"full",buttonStyle:"primary",buttonSize:"large",manualCloseOnConfirm:!0});return new Promise(((t,i)=>{let r=!1,l=!1;d.onConfirm((async()=>{try{if(l)return;l=!0,d.updateConfirmButtonText("Processing...");document.getElementById("recharge-error").classList.add("hidden");const i=await u.K.recharge(s?"tokens":"premium");if(!i.success)throw new Error(i.error||"Failed to process recharge");r=!0,d.close(),this.showRechargeSuccess(e),t(!0)}catch(e){l=!1,d.updateConfirmButtonText(`Purchase for ${a}`);let t=e.message||"An error occurred while processing your payment.",s=!1;(t.includes("card was declined")||t.includes("Request req_"))&&(s=!0,t="Your card was declined. Please update your payment method.");const i=document.getElementById("recharge-error"),r=o.A.name("error");let c=`<div class="flex flex-col gap-3"><div class="flex items-start gap-2"><div><svg viewBox="${r.viewBox}" class="w-4 h-4 fill-current text-red-500"><path d="${r.path}"></path></svg></div><div>${t}</div></div>`;if(s&&(c+='<div id="update-payment-button-container" class="flex justify-center mt-2"></div>'),c+="</div>",i.innerHTML=c,i.classList.remove("hidden"),s){const e=document.getElementById("update-payment-button-container"),t=o.A.name("edit"),s=new n.$({text:"Update payment method",type:"link",size:"link-sm",svgPathData:t.path,svgViewBox:t.viewBox});s.onClick((()=>{this.switchSection("payment"),d.close()})),s.render(e)}}})),d.onClose((()=>{r||(d.wasCancelled?i(new Error("Recharge cancelled")):i(new Error("Modal closed without recharging")))}))}))};showRechargeSuccess=e=>{const t="tokens"===e?"Input/output credits":"Premium tokens",s=document.createElement("div");s.className="flex flex-col items-center justify-center align-middle space-y-4 h-[250px]";const i=document.createElement("div");i.className="py-4 flex flex-col items-center gap-4 px-10";const n=document.createElement("div"),a=o.A.name("success"),c=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-20 h-20"});n.appendChild(c.element);const d=document.createElement("div"),h=document.createElement("div");h.className="font-bold text-lg text-center",h.textContent=`${t} recharge successful!`;const m=document.createElement("div");m.className=`${this.theme.fadedText} text-base text-center`,m.textContent="Your additional credits have been added to your account.",d.appendChild(h),d.appendChild(m),i.appendChild(n),i.appendChild(d),s.appendChild(i);new l({size:"medium",title:"",closeX:!0,confirmOnExit:!1,body:s}),new H.N;setTimeout((async()=>{await this.refreshUsageData()}),2500)};refreshUsageData=async()=>{try{this.usageData=null,await this.loadUsageData(),"usage"===this.activeSection&&this.refreshContent()}catch(e){}};upgradePlan=async(e,t=!1)=>{try{await this.showPlanUpgradeModal(e,t),this.upgradeButton&&(this.upgradeButton.toggleLoading(!1),this.upgradeButton=null),this.showSuccessMessage(e,t?"annual":this.billingCycle,"upgrade")}catch(e){this.upgradeButton&&(this.upgradeButton.toggleLoading(!1),this.upgradeButton=null)}};resumePlan=async e=>{try{await g.G.postData("/accounts/account/resume",{billing_cycle:this.billingCycle}),this.showSuccessMessage(e,this.billingCycle,"resume")}catch(e){new c.y("An error occurred while resuming your plan. Please try again.","error")}};showSuccessMessage=(e,t,s)=>{const i=this.planConfig[e],n=document.createElement("div");n.className="flex flex-col items-center justify-center align-middle space-y-4 h-[250px]";const a=o.A.name("success");n.innerHTML="upgrade"===s?`\n            <div class="py-4 flex flex-col items-center gap-4 px-10"><div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div><div><div class="font-bold text-lg text-center">You've successfully been upgraded to the ${i.name}.</div><div class="${this.theme.fadedText} text-base text-center">Your new plan features and limits are now available.</div></div></div>\n            `:"resume"===s?`\n            <div class="py-4 flex flex-col items-center gap-4 px-10"><div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div><div><div class="font-bold text-lg text-center">You've successfully resumed your plan.</div><div class="${this.theme.fadedText} text-base text-center">Your plan is active and will continue to renew.</div></div></div>\n            `:`\n            <div class="py-4 flex flex-col items-center gap-4 px-10"><div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div><div><div class="font-bold text-lg text-center">Your plan has been switched to annual billing successfully.</div></div></div>\n            `;new l({size:"medium",title:"",closeX:!0,confirmOnExit:!1,body:n}),new H.N;setTimeout((async()=>{await this.refreshPlanData()}),2500)};fetchPlanData=async()=>{try{const e=await g.G.postData("/accounts/account/refresh",{});this.currentPlanID=e.currentPlanID,this.billingCycle=e.billingCycle,this.nextBillingDate=e.nextBillingDate,this.isAnnual=e.isAnnual,this.isRechargeEnabled=e.autoRechargeEnabled??!1,this.planInfo=this.planConfig[this.currentPlanID]}catch(e){throw new Error("Could not fetch plan information.")}};refreshPlanData=async()=>{try{await this.fetchPlanData(),"plan"===this.activeSection&&this.refreshContent()}catch(e){new c.y(e.message,"error")}};showPlanUpgradeModal=async(e,t=!1)=>new Promise(((e,t)=>{e(!0)}));loadUsageHistoryData=async()=>{if(!this.usageHistory)try{const e=await u.K.getUsageLog();if(!e.success)throw new Error(e.error||"Failed to load usage history.");this.usageHistory=e.history}catch(e){throw this.usageHistory=null,e}};toggleSidebar=(e=null)=>{const t=null!==e?e:!this.sidebarVisible;this.sidebarVisible=t,this.mobileSidebar&&this.sidebarOverlay&&(t?(this.mobileSidebar.classList.remove("-translate-x-full"),this.mobileSidebar.classList.add("translate-x-0"),this.sidebarOverlay.classList.remove("hidden")):(this.mobileSidebar.classList.remove("translate-x-0"),this.mobileSidebar.classList.add("-translate-x-full"),this.sidebarOverlay.classList.add("hidden")))};handleResize=()=>{window.innerWidth>=768&&this.sidebarVisible&&this.toggleSidebar(!1)};handleKeyDown=e=>{"Escape"===e.key&&(this.sidebarVisible?this.toggleSidebar(!1):this.close())};show=()=>{this.container&&this.settingsEl&&(document.addEventListener("keydown",this.handleKeyDown),document.body.classList.add("overflow-hidden"),this.container.style.opacity="0",this.settingsEl.style.transform="scale(0.95)",this.settingsEl.style.opacity="0",requestAnimationFrame((()=>{this.container.style.transition="opacity 0.2s ease-out",this.settingsEl.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out",this.container.style.opacity="1",this.settingsEl.style.opacity="1",this.settingsEl.style.transform="scale(1)"})))};close=async()=>{this.isDestroyed||(this.saveTimeout?(clearTimeout(this.saveTimeout),this.saveTimeout=null,await this.handleAutoSave(!1)):this.isDirty&&await this.handleAutoSave(!1),this.container&&this.settingsEl&&(this.container.style.transition="opacity 0.2s ease-in",this.settingsEl.style.transition="opacity 0.2s ease-in, transform 0.2s ease-in",this.container.style.opacity="0",this.settingsEl.style.transform="scale(0.95)",setTimeout((()=>{this.destroy()}),200)))};destroy=()=>{this.isDestroyed||(this.isDestroyed=!0,document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),document.body.classList.remove("overflow-hidden"),this.container?.parentNode&&this.container.parentNode.removeChild(this.container),Object.keys(this).forEach((e=>{this[e]=null})))}}class j{constructor(e,t,s,i,n){if(this.planConfig=O.l.getPlans(!0).individual,this.usage=t,this.chat_id=s,this.upgradeReason=e,this.upgradeReasonDescripton=i||"",this.plans=O.l.getPlans().individual,this.currentPlanID=window.user.billing.plan_id||"member",this.billingCycle="annual",this.hasPermissionToUpgrade=u.K.hasPermission("workspace:billing"),this.currentBillingCycle=window.user.billing.billing_cycle||"monthly",this.workspaceContext=!!window.workspace_context,this.resetDate=n||null,this.resetDate){const e=new Date(this.resetDate),t={year:"numeric",month:"long",day:"numeric"};this.resetDate=e.toLocaleDateString("en-US",t)}this.upgradeButtons=[],this.billingCycleToggleRegistry=[],this.overlay=null,this.render()}render(){this.setModalContent(),this.renderOverlay()}setModalContent(){const e=this.usage&&null!=this.usage.skill_count?this.usage.skill_count:null,t=this.usage&&null!=this.usage.max_allowed?this.usage.max_allowed:null,s=null!=e&&null!=t?` (${e}/${t} used)`:"",i=this.resetDate?` It resets on ${this.resetDate}.`:"";if(this.isHighestPlan()&&!["workspace","workspace_limit","personal_workspace_limit"].includes(this.upgradeReason))return this.modelTitle="You've Reached Your Limit",void(this.bodyText="You've reached your monthly usage limit. Since you're on our highest plan, you can recharge or enable auto recharge to continue.");switch(this.upgradeReason){case"model_limit":this.modelTitle="Monthly Model Limit Reached",this.bodyText="You've reached your plan's premium model limit for this month. To continue, please upgrade to a higher plan or wait for your limit to reset. We've switched you to a standard model for now.";break;case"computer":this.modelTitle="Upgrade to Use This Feature",this.bodyText="Workspace computer use is not included on your current plan. This feature is in an early alpha and by invite only. Upgrading will not guarantee access.";break;case"voice":this.modelTitle="Upgrade to Use Voice",this.bodyText="Voice mode is not included on your current plan. To gain access, please upgrade your plan.";break;case"web_crawl":case"crawl":case"youtube":this.modelTitle="Upgrade to Use This Feature",this.bodyText="Web crawling, including YouTube video analysis, is not available on your current plan. Please upgrade to unlock this feature.";break;case"premium_image":if(this.workspaceContext){const e=this.hasPermissionToUpgrade?" You can manage billing for this workspace below.":" Please contact your workspace administrator.";this.modelTitle="You don't have enough premium tokens to use this feature",this.bodyText=`Your workspace has no premium tokens left${s}.${i}${e}`}else this.modelTitle="You don't have enough premium tokens to use this feature",this.bodyText="Add premium tokens to your account or wait for your plan to reset. Note: some premium features require minimum token balances to use.";break;case"frontier":this.modelTitle="You've exhausted your monthly token limit",this.bodyText="Please upgrade to continue, recharge tokens or switch to a different model.";break;case"frontier-o1":this.modelTitle="Update Your Plan",this.bodyText="OpenAI's o1 and o3 models are exclusive to our Pro and Max plans. Please upgrade to use these advanced models.";break;case"personal_workspace_limit":this.modelTitle="You've reached your monthly usage limit",this.bodyText=`Your limit will next reset on ${this.resetDate}. <BR />Contact your administrator to increase your limit.`;break;case"workspace_limit":this.modelTitle="Workspace limit reached",this.bodyText=`The limit for this workspace has been reached for this month. <BR />It will reset ${this.resetDate}. <BR />Please contact your administrator to discuss increasing your limit.`;break;case"untrusted":this.modelTitle="Your workspace requires review",this.bodyText="To stop abuse we manually review all new workspaces. Please contact support to request activation. Include information about your business and team size to expedite your review.";break;case"workspace":this.isHighestPlan()?(this.modelTitle="Highest Plan Limit Reached",this.bodyText="You're a power AI workspace user! You've hit the highest rate limit for this model. If you think this is a mistake or would like to discuss an increase, please create a support ticket. Your limit will reset in 24 hours."):(this.modelTitle="Workspace limit reached",this.bodyText=this.upgradeReasonDescripton||`The limit for this workspace has been reached for this month.${i}`);break;default:this.modelTitle="Plan limit reached",this.bodyText="You've reached a limit on your current plan. To continue without interruption, please upgrade your plan or switch to a different feature."}}renderOverlay(){this.overlay=document.createElement("div"),this.overlay.className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4",this.overlay.id="upgrade-modal-overlay",this.overlay.addEventListener("click",(e=>{e.target===this.overlay&&this.close()}));const e=document.createElement("div");e.className="relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden max-h-[90vh] flex flex-col";const t=this.createOverlayContent();e.appendChild(t);const s=this.createCloseButton();e.appendChild(s),this.overlay.appendChild(e),document.body.appendChild(this.overlay),this.overlay.style.opacity="0",this.overlay.style.transition="opacity 0.3s ease-out",requestAnimationFrame((()=>this.overlay.style.opacity="1"))}createOverlayContent(){const e=document.createElement("div");e.className="p-8 lg:p-12 overflow-y-auto",e.innerHTML=`\n            <div class="text-center">\n                <h1 class="text-4xl font-medium tracking-tighter text-black mb-2">${this.modelTitle}</h1>\n                <p class="text-lg text-gray-600 leading-relaxed max-w-3xl mx-auto">${this.bodyText}</p>\n            </div>\n        `;const t=!this.workspaceContext||"Personal"===window.workspace?.name;if("untrusted"===this.upgradeReason)e.appendChild(this.createContactSupportButton());else if(this.workspaceContext&&(["workspace","workspace_limit","personal_workspace_limit"].includes(this.upgradeReason)||"premium_image"===this.upgradeReason))this.hasPermissionToUpgrade&&e.appendChild(this.createManageWorkspaceButton());else if(t&&this.hasPermissionToUpgrade)if(this.isHighestPlan()){const t=document.createElement("div");t.className="flex justify-center items-center gap-4 mt-8";const s=new n.$({text:"Recharge tokens",type:"primary",size:"extraLarge",additionalClasses:"w-full sm:w-auto"});s.onClick((()=>{this.close(),new q("plan")})),s.render(t),e.appendChild(t)}else e.appendChild(this.createActionButtons());return e}createContactSupportButton(){const e=document.createElement("div");e.className="flex justify-center mt-8";const t=new n.$({text:"Request activation",type:"primary",size:"extraLarge",additionalClasses:"w-full sm:w-auto"});return t.onClick((()=>{this.close();const e=`My workspace trial for "${window.workspace?.name||"my workspace"}" needs to be activated. Please let me know when this is done.`;new f("Workspace activation request",e,!0)})),t.render(e),e}createManageWorkspaceButton(){const e=document.createElement("div");e.className="text-center mt-8";const t=document.createElement("button");return t.className="px-10 py-3 bg-black hover:bg-blue-600 text-white rounded-full text-base font-medium transition-all duration-300 transform hover:scale-105 shadow-lg",t.textContent="Manage workspace billing",t.onclick=()=>{const e=window.workspace?.slug;e?window.location.href="/chat/workspace/admin/billing":new c.y("Could not find workspace information. Please go to your workspace admin page.","error")},e.appendChild(t),e}createSupportButton(){const e=document.createElement("div");e.className="text-center mt-8";const t=document.createElement("button");return t.className="px-10 py-3 bg-black hover:bg-blue-600 text-white rounded-full text-base font-medium transition-all duration-300 transform hover:scale-105 shadow-lg",t.textContent="Create Support Ticket",t.onclick=()=>{this.close(),new f("Upper limit reached","I have reached the upper limit for the Max plan. Can we discuss increasing this limit?")},e.appendChild(t),e}createActionButtons=()=>{const e=document.createElement("div");e.className="flex flex-col sm:flex-row justify-center items-center gap-4 mt-8";const t=new n.$({text:"Upgrade plan",type:"primary",size:"extraLarge",additionalClasses:"w-full sm:w-auto"});t.onClick((()=>{window.location.href="/accounts/change-plan/"})),t.render(e);const s=new n.$({text:"Recharge tokens",type:"secondary",size:"extraLarge",additionalClasses:"w-full sm:w-auto"});return s.onClick((()=>{this.close(),new q("plan")})),s.render(e),e};isHighestPlan(){const e=["member","pro","max"];return this.currentPlanID===e[e.length-1]}getAvailablePlans(){const e=["member","pro","max"],t=e.indexOf(this.currentPlanID);return-1===t?[]:e.slice(t+1)}async upgradePlan(e,t){const s=this.planConfig[e],i=window.location.hostname.match(/localhost/)?s[t].pid:s[t].prpid;try{const s=await g.G.postData(`/accounts/account/upgrade/${i}`,{billing_cycle:t});if(!s.success)throw new Error(s.error||"Upgrade failed");this.showSuccessMessage(e)}catch(e){new c.y(e.message||"An error occurred. Please try again later.","error"),this.upgradeButtons.forEach((e=>e.disabled=!1));const t=this.upgradeButtons.find((e=>e.textContent.includes(s.name)));t&&(t.innerHTML=`Upgrade to ${s.name}`)}}showSuccessMessage(e){this.close(!0);const t=this.plans[e],s=document.createElement("div");s.className="fixed inset-0 z-[100] flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm p-4";const i=document.createElement("div");i.className="relative w-full max-w-4xl bg-white rounded-2xl shadow-2xl overflow-hidden",i.innerHTML=`\n            <div class="relative">\n                <div class="absolute -z-10 w-[600px] h-[600px] opacity-20 -top-20 -right-20">\n                    <img src="/static/img/sim-bg.png" alt="" class="w-full h-full object-contain">                \n                </div>\n                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 p-8 lg:p-12">\n                    <div class="space-y-6 flex flex-col justify-center">\n                        <div class="space-y-3">\n                             <div class="inline-flex items-center bg-blue-100 text-blue-800 text-sm font-medium px-4 py-2 rounded-full">\n                                <span class="bg-green-300 text-green-800 w-5 h-5 flex items-center justify-center rounded-full mr-2"></span>\n                                <span class="font-medium tracking-tight">Upgrade Successful!</span>\n                            </div>\n                            <h1 class="text-4xl font-medium tracking-tighter leading-tight text-black">Welcome to the ${t.name}</h1>\n                            <p class="text-lg text-gray-600 leading-relaxed">You're all set! Your new limits and features are ready to go.</p>\n                        </div>\n                        <div class="space-y-2 pt-2">\n                             ${t.features.slice(0,3).map((e=>`\n                                <div class="flex gap-3 items-center text-sm text-gray-800">\n                                    <div><i class="fa-solid fa-check-circle text-blue-500"></i></div>\n                                    <div>${e.replace("Everything in Member, plus:","<strong>Everything in Member, plus:</strong>").replace("Everything in Pro, plus:","<strong>Everything in Pro, plus:</strong>")}</div>\n                                </div>\n                            `)).join("")}\n                        </div>\n                        <div class="pt-4">\n                            <button id="startExploringBtn" class="w-full sm:w-auto px-10 py-3 bg-black hover:bg-blue-600 text-white rounded-full text-base font-medium transition-all duration-300 transform hover:scale-105 shadow-lg">Let's go! </button>\n                        </div>\n                    </div>\n                    <div class="hidden lg:flex items-center justify-center">\n                        <div class="relative">\n                            <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-purple-600 rounded-2xl transform -rotate-3 opacity-20"></div>\n                            <img src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1752468861/website/new%20home/agentic-task-clean_oqfiwn.png" alt="Simtheory AI Workspace" class="relative rounded-2xl shadow-xl w-full max-w-md transform hover:scale-105 transition-transform duration-300">\n                        </div>\n                    </div>\n                </div>\n                <button id="successCloseBtn" class="absolute top-5 right-5 w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">\n                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>\n                </button>\n            </div>\n        `,s.appendChild(i),document.body.appendChild(s);const n=()=>{s.style.opacity="0",setTimeout((()=>{document.body.contains(s)&&document.body.removeChild(s),this.chat_id&&g.G.postData(`/chat/${this.chat_id}/reprocess/`,{})}),300)};s.querySelector("#startExploringBtn").addEventListener("click",n),s.querySelector("#successCloseBtn").addEventListener("click",n),s.addEventListener("click",(e=>{e.target===s&&n()})),s.style.opacity="0",s.style.transition="opacity 0.3s ease-out",requestAnimationFrame((()=>s.style.opacity="1")),new H.N}createCloseButton(){const e=document.createElement("button");return e.className="absolute top-5 right-5 w-9 h-9 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors",e.innerHTML='<svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',e.addEventListener("click",(()=>this.close())),e}close(e=!1){this.overlay&&(e?document.body.contains(this.overlay)&&document.body.removeChild(this.overlay):(this.overlay.style.opacity="0",setTimeout((()=>{document.body.contains(this.overlay)&&document.body.removeChild(this.overlay)}),300)))}}class U{constructor(){this.theme=i.A.theme,this.render()}render(){this.modelContent=document.createElement("div"),this.modelContent.classList="flex flex-col py-2",this.modelContent.innerHTML=`\n    <div class="flex flex-col text-base">\n        <div class="${this.theme.toastWarning} p-3 rounded-lg text-base leading-5 mb-3">\n            <div>This feature is in early alpha and highly experimental. Exercise caution. We disclaim all liability for actions taken by you or your AI agents on this computer.</div>\n        </div>\n        <div class="text-lg">When you setup a workspace computer you can:</div>\n\n        <div class="space-y-4 py-4 ml-2">\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8">\n                    <i class="fa-solid fa-cloud-arrow-down fa-lg"></i>\n                </div>\n                <div>Install applications tailored to your needs e.g. VScode, Microsoft Excel</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8">\n                    <i class="fa-solid fa-lock fa-lg"></i>\n                </div>\n                <div>Log in to websites and applications so an AI agent can act on your behalf</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8">\n                    <i class="fa-solid fa-folder fa-lg"></i>\n                </div>\n                <div>Access your files and settings from anywhere</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8">\n                    <i class="fa-solid fa-user fa-lg"></i>\n                </div>\n                <div>Enjoy a personalized experience as it remembers your preferences</div>\n            </div>\n        </div>\n\n        <div class="text-lg">You agree to the following terms of use of this feature:</div>\n\n         <div class="space-y-4 py-4 ml-2">\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8 flex-shrink-0">\n                    <i class="fa-solid fa-check-circle fa-lg"></i>\n                </div>\n                <div>You are responsible for all actions taken with your workspace computer.</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8 flex-shrink-0">\n                    <i class="fa-solid fa-check-circle fa-lg"></i>\n                </div>\n                <div>You agree not to use this feature for any illegal activities.</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8 flex-shrink-0">\n                    <i class="fa-solid fa-check-circle fa-lg"></i>\n                </div>\n                <div>We reserve the right to terminate your access if you violate these terms.</div>\n            </div>\n            <div class="flex items-center gap-2">\n                <div class="flex items-center justify-center w-8 flex-shrink-0">\n                    <i class="fa-solid fa-check-circle fa-lg"></i>\n                </div>\n                <div>During the alpha all workspace computers are complimentary. When this feature is launched it may require a small monthly fee to keep your computer.</div>\n            </div>\n        </div>\n    </div>\n`,this.createComputerModal=new l({size:"medium",title:"Setup your computer",body:this.modelContent,confirm:!0,closeX:!0,confirmText:"I agree, create my workspace computer",cancel:!1,buttonWidth:"full",buttonSize:"large",manualCloseOnConfirm:!1}),this.createComputerModal.onConfirm((()=>{this.createComputer()}))}async createComputer(){if("member"!==window.user.plan){this.showLoadingModal();try{const e=await g.G.fetchData("/accounts/create-computer/");if(e.success&&e.computer);else switch(this.loadingModal.close(),e.error){case"plan":return void new j("computer");case"exists":return void new c.y("A workspace computer already exists for your account.","error");case"no_cpu":return void this.atCapacity();default:new c.y("An error occurred while setting up your computer. Please try again later.","error")}}catch(e){this.loadingModal.close(),new c.y("An error occurred while setting up your computer. Please try again later.","error")}}else new j("computer")}atCapacity(){const e=document.createElement("div");e.innerHTML='\n            <div class="">\n                <div class="text-xl font-bold">Workspace computer alpha completed</div>\n                <div class="text-base pt-2">The workspace alpha is now over. A general release of workspace computer is coming soon.</div\n            </div>\n        ';new l({size:"small",title:"",body:e,confirm:!0,confirmText:"Dismiss",buttonWidth:"full",buttonSize:"large",closeX:!1,cancel:!1})}showLoadingModal(){const e=document.createElement("div");e.classList.add("flex","flex-col","items-center","justify-center","space-y-4");const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","pt-8","pb-6");const s=document.createElement("i");s.classList.add("fa-solid","fa-spinner","fa-spin","fa-3x"),t.appendChild(s);const i=document.createElement("div");i.classList.add("pb-2","text-center"),i.textContent="Please be patient while we setup your computer (it may take a few minutes)",e.appendChild(t),e.appendChild(i),this.loadingModal=new l({size:"small",title:"Setting things up...",body:e,confirm:!1,closeX:!1,cancel:!1,manualCloseOnConfirm:!1})}showSuccessModal(){const e=document.createElement("div");e.classList.add("flex","flex-col","items-center","justify-center");const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","pt-8","pb-2");const s=document.createElement("i");s.classList.add("fa-solid","fa-check-circle","w-20","h-20","text-green-500"),t.appendChild(s);const i=document.createElement("div");i.classList.add("pb-2","text-center"),i.textContent="Your computer is now setup and ready to use.",e.appendChild(t),e.appendChild(i),this.successModal=new l({size:"small",title:"",body:e,confirm:!0,confirmText:"Use workspace computer",closeX:!1,cancel:!1,buttonWidth:"full",buttonSize:"large",manualCloseOnConfirm:!1}),new H.N,this.successModal.onConfirm((()=>{this.successModal.close()}))}}class V{constructor(e,t,s,n,a=!0){this.triggerElement=e,this.onSelectCallback=t,this.onScreenShareCallback=s,this.onVoiceCallback=n,this.theme=i.A.theme,this.menuContainer=null,this.skillListContainer=null,this.footerContainer=null,this.availableSkills=u.K.skills_menu||[],this.isLoading=!1,this._boundHandleOutsideClick=null,this.searchInput=null,this.memoryState=a,this.backspaceCount=0,this.isMobile=u.K.isMobile(),this.highlightedIndex=-1,this.keyboardHighlightClass=this.theme.tableButtonSelectedBackground,this._boundHandleKeyDown=this._handleKeyDown.bind(this),this.init()}async init(){if(this.menuContainer)return void this.removeExisting();this.menuContainer=document.createElement("div"),this.menuContainer.className=`skill-selector-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-lg z-30 text-sm w-64 flex flex-col max-h-[calc(100vh-theme(space.16))] py-1 max-w-[260px] overflow-hidden`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="opacity 0.2s ease-in-out";const e=document.createElement("div");e.className="px-3",this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search skills",this.searchInput.className=`w-full p-2 rounded-md ${this.theme.inputBackground} ${this.theme.text} text-sm border-0 focus:outline-none focus:ring-0 focus:border-0 focus:shadow-none text-medium placeholder:${this.theme.text} placeholder:text-medium`;const t=o.A.name("search");if(t){const s=document.createElement("div");s.className="absolute left-4 top-4 pointer-events-none";const i=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:`${this.theme.text}`});s.appendChild(i.element),e.appendChild(s),this.searchInput.className+=" pl-8"}e.appendChild(this.searchInput),this.menuContainer.appendChild(e),this.skillListContainer=document.createElement("div"),this.skillListContainer.className=`flex-grow overflow-y-auto min-h-[200px] max-h-[200px] pb-1 transition-opacity duration-200 ease-in-out scrollbar-thin ${this.theme.scrollbarThumb} ${this.theme.scrollbarTrack}`,this.menuContainer.appendChild(this.skillListContainer);const s=this._createLoadingIndicator();this.skillListContainer.appendChild(s),this.footerContainer=document.createElement("div"),this.footerContainer.className="flex-shrink-0",this.menuContainer.appendChild(this.footerContainer),document.body.appendChild(this.menuContainer),this._addCloseListener(),await this._loadAndRenderSkills(s),this.searchInput.addEventListener("input",(()=>{this._filterSkills(this.searchInput.value.toLowerCase())})),this.searchInput.addEventListener("keydown",this._boundHandleKeyDown),this.menuContainer&&(this._positionMenu(),this.menuContainer.style.visibility="visible",requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.opacity="1",setTimeout((()=>this.searchInput.focus()),100))})))}_createLoadingIndicator(){const e=document.createElement("div");e.className=`px-3 py-2 text-center ${this.theme.fadedText} flex items-center justify-center`;const t=o.A.name("spinner"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"animate-spin mr-2"});return e.innerHTML=`${s.element.outerHTML}Loading skills...`,e}_filterSkills(e){if(!this.skillListContainer||!this.menuContainer)return;const t=this._getNavigableItems();-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),this.highlightedIndex=-1;const s=this.skillListContainer.querySelectorAll(".skill-item.navigable-menu-item");let i=!1;s.forEach((t=>{if(!t.dataset.skillName)return;const s=t.dataset.skillName.toLowerCase().includes(e);t.style.display=s?"flex":"none",s&&(i=!0)}));const n=this.skillListContainer.querySelector(".no-results-message");if(i)n&&(n.style.display="none");else if(n)n.style.display="block";else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText} no-results-message`,e.textContent="No skills found",this.skillListContainer.appendChild(e)}}async _loadAndRenderSkills(e){this.isLoading=!0;try{const e=this.availableSkills;if(this.skillListContainer.innerHTML="",e&&0!==e.length){e.forEach((e=>{const t=this._createSkillItem(e);this.skillListContainer.appendChild(t)}));const t=u.K.hasPermission("feature:screen-share"),s=u.K.hasPermission("feature:voice");if(t||s){const e=document.createElement("div");e.className=`border-t ${this.theme.tableDividerLine} my-2 mx-2`,this.footerContainer.appendChild(e)}if(t){const e=this._createSpecialItem({name:this.isMobile?"Open camera":"Share screen",icon:this.isMobile?"camera":"chatScreenShare",onClick:()=>{this.onScreenShareCallback&&(this.onScreenShareCallback(),this.remove())}});this.footerContainer.appendChild(e)}if(s)return}else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText}`,e.textContent="No skills available",this.skillListContainer.appendChild(e)}}catch(e){this.skillListContainer.innerHTML="";const t=document.createElement("div");t.className=`px-3 py-2 text-center ${this.theme.errorText||"text-red-600"}`,t.textContent="Failed to load skills.",this.skillListContainer.appendChild(t),new c.y("Error loading skills","error"),this.menuContainer&&(this._positionMenu(),this.menuContainer.style.visibility="visible",requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.opacity="1")})))}finally{this.isLoading=!1}}_createSkillItem(e){const t=document.createElement("div");t.className=`px-3 py-2.5 flex justify-between items-center ${this.theme.tableMenuButtonHover} rounded mx-1 cursor-pointer group skill-item navigable-menu-item`,t.dataset.skillName=e.name;const s=document.createElement("div");s.className="flex items-center gap-2 overflow-hidden mr-2 flex-grow min-w-0";const i=document.createElement("div");if(i.className="w-5 h-5 flex-shrink-0 flex items-center justify-center",e.image&&(i.innerHTML=`<img src="${e.image}" class="w-full h-full rounded-sm object-contain" draggable="false">`),e.icon){const t=o.A.name(e.icon);if(t){const e=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:`${this.theme.iconColor}`});i.appendChild(e.element)}}s.appendChild(i);const n=document.createElement("span");return n.className=`${this.theme.text} font-medium text-sm truncate`,n.textContent=e.name,n.title=e.name,s.appendChild(n),t.appendChild(s),t.addEventListener("click",(()=>{this.onSelectCallback&&(this.onSelectCallback(e),this.remove())})),t}_createSpecialItem({name:e,icon:t,onClick:s}){const i=document.createElement("div");i.className=`px-3 py-2 flex justify-between items-center ${this.theme.tableMenuButtonHover} rounded mx-1 cursor-pointer group ${this.theme.text} navigable-menu-item`;const n=document.createElement("div");n.className="flex items-center gap-2 overflow-hidden mr-2 flex-grow min-w-0";const a=document.createElement("div");a.className="w-5 h-5 flex-shrink-0 flex items-center justify-center";const l=o.A.name(t);if(l){const e=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:"w-4 h-4",additionalClasses:`${this.theme.iconColor}`});a.appendChild(e.element)}n.appendChild(a);const c=document.createElement("span");return c.className=`${this.theme.text} font-medium text-sm truncate`,c.textContent=e,c.title=e,n.appendChild(c),i.appendChild(n),i.addEventListener("click",s),i}_getNavigableItems(){if(!this.menuContainer)return[];return[...Array.from(this.skillListContainer.querySelectorAll(".navigable-menu-item.skill-item")).filter((e=>"none"!==e.style.display)),...Array.from(this.footerContainer.querySelectorAll(".navigable-menu-item"))]}_handleKeyDown(e){const t=this._getNavigableItems();if("Escape"===e.key)return e.preventDefault(),void this.remove();if("Backspace"===e.key&&this.searchInput&&""===this.searchInput.value){if(this.backspaceCount++,this.backspaceCount>=2)return e.preventDefault(),this.remove(),void(this.backspaceCount=0)}else("Backspace"!==e.key||this.searchInput&&""!==this.searchInput.value)&&(this.backspaceCount=0);if(t.length||"Backspace"===e.key)switch(e.key){case"ArrowDown":e.preventDefault();let s=this.highlightedIndex+1;s>=t.length&&(s=0),this._updateHighlight(s,t);break;case"ArrowUp":e.preventDefault();let i=this.highlightedIndex-1;i<0&&(i=t.length-1),this._updateHighlight(i,t);break;case"Enter":e.preventDefault(),-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].click()}}_updateHighlight(e,t){-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),-1!==e&&t[e]&&(t[e].classList.add(this.keyboardHighlightClass),t[e].scrollIntoView({block:"nearest"})),this.highlightedIndex=e}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect(),t=this.menuContainer.offsetHeight,s=this.menuContainer.offsetWidth;let i=e.top-t-8,n=e.left;i<8&&(i=e.bottom+8,i+t>window.innerHeight-8&&(i=window.innerHeight-t-8)),n<8?n=8:n+s>window.innerWidth-8&&(n=window.innerWidth-s-8),this.menuContainer.style.top=`${i+window.scrollY}px`,this.menuContainer.style.left=`${n+window.scrollX}px`}_addCloseListener(){this._boundHandleOutsideClick&&this._removeCloseListener(),setTimeout((()=>{this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),document.addEventListener("click",this._boundHandleOutsideClick,{capture:!0,once:!1})}),0)}_removeCloseListener(){this._boundHandleOutsideClick&&(document.removeEventListener("click",this._boundHandleOutsideClick,{capture:!0}),this._boundHandleOutsideClick=null)}_handleOutsideClick(e){const t=this.menuContainer&&!this.menuContainer.contains(e.target),s=this.triggerElement&&!this.triggerElement.contains(e.target);t&&s&&this.remove()}removeExisting(){document.querySelectorAll(".skill-selector-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(){const e=!!this.menuContainer;if(this._removeCloseListener(),this.searchInput&&this._boundHandleKeyDown&&this.searchInput.removeEventListener("keydown",this._boundHandleKeyDown),this.menuContainer){const t=this.menuContainer,s=this.onRemoveCallback;this.menuContainer=null,this.skillListContainer=null,this.footerContainer=null,this.searchInput=null,this.highlightedIndex=-1,this.onRemoveCallback=null,t.style.opacity="0";let i=!1;const n=()=>{i||(i=!0,t.parentNode&&t.remove(),e&&s?.())},a=setTimeout(n,250);t.addEventListener("transitionend",(e=>{"opacity"===e.propertyName&&(clearTimeout(a),n())}),{once:!0})}else this.onRemoveCallback&&(this.onRemoveCallback(),this.onRemoveCallback=null)}}class W{constructor(e,t,s=null,n=null,a=!0,o=null){if(this.user=u.K.user,this.theme=i.A.theme,this.isMobile=u.K.isMobile(),this.maxTextAreaHeight=200,this.minTextAreaHeight=36,this.isExpanded=!1,this.expandButton=null,this.backspaceCount=0,this.chatId=e,this._assistant=s,this._model=n,this.memoryStatus=a,this.modelObject=o,this._chatObject=t,this.lastInput={message:"",files:[],selectedSkill:null,skillParams:null,replyToMessage:null},this.mcpStatus=!window.mcp_menu_data||!1!==window.mcp_menu_data.master_enabled,this.onMessageSendCallback=null,this.onModelSwitchCallback=null,this.onAssistantSwitchCallback=null,this.onMemorySwitchCallback=null,this.onScreenShareCallback=null,this.onVoiceModeCallback=null,this.toggleSelectedSkill=this.toggleSelectedSkill.bind(this),this.toggleSkillsMenu=this.toggleSkillsMenu.bind(this),this.checkFileAreaAndShowSkillsMenu=this.checkFileAreaAndShowSkillsMenu.bind(this),this.handleStop=this.handleStop.bind(this),this.pmView=null,this.positionContainer=null,this.positionContainerHeight=null,this.container=null,this.inputBox=null,this.skillArea=null,this.chatArea=null,this.selectedSkillBox=null,this.plusButton=null,this.textAreaWrapper=null,this.sendWrapper=null,this.sendButton=null,this.onPasteCallback=null,this.commandsContainer=null,this.removedSlashOptions=[],this.replyToMessage=null,this.isSkillActive=!1,this.filesShown=0,this.skillIsShowing=!1,this.lastEditorHeight=0,this.onAllFilesRemovedCallback=null,this.onSkillSelectedCallback=null,this.onSkillClosedCallback=null,this.onHeightChangeCallback=null,this.onUploadingFilesCheckCallback=null,this.availableSkills=u.K.available_skills,this.skillsMenu=u.K.skills_menu,this.initialLoad=!0,this.handleCodeSelected=this.handleCodeSelected.bind(this),document.addEventListener("codeSelected",this.handleCodeSelected),this.handleCodeDeselected=this.handleCodeDeselected.bind(this),document.addEventListener("codeDeselected",this.handleCodeDeselected),this.handleVisualizationTrigger=this.handleVisualizationTrigger.bind(this),this.addVisualizationListener(),this.broadcastChannel=new BroadcastChannel("simtheory_mcp_status_channel"),this.originalForkState=null,this.forkSessionMessage=null,this.isResizingVertically=!1,this.userSetTextAreaHeight=null,this.currentInputBoxOverhead=0,this.startVerticalResize=this.startVerticalResize.bind(this),this.verticalResize=this.verticalResize.bind(this),this.stopVerticalResize=this.stopVerticalResize.bind(this),this.init(),this._assistant){const e=!0===this._assistant.has_forced_mcps?this._assistant.id:null;this._fetchMCPDataForAssistant(e)}else this._fetchMCPDataForAssistant(null);this._assistant&&!0===this._assistant.has_forced_mcps?this._fetchMCPDataForAssistant(this._assistant.id):this._assistant||this._fetchMCPDataForAssistant(null),this.handleMCPDataUpdate=e=>{this._assistant&&window.mcp_menu_data&&(e.detail.assistantId===this._assistant.id||"global"===e.detail.assistantId)&&this.updateMCPStateForAssistant(this._assistant)},window.addEventListener("mcpDataUpdated",this.handleMCPDataUpdate)}init(){if(this.relativeContainer=document.createElement("div"),this.relativeContainer.className="relative flex flex-col w-full pb-2",this.contentContainer=document.createElement("div"),this.contentContainer.className="flex-grow",this.positionContainer=document.createElement("div"),this.positionContainer.className="sticky bottom-[20px] left-0 right-0 w-full overflow-none smooth-transition",this.positionContainer.style.height="auto",this.relativeContainer.appendChild(this.contentContainer),this.relativeContainer.appendChild(this.positionContainer),this.container=document.createElement("div"),this.container.className="flex flex-grow justify-center relative mx-2",this.positionContainer.appendChild(this.container),this.inputBox=document.createElement("div"),this.inputBox.className=`flex flex-col flex-grow rounded-t-xl drop-shadow-lg w-full max-w-[760px] ${this.theme.chatInputBackground} relative pb-2 mx-2`,this.inputBox.classList.add("container-type-inline-size","container-name-chat-input"),this.isMobile||this.inputBox.classList.add("group"),this.container.appendChild(this.inputBox),!this.isMobile){this.verticalResizeHandle=document.createElement("div"),this.verticalResizeHandle.className="absolute top-0 left-0 w-full h-[10px] cursor-ns-resize z-20 flex items-center justify-center";const e=document.createElement("div");e.className="w-[40px] h-[4px] rounded-full opacity-0 group-hover:opacity-50 transition-opacity",e.style.backgroundColor=this.theme.textInputBorder||"#cccccc",this.verticalResizeHandle.appendChild(e),this.inputBox.appendChild(this.verticalResizeHandle),this.verticalResizeHandle.addEventListener("mousedown",this.startVerticalResize)}this.filesArea=document.createElement("div"),this.filesArea.className="flex w-full overflow-x-auto overflow-y-none gap-4 align-middle items-center p-4 hidden",this.inputBox.appendChild(this.filesArea),this.skillArea=document.createElement("div"),this.skillArea.className="flex flex-grow gap-1 align-middle items-center",this.inputBox.appendChild(this.skillArea),this.replyArea=document.createElement("div"),this.replyArea.className="flex w-grow gap-1 align-middle items-center",this.inputBox.appendChild(this.replyArea),this.chatArea=document.createElement("div"),this.chatArea.className="flex w-full gap-1 align-middle items-end flex-grow flex-shrink min-h-0",this.selectedSkillBox=document.createElement("div"),this.selectedSkillBox.className="flex flex-grow pl-4 pb-4",this.textAreaWrapper=document.createElement("div"),this.textAreaWrapper.className="flex w-full flex-col p-2 relative flex-grow flex-shrink min-h-0",this.chatArea.appendChild(this.textAreaWrapper),this.inputTextArea=document.createElement("textarea"),this.inputTextArea.id="user-input",this.inputTextArea.rows=1,this.inputTextArea.className=`flex w-full h-full text-base border-0 focus:ring-0 bg-transparent resize-none pl-2 pr-2 ${this.theme.placeholderText} placeholder:truncate`,this.inputTextArea.setAttribute("placeholder","Compose a message..."),this.inputTextArea.setAttribute("aria-label","Message input"),this.textAreaWrapper.appendChild(this.inputTextArea),this.inputBox.appendChild(this.chatArea),this.footerControls=document.createElement("div"),this.footerControls.className="flex justify-between align-top items-center px-3",this.inputBox.appendChild(this.footerControls),this.lhsFooter=document.createElement("div"),this.lhsFooter.className="flex align-middle items-center",this.footerControls.appendChild(this.lhsFooter),this.rhsFooter=document.createElement("div"),this.rhsFooter.className="flex gap-1 align-middle items-center justify-end",this.footerControls.appendChild(this.rhsFooter),this.noSkillContainer=document.createElement("div"),this.noSkillContainer.className="flex gap-1 align-middle items-center",this.lhsFooter.appendChild(this.noSkillContainer);const e=o.A.name("plus");if(this.plusButton=new n.$({text:"",type:"secondaryTransparent",size:"xSmallMobile",svgPathData:e.path,svgViewBox:e.viewBox,width:"auto",id:"skills-menu",ariaLabel:"Open skills menu"}),this.plusButton.render(this.noSkillContainer),u.K.hasPermission("feature:mcps")){const e="boxOpen",t=o.A.name(e);this.mcpControlButton=new n.$({text:"",type:"secondaryTransparent",size:"smallMobile",svgPathData:t?t.path:"",svgViewBox:t?t.viewBox:"",width:"auto",ariaLabel:"Open MCP Menu (Loading...)",ariaPressed:"false"}),this.mcpControlButton.render(this.noSkillContainer),this.updateMCPButtonForModel(this._model),this.updateMCPIcon(this.mcpStatus)}u.K.hasPermission("feature:assistant-switching")&&this._assistant&&(this.assistantSelection=new n.$({text:this._assistant.name,type:u.K.hasPermission("feature:model-switching")?"secondaryTransparent":"primaryTransparent",size:"topMenu",width:"auto",image:this._assistant.image,truncateMobile:!0,containerResponsive:!0,ariaLabel:"Switch assistant"}),this.assistantSelection.render(this.rhsFooter)),u.K.hasPermission("feature:model-switching")&&(this.modelSelection=new n.$({text:this._model.name,type:"secondaryTransparent",size:"topMenu",width:"auto",image:this._model.image,truncateMobile:!0,containerResponsive:!0,ariaLabel:"Switch model"}),this.modelSelection.render(this.rhsFooter)),this.sendButton=document.createElement("button"),this.sendButton.id="send-message",this.sendButton.type="button",this.sendButton.className=`ml-2 flex items-center justify-center w-7 h-7 ${this.theme.chatButtonDisabled} rounded-md opacity-50 cursor-default`,this.sendButton.setAttribute("aria-label","Send message");const t=new r.I({pathData:o.A.name("chatSendMessage").path,viewBox:o.A.name("chatSendMessage").viewBox,sizeClasses:"w-4 h-4"});this.sendButton.appendChild(t.element),this.updateSendButtonState(!1,!1),this.rhsFooter.appendChild(this.sendButton),this.addEventListeners(),this.defaultInputHeight=100,this.relativeContainer.style.transition="none",this.initialLoad=!1}async _fetchMCPDataForAssistant(e){try{const t=e?`/accounts/mcp/installed-with-status/?assistant_id=${e}`:"/accounts/mcp/installed-with-status/",s=await g.G.fetchData(t);s&&(window.mcp_menu_data=s,window.dispatchEvent(new CustomEvent("mcpDataUpdated",{detail:{assistantId:e||"global"}})),this._assistant&&this.updateMCPStateForAssistant(this._assistant))}catch(e){new c.y("Could not load MCP settings","warning"),this._assistant&&window.mcp_menu_data&&this.updateMCPStateForAssistant(this._assistant)}}updateMCPStateForAssistant(e){if(!e||!this.mcpControlButton)return;if(!window.mcp_menu_data)return;let t=!1!==window.mcp_menu_data.master_enabled;const s=!0===e.has_forced_mcps,i=!0===window.mcp_menu_data.is_assistant_specific;s&&i&&window.mcp_menu_data.assistant_id===e.id?t=!1!==window.mcp_menu_data.master_enabled:s||(t=!1!==window.mcp_menu_data.master_enabled),this.mcpStatus=t,this.updateMCPIcon(t),this.updateMCPButtonForModel(this._model)}updateMCPIcon(e){const t=e?"boxOpen":"boxClosed",s=o.A.name(t);this.mcpControlButton&&s&&(this.mcpControlButton.setSvgIcon(s.path,s.viewBox),this.mcpStatus=e,this.mcpControlButton.element.setAttribute("aria-label",e?"Open MCP Menu (MCPs Enabled)":"Open MCP Menu (MCPs Disabled)"),this.mcpControlButton.element.setAttribute("aria-pressed",e.toString()))}onMCPControl(e){"function"==typeof e&&(this.onMCPControlCallback=e)}updateMemoryIcon(){}stripHoverState(e){return e.replace(/\s*hover:[^\s]+/g,"")}updateSendButtonState(e,t=!1){let s;this.sendButton.innerHTML="";let i="ml-2 w-[30px] h-[30px] rounded-lg flex items-center justify-center ";t?(this.sendButton.disabled=!1,i+=`${this.stripHoverState(this.theme.chatButtonEnabled)} cursor-pointer`,s={pathData:o.A.name("spinner").path,viewBox:o.A.name("spinner").viewBox,sizeClasses:"w-4 h-4 animate-spin",colorClass:this.stripHoverState(this.theme.chatButtonEnabled)},this.sendButton.title="Stop generating",this.sendButton.setAttribute("aria-label","Stop generating")):e?(this.sendButton.disabled=!1,i+=`${this.stripHoverState(this.theme.chatButtonEnabled)} cursor-pointer`,s={pathData:o.A.name("chatSendMessage").path,viewBox:o.A.name("chatSendMessage").viewBox,sizeClasses:"w-4 h-4",colorClass:this.stripHoverState(this.theme.chatButtonEnabled)},this.sendButton.title="Send message",this.sendButton.setAttribute("aria-label","Send message")):(this.sendButton.disabled=!0,i+=`${this.stripHoverState(this.theme.chatButtonDisabled)} opacity-50 cursor-default`,s={pathData:o.A.name("chatSendMessage").path,viewBox:o.A.name("chatSendMessage").viewBox,sizeClasses:"w-4 h-4",colorClass:this.stripHoverState(this.theme.chatButtonDisabled)},this.sendButton.title=""),this.sendButton.className=i;const n=new r.I(s);this.sendButton.appendChild(n.element)}toggleStopButton(e){if(this.isStreaming=e,this.sendButton.removeEventListener("mouseenter",this.showStopIcon),this.sendButton.removeEventListener("mouseleave",this.showSpinnerIcon),e&&!this.isSkillActive)this.updateSendButtonState(!0,!0),this.sendButton.addEventListener("mouseenter",this.showStopIcon),this.sendButton.addEventListener("mouseleave",this.showSpinnerIcon);else{let e=!1;if(this.inputTextArea){const t=""!==this.inputTextArea.value.trim(),s=this.selectedSkill&&this.selectedSkill.noMessageRequired;e=t||this.filesShown>0||s}this.updateSendButtonState(e,!1)}}showStopIcon=()=>{if(!this.sendButton)return;this.sendButton.innerHTML="";const e=new r.I({pathData:o.A.name("squareSmall").path,viewBox:o.A.name("squareSmall").viewBox,sizeClasses:"w-4 h-4",colorClass:this.stripHoverState(this.theme.chatButtonEnabled)});this.sendButton.appendChild(e.element)};showSpinnerIcon=()=>{if(!this.sendButton)return;this.sendButton.innerHTML="";const e=new r.I({pathData:o.A.name("spinner").path,viewBox:o.A.name("spinner").viewBox,sizeClasses:"w-4 h-4 animate-spin",colorClass:this.stripHoverState(this.theme.chatButtonEnabled)});this.sendButton.appendChild(e.element)};toggleSendButton(){if(!this.inputTextArea)return;const e=""!==this.inputTextArea.value.trim(),t=this.selectedSkill&&this.selectedSkill.noMessageRequired,s=e||this.filesShown>0||t;this.isStreaming&&!this.isSkillActive||this.updateSendButtonState(s,!1)}set placeholder(e){this.inputTextArea.setAttribute("placeholder",e)}addVisualizationListener(){document.addEventListener("triggerVisualization",this.handleVisualizationTrigger)}removeVisualizationListener(){document.removeEventListener("triggerVisualization",this.handleVisualizationTrigger)}handleVisualizationTrigger(e){const{messageId:t,blockId:s}=e.detail,i=this.availableSkills.find((e=>"visualization"===e.value));this.selectedSkill=i;const n={id:Math.floor(1e6*Math.random()),type:"user",nickname:this.user.nickname,timestamp:(new Date).toISOString(),body:"Visualize data for code block",skill:"visualization",skill_params:{source_message_id:t,visualize_form_data:!0}};this.onMessageSendCallback?.(n,!1)}handleSendOrStop(){!this.isStreaming||this.isSkillActive||this.forkSessionMessage||""!==this.inputTextArea.value.trim()||this.filesShown>0?this.sendMessage():"function"==typeof this.onStopCallback&&this.onStopCallback()}handleStop(){""===this.inputTextArea.value.trim()?"function"==typeof this._chatObject.onStop&&this._chatObject.onStop():this.sendMessage(),this.toggleStopButton(!1)}onStop(e){"function"==typeof e&&(this.onStopCallback=e)}addEventListeners(){this.broadcastChannel.onmessage=this.handleBroadcastMessage.bind(this),this.inputTextArea.addEventListener("click",(()=>{this.inputTextArea.focus()})),this.positionContainer.addEventListener("click",(e=>{e.target===this.positionContainer&&this.inputTextArea.focus()})),this.inputTextArea.addEventListener("paste",(e=>{if(e.clipboardData.files.length>0){if(this.selectedSkill&&!this.selectedSkill.enableFileUpload)return void e.preventDefault();e.preventDefault(),"function"==typeof this.onPasteCallback&&this.onPasteCallback(e.clipboardData.files)}})),this.positionContainer&&this.positionContainer.addEventListener("click",(e=>{e.target===this.positionContainer&&this.focus()})),this.plusButton&&this.plusButton.onClick(this.checkFileAreaAndShowSkillsMenu),this.sendButton&&this.sendButton.addEventListener("click",(()=>{this.handleSendOrStop()})),this.mcpControlButton&&u.K.hasPermission("feature:mcps")&&this.mcpControlButton.onClick((()=>{"function"==typeof this.onMCPControlCallback&&this.onMCPControlCallback(this.mcpControlButton,this._assistant)})),this.mcpAdminButton&&u.K.hasPermission("feature:mcps")&&this.mcpAdminButton.onClick((()=>{"function"==typeof this.onMCPControlCallback&&this.onMCPAdminCallback(this.mcpAdminButton)})),this.assistantSelection&&u.K.hasPermission("feature:assistant-switching")&&this.assistantSelection.onClick((()=>{"function"==typeof this.onAssistantSwitchCallback&&this.onAssistantSwitchCallback()})),this.modelSelection&&u.K.hasPermission("feature:model-switching")&&this.modelSelection.onClick((()=>{"function"==typeof this.onModelSwitchCallback&&this.onModelSwitchCallback()})),this.inputTextArea.addEventListener("keydown",(e=>{if(!e.altKey||!e.shiftKey||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key)if(e.altKey||e.shiftKey||"ArrowLeft"!==e.key&&"ArrowRight"!==e.key){if(!this.skillIsShowing||"Backspace"!==e.key&&"Delete"!==e.key||0!==this.inputTextArea.value.length?"Enter"!==e.key&&(this.backspaceCount=0):(this.backspaceCount++,this.backspaceCount>=2&&(this.selectedSkill=null,this.removeSkill(),this.backspaceCount=0)),"Enter"===e.key){if(this.isMobile||e.shiftKey){e.preventDefault();const t=this.inputTextArea.selectionStart,s=this.inputTextArea.value,i=s.slice(0,t)+"\n"+s.slice(t);this.inputTextArea.value=i;const n=t+1;this.inputTextArea.setSelectionRange(n,n),requestAnimationFrame((()=>{this.adjustTextarea(),this.scrollToCursor()}))}else{if(window.user.preferences.sendMessageOnEnter){this.inputTextArea.value.trim().length>0||this.filesShown>0||this.selectedSkill&&this.selectedSkill.noMessageRequired?(e.preventDefault(),this.sendMessage(),setTimeout((()=>this.adjustTextarea()),0)):e.preventDefault()}}this.backspaceCount=0}if(e.altKey&&!e.ctrlKey&&!e.metaKey&&!e.shiftKey){let t=!1;switch(e.code){case"KeyS":this.plusButton&&this.plusButton.element&&null!==this.plusButton.element.offsetParent&&(this.checkFileAreaAndShowSkillsMenu(),t=!0);break;case"KeyC":this.mcpControlButton&&u.K.hasPermission("feature:mcps")&&this.mcpControlButton.element&&null!==this.mcpControlButton.element.offsetParent&&("function"==typeof this.onMCPControlCallback?this.onMCPControlCallback(this.mcpControlButton,this._assistant):this.mcpControlButton.element.click(),t=!0);break;case"KeyA":this.assistantSelection&&u.K.hasPermission("feature:assistant-switching")&&this._assistant&&this.assistantSelection.element&&null!==this.assistantSelection.element.offsetParent&&("function"==typeof this.onAssistantSwitchCallback?this.onAssistantSwitchCallback():this.assistantSelection.element.click(),t=!0);break;case"KeyM":this.modelSelection&&u.K.hasPermission("feature:model-switching")&&this._model&&this.modelSelection.element&&null!==this.modelSelection.element.offsetParent&&("function"==typeof this.onModelSwitchCallback?this.onModelSwitchCallback():this.modelSelection.element.click(),t=!0)}t&&e.preventDefault()}}else e.stopPropagation()})),this.inputTextArea.addEventListener("input",(()=>{this.checkForBackslashCommand(),this.toggleSendButton(),this.adjustTextarea()}))}scrollToCursor(){if(!this.inputTextArea)return;const e=this.inputTextArea.value,t=this.inputTextArea.selectionStart,s=e.substring(0,t).split("\n").length,i=parseInt(window.getComputedStyle(this.inputTextArea).lineHeight)||18,n=(s-1)*i,a=this.inputTextArea.clientHeight,o=Math.max(0,n-a/2+i);(n<this.inputTextArea.scrollTop||n>this.inputTextArea.scrollTop+a-i)&&(this.inputTextArea.scrollTop=o)}scrollToCursor(){if(!this.inputTextArea)return;const e=this.inputTextArea,{selectionStart:t}=e,s=document.createElement("div"),i=window.getComputedStyle(e);s.style.position="absolute",s.style.visibility="hidden",s.style.whiteSpace="pre-wrap",s.style.wordWrap="break-word",s.style.overflowWrap="break-word",s.style.top="0",s.style.left="-9999px",s.style.width=`${e.clientWidth}px`,["borderLeftWidth","borderRightWidth","borderTopWidth","borderBottomWidth","fontFamily","fontSize","fontWeight","fontStyle","letterSpacing","lineHeight","textTransform","textAlign","paddingTop","paddingRight","paddingBottom","paddingLeft","whiteSpace","wordBreak","wordWrap","boxSizing"].forEach((e=>{s.style[e]=i[e]}));const n=e.value,a=n.slice(0,t),o=n.slice(t)||" ";s.textContent=a;const r=document.createElement("span");r.textContent=o[0],s.appendChild(r),document.body.appendChild(s);const l=r.getBoundingClientRect(),c=s.getBoundingClientRect(),d=l.top-c.top,h=e.scrollTop,m=e.clientHeight;(d<h||d>h+m-20)&&(e.scrollTop=d-m/2),document.body.removeChild(s)}adjustTextarea(){const e=this.inputBox.offsetHeight;if(this.isResizingVertically)return;const t=this.inputTextArea.scrollTop;this.inputTextArea.style.height="auto";const s=this.inputTextArea.scrollHeight;let i;const n=parseFloat(getComputedStyle(this.inputTextArea).lineHeight)||18;i=this.userSetTextAreaHeight?Math.min(s,this.userSetTextAreaHeight):Math.min(s,this.maxTextAreaHeight),this.inputTextArea.style.height=`${Math.max(i,n)}px`,this.inputTextArea.scrollTop=t,this.inputBox.offsetHeight!==e&&"function"==typeof this.onHeightChangeCallback&&this.onHeightChangeCallback(this.inputBox.offsetHeight)}onUploadingFilesCheck(e){"function"==typeof e&&(this.onUploadingFilesCheckCallback=e)}checkForBackslashCommand(){if(!this.inputTextArea||this.skillIsShowing)return;const e=this.inputTextArea.value;return"/"!==e||e.startsWith("//")?void 0:(this.inputTextArea.value="",this.toggleSendButton(),void this.checkFileAreaAndShowSkillsMenu())}showAvailableCommands(){this.commandsContainer||this.createSlashCommandContainer(),"none"===this.commandsContainer.style.display&&(this.commandsContainer.style.display="block",this.filterSlashOptions(""))}executeSlashCommand(e){this.inputTextArea&&("computer"!==e.value||window.user.computer&&"None"!==window.user.computer?(this.selectedSkill=e,this.inputTextArea.value="",this.adjustTextarea(),this.toggleSelectedSkill(e),this.focus()):new U)}onHeightChange(e){"function"==typeof e&&(this.onHeightChangeCallback=e)}render(){return this.relativeContainer}focusMode(e,t){let s="";this.focusOn=e,this.focusSkillType=null,this.focusOn&&("CODE-BLOCK"===t?.tagName?(this.focusSkillType="code",s="Coding",this.setSkillMode("code")):this.focusSkillType=null)}setSkillMode(e){const t=this.availableSkills.find((t=>t.value===e));t?this.executeSlashCommand(t):this.toggleSelectedSkill()}sendMessage(){if(!this.inputTextArea)return;let e=!1;if(this.selectedSkill&&this.skillComponents&&!this.skillComponents.validate())return;if(this.filesShown>0)if("function"==typeof this.onUploadingFilesCheckCallback){if(this.onUploadingFilesCheckCallback())return void new c.y("Please wait for files to finish uploading","warning");e=!0}else e=!0;const t=this.inputTextArea.value.trim();if(t||e||this.selectedSkill&&this.selectedSkill.noMessageRequired){const s=this.skillComponents?this.skillComponents.values:null,i=this._chatObject.getFileData();this.lastInput={message:t,files:i,selectedSkill:this.selectedSkill,skillParams:s,replyToMessage:this.replyToMessage},this.inputTextArea.value="",this.adjustTextarea();const n=Math.floor(1e6*Math.random()),a=this.selectedSkill?this.selectedSkill.value:null,o=(document.getElementById(`messages-for-chat-${this.chatId}`),document.querySelector(`code-block[mode="focus"][chat-id="${this.chatId}"]`));let r=s?{...s}:{},l={id:n,type:"user",nickname:this.user.nickname,timestamp:(new Date).toISOString(),body:t||"",skill:a,skill_params:null,in_reply_to:null,reply_to_session_id:null,reply_to_assistant_message_id:null};if(o){l.code_block_id=o.getAttribute("block-id"),l.code_block_code=o.code,r.focus_mode=!0,r.focus_id=o.messageId,r.focus_block_id=o.getAttribute("block-id");const e=o.getCurrentVersion();e&&(r.code_version=e.version,r.code=e.code)}if(l.skill_params=Object.keys(r).length>0?r:null,this.forkSessionMessage?(l.reply_to_session_id=this.forkSessionMessage.id,l.reply_to_assistant_message_id=this.forkSessionMessage.assistantMessageId,l.fork_assistant_id=this.forkSessionMessage.assistant.id,l.fork_model_id=this.forkSessionMessage.model.id,this.resetForkState()):this.replyToMessage&&(this.replyToMessage.isCode?l.in_reply_to_code="string"==typeof this.replyToMessage.content?this.replyToMessage.content:this.replyToMessage:l.in_reply_to=this.replyToMessage.id||this.replyToMessage),"upload"===a&&this.skillComponents&&(l.temp_files_render=this.skillComponents.fileRender),o&&"code"===a&&o.showLoadingOverlay(!0),this.onMessageSendCallback?.(l,e),this.toggleSendButton(),this.clearFileArea(),this.clearReplyTo(),this.skillIsShowing&&this.skillComponents){this.skillComponents.close?.();this.availableSkills.find((e=>e.value===a))}this.focus()}}onSend(e){"function"==typeof e&&(this.onMessageSendCallback=e)}checkFileAreaAndShowSkillsMenu(){this.toggleSkillsMenu()}toggleSkillsMenu(){new V(this.plusButton,(e=>{e&&"upload"===e.value?this.triggerUploadSelectFile():(this.selectedSkill=e,this.toggleSelectedSkill(e),this.focus())}),(()=>{"function"==typeof this.handleScreenShareAction&&this.handleScreenShareAction()}),(()=>{"function"==typeof this.handleVoiceAction&&this.handleVoiceAction()}))}async toggleSelectedSkill(e=null){if(this.skillComponents&&(this.skillComponents.close(),this.skillComponents=null),this.skillArea&&(this.skillArea.innerHTML=""),e&&(this.selectedSkill=e),!this.selectedSkill)return this.toggleSkillButtons(!1),void requestAnimationFrame((()=>this.recalculateAndApplyHeightConstraints()));this.isSkillActive=!0,this.toggleStopButton(!1),this.toggleSkillButtons(!0),"function"==typeof this.onSkillSelectedCallback&&this.onSkillSelectedCallback(e),this.skillIsShowing=!0,"skill"===this.selectedSkill.type?(this.skillComponents=new P(this.selectedSkill.value,this._chatObject,this,this.skillArea),await this.skillComponents.init(),this.skillArea.classList.add("my-auto"),this.skillComponents.placeholder&&(this.inputTextArea.placeholder=this.skillComponents.placeholder)):"mcp"===this.selectedSkill.type&&(this.inputTextArea.placeholder=`Using ${this.selectedSkill.name}`),requestAnimationFrame((()=>this.recalculateAndApplyHeightConstraints()))}removeSkill(){this.skillIsShowing=!1,this.isSkillActive=!1,this.toggleSkillButtons(!1),this.skillComponents&&(this.skillComponents.close(),this.skillComponents=null),this.skillArea&&(this.skillArea.innerHTML=""),"function"==typeof this.onSkillClosedCallback&&this.onSkillClosedCallback(),this.selectedSkillBox.innerHTML="",this.selectedSkillBox.classList="flex pl-4 pb-4",this.resetPlaceholder(),requestAnimationFrame((()=>{this.recalculateAndApplyHeightConstraints()})),this.focus()}toggleSkillButtons(e=!1){if(this.skillLabelContainer&&(this.skillLabelContainer.remove(),this.skillLabelContainer=null),!this.selectedSkill||!e)return this.plusButton&&this.plusButton.element.classList.remove("hidden"),void(this.mcpControlButton&&u.K.hasPermission("feature:mcps")&&this.mcpControlButton.element.classList.remove("hidden"));this.skillLabelContainer=document.createElement("div"),this.skillLabelContainer.className="flex items-center gap-1";const t=this.selectedSkill,s="mcp"===this.selectedSkill.type,i=document.createElement("div");i.className=`inline-flex items-center rounded-md px-1 py-1 ${this.theme.skillTag||this.theme.secondaryButtonTransparent} text-sm gap-1 cursor-pointer max-w-[100px] sm:max-w-[200px] overflow-hidden`;const n=document.createElement("div");if(n.className="flex-shrink-0 w-5 h-5 flex items-center justify-center",s&&t.image){const e=document.createElement("img");e.src=t.image,e.className="w-full h-full rounded-sm object-contain",e.draggable=!1,n.appendChild(e)}else{let e="puzzle";t.iconName?e=t.iconName:t.icon&&(e=t.icon);const s=o.A.name(e);if(s){const e=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4"});n.appendChild(e.element)}}i.appendChild(n);const a=document.createElement("div");a.className="truncate",a.textContent=t.tag_name||t.name,i.appendChild(a);const l=document.createElement("div");l.className="flex-shrink-0 flex items-center justify-center pointer-events-none";const c=o.A.name("tabClose"),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3"});if(l.appendChild(d.element),i.appendChild(l),i.addEventListener("click",(e=>{(e.target===i||i.contains(e.target))&&(this.selectedSkill=null,this.removeSkill())})),this.skillLabelContainer.appendChild(i),this.selectedSkill.has_ui){const e=this.availableSkills.find((e=>e.value===this.selectedSkill.value)),t=!!e&&e.show_UI_on_open&&this.theme.skillTag||this.theme.secondaryButtonTransparent,s=document.createElement("div");s.className=`inline-flex items-center justify-center rounded-md h-7 w-8 ${t} cursor-pointer`;const i=o.A.name("sliders");if(i){const e=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-3.5 h-3.5"});s.appendChild(e.element),s.addEventListener("click",(e=>{if(e.stopPropagation(),this.skillComponents){this.skillComponents.toggleSkillUI(),requestAnimationFrame((()=>this.recalculateAndApplyHeightConstraints()));const e=this.skillComponents.skillShowing&&this.theme.skillTag||this.theme.secondaryButtonTransparent;s.className=`inline-flex items-center justify-center rounded-md h-7 w-8 ${e} cursor-pointer`}})),this.skillLabelContainer.appendChild(s)}}this.plusButton&&this.plusButton.element.classList.add("hidden"),s&&this.mcpControlButton?this.mcpControlButton.element.classList.add("hidden"):this.mcpControlButton&&this.mcpControlButton.element.classList.remove("hidden"),this.noSkillContainer.firstChild?this.noSkillContainer.insertBefore(this.skillLabelContainer,this.noSkillContainer.firstChild):this.noSkillContainer.appendChild(this.skillLabelContainer)}adjustHeight(){}onPaste(e){"function"==typeof e&&(this.onPasteCallback=e)}addFile(e){this.filesArea.children.length>0?this.filesArea.insertBefore(e,this.filesArea.firstChild):this.filesArea.appendChild(e),this.filesShown++,this.filesArea.children.length>0&&this.filesArea.classList.remove("hidden"),requestAnimationFrame((()=>{this.adjustHeight(),setTimeout((()=>{this.adjustHeight(),this.toggleSendButton()}),50)})),this.focus()}onFileRemoved(){this.filesShown--,requestAnimationFrame((()=>{this.adjustHeight()})),0===this.filesShown&&(this.clearFileArea(),this.toggleSendButton())}onSkillSelected(e){"function"==typeof e&&(this.onSkillSelectedCallback=e)}onSkillClosed(e){"function"==typeof e&&(this.onSkillClosedCallback=e)}handleCodeSelected(e){if(e.detail.chatId===this.chatId){const t=e.detail.code;this.showReplyTo(t,!0)}}async addFileFromObject(e){if(e&&e.url)try{const t=await fetch(e.url);if(!t.ok)throw new Error(`Failed to fetch image: ${t.statusText}`);const s=await t.blob(),i=e.filename||e.url.split("/").pop().split("?")[0]||"dropped-image.png",n=new File([s],i,{type:s.type});if(!this._chatObject||!this._chatObject.chatFiles||"function"!=typeof this._chatObject.chatFiles.processFiles)throw new Error("File processing unavailable.");this._chatObject.chatFiles.processFiles([n])}catch(e){new c.y(`Error: ${e.message}`,"error")}}showReplyTo(e,t=!1){let s;this.replyToMessage=e,this.replyArea.children.length>0&&(this.replyArea.innerHTML=""),this.replyContainer=document.createElement("div"),this.replyContainer.className=`flex gap-1.5 p-2 ${i.A.theme.skillContainerBG} rounded-lg m-2 w-full max-h-[150px]`,this.replyIcon=document.createElement("div"),this.replyIcon.className="flex flex-col mx-1 justify-start align-middle items-center py-1",this.replyIcon.innerHTML="",s=t?o.A.name("code"):o.A.name("reply");const n=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4",colorClass:i.A.theme.iconColor});this.replyIcon.appendChild(n.element),this.replyContainer.appendChild(this.replyIcon),this.replyPreviewInner=document.createElement("div"),this.replyPreviewInner.className="flex flex-col flex-grow gap-1 justify-start align-middle",t&&(this.replyHeading=document.createElement("div"),this.replyHeading.className="flex flex-col line-clamp-1 overflow-hidden mx-1 font-bold text-sm",this.replyHeading.innerText="Refine this code:",this.inputTextArea.placeholder="What would you like to change?",this.replyPreviewInner.appendChild(this.replyHeading)),this.replyPreview=document.createElement("div"),this.replyPreview.className="flex flex-grow line-clamp-3 text-sm overflow-hidden text-left ml-1 mr-3 my-0.5",t&&(this.replyPreview.className+=` font-mono px-2 py-0.5 rounded ${i.A.theme.background}`),this.replyPreview.innerText=e,this.replyPreviewInner.appendChild(this.replyPreview),this.replyContainer.appendChild(this.replyPreviewInner),this.closeReplyTo=document.createElement("div"),this.closeReplyTo.className="flex flex-col px-1 justify-start align-middle cursor-pointer py-1",this.closeReplyTo.setAttribute("role","button"),this.closeReplyTo.setAttribute("aria-label","Clear reply context"),this.closeReplyTo.setAttribute("tabindex","0"),this.closeReplyTo.innerHTML="";const a=o.A.name("tabClose"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",colorClass:i.A.theme.iconColor});this.closeReplyTo.appendChild(l.element);const c=()=>{this.replyContainer.remove(),this.clearReplyTo()};this.closeReplyTo.addEventListener("click",c),this.closeReplyTo.addEventListener("keydown",(e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),c())})),this.replyContainer.appendChild(this.closeReplyTo),this.replyArea.appendChild(this.replyContainer),requestAnimationFrame((()=>{this.adjustHeight()})),this.focus()}displaySessionReplyIndicator(e,t,s){this.originalForkState={assistant:this._assistant,model:this._model},this.updateSendButtonState(!0,!1),this.toggleStopButton(!1),this.forkSessionMessage={id:t,name:e,assistantMessageId:s,isSessionReply:!0,assistant:this._assistant,model:this._model},this.replyArea.children.length>0&&(this.replyArea.innerHTML=""),this.replyContainer=document.createElement("div"),this.replyContainer.className=`flex gap-1.5 p-2 ${i.A.theme.skillContainerBG} rounded-lg m-2 w-full max-h-[150px]`,this.replyIcon=document.createElement("div"),this.replyIcon.className="flex flex-col mx-1 justify-start align-middle items-center py-1",this.replyIcon.innerHTML="";const n=o.A.name("arrowUpRightFromSquare"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:i.A.theme.iconColor});this.replyIcon.appendChild(a.element),this.replyContainer.appendChild(this.replyIcon),this.replyPreviewInner=document.createElement("div"),this.replyPreviewInner.className="flex flex-col flex-grow gap-0.5 justify-start align-middle",this.replyHeading=document.createElement("div"),this.replyHeading.className="flex flex-col line-clamp-1 overflow-hidden mx-1 font-bold text-sm",this.replyHeading.innerText=`Replying to ${e}`,this.replyPreviewInner.appendChild(this.replyHeading),this.replyPreview=document.createElement("div"),this.replyPreview.className="flex flex-grow line-clamp-2 text-sm overflow-hidden text-left ml-1 mr-3",this.replyPreview.innerText="Opens in new tab",this.replyPreviewInner.appendChild(this.replyPreview),this.replyContainer.appendChild(this.replyPreviewInner),this.closeReplyTo=document.createElement("div"),this.closeReplyTo.className="flex flex-col px-1 justify-start align-middle cursor-pointer py-1",this.closeReplyTo.innerHTML="";const l=o.A.name("tabClose"),c=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:"w-4 h-4",colorClass:i.A.theme.iconColor});this.closeReplyTo.appendChild(c.element),this.closeReplyTo.addEventListener("click",(()=>{this.replyContainer.remove(),this.replyToMessage=null,this.resetPlaceholder(),this.resetForkState(),requestAnimationFrame((()=>{this.recalculateAndApplyHeightConstraints()}))})),this.replyContainer.appendChild(this.closeReplyTo),this.replyArea.appendChild(this.replyContainer),requestAnimationFrame((()=>{this.recalculateAndApplyHeightConstraints()})),this.focus()}resetForkState(){this.originalForkState&&(this.assistant=this.originalForkState.assistant,this.model=this.originalForkState.model,this.originalForkState=null),this.forkSessionMessage=null,this.toggleStopButton(this.isStreaming)}handleCodeDeselected(e){e.detail.chatId===this.chatId&&this.clearReplyTo()}clearReplyTo(){this.forkSessionMessage&&this.resetForkState(),this.replyArea.children.length>0&&(this.replyArea.innerHTML=""),this.replyToMessage=null,this.resetPlaceholder(),requestAnimationFrame((()=>{this.adjustHeight()}))}clearFileArea(){this.filesArea.innerHTML="",this.filesArea.classList.add("hidden"),this.filesShown=0,this.toggleSendButton(),"function"==typeof this.onAllFilesRemovedCallback&&this.onAllFilesRemovedCallback()}onAllFilesRemoved(e){"function"==typeof e&&(this.onAllFilesRemovedCallback=e)}setPlaceholderText(e){if(!this.pmView||e===this.currentPlaceholderText)return;this.currentPlaceholderText=e;const{state:t}=this.pmView,s=t.tr.setMeta(this.placeholderPluginKey,e);this.pmView.dispatch(s)}resetPlaceholder(){let e="Compose a message...";if(this.selectedSkill){const t=u.K.available_skills.find((e=>e.value===this.selectedSkill.value));t&&t.placeholder&&(e=t.placeholder)}else this.replyToMessage?.isCode&&(e="What would you like to change?");this.inputTextArea&&(this.inputTextArea.setAttribute("placeholder",e),this.currentPlaceholderText=e)}focus(){this.inputTextArea&&requestAnimationFrame((()=>{this.inputTextArea.focus();try{const e=this.inputTextArea.value.length;this.inputTextArea.setSelectionRange(e,e)}catch(e){}}))}restoreLastInput(){if(this.inputTextArea&&(this.lastInput.message||this.lastInput.files.length>0||this.lastInput.selectedSkill||this.lastInput.replyToMessage)){if(this.lastInput.message&&(this.inputTextArea.value=this.lastInput.message),this.lastInput.files.length>0&&this._chatObject.restoreFiles(this.lastInput.files),this.lastInput.selectedSkill&&this.toggleSelectedSkill(this.lastInput.selectedSkill),this.lastInput.replyToMessage){const e=this.lastInput.replyToMessage.content||this.lastInput.replyToMessage,t=!!this.lastInput.replyToMessage.isCode;this.showReplyTo(e,t)}this.toggleSendButton(),this.adjustTextarea(),this.initialLoad=!1}}set placeholder(e){this.placeholderElement&&(this.placeholderElement.textContent=e)}set assistant(e){if(this._assistant=e,this.assistantSelection&&(this.assistantSelection.text=e.name,this.assistantSelection.image=e.image),this.resetPlaceholder(),e){const t=!0===e.has_forced_mcps?e.id:null;this._fetchMCPDataForAssistant(t)}else this._fetchMCPDataForAssistant(null)}recalculateAndApplyHeightConstraints(){if(this.isResizingVertically||!this.inputBox||!this.inputTextArea)return;const e=.8*window.innerHeight;this.inputBox.style.maxHeight=`${e}px`;let t=0;this.filesArea&&this.filesArea.offsetParent&&(t+=this.filesArea.offsetHeight,t+=parseFloat(getComputedStyle(this.filesArea).marginTop)||0,t+=parseFloat(getComputedStyle(this.filesArea).marginBottom)||0),this.skillArea&&this.skillArea.offsetParent&&(t+=this.skillArea.offsetHeight,t+=parseFloat(getComputedStyle(this.skillArea).marginTop)||0,t+=parseFloat(getComputedStyle(this.skillArea).marginBottom)||0),this.replyArea&&this.replyArea.offsetParent&&(t+=this.replyArea.offsetHeight,t+=parseFloat(getComputedStyle(this.replyArea).marginTop)||0,t+=parseFloat(getComputedStyle(this.replyArea).marginBottom)||0),this.footerControls&&(t+=this.footerControls.offsetHeight,t+=parseFloat(getComputedStyle(this.footerControls).marginTop)||0,t+=parseFloat(getComputedStyle(this.footerControls).marginBottom)||0);const s=getComputedStyle(this.inputBox);t+=parseFloat(s.paddingTop)||0,t+=parseFloat(s.paddingBottom)||0;const i=getComputedStyle(this.textAreaWrapper);t+=parseFloat(i.paddingTop)||0,t+=parseFloat(i.paddingBottom)||0;const n=Math.max(0,e-t);let a;this.userSetTextAreaHeight=null;const o=this.inputTextArea.scrollTop,r=this.inputTextArea.style.height;this.inputTextArea.style.height="auto";const l=this.inputTextArea.scrollHeight;this.inputTextArea.style.height=r,a=Math.min(l,this.maxTextAreaHeight,n),a=Math.max(this.minTextAreaHeight,a);const c=this.inputBox.offsetHeight;this.inputTextArea.style.height=`${a}px`,this.inputTextArea.scrollTop=o,this.adjustTextarea(),this.inputBox.offsetHeight!==c&&"function"==typeof this.onHeightChangeCallback&&this.onHeightChangeCallback(this.inputBox.offsetHeight)}toggleMemory(){if(!this.memoryButton)return;this.memoryStatus=!this.memoryStatus;const e=this.memoryStatus?"stack":"clearStack",t=o.A.name(e);t&&this.memoryButton.setSvgIcon(t.path,t.viewBox)}setMemory(){if(!1===u.K.hasPermission("feature:memory")||!this.memoryButton)return;const e=this.memoryStatus?"stack":"clearStack",t=o.A.name(e);t&&this.memoryButton.setSvgIcon(t.path,t.viewBox)}toggleScreenShare(e){if(!1===u.K.hasPermission("feature:screen-share")||!this.screenShareButton)return;const t=e?"chatScreenShareOff":"chatScreenShare",s=o.A.name(t);s&&this.screenShareButton.setSvgIcon(s.path,s.viewBox)}onVoiceMode(e){"function"==typeof e&&(this.onVoiceModeCallback=e)}onScreenShare(e){"function"==typeof e&&(this.onScreenShareCallback=e)}onModelSwitch(e){"function"==typeof e&&(this.onModelSwitchCallback=e)}onAssistantSwitch(e){"function"==typeof e&&(this.onAssistantSwitchCallback=e)}onMemorySwitch(e){"function"==typeof e&&(this.onMemorySwitchCallback=e)}set model(e){this._model=e,this.modelSelection&&(this.modelSelection.text=e.name,this.modelSelection.image=e.image),this.updateMCPButtonForModel(this._model)}startVerticalResize(e){e.preventDefault(),this.isResizingVertically=!0,this.startY=e.clientY,this.startTextAreaHeight=this.inputTextArea.offsetHeight,this.currentInputBoxOverhead=0,this.filesArea&&this.filesArea.offsetParent&&(this.currentInputBoxOverhead+=this.filesArea.offsetHeight,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.filesArea).marginTop)||0,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.filesArea).marginBottom)||0),this.skillArea&&this.skillArea.offsetParent&&(this.currentInputBoxOverhead+=this.skillArea.offsetHeight,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.skillArea).marginTop)||0,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.skillArea).marginBottom)||0),this.replyArea&&this.replyArea.offsetParent&&(this.currentInputBoxOverhead+=this.replyArea.offsetHeight,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.replyArea).marginTop)||0,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.replyArea).marginBottom)||0),this.footerControls&&(this.currentInputBoxOverhead+=this.footerControls.offsetHeight,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.footerControls).marginTop)||0,this.currentInputBoxOverhead+=parseFloat(getComputedStyle(this.footerControls).marginBottom)||0);const t=getComputedStyle(this.inputBox);this.currentInputBoxOverhead+=parseFloat(t.paddingTop)||0,this.currentInputBoxOverhead+=parseFloat(t.paddingBottom)||0;const s=getComputedStyle(this.textAreaWrapper);this.currentInputBoxOverhead+=parseFloat(s.paddingTop)||0,this.currentInputBoxOverhead+=parseFloat(s.paddingBottom)||0,this.inputBox.style.transition="none",this.inputTextArea.style.transition="none",this.createResizeOverlay("ns-resize"),document.addEventListener("mousemove",this.verticalResize),document.addEventListener("mouseup",this.stopVerticalResize),document.addEventListener("mouseleave",this.stopVerticalResize)}verticalResize(e){if(!this.isResizingVertically)return;const t=this.inputBox.offsetHeight,s=e.clientY-this.startY;let i=this.startTextAreaHeight-s;const n=.8*window.innerHeight-this.currentInputBoxOverhead;i=Math.max(this.minTextAreaHeight,Math.min(i,n)),this.inputTextArea.style.height=`${i}px`,this.inputBox.offsetHeight!==t&&"function"==typeof this.onHeightChangeCallback&&this.onHeightChangeCallback(this.inputBox.offsetHeight)}stopVerticalResize(){this.isResizingVertically&&(this.isResizingVertically=!1,document.removeEventListener("mousemove",this.verticalResize),document.removeEventListener("mouseup",this.stopVerticalResize),document.removeEventListener("mouseleave",this.stopVerticalResize),this.removeResizeOverlay(),this.inputBox.style.transition="",this.inputTextArea.style.transition="",this.userSetTextAreaHeight=this.inputTextArea.offsetHeight,"function"==typeof this.onHeightChangeCallback&&this.onHeightChangeCallback(this.inputBox.offsetHeight))}createResizeOverlay(e="ew-resize"){this.resizeOverlay||(this.resizeOverlay=document.createElement("div"),this.resizeOverlay.style.cssText=`\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            z-index: 9998; \n            cursor: ${e};\n        `,document.body.appendChild(this.resizeOverlay))}removeResizeOverlay(){this.resizeOverlay&&(this.resizeOverlay.remove(),this.resizeOverlay=null)}triggerUploadSelectFile(){this._chatObject.chatFiles.triggerFileSelection()}handleScreenShareAction(){this._chatObject.shareScreen()}handleVoiceAction(){this._chatObject.toggleVoiceMode()}updateAssistantDisplay(){this.assistantSelection&&this._assistant&&(this.assistantSelection.text=this._assistant.name,this.assistantSelection.image=this._assistant.image)}updateMCPButtonForModel(e){if(!this.mcpControlButton)return;e?.mcp_capable??!1?(this.mcpControlButton.element.classList.remove("opacity-50","pointer-events-none"),this.mcpControlButton.setDisabled(!1)):(this.mcpControlButton.element.classList.add("opacity-50","pointer-events-none"),this.mcpControlButton.setDisabled(!0))}destroy(){this.broadcastChannel&&"closed"!==this.broadcastChannel.readyState&&this.broadcastChannel.close(),this.broadcastChannel=null,document.removeEventListener("codeSelected",this.handleCodeSelected),document.removeEventListener("codeDeselected",this.handleCodeDeselected),this.removeVisualizationListener(),this.handleMCPDataUpdate&&window.removeEventListener("mcpDataUpdated",this.handleMCPDataUpdate)}handleBroadcastMessage(e){if(!this.broadcastChannel||"closed"===this.broadcastChannel.readyState||!e.data)return;const{assistantId:t,status:s}=e.data;if(!t||"boolean"!=typeof s)return;!0===this._assistant?.has_forced_mcps?this._assistant.id===t&&this.updateMCPIcon(s):"global"===t&&this.updateMCPIcon(s)}}class G{static openFocuses=new Map;constructor(e,t,s){if(G.openFocuses.has(e)){const i=G.openFocuses.get(e);return i.updateFocusContent(t,s),i}this.chatId=e,this.object=t,this.payload=s,this.minimizeButton=null,this.focousContentContainer=null,this.fileMenuItems=null,this.theme=i.A.theme,this.structureCreatedByFocus=!1,this.initialAnimationDone=!1,this.minChatWidth=470,this.resizeHandler=this.recalculateWidths.bind(this),window.addEventListener("resize",this.resizeHandler),this.focusWidthProportion=.6,this.findFocusContainer(),this.createFocus(),G.openFocuses.set(this.chatId,this),this.toggleTitleMenu()}findFocusContainer(){const e=ke.chatInstances[this.chatId];let t;if(e&&e.primaryContent)t=e.primaryContent;else{const e=ke.activeChat;if(!e||!e.primaryContent)return this.chatContainer=document.getElementById("views-container")||document.body,this.chatWidthContainer=this.chatContainer.querySelector("#outer-chat-session-container")||this.chatContainer.firstChild||document.createElement("div"),void(this.chatWidthContainer.parentElement||this.chatContainer.appendChild(this.chatWidthContainer));t=e.primaryContent}this.chatSessionElement=t;let s=null,i=0;if(e&&e.chatSession&&(s=e.chatSession.getScrollContainer(),s&&(i=s.scrollTop)),this.focusHostContainer=this.chatSessionElement.querySelector(".focus-host-container"),this.focusHostContainer){if(this.originalChatContentWrapper=this.focusHostContainer.querySelector(".original-chat-content-wrapper"),!this.originalChatContentWrapper&&(this.originalChatContentWrapper=Array.from(this.focusHostContainer.children).find((e=>!e.classList.contains("focus-maximize-in"))),!this.originalChatContentWrapper)){for(this.originalChatContentWrapper=document.createElement("div"),this.originalChatContentWrapper.classList.add("original-chat-content-wrapper","h-full","flex-shrink-0","w-full");this.focusHostContainer.firstChild;)this.originalChatContentWrapper.appendChild(this.focusHostContainer.firstChild);this.focusHostContainer.appendChild(this.originalChatContentWrapper)}this.structureCreatedByFocus=!1}else{for(this.focusHostContainer=document.createElement("div"),this.focusHostContainer.classList.add("focus-host-container","flex","w-full","h-full"),this.originalChatContentWrapper=document.createElement("div"),this.originalChatContentWrapper.classList.add("original-chat-content-wrapper","h-full","flex-shrink-0","w-full");this.chatSessionElement.firstChild;)this.originalChatContentWrapper.appendChild(this.chatSessionElement.firstChild);this.chatSessionElement.appendChild(this.focusHostContainer),this.focusHostContainer.appendChild(this.originalChatContentWrapper),this.structureCreatedByFocus=!0}s&&requestAnimationFrame((()=>{s.scrollTop=i})),this.chatContainer=this.focusHostContainer,this.chatWidthContainer=this.originalChatContentWrapper}createFocus(){if(!(this.chatContainer&&this.chatWidthContainer||(this.findFocusContainer(),this.chatContainer&&this.chatWidthContainer)))return;this.focusedContentContainer=document.createElement("div"),this.focusedContentContainer.classList.add("w-full","overflow-y-auto","overflow-x-hidden","h-full","relative","lg:mr-0","chat-focus-mode","min-w-[300px]","sm:min-w-full","flex-shrink-0");const e=this.chatContainer.offsetWidth,t=window.innerWidth<640,s=window.innerWidth<1024;if(t||s)this.focusedContentContainer.style.width="100%",this.focusedContentContainer.style.minWidth="100%",this.focusedContentContainer.style.maxWidth="100%",this.focusedContentContainer.style.order="1",this.chatWidthContainer.style.width="0px",this.chatWidthContainer.style.minWidth="0px",this.chatWidthContainer.style.display="none",this.chatWidthContainer.style.order="2";else{this.chatWidthContainer.style.display="";const t=Math.round(e*this.focusWidthProportion),s=500,i=1400,n=this.minChatWidth;let a=t;e>n&&e-t<n?a=e-n:e<=n&&(a=Math.max(s,.8*e)),a=Math.max(s,Math.min(a,i)),this.focusedContentContainer.style.width=`${a}px`,this.focusedContentContainer.style.minWidth=`${a}px`,this.focusedContentContainer.style.maxWidth=`${a}px`,this.focusedContentContainer.style.flexGrow="0",this.focusedContentContainer.style.flexShrink="0",this.focusedContentContainer.style.order="1";const o=Math.max(n,e-a);this.chatWidthContainer.style.width=`${o}px`,this.chatWidthContainer.style.minWidth=`${o}px`,this.chatWidthContainer.style.flexGrow="1",this.chatWidthContainer.style.flexShrink="0",this.chatWidthContainer.style.order="2",e>0&&(this.focusWidthProportion=a/e)}this.focusContentInner=document.createElement("div"),this.focusContentInner.classList.add("w-full","h-full","overflow-y-auto","overflow-x-hidden","relative"),this.focusedContentContainer.appendChild(this.focusContentInner);const i=this.createResizeHandle();if((t||s)&&(i.style.display="none"),this.focusedContentContainer.appendChild(i),this.focusContentInner.appendChild(this.object.focus(this.payload)),this.chatContainer.prepend(this.focusedContentContainer),this.initialAnimationDone)this.focusedContentContainer.classList.add("focus-visible-static");else{this.focusedContentContainer.classList.add("focus-maximize-in");const e=()=>{this.focusedContentContainer.removeEventListener("animationend",e),this.focusedContentContainer.classList.remove("focus-maximize-in"),this.focusedContentContainer.classList.add("focus-visible-static"),this.initialAnimationDone=!0};this.focusedContentContainer.addEventListener("animationend",e),setTimeout((()=>{this.initialAnimationDone||(this.focusedContentContainer.removeEventListener("animationend",e),this.focusedContentContainer.classList.remove("focus-maximize-in"),this.focusedContentContainer.classList.add("focus-visible-static"),this.initialAnimationDone=!0)}),350)}const n=ke.chatInstances[this.chatId];n&&n.chatSession&&n.chatSession.focusMode(!0,this.object)}updateFocusContent(e,t){if(this.object&&"function"==typeof this.object.closeFocus&&"function"==typeof this.object.maximizeInChat&&this.object.closeFocus(),this.object=e,this.focusContentInner){const e=document.createElement("div");e.classList.add("w-full","h-full","absolute","top-0","left-0","opacity-0","transition-opacity","duration-300","ease-in-out"),e.appendChild(this.object.focus(t)),this.focusContentInner.appendChild(e),e.offsetWidth;const s=Array.from(this.focusContentInner.childNodes);s.forEach((t=>{t.style.opacity=t===e?"1":"0"})),setTimeout((()=>{s.forEach((t=>{t!==e&&t.parentNode===this.focusContentInner&&this.focusContentInner.removeChild(t)})),e.classList.remove("absolute","top-0","left-0")}),300)}else this.findFocusContainer(),this.createFocus()}close(){const e=ke.chatInstances[this.chatId];if(e&&e.chatSession&&e.chatSession.focusMode(!1),!this.focusedContentContainer)return G.openFocuses.get(this.chatId)===this&&G.openFocuses.delete(this.chatId),this.closeCallback&&this.closeCallback(this),void window.removeEventListener("resize",this.resizeHandler);this.focusedContentContainer.animate([{transform:"scale(1)",opacity:1},{transform:"scale(0.8)",opacity:0}],{duration:300,easing:"ease-in-out"}).onfinish=()=>{this.focusedContentContainer&&this.focusedContentContainer.parentNode&&this.focusedContentContainer.remove(),G.openFocuses.get(this.chatId)===this&&G.openFocuses.delete(this.chatId),this.originalChatContentWrapper&&(this.originalChatContentWrapper.style.width="100%",this.originalChatContentWrapper.style.minWidth="",this.originalChatContentWrapper.style.maxWidth="",this.originalChatContentWrapper.style.display="",this.originalChatContentWrapper.style.flexGrow="",this.originalChatContentWrapper.style.order=""),this.toggleTitleMenu(),this.focusedContentContainer=null,window.removeEventListener("resize",this.resizeHandler),this.closeCallback&&this.closeCallback(this)}}toggleTitleMenu(){const e=document.getElementById("title-menu");e&&e.classList.toggle("hidden")}createResizeHandle(){const e=document.createElement("div");let t,s,i;e.classList.add("resize-handle","mt-1","z-50","rounded-full");let n=!1;const a=window.innerWidth<768?300:500,o=this.minChatWidth,r=e=>{if(!n)return;if(!this.focusedContentContainer||!this.chatWidthContainer)return;const r=e.clientX-t;let l=s+r,c=i-r;const d=this.chatContainer.offsetWidth;l=Math.max(a,Math.min(l,2e3)),d-l<o&&(l=d-o),l=Math.max(a,l),c=d-l,c<o&&(c=o,l=d-c),d<a+o&&(l=Math.min(d-o,d*this.focusWidthProportion),l=Math.max(0,l),c=d-l),d>0&&(this.focusWidthProportion=l/d),this.focusedContentContainer.style.width=`${l}px`,this.focusedContentContainer.style.minWidth=`${l}px`,this.focusedContentContainer.style.maxWidth=`${l}px`,this.chatWidthContainer.style.width=`${c}px`,this.chatWidthContainer.style.minWidth=`${c}px`},l=()=>{n&&(n=!1,document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l),document.removeEventListener("mouseleave",l),this.removeResizeOverlay(),e.classList.remove("active"))};return e.addEventListener("mousedown",(a=>{window.innerWidth<1024||(a.preventDefault(),n=!0,t=a.clientX,s=this.focusedContentContainer.offsetWidth,i=this.chatWidthContainer.offsetWidth,this.createResizeOverlay(),document.addEventListener("mousemove",r),document.addEventListener("mouseup",l),document.addEventListener("mouseleave",l),e.classList.add("active"))})),e}createResizeOverlay(){this.resizeOverlay||(this.resizeOverlay=document.createElement("div"),this.resizeOverlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            z-index: 9999;\n            cursor: ew-resize;\n        ",document.body.appendChild(this.resizeOverlay))}removeResizeOverlay(){this.resizeOverlay&&(this.resizeOverlay.remove(),this.resizeOverlay=null)}recalculateWidths(){if(!this.chatContainer||!this.focusedContentContainer||!this.chatWidthContainer)return;const e=this.chatContainer.offsetWidth,t=window.innerWidth<640,s=window.innerWidth<1024,i=this.focusedContentContainer.querySelector(".resize-handle");if(t||s)this.focusedContentContainer.style.width="100%",this.focusedContentContainer.style.minWidth="100%",this.focusedContentContainer.style.maxWidth="100%",this.focusedContentContainer.style.order="1",this.chatWidthContainer.style.width="0px",this.chatWidthContainer.style.minWidth="0px",this.chatWidthContainer.style.display="none",this.chatWidthContainer.style.order="2",i&&(i.style.display="none");else{this.chatWidthContainer.style.display="",i&&(i.style.display="");const t=500,s=1400,n=this.minChatWidth;let a=Math.round(e*this.focusWidthProportion);e>n&&e-a<n?a=e-n:e<=n&&(a=Math.max(t,.8*e)),a=Math.max(t,Math.min(a,s)),e<t+n&&(a=Math.min(e-n,e*this.focusWidthProportion),a=Math.max(0,a)),this.focusedContentContainer.style.width=`${a}px`,this.focusedContentContainer.style.minWidth=`${a}px`,this.focusedContentContainer.style.maxWidth=`${a}px`,this.focusedContentContainer.style.order="1",this.focusedContentContainer.style.flexGrow="0",this.focusedContentContainer.style.flexShrink="0";const o=Math.max(n,e-a);this.chatWidthContainer.style.width=`${o}px`,this.chatWidthContainer.style.minWidth=`${o}px`,this.chatWidthContainer.style.order="2",this.chatWidthContainer.style.flexGrow="1",this.chatWidthContainer.style.flexShrink="0",e>0&&(this.focusWidthProportion=a/e)}}}class K extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this.videoData={},this.touchStartX=0,this.touchEndX=0,this.handleTouchStart=this.handleTouchStart.bind(this),this.handleTouchEnd=this.handleTouchEnd.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.downloadVideo=this.downloadVideo.bind(this),this.createFocus=this.createFocus.bind(this)}connectedCallback(){this.render()}static get observedAttributes(){return["url","video-name","chat-id"]}attributeChangedCallback(e,t,s){t!==s&&this.render()}render(){this.innerHTML="";const e=this.getAttribute("url"),t=this.getAttribute("video-name")||"video.mp4";if(this.chatId=this.getAttribute("chat-id"),!e)return;this.videoData={url:e,filename:t};const s=document.createElement("div");s.className="relative cursor-pointer py-2 inline-flex";const i=document.createElement("video");i.src=e,i.className="rounded-md internal-video max-w-full max-h-96",i.preload="metadata",i.controls=!0,i.addEventListener("loadeddata",(()=>{i.currentTime=.1}),{once:!0}),s.appendChild(i);const a=document.createElement("div");a.className="absolute top-4 right-2 z-30 hidden";const r=document.createElement("div");r.className="flex gap-0.5",a.appendChild(r),s.appendChild(a);const l=new n.$({type:"focus",size:"icon",svgPathData:o.A.name("cloudDownload").path,svgViewBox:o.A.name("cloudDownload").viewBox,iconHeightAndWidth:"w-6 h-6"}),c=new n.$({type:"focus",size:"icon",svgPathData:o.A.name("focus").path,svgViewBox:o.A.name("focus").viewBox,iconHeightAndWidth:"w-6 h-6"});l.render(r),c.render(r),u.K.isOnTouchDevice?a.classList.remove("hidden"):(s.addEventListener("mouseover",(()=>a.classList.remove("hidden"))),s.addEventListener("mouseleave",(()=>a.classList.add("hidden")))),c.onClick((()=>this.createFocus())),l.onClick((()=>this.downloadVideo())),i.addEventListener("click",(e=>e.stopPropagation())),this.appendChild(s)}handleTouchStart(e){this.touchStartX=e.touches[0].clientX}handleTouchEnd(e){this.touchEndX=e.changedTouches[0].clientX,this.handleSwipe()}handleSwipe(){this.touchStartX-this.touchEndX>50?this.navigateVideos("next"):this.touchEndX-this.touchStartX>50&&this.navigateVideos("previous")}handleKeyDown(e){"Escape"===e.key&&this.closeFocus()}createFocus(){if(!this.videoData)return;let e=this.chatId||ke.activeChat?.id;e&&ke.chatInstances[e]&&(this.focusModal=new G(e,this,this.videoData))}focus(e){this.wrapper=document.createElement("div"),this.wrapper.className="rounded-tr-md z-40 h-full flex flex-col";const t=this.createMenuOptions(),s=new D(t).create();this.wrapper.appendChild(s);const i=document.createElement("div");i.className=`relative flex-grow rounded-b-lg overflow-hidden ${this.theme.lightboxBackground}`;const n=document.createElement("div");n.className="w-full h-full p-2 pb-[25px] flex justify-center items-center";const a=document.createElement("video");return a.src=e.url,a.controls=!0,a.className="max-w-full max-h-full rounded-md",n.appendChild(a),i.appendChild(n),this.wrapper.appendChild(i),document.addEventListener("keydown",this.handleKeyDown),i.addEventListener("touchstart",this.handleTouchStart),i.addEventListener("touchend",this.handleTouchEnd),this.focusedVideoContentContainer=i,this.wrapper}closeFocus(){this.focusModal&&(this.focusModal.close(),this.focusModal=null),document.removeEventListener("keydown",this.handleKeyDown),this.focusedVideoContentContainer&&(this.focusedVideoContentContainer.removeEventListener("touchstart",this.handleTouchStart),this.focusedVideoContentContainer.removeEventListener("touchend",this.handleTouchEnd),this.focusedVideoContentContainer=null)}createMenuOptions(){return{title:this.videoData.filename||"Video",mode:"focus",fileMenu:[{type:"item",label:"Download",onClick:()=>this.downloadVideo()}],quickActions:[{type:"icon",icon:"cloudDownload",hoverText:"Download",onClick:()=>this.downloadVideo()}],onExitFocus:()=>this.closeFocus()}}async downloadVideo(){try{const e=await fetch(this.videoData.url),t=await e.blob();let s=this.videoData.filename||"video.mp4";s.endsWith(".mp4")||(s+=".mp4");const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(i)}catch(e){}}}customElements.define("output-video",K);class Y{constructor(e,t,s=!1,n=!1,a=!1){this.files=e,this.chat=t,this.theme=i.A.theme,this.rightAlign=s,this.fullWidth=n||!1,this.forceFile=a,this.audioItemsContainer=null}makeImagesArray(e){if(!e)return[];const t=[];return e.forEach((e=>{const s=e.name?.split(".").pop().toLowerCase();let i=["jpg","jpeg","png","gif","svg","webp"].includes(s);"image"===e.type&&(i=!0),i&&t.push(e)})),t}makeVideosArray(e){if(!e)return[];const t=[];return e.forEach((e=>{const s=e.name?.split(".").pop().toLowerCase();let i=["mp4","mov","avi","mkv","webm"].includes(s);"video"===e.type&&(i=!0),i&&t.push(e)})),t}makeAudiosArray(e){if(!e)return[];const t=[];return e.forEach((e=>{const s=e.name?.split(".").pop().toLowerCase();let i=["mp3","wav","ogg","flac","m4a","amr","aiff","wma","aac","opus"].includes(s);"audio"===e.type&&(i=!0),i&&t.push(e)})),t}createAudioItems(){this.audiosArray&&0!==this.audiosArray.length&&(this.audioItemsContainer.innerHTML="",this.audioItemsContainer.className="space-y-2",this.rightAlign&&this.audioItemsContainer.classList.add("flex","flex-col","items-end"),this.audiosArray.forEach((e=>{const t=document.createElement("audio-player");if(this.audioItemsContainer.appendChild(t),e.loading)t.showLoadingIndicator();else{const s=e.url||(e instanceof File?URL.createObjectURL(e):"");t.setAttribute("audio-url",s),t.setAttribute("audio-name",e.name),this.chat&&this.chat.id&&t.setAttribute("chat-id",this.chat.id),this.rightAlign&&t.setAttribute("right-align",""),e.transcript&&t.setAttribute("transcript",e.transcript),e.transcriptSummary&&t.setAttribute("transcript-summary",e.transcriptSummary)}})))}render(){return this.outputContainer=document.createElement("div"),this.outputContainer.classList="space-y-2",this.fileItems=document.createElement("div"),this.fileItems.classList=this.rightAlign?"flex flex-wrap gap-2 justify-end pt-2":"space-y-2",this.imagesArray=[],this.videosArray=[],this.audiosArray=[],this.files.forEach((e=>{const t=e.name?.split(".").pop().toLowerCase();let s=["jpg","jpeg","png","gif","svg","webp"].includes(t),i=["mp4","mov","avi","mkv","webm"].includes(t),n=["mp3","wav","ogg","flac","m4a","amr","aiff","wma","aac","opus"].includes(t),a="youtube"===e.file_type,o="crawl"===e.file_type;if("image"===e.type?s=!0:"video"===e.type?i=!0:"audio"===e.type&&(n=!0),this.forceFile){const s=this.createFileItem(e,t);this.fileItems.appendChild(s)}else if(s)this.imagesArray.push(e);else if(i)this.videosArray.push(e);else if(n)this.audiosArray.push(e);else if(a)this.createYouTubeItem(e);else if(o)this.createURLItem(e);else{const s=this.createFileItem(e,t);this.fileItems.appendChild(s)}})),this.outputContainer.appendChild(this.fileItems),this.forceFile||(this.imagesArray.length>0&&this.createImageItems(),this.videosArray.length>0&&this.createVideoItems(),this.audioItemsContainer=document.createElement("div"),this.outputContainer.appendChild(this.audioItemsContainer),this.audiosArray.length>0&&this.createAudioItems()),this.outputContainer}createFileItem(e,t){const s=document.createElement("div");s.classList="relative p-0.5 cursor-pointer select-none file-item";const n=document.createElement("div");n.classList=`rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-2 flex items-center gap-2 file-item-detail`,this.fullWidth?n.classList.add("w-full"):n.classList.add("w-[255px]","sm:w-[280px]"),n.dataset.file=e.name,n.dataset.fileType=e.file_type,n.dataset.fileExtension=t;const a=Y.getFileColor(e.file_type,t),o=document.createElement("div");o.classList=`w-10 h-10 rounded-md ${a} ${i.A.theme.fileIconColor} flex justify-center items-center flex-shrink-0`,o.innerHTML=Y.getFileIcon(e,t);const r=document.createElement("div");r.classList="flex flex-col text-left overflow-hidden flex-grow min-h-0 max-w-[calc(100%-2.5rem)]",r.style.cssText="display: flex; flex-direction: column; gap: 0.125rem;";const l=document.createElement("div");l.classList="text-left text-sm truncate w-full",l.style.cssText="line-height: 1.2; max-height: 1.2em; overflow: hidden;",l.textContent=e.name;const c=document.createElement("div");return c.classList=`text-sm ${this.theme.fadedText}`,c.style.cssText="line-height: 1.2; max-height: 1.2em; overflow: hidden;",c.textContent=Y.getFileType(e.file_type,t),r.appendChild(l),r.appendChild(c),n.appendChild(o),n.appendChild(r),s.appendChild(n),s}createYouTubeItem(e){const t=e.file_path,s=Y.getFileColor(e.file_type,e.name.split(".").pop().toLowerCase()),n=document.createElement("div");n.classList="w-full max-w-[260px] sm:max-w-[400px]";const a=document.createElement("a");a.classList="relative p-0.5 cursor-pointer select-none file-item block",a.dataset.file=e.name,a.href=t,a.target="_blank";const r=document.createElement("div");r.classList=`rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-3 flex flex-col gap-3 truncate`;const l=document.createElement("div");if(l.classList=`w-full h-auto rounded-md ${s} ${i.A.theme.fileIconColor} flex justify-center items-center flex-shrink-0 overflow-hidden`,e.file_thumbnail_url)l.innerHTML=`<img src="${e.file_thumbnail_url}" alt="${e.name}" class="w-full h-auto rounded-md object-cover">`;else{const e=o.A.name("youtube"),t="w-10 h-10 sm:w-12 sm:h-12 fill-current pointer-events-none",s=`<svg viewBox="${e.viewBox}" aria-hidden="true" focusable="false" class="${t}"><path d="${e.path}"></path></svg>`,i=document.createElement("div");i.className="w-full flex h-[120px] sm:h-[200px] justify-center items-center",i.innerHTML=s,l.innerHTML="",l.appendChild(i)}const c=document.createElement("div");c.classList="flex flex-col text-left truncate gap-1";const d=document.createElement("div");d.classList="text-left text-sm font-semibold truncate",d.textContent=e.name;const h=document.createElement("div");h.classList=`text-sm ${this.theme.fadedText} truncate w-full`,h.style.cssText="line-height: 1.2; max-height: 1.2em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;",h.textContent=Y.getFileType(e.file_type,e.name.split(".").pop().toLowerCase()),c.appendChild(d),c.appendChild(h),r.appendChild(l),r.appendChild(c),a.appendChild(r),n.appendChild(a),this.fileItems.appendChild(n)}createURLItem(e){const t=document.createElement("div");t.classList="w-full max-w-[260px] sm:max-w-[400px]";const s=document.createElement("a");s.classList="relative p-0.5 cursor-pointer select-none file-item block",s.dataset.file=e.name,s.href=e.file_path,s.target="_blank",s.rel="noopener noreferrer";const n=document.createElement("div");n.classList=`rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-3 flex items-center gap-3`;const a=document.createElement("div");if(a.classList=`w-10 h-10 rounded-md ${i.A.theme.fileDocColor} ${i.A.theme.fileIconColor} flex justify-center items-center flex-shrink-0`,e.file_thumbnail_url)a.innerHTML=`<img src="${e.file_thumbnail_url}" alt="${e.name}" class="w-6 h-6 object-cover rounded-sm">`;else{const e=o.A.name("globe"),t="w-6 h-6 fill-current pointer-events-none",s=`<svg viewBox="${e.viewBox}" aria-hidden="true" focusable="false" class="${t}"><path d="${e.path}"></path></svg>`;a.innerHTML=s}const r=document.createElement("div");r.classList="flex flex-col text-left truncate leading-4";const l=document.createElement("div");l.classList="text-left text-sm font-semibold truncate","Unknown"!==e.name&&e.name||(e.name="Web crawl"),l.textContent=e.name;const c=document.createElement("div");c.classList=`text-sm ${this.theme.fadedText} truncate`,c.textContent=e.file_path||"URL not available",r.appendChild(l),r.appendChild(c),n.appendChild(a),n.appendChild(r),s.appendChild(n),t.appendChild(s),this.fileItems.appendChild(t)}updateFiles(e){if(this.imagesArray=this.makeImagesArray(e),this.videosArray=this.makeVideosArray(e),this.audiosArray=this.makeAudiosArray(e),this.images&&this.images instanceof HTMLElement&&"output-image"===this.images.tagName.toLowerCase()){const e=[];let t=0;this.imagesArray.forEach((s=>{s.loading?t++:e.push({url:s.url||(s instanceof File?URL.createObjectURL(s):""),alt:s.alt||s.name||"Image",filename:s.name||"image.png"})})),t>0?(this.images.setAttribute("loading-count",t.toString()),e.length>0&&this.images.removeAttribute("images")):e.length>0&&(this.images.setAttribute("images",JSON.stringify(e)),this.images.removeAttribute("loading-count"))}this.videos&&this.videos.init(this.videosArray),this.audioItemsContainer&&this.createAudioItems()}createImageItems(){if(!this.imagesArray||0===this.imagesArray.length)return;const e=document.createElement("output-image");this.chat&&this.chat.id&&e.setAttribute("chat-id",this.chat.id),this.rightAlign&&e.setAttribute("right-align",""),this.fullWidth&&e.setAttribute("full-width","");let t=0;const s=[];this.imagesArray.forEach((e=>{e.loading?t++:s.push({url:e.url||(e instanceof File?URL.createObjectURL(e):""),alt:e.alt||e.name||"Image",filename:e.name||"image.png"})})),t>0?e.setAttribute("loading-count",t.toString()):s.length>0&&e.setAttribute("images",JSON.stringify(s)),this.images=e,this.outputContainer.appendChild(e)}createVideoItems(){this.videosArray&&0!==this.videosArray.length&&this.videosArray.forEach((e=>{if(e.loading)return;const t=document.createElement("output-video"),s=e.url||(e instanceof File?URL.createObjectURL(e):"");t.setAttribute("url",s),t.setAttribute("video-name",e.name),this.chat&&this.chat.id&&t.setAttribute("chat-id",this.chat.id),this.outputContainer.appendChild(t)}))}static getFileType(e,t){if("youtube"===e)return"YouTube video";if("crawl"===e)return"Web crawl";return t&&{pdf:"PDF",pdb:"Click to open visualizer",jpg:"Image",jpeg:"Image",png:"Image",svg:"Image",gif:"Image",doc:"Document",docx:"Document",csv:"CSV",xls:"Spreadsheet",xlsx:"Spreadsheet",ppt:"Presentation",pptx:"Presentation",txt:"Text",rtf:"Text",mp3:"Audio",wav:"Audio",ogg:"Audio",flac:"Audio",m4a:"Audio",amr:"Audio",aiff:"Audio",wma:"Audio",aac:"Audio",opus:"Audio",mp4:"Video",mov:"Video",avi:"Video",mkv:"Video",webm:"Video",zip:"Archive",rar:"Archive","7z":"Archive",tar:"Archive",gz:"Archive",bz2:"Archive",html:"HTML",css:"CSS",js:"JavaScript",py:"Python",java:"Java",c:"C",cpp:"C++",cs:"C#",php:"PHP",rb:"Ruby",go:"Go",swift:"Swift",kt:"Kotlin",ts:"TypeScript",json:"JSON",xml:"XML",svg:"SVG"}[t.toLowerCase()]||"File"}static getFileIcon(e,t){const s={pdf:"filePDF",doc:"fileWord",docx:"fileWord",csv:"fileLines",xls:"fileLines",xlsx:"fileLines",ppt:"file",pptx:"file",txt:"fileLines",rtf:"fileLines",pdb:"molecule",jpg:"fileImage",jpeg:"fileImage",png:"fileImage",gif:"fileImage",svg:"fileImage",webp:"fileImage",mp3:"fileAudio",wav:"fileAudio",ogg:"fileAudio",flac:"fileAudio",m4a:"fileAudio",amr:"fileAudio",aiff:"fileAudio",wma:"fileAudio",aac:"fileAudio",opus:"fileAudio",mp4:"fileVideo",mov:"fileVideo",avi:"fileVideo",mkv:"fileVideo",webm:"fileVideo",html:"fileLines",css:"fileLines",js:"fileLines",py:"fileLines",java:"fileLines",c:"fileLines",cpp:"fileLines",cs:"fileLines",php:"fileLines",rb:"fileLines",go:"fileLines",swift:"fileLines",kt:"fileLines",ts:"fileLines",json:"fileLines",xml:"fileLines",r:"fileLines",dart:"fileLines",sh:"fileLines",sql:"fileLines",pl:"fileLines",lua:"fileLines",asm:"fileLines",zip:"fileZIP",rar:"fileZIP","7z":"fileZIP",tar:"fileZIP",gz:"fileZIP",bz2:"fileZIP",youtube:"youtube",crawl:"globe"};let i="file";e&&"youtube"===e.file_type?i="youtube":e&&"crawl"===e.file_type?i="globe":t&&s[t.toLowerCase()]?i=s[t.toLowerCase()]:e&&e.type&&(e.type.startsWith("image/")?i="fileImage":e.type.startsWith("video/")?i="fileVideo":e.type.startsWith("audio/")?i="fileAudio":e.type.startsWith("text/")&&(i="fileLines"));const n=o.A.name(i);return`<svg viewBox="${n.viewBox}" aria-hidden="true" focusable="false" class="w-5 h-5 fill-current pointer-events-none"><path d="${n.path}"></path></svg>`}static getFileColor(e,t){if("youtube"===e)return i.A.theme.fileVideoColor;if("crawl"===e)return i.A.theme.fileOtherColor;return{pdf:i.A.theme.filePDFColor,pdb:i.A.theme.fileSpreadsheetColor,jpg:i.A.theme.fileImageColor,jpeg:i.A.theme.fileImageColor,png:i.A.theme.fileImageColor,gif:i.A.theme.fileImageColor,doc:i.A.theme.fileDocColor,docx:i.A.theme.fileDocColor,xls:i.A.theme.fileSpreadsheetColor,xlsx:i.A.theme.fileSpreadsheetColor,ppt:i.A.theme.fileSpreadsheetColor,pptx:i.A.theme.fileSpreadsheetColor,txt:i.A.theme.fileOtherColor,mp3:i.A.theme.fileAudioColor,wav:i.A.theme.fileAudioColor,ogg:i.A.theme.fileAudioColor,flac:i.A.theme.fileAudioColor,m4a:i.A.theme.fileAudioColor,mp4:i.A.theme.fileVideoColor,mov:i.A.theme.fileVideoColor,avi:i.A.theme.fileVideoColor,mkv:i.A.theme.fileVideoColor,webm:i.A.theme.fileVideoColor,zip:i.A.theme.fileOtherColor,rar:i.A.theme.fileOtherColor,"7z":i.A.theme.fileOtherColor,tar:i.A.theme.fileOtherColor,gz:i.A.theme.fileOtherColor,bz2:i.A.theme.fileOtherColor}[t?.toLowerCase()]||i.A.theme.fileOtherColor}}var X=s(19878);class J{constructor(e){switch(this.config=e,this.container=null,this.fileContainer=null,this.uploadHelper=null,this.placeholderMessage=null,this.orMessage=null,this.fileInput=null,this.clickMessage=null,this.uploadHelper=null,this.chatId=e.chatId||null,this.counter=0,this.totalFiles=0,this.validFiles=[],this.uploadedFiles=[],this.fileNames=[],this.filesBeingProcessed=[],this.uploadIds={},this.validate=this.validate.bind(this),this.onChangeCallback=null,this.onFileAddedCallback=null,this.onFileRemovedCallback=null,e.uiType){case"uploadBox":this.init();break;case"chat":this.initChatMode()}}initChatMode(){}validate(){return!this.config.required||(this.filesBeingProcessed&&this.filesBeingProcessed.length>0?void new c.y("Files are still uploading, please wait","error",!0,!0):this.uploadedFiles.length>0||void new c.y("Please upload a file","error",!0,!0))}init(){this._createAndSetFileInput(),this.container=document.createElement("div"),this.container.classList.add("space-y-2"),this.buttonContainer=document.createElement("div"),this.buttonContainer.classList="flex justify-between items-center align-middle gap-2",this.labelContainer=document.createElement("div"),this.label=this.config.label,this.labelContainer.classList=`${i.A.theme.text} font-medium`,this.labelContainer.textContent=this.label,this.buttonContainer.appendChild(this.labelContainer),!1!==this.config.showUploadButton&&(this.uploadButton=new n.$({text:"+ Upload",type:"link",size:"link-sm",icon:"upload"}),this.uploadButton.render(this.buttonContainer),this.uploadButton.onClick((()=>{this.triggerFileSelection()}))),this.container.appendChild(this.buttonContainer),this.fileContainer=document.createElement("div");const e=this.config.uploadBoxHeight||"min-h-[130px]";this.fileContainer.classList=`rounded-md border-2 border-dashed ${i.A.theme.inputBorder} ${i.A.theme.inputBackground} p-4 overflow-x-hidden grid ${e} max-h-[500px] overflow-y-auto gap-4 cursor-pointer`,this.fileContainer.style.gridTemplateColumns="repeat(auto-fill, minmax(300px, 1fr))",this.fileContainer.style.gridAutoRows="min-content",this.fileContainer.style.alignContent="start",this.fileContainer.addEventListener("click",(e=>{e.target.closest("[data-file]")||this.triggerFileSelection()})),this.uploadHelper=document.createElement("div"),this.uploadHelper.classList=`flex justify-center align-middle items-center gap-1 text-base ${i.A.theme.memoryPlaceholderText} pointer-events-none`,this.uploadHelper.style.gridColumn="1 / -1",this.uploadHelper.style.minHeight="100px",this.placeholderMessage=document.createElement("div"),this.placeholderMessage.textContent=this.config.placeholderText||"Drag and drop or select to upload",this.uploadHelper.appendChild(this.placeholderMessage),this.fileContainer.appendChild(this.uploadHelper),this.container.appendChild(this.fileContainer),this.addEventListeners()}addEventListeners(){this.fileContainer&&(this.fileContainer.addEventListener("dragenter",this.handleDragEnter.bind(this),!1),this.fileContainer.addEventListener("dragover",this.handleDragOver.bind(this),!1),this.fileContainer.addEventListener("dragleave",this.handleDragLeave.bind(this),!1),this.fileContainer.addEventListener("drop",this.handleDrop.bind(this),!1))}addHoverBorder(){const e=this.config.uploadBoxHeight||"min-h-[130px]";this.fileContainer.classList=`rounded-md border-2 border-dashed ${i.A.theme.inputSelectedBorder} ${i.A.theme.inputBackground} p-4 overflow-x-hidden grid ${e} max-h-[500px] overflow-y-auto gap-4 cursor-pointer`,this.fileContainer.style.gridTemplateColumns="repeat(auto-fill, minmax(300px, 1fr))",this.fileContainer.style.gridAutoRows="min-content",this.fileContainer.style.alignContent="start"}removeHoverBorder(){const e=this.config.uploadBoxHeight||"min-h-[130px]";this.fileContainer.classList=`rounded-md border-2 border-dashed ${i.A.theme.inputBorder} ${i.A.theme.inputBackground} p-4 overflow-x-hidden grid ${e} max-h-[500px] overflow-y-auto gap-4 cursor-pointer`,this.fileContainer.style.gridTemplateColumns="repeat(auto-fill, minmax(300px, 1fr))",this.fileContainer.style.gridAutoRows="min-content",this.fileContainer.style.alignContent="start"}handleDragEnter(e){e.preventDefault(),e.stopPropagation(),this.counter++,1===this.counter&&this.addHoverBorder()}handleDragLeave(e){e.preventDefault(),e.stopPropagation(),this.counter--,0===this.counter&&this.removeHoverBorder()}handleDragOver(e){e.preventDefault(),e.stopPropagation()}handleDrop(e){e.preventDefault(),e.stopPropagation();let t=null;e.dataTransfer&&e.dataTransfer.files&&e.dataTransfer.files.length>0?(t=e.dataTransfer.files,this.fileContainer&&(this.counter=0,this.removeHoverBorder())):e.target&&e.target.files&&e.target.files.length>0&&(t=e.target.files),t&&t.length>0&&this.validateFiles(t),e.target&&"file"===e.target.type&&(e.target.value=null)}triggerChange(){"function"==typeof this.onChangeCallback&&this.onChangeCallback()}validateFiles(e){if(this.validFiles=[],this.config.allowedTypes)for(let t of e)if(!this.isAllowedFileType(t)){new c.y(`${t.name} is not of an allowed file type.`,"warning",!0,!0);return}if(e.length+this.totalFiles>this.config.maxFiles){new c.y(`You can only upload a maximum of ${this.config.maxFiles} files.`,"warning",!0,!0);return}let t=0;for(let s of e){if(t=Number((s.size/1024/1024).toFixed(0)),t>this.config.maxSizePerFile){new c.y(`${s.name} exceeds the max file size (${this.config.maxSizePerFile}MB)`,"warning",!0,!0);return}this.validFiles.push(s)}let s=0;for(let e of this.validFiles)if(s+=Number((e.size/1024/1024).toFixed(0)),s>this.config.maxTotalSize){new c.y(`Total file size exceeds ${this.config.maxTotalSize}MB.`,"warning",!0,!0);return}this.totalFiles+=this.validFiles.length,this.validFiles.length>0&&this.triggerChange(),this.uploadFiles()}isAllowedFileType(e){return!0}removeFileFromProcessing(e){const t=this.filesBeingProcessed.indexOf(e);-1!==t&&this.filesBeingProcessed.splice(t,1),this.triggerChange()}isFileBeingProcessed(e){return this.filesBeingProcessed.includes(e)}get isUploadInProgress(){return this.filesBeingProcessed.length>0}get files(){return this.uploadedFiles}get value(){const e={};for(const t in this.uploadIds){const s=this.uploadIds[t];null!=s&&(e[t]=s)}return e}get fileUploadIds(){const e=[];for(const t in this.uploadIds){const s=this.uploadIds[t];null!=s&&e.push(String(s))}return e}uploadFiles(){this.xhrs=this.xhrs||{},this.filesBeingProcessed.push(...this.validFiles.map((e=>this.getFileKey(e))));for(let e of this.validFiles){const t=this.getFileKey(e),s=new FormData;s.append("file",e),this.chatId&&s.append("chat_id",this.chatId),this.addFile(e);const n=new XMLHttpRequest,a=(0,m.R)("csrftoken");n.open("POST","/chat/upload_files/",!0),n.setRequestHeader("X-CSRFToken",a),n.upload.addEventListener("progress",(e=>{if(e.lengthComputable){const s=Math.round(e.loaded/e.total*100);this.updateProgress(t,s)}}),!1),n.addEventListener("load",(()=>{if(200===n.status){const s=JSON.parse(n.response);this.removeFileFromProcessing(t),this.updateProgress(t,100);const i=URL.createObjectURL(e);e.fileUrl=i,this.uploadedFiles.push(e),s.file&&s.file.upload_id&&(e._serverUploadId=s.file.upload_id,this.uploadIds[t]=s.file.upload_id),this.triggerChange()}else{new c.y(`Error uploading ${e.name}, please try again.`,"error",!0,!0),this.updateProgress(t,10),this.removeFileFromProcessing(t);const s=document.querySelector(`[data-filering="${t}"]`);s&&(s.classList=`flex justify-center align-middle items-center rounded-md ${i.A.theme.text} ring-1 ${i.A.theme.errorRingColor} p-2 text-xs w-[120px] h-[80px] overflow-hidden`),this.triggerChange()}})),n.send(s),this.xhrs[t]=n}}processFiles(e){this.validateFiles(e)}onClose(e){new a("Are you sure?","This will remove the file and cancel the upload.").onConfirm((()=>{const t=e._fileKey||this.getFileKey(e);let s=this.uploadedFiles.indexOf(e);-1!==s&&this.uploadedFiles.splice(s,1);let i=this.validFiles.indexOf(e);-1!==i&&this.validFiles.splice(i,1);let n=this.fileNames.indexOf(e.name);-1!==n&&this.fileNames.splice(n,1),this.uploadIds[t]&&delete this.uploadIds[t],this.totalFiles--,this.xhrs&&this.xhrs[t]&&(this.xhrs[t].abort(),delete this.xhrs[t]),this.isFileBeingProcessed(t)&&this.removeFileFromProcessing(t);const a=document.querySelector(`[data-file="${t}"]`);a&&a.remove(),this.updatePlaceholderVisibility(),"chat"===this.config.uiType&&"function"==typeof this.onFileRemovedCallback&&this.onFileRemovedCallback();new c.y(`${e.name} removed`,"success",!0,!0);this.triggerChange()}))}updatePlaceholderVisibility(){if("chat"!==this.config.uiType){this.fileContainer.querySelectorAll("[data-file]").length>0?this.uploadHelper.classList.add("hidden"):this.uploadHelper.classList.remove("hidden")}}onFileRemoved(e){"function"==typeof e&&(this.onFileRemovedCallback=e)}getFileKey(e){if(!e._fileKey){const t="undefined"!=typeof crypto&&crypto.randomUUID?crypto.randomUUID():`fx_${Date.now()}_${Math.random().toString(36).slice(2)}`;e._fileKey=t}return e._fileKey}addFile(e){"chat"!==this.config.uiType&&this.uploadHelper.classList.add("hidden");const t=this.getFileKey(e),s=document.createElement("div");s.classList.add("relative","h-fit"),s.dataset.file=t,"chat"===this.config.uiType&&s.classList.add("max-w-xs","w-full","flex-shrink-0");const n=document.createElement("div");n.classList=`rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} p-2 flex justify-start items-center align-middle text-white gap-2 relative h-fit`,n.dataset.file=t;const a=document.createElement("div");a.classList=`absolute top-0 left-0 h-full ${i.A.theme.fileProgressBG} opacity-50`,a.style.width="0%",a.style.transition="opacity 1s ease",a.dataset.progress=t,a.style.borderRadius="0.375rem";const l=document.createElement("div");l.classList="flex gap-2 items-center relative z-10 w-full";const c=e.name.split(".").pop().toLowerCase(),d=["jpg","jpeg","png","gif","svg","webp"].includes(c),h="pdf"===c,m="csv"===c,u=["txt","js","py","html","css","json","md","sh","xml","yaml","log"].includes(c)||e.type.startsWith("text/"),p=document.createElement("div");if(p.classList.add("w-10","h-10","rounded-md","flex","justify-center","items-center","align-middle","flex-shrink-0"),d){p.classList.add("cursor-pointer");const t=new FileReader;t.onload=t=>{const s=t.target.result;e.base64URL=s,p.style.backgroundImage=`url('${s}')`,p.style.backgroundSize="cover",p.style.backgroundPosition="center",p.addEventListener("click",(t=>{t.stopPropagation();const i=document.createElement("img");i.src=s,i.classList="max-w-full max-h-full object-contain",this._createLightbox(e,i)}))},t.readAsDataURL(e)}else if(h){const t=Y.getFileColor(null,c);p.classList.add(...t.split(" "),i.A.theme.fileIconColor,"cursor-pointer"),p.innerHTML=Y.getFileIcon(null,c),p.addEventListener("click",(t=>{t.stopPropagation();const s=URL.createObjectURL(e),i=document.createElement("iframe");i.src=s,i.className="w-full h-full border-0",this._createLightbox(e,i,(()=>URL.revokeObjectURL(s)))}))}else if(m){const t=Y.getFileColor(null,c);p.classList.add(...t.split(" "),i.A.theme.fileIconColor,"cursor-pointer"),p.innerHTML=Y.getFileIcon(null,c),p.addEventListener("click",(t=>{t.stopPropagation();const s=new FileReader;s.onload=t=>{const s=t.target.result.trim().split("\n"),n=s.shift().split(","),a=document.createElement("div");a.className=`w-full h-full ${i.A.theme.modalBackground} overflow-auto p-4`;const o=document.createElement("table");o.className="w-full text-sm text-left";const r=document.createElement("thead");r.className=`text-xs ${i.A.theme.tableHeaderText} uppercase ${i.A.theme.secondaryBackground} sticky top-0`;const l=document.createElement("tr");n.forEach((e=>{const t=document.createElement("th");t.className="px-6 py-3",t.textContent=e.trim(),l.appendChild(t)})),r.appendChild(l),o.appendChild(r);const c=document.createElement("tbody");s.forEach(((e,t)=>{const s=document.createElement("tr");s.className=`${t%2==0?i.A.theme.modalBackground:i.A.theme.secondaryBackground} border-b ${i.A.theme.tableDividerLine}`,e.split(",").forEach((e=>{const t=document.createElement("td");t.className="px-6 py-4",t.textContent=e.trim(),s.appendChild(t)})),c.appendChild(s)})),o.appendChild(c),a.appendChild(o),this._createLightbox(e,a)},s.readAsText(e)}))}else if(u){const t=Y.getFileColor(null,c);p.classList.add(...t.split(" "),i.A.theme.fileIconColor,"cursor-pointer"),p.innerHTML=Y.getFileIcon(null,c),p.addEventListener("click",(t=>{t.stopPropagation();const s=new FileReader;s.onload=t=>{const s=t.target.result,i=X.A.highlightAuto(s),n=document.createElement("pre");n.className="h-full";const a=document.createElement("code");a.className=`hljs language-${i.language}`,a.innerHTML=i.value,n.appendChild(a),this._createLightbox(e,n)},s.readAsText(e)}))}else{const e=Y.getFileColor(null,c);p.classList.add(...e.split(" "),i.A.theme.fileIconColor),p.innerHTML=Y.getFileIcon(null,c)}l.appendChild(p);const g=document.createElement("div");g.classList="flex flex-col text-left truncate w-full";const f=document.createElement("div");f.classList=`text-left text-sm truncate ${i.A.theme.fileNameText}`,f.textContent=e.name;const v=document.createElement("div");v.classList=`text-sm ${i.A.theme.fileSubText}`,v.textContent=Y.getFileType(e.file_type,c),g.appendChild(f),g.appendChild(v),l.appendChild(g);const y=document.createElement("button");y.classList=`absolute -top-2 -right-2 w-6 h-6 rounded-full ${i.A.theme.text} ${i.A.theme.secondaryBackground} flex flex-shrink-0 justify-center align-middle items-center z-30`;const w=o.A.name("xmark"),b=new r.I({pathData:w.path,viewBox:w.viewBox,sizeClasses:"w-3 h-3"});y.appendChild(b.element),y.dataset.file="remove-"+t,y.addEventListener("click",(t=>{t.stopPropagation(),t.preventDefault(),this.onClose(e)})),n.appendChild(a),n.appendChild(l),s.appendChild(n),s.appendChild(y),"chat"===this.config.uiType?"function"==typeof this.onFileAddedCallback&&this.onFileAddedCallback(s):this.fileContainer.appendChild(s),this.updatePlaceholderVisibility()}_createLightbox(e,t,s){if(document.querySelector(".file-upload-lightbox"))return;const n=document.createElement("div");n.classList=`file-upload-lightbox fixed inset-0 ${i.A.theme.overlayFadeBackground} flex justify-center items-center z-[9999] transition-opacity duration-300 p-4`;const a=document.createElement("div");a.className=`relative flex flex-col w-full h-full max-w-[95vw] max-h-[95vh] ${i.A.theme.modalBackground} rounded-lg shadow-2xl overflow-hidden`;const l=document.createElement("div");l.className=`flex justify-between items-center p-3 ${i.A.theme.secondaryBackground} border-b ${i.A.theme.modalSeperationBorderColor} flex-shrink-0`;const c=document.createElement("div");c.className="flex items-center gap-2 overflow-hidden";const d=document.createElement("div");d.className=`${i.A.theme.text} font-semibold truncate`,d.textContent=e.name,c.appendChild(d);const h=document.createElement("button");h.className=`w-8 h-8 rounded-md ${i.A.theme.menuIconHoverColor} flex justify-center items-center flex-shrink-0 ml-4`;const m=o.A.name("xmark"),u=new r.I({pathData:m.path,viewBox:m.viewBox,sizeClasses:"w-5 h-5",colorClass:i.A.theme.text});h.appendChild(u.element),l.appendChild(c),l.appendChild(h);const p=document.createElement("div");if(p.className="flex-grow overflow-auto","IMG"===t.tagName)p.classList.add("flex","justify-center","items-center","p-4");else if("PRE"===t.tagName){t.style.height="100%",t.style.margin="0",t.style.borderRadius="0";const e=t.querySelector("code");e&&(e.style.padding="1rem")}p.appendChild(t),a.appendChild(l),a.appendChild(p);const g=()=>{n.classList.add("opacity-0"),n.addEventListener("transitionend",(()=>{document.body.contains(n)&&document.body.removeChild(n),"function"==typeof s&&s()}),{once:!0})};h.addEventListener("click",g),n.addEventListener("click",(e=>{e.target===n&&g()})),n.appendChild(a),document.body.appendChild(n)}onFileAdded(e){"function"==typeof e&&(this.onFileAddedCallback=e)}updateProgress(e,t){const s=document.querySelector(`[data-progress="${e}"]`),n=document.querySelector(`[data-file="${e}"]`);s&&(100===t?(s.style.width="100%",setTimeout((()=>{s.style.opacity="0",setTimeout((()=>{s.style.width="0%",n&&(n.style.background=i.A.theme.inputBackground)}),1e3)}),2e3)):s.style.width=`${t}%`)}render(e){e&&e.appendChild(this.container)}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}clearAllFiles(){this.validFiles=[],this.uploadedFiles=[],this.fileNames=[],this.filesBeingProcessed=[],this.uploadIds={},this.totalFiles=0;for(let e in this.xhrs)this.xhrs.hasOwnProperty(e)&&(this.xhrs[e].abort(),delete this.xhrs[e]);if("chat"!==this.config.uiType){for(;this.fileContainer.firstChild;)this.fileContainer.removeChild(this.fileContainer.firstChild);this.uploadHelper.classList.remove("hidden"),this.fileContainer.appendChild(this.uploadHelper)}}getFileViewRender(e){const t=this.uploadedFiles.map((e=>({name:e.name,file_type:e.type,file_path:URL.createObjectURL(e),url:e.base64URL})));return new Y(t,e,!0).render()}triggerFileSelection(){this.fileInput&&document.body.contains(this.fileInput)||this._createAndSetFileInput(),this.fileInput?this.fileInput.click():new c.y("File selection is currently unavailable.","error",!0,!0)}_createAndSetFileInput(){this.fileInput&&this._boundHandleDrop&&(this.fileInput.removeEventListener("change",this._boundHandleDrop),this.fileInput.parentNode&&this.fileInput.parentNode.removeChild(this.fileInput)),this.fileInput=document.createElement("input"),this.fileInput.type="file",this.fileInput.style.display="none",this.config.maxFiles>1?this.fileInput.multiple=!0:this.fileInput.multiple=!1,this.config.allowedTypes&&this.config.allowedTypes.length>0&&"*"===this.config.allowedTypes[0]?this.fileInput.removeAttribute("accept"):this.config.allowedTypes&&(this.fileInput.accept=this.config.allowedTypes.join(",")),this._boundHandleDrop=this.handleDrop.bind(this),this.fileInput.addEventListener("change",this._boundHandleDrop,!1),document.body.appendChild(this.fileInput)}}class Q{static instance=null;static getInstance(e){return!Q.instance&&e&&(Q.instance=new Q(e),Q.instance.connect()),Q.instance}constructor(e){this.chatId=e,this.listeners={},this.messageQueue=[],this.wsUri=null,this.chatSocket=null,this.isConnected=!1,this.shouldReconnect=!0,this.isReconnecting=!1,this.reconnectAttempts=0,this.reconnectTimer=null,this.maxReconnectDelay=15e3,this.baseReconnectDelay=1e3,this.heartbeatInterval=null,this.pingTimeout=null,this.handleOnline=this.forceReconnect.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this)}connect(){if(this.wsUri)return;const e=`st_chat_${this.chatId}`;this.wsUri=`${window.ws_base}${e}/`,this.createWebSocket(),this.addBrowserEventListeners()}createWebSocket(){try{this.chatSocket=new WebSocket(this.wsUri),this.chatSocket.binaryType="arraybuffer",this.chatSocket.onopen=e=>this.onOpen(e),this.chatSocket.onclose=e=>this.onClose(e),this.chatSocket.onmessage=e=>this.onMessage(e),this.chatSocket.onerror=e=>this.onError(e)}catch(e){this.scheduleReconnect()}}onOpen(e){this.isConnected=!0,this.reconnectAttempts=0,this.isReconnecting=!1,clearTimeout(this.reconnectTimer),this.startHeartbeat(),this.flushMessageQueue()}onClose(e){this.isConnected=!1,this.stopHeartbeat(),this.shouldReconnect&&this.scheduleReconnect()}onError(e){}scheduleReconnect(){if(!this.shouldReconnect||this.isReconnecting)return;this.isReconnecting=!0;const e=Math.min(this.baseReconnectDelay*Math.pow(1.5,this.reconnectAttempts),this.maxReconnectDelay),t=e+.1*e*Math.random();this.reconnectTimer=setTimeout((()=>{this.isReconnecting=!1,this.shouldReconnect&&(this.reconnectAttempts++,this.createWebSocket())}),t)}forceReconnect(){this.isConnected||this.isReconnecting||(clearTimeout(this.reconnectTimer),this.isReconnecting=!1,this.reconnectAttempts=0,this.scheduleReconnect())}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval((()=>{this.isConnected&&this.chatSocket.readyState===WebSocket.OPEN&&(this.pingTimeout=setTimeout((()=>{this.chatSocket.close()}),5e3),this.send({ws_msg_type:"ping"}))}),25e3)}stopHeartbeat(){clearInterval(this.heartbeatInterval),clearTimeout(this.pingTimeout),this.heartbeatInterval=null,this.pingTimeout=null}flushMessageQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();this.send(e,!0)}}send(e,t=!1){this.isConnected&&this.chatSocket?.readyState===WebSocket.OPEN?this.chatSocket.send(JSON.stringify({text_data:e})):t||this.messageQueue.push(e)}stopStream(e,t){this.send({ws_msg_type:"chat.stop",chat_id:e,run_id:t})}onMessage(e){try{const t=JSON.parse(e.data);if("pong"===t.ws_msg_type)return void clearTimeout(this.pingTimeout);this.listeners[t.ws_msg_type]&&this.listeners[t.ws_msg_type].forEach((e=>e(t)))}catch(e){}}close(){this.shouldReconnect=!1,this.stopHeartbeat(),clearTimeout(this.reconnectTimer),this.removeBrowserEventListeners(),this.chatSocket&&this.chatSocket.close(),Q.instance=null}addBrowserEventListeners(){window.addEventListener("online",this.handleOnline),document.addEventListener("visibilitychange",this.handleVisibilityChange)}removeBrowserEventListeners(){window.removeEventListener("online",this.handleOnline),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}handleVisibilityChange(){"visible"===document.visibilityState&&this.forceReconnect()}registerMsgListener(e,t){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}}class Z{constructor(e,t=0){if(!(e instanceof HTMLElement))throw new Error("Container must be a DOM element");this.container=e,this.offset=t,this.onScrollBottomCallback=null,this.hasMoreResults=!0,this.loadingUI=null,this.isLoading=!1,this.pageNumber=1,this.debounceTimeout=null,this.onLoadingCallback=null,this.onFinishLoadingCallback=null,this.setContainerClasses(),this.handleScroll=this.handleScroll.bind(this),this.init()}setContainerClasses(){switch(this.offset){case 35:case 32:this.container.className="flex justify-center overflow-y-auto overflow-x-hidden w-full h-[calc(var(--vh)*100-32px)]";break;case 1:this.container.className="flex flex-col overflow-y-auto overflow-x-hidden w-full px-2 h-[calc(60vh-25px)] sm:h-[calc(50vh-10px)]";break;default:this.container.className="flex justify-center overflow-y-auto overflow-x-hidden w-full h-full pt-4 lg:pt-4 px-6 md:px-0"}}init(){this.container.addEventListener("scroll",this.handleScroll.bind(this))}handleScroll(){this.isLoading||(this.debounceTimeout&&clearTimeout(this.debounceTimeout),this.debounceTimeout=setTimeout((()=>{const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.container;e+s>=t-10&&!this.isLoading&&this.hasMoreResults&&this.onScrollBottomCallback&&(this.isLoading=!0,"function"==typeof this.onLoadingCallback&&this.onLoadingCallback(),this.onScrollBottomCallback(this.pageNumber),this.pageNumber++)}),200))}addContainer(e){this.container.appendChild(e)}setLazyLoadCallback(e){if("function"!=typeof e)throw new Error("Lazy load callback must be a function");this.onScrollBottomCallback=e}stopLoading(){this.hasMoreResults=!1}onLoading(e){this.onLoadingCallback=e}hideLoadingUI(){this.isLoading=!1,"function"==typeof this.onFinishLoadingCallback&&this.onFinishLoadingCallback()}onFinishedLoading(e){this.onFinishLoadingCallback=e}setOffset(e){this.offset=e,this.setContainerClasses()}cleanup(){this.container.removeEventListener("scroll",this.handleScroll)}reset(){this.pageNumber=0,this.hasMoreResults=!0,this.isLoading=!1}scrollBottom(){this.container.scrollTop=this.container.scrollHeight}}class ee{constructor(e=!0){this.theme=i.A.theme,this.container=null,this.settingOuter=null,this.setting=null,this.knowledgeGraphOn=e,this.memorySwitch=null,this.scrollContainer=null,this.scrollView=null,this.memoriesContainer=null,this.modal=null,this.emptyState=null,this.onMemoryOffCallback=null,this.onMemoryOnCallback=null,this.assistantMemories=u.K.knowledgeGraph,this.init()}init(){this.container=document.createElement("div"),this.settingOuter=document.createElement("div"),this.settingOuter.classList=`border-b ${this.theme.modalSeperationBorderColor} pb-2`,this.setting=document.createElement("div"),this.setting.classList="w-full h-full py-2 px-6",this.settingOuter.appendChild(this.setting),this.memorySwitch=new C({value:this.knowledgeGraphOn,label:"Enable memory for this assistant",labelPosition:"left"}),this.scrollContainer=document.createElement("div"),this.scrollContainer.classList="w-full",this.memorySwitch.render(this.setting),this.container.append(this.settingOuter),this.scrollView=new Z(this.scrollContainer,1),this.memoriesContainer=document.createElement("div"),this.memoriesContainer.classList="flex flex-col gap-2 p-3 w-full relative",this.scrollView.addContainer(this.memoriesContainer),this.container.appendChild(this.scrollContainer),this.modal=new l({size:"medium",title:"Memory",body:this.container,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1,disableScroll:!0,disableXPadding:!0,disableBPadding:!0}),this.addEventListeners(),this.loadMemories()}async loadMemories(){if(this.assistantMemories=await u.K.getKnowledgeGraph(),this.assistantMemories.length>0){this.clearAllButtonContainer=document.createElement("div"),this.clearAllButtonContainer.classList="flex flex-col clearall";const e={text:"Clear all",type:"ringSecondary",size:"large"};this.clearAllButton=new n.$(e),this.clearAllButton.render(this.clearAllButtonContainer),this.clearAllButton.onClick((()=>{new a("Are you sure?","This will remove all memories permanently").onConfirm((async()=>{this.memoriesContainer.innerHTML="",this.assistantMemories=[],this.checkEmptyState(),await u.K.clearKnowledgeGraph();new c.y("All memories have been cleared for this assistant","success",!0,!0)}))})),this.memoriesContainer.appendChild(this.clearAllButtonContainer)}this.assistantMemories.forEach((e=>{this.memoriesContainer.appendChild(this.renderMemory(e))})),this.checkEmptyState(),this.knowledgeGraphOn||this.memoriesContainer.classList.add("opacity-40")}checkEmptyState(){0===this.assistantMemories.length?(this.memoriesContainer.innerHTML="",this.emptyState=document.createElement("div"),this.emptyState.classList="p-3 flex justify-between",this.emptyStateText=document.createElement("div"),this.emptyStateText.classList="text-sm py-2 opacity-60 leading-5",this.emptyStateText.innerHTML='\n                <div class="font-medium text-xl text-left pb-2">No memories for this assistant</div>\n                <div class="font-normal text-sm text-left">Memory is specific to each assistant. Assistants will decide to remember information they deem important to personalize your experience. You can remove indivdual memories or clear all memories. \n                <div class="font-normal text-sm text-left pt-2">When you toggle memories off, the assistant will no longer consider it\'s memory when responding or add new memories. You can explicitly ask an assistant to remember something e.g. "Remember I like short, sharp answers". </div>\n            ',this.emptyState.appendChild(this.emptyStateText),this.memoriesContainer.appendChild(this.emptyState)):this.emptyState&&this.emptyState.remove()}addEventListeners(){this.memorySwitch.onSwitchFalse((()=>{this.memoriesContainer.classList.add("opacity-40"),"function"==typeof this.onMemoryOffCallback&&this.onMemoryOffCallback()})),this.memorySwitch.onSwitchTrue((()=>{this.memoriesContainer.classList.remove("opacity-40"),"function"==typeof this.onMemoryOnCallback&&this.onMemoryOnCallback()})),this.modal.onClose((()=>{this.close()}))}onMemoryOff(e){"function"==typeof e&&(this.onMemoryOffCallback=e)}onMemoryOn(e){"function"==typeof e&&(this.onMemoryOnCallback=e)}close(){this.modal="",this.container=""}renderMemory(e){const t=document.createElement("div");t.classList=`ring-1 ${this.theme.memoryItemRing} rounded-md px-3 flex justify-between`;const s=document.createElement("div");s.classList="flex items-center flex-grow";const i=document.createElement("div");i.classList="text-sm py-2",i.textContent=e.memory;const n=document.createElement("div");n.classList="flex items-start justify-start align-top py-2";const l=document.createElement("button");l.type="button",l.classList=`p-2 ${this.theme.iconColor}`;const c=o.A.name("trash");return new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",colorClass:"fill-current"}).render(l),s.appendChild(i),t.appendChild(s),n.appendChild(l),t.appendChild(n),l.addEventListener("click",(()=>{new a("Are you sure?","This will remove the memory permanently").onConfirm((()=>{t.remove(),this.removeMemory(e.id,t),this.checkEmptyState()}))})),t}removeMemory(e,t){this.assistantMemories=this.assistantMemories.filter((t=>t.id!==e)),u.K.deleteKnowledgeGraphItem(e)}}class te{constructor(e,t){this.theme=i.A.theme,this.stream=null,this.interval=5e3,this.captureInterval=null,this.floatingBox=null,this.previewVideo=null,this.shareButton=null,this.isDragging=!1,this.dragOffset={x:0,y:0},this.uploadInProgess=!1,this.onStopCallback=null,this.onStartCallback=null,this.previewFrameRate=5,this.lastPreviewUpdateTime=0,this.isMobile=/iPhone|iPad|iPod|Android/i.test(navigator.userAgent),this.chat_id=e,this.playVideoSafely=this.playVideoSafely.bind(this),this.isPaused=!1,this.pausedScreenshot=null,this.isMaximized=!1,this.maximizeMinimizeButton=null,this.callbackForImage=t,this.createUI(),this.setupResizeListener()}async playVideoSafely(e){if(this.isMobile){e.setAttribute("playsinline",""),e.setAttribute("webkit-playsinline",""),e.setAttribute("autoplay",""),e.muted=!0;try{await e.play()}catch(t){const s=document.createElement("video");s.setAttribute("playsinline",""),s.setAttribute("webkit-playsinline",""),s.setAttribute("autoplay",""),s.muted=!0,s.style.width="1px",s.style.height="1px",s.style.position="absolute",s.style.left="-1px",s.style.top="-1px",document.body.appendChild(s),s.srcObject=e.srcObject,await s.play(),e.srcObject=s.srcObject,await e.play(),document.body.removeChild(s)}}else await e.play()}createUI(){this.floatingBox=document.createElement("div"),this.floatingBox.className=`fixed ${this.theme.widgetBackground} bg-opacity-75 rounded-lg shadow-lg p-2 cursor-move touch-none select-none transition-all duration-300 ease-in-out z-30 top-12 right-5 flex flex-col screen-share-active`,this.floatingBox.style.display="none",function(e,t=!0){e.style.right="24px";const s=t?document.querySelector(".screen-share-active"):document.querySelector(".voice-active");if(s&&"none"!==window.getComputedStyle(s).display&&s.offsetWidth>0){const t=s.offsetWidth,i=window.getComputedStyle(s),n=(parseInt(i.right)||24)+t+30;e.style.right=`${n}px`}}(this.floatingBox,!1),this.isMobile?(this.floatingBox.style.width="200px",this.floatingBox.style.height="180px",this.floatingBox.style.top="40px",this.floatingBox.style.right="5px"):(this.floatingBox.style.width="175px",this.floatingBox.style.height="auto");const e=document.createElement("div");if(e.className="flex flex-col h-full",this.floatingBox.appendChild(e),this.previewContainer=document.createElement("div"),this.previewContainer.className="relative flex-grow flex justify-center items-center rounded-md overflow-hidden",e.appendChild(this.previewContainer),this.previewVideo=document.createElement("video"),this.previewVideo.className="object-cover object-center rounded-md w-full h-[120px] sm:h-[100px]",this.isMobile&&(this.previewVideo.setAttribute("playsinline",""),this.previewVideo.setAttribute("webkit-playsinline",""),this.previewVideo.setAttribute("autoplay",""),this.previewVideo.muted=!0),this.previewContainer.appendChild(this.previewVideo),this.buttonContainer=document.createElement("div"),this.buttonContainer.className="flex justify-center gap-1 pt-2",e.appendChild(this.buttonContainer),this.stopButton=new n.$({text:"Stop",type:"primary",size:"small",iconHeightAndWidth:"h-7",hoverText:"Stop sharing"}),this.stopButton.onClick((()=>this.stopCapture())),this.stopButton.render(this.buttonContainer),this.isMobile){const e=o.A.name("rotate"),t=new n.$({svgPathData:e.path,svgViewBox:e.viewBox,type:"secondary",size:"small",iconHeightAndWidth:"w-7 h-7"});t.onClick((()=>this.switchCamera())),t.render(this.buttonContainer)}const t=o.A.name("camera");if(this.cameraButton=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"secondary",size:"small",hoverText:u.K.isMobile()?"Capture photo":"Capture screenshot",iconHeightAndWidth:"h-7 w-7"}),this.cameraButton.onClick((()=>this.captureAndUploadPhoto())),this.cameraButton.render(this.buttonContainer),!this.isMobile){const e=o.A.name("expand");this.maximizeMinimizeButton=new n.$({svgPathData:e.path,svgViewBox:e.viewBox,type:"secondary",size:"small",iconHeightAndWidth:"w-7 h-7"}),this.maximizeMinimizeButton.onClick((()=>this.toggleMaximize())),this.maximizeMinimizeButton.render(this.buttonContainer)}document.body.appendChild(this.floatingBox),this.originalPosition={left:parseFloat(this.floatingBox.style.left)||0,top:parseFloat(this.floatingBox.style.top)||0,width:this.floatingBox.offsetWidth,height:this.floatingBox.offsetHeight},this.setupDragListeners()}toggleMaximize(){if(this.isMaximized=!this.isMaximized,this.isMaximized){const e=o.A.name("minimize");this.maximizeMinimizeButton.setSvgIcon(e.path,e.viewBox)}else{const e=o.A.name("expand");this.maximizeMinimizeButton.setSvgIcon(e.path,e.viewBox)}if(this.isMaximized){this.originalPosition={left:parseFloat(this.floatingBox.style.left)||0,top:parseFloat(this.floatingBox.style.top)||0,width:this.floatingBox.offsetWidth,height:this.floatingBox.offsetHeight};const e=400;this.floatingBox.style.width=`${e}px`,this.previewVideo.style.width=`${e}px`,this.previewVideo.style.height="229px";const t=this.originalPosition.left-(e-this.originalPosition.width);this.floatingBox.style.left=`${Math.max(0,t)}px`}else{const e=175;if(this.floatingBox.style.width=`${e}px`,this.previewVideo.style.width=`${e}px`,this.previewVideo.style.height="100px",this.originalPosition)this.floatingBox.style.left=`${this.originalPosition.left}px`,this.floatingBox.style.top=`${this.originalPosition.top}px`;else{const t=window.innerWidth;this.floatingBox.style.left=t-e-20+"px",this.floatingBox.style.top="20px"}}this.buttonContainer.style.marginTop="4px",this.floatingBox.style.height="auto"}async startCapture(){try{if(this.isMobile){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)throw new Error("getUserMedia is not supported on this device.");this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"},audio:!1})}else this.stream=await navigator.mediaDevices.getDisplayMedia({video:!0});this.stream.getVideoTracks()[0].addEventListener("ended",(()=>{this.handleStreamEnded("Sharing was stopped by system")})),this.captureInterval=setInterval((()=>this.captureScreenshot()),this.interval),this.previewVideo.srcObject=this.stream,await this.playVideoSafely(this.previewVideo),this.floatingBox.style.display="block","function"==typeof this.onStartCallback&&this.onStartCallback(),this.captureScreenshot()}catch(e){let t="Sharing failed, check permissions and try again.";"NotAllowedError"===e.name?t="Check your permissions and try again.":"NotFoundError"===e.name?t="Your camera or screen was not found.":"NotReadableError"!==e.name&&"AbortError"!==e.name||(t="Sharing failed. Check permission and try again.");new c.y(t,"warning")}}updatePreviewFrame(){const e=performance.now();e-this.lastPreviewUpdateTime>=1e3/this.previewFrameRate&&(this.lastPreviewUpdateTime=e),requestAnimationFrame((()=>this.updatePreviewFrame()))}handleStreamEnded(e){this.stopCapture();new c.y(e,"info")}handleSystemLevelStop(){this.stopCapture()}stopCapture(){this.stream&&(this.stream.getTracks().forEach((e=>e.stop())),this.stream=null),this.captureInterval&&(clearInterval(this.captureInterval),this.captureInterval=null),this.floatingBox.style.display="none",this.isPaused=!1,this.pausedScreenshot=null,"function"==typeof this.onStopCallback&&this.onStopCallback(),this.resetState()}resetState(){this.stream=null,this.captureInterval&&(clearInterval(this.captureInterval),this.captureInterval=null),this.floatingBox.style.display="none",this.uploadInProgress=!1,this.isMaximized&&this.toggleMaximize(),this.previewVideo&&(this.previewVideo.srcObject=null)}handleStreamEnded(e){this.stopCapture();new c.y(e,"info")}handleSystemLevelStop(){this.stopCapture()}setupDragListeners(){let e,t,s=!1;const i=i=>{s=!0;const n="touchstart"===i.type?i.touches[0]:i,a=this.floatingBox.getBoundingClientRect();e=n.clientX-a.left,t=n.clientY-a.top,this.floatingBox.style.transition="none"},n=i=>{if(!s)return;i.preventDefault();const n="touchmove"===i.type?i.touches[0]:i;let a=n.clientX-e,o=n.clientY-t;const r=this.constrainPosition(a,o);this.floatingBox.style.left=`${r.left}px`,this.floatingBox.style.top=`${r.top}px`,this.floatingBox.style.right="auto"},a=()=>{if(!s)return;s=!1,this.floatingBox.style.transition="all 0.3s ease-in-out";const e=this.floatingBox.getBoundingClientRect(),t=this.constrainPosition(e.left,e.top);this.floatingBox.style.left=`${t.left}px`,this.floatingBox.style.top=`${t.top}px`};this.floatingBox.addEventListener("mousedown",i),this.floatingBox.addEventListener("touchstart",i),document.addEventListener("mousemove",n),document.addEventListener("touchmove",n,{passive:!1}),document.addEventListener("mouseup",a),document.addEventListener("touchend",a)}captureScreenshot(e=!1){if(!this.stream||this.isPaused&&!e)return;const t=document.createElement("video");t.srcObject=this.stream;const s=async()=>{await this.playVideoSafely(t);const i=document.createElement("canvas");i.width=1*t.videoWidth,i.height=1*t.videoHeight,i.getContext("2d").drawImage(t,0,0,i.width,i.height);const n=i.toDataURL("image/png");this.pausedScreenshot=n,this.isPaused&&!e||this.handleScreenshot(n),t.removeEventListener("loadedmetadata",s),t.srcObject=null,t.remove(),i.remove()};t.addEventListener("loadedmetadata",s)}handleScreenshot(e){if(this.uploadInProgress)return;if(this.isPaused&&e===this.pausedScreenshot)return void this.updatePreviewWithScreenshot(e);const t=atob(e.split(",")[1]),s=e.split(",")[0].split(":")[1].split(";")[0],i=new ArrayBuffer(t.length),n=new Uint8Array(i);for(let e=0;e<t.length;e++)n[e]=t.charCodeAt(e);const a=new Blob([i],{type:s}),o=new FormData;let r=Date.now();o.append("file",a,`screenshot_${r}.png`),o.append("is_screen_share",!0),o.append("chat_id",this.chat_id),this.uploadInProgress=!0,g.G.uploadFile(o).then((e=>{e&&e.message&&e.message})).catch((e=>{})).finally((()=>{this.uploadInProgress=!1}))}updatePreviewWithScreenshot(e){const t=new Image;t.onload=()=>{const e=document.createElement("canvas");e.width=this.previewVideo.videoWidth,e.height=this.previewVideo.videoHeight;e.getContext("2d").drawImage(t,0,0,e.width,e.height),this.previewVideo.srcObject=null,this.previewVideo.src=e.toDataURL("image/png")},t.src=e}toggleCamera(){this.stream?this.captureAndUploadPhoto():new c.y("Camera is not active","warning")}onStart(e){"function"==typeof e&&(this.onStartCallback=e)}onStop(e){"function"==typeof e&&(this.onStopCallback=e)}getSharingStatus(){return null!==this.stream}handleWindowResize(){const e=window.innerWidth,t=window.innerHeight,s=this.floatingBox.offsetWidth*(this.isMaximized?1.5:1),i=(this.floatingBox.offsetHeight,this.isMaximized,1*e/100),n=5*t/100;let a,o;const r=parseInt(this.floatingBox.style.left),l=parseInt(this.floatingBox.style.top);if(Math.abs(e-this.lastWindowWidth)>200||Math.abs(t-this.lastWindowHeight)>200)a=e-s-i,o=n;else{a=r/(this.lastWindowWidth-s)*(e-s),o=l/this.lastWindowHeight*t}const c=this.constrainPosition(a,o);this.floatingBox.style.left=`${c.left}px`,this.floatingBox.style.top=`${c.top}px`,this.lastWindowWidth=e,this.lastWindowHeight=t}setupResizeListener(){window.addEventListener("resize",this.handleWindowResize.bind(this))}constrainPosition(e,t){const s=window.innerWidth,i=window.innerHeight,n=this.floatingBox.offsetWidth,a=this.floatingBox.offsetHeight;return{left:e=Math.max(20,Math.min(e,s-20)),top:t=Math.max(20,Math.min(t,i-a-20)),right:s-e-n}}async switchCamera(){if(!this.isMobile)return;const e="environment"===this.stream.getVideoTracks()[0].getSettings().facingMode?"user":"environment";this.stopCapture();try{this.stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:e}}),this.previewVideo.srcObject=this.stream,await this.playVideoSafely(this.previewVideo),this.captureInterval=setInterval((()=>this.captureScreenshot()),this.interval),this.previewVideo.style.transform="user"===e?"scaleX(-1)":"none",this.floatingBox.style.display="block","function"==typeof this.onStartCallback&&this.onStartCallback()}catch(e){new c.y("Failed to switch camera","error");this.resetState()}}async captureAndUploadPhoto(){if(!this.stream)return;const e=document.createElement("video");e.srcObject=this.stream;const t=async()=>{await this.playVideoSafely(e);const s=document.createElement("canvas");s.width=e.videoWidth,s.height=e.videoHeight,s.getContext("2d").drawImage(e,0,0,s.width,s.height),s.toBlob((i=>{const n=Date.now(),a=new File([i],`photo_${n}.png`,{type:"image/png"});this.callbackForImage&&"function"==typeof this.callbackForImage&&this.callbackForImage([a]),e.removeEventListener("loadedmetadata",t),e.srcObject=null,e.remove(),s.remove()}),"image/png")};e.addEventListener("loadedmetadata",t)}insertPhotoIntoChat(e){this.callbackForImage&&"function"==typeof this.callbackForImage&&this.callbackForImage(e)}}const se={us:"en-US",uk:"en-GB",au:"en-AU",ca:"en-CA",ie:"en-IE",in:"en-IN",nz:"en-NZ",za:"en-ZA"};class ie{constructor(e){this.audioContext=null,this.audioQueue=[],this.isPlaying=!1,this.initialized=!1,this.gainNode=null,this.chat=e,this.sampleRate=24e3,this.bufferSize=8192,this.startOffset=0,this.speakingStateTimer=null,this.speakingStateDelay=2500,this.lastChunkTime=null,this.isSpeaking=!1,this.bufferThreshold=40,this.playbackTimeout=null,this.maxWaitTime=1e3,this.lastChunkReceived=null}async initialize(){if(!this.initialized)try{const e=window.AudioContext||window.webkitAudioContext;this.audioContext=new e({sampleRate:this.sampleRate,latencyHint:"playback"}),this.gainNode=this.audioContext.createGain(),this.gainNode.connect(this.audioContext.destination),this.gainNode.gain.value=1,this.initialized=!0,await this.audioContext.resume()}catch(e){throw e}}setVolume(e){this.gainNode&&(this.gainNode.gain.value=e)}async handleAudioChunk(e,t){this.initialized||await this.initialize(),this.caller=t,this.lastChunkTime=Date.now(),this.lastChunkReceived=Date.now();try{const t=atob(e),s=new Uint8Array(t.length);for(let e=0;e<t.length;e++)s[e]=t.charCodeAt(e);const i=new Int16Array(s.buffer),n=this.audioContext.createBuffer(1,i.length,this.sampleRate),a=n.getChannelData(0),o=Math.min(i.length,a.length);for(let e=0;e<o;e++)a[e]=Math.max(-1,Math.min(1,i[e]/32768));this.audioQueue.push(n),this.isSpeaking||this.updateSpeakingState(!0),this.playbackTimeout&&clearTimeout(this.playbackTimeout),this.isPlaying||(this.audioQueue.length>=this.bufferThreshold?await this.playNextChunk():this.playbackTimeout=setTimeout((async()=>{this.audioQueue.length>0&&!this.isPlaying&&await this.playNextChunk()}),this.maxWaitTime))}catch(e){}}async playNextChunk(){if(0===this.audioQueue.length){this.isPlaying=!1;if(Date.now()-(this.lastChunkReceived||0)<this.maxWaitTime)return this.playbackTimeout&&clearTimeout(this.playbackTimeout),void(this.playbackTimeout=setTimeout((()=>this.playNextChunk()),100));if(this.isSpeaking){Date.now()-(this.lastChunkTime||0)>this.speakingStateDelay?this.updateSpeakingState(!1):this.speakingStateTimer&&(clearTimeout(this.speakingStateTimer),this.speakingStateTimer=setTimeout((()=>{0===this.audioQueue.length&&this.updateSpeakingState(!1)}),this.speakingStateDelay))}return}this.isPlaying=!0;const e=Math.min(20,this.audioQueue.length),t=this.audioQueue.slice(0,e).reduce(((e,t)=>e+t.length),0),s=this.audioContext.createBuffer(1,t,this.sampleRate),i=s.getChannelData(0);let n=0;for(let t=0;t<e;t++){const e=this.audioQueue.shift(),s=e.getChannelData(0);if(0===t){const e=Math.min(100,s.length);for(let t=0;t<e;t++){const a=t/e;i[n+t]=s[t]*a}i.set(s.subarray(e),n+e)}else i.set(s,n);n+=e.length}const a=this.audioContext.createBufferSource();a.buffer=s;const o=this.audioContext.createGain();o.connect(this.gainNode),a.connect(o);const r=this.audioContext.currentTime+this.startOffset;a.onended=()=>this.playNextChunk();try{a.start(r)}catch(e){this.playNextChunk()}}updateSpeakingState(e){this.isSpeaking!==e&&(this.isSpeaking=e,this.chat?.voiceModal&&this.chat.voiceModal?.setAssistantSpeaking(e),!e&&this.caller&&(this.caller.isAISpeaking=!1,this.caller.handleResumeAfterAudio()))}clear(){this.playbackTimeout&&(clearTimeout(this.playbackTimeout),this.playbackTimeout=null),this.audioQueue=[],this.isPlaying=!1,this.speakingStateTimer&&(clearTimeout(this.speakingStateTimer),this.speakingStateTimer=null),this.lastChunkTime=null,this.updateSpeakingState(!1)}async resume(){"suspended"===this.audioContext?.state&&await this.audioContext.resume()}destroy(){this.playbackTimeout&&(clearTimeout(this.playbackTimeout),this.playbackTimeout=null),this.speakingStateTimer&&(clearTimeout(this.speakingStateTimer),this.speakingStateTimer=null),this.audioContext&&(this.gainNode?.disconnect(),this.audioContext.close(),this.audioContext=null),this.audioQueue=[],this.isPlaying=!1,this.isSpeaking=!1,this.initialized=!1,this.lastChunkTime=null,this.updateSpeakingState(!1)}}class ne{constructor(e){this.chat=e,this.audioPlayer=new ie(e),this.recognition=null,this.currentLanguage=se.au,this.microphoneStream=null,this.connected=!1,this.initializationInProgress=!1,this.isListening=!1,this.isAISpeaking=!1,this.isProcessingResponse=!1,this.isInterrupting=!1,this.currentRunId=null,this.transcript="",this.accumulatedTranscript="",this.lastPartialTranscript="",this.lastSentTranscript="",this.isPushToTalkActive=!1,this.pushToTalkBuffer="",this.silenceTimeout=2500,this.silenceTimer=null,this.resumeListeningTimeout=null,this.recognitionRestartDelay=100}async checkPermissions(){try{"suspended"===this.audioPlayer.audioContext?.state&&await this.audioPlayer.audioContext.resume();const e={audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0,channelCount:1,sampleRate:16e3,googEchoCancellation:!0,googAutoGainControl:!0,googNoiseSuppression:!0,googHighpassFilter:!0}};try{const t=await navigator.mediaDevices.getUserMedia(e);this.microphoneStream=t;return document.createElement("audio").srcObject=t,!0}catch(e){if("NotAllowedError"===e.name||"PermissionDeniedError"===e.name){/^((?!chrome|android).)*safari/i.test(navigator.userAgent)?this.chat.voiceModal?.setError('Please click the microphone icon in your address bar and choose "Allow"'):this.chat.voiceModal?.setError("Microphone access denied. Please check your browser settings.")}throw e}}catch(e){return!1}}async initializeRecognition(){const e=navigator.userAgent.indexOf("Firefox")>-1;/Chrome/.test(navigator.userAgent)&&/Google Inc/.test(navigator.vendor),/^((?!chrome|android).)*safari/i.test(navigator.userAgent),window,window,navigator,navigator.mediaDevices;let t;try{if("SpeechRecognition"in window)t=window.SpeechRecognition;else{if(!("webkitSpeechRecognition"in window)){if(e){throw new Error("Firefox detected: Please enable speech recognition in about:config:\n1. Visit about:config\n2. Enable media.webspeech.recognition.enable\n3. Enable media.webspeech.recognition.force_enable")}throw new Error("Speech recognition not supported in this browser")}t=window.webkitSpeechRecognition}this.recognition=new t}catch(e){throw e}this.isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),this.isSafari?(this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.maxAlternatives=1):(this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.maxAlternatives=3),this.recognition.lang=this.currentLanguage,this.recognition.onstart=()=>{this.isListening=!0,this.chat.voiceModal&&this.isPushToTalkActive&&this.chat.voiceModal?.setUserSpeaking(!0)},this.recognition.onend=async()=>{this.isListening=!1,this.chat.voiceModal&&this.chat.voiceModal?.setUserSpeaking(!1),this.chat.voiceModal?.isPushToTalkEnabled||this.isPushToTalkActive||this.isSafari||setTimeout((()=>this.startListening()),this.recognitionRestartDelay)},this.recognition.onerror=e=>{if("aborted"!==e.error){switch(e.error){case"not-allowed":this.chat.voiceModal?.setError("Microphone access denied");break;case"no-speech":break;default:this.chat.voiceModal?.setError(`Recognition error: ${e.error}`)}this.isListening=!1,this.chat.voiceModal&&this.chat.voiceModal?.setUserSpeaking(!1)}},this.recognition.onresult=e=>this.handleRecognitionResult(e)}async handlePushToTalkStart(){return this.isListening=!1,this.isPushToTalkActive=!0,this.transcript="",this.currentRunId=Math.floor(1e6*Math.random()),this.accumulatedTranscript="",this.lastPartialTranscript="",this.pushToTalkBuffer="",this.lastSentTranscript="",this.wasBlocking=!1,new Promise((async e=>{try{this.recognition||await this.initializeRecognition(),await this.recognition.start(),this.chat.voiceModal&&this.chat.voiceModal.pushToTalkText&&(this.chat.voiceModal.pushToTalkText.textContent="Listening..."),e()}catch(t){this.isPushToTalkActive=!1,this.isListening=!1,await this.reconnect(null,!0),e()}}))}handlePushToTalkEnd(){const e=this.isPushToTalkActive;if(this.isPushToTalkActive=!1,!e)return;this.chat.voiceModal&&(this.chat.voiceModal.setUserSpeaking(!1),this.chat.voiceModal.pushToTalkText.textContent="Push to talk");let t=1300;this.isSafari&&(t=2500),setTimeout((()=>{const e=(this.transcript||this.pushToTalkBuffer).trim();if(this.transcript="",this.pushToTalkBuffer="",this.lastSentTranscript=e,this.recognition)try{this.recognition.onend=()=>{this.isListening=!1,this.chat.voiceModal&&this.chat.voiceModal?.setUserSpeaking(!1)},this.recognition.abort()}catch(e){}e&&this.sendFinalTranscript(e,!0),this.currentRunId=null,this.isListening=!1}),t)}handleRecognitionResult(e){if(this.isPushToTalkActive)this.handlePushToTalkResult(e);else if(!this.wasBlocking||this.isPushToTalkActive)this.isAISpeaking||this.audioPlayer.isSpeaking?this.wasBlocking=!0:(this.isSafari&&(this.chat.chatSession.toggleUserVoiceInput(!0),this.clearVoiceInputTimeout=setTimeout((()=>{this.chat.chatSession.toggleUserVoiceInput(!1)}),1e4)),this.isPushToTalkActive?this.handlePushToTalkResult(e):this.handleNormalModeResult(e));else{this.wasBlocking=!1;try{this.isListening&&(this.recognition.stop(),this.recognition.onend=()=>{this.recognition.onend=null,setTimeout((()=>{this.isAISpeaking||this.audioPlayer.isSpeaking||this.isPushToTalkEnabled||this.startListening()}),400)})}catch(e){}}}handlePushToTalkResult(e){let t="",s=!1;for(let i=e.resultIndex;i<e.results.length;i++){const n=e.results[i];let a="",o=0;for(let e=0;e<n.length;e++)n[e].confidence>o&&(o=n[e].confidence,a=n[e].transcript);n.isFinal?(this.pushToTalkBuffer+=" "+a,this.pushToTalkBuffer=this.pushToTalkBuffer.trim(),s=!0):t+=a}const i=(this.pushToTalkBuffer+" "+t).trim();i&&(this.transcript=i,this.sendPartialTranscript(i))}handleNormalModeResult(e){this.silenceTimer&&clearTimeout(this.silenceTimer);let t="",s=!1;for(let i=e.resultIndex;i<e.results.length;i++){const n=e.results[i];let a="",o=0;for(let e=0;e<n.length;e++)n[e].confidence>o&&n[e].confidence>.1&&(o=n[e].confidence,a=n[e].transcript);a&&(n.isFinal?(this.accumulatedTranscript+=" "+a,this.accumulatedTranscript=this.accumulatedTranscript.trim(),s=!0):t+=a)}s&&(this.lastPartialTranscript="",this.handleFinalTranscript(this.accumulatedTranscript));const i=(this.accumulatedTranscript+" "+t).trim();i&&i!==this.lastSentTranscript&&(this.lastSentTranscript=i,this.handleInterimTranscript(i))}handleInterrupt(){(this.isPushToTalkActive||this.isAISpeaking)&&(this.isInterrupting=!0,this.audioPlayer.clear(),this.isAISpeaking=!1,this.isProcessingResponse=!1,this.currentRunId=null,this.transcript="",setTimeout((()=>{this.isInterrupting=!1,this.handleResumeAfterAudio()}),100))}handleInterimTranscript(e){this.currentRunId||(this.currentRunId=Math.floor(1e6*Math.random())),this.transcript=e,this.sendPartialTranscript(e)}handleFinalTranscript(e){if(this.isSafari&&this.chat.chatSession.toggleUserVoiceInput(!1),this.currentRunId||(this.currentRunId=Math.floor(1e6*Math.random())),this.silenceTimer&&clearTimeout(this.silenceTimer),this.chat.voiceModal?.isPushToTalkEnabled)return this.transcript=e,void(this.isPushToTalkActive&&this.sendPartialTranscript(e));this.transcript=e,this.silenceTimer=setTimeout((()=>{this.sendFinalTranscript(this.transcript)}),this.silenceTimeout)}sendPartialTranscript(e){if(this.isSafari&&this.chat.chatSession.toggleUserVoiceInput(!1),!e.trim())return;this.currentRunId||(this.currentRunId=Math.floor(1e6*Math.random())),this.currentRunId||(this.currentRunId=Math.floor(1e6*Math.random()));const t={id:this.currentRunId,run_id:this.currentRunId,type:"user",nickname:this.chat.chatSession.user.nickname,timestamp:(new Date).toISOString(),body:e};this.isSafari&&this.chat.chatSession.toggleUserVoiceInput(!1),this.chat.chatSession.addMessage(t,this.currentRunId,!1)}sendFinalTranscript(e,t=!1){if(!t&&this.isAISpeaking&&!this.isInterrupting||!e.trim())return;const s=e.trim();this.accumulatedTranscript="",this.transcript="";const i={id:this.currentRunId,run_id:this.currentRunId,type:"user",nickname:this.chat.chatSession.user.nickname,timestamp:(new Date).toISOString(),body:s,voice_mode:!0},n=window._ci.selectedSkill?window._ci.selectedSkill.value:null,a=document.querySelector('code-block[mode="focus"][block-id]');if(a&&(i.code_block_id=a.getAttribute("block-id"),i.code_block_code=a.code,a.showLoadingOverlay(!0)),n){i.skill=n;let e=window._ci.selectedSkill&&window._ci.skillComponents?{...window._ci.skillComponents.values}:{};["code","game","widget","visualization","survey","form","quiz","presentation","landing","website","prototype","email","react","svg"].includes(n)&&(e={...e,focus_mode:!!window._ci.focusOn,focus_id:window._ci.focusOn?a?.messageId:null}),Object.keys(e).length>0&&(i.skill_params=e)}if(window._ci.skillIsShowing){window._ci.skillComponents.close();const e=window._ci.availableSkills.find((e=>e.value===n));e?.closeAfterUse&&(window._ci.skillComponents.removeSkill(),window._ci.selectedSkill=null,window._ci.resetPlaceholder())}this.isSafari&&this.chat.chatSession.toggleUserVoiceInput(!1),this.chat.chatSession.addMessage(i,this.currentRunId,!0),this.chat.chatSession.toggleAssistantThinking(!0),this.isProcessingResponse=!0,this.currentRunId=null,this.transcript="",this.chat.voiceModal?.isPushToTalkEnabled||this.chat.voiceModal?.setUserSpeaking(!1),g.G.postData(`/chat/${this.chat.chatSession._chat_obj.chat_id}/message/`,i),!this.chat.voiceModal?.isPushToTalkEnabled&&this.chat.user.v_text_reply_mode&&this.handleResumeAfterAudio()}async handleWebSocketMessage(e){switch(e.ws_msg_type){case"voice.audio.chunk":try{this.isAISpeaking||"voice_audio_chunk"!==e.type||(this.isAISpeaking=!0,this.chat.voiceModal?.isPushToTalkEnabled||await this.stopListening(),this.transcript="",this.accumulatedTranscript="",this.lastPartialTranscript="",this.isSafari&&await this.audioPlayer.resume()),this.chat.voiceModal?.setAssistantSpeaking(!0),await this.audioPlayer.handleAudioChunk(e.data,this),this.resumeListeningTimeout&&clearTimeout(this.resumeListeningTimeout)}catch(e){this.isAISpeaking=!1,this.chat.voiceModal?.setAssistantSpeaking(!1)}break;case"voice.audio.end":this.isProcessingResponse=!1;break;case"voice.error":this.chat.voiceModal?.setError(e.error),this.isAISpeaking=!1,this.chat.voiceModal?.setAssistantSpeaking(!1),this.isProcessingResponse=!1}}handleResume(){this.chat.voiceModal?.isPushToTalkEnabled||(this.isAISpeaking=!1,this.startListening())}handleResumeAfterAudio(){if(!this.chat.voiceModal?.isPushToTalkEnabled){if(this.isAISpeaking=!1,this.isProcessingResponse=!1,this.wasBlocking=!1,this.recognition)try{this.recognition.abort()}catch(e){}this.initializeRecognition().then((()=>{this.startListening()})).catch((e=>{this.reconnect(null,!0)}))}}async connect(){try{if(!await this.checkPermissions())return this.chat.voiceModal?.setError("Microphone access denied"),!1;if(this.isSafari&&(this.chat.voiceModal?.setConnecting(),await new Promise((e=>setTimeout(e,1e3)))),await this.initializeRecognition(),await this.audioPlayer.initialize(),this.isSafari)try{await this.testRecognitionSystem()}catch(e){return!1}return this.connected=!0,this.chat.voiceModal?.setConnected(),this.chat.voiceModal?.isPushToTalkEnabled||await this.startListening(),!0}catch(e){return this.chat.voiceModal?.setError("Failed to initialize voice system"),!1}}async testRecognitionSystem(){return new Promise(((e,t)=>{const s=setTimeout((()=>{t(new Error("Recognition system initialization timeout"))}),3e3),i=new(window.webkitSpeechRecognition||window.SpeechRecognition);i.onstart=()=>{i.abort(),clearTimeout(s),e()},i.onerror=e=>{clearTimeout(s),t(e)},i.start()}))}async startListening(){if(this.recognition&&!this.isAISpeaking)try{this.stopRecognisingExceptForInterruptions=!1,await this.recognition.start(),this.isListening=!0}catch(e){e.message.includes("already started")?this.isListening=!0:(this.isListening=!1,await this.reconnect(null,!0))}}async stopListening(){if(this.recognition)try{this.isListening=!1,this.chat.voiceModal?.isPushToTalkEnabled?await this.recognition.stop():this.stopRecognisingExceptForInterruptions=!0,this.silenceTimer&&clearTimeout(this.silenceTimer)}catch(e){}}async reconnect(e=null,t=!1){this.disconnect(),this.isListening=!1,this.transcript="",this.currentRunId=null,this.isAISpeaking=!1,this.isProcessingResponse=!1,this.isPushToTalkActive=!1,this.connected=!1,await new Promise((e=>setTimeout(e,500)));try{return await this.initializeRecognition(),await this.audioPlayer.initialize(),this.connected=!0,this.chat.voiceModal?.setConnected(),this.chat.voiceModal?.isPushToTalkEnabled||await this.startListening(),!0}catch(e){return this.chat.voiceModal?.setError("Failed to reconnect voice system"),!1}}disconnect(){if(this.recognition){try{this.recognition.stop(),this.recognition.onstart=null,this.recognition.onend=null,this.recognition.onresult=null,this.recognition.onerror=null}catch(e){}this.recognition=null}if(this.microphoneStream)try{this.microphoneStream.getTracks().forEach((e=>{e.stop(),e.enabled=!1})),this.microphoneStream=null}catch(e){}this.audioPlayer.destroy(),this.isListening=!1,this.connected=!1,this.isAISpeaking=!1,this.isProcessingResponse=!1,this.isPushToTalkActive=!1,this.wasBlocking=!1,this.silenceTimer&&(clearTimeout(this.silenceTimer),this.silenceTimer=null),this.resumeListeningTimeout&&(clearTimeout(this.resumeListeningTimeout),this.resumeListeningTimeout=null),this.chat.voiceModal?.setDisconnected()}}class ae{constructor(e,t,s,n){this.theme=i.A.theme,this.chat=e,this.stVoice=s,this.assistant=t,this.voiceCallback=n,this.isMobile=u.K.isMobile(),this.isRecording=!1,this.isFlipped=!1,this.floatingBox=null,this.assistantImage=null,this.settingsButton=null,this.pulseAnimation=null,this.settingsPanel=null,this.isDragging=!1,this.dragOffset={x:0,y:0},this.isMaximized=!1,this.originalPosition=null,this.lastWindowWidth=window.innerWidth,this.lastWindowHeight=window.innerHeight,this.pushToTalkText=null,this.isPressed=!1,this.isConnecting=!1,this.isConnected=!1,this.isError=!1,this.isPushToTalkEnabled=window.user.v_push_to_talk,this.textReplyMode=window.user.v_text_reply_mode,this.voice=window.user.v_voice,this.v_voice_language=window.user.v_voice_language,this.v_tools_enabled=window.user.v_tools_enabled,this.v_push_to_talk=window.user.v_push_to_talk,this.v_voice_language=window.user.v_voice_language,this.createUI(),this.setupDragListeners(),this.setupResizeListener(),this.setupKeyboardListeners(),this.setupAssistantImageListeners()}saveUserSettings(){const e={v_push_to_talk:this.isPushToTalkEnabled,v_text_reply_mode:this.textReplyMode,v_voice:this.voice,v_voice_language:this.v_voice_language,v_tools_enabled:this.v_tools_enabled};g.G.postData("/accounts/save_voice_settings/",e),window.user.v_voice=this.voice,window.user.v_voice_language=this.v_voice_language,window.user.v_tools_enabled=this.v_tools_enabled,window.user.v_push_to_talk=this.isPushToTalkEnabled,window.user.v_text_reply_mode=this.textReplyMode,this.stVoice.disconnect()}async connect(){await this.stVoice.connect()}async checkAndRequestPermissions(){try{if(navigator.permissions){"granted"===(await navigator.permissions.query({name:"microphone"})).state||await this.requestMicrophonePermission()}else await this.requestMicrophonePermission();this.attemptPlayAudio()}catch(e){}}async requestMicrophonePermission(){try{await navigator.mediaDevices.getUserMedia({audio:!0})}catch(e){}}attemptPlayAudio(){const e=new(window.AudioContext||window.webkitAudioContext),t=e.createBuffer(1,1,22050),s=e.createBufferSource();s.buffer=t,s.connect(e.destination),s.start()}createUI(){this.floatingBox=document.createElement("div"),this.floatingBox.className=`fixed ${this.theme.widgetBackground} bg-opacity-90 rounded-lg drop-shadow-xl mx-1 my-2 cursor-move touch-none select-none transition-all duration-300 ease-in-out z-30 top-10 right-5 flex flex-col opacity-0 transition-opacity duration-300 ease-in-out voice-active`,this.floatingBox.style.width="140px",this.floatingBox.style.height="140px",function(e,t=!0){e.style.right="18px";const s=t?document.querySelector(".screen-share-active"):document.querySelector(".voice-active");if(s&&"none"!==window.getComputedStyle(s).display&&s.offsetWidth>0){const t=s.offsetWidth,i=window.getComputedStyle(s),n=(parseInt(i.right)||5)+t+10;e.style.right=`${n}px`}}(this.floatingBox,!0),this.isMobile&&(this.floatingBox.style.top="90px",this.floatingBox.style.right="5px");const e=document.createElement("div");e.className="flex flex-col h-full relative",this.floatingBox.appendChild(e),this.closeButton=document.createElement("button");const t=o.A.name("circlePhoneHangup");this.closeButton.innerHTML=`<svg viewBox="${t.viewBox}" class="w-5 h-5 fill-current text-red-600"><path d="${t.path}"></path></svg>`,this.closeButton.className="absolute top-1 right-0 z-10 rounded-full px-2 pt-1",this.closeButton.addEventListener("click",(()=>{this.stVoice?.disconnect(),this.remove()})),e.appendChild(this.closeButton),this.settingsButton=document.createElement("button"),this.settingsButton.id="settingsButton";const s=o.A.name("circleEllipsis");this.settingsButton.innerHTML=`<svg viewBox="${s.viewBox}" class="w-5 h-5 fill-current"><path d="${s.path}"></path></svg>`,this.settingsButton.className=`absolute top-1 left-0 z-10 ${this.theme.iconColor} rounded-full px-2 pt-1`,this.settingsButton.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.togglingSettings=!0,this.toggleSettings()})),e.appendChild(this.settingsButton),this.frontSide=document.createElement("div"),this.frontSide.className="absolute inset-0 flex flex-col items-center justify-center h-full w-full transition-all duration-500",this.frontSide.style.backfaceVisibility="hidden",e.appendChild(this.frontSide);const i=document.createElement("div");i.className="flex flex-col justify-center items-center h-full w-full relative pt-3",this.frontSide.appendChild(i),this.pulseAnimation=document.createElement("div"),this.pulseAnimation.className="absolute w-[100px] h-[100px] top-[12px] rounded-full bg-indigo-500/50 opacity-0",i.appendChild(this.pulseAnimation),this.assistantImage=document.createElement("img"),this.assistantImage.src=this.assistant.image,this.assistantImage.alt="Assistant",this.assistantImage.className="w-[80px] h-[80px] rounded-full drop-shadow-xl cursor-pointer transition-all duration-200 ease-in-out z-20 relative",this.assistantImage.draggable=!1,i.appendChild(this.assistantImage),this.pushToTalkText=document.createElement("div"),this.pushToTalkText.className=`text-center ${this.theme.text} text-xs pt-3`,this.pushToTalkText.textContent="Push to talk",i.appendChild(this.pushToTalkText),this.settingsPanel=document.createElement("div"),this.settingsPanel.className="absolute inset-0 p-2 rounded-lg z-30 flex flex-col items-center justify-start transition-all duration-500",this.settingsPanel.style.backfaceVisibility="hidden",this.settingsPanel.style.transform="rotateY(180deg)",e.appendChild(this.settingsPanel);const n=document.createElement("button"),a=o.A.name("circleCheveronLeft");n.innerHTML=`<svg viewBox="${a.viewBox}" class="w-5 h-5 fill-current"><path d="${a.path}"></path></svg>`,n.className="absolute top-1 left-0 z-10 text-gray-500 rounded-full px-2 pt-1",n.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.togglingSettings=!0,this.toggleSettings()})),this.settingsPanel.appendChild(n),this.settingsContent=document.createElement("div"),this.settingsContent.className="w-full mt-8 overflow-y-auto mx-2 hidden transition-all duration-300 ease-in-out px-0.5 pb-4";const r=document.createElement("div");r.className="mb-1";const l=document.createElement("div");l.className="text-xs",l.textContent="Push to talk",r.appendChild(l),this.pushToTalkSwitch=new C({size:"small",value:this.isPushToTalkEnabled,disabled:!1}),this.pushToTalkSwitch.render(r),this.pushToTalkSwitch.onSwitchTrue((()=>{this.isPushToTalkEnabled=!0,window.v_push_to_talk=!0,this.updateUIForPushToTalkState(),this.saveUserSettings()})),this.pushToTalkSwitch.onSwitchFalse((()=>{this.isPushToTalkEnabled=!1,window.v_push_to_talk=!1,this.updateUIForPushToTalkState(),this.saveUserSettings()}));const c=document.createElement("div");c.className="mb-1";const d=document.createElement("div");d.className="text-xs",d.textContent="Voice response",c.appendChild(d),this.voiceResponseSwitch=new C({size:"small",value:!this.textReplyMode,disabled:!1}),this.voiceResponseSwitch.render(c),this.voiceResponseSwitch.onChange((()=>{this.voiceResponseSwitch.value?(this.textReplyMode=!1,this.voiceResponseCallback&&this.voiceResponseCallback("enable")):(this.textReplyMode=!0,this.voiceResponseCallback&&this.voiceResponseCallback("disable")),this.saveUserSettings()}));const h=document.createElement("div");h.className="mr-3";const m=document.createElement("div");m.className="text-xs",m.textContent="Voice",h.appendChild(m),this.voice||(this.voice="af"),["af","am_adam","am_michael","af_bella","af_nicole","af_sarah","af_sky","bf_emma","bf_isabella","bm_george","bm_lewis"].indexOf(this.voice)<0&&(this.voice="af"),this.voiceSelectionSelector=new E({label:"",value:this.voice||"af",required:!0,disabled:!1,readonly:!1,error:"Please select a voice",helpText:"",size:"small",options:[{value:"af",label:"Default Voice (American Female)",type:"model"},{value:"am_adam",label:"Adam (American Male)",type:"model"},{value:"am_michael",label:"Michael (American Male)",type:"model"},{value:"af_bella",label:"Bella (American Female)",type:"model"},{value:"af_nicole",label:"Nicole (American Female)",type:"model"},{value:"af_sarah",label:"Sarah (American Female)",type:"model"},{value:"af_sky",label:"Sky (American Female)",type:"model"},{value:"bf_emma",label:"Emma (British Female)",type:"model"},{value:"bf_isabella",label:"Isabella (British Female)",type:"model"},{value:"bm_george",label:"George (British Male)",type:"model"},{value:"bm_lewis",label:"Lewis (British Male)",type:"model"}]}),this.voiceSelectionSelector.render(h),this.voiceSelectionSelector.onChange((e=>{this.voice=e,this.saveUserSettings()}));const u=document.createElement("div");u.className="mb-1 mt-2";const p=document.createElement("div");p.className="text-xs",p.textContent="Enable skills",u.appendChild(p),this.toolUseSwitch=new C({size:"small",value:this.v_tools_enabled,disabled:!1}),this.toolUseSwitch.render(u),this.toolUseSwitch.onSwitchTrue((()=>{this.v_tools_enabled=!0,this.saveUserSettings()})),this.toolUseSwitch.onSwitchFalse((()=>{this.v_tools_enabled=!1,this.saveUserSettings()})),this.setConnecting(),this.settingsContent.appendChild(r),this.settingsContent.appendChild(c),this.settingsContent.appendChild(h),this.settingsContent.appendChild(u),this.settingsPanel.appendChild(this.settingsContent),e.appendChild(this.settingsPanel),document.body.appendChild(this.floatingBox),requestAnimationFrame((()=>this.fadeIn()))}fadeIn(){this.floatingBox.offsetWidth,this.floatingBox.classList.remove("opacity-0"),this.floatingBox.classList.add("opacity-100")}toggleSettings(){this.isFlipped=!this.isFlipped;const e=this.isFlipped?180:0;this.frontSide.style.transform=`rotateY(${e}deg)`,this.settingsPanel.style.transform=`rotateY(${e+180}deg)`,this.isFlipped?(this.frontSide.style.pointerEvents="none",this.settingsPanel.style.pointerEvents="auto",this.settingsButton.style.display="none",this.closeButton.style.display="none",setTimeout((()=>{this.settingsContent.classList.remove("hidden")}),200)):(this.settingsContent.classList.add("hidden"),this.frontSide.style.pointerEvents="auto",this.settingsPanel.style.pointerEvents="none",this.settingsButton.style.display="block",this.closeButton.style.display="block",this.updateUIForPushToTalkState(),this.stVoice.reconnect(null,!0))}setupDragListeners(){let e,t,s=!1;const i=s=>{if(s.target===this.assistantImage)return;const i="touchstart"===s.type?s.touches[0]:s,a=this.floatingBox.getBoundingClientRect();e=i.clientX-a.left,t=i.clientY-a.top,this.floatingBox.style.transition="none",document.addEventListener("mousemove",n),document.addEventListener("touchmove",n,{passive:!1}),document.addEventListener("mouseup",o),document.addEventListener("touchend",o)},n=i=>{const o="touchmove"===i.type?i.touches[0]:i,r=o.clientX-(e+this.floatingBox.offsetLeft),l=o.clientY-(t+this.floatingBox.offsetTop);(Math.abs(r)>5||Math.abs(l)>5)&&(s=!0,document.removeEventListener("mousemove",n),document.removeEventListener("touchmove",n),document.addEventListener("mousemove",a),document.addEventListener("touchmove",a,{passive:!1}))},a=i=>{if(!s)return;i.preventDefault();const n="touchmove"===i.type?i.touches[0]:i;let a=n.clientX-e,o=n.clientY-t;const r=this.constrainPosition(a,o);this.floatingBox.style.left=`${r.left}px`,this.floatingBox.style.top=`${r.top}px`,this.floatingBox.style.right="auto"},o=()=>{s=!1,this.floatingBox.style.transition="all 0.3s ease-in-out",document.removeEventListener("mousemove",n),document.removeEventListener("touchmove",n),document.removeEventListener("mousemove",a),document.removeEventListener("touchmove",a),document.removeEventListener("mouseup",o),document.removeEventListener("touchend",o)};this.floatingBox.addEventListener("mousedown",i),this.floatingBox.addEventListener("touchstart",i)}constrainPosition(e,t){const s=window.innerWidth,i=window.innerHeight,n=this.floatingBox.offsetWidth,a=this.floatingBox.offsetHeight;return{left:e=Math.max(20,Math.min(e,s-20)),top:t=Math.max(20,Math.min(t,i-a-20)),right:s-e-n}}handleWindowResize(){const e=window.innerWidth,t=window.innerHeight,s=this.floatingBox.offsetWidth,i=(this.floatingBox.offsetHeight,1*e/100),n=5*t/100;let a,o;const r=parseInt(this.floatingBox.style.right)||i,l=parseInt(this.floatingBox.style.top)||n;if(Math.abs(e-this.lastWindowWidth)>200||Math.abs(t-this.lastWindowHeight)>200)a=i,o=n;else{a=r/this.lastWindowWidth*e,o=l/this.lastWindowHeight*t}const c=this.constrainPosition(e-a-s,o);this.floatingBox.style.right=`${c.right}px`,this.floatingBox.style.top=`${c.top}px`,this.floatingBox.style.left="auto",this.lastWindowWidth=e,this.lastWindowHeight=t}setupAssistantImageListeners(){this.assistantImage.addEventListener("mousedown",this.handleAssistantImagePress.bind(this)),this.assistantImage.addEventListener("mouseup",this.handleAssistantImageRelease.bind(this)),this.assistantImage.addEventListener("mouseleave",this.handleAssistantImageRelease.bind(this)),this.assistantImage.addEventListener("touchstart",(e=>{e.preventDefault(),this.handleAssistantImagePress(e)})),this.assistantImage.addEventListener("touchend",(e=>{e.preventDefault(),this.handleAssistantImageRelease(e)})),this.assistantImage.addEventListener("touchcancel",(e=>{e.preventDefault(),this.handleAssistantImageRelease(e)}))}handleAssistantImagePress(e){this.isPushToTalkEnabled&&!this.isRecording&&this.isConnected&&(this.isKeyPressed||this.isPressed||(this.isPressed=!0,this.isSpeaking&&this.interruptSpeech(),this.isPushToTalkEnabled&&this.stVoice.handlePushToTalkStart()))}handleAssistantImageRelease(e){this.isPushToTalkEnabled&&this.isPressed&&(this.isPressed=!1,this.isPushToTalkEnabled&&this.stVoice.handlePushToTalkEnd())}interruptSpeech(){this.isSpeaking&&(this.isSpeaking=!1,this.assistantImage.style.border="none",this.voiceCallback&&this.voiceCallback("interrupt"))}startRecording(){!this.isRecording&&this.isConnected&&(this.isRecording=!0,this.assistantImage.style.transform="scale(0.95)",this.pulseAnimation.style.animation="pulse 2s infinite",this.pulseAnimation.style.opacity="1",this.pushToTalkText.textContent="Listening...",this.assistantImage.style.border="none",this.stVoice.startListening())}stopRecording(){this.isRecording&&this.isConnected&&(this.isRecording=!1,this.resetUIState(),this.stVoice.stopListening())}handleKeyDown(e){if(this.isPushToTalkEnabled&&"`"===e.key&&!this.isKeyPressed&&!this.isPressed){if(e.preventDefault(),this.isRecording||!this.isConnected)return;this.isKeyPressed=!0,this.isSpeaking&&this.interruptSpeech(),this.isPushToTalkEnabled?this.stVoice.handlePushToTalkStart():this.startRecording()}}handleKeyUp(e){this.isPushToTalkEnabled&&"`"===e.key&&this.isKeyPressed&&(e.preventDefault(),this.isKeyPressed=!1,this.isPushToTalkEnabled?this.stVoice.handlePushToTalkEnd():this.stopRecording())}setAssistantSpeaking(e){this.isSpeaking=e,this.isRecording=!1,e?(this.assistantImage.style.transform="scale(1.05)",this.pulseAnimation.style.animation="pulse 1.5s infinite",this.pulseAnimation.style.opacity="1",this.pushToTalkText.textContent="Speaking...",this.assistantImage.style.border="2px solid #4CAF50"):this.resetUIState()}setUserSpeaking(e){this.isPushToTalkEnabled&&!e||(e?(this.assistantImage.style.transform="scale(1.05)",this.pulseAnimation.style.animation="pulse 1.5s infinite",this.pulseAnimation.style.opacity="1",this.pushToTalkText.textContent="Listening..."):this.resetUIState())}resetUIState(){this.assistantImage.style.transform="scale(1)",this.pulseAnimation.style.animation="none",this.pulseAnimation.style.opacity="0",this.isPressed&&this.isPushToTalkEnabled||(this.pushToTalkText.textContent=this.isPushToTalkEnabled?"Push to talk":"I'm listening"),this.assistantImage.style.border="none"}onVoiceClosed(e){this.onVoiceClosedCallback=e}updateUIForPushToTalkState(){this.pushToTalkText&&(this.pushToTalkText.textContent=this.isPushToTalkEnabled?"Push to talk":"I'm listening"),this.isPushToTalkEnabled&&this.isRecording&&this.stopRecording()}remove(){this.floatingBox.classList.remove("opacity-100"),this.floatingBox.classList.add("opacity-0"),setTimeout((()=>{document.removeEventListener("resize",this.handleWindowResize.bind(this)),document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this)),this.floatingBox&&this.floatingBox.parentNode&&this.floatingBox.parentNode.removeChild(this.floatingBox),this.onVoiceClosedCallback&&this.onVoiceClosedCallback()}),300)}setupKeyboardListeners(){document.addEventListener("keydown",this.handleKeyDown.bind(this)),document.addEventListener("keyup",this.handleKeyUp.bind(this))}setupResizeListener(){window.addEventListener("resize",this.handleWindowResize.bind(this))}destroy(){this.stVoice?.disconnect(),document.removeEventListener("keydown",this.handleKeyDown.bind(this)),document.removeEventListener("keyup",this.handleKeyUp.bind(this)),window.removeEventListener("resize",this.handleWindowResize.bind(this)),this.floatingBox.removeEventListener("mousedown",this.startDrag),this.floatingBox.removeEventListener("touchstart",this.startDrag),this.assistantImage.removeEventListener("mousedown",this.handleAssistantImagePress.bind(this)),this.assistantImage.removeEventListener("mouseup",this.handleAssistantImageRelease.bind(this)),this.assistantImage.removeEventListener("mouseleave",this.handleAssistantImageRelease.bind(this)),this.assistantImage.removeEventListener("touchstart",this.handleAssistantImagePress.bind(this)),this.assistantImage.removeEventListener("touchend",this.handleAssistantImageRelease.bind(this)),this.assistantImage.removeEventListener("touchcancel",this.handleAssistantImageRelease.bind(this)),this.floatingBox&&this.floatingBox.parentNode&&this.floatingBox.parentNode.removeChild(this.floatingBox),this.floatingBox=null,this.assistantImage=null,this.settingsButton=null,this.pulseAnimation=null,this.settingsPanel=null,this.pushToTalkText=null}setConnecting(){this.isConnecting=!0,this.isConnected=!1,this.updateUIForConnectingState()}setConnected(){this.isConnecting=!1,this.isConnected=!0,this.updateUIForConnectedState()}updateUIForConnectingState(){this.pushToTalkText&&(this.pushToTalkText.textContent="Connecting..."),this.assistantImage&&(this.assistantImage.style.opacity="0.5",this.assistantImage.style.cursor="wait"),this.disableAssistantImageButton()}updateUIForConnectedState(){this.pushToTalkText&&(this.pushToTalkText.textContent=this.isPushToTalkEnabled?"Push to talk":"I'm listening"),this.assistantImage&&(this.assistantImage.style.opacity="1",this.assistantImage.style.cursor="pointer"),this.enableAssistantImageButton()}disableAssistantImageButton(){this.assistantImage.style.pointerEvents="none",this.assistantImage.removeEventListener("mousedown",this.handleAssistantImagePress),this.assistantImage.removeEventListener("mouseup",this.handleAssistantImageRelease),this.assistantImage.removeEventListener("mouseleave",this.handleAssistantImageRelease),this.assistantImage.removeEventListener("touchstart",this.handleAssistantImagePress),this.assistantImage.removeEventListener("touchend",this.handleAssistantImageRelease),this.assistantImage.removeEventListener("touchcancel",this.handleAssistantImageRelease)}enableAssistantImageButton(){this.assistantImage.style.pointerEvents="auto",this.assistantImage.addEventListener("mousedown",this.handleAssistantImagePress.bind(this)),this.assistantImage.addEventListener("mouseup",this.handleAssistantImageRelease.bind(this)),this.assistantImage.addEventListener("mouseleave",this.handleAssistantImageRelease.bind(this)),this.assistantImage.addEventListener("touchstart",(e=>{e.preventDefault(),this.handleAssistantImagePress(e)})),this.assistantImage.addEventListener("touchend",(e=>{e.preventDefault(),this.handleAssistantImageRelease(e)})),this.assistantImage.addEventListener("touchcancel",(e=>{e.preventDefault(),this.handleAssistantImageRelease(e)}))}setError(e="Something went wrong"){this.isConnecting=!1,this.isConnected=!1,this.isError=!0,this.updateUIForErrorState(e)}setDisconnected(){this.isConnecting=!1,this.isConnected=!1,this.isError=!1,this.updateUIForDisconnectedState()}updateUIForDisconnectedState(){this.pushToTalkText&&(this.pushToTalkText.textContent="Disconnected"),this.assistantImage&&(this.assistantImage.style.opacity="0.5",this.assistantImage.style.cursor="not-allowed"),this.disableAssistantImageButton()}updateUIForErrorState(e){this.pushToTalkText&&(this.pushToTalkText.textContent=e,this.pushToTalkText.classList.add("text-red-500")),this.assistantImage&&(this.assistantImage.style.opacity="0.5",this.assistantImage.style.cursor="not-allowed",this.assistantImage.style.border="2px solid #FF0000"),this.disableAssistantImageButton()}toggleMute(){this.isMuted=!this.isMuted;const e=this.isMuted?"microphoneSlash":"microphone",t=o.A.name(e);if(this.muteButton&&t&&t.path)this.muteButton.innerHTML=`<svg viewBox="${t.viewBox}" class="w-[10px] h-[10px] fill-current"><path d="${t.path}"></path></svg>`;else{const e=o.A.name("error");this.muteButton&&e&&e.path&&(this.muteButton.innerHTML=`<svg viewBox="${e.viewBox}" class="w-[10px] h-[10px] fill-current"><path d="${e.path}"></path></svg>`)}this.voiceCallback&&this.voiceCallback(this.isMuted?"mute":"unmute")}stopAssistantSpeech(){this.isSpeaking&&(this.setAssistantSpeaking(!1),this.voiceCallback&&this.voiceCallback("stop"))}}class oe{static openTaskBars=new Map;constructor(e){if(oe.openTaskBars.has(e)){return oe.openTaskBars.get(e)}this.chatId=e,this.theme=i.A.theme,this.isOpen=!1,this.taskBarWidthProportion=.25,this.minTaskBarWidth=300,this.maxTaskBarWidth=600,this.minChatWidth=450,this.taskBarContainer=null,this.taskBarContent=null,this.resizeHandle=null,this.resizeHandler=this.recalculateWidths.bind(this),window.addEventListener("resize",this.resizeHandler),oe.openTaskBars.set(e,this),this.createTaskBar()}createTaskBar(){if(this.chatContainer=document.getElementById("focus-mode"),this.chatWidthContainer=document.getElementById("outer-chat-session-container"),!this.chatContainer||!this.chatWidthContainer)return null;this.taskBarContainer=document.createElement("div"),this.taskBarContainer.classList="h-full overflow-y-auto overflow-x-hidden relative ml-2 lg:ml-0 task-bar-slide-in min-w-[300px] sm:min-w-[300px]",this.taskBarContainer.id="task-bar-container";const e=this.chatContainer.offsetWidth,t=window.innerWidth<640,s=window.innerWidth<1024;if(t||s)this.taskBarContainer.style.width="100%",this.taskBarContainer.style.minWidth="100%",this.taskBarContainer.style.maxWidth="100%";else{const t=Math.round(e*this.taskBarWidthProportion),s=Math.max(this.minTaskBarWidth,Math.min(t,e-this.minChatWidth,this.maxTaskBarWidth));this.taskBarContainer.style.width=`${s}px`,this.taskBarContainer.style.minWidth=`${s}px`,this.taskBarContainer.style.maxWidth=`${s}px`,this.taskBarWidthProportion=s/e;const i=e-s;this.chatWidthContainer.style.width=`${i}px`}return this.taskBarContainer.style.opacity="0",this.taskBarContainer.style.transform="translateX(50px)",this.taskBarContent=document.createElement("div"),this.taskBarContent.classList=`w-full h-full overflow-y-auto overflow-x-hidden ${this.theme.secondaryBackground} p-6`,this.taskBarContent.id="task-bar-content",this.taskBarContent.innerHTML=`\n        \n\n\n\n<div class="space-y-4">\n  <div class="flex items-center justify-between mb-6">\n    <h2 class="text-lg font-medium">Tasks</h2>\n    <button class="${this.theme.primaryButton} text-sm px-3 py-1 rounded-md flex items-center">\n      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />\n      </svg>\n      New Task\n    </button>\n  </div>\n\n  \x3c!-- In Progress Section --\x3e\n  <div class="mb-4">\n    <h3 class="text-sm font-medium ${this.theme.fadedText} mb-2">IN PROGRESS</h3>\n    \n    \x3c!-- Task Card 1 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 mb-3 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-yellow-400 mr-3"></div>\n          <h4 class="font-medium">Research market trends</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Analyzing competitor strategies and identifying market opportunities</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-blue-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-green-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-purple-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="${this.theme.primaryButtonTransparent} text-xs px-2 py-1 rounded flex items-center">\n          <i class="fa-solid fa-spinner fa-spin mr-1"></i>\n          Working...\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Task Card 2 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 mb-3 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-purple-500 mr-3"></div>\n          <h4 class="font-medium">Generate content outline</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Creating a structured outline for the quarterly report</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-red-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-yellow-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-indigo-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="${this.theme.primaryButtonTransparent} text-xs px-2 py-1 rounded flex items-center">\n          <i class="fa-solid fa-spinner fa-spin mr-1"></i>\n          Working...\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Queued Section --\x3e\n  <div class="mb-4">\n    <h3 class="text-sm font-medium ${this.theme.fadedText} mb-2">QUEUED</h3>\n    \n    \x3c!-- Task Card 3 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 mb-3 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-gray-400 mr-3"></div>\n          <h4 class="font-medium">Data visualization</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Creating charts and graphs for the sales data</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-teal-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-orange-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-blue-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="${this.theme.secondaryButtonTransparent} text-xs px-2 py-1 rounded">\n          Queued\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Task Card 4 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-gray-400 mr-3"></div>\n          <h4 class="font-medium">Code review</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Analyzing and optimizing the JavaScript implementation</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-pink-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-cyan-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-amber-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="${this.theme.secondaryButtonTransparent} text-xs px-2 py-1 rounded">\n          Queued\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Needs Follow-up Section --\x3e\n  <div class="mb-4">\n    <h3 class="text-sm font-medium ${this.theme.fadedText} mb-2">NEEDS FOLLOW-UP</h3>\n    \n    \x3c!-- Task Card - Follow-up 1 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 mb-3 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-amber-500 mr-3"></div>\n          <h4 class="font-medium">Verifying details</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Waiting for reply to my email</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-blue-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-purple-500 border-2 border-white dark:border-gray-800 z-20"></div>\n          </div>\n        </div>\n        <div class="bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs px-2 py-1 rounded flex items-center">\n          <i class="fa-solid fa-clock mr-1"></i>\n          Awaiting Input\n        </div>\n      </div>\n    </div>\n    \n    \x3c!-- Task Card - Follow-up 2 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 ${this.theme.backgroundHover} transition-shadow">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-amber-500 mr-3"></div>\n          <h4 class="font-medium">API integration clarification</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Need technical specifications from the backend team</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-green-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-red-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-yellow-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs px-2 py-1 rounded flex items-center">\n          <i class="fa-solid fa-question-circle mr-1"></i>\n          Needs Input\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Completed Section --\x3e\n  <div>\n    <h3 class="text-sm font-medium ${this.theme.fadedText} mb-2">COMPLETED</h3>\n    \n    \x3c!-- Task Card 5 --\x3e\n    <div class="${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 mb-3 ${this.theme.backgroundHover} transition-shadow opacity-75">\n      <div class="flex justify-between items-start">\n        <div class="flex items-center">\n          <div class="h-4 w-4 rounded-full bg-green-500 mr-3"></div>\n          <h4 class="font-medium line-through ${this.theme.fadedText}">Draft email campaign</h4>\n        </div>\n        <div class="relative flex items-center">\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n            </svg>\n          </button>\n          <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n            </svg>\n          </button>\n        </div>\n      </div>\n      <p class="text-sm ${this.theme.fadedText} mt-2">Created email templates for the product launch</p>\n      <div class="mt-4 flex justify-between items-center">\n        <div class="flex items-center">\n          <div class="flex -space-x-2">\n            <div class="h-6 w-6 rounded-full bg-violet-500 border-2 border-white dark:border-gray-800 z-30"></div>\n            <div class="h-6 w-6 rounded-full bg-emerald-500 border-2 border-white dark:border-gray-800 z-20"></div>\n            <div class="h-6 w-6 rounded-full bg-rose-500 border-2 border-white dark:border-gray-800 z-10"></div>\n          </div>\n        </div>\n        <div class="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-2 py-1 rounded">\n          Complete\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \x3c!-- Add Task Button (Mobile) --\x3e\n  <div class="mt-6 sm:hidden">\n    <button class="w-full py-2 ${this.theme.primaryButton} rounded-md flex items-center justify-center">\n      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />\n      </svg>\n      Add New Task\n    </button>\n  </div>\n</div>\n        \n        \n        \n        \n              \n              \n              \n        \n        `,this.resizeHandle=this.createResizeHandle(),(t||s)&&(this.resizeHandle.style.display="none"),this.taskBarContainer.appendChild(this.resizeHandle),this.taskBarContainer.appendChild(this.taskBarContent),this.chatContainer.appendChild(this.taskBarContainer),this.taskBarContainer.offsetWidth,this.taskBarContainer.style.removeProperty("opacity"),this.taskBarContainer.style.removeProperty("transform"),this.isOpen=!0,this.taskBarContainer}createResizeHandle(){const e=document.createElement("div");let t,s;e.classList.add("resize-handle"),e.style.right="auto",e.style.left="0";let i=!1;const n=e=>{if(!i)return;if(!this.taskBarContainer)return;const n=t-e.clientX;let a=s+n;const o=this.chatContainer.offsetWidth,r=o-this.minChatWidth;a=Math.max(this.minTaskBarWidth,Math.min(a,r,this.maxTaskBarWidth)),this.taskBarWidthProportion=a/o,this.taskBarContainer.style.width=`${a}px`,this.taskBarContainer.style.minWidth=`${a}px`,this.taskBarContainer.style.maxWidth=`${a}px`;const l=o-a;this.chatWidthContainer.style.width=`${l}px`},a=()=>{i=!1,document.removeEventListener("mousemove",n),document.removeEventListener("mouseup",a),this.removeResizeOverlay(),e.classList.remove("active")};return e.addEventListener("mousedown",(o=>{window.innerWidth<1024||(o.preventDefault(),i=!0,t=o.clientX,s=this.taskBarContainer.offsetWidth,this.createResizeOverlay(),document.addEventListener("mousemove",n),document.addEventListener("mouseup",a),e.classList.add("active"))})),e}createResizeOverlay(){this.resizeOverlay=document.createElement("div"),this.resizeOverlay.style.cssText="\n            position: fixed;\n            top: 0;\n            left: 0;\n            right: 0;\n            bottom: 0;\n            z-index: 9999;\n            cursor: ew-resize;\n        ",document.body.appendChild(this.resizeOverlay)}removeResizeOverlay(){this.resizeOverlay&&(this.resizeOverlay.remove(),this.resizeOverlay=null)}recalculateWidths(){if(!this.isOpen||!this.taskBarContainer)return;const e=this.chatContainer?.offsetWidth;if(!e)return;const t=window.innerWidth<640,s=window.innerWidth<1024;if(t||s)this.taskBarContainer.style.width="100%",this.taskBarContainer.style.minWidth="100%",this.taskBarContainer.style.maxWidth="100%",this.chatWidthContainer.style.width="100%",this.resizeHandle&&(this.resizeHandle.style.display="none");else{this.resizeHandle&&(this.resizeHandle.style.display="");let t=Math.round(e*this.taskBarWidthProportion);t=Math.max(this.minTaskBarWidth,Math.min(t,e-this.minChatWidth,this.maxTaskBarWidth)),this.taskBarContainer.style.width=`${t}px`,this.taskBarContainer.style.minWidth=`${t}px`,this.taskBarContainer.style.maxWidth=`${t}px`;const s=e-t;this.chatWidthContainer.style.width=`${s}px`}}setContent(e){this.taskBarContent&&(this.taskBarContent.innerHTML="","string"==typeof e?this.taskBarContent.innerHTML=e:e instanceof HTMLElement&&this.taskBarContent.appendChild(e))}close(){if(!this.isOpen||!this.taskBarContainer)return;this.taskBarContainer.animate([{transform:"translateX(0)",opacity:1},{transform:"translateX(50px)",opacity:0}],{duration:300,easing:"ease-in-out"}).onfinish=()=>{this.taskBarContainer.remove(),this.taskBarContainer=null,this.taskBarContent=null,this.resizeHandle=null,this.chatWidthContainer.style.width="100%",this.isOpen=!1,oe.openTaskBars.delete(this.chatId)}}toggle(){this.isOpen?this.close():this.createTaskBar()}}var re=s(10246);class le{constructor(e,t,s){this.triggerElement=e,this.tabData=t,this.callbacks=s,this.theme=i.A.theme,this.menuContainer=null,this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),this._boundHandleKeyDown=this._handleKeyDown.bind(this),this.init()}init(){this.removeExisting(),this.menuContainer=document.createElement("div"),this.menuContainer.className=`tab-context-menu absolute ${this.theme.tableMenuBackground} ${this.theme.shadow} rounded-lg z-50 text-sm min-w-[180px] flex flex-col overflow-hidden py-1`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transform="scale(0.95)",this.menuContainer.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out",this.menuContainer.setAttribute("role","menu"),this._renderMenuItems(),document.body.appendChild(this.menuContainer),this._positionMenu(),requestAnimationFrame((()=>{if(!this.menuContainer)return;this.menuContainer.style.visibility="visible",this.menuContainer.style.opacity="1",this.menuContainer.style.transform="scale(1)";this.menuContainer.querySelector('button[role="menuitem"]')})),this._addEventListeners()}_renderMenuItems(){if(!this.menuContainer)return;const e=this.tabData.isPinned?"Unpin":"Pin",t=this.tabData.isPinned&&o.A.name("thumbtackSlash")?"thumbtackSlash":"thumbtack";if(this._addMenuItem(e,t,this.callbacks.onPin),this._addMenuItem("Add to folder","folder",this.callbacks.onFolder),this._addSeparator(),this._addMenuItem("Rename","edit",this.callbacks.onRename),this._addSeparator(),this.callbacks.onMarkRead){const e=this.tabData.hasNotification?"Mark read":"Mark unread",t=this.tabData.hasNotification?"bellSlash":"bell";this._addMenuItem(e,t,this.callbacks.onMarkRead)}this._addMenuItem("Refresh","rotate",this.callbacks.onRefresh),this._addSeparator(),this._addMenuItem("Delete","trash",this.callbacks.onDelete)}_addMenuItem(e,t,s,i){if(!this.menuContainer)return;const n=document.createElement("button"),a=i||this.theme.text;n.className=`w-full text-left px-3 py-1.5 ${this.theme.tableMenuButtonHover} flex items-center gap-3`,n.setAttribute("role","menuitem");const l=o.A.name(t);let c=!1;if("bell"!==t&&"bellSlash"!==t||(c=!0),l){const e=document.createElement("div");e.className="w-4 h-4 flex-shrink-0 flex items-center justify-center";const t=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:c?"w-4 h-4":"w-3.5 h-3.5",additionalClasses:a});e.appendChild(t.element),n.appendChild(e)}else{const e=document.createElement("div");e.className="w-4 h-4 flex-shrink-0",n.appendChild(e)}const d=document.createElement("span");d.className=`${a} text-sm`,d.textContent=e,n.appendChild(d),n.addEventListener("click",(e=>{e.stopPropagation(),s&&s(this.tabData),this.remove()})),this.menuContainer.appendChild(n)}_addSeparator(){if(!this.menuContainer)return;const e=document.createElement("div");e.className=`border-t ${this.theme.tableDividerLine} my-1 mx-2`,this.menuContainer.appendChild(e)}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect();this.menuContainer.style.visibility="hidden",document.body.appendChild(this.menuContainer);const t=this.menuContainer.getBoundingClientRect();let s=e.bottom+4,i=e.left;i+t.width>window.innerWidth-8&&(i=window.innerWidth-t.width-8),i<8&&(i=8),s+t.height>window.innerHeight-8&&(s=e.top-t.height-4),s<8&&(s=8),this.menuContainer.style.top=`${s+window.scrollY}px`,this.menuContainer.style.left=`${i+window.scrollX}px`}_addEventListeners(){document.addEventListener("click",this._boundHandleOutsideClick,!0),this.menuContainer&&this.menuContainer.addEventListener("keydown",this._boundHandleKeyDown)}_removeEventListeners(){document.removeEventListener("click",this._boundHandleOutsideClick,!0),this.menuContainer&&this.menuContainer.removeEventListener("keydown",this._boundHandleKeyDown)}_handleOutsideClick(e){!this.menuContainer||this.menuContainer.contains(e.target)||e.target===this.triggerElement||this.triggerElement.contains(e.target)||this.remove()}_handleKeyDown(e){if(this.menuContainer){if("Escape"===e.key&&(e.preventDefault(),this.remove(),this.triggerElement&&"function"==typeof this.triggerElement.focus&&this.triggerElement.focus()),"ArrowDown"===e.key||"ArrowUp"===e.key||"Tab"===e.key){e.preventDefault();const t=Array.from(this.menuContainer.querySelectorAll('button[role="menuitem"]'));if(!t.length)return;let s,i=t.indexOf(document.activeElement);-1===i&&"Tab"===e.key&&e.shiftKey?i=0:-1===i&&"Tab"===e.key&&(i=t.length-1),s="ArrowDown"===e.key||"Tab"===e.key&&!e.shiftKey?(i+1)%t.length:(i-1+t.length)%t.length,t[s].focus()}"Enter"!==e.key&&" "!==e.key||document.activeElement&&this.menuContainer.contains(document.activeElement)&&(e.preventDefault(),document.activeElement.click())}}removeExisting(){document.querySelectorAll(".tab-context-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(){this._removeEventListeners();const e=this.menuContainer;if(this.menuContainer=null,e){e.style.opacity="0",e.style.transform="scale(0.95)";const t=setTimeout((()=>{e.parentNode&&e.remove()}),150);e.addEventListener("transitionend",(s=>{"opacity"===s.propertyName&&e.parentNode&&(clearTimeout(t),e.remove())}),{once:!0})}}}class ce{constructor(){this.theme=i.A.theme,this.currentAdminView="users_list",this.activeUserIdForMcpList=null,this.searchQueryUsers="",this.searchQueryMcpStoreListings="",this.handleKeyDown=this.handleKeyDown.bind(this),this.toggleSidebar=this.toggleSidebar.bind(this),this.handleResize=this.handleResize.bind(this),this.navigateTo=this.navigateTo.bind(this),this.handleUserSearch=this.handleUserSearch.bind(this),this.fetchAndRenderUsers=this.fetchAndRenderUsers.bind(this),this.filterByUserAndShowMcps=this.filterByUserAndShowMcps.bind(this),this.handleMcpConnectionAction=this.handleMcpConnectionAction.bind(this),this.restartMcpConnection=this.restartMcpConnection.bind(this),this.testMcpConnection=this.testMcpConnection.bind(this),this.viewMcpLogs=this.viewMcpLogs.bind(this),this.pollUserMcpConnectionStatuses=this.pollUserMcpConnectionStatuses.bind(this),this.pollForAiAnalysis=this.pollForAiAnalysis.bind(this),this.users=[],this.currentUserMcps=[],this.mcpStoreListings=[],this.isLoading=!1,this.container=null,this.panelEl=null,this.sidebarEl=null,this.mobileSidebar=null,this.sidebarOverlay=null,this.contentEl=null,this.mobileMenuButton=null,this.sidebarVisible=!1,this.userMcpPollingInterval=null,this.loadInitialAdminShellData(),window.addEventListener("resize",this.handleResize),this.handleResize()}async loadInitialAdminShellData(){this.isLoading=!0,this.renderShell(),this.show(),this.renderAdminMenuLoadingState(),this.renderAdminMenu(),await this.navigateTo(this.currentAdminView),this.isLoading=!1}renderShell(){this.container=document.createElement("div"),this.container.className="mcp-admin-panel-container fixed inset-0 z-40 flex items-start justify-center backdrop-blur-xs pt-10 sm:pt-20",this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.panelEl=document.createElement("div"),this.panelEl.className=`${this.theme.modalBackground} w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] h-[90vh] sm:h-[80vh] md:h-[75vh] rounded-lg shadow-xl flex overflow-hidden ring-1 ${this.theme.ringColor} relative`;const e=document.createElement("div");e.className="absolute top-4 right-3 z-10";const t=o.A.name("tabClose"),s=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"focus",size:"small",iconHeightAndWidth:"h-6 w-6"});s.onClick((()=>this.close())),s.render(e),this.panelEl.appendChild(e),this.sidebarEl=document.createElement("div"),this.sidebarEl.className=`${this.theme.secondaryBackground} w-56 sm:w-64 flex-shrink-0 flex flex-col border-r ${this.theme.tableBorder} hidden md:flex`,this.sidebarEl.dataset.id="admin-main-menu-desktop",this.contentEl=document.createElement("div"),this.contentEl.className="flex-1 flex flex-col overflow-hidden",this.contentEl.dataset.id="admin-content-area",this.sidebarOverlay=document.createElement("div"),this.sidebarOverlay.className="absolute inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden",this.sidebarOverlay.addEventListener("click",(()=>this.toggleSidebar(!1))),this.mobileSidebar=document.createElement("div"),this.mobileSidebar.className=`${this.theme.modalBackground} absolute inset-y-0 left-0 w-64 z-30 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden border-r ${this.theme.tableBorder}`,this.mobileSidebar.dataset.id="admin-main-menu-mobile",this.panelEl.appendChild(this.sidebarEl),this.panelEl.appendChild(this.contentEl),this.panelEl.appendChild(this.sidebarOverlay),this.panelEl.appendChild(this.mobileSidebar),this.container.appendChild(this.panelEl),document.body.appendChild(this.container)}renderAdminMenuLoadingState(){const e=`\n            <div class="p-4 border-b ${this.theme.tableBorder}"><div class="h-8 ${this.theme.loadBackground} rounded animate-pulse w-3/4"></div></div>\n            <div class="flex-1 p-4 space-y-4">\n                <div class="h-6 ${this.theme.loadBackground} rounded animate-pulse"></div>\n                <div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-5/6"></div>\n                <div class="h-6 ${this.theme.loadBackground} rounded animate-pulse w-4/6"></div>\n            </div>`;this.sidebarEl&&(this.sidebarEl.innerHTML=e),this.mobileSidebar&&(this.mobileSidebar.innerHTML=e)}renderAdminMenu(){const e=[{id:"users_list",label:"Users",icon:"users",action:()=>this.navigateTo("users_list")},{id:"mcp_store_listings",label:"MCPs",icon:"puzzle",action:()=>this.navigateTo("mcp_store_listings")}],t=t=>{if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className=`p-4 border-b ${this.theme.tableBorder} flex-shrink-0`;const i=document.createElement("h2");i.className=`text-lg font-semibold ${this.theme.text}`,i.textContent="MCP admin panel",s.appendChild(i),t.appendChild(s);const n=document.createElement("ul");n.className="py-2 px-2 space-y-1 flex-grow overflow-y-auto",e.forEach((e=>{const s=document.createElement("li"),i=document.createElement("button");i.dataset.viewId=e.id,i.className="w-full text-left px-3 py-2.5 flex items-center rounded-md transition-colors duration-150 text-sm";const a=o.A.name(e.icon),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-5 h-5",additionalClasses:`mr-3 ${this.theme.menuIconColor}`}),c=document.createElement("span");c.className=this.theme.text,c.textContent=e.label,i.appendChild(l.element),i.appendChild(c),i.addEventListener("click",(()=>{e.action(),t===this.mobileSidebar&&this.toggleSidebar(!1)})),s.appendChild(i),n.appendChild(s)})),t.appendChild(n)};t(this.sidebarEl),t(this.mobileSidebar),this.updateAdminMenuHighlighting()}updateAdminMenuHighlighting(){const e=e=>"string"==typeof e?e.split(" ").filter(Boolean):[],t=t=>{if(!t)return;t.querySelectorAll("ul button").forEach((t=>{const s=t.dataset.viewId,i=t.querySelector("svg"),n=t.querySelector("span");t.classList.remove(...e(this.theme.menuSelectedItem)),t.classList.add(...e(this.theme.backgroundHover)),n&&(n.classList.remove(...e(this.theme.menuSelectedText)),n.classList.add(...e(this.theme.text))),i&&(i.classList.remove(...e(this.theme.menuIconColor)),i.classList.add(...e(this.theme.fadedText))),this.currentAdminView===s&&(t.classList.add(...e(this.theme.menuSelectedItem)),t.classList.remove(...e(this.theme.backgroundHover)),n&&(n.classList.remove(...e(this.theme.text)),n.classList.add(...e(this.theme.menuSelectedText))),i&&(i.classList.remove(...e(this.theme.fadedText)),i.classList.add(...e(this.theme.menuIconColor))))}))};t(this.sidebarEl),t(this.mobileSidebar)}async navigateTo(e){this._stopUserMcpPolling(),this.currentAdminView=e,this.activeUserIdForMcpList=null,this.currentUserMcps=[],this.renderAdminMenu(),this.renderContentAreaShell(),this.isLoading=!0,this.renderContentLoadingState();try{switch(e){case"users_list":await this.renderUsersListView();break;case"user_mcps":this.activeUserIdForMcpList?await this.renderUserMcpConnectionsView(this.activeUserIdForMcpList):this.renderErrorState("No user selected to view MCPs.");break;case"mcp_store_listings":await this.renderMcpStoreListingsView();break;default:this.renderErrorStateInContent(`View "${e}" not found.`)}}catch(t){this.renderErrorStateInContent(`Could not load ${e.replace(/_/g," ")}.`)}finally{this.isLoading=!1}}renderContentAreaShell(){if(!this.contentEl)return;this.contentEl.innerHTML="";const e=document.createElement("div");e.className=`p-3 sm:p-4 border-b ${this.theme.tableBorder} ${this.theme.modalBackground} flex items-center gap-2`,e.dataset.id="admin-content-header";const t=o.A.name("bars");this.mobileMenuButton=new n.$({svgPathData:t.path,viewBox:t.viewBox,type:"secondaryTransparent",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden mr-2"}),this.mobileMenuButton.onClick((()=>this.toggleSidebar()));const s=document.createElement("h3");s.className=`font-medium ${this.theme.text} flex-1 text-lg`,s.dataset.id="admin-content-title",e.appendChild(this.mobileMenuButton.element),e.appendChild(s);const i=document.createElement("div");i.className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6",i.dataset.id="admin-content-body",this.contentEl.appendChild(e),this.contentEl.appendChild(i)}renderContentLoadingState(){const e=this.contentEl?.querySelector('[data-id="admin-content-body"]');if(!e)return;e.innerHTML="";const t=document.createElement("div");t.className="flex items-center justify-center h-full py-10";const s=o.A.name("spinner"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-10 h-10 animate-spin",colorClass:this.theme.iconColor});t.appendChild(i.element),e.appendChild(t)}renderErrorStateInContent(e="An error occurred."){const t=this.contentEl?.querySelector('[data-id="admin-content-body"]');if(!t)return;t.innerHTML="";const s=document.createElement("div");s.className="flex flex-col items-center justify-center h-full p-6 text-center";const i=o.A.name("error"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-12 h-12",colorClass:"text-red-500",additionalClasses:"mb-4"}),a=document.createElement("p");a.className=`text-lg font-medium ${this.theme.text} mb-2`,a.textContent="Oops! Something went wrong.";const l=document.createElement("p");l.className=this.theme.fadedText,l.textContent=e,s.appendChild(n.element),s.appendChild(a),s.appendChild(l),t.appendChild(s)}async renderUsersListView(){const e=this.contentEl.querySelector('[data-id="admin-content-header"]'),t=e?.querySelector('[data-id="admin-content-title"]');t&&(t.textContent="User management");const s=this.contentEl.querySelector('[data-id="admin-content-body"]');if(!s)return;s.innerHTML="";const i=document.createElement("div");i.className="mb-4";new d({type:"search",placeholder:"Search users...",size:"medium",value:this.searchQueryUsers,onChange:e=>this.handleUserSearch(e)}).render(i),s.appendChild(i);const n=document.createElement("div");n.className=`border ${this.theme.tableBorder} rounded-lg overflow-hidden`;const a=document.createElement("table");a.className=`min-w-full divide-y ${this.theme.tableDividerLine}`;const o=document.createElement("thead");o.className=this.theme.secondaryBackground,o.innerHTML=`\n            <tr>\n                <th scope="col" class="px-6 py-3 text-left text-xs font-medium ${this.theme.tableHeaderText} uppercase tracking-wider">Name</th>\n                <th scope="col" class="px-6 py-3 text-left text-xs font-medium ${this.theme.tableHeaderText} uppercase tracking-wider">Email</th>\n                <th scope="col" class="px-6 py-3 text-left text-xs font-medium ${this.theme.tableHeaderText} uppercase tracking-wider">Actions</th>\n            </tr>`,a.appendChild(o);const r=document.createElement("tbody");r.className=`${this.theme.modalBackground} divide-y ${this.theme.tableDividerLine}`,r.dataset.id="users-table-body",a.appendChild(r),n.appendChild(a),s.appendChild(n),await this.fetchAndRenderUsers()}async handleUserSearch(e){this.searchQueryUsers=e,await this.fetchAndRenderUsers()}async fetchAndRenderUsers(){const e=this.contentEl?.querySelector('[data-id="users-table-body"]');if(e){e.innerHTML=`<tr><td colspan="3" class="text-center py-4 ${this.theme.fadedText}">Loading users...</td></tr>`;try{const t=`/chat/admin/mcp-control-panel/users/?search=${encodeURIComponent(this.searchQueryUsers)}`,s=await g.G.fetchData(t);if(this.users=s.users||[],e.innerHTML="",0===this.users.length)return void(e.innerHTML=`<tr><td colspan="3" class="text-center py-4 ${this.theme.fadedText}">No users found.</td></tr>`);this.users.forEach((t=>{const s=document.createElement("tr");s.className=`hover:${this.theme.tableHoverBackground} transition-colors`;const i=document.createElement("td");i.className=`px-6 py-4 whitespace-nowrap text-sm font-medium ${this.theme.tablePrimaryColumnText}`,i.textContent=t.name||"N/A";const a=document.createElement("td");a.className=`px-6 py-4 whitespace-nowrap text-sm ${this.theme.text}`,a.textContent=t.email;const o=document.createElement("td");o.className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium";const r=new n.$({text:"View MCPs",type:"link",size:"link-sm"});r.onClick((()=>this.filterByUserAndShowMcps(t.id))),r.render(o),s.appendChild(i),s.appendChild(a),s.appendChild(o),e.appendChild(s)}))}catch(t){e.innerHTML='<tr><td colspan="3" class="text-center py-4 text-red-500">Error loading users.</td></tr>',new c.y("Failed to load users.","error")}}}async filterByUserAndShowMcps(e){this._stopUserMcpPolling(),this.activeUserIdForMcpList=e,this.currentAdminView="user_mcps",this.renderAdminMenu(),this.renderContentAreaShell();const t=this.contentEl.querySelector('[data-id="admin-content-header"]'),s=t?.querySelector('[data-id="admin-content-title"]'),i=this.users.find((t=>t.id===e));if(s&&(s.textContent=i?`MCPs for ${i.name||i.email}`:"User MCPs"),t){const e=t.querySelector('[data-button-type="back-to-users"]');e&&e.parentElement.remove();const s=document.createElement("div");s.className="ml-auto";const i=o.A.name("chevronLeft"),a=new n.$({text:"Back to users",svgPathData:i.path,svgViewBox:i.viewBox,type:"secondary",size:"small"});a.element.dataset.buttonType="back-to-users",a.onClick((()=>this.navigateTo("users_list"))),a.render(s),t.children.length>1?t.insertBefore(s,t.children[1].nextSibling):t.appendChild(s)}this.isLoading=!0,this.renderContentLoadingState();try{const t=`/chat/admin/mcp-control-panel/user-mcps/${e}/`,s=await g.G.fetchData(t);this.currentUserMcps=s.mcps||[],this.renderUserMcpConnectionsViewBody(),this.currentUserMcps.length>0&&(this.userMcpPollingInterval=setInterval(this.pollUserMcpConnectionStatuses,5e3))}catch(e){const t=i?.name||"user";new c.y(`Failed to load MCPs for ${t}.`,"error"),this.renderErrorStateInContent(`Could not load MCPs for ${t}.`)}finally{this.isLoading=!1}}renderUserMcpConnectionsViewBody(){const e=this.contentEl.querySelector('[data-id="admin-content-body"]');if(e)if(e.innerHTML="",this.currentUserMcps.length>0){const t=document.createElement("div");t.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 sm:gap-4",this.currentUserMcps.forEach((e=>t.appendChild(this.createMcpConnectionCard(e)))),e.appendChild(t)}else{const t=document.createElement("div");t.className="flex flex-col items-center justify-center h-full p-6 text-center";const s=o.A.name("boxOpen"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-12 h-12",colorClass:this.theme.iconColor,additionalClasses:"mb-4"}),n=document.createElement("p");n.className=this.theme.fadedText,n.textContent="This user has no MCPs installed or configured.",t.appendChild(i.element),t.appendChild(n),e.appendChild(t)}}_stopUserMcpPolling(){this.userMcpPollingInterval&&(clearInterval(this.userMcpPollingInterval),this.userMcpPollingInterval=null)}async pollUserMcpConnectionStatuses(){if(this.activeUserIdForMcpList&&!this.isLoading)try{const e=`/chat/admin/mcp-control-panel/user-mcps-status/${this.activeUserIdForMcpList}/`,t=(await g.G.fetchData(e)).mcps||[];let s=this.currentUserMcps.length!==t.length;if(!s&&this.currentUserMcps.length>0){const e=new Set(this.currentUserMcps.map((e=>e.id))),i=new Set(t.map((e=>e.id)));e.size===i.size&&[...e].every((e=>i.has(e)))||(s=!0)}s?(this.currentUserMcps=t,this.renderUserMcpConnectionsViewBody()):t.forEach((e=>{const t=this.currentUserMcps.find((t=>t.id===e.id));if(t&&t.live_status!==e.live_status){t.live_status=e.live_status,t.stored_status=e.stored_status;const s=this.contentEl?.querySelector(`[data-mcp-connection-id="${t.id}"]`);if(s){const e=s.querySelector('[data-live-status-value="true"]');e&&this.updateLiveStatusBadge(e,t.live_status)}}}))}catch(e){}}async renderMcpStoreListingsView(){const e=this.contentEl.querySelector('[data-id="admin-content-header"]'),t=e?.querySelector('[data-id="admin-content-title"]');t&&(t.textContent="Manage MCP store listings");const s=this.contentEl.querySelector('[data-id="admin-content-body"]');if(!s)return;s.innerHTML="";const i=document.createElement("div");i.className="mb-4";new d({type:"search",placeholder:"Search MCPs by name or ID...",size:"medium",value:this.searchQueryMcpStoreListings,onChange:e=>{this.searchQueryMcpStoreListings=e,this.fetchAndRenderMcpStoreListings()}}).render(i),s.appendChild(i);const n=document.createElement("div");n.dataset.id="mcp-store-listings-container",n.className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",s.appendChild(n),await this.fetchAndRenderMcpStoreListings()}async fetchAndRenderMcpStoreListings(){const e=this.contentEl?.querySelector('[data-id="mcp-store-listings-container"]');if(e){e.innerHTML=`<p class="${this.theme.fadedText} col-span-full text-center py-5">Loading MCP listings...</p>`;try{const t=`/chat/admin/mcp-control-panel/mcp-store-listings/?search=${encodeURIComponent(this.searchQueryMcpStoreListings)}`,s=await g.G.fetchData(t);if(this.mcpStoreListings=s.mcp_store_listings||[],e.innerHTML="",0===this.mcpStoreListings.length)return void(e.innerHTML=`<p class="${this.theme.fadedText} col-span-full text-center py-5">No MCP store listings found.</p>`);this.mcpStoreListings.forEach((t=>{e.appendChild(this.createMcpStoreListingCard(t))}))}catch(t){e.innerHTML='<p class="text-red-500 col-span-full text-center py-5">Error loading MCP store listings.</p>',new c.y("Failed to load MCP store listings.","error")}}}createMcpStoreListingCard(e){const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} shadow-sm flex flex-col overflow-hidden`;const s=document.createElement("div");if(s.className="p-4 flex items-start gap-4",e.image_url){const t=document.createElement("img");t.src=e.image_url,t.alt=e.name,t.className="w-16 h-16 object-contain rounded-md flex-shrink-0",s.appendChild(t)}else{const e=o.A.name("puzzle"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-16 h-16",colorClass:this.theme.fadedText});s.appendChild(t.element)}const i=document.createElement("div");i.className="flex-1 min-w-0";const a=document.createElement("h5");a.className=`font-semibold text-lg ${this.theme.tablePrimaryColumnText} truncate`,a.textContent=e.name,i.appendChild(a);const l=document.createElement("p");l.className=`text-xs ${this.theme.fadedText} truncate`,l.textContent=`ID: ${e.mcp_id}`,i.appendChild(l),s.appendChild(i),t.appendChild(s);const c=document.createElement("div");c.className="p-4 pt-0 flex-grow";const d=document.createElement("p");d.className=`${this.theme.text} text-sm mb-3 line-clamp-3`,d.textContent=e.short_description||"No description available.",c.appendChild(d);const h=document.createElement("div");h.className="grid grid-cols-2 gap-x-3 gap-y-1 text-xs mb-3";const m=(e,t)=>{const s=document.createElement("p");return s.innerHTML=`<span class="${this.theme.fadedText}">${e}:</span> <span class="${this.theme.text}">${t||"N/A"}</span>`,s};h.appendChild(m("Category",e.category_name||"Uncategorized")),h.appendChild(m("Launch Mode",e.launch_mode_display||e.launch_mode)),h.appendChild(m("Popular",e.popular?"Yes":"No")),h.appendChild(m("Enabled",e.enabled?"Yes":"No")),c.appendChild(h),t.appendChild(c);const u=document.createElement("div");u.className=`p-3 border-t ${this.theme.tableBorder} mt-auto flex justify-end`;const p=document.createElement("div");p.className="relative inline-block text-left";const g=o.A.name("chevronDown"),f=new n.$({svgPathData:g.path,svgViewBox:g.viewBox,type:"icon",size:"icon-sm",additionalClasses:`${this.theme.secondaryButtonBackground} ${this.theme.secondaryButtonText} hover:${this.theme.secondaryButtonHoverBackground}`}),v=document.createElement("div");v.className=`${this.theme.modalBackground} origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg ring-1 ${this.theme.ringColor} focus:outline-none hidden z-10`,v.setAttribute("role","menu"),v.setAttribute("aria-orientation","vertical"),v.setAttribute("aria-labelledby",`menu-button-${e.id}`),f.element.id=`menu-button-${e.id}`,f.onClick((()=>{v.classList.toggle("hidden"),v.classList.contains("hidden")||v.querySelector("button, a")?.focus()})),document.addEventListener("click",(e=>{p.contains(e.target)||v.classList.contains("hidden")||v.classList.add("hidden")}),{capture:!0,once:!1});const y=document.createElement("div");return y.className="py-1",y.setAttribute("role","none"),[{label:"Sync config & restart",actionKey:"sync_config_all",icon:"powerOff"}].forEach((t=>{const s=document.createElement("button");s.className=`w-full text-left flex items-center px-4 py-2 text-sm ${this.theme.text} hover:${this.theme.listTableHover}`,s.setAttribute("role","menuitem");const i=o.A.name(t.icon),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4 mr-2",colorClass:this.theme.fadedText});s.appendChild(n.element),s.appendChild(document.createTextNode(t.label)),s.addEventListener("click",(()=>{this.handleMcpStoreListingAction(e,t.actionKey),v.classList.add("hidden")})),y.appendChild(s)})),v.appendChild(y),f.render(p),p.appendChild(v),u.appendChild(p),t.appendChild(u),t}async handleMcpStoreListingAction(e,t){new a(`Confirm Action: ${t.replace(/_/g," ")}`,`Are you sure you want to perform this action for all instances of "${e.name}"? This could affect multiple users.`).onConfirm((async()=>{new c.y(`Performing "${t}" for ${e.name}... This may take a moment.`,"info",1e4);try{const s=`/chat/admin/mcp-control-panel/mcp-store-listings/${e.mcp_id}/${t}/`,i=await g.G.postData(s,{});i.success?new c.y(i.message||`Successfully initiated "${t}" for ${e.name}.`,"success"):new c.y(`Failed to perform "${t}" for ${e.name}: ${i.error||"Unknown error"}`,"error",1e4)}catch(s){new c.y(`Client-side error performing "${t}" for ${e.name}.`,"error")}}))}createMcpConnectionCard(e){const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} overflow-hidden shadow-sm flex flex-col h-full`,t.dataset.mcpConnectionId=e.id;const s=document.createElement("div");s.className="p-3 sm:p-4 flex-grow";const i=document.createElement("div");i.className="flex items-start justify-between mb-2 sm:mb-3";const a=document.createElement("div");a.className="flex-1 min-w-0";const o=document.createElement("h5");o.className=`font-medium text-base ${this.theme.tablePrimaryColumnText} truncate`,o.textContent=e.mcp_name,a.appendChild(o);const r=document.createElement("p");r.className=`${this.theme.fadedText} text-xs sm:text-sm truncate`,r.textContent=`(${e.connection_name})`,a.appendChild(r),i.appendChild(a),s.appendChild(i);const l=document.createElement("div");l.className="grid grid-cols-2 gap-x-4 gap-y-2 text-xs sm:text-sm mb-3";const c=(e,t,s="",i=!1)=>{const n=document.createElement("div"),a=document.createElement("span");a.className=`${this.theme.fadedText}`,a.textContent=`${e}: `;const o=document.createElement("span");return o.className=`${this.theme.text} ${s}`,i&&(o.dataset.liveStatusValue="true"),o.textContent=t||"N/A",n.appendChild(a),n.appendChild(o),n};l.appendChild(c("Port",e.port)),l.appendChild(c("Hostname",e.hostname)),l.appendChild(c("Stored status",e.stored_status));const d=c("Live status","","",!0),h=d.querySelector('[data-live-status-value="true"]');if(h)h.dataset.liveStatusId=e.id,this.updateLiveStatusBadge(h,e.live_status);else{const e=document.createElement("span");e.textContent="Status N/A",e.className="text-red-500",d.appendChild(e)}l.appendChild(d),s.appendChild(l),t.appendChild(s);const m=document.createElement("div");m.className=`p-3 sm:p-4 border-t ${this.theme.tableBorder} mt-auto flex items-center justify-end gap-2`;const u=new n.$({text:"Restart",type:"ringSecondary",size:"small",width:"auto"});u.onClick((()=>this.handleMcpConnectionAction(e,"restart"))),u.render(m);const p=new n.$({text:"Test",type:"ringSecondary",size:"small",width:"auto"});p.onClick((()=>this.handleMcpConnectionAction(e,"test"))),p.render(m);const g=new n.$({text:"View logs",type:"ringSecondary",size:"small",width:"auto"});return g.onClick((()=>this.handleMcpConnectionAction(e,"view_logs"))),g.render(m),t.appendChild(m),t}updateLiveStatusBadge(e,t){e.innerHTML="";const s=document.createElement("span");s.className="badge badge-pill text-xs px-2 py-0.5 rounded-full whitespace-nowrap inline-flex items-center gap-1";let i="help",n=t||"Checking...",a=!1;"Active"===t?(s.classList.add("bg-green-100","text-green-800","dark:bg-green-900/50","dark:text-green-300"),i="check"):t&&(t.startsWith("Error")||t.includes("Failed")||t.includes("Exception"))?(s.classList.add("bg-red-100","text-red-800","dark:bg-red-900/50","dark:text-red-300"),i="warning"):["Inactive (Empty Response)","Config Error"].includes(t)?(s.classList.add("bg-yellow-100","text-yellow-800","dark:bg-yellow-900/50","dark:text-yellow-400"),i="help"):["Restarting...","Testing..."].includes(t)||null===t||"Checking..."===t?(s.classList.add("bg-blue-100","text-blue-800","dark:bg-blue-900/50","dark:text-blue-300"),i="spinner",a=!0):(s.classList.add("bg-gray-100","text-gray-800","dark:bg-gray-700/50","dark:text-gray-300"),i="help");const l=o.A.name(i),c=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:"w-3 h-3",additionalClasses:a?"animate-spin":""}),d=document.createElement("span");d.textContent=n,s.appendChild(c.element),s.appendChild(d),e.appendChild(s)}handleMcpConnectionAction(e,t){switch(t){case"restart":this.restartMcpConnection(e);break;case"test":this.testMcpConnection(e);break;case"view_logs":this.viewMcpLogs(e);break;default:new c.y(`Action "${t}" is not yet implemented.`,"warning")}}async testMcpConnection(e){const t=this.contentEl?.querySelector(`[data-mcp-connection-id="${e.id}"]`),s=t?.querySelector('[data-live-status-value="true"]');s&&this.updateLiveStatusBadge(s,"Testing...");try{const t=await g.G.postData(`/chat/admin/mcp-control-panel/test/${e.id}/`),i=this.currentUserMcps.find((t=>t.id===e.id));t.success?(new c.y(`Test successful: ${t.message||e.connection_name}`,"success"),i&&(i.live_status=t.live_status||"Active"),s&&this.updateLiveStatusBadge(s,t.live_status||"Active")):(new c.y(`Test failed: ${t.error||t.message||"Unknown error"}`,"error"),i&&(i.live_status=t.live_status||"Error (Test Failed)"),s&&this.updateLiveStatusBadge(s,t.live_status||"Error (Test Failed)"))}catch(t){new c.y(`Error testing ${e.connection_name}.`,"error"),s&&this.updateLiveStatusBadge(s,"Error (Test Exception)");const i=this.currentUserMcps.find((t=>t.id===e.id));i&&(i.live_status="Error (Test Exception)")}}async restartMcpConnection(e){new a("Restart MCP?",`Are you sure you want to restart "${e.connection_name}"?`).onConfirm((async()=>{const t=this.contentEl?.querySelector(`[data-mcp-connection-id="${e.id}"]`),s=t?.querySelector('[data-live-status-value="true"]');let i=null;if(t){t.querySelectorAll("button").forEach((e=>{"restart"===e.textContent.trim().toLowerCase()&&(i=e)}))}i?(i.disabled=!0,i.innerHTML=`<span class="inline-flex items-center">${o.A.svg("spinner","w-4 h-4 animate-spin mr-1")}Restarting...</span>`):new c.y(`Restarting ${e.connection_name}...`,"info"),s&&this.updateLiveStatusBadge(s,"Restarting...");const n=this.currentUserMcps.find((t=>t.id===e.id));n&&(n.live_status="Restarting...");try{const t=await g.G.postData(`/chat/admin/mcp-control-panel/restart/${e.id}/`);t.success?(new c.y(`Restart signal sent for ${e.connection_name}.`,"success"),setTimeout((()=>this.pollUserMcpConnectionStatuses()),4e3)):(new c.y(`Failed to restart: ${t.error||"Unknown error"}`,"error"),n&&(n.live_status="Error (restart failed)"),s&&this.updateLiveStatusBadge(s,"Error (restart failed)"))}catch(t){new c.y(`Error restarting ${e.connection_name}.`,"error"),n&&(n.live_status="Error (restart exception)"),s&&this.updateLiveStatusBadge(s,"Error (Restart Exception)")}finally{i&&(i.disabled=!1,i.innerHTML="Restart")}}))}async viewMcpLogs(e){const t=document.createElement("div");t.className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 p-2 sm:p-4",t.addEventListener("click",(e=>{e.target===t&&t.remove()}));const s=document.createElement("div");s.className=`${this.theme.modalBackground} rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col`;const i=document.createElement("div");i.className=`flex justify-between items-center p-4 border-b ${this.theme.tableBorder} flex-shrink-0`;const a=document.createElement("h3");a.className=`text-lg font-medium ${this.theme.text} truncate`,a.textContent=`Diagnostic info: ${e.connection_name}`;const l=document.createElement("span");l.className=`text-xs ${this.theme.fadedText} ml-2 truncate`,l.textContent=`(${e.mcp_name} on ${e.hostname||"N/A"})`,a.appendChild(l);const d=o.A.name("tabClose"),h=new n.$({svgPathData:d.path,svgViewBox:d.viewBox,type:"icon",size:"icon",iconHeightAndWidth:"w-5 h-5"});h.onClick((()=>t.remove())),i.appendChild(a),i.appendChild(h.element),s.appendChild(i);const m=document.createElement("div");m.className="overflow-y-auto p-4 space-y-6 flex-grow";const u=(e,t,s=!1,i=null)=>{const n=document.createElement("div");n.className=`border ${this.theme.tableBorder} rounded-md`,i&&(n.id=i);const a=document.createElement("button");a.className=`w-full flex justify-between items-center p-3 ${this.theme.secondaryBackground} hover:${this.theme.listTableHover} transition-colors duration-150 rounded-t-md`,a.setAttribute("aria-expanded",s.toString());const l=document.createElement("h4");l.className=`text-md font-medium ${this.theme.text}`,l.textContent=e;const c=o.A.name("chevronDown"),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-4 h-4 transform transition-transform duration-200",colorClass:this.theme.fadedText});s&&d.element.classList.add("rotate-180"),a.appendChild(l),a.appendChild(d.element);const h=document.createElement("div");return h.className="p-3 "+(s?"":"hidden"),h.appendChild(t),a.addEventListener("click",(()=>{const e=h.classList.toggle("hidden");a.setAttribute("aria-expanded",(!e).toString()),d.element.classList.toggle("rotate-180",!e)})),n.appendChild(a),n.appendChild(h),n},p=document.createElement("div");p.className=`flex items-center justify-center ${this.theme.fadedText} py-10`;const f=o.A.name("spinner"),v=new r.I({pathData:f.path,viewBox:f.viewBox,sizeClasses:"w-8 h-8 animate-spin",colorClass:this.theme.iconColor}),y=document.createElement("span");y.textContent="Fetching diagnostic info...",y.className="ml-3",p.appendChild(v.element),p.appendChild(y),m.appendChild(p);const w=document.createElement("div");w.className="space-y-3";const b=document.createElement("h5");b.className=`font-semibold ${this.theme.text}`,b.textContent="Problem Description:";const C=document.createElement("p");C.className=`${this.theme.text} text-sm whitespace-pre-wrap`,C.textContent="AI analysis pending...";const x=document.createElement("h5");x.className=`font-semibold ${this.theme.text} mt-2`,x.textContent="Suggested Fix:";const k=document.createElement("p");k.className=`${this.theme.text} text-sm whitespace-pre-wrap`,k.textContent="AI analysis pending...",w.appendChild(b),w.appendChild(C),w.appendChild(x),w.appendChild(k);const E=u(" AI diagnostics",w,!0,"ai-diagnostics-section");s.appendChild(m),t.appendChild(s),document.body.appendChild(t);try{const t=await g.G.fetchData(`/chat/admin/mcp-control-panel/logs/${e.id}/`);if(p.remove(),m.appendChild(E),t.success&&t.logs){const s=t.logs;if(s.additional_info){const e=document.createElement("div");e.className="grid grid-cols-1 sm:grid-cols-2 gap-x-4 gap-y-1 text-xs";for(const[t,i]of Object.entries(s.additional_info)){const s=document.createElement("div");s.className="truncate py-0.5";const n=document.createElement("span");n.className=`font-medium ${this.theme.fadedText}`,n.textContent=`${t.replace(/_/g," ").replace(/\b\w/g,(e=>e.toUpperCase()))}: `;const a=document.createElement("span");a.className=this.theme.text;const o="object"==typeof i&&null!==i?JSON.stringify(i):i||"N/A";if(o.length>100&&"object"!=typeof i?(a.textContent=o.substring(0,100)+"...",a.title=o):a.textContent=o,"object"==typeof i&&null!==i){const e=document.createElement("pre");e.className=`whitespace-pre-wrap break-all ${this.theme.secondaryBackground} p-1 rounded text-xs max-h-20 overflow-y-auto`,e.textContent=JSON.stringify(i,null,2),s.appendChild(n),s.appendChild(e)}else s.appendChild(n),s.appendChild(a);e.appendChild(s)}m.appendChild(u("Connection details",e,!1))}const i=document.createElement("pre");i.className=`${this.theme.secondaryBackground} ${this.theme.text} text-xs p-3 rounded-md overflow-x-auto whitespace-pre-wrap`,i.textContent=s.systemd_status||"Status not available.",m.appendChild(u("Systemd service status",i,!1));const n=document.createElement("pre");if(n.className=`${this.theme.secondaryBackground} ${this.theme.text} text-xs p-3 rounded-md overflow-x-auto whitespace-pre-wrap max-h-96`,n.textContent=Array.isArray(s.systemd_logs)?s.systemd_logs.join("\n"):s.systemd_logs||"No systemd journal logs.",m.appendChild(u("Systemd journal logs",n)),s.mcp_specific_log&&!s.mcp_specific_log.startsWith("deploy_lib")&&!s.mcp_specific_log.startsWith("Could not read")){const e=document.createElement("pre");e.className=`${this.theme.secondaryBackground} ${this.theme.text} text-xs p-3 rounded-md overflow-x-auto whitespace-pre-wrap max-h-96`,e.textContent=s.mcp_specific_log||"No specific MCP logs.",m.appendChild(u("MCP application log",e))}const a=document.createElement("pre");a.className=`${this.theme.secondaryBackground} ${this.theme.text} text-xs p-3 rounded-md overflow-x-auto whitespace-pre-wrap`,a.textContent=s.service_file_content||"Service file content not available.",m.appendChild(u("Systemd service file",a)),t.analysis_cache_key?this.pollForAiAnalysis(t.analysis_cache_key,C,k,e.id):(C.textContent="AI analysis could not be initiated.",k.textContent="N/A")}else{C.textContent=`Could not fetch logs: ${t.error||"Unknown error"}`,k.textContent="N/A";const e=document.createElement("p");e.className=`p-4 ${this.theme.text}`,e.textContent=`Failed to fetch logs: ${t.error||"Unknown error"}`,m.appendChild(e)}}catch(e){if(p.remove(),m){m.appendChild(E),C.textContent="Error fetching diagnostic data.",k.textContent="N/A";const e=document.createElement("p");e.className=`p-4 ${this.theme.text}`,e.textContent="Error fetching diagnostic information.",m.appendChild(e)}new c.y("Error fetching diagnostic information.","error")}}pollForAiAnalysis(e,t,s,i,n=12,a=5e3){if(n<=0)return t.textContent="AI analysis timed out.",void(s.textContent="N/A");g.G.fetchData(`/chat/admin/mcp-control-panel/log-analysis/${i}/?analysis_key=${e}`).then((o=>{"completed"===o.status?(t.textContent=o.problem||"No specific problem identified.",s.textContent=o.fix||"No specific fix suggested."):"pending"===o.status?(t.innerHTML=`AI analysis in progress... <span class="animate-pulse"></span> (${n-1} left)`,s.textContent="Please wait...",setTimeout((()=>this.pollForAiAnalysis(e,t,s,i,n-1,a)),a)):(t.textContent=o.problem||"AI analysis error.",s.textContent=o.fix||"N/A")})).catch((e=>{t.textContent="Error fetching AI analysis.",s.textContent="N/A"}))}toggleSidebar(e=null){const t=null!==e?e:!this.sidebarVisible;this.sidebarVisible=t,this.mobileSidebar&&this.sidebarOverlay&&(t?(this.mobileSidebar.classList.remove("-translate-x-full"),this.mobileSidebar.classList.add("translate-x-0"),this.sidebarOverlay.classList.remove("hidden")):(this.mobileSidebar.classList.remove("translate-x-0"),this.mobileSidebar.classList.add("-translate-x-full"),this.sidebarOverlay.classList.add("hidden")))}handleResize(){window.innerWidth>=768?(this.sidebarVisible&&this.mobileSidebar&&this.toggleSidebar(!1),this.sidebarEl&&this.sidebarEl.classList.remove("hidden"),this.mobileSidebar&&(this.mobileSidebar.classList.add("-translate-x-full"),this.mobileSidebar.classList.remove("translate-x-0")),this.sidebarOverlay&&this.sidebarOverlay.classList.add("hidden")):this.sidebarEl&&this.sidebarEl.classList.add("hidden")}handleKeyDown(e){if("Escape"===e.key){const t=document.body.querySelector(".fixed.inset-0.z-50");if(t&&t.contains(e.target)||t===e.target.closest(".fixed.inset-0.z-50"))return void t.remove();if(this.sidebarVisible)return void this.toggleSidebar(!1);this.close()}}show(){this.container&&(document.addEventListener("keydown",this.handleKeyDown),document.body.classList.add("overflow-hidden"),this.container.style.opacity="0",this.panelEl.style.transform="scale(0.95)",this.panelEl.style.opacity="0",this.container.style.display="flex",requestAnimationFrame((()=>{this.container.style.opacity="1",this.panelEl.style.opacity="1",this.panelEl.style.transform="scale(1)",this.container.style.transition="opacity 0.2s ease-out",this.panelEl.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out"})))}close(){this.container&&(this._stopUserMcpPolling(),document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),this.container.style.opacity="0",this.panelEl.style.opacity="0",this.panelEl.style.transform="scale(0.95)",setTimeout((()=>{document.body.classList.remove("overflow-hidden"),this.destroy()}),200))}destroy(){this._stopUserMcpPolling(),this.container?.parentNode&&this.container.parentNode.removeChild(this.container),this.container=null,this.panelEl=null,this.sidebarEl=null,this.contentEl=null,this.mobileMenuButton=null,this.mobileSidebar=null,this.sidebarOverlay=null,this.users=[],this.currentUserMcps=[],this.mcpStoreListings=[],this.mcpCategories=[],document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),document.body.classList.remove("overflow-hidden")}static create(){if(document.querySelector(".mcp-admin-panel-container"))return null;return new ce}}class de{constructor(e,t={}){this.id=`folder-selector-${Math.random().toString(36).slice(2,11)}`,this.folders=e,this.theme=i.A.theme,this.disableSettings=t.disableSettings||!1,this.openFolders=new Set(t.openFolders||[]),this.mode=t.mode||"sidepanel","modal"===this.mode?this.selectedFolderId=null:this.selectedFolderId=t.selectedFolderId||null,this.onFolderSelect=t.onFolderSelect||(()=>{}),this.onFolderToggle=t.onFolderToggle||(()=>{}),this.onDragOver=t.onDragOver||(()=>{}),this.onDragLeave=t.onDragLeave||(()=>{}),this.onDrop=t.onDrop||(()=>{}),this.onFolderDrop=t.onFolderDrop||(()=>{}),this.onFolderPositionChange=t.onFolderPositionChange||(()=>{}),this.dragOverFolder=null,this.dragLeaveTimer=null,this.headerText="modal"===t.mode?"Select folder:":"Folders",t.headerText,this.onFolderManage=t.onFolderManage||(()=>{}),this.onFolderUpdate=t.onFolderUpdate||(()=>{}),this.onFolderCreate=t.onFolderCreate||(()=>{}),this.onFolderRename=t.onFolderRename||(()=>{}),this.onFolderDelete=t.onFolderDelete||(()=>{}),this.onFolderMove=t.onFolderMove||(()=>{}),this.editMode=!1,this.headerDragCounter=0}render(e){this.container=e,this.container.innerHTML="";const t=this.createHeader(),s=this.createFolderStructure(this.folders);this.container.appendChild(t),this.container.appendChild(s),requestAnimationFrame((()=>{this.updateHeaderIcon()}))}handleHeaderDragEnter(e){e.preventDefault(),this.headerDragCounter++,this.updateHeaderStyle()}handleHeaderDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}handleHeaderDragLeave(e){e.preventDefault(),this.headerDragCounter--,this.updateHeaderStyle()}handleHeaderDrop(e){e.preventDefault(),this.resetHeaderStyle();const t=JSON.parse(e.dataTransfer.getData("application/json"));"folder"===t.type&&this.moveFolderToRoot(t.id)}updateHeaderStyle(){const e=document.getElementById(`${this.id}-header`);this.headerDragCounter>0?e.classList.add("border-b-4","border-blue-500"):e.classList.remove("border-b-4","border-blue-500")}resetHeaderStyle(){const e=document.getElementById(`${this.id}-header`);e&&e.classList.remove("border-b-4","border-blue-500"),this.headerDragCounter=0}getFolderNameById(e){const t=s=>{for(const i of s){if(i.id===e)return i.name;if(i.subfolders){const e=t(i.subfolders);if(e)return e}}return null};return t(this.folders)}moveFolderToRoot(e){const t=this.findFolderById(e);if(!t||null===t.parentId)return;const{folder:s,parentId:i}=t,n=this.findFolderById(i).folder;n.subfolders=n.subfolders.filter((t=>t.id!==e)),0===n.subfolders.length&&(this.openFolders.delete(i),this.updateFolderState(i,!1)),this.folders.unshift(s),this.onFolderPositionChange({action:"moveToRoot",folderId:e,newParentId:null}),this.render(this.container)}createHeader(){const e=document.createElement("div");e.classList.add("folder-header","flex","justify-between","items-center","py-1"),e.id=`${this.id}-header`;const t=document.createElement("div");t.textContent=this.headerText,t.classList.add("text-sm","font-semibold","select-none"),t.id=`${this.id}-header-title`;const s=document.createElement("div");return s.id=`${this.id}-header-icon`,s.classList.add("select-none"),e.appendChild(t),e.appendChild(s),this.editMode&&(e.addEventListener("dragenter",this.handleHeaderDragEnter.bind(this)),e.addEventListener("dragover",this.handleHeaderDragOver.bind(this)),e.addEventListener("dragleave",this.handleHeaderDragLeave.bind(this)),e.addEventListener("drop",this.handleHeaderDrop.bind(this))),e}updateHeaderIcon(){const e=document.getElementById(`${this.id}-header-icon`);if(!e)return;e.innerHTML="";let t={type:"focus",size:"small"},s=null,i=null;if(0===this.folders.length?(s="plus",i=()=>{this.editMode=!0,this.onFolderManage(this.editMode),this.addNewFolder()}):this.editMode?(s="check",t.text="Done",i=()=>{this.exitEditMode()}):this.disableSettings||(s="cog",t.iconHeightAndWidth="w-6 h-6",i=()=>{this.handleCogClick()}),s){const e=o.A.name(s);e&&e.path&&(t.svgPathData=e.path,t.svgViewBox=e.viewBox)}else if(!t.text&&this.folders.length>0&&this.disableSettings)return;if(t.svgPathData||t.text){const s=new n.$(t);i&&s.onClick(i),s.render(e)}}handleHeaderIconClick(){0===this.folders.length?(this.editMode=!0,this.onFolderManage(this.editMode),this.addNewFolder()):(this.editMode=!this.editMode,this.onFolderManage(this.editMode),this.render(this.container))}addNewFolder(){const e=`temp-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,t={id:e,name:"New folder",subfolders:[],isEditing:!0,isTemp:!0};this.folders.push(t),this.render(this.container),setTimeout((()=>{const t=document.getElementById(`${this.id}-folder-input-${e}`);t&&(t.focus(),t.select())}),0)}handleHeaderDragLeave(e){if(!this.rootDraggedOver)return;this.rootDraggedOver=!1;const t=document.getElementById(`${this.id}-header`),s=document.getElementById(`${this.id}-header-title`);t.classList.remove("border-2","border-dotted","border-gray-400"),s.textContent=this.headerText}exitEditMode(){this.editMode&&(this.editMode=!1,this.onFolderManage(this.editMode),this.updateHeaderIcon(),this.render(this.container))}handleCogClick(){this.editMode=!this.editMode,this.onFolderManage(this.editMode),this.render(this.container)}createFolderStructure(e,t=0){const s=document.createElement("div");s.classList.add("folder-structure","select-none"),e.forEach(((e,i)=>{const n=this.createFolderItem(e,t,i);if(s.appendChild(n),e.subfolders&&e.subfolders.length>0){const i=this.createFolderStructure(e.subfolders,t+1);i.id=`${this.id}-subfolders-${e.id}`,i.style.display=this.openFolders.has(e.id)?"block":"none",s.appendChild(i)}}));const i=()=>{const e=this.createAddFolderButton();s.appendChild(e)};return(this.editMode&&0===t&&this.folders.length>0||"modal"===this.mode&&0===t)&&i(),s}handleReorderDragOver(e,t,s){e.preventDefault(),e.dataTransfer.dropEffect="move";e.currentTarget.classList.add("highlight")}handleReorderDrop(e,t,s){e.preventDefault();const i=JSON.parse(e.dataTransfer.getData("application/json")),n=i.id;i.parentId,i.index;if(n===t)return;if(this.isDescendant(n,t))return;const a=this.findFolderById(t).parentId,o=a?this.findFolderById(a).folder:{subfolders:this.folders};if(!o.subfolders)return;let r=o.subfolders.findIndex((e=>e.id===t));if(-1===r)return;"after"===s&&(r+=1);const[l]=this.removeFolderById(n);l&&(o.subfolders.splice(r,0,l),this.onFolderUpdate({action:"reorder",sourceId:n,targetId:t,position:s}),this.render(this.container))}removeFolderById(e,t=this.folders){for(let s=0;s<t.length;s++){if(t[s].id===e)return[t.splice(s,1)[0],t];if(t[s].subfolders){const i=this.removeFolderById(e,t[s].subfolders);if(i)return i}}return[null,null]}createFolderItem(e,t,s){const i=document.createElement("div");i.id=`${this.id}-folder-${e.id}`,i.dataset.folderId=e.id,i.classList.add("folder-item","flex","items-center","gap-1","cursor-pointer","py-1","transition","duration-200","ease-in-out","folder-drop-zone"),i.style.paddingLeft=16*t+"px",this.editMode&&(i.draggable=!0,i.addEventListener("dragstart",(t=>this.handleDragStart(t,e.id))),i.addEventListener("dragover",(t=>this.handleDragOver(t,e.id))),i.addEventListener("drop",(t=>this.handleFolderDrop(t,e.id))),i.addEventListener("dragend",(()=>this.handleDragEnd())));const n=document.createElement("button");n.id=`${this.id}-chevron-${e.id}`,n.classList.add("chevron-button","flex","items-center","justify-center","w-4","h-4","flex-shrink-0");const a=document.createElement("div");a.classList.add("chevron-icon-wrapper");const l=this.openFolders.has(e.id)?"chevronDown":"chevronRight",c=o.A.name(l),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.fadedText});a.appendChild(d.element),n.appendChild(a),n.onclick=t=>{t.stopPropagation(),this.toggleFolder(e.id)};const h=document.createElement("div");h.classList.add("folder-icon-wrapper","w-4","h-4","flex","items-center","justify-center","flex-shrink-0");const m=this.openFolders.has(e.id)?"folderOpen":"folder",u=o.A.name(m),p=new r.I({pathData:u.path,viewBox:u.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor});if(h.appendChild(p.element),i.appendChild(n),i.appendChild(h),e.isEditing){const t=document.createElement("input");t.id=`${this.id}-folder-input-${e.id}`,t.type="text",t.value=e.name,t.classList.add("folder-name-input","w-full","bg-transparent","border-none","focus:outline-none","rounded-sm","py-0.5","px-1","max-w-[126px]","text-sm");let s=!1;const n=()=>{s||(s=!0,this.saveFolderName(e))};t.addEventListener("blur",n),t.addEventListener("keydown",(t=>{"Enter"===t.key?(t.preventDefault(),n()):"Escape"===t.key&&this.cancelFolderCreation(e)})),i.appendChild(t)}else{const t=document.createElement("button");t.id=`${this.id}-folder-button-${e.id}`,t.classList.add("folder-text-button","truncate","text-left","flex-grow","text-sm"),t.textContent=e.name,t.ondblclick=t=>{t.stopPropagation(),this.editFolderName(e)},t.onclick=t=>{t.stopPropagation(),this.selectFolder(e.id)},i.appendChild(t)}if(this.selectedFolderId===e.id&&i.classList.add("font-bold"),this.editMode&&!e.isTemp){const t=document.createElement("button");t.classList.add("text-xs",this.theme.fadedText,"ml-auto","flex","items-center","justify-center","w-4","h-4","flex-shrink-0");const s=o.A.name("trash"),n=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.fadedText});t.appendChild(n.element),t.onclick=t=>{t.stopPropagation(),this.deleteFolder(e.id)},i.appendChild(t)}return"modal"!==this.mode&&(i.addEventListener("dragover",(t=>this.handleFolderDragOver(t,e.id))),i.addEventListener("dragleave",(t=>this.handleFolderDragLeave(t,e.id))),i.addEventListener("drop",(t=>this.handleFolderDrop(t,e.id)))),i}getFolderLevel(e){let t=0;const s=(e,i)=>{for(const n of e){if(n.id===i)return!0;if(n.subfolders){if(t++,s(n.subfolders,i))return!0;t--}}return!1};return s(this.folders,e.id),t}createAddFolderButton(){const e=document.createElement("div");e.classList="py-2 select-none";const t=o.A.name("plus"),s=new n.$({text:"New folder",svgPathData:t.path,svgViewBox:t.viewBox,size:"small",type:"focus",width:"auto"});return s.onClick((()=>this.addNewFolder())),s.render(e),e}toggleFolder(e){const t=document.getElementById(`${this.id}-folder-${e}`);if(!t)return;const s=t.querySelector(".chevron-icon-wrapper"),i=t.querySelector(".folder-icon-wrapper"),n=document.getElementById(`${this.id}-subfolders-${e}`);if(!s||!i)return;let a,l;this.openFolders.has(e)?(this.openFolders.delete(e),a="chevronRight",l="folder",n&&(n.style.display="none")):(this.openFolders.add(e),a="chevronDown",l="folderOpen",n&&(n.style.display="block")),s.innerHTML="";const c=o.A.name(a),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.fadedText});s.appendChild(d.element),i.innerHTML="";const h=o.A.name(l),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor});i.appendChild(m.element),this.onFolderToggle(e,this.openFolders.has(e))}selectFolder(e){if(this.editMode&&"modal"===this.mode&&this.exitEditMode(),this.onFolderSelect(e),this.selectedFolderId===e)return;if(this.selectedFolderId){const e=document.getElementById(`${this.id}-folder-${this.selectedFolderId}`);e&&e.classList.remove("font-bold")}this.selectedFolderId=e;const t=document.getElementById(`${this.id}-folder-${e}`);t&&t.classList.add("font-bold"),this.showFolderChildren(e)}showFolderChildren(e){const t=e=>{e.subfolders&&e.subfolders.length>0&&(this.openFolders.has(e.id)||this.toggleFolder(e.id),e.subfolders.forEach((e=>t(e))))},s=this.findFolderById(e);s&&s.folder&&t(s.folder)}handleFolderDragOver(e,t){if(e.preventDefault(),e.dataTransfer.dropEffect="move",this.dragLeaveTimer&&(clearTimeout(this.dragLeaveTimer),this.dragLeaveTimer=null),this.dragOverFolder===t)return;this.dragOverFolder&&this.resetFolderState(this.dragOverFolder),this.resetHeaderStyle(),this.dragOverFolder=t;const s=document.getElementById(`${this.id}-folder-${t}`);if(s){s.classList.add(this.theme.secondaryBackground);const e=s.querySelector(".folder-icon-wrapper");if(e){e.innerHTML="";const t=o.A.name("folderOpen"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor});e.appendChild(s.element)}}this.onDragOver(t)}handleFolderDragLeave(e,t){this.dragLeaveTimer=setTimeout((()=>{this.dragOverFolder===t&&(this.resetFolderState(t),this.dragOverFolder=null,this.onDragLeave(t))}),50)}handleFolderDragLeave(e,t){this.dragLeaveTimer=setTimeout((()=>{this.dragOverFolder===t&&(this.resetFolderState(t),this.dragOverFolder=null,this.onDragLeave(t))}),50)}handleFolderDrop(e,t){let s;e.preventDefault(),this.resetFolderState(t),this.resetHeaderStyle(),this.dragOverFolder=null;try{s=JSON.parse(e.dataTransfer.getData("application/json"))}catch(e){return}if("folder"===s.type){const e=s.id,i=s.parentId;if(e===t)return void this.moveFolderToRoot(e);if(this.isDescendant(e,t))return;const n=t===i;n?this.reorderFolder(i,e,t):this.moveFolder(e,t),this.onFolderPositionChange({action:n?"reorder":"move",folderId:e,newParentId:n?i:t,targetFolderId:n?t:void 0}),this.render(this.container)}else"record"===s.type&&this.onFolderDrop&&this.onFolderDrop(s.id,t)}isDescendant(e,t){const s=(e,t)=>{for(const i of e){if(i.id===t)return i;if(i.subfolders){const e=s(i.subfolders,t);if(e)return e}}return null},i=s(this.folders,t);if(!i)return!1;const n=t=>{for(const s of t){if(s.id===e)return!0;if(s.subfolders&&n(s.subfolders))return!0}return!1};return i.subfolders&&n(i.subfolders)}moveFolder(e,t){let s=null,i=null;const n=(t,a=null)=>{for(let o=0;o<t.length;o++){if(t[o].id===e)return s=t.splice(o,1)[0],i=a,!0;if(t[o].subfolders&&n(t[o].subfolders,t[o].id))return!0}return!1};if(n(this.folders),s){const n=e=>{for(const i of e){if(i.id===t)return i.subfolders||(i.subfolders=[]),i.subfolders.push(s),!0;if(i.subfolders&&n(i.subfolders))return!0}return!1};if(n(this.folders)||(this.folders.push(s),s=null),i){const e=this.findFolderById(i);!e||e.folder.subfolders&&0!==e.folder.subfolders.length||(this.openFolders.delete(i),this.updateFolderState(i,!1))}this.onFolderPositionChange({action:"move",folderId:e,newParentId:t})}return s}updateFolderState(e,t){const s=document.getElementById(`${this.id}-folder-${e}`);if(!s)return;const i=s.querySelector(".chevron-icon-wrapper"),n=s.querySelector(".folder-icon-wrapper");if(!i||!n)return;const a=t?"chevronDown":"chevronRight",l=t?"folderOpen":"folder";i.innerHTML="";const c=o.A.name(a),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.fadedText});i.appendChild(d.element),n.innerHTML="";const h=o.A.name(l),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor});n.appendChild(m.element);const u=document.getElementById(`${this.id}-subfolders-${e}`);u&&(u.style.display=t?"block":"none")}reorderFolder(e,t,s){let i=-1,n=-1;const a=e?this.findFolderById(e).folder:{subfolders:this.folders};if(!a.subfolders)return;if(a.subfolders.forEach(((e,a)=>{e.id===t&&(i=a),e.id===s&&(n=a)})),-1===i||-1===n)return;const[o]=a.subfolders.splice(i,1);a.subfolders.splice(n,0,o),this.onFolderPositionChange({action:"reorder",folderId:t,newParentId:e,targetFolderId:s})}resetFolderState(e){const t=document.getElementById(`${this.id}-folder-${e}`);if(t){t.classList.remove(this.theme.secondaryBackground);const e=t.querySelector(".fa-folder-open");e&&e.classList.replace("fa-folder-open","fa-folder")}}cancelFolderCreation(e){e.isTemp?this.folders=this.folders.filter((t=>t.id!==e.id)):e.isEditing=!1,this.render(this.container)}saveFolderName(e){const t=document.getElementById(`${this.id}-folder-input-${e.id}`);if(!t)return;const s=t.value.trim();""!==s?(e.name=s,e.isEditing=!1,e.isTemp?(delete e.isTemp,this.onFolderCreate(e).then((t=>{const s=this.folders.findIndex((t=>t.id===e.id));-1!==s&&(this.folders[s]=t,this.openFolders.has(e.id)&&(this.openFolders.delete(e.id),this.openFolders.add(t.id)),this.selectedFolderId===e.id&&(this.selectedFolderId=t.id)),this.render(this.container)})).catch((t=>{this.folders=this.folders.filter((t=>t.id!==e.id)),this.render(this.container)}))):this.onFolderRename(e.id,s).then((()=>{this.render(this.container)})).catch((e=>{this.render(this.container)}))):this.cancelFolderCreation(e)}editFolderName(e,t=!1){const s=document.getElementById(`${this.id}-folder-button-${e.id}`);if(!s)return;const i=document.createElement("input");i.type="text",i.value=e.name,i.classList.add("folder-name-input","w-full","bg-transparent","border-none","focus:outline-none","rounded-sm","py-0.5","px-1","max-w-[126px]","text-sm");let n=!1;const a=()=>{if(n)return;n=!0;const s=i.value.trim();s&&s!==e.name&&(e.name=s,this.onFolderRename(e)),t&&this.exitEditMode(),this.render(this.container)};i.onblur=a,i.onkeydown=e=>{"Enter"===e.key&&(e.preventDefault(),a())},s.replaceWith(i),i.focus(),i.select()}deleteFolder(e){new a("Delete folder?","Are you sure you want to delete this folder?").onConfirm((()=>{const t=(s,i=null)=>{for(let n=0;n<s.length;n++){if(s[n].id===e)return s.splice(n,1),i&&0===i.subfolders.length&&this.openFolders.delete(i.id),!0;if(s[n].subfolders&&t(s[n].subfolders,s[n]))return!0}return!1};t(this.folders)&&(this.onFolderDelete(e),0===this.folders.length&&this.exitEditMode(),this.render(this.container))}))}clearSelectedFolder(){if(this.selectedFolderId){const e=document.getElementById(`${this.id}-folder-${this.selectedFolderId}`);e&&e.classList.remove("font-bold"),this.selectedFolderId=null}}createFolderDragImage(e){const t=document.createElement("div");t.classList=`${this.theme.background} border ${this.theme.inputBorder} rounded-md shadow-lg absolute z-50 pointer-events-none p-2`,t.style.width="160px",t.style.left="-1000px",t.style.top="-1000px",t.style.opacity="0.8";const s=document.createElement("div");s.classList="flex items-center gap-2";const i=document.createElement("div");i.classList="flex-shrink-0";const n=o.A.name("folder"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor||this.theme.iconColor});i.appendChild(a.element),s.appendChild(i);const l=document.createElement("div");return l.classList=`${this.theme.fadedText} text-sm truncate`,l.textContent=e.name,s.appendChild(l),t.appendChild(s),t}handleDragStart(e,t){const s=this.findFolderById(t);if(!s)return;e.dataTransfer.setData("application/json",JSON.stringify({id:t,type:"folder",parentId:s.parentId,index:s.index})),e.dataTransfer.effectAllowed="move";const i=this.createFolderDragImage(s.folder);document.body.appendChild(i),i.offsetHeight;const n=i.getBoundingClientRect();e.dataTransfer.setDragImage(i,n.width/2,n.height/2)}findFolderById(e,t=this.folders,s=null){for(let i=0;i<t.length;i++){const n=t[i];if(n.id===e)return{folder:n,parentId:s,index:i};if(n.subfolders){const t=this.findFolderById(e,n.subfolders,n.id);if(t)return t}}return null}handleDragOver(e,t){e.preventDefault(),e.dataTransfer.dropEffect="move";const s=document.getElementById(`${this.id}-folder-${t}`);s&&s.classList.add(this.theme.secondaryBackground,"rounded-md")}handleFolderDrop(e,t){let s;e.preventDefault(),this.resetFolderState(t),this.resetHeaderStyle(),this.dragOverFolder=null;try{s=JSON.parse(e.dataTransfer.getData("application/json"))}catch(e){return}if(this.editMode){if("folder"!==s.type)return;const e=s.id,i=s.parentId;if(e===t)return void this.moveFolderToRoot(e);if(this.isDescendant(e,t))return;const n=t===i;if(n)this.reorderFolder(i,e,t);else{if(!this.moveFolder(e,t))return;if(i){const e=this.findFolderById(i);!e||e.folder.subfolders&&0!==e.folder.subfolders.length||(this.openFolders.delete(i),this.updateFolderState(i,!1))}}this.onFolderUpdate({action:n?"reorder":"move",sourceId:e,targetId:t}),this.render(this.container)}else{if("record"!==s.type)return;this.onFolderDrop&&this.onFolderDrop(s.id,t)}}handleDragEnd(){document.querySelectorAll(".folder-item").forEach((e=>{e.classList.remove(this.theme.secondaryBackground)}))}}class he{constructor(e,t){this.triggerElement=e,this.callbacks=t,this.theme=i.A.theme,this.menuContainer=null,this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),this._boundHandleKeyDown=this._handleKeyDown.bind(this),this.init()}init(){this.removeExisting(),this.menuContainer=document.createElement("div"),this.menuContainer.className=`actions-context-menu absolute ${this.theme.tableMenuBackground} ${this.theme.shadow} rounded-lg z-50 text-sm min-w-[180px] flex flex-col overflow-hidden py-1`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transform="scale(0.95)",this.menuContainer.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out",this.menuContainer.setAttribute("role","menu"),this._renderMenuItems(),document.body.appendChild(this.menuContainer),this._positionMenu(),requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.visibility="visible",this.menuContainer.style.opacity="1",this.menuContainer.style.transform="scale(1)")})),this._addEventListeners()}_renderMenuItems(){this.menuContainer&&(this._addMenuItem("New tab","plus",this.callbacks.onNewTab),this._addMenuItem("Close all tabs","tabClose",this.callbacks.onCloseAllTabs))}_addMenuItem(e,t,s,i){if(!this.menuContainer)return;const n=document.createElement("button"),a=i||this.theme.text;n.className=`w-full text-left px-3 py-1.5 ${this.theme.tableMenuButtonHover} flex items-center gap-3`,n.setAttribute("role","menuitem");const l=o.A.name(t);if(l){const e=document.createElement("div");e.className="w-4 h-4 flex-shrink-0 flex items-center justify-center";const t=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:"w-3.5 h-3.5",additionalClasses:a});e.appendChild(t.element),n.appendChild(e)}const c=document.createElement("span");c.className=`${a} text-sm`,c.textContent=e,n.appendChild(c),n.addEventListener("click",(e=>{e.stopPropagation(),s&&s(),this.remove()})),this.menuContainer.appendChild(n)}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect();this.menuContainer.style.visibility="hidden",document.body.appendChild(this.menuContainer);const t=this.menuContainer.getBoundingClientRect();let s=e.bottom+4,i=e.left;i+t.width>window.innerWidth-8&&(i=e.right-t.width),i<8&&(i=8),s+t.height>window.innerHeight-8&&(s=e.top-t.height-4),s<8&&(s=8),this.menuContainer.style.top=`${s+window.scrollY}px`,this.menuContainer.style.left=`${i+window.scrollX}px`}_addEventListeners(){document.addEventListener("click",this._boundHandleOutsideClick,!0),this.menuContainer&&this.menuContainer.addEventListener("keydown",this._boundHandleKeyDown)}_removeEventListeners(){document.removeEventListener("click",this._boundHandleOutsideClick,!0),this.menuContainer&&this.menuContainer.removeEventListener("keydown",this._boundHandleKeyDown)}_handleOutsideClick(e){!this.menuContainer||this.menuContainer.contains(e.target)||e.target===this.triggerElement||this.triggerElement.contains(e.target)||this.remove()}_handleKeyDown(e){this.menuContainer&&"Escape"===e.key&&(e.preventDefault(),this.remove())}removeExisting(){document.querySelectorAll(".actions-context-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(){this._removeEventListeners();const e=this.menuContainer;if(this.menuContainer=null,e){e.style.opacity="0",e.style.transform="scale(0.95)";const t=setTimeout((()=>{e.parentNode&&e.remove()}),150);e.addEventListener("transitionend",(s=>{"opacity"===s.propertyName&&e.parentNode&&(clearTimeout(t),e.remove())}),{once:!0})}}}class me{static instance=null;static getInstance(){return me.instance||(me.instance=new me,me.instance.connect()),me.instance}constructor(){this.listeners={},this.messageQueue=[],this.wsUri=null,this.ws=null,this.isConnected=!1,this.shouldReconnect=!0,this.isReconnecting=!1,this.reconnectAttempts=0,this.reconnectTimer=null,this.maxReconnectDelay=15e3,this.baseReconnectDelay=1e3,this.heartbeatInterval=null,this.pingTimeout=null,this.triedAlternate=!1,this.handleOnline=this.forceReconnect.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this)}connect(){if(this.wsUri)return;let e;e=window.ws_base&&/^(ws|wss):\/\//i.test(window.ws_base)?window.ws_base:"https:"===location.protocol?`wss://${location.host}/ws/`:`ws://${location.host}/ws/`;const t=e.endsWith("/")?e:`${e}/`,s=window.workspace&&window.workspace.slug?window.workspace.slug:"personal";this.wsUri=`${t}tabs/?ws=${encodeURIComponent(s)}`,this.createWebSocket(),this.addBrowserEventListeners()}createWebSocket(){try{if(!this.wsUri||"string"!=typeof this.wsUri)throw new Error(`[TabsWS] Invalid wsUri: ${String(this.wsUri)}`);if(this.ws&&(this.ws.readyState===WebSocket.OPEN||this.ws.readyState===WebSocket.CONNECTING))return;this.ws=new WebSocket(this.wsUri),this.ws.binaryType="arraybuffer",this.ws.onopen=e=>this.onOpen(e),this.ws.onclose=e=>this.onClose(e),this.ws.onmessage=e=>this.onMessage(e),this.ws.onerror=e=>this.onError(e)}catch(e){this.scheduleReconnect()}}onOpen(){this.isConnected=!0,this.reconnectAttempts=0,this.isReconnecting=!1,clearTimeout(this.reconnectTimer),this.startHeartbeat(),this.flushMessageQueue()}onClose(e){this.isConnected=!1,this.stopHeartbeat(),this.shouldReconnect&&this.scheduleReconnect()}onError(e){}scheduleReconnect(){if(!this.shouldReconnect||this.isReconnecting)return;this.isReconnecting=!0;const e=Math.min(this.baseReconnectDelay*Math.pow(1.5,this.reconnectAttempts),this.maxReconnectDelay),t=e+.1*e*Math.random();this.reconnectTimer=setTimeout((()=>{this.isReconnecting=!1,this.shouldReconnect&&(this.reconnectAttempts++,this.createWebSocket())}),t)}forceReconnect(){this.isConnected||this.isReconnecting||(clearTimeout(this.reconnectTimer),this.isReconnecting=!1,this.reconnectAttempts=0,this.scheduleReconnect())}startHeartbeat(){this.stopHeartbeat(),this.heartbeatInterval=setInterval((()=>{this.isConnected&&this.ws.readyState===WebSocket.OPEN&&(this.pingTimeout=setTimeout((()=>{try{this.ws.close()}catch(e){}}),5e3),this.send({ws_msg_type:"ping"}))}),25e3)}stopHeartbeat(){clearInterval(this.heartbeatInterval),clearTimeout(this.pingTimeout),this.heartbeatInterval=null,this.pingTimeout=null}flushMessageQueue(){for(;this.messageQueue.length>0;){const e=this.messageQueue.shift();this.send(e,!0)}}send(e,t=!1){this.isConnected&&this.ws?.readyState===WebSocket.OPEN?this.ws.send(JSON.stringify({text_data:e})):t||this.messageQueue.push(e)}onMessage(e){try{const t=JSON.parse(e.data);if("pong"===t.ws_msg_type)return void clearTimeout(this.pingTimeout);const s=t.ws_msg_type;s&&this.listeners[s]&&this.listeners[s].forEach((e=>e(t)))}catch(e){}}close(){if(this.shouldReconnect=!1,this.stopHeartbeat(),clearTimeout(this.reconnectTimer),this.removeBrowserEventListeners(),this.ws)try{this.ws.close()}catch(e){}me.instance=null}addBrowserEventListeners(){window.addEventListener("online",this.handleOnline),document.addEventListener("visibilitychange",this.handleVisibilityChange)}removeBrowserEventListeners(){window.removeEventListener("online",this.handleOnline),document.removeEventListener("visibilitychange",this.handleVisibilityChange)}handleVisibilityChange(){"visible"===document.visibilityState&&this.forceReconnect()}registerMsgListener(e,t){this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e)}}class ue{constructor(e,t){this.userId=e,this.instanceId=t,this.onStateHandler=null,this.bc=null,this.ws=null,this._retry=0,this._init()}static getInstanceId(){const e="tabs_sync_instance_id";let t=localStorage.getItem(e);return t||(t=crypto.randomUUID(),localStorage.setItem(e,t)),t}static resolveUserId(){return window?.User?.user?.id||window?.User?.id||window.current_user_id||null}onState(e){this.onStateHandler=e}_init(){try{this.bc=new BroadcastChannel("session-tabs"),this.bc.onmessage=e=>{const t=e.data;t&&"tabs.state"===t.type&&t.origin_id!==this.instanceId&&this.onStateHandler&&this.onStateHandler(t.state,{origin:"broadcast"})}}catch(e){}this.ws=me.getInstance(),this.ws&&(this.ws.registerMsgListener((e=>{e&&e.origin_id!==this.instanceId&&this.onStateHandler&&this.onStateHandler(e.state,{origin:"ws"})}),"tabs.state"),this.ws.send({ws_msg_type:"tabs.request_sync",origin_id:this.instanceId}))}broadcastState(e){const t={type:"tabs.state",origin_id:this.instanceId,state:e};this.bc&&this.bc.postMessage(t),this.ws&&this.ws.send({ws_msg_type:"tabs.state",origin_id:this.instanceId,state:e})}}class pe{constructor(){this.tabs=[],this.specialTabs=[{id:"history",title:"History",icon:o.A.name("menuHistory").path,route:"/chat/history"},{id:"assistants",title:"Assistants",icon:o.A.name("menuAssistants").path,route:"/chat/assistants",permission:"assistants:crud"}],this.activeTabId=null,this.activeSpecialTabId=null,this.element=null,this.tabsScrollContainer=null,this.tabsInnerContainer=null,this.actionsContainer=null,this.sortableInstance=null,this.theme=i.A.theme,this.isTouchDevice="ontouchstart"in window||navigator.maxTouchPoints>0,this.workspaces=[],this.getWorkspaces(),window.talkWidgetShowing=!1,this.saveSessionState=this.saveSessionState.bind(this),this.debouncedSave=this.debounce(this.saveSessionState,750),this.isSmoothScrolling=!1,this.nextSmoothScrollTarget=null,this.scrollEndTimeout=null,this.SMOOTH_SCROLL_DURATION=400,this._applyingRemote=!1,this.instanceId=ue.getInstanceId(),this.sync=new ue(this.instanceId),this.sync.onState((e=>this.applyRemoteState(e)))}_onScrollEnd(){this.isSmoothScrolling&&this._finalizeSmoothScroll()}_finalizeSmoothScroll(){if(this.scrollEndTimeout&&(clearTimeout(this.scrollEndTimeout),this.scrollEndTimeout=null),this.isSmoothScrolling&&(this.isSmoothScrolling=!1,this.nextSmoothScrollTarget)){const{tabId:e,behavior:t,offset:s}=this.nextSmoothScrollTarget;this.nextSmoothScrollTarget=null,this.scrollToActiveTab(t,s,e)}}applyRemoteState(e){try{if(!e||"object"!=typeof e)return;const t=window.session_tab_state?.version||0;if((e.version||0)<=t)return;const s=0===this.tabs.length&&null==this.activeTabId&&null==this.activeSpecialTabId;if(this._applyingRemote=!0,s)window.session_tab_state=e;else{const t={...e,active_chat_id:this.activeTabId,active_special_tab_id:this.activeSpecialTabId};window.session_tab_state=t}this.loadTabsFromState()}finally{this._applyingRemote=!1}}sortTabs(){this.tabs.sort(((e,t)=>e.isPinned&&!t.isPinned?-1:!e.isPinned&&t.isPinned?1:0))}debounce(e,t){let s;return function(...i){clearTimeout(s),s=setTimeout((()=>{clearTimeout(s),e.apply(this,i)}),t)}}async getWorkspaces(){this.workspaces=await y.a.getWorkspaces()}loadInitialState(){let e=window.session_tab_state||{};"object"==typeof e&&null!==e&&"open_chat_ids"in e&&!("open_tabs_info"in e)&&(e={},window.session_tab_state=e),this.tabs=[],this.activeTabId=null,this.activeSpecialTabId=null;let t=e.open_tabs_info||[];const s=e.active_chat_id||null,i=e.active_special_tab_id||null;return t.filter((e=>e.id&&e.id.startsWith("placeholder-"))).map((e=>e.id)).length>0?(t=t.filter((e=>!(e.id&&e.id.startsWith("placeholder-")))),s&&s.startsWith("placeholder-")?this.activeTabId=null:this.activeTabId=s):this.activeTabId=s,this.activeSpecialTabId=i,t.forEach((e=>{this.tabs.push({id:e.id,title:e.title||"New session",active:e.id===this.activeTabId,assistantImage:e.assistantImage||null,hasNotification:!!e.hasNotification,isWorking:!1,isPinned:!!e.isPinned,isPlaceholder:!1})})),this.sortTabs(),this.activeTabId&&!this.tabs.some((e=>e.id===this.activeTabId))&&(this.activeTabId=null),this.tabs.length>0&&!this.activeTabId&&!this.activeSpecialTabId&&(this.activeTabId=this.tabs[0].id,this.tabs[0].active=!0),{active_chat_id:this.activeTabId,active_special_tab_id:this.activeSpecialTabId}}addTab(e,t,s,i=!1){const n=ke.chatInstances[e],a=!(!n||!n.chat)&&n.chat.pinned;if(this.tabs.some((t=>t.id===e))){const n=this.tabs.find((t=>t.id===e));return n&&(n.isPlaceholder=i,n.title=t||"New session",void 0!==s&&(n.assistantImage=s)),this.updateTabTitle(e,t||"New session",s),this.activeTabId===e&&this.setActiveTab(e),n}const o={id:e,title:t||"New session",active:!1,assistantImage:s||null,justAdded:!0,hasNotification:!1,isWorking:!1,isPinned:a,isPlaceholder:i};if(a&&!i){let e=this.tabs.findIndex((e=>!e.isPinned));-1===e?this.tabs.push(o):this.tabs.splice(e,0,o)}else this.tabs.push(o);return this.renderTabs(),this.debouncedSave(),o}resolvePlaceholderTab(e,t,s,i){const n=this.tabs.find((t=>t.id===e));if(n){n.id=t,n.isPlaceholder=!1,n.title=s||n.title,void 0!==i&&(n.assistantImage=i),this.activeTabId===e&&(this.activeTabId=t),this.renderTabs(),this.debouncedSave();const a=this.tabsInnerContainer?.querySelector(`[data-id="${e}"]`);a&&(a.dataset.id=t),this.activeTabId===t&&this.scrollToActiveTab("smooth")}}setActiveTab(e){if(this._tabRemovalInProgress)return;this.activeTabId=e,this.activeSpecialTabId=null,this.tabs.forEach((t=>{t.active=t.id===e}));const t=this.tabs.find((t=>t.id===e));t&&t.hasNotification&&this.setNotificationLight(e,!1),window.taskBarInstance&&window.taskBarInstance.isOpen&&setTimeout((()=>{window.taskBarInstance.moveToContainer()}),0),this.element&&(this.renderTabs(),this.renderActions(),this.scrollToActiveTab("smooth")),this.debouncedSave()}setActiveSpecialTab(e){this.activeSpecialTabId=e,this.activeTabId=null,this.tabs.forEach((e=>{e.active=!1})),this.element&&(this.renderTabs(),this.renderActions()),this.debouncedSave()}removeTabSilently(e){const t=this.tabs.findIndex((t=>t.id===e));-1!==t&&(this.tabs.splice(t,1),this.activeTabId===e&&(this.activeTabId=this.tabs.length>0?this.tabs[0].id:null),this.renderTabs(),this.debouncedSave())}removeTab(e){return new Promise((t=>{this._tabRemovalInProgress=!0;const s=this.tabs.findIndex((t=>t.id===e));if(-1===s)return this._tabRemovalInProgress=!1,void t({removedTabId:e,newActiveTabId:this.activeTabId,wasActive:!1,tabsRemaining:this.tabs.length,error:"Tab not found"});this.tabs[s];const i=this.activeTabId===e,n=1===this.tabs.length;let a=null;i&&!n&&(a=s>0?this.tabs[s-1].id:this.tabs[1].id);const o=this.tabsInnerContainer?.querySelector(`[data-id="${e}"]`);let r=!1;const l=()=>{if(r)return;r=!0,o&&o.parentNode&&o.remove();const s=this.tabs.findIndex((t=>t.id===e));-1!==s&&this.tabs.splice(s,1);let n=this.activeTabId;if(i){if(this.tabs.length>0){const e=this.tabs.some((e=>e.id===a));n=a&&e?a:this.tabs[0].id}else n=null;this.activeTabId=n}this.activeTabId?this.tabs.forEach((e=>e.active=e.id===this.activeTabId)):this.tabs.forEach((e=>e.active=!1)),this.renderTabs(),this._tabRemovalInProgress=!1,this.debouncedSave(),t({removedTabId:e,newActiveTabId:this.activeTabId,wasActive:i,tabsRemaining:this.tabs.length})};if(o){let e;o.classList.add("tab-closing");const t=()=>{e&&clearTimeout(e),l()};o.addEventListener("animationend",t,{once:!0}),e=setTimeout((()=>{o.removeEventListener("animationend",t),l()}),250)}else l()}))}async animateTyping(e,t,s=300){if(!e)return;return e.textContent!==t?new Promise((s=>{e.classList.add("tab-title-animating"),e.classList.add("tab-title-fade-out"),setTimeout((()=>{e.textContent=t,e.classList.remove("tab-title-fade-out"),e.classList.add("tab-title-fade-in"),setTimeout((()=>{e.classList.remove("tab-title-fade-in","tab-title-animating"),s()}),150)}),150)})):void 0}async updateTabTitle(e,t,s,i=!0){const n=this.tabs.find((t=>t.id===e));if(!n||!this.tabsInnerContainer)return;const a=this.tabsInnerContainer.querySelector(`[data-id="${e}"]`),o=a?a.querySelector("span.truncate"):null;if(!a||!o)return null!=t&&""!==t&&(n.title=t),void 0!==s&&(n.assistantImage=s),void this.renderTabs();try{null!=t&&""!==t&&(n.title=t);let r=!1;if(void 0!==s&&(n.assistantImage!==s&&(r=!0),n.assistantImage=s),r)this.renderTabs();else if(null!=t&&""!==t)if(i)o.textContent=t,a.style.width="",a.style.minWidth="";else{const s=Math.max(a.offsetWidth,o.offsetWidth+40);a.style.width=`${s}px`,a.style.minWidth=`${s}px`,await this.animateTyping(o,t),setTimeout((()=>{a&&(a.style.width="",a.style.minWidth=""),e===this.activeTabId&&this.scrollToActiveTab("smooth")}),50)}}catch(e){o&&null!=t&&""!==t&&(o.textContent=t),a&&(a.style.width="",a.style.minWidth="")}}setCallbacks(e,t,s,i,n,a,o,r){this.onNewTab=e,this.onTabSwitch=t,this.onTabClose=s,this.onRename=i,this.onPin=n,this.onDelete=a,this.onShare=o,this.onRefresh=r}async showFolderSelectorForTab(e){let t;try{const e=await g.G.postData("/chat/get-folder-structure/",{});if(!e||!Array.isArray(e.folders))throw new Error("Invalid folder data from server.");t=e.folders}catch(e){return void new c.y("Could not load folders. Please try again.","error")}const s=document.createElement("div");let i;s.className=`max-h-full py-2 mt-2 px-4 ${this.theme.secondaryBackground} rounded-md`;let n=null;const a=new de(t,{mode:"modal",onFolderSelect:e=>{n=e,i&&i.enableConfirmButton()},onFolderCreate:async e=>{const t=await g.G.postData("/chat/create-chat-folder/",e);return await this.refreshFolderSelector(a),t.folder},onFolderRename:async e=>{await g.G.postData("/chat/rename-folder/",e)},onFolderDelete:async e=>{await g.G.postData("/chat/delete-folder/",{id:e})},onFolderPositionChange:async e=>{await g.G.postData("/chat/move-folder/",e)}});a.render(s),i=new l({size:"small",title:"Add to folder",body:s,closeX:!0,confirm:!0,cancel:!0,confirmText:"Add",cancelText:"Cancel",buttonWidth:"full",buttonStyleConfirm:"primary",buttonStyleCancel:"secondary"}),i.disableConfirmButton(),i.onConfirm((async()=>{if(n)try{const t={chat_ids:[e.id],folder_id:n};await g.G.postData("/chat/add-chats-to-folder/",t);const s=a.getFolderNameById(n);new c.y(`Added to "${s}"`,"success")}catch(e){new c.y("Error adding to folder.","error")}}))}async refreshFolderSelector(e){try{const t=await g.G.postData("/chat/get-folder-structure/",{});t&&Array.isArray(t.folders)&&(e.folders=t.folders,e.render(e.container))}catch(e){}}async renameChat(e,t){}async saveSessionState(){const e=this.tabs.map((e=>({id:e.id,title:e.title||"New session",assistantImage:e.assistantImage||null,hasNotification:!!e.hasNotification,isPinned:!!e.isPinned}))),t={version:(window.session_tab_state?.version||0)+1,updated_at:Date.now(),open_tabs_info:e,active_chat_id:this.activeTabId,active_special_tab_id:this.activeSpecialTabId};if(window.session_tab_state=t,!this._applyingRemote){const e={...t};delete e.active_chat_id,delete e.active_special_tab_id;try{this.sync.broadcastState(e)}catch(e){}try{await u.K.updateSessionState(t)}catch(e){new c.y("Check your internet connection.","error")}}}async loadTabsFromState(){const e=window.session_tab_state||{};this.tabs=[],this.activeTabId=null,this.activeSpecialTabId=null;const t=e.open_tabs_info||[],s=e.active_chat_id||null,i=e.active_special_tab_id||null;if(0===t.length&&!i)return this.element&&(this.renderTabs(),this.renderActions(),setTimeout((()=>this.scrollToActiveTab("auto")),0)),{active_chat_id:null,active_special_tab_id:null};if(t.forEach((e=>{this.tabs.push({id:e.id,title:e.title||"New session",active:!1,assistantImage:e.assistantImage||null,hasNotification:!!e.hasNotification,isWorking:!1,isPinned:!!e.isPinned})})),this.sortTabs(),this.activeTabId=s,this.activeSpecialTabId=i,this.activeTabId){const e=this.tabs.find((e=>e.id===this.activeTabId));e?e.active=!0:(this.activeTabId=null,this.tabs.length>0&&(this.activeTabId=this.tabs[0].id,this.tabs[0].active=!0))}else this.tabs.length>0&&!this.activeSpecialTabId&&(this.activeTabId=this.tabs[0].id,this.tabs[0].active=!0);return this.element&&(this.renderTabs(),this.renderActions(),setTimeout((()=>this.scrollToActiveTab("auto")),0)),{active_chat_id:this.activeTabId,active_special_tab_id:this.activeSpecialTabId}}initSortable(){if(this.sortableInstance&&this.sortableInstance.destroy(),!this.tabsInnerContainer)return;const e=this.isTouchDevice;this.sortableInstance=re.Ay.create(this.tabsInnerContainer,{animation:150,forceFallback:!1,ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",filter:".no-drag",preventOnFilter:!0,distance:5,disabled:e,onStart:t=>{e||document.body.classList.add("tab-dragging")},onMove:e=>{const t=e.dragged.dataset.id,s=e.related.dataset.id,i=this.tabs.find((e=>e.id===t)),n=this.tabs.find((e=>e.id===s));if(i&&n){if(i.isPinned&&!n.isPinned)return!1;if(!i.isPinned&&n.isPinned)return!1}return!0},onEnd:t=>{if(!e){document.body.classList.remove("tab-dragging");const e=t.oldDraggableIndex,s=t.newDraggableIndex;if(void 0!==e&&void 0!==s&&e!==s){const t=this.tabs.splice(e,1)[0];this.tabs.splice(s,0,t),this.debouncedSave()}}}})}updateTabActiveStates(){if(!this.tabsInnerContainer)return;Array.from(this.tabsInnerContainer.children).forEach((e=>{const t=e.dataset.id,s=this.tabs.find((e=>e.id===t));if(s){const t=s.active||s.id===this.activeTabId;let i="flex items-center h-8 px-2 cursor-pointer rounded-md backdrop-blur-sm transition duration-100 box-border whitespace-nowrap text-sm font-medium min-w-[80px] max-w-[250px] relative overflow-hidden";e.className=t?`${i} ${this.theme.navTabActiveBackgroundColor||this.theme.tabSelectedBackground} ${this.theme.navTabActiveTextColor||this.theme.tabSelectedTextColor}`:`${i} ${this.theme.navTabBackgroundColor||this.theme.tabBackground} ${this.theme.navTabTextColor||this.theme.fadedText}`,e.style.cursor="grab"}}))}renderTabs(){this.tabsScrollContainer&&this.tabsInnerContainer&&(this.tabsInnerContainer.innerHTML="",this.tabs.forEach((e=>{const t=document.createElement("div");t.dataset.id=e.id;let s="flex items-center h-8 px-2 rounded-md backdrop-blur-sm transition duration-150 box-border whitespace-nowrap text-sm font-medium w-[120px] sm:w-[200px] relative overflow-hidden flex-shrink select-none";const i=e.active||e.id===this.activeTabId;if(t.id=`session-tab-${e.id}`,t.setAttribute("role","tab"),t.setAttribute("aria-selected",i.toString()),t.setAttribute("tabindex",i?"0":"-1"),i){const e=this.theme.navTabActiveBackgroundColor||this.theme.tabSelectedBackground,i=this.theme.navTabActiveTextColor||this.theme.tabSelectedTextColor;t.className=`${s} ${e} ${i}`}else{const e=this.theme.navTabBackgroundColor||this.theme.tabBackground,i=this.theme.navTabTextColor||this.theme.fadedText;t.className=`${s} ${e} ${i}`}if(e.assistantImage){const s=document.createElement("div");s.className="relative flex-shrink-0 mr-1.5 group";const i=document.createElement("img");if(i.src=e.assistantImage,i.className="sm:w-5 sm:h-5 w-4 h-4 rounded-full pointer-events-none",i.alt="",i.draggable=!1,s.appendChild(i),e.isPinned&&!e.isPlaceholder){const e=document.createElement("div");e.className="absolute bottom-[-2px] left-[-3px] z-30 shadow-lg",e.style.pointerEvents="none";const t=o.A.name("thumbtack");if(t){const s=new r.I({pathData:t.path,viewBox:t.viewBox||"0 0 384 512",sizeClasses:"w-3 h-3",additionalClasses:this.theme.thumbtackTitleMenuSelectedColor||"text-gray-400"});s.element&&e.appendChild(s.element)}s.appendChild(e)}const n=document.createElement("div");n.dataset.notificationLightId=e.id;const a=this.theme.navTabIndicatorLight||"bg-[#6F9EF2]";if(n.className=`absolute bottom-[-2px] right-[-2px] w-2 h-2 ${a} rounded-full transition-opacity duration-300 ease-in-out z-40`,e.hasNotification?n.classList.remove("hidden"):n.classList.add("hidden"),s.appendChild(n),!e.isPlaceholder){const t=(e,t,s)=>{e.stopPropagation();const i=this.tabs.find((e=>e.id===s.id));if(!i||i.isPlaceholder)return void(i&&i.isPlaceholder&&new c.y("Session is finalizing, please wait.","info"));const n={...i};new le(t,n,{onPin:async e=>{if(this.onPin){const t=!e.isPinned;await this.onPin(e.id,t)}},onMarkRead:e=>{const t=this.tabs.find((t=>t.id===e.id));t&&this.setNotificationLight(e.id,!t.hasNotification)},onFolder:e=>{this.showFolderSelectorForTab(e)},onRename:e=>{this.onRename&&this.onRename(e.id)},onShare:e=>{this.onShare?this.onShare(e.id):new c.y(`Sharing for "${e.title}" coming soon!`,"info")},onRefresh:e=>{this.onRefresh&&this.onRefresh(e.id)},onDelete:e=>{this.onDelete&&this.onDelete(e.id)}})};if(this.isTouchDevice)s.style.cursor="pointer",s.addEventListener("click",(i=>{t(i,s,e)}));else{const i=document.createElement("div");i.dataset.ellipsisButtonId=e.id;const n="absolute inset-0 flex items-center justify-center bg-black/40 dark:bg-black/50 rounded-full transition-opacity cursor-pointer z-30";i.className=`${n} opacity-0 group-hover:opacity-100`;const a=o.A.name("ellipsis"),l=new r.I({pathData:a.path,viewBox:a.viewBox||"0 0 512 512",sizeClasses:"w-3.5 h-3.5",colorClass:"text-gray-50"});l.element&&i.appendChild(l.element),i.addEventListener("mousedown",(e=>{e.stopPropagation()})),i.addEventListener("click",(s=>{t(s,i,e)})),s.appendChild(i)}}const l=document.createElement("div");l.dataset.spinnerOverlayId=e.id,l.className="absolute inset-0 flex items-center justify-center bg-black/40 dark:bg-black/50 rounded-full transition-opacity duration-150 ease-in-out z-20";const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-3 h-3",additionalClasses:"animate-spin text-white"});h.element&&l.appendChild(h.element),e.isWorking?(l.classList.remove("hidden"),i.style.opacity="0.6"):(l.classList.add("hidden"),i.style.opacity="1"),s.appendChild(l),t.appendChild(s)}const n=document.createElement("span");if(n.className="truncate pr-1 flex-grow min-w-0",t.appendChild(n),e.isPinned)n.classList.remove("pr-1"),e.isPlaceholder||n.classList.add("pr-2");else{const s=document.createElement("button");s.type="button",s.className="ml-auto rounded-full flex items-center justify-center transition-colors flex-shrink-0 p-1 h-4 w-4 box-border "+(i?(this.theme.tabSelectedTextColor||"text-white")+" hover:bg-black/10 dark:hover:bg-white/10":(this.theme.fadedText||"text-gray-400")+" hover:bg-black/10 dark:hover:bg-white/10"),s.setAttribute("aria-label","Close tab");const n=new r.I({pathData:o.A.name("tabClose").path,viewBox:o.A.name("tabClose").viewBox,sizeClasses:"w-3 h-3",colorClass:"fill-current"});n.element&&s.appendChild(n.element),s.addEventListener("click",(t=>{t.stopPropagation(),this.onTabClose?this.onTabClose(e.id):this.removeTab(e.id)})),t.appendChild(s)}n.textContent=e.title,e.justAdded&&(t.style.opacity="0",t.style.transform="scale(0.8)",t.style.maxWidth="0px",t.style.transition="opacity 150ms ease-out, transform 150ms ease-out, max-width 150ms ease-out",requestAnimationFrame((()=>{t.style.opacity="1",t.style.transform="scale(1)",t.style.maxWidth="",setTimeout((()=>{t&&(t.style.transition="",e.id===this.activeTabId&&this.scrollToActiveTab("smooth"))}),150)})),delete e.justAdded),t.addEventListener("click",(()=>{e.isPlaceholder?new c.y("Session is finalizing, please wait.","info"):this.activeTabId===e.id||!this.isTouchDevice&&document.body.classList.contains("tab-dragging")||(this.setActiveTab(e.id),this.onTabSwitch&&this.onTabSwitch(e.id))}));const a=["ring-2",...(this.theme.secondaryRingColor||"ring-blue-500").split(" ")];t.addEventListener("dragover",(e=>{document.body.classList.contains("dragging-internal-image")&&(e.preventDefault(),e.dataTransfer.dropEffect="copy",t.classList.add(...a))})),t.addEventListener("dragleave",(()=>{t.classList.remove(...a)})),t.addEventListener("drop",(e=>{if(e.preventDefault(),t.classList.remove(...a),!document.body.classList.contains("dragging-internal-image"))return;const s=t.dataset.id,i=e.dataTransfer.getData("application/json");if(i)try{const e=JSON.parse(i);if(this.activeTabId===s){const t=ke.chatInstances[s];t&&"function"==typeof t.acceptDroppedImage?t.acceptDroppedImage(e):new c.y("Could not add image to this chat.","error")}else ke.pendingDroppedImage={tabId:s,imageObject:e},this.onTabSwitch&&this.onTabSwitch(s),this.setActiveTab(s)}catch(e){new c.y("There was an error adding the image.","error"),ke.pendingDroppedImage=null}})),this.tabsInnerContainer.appendChild(t)})),this.initSortable())}scrollToActiveTab(e="smooth",t=45,s=null){const i=s||this.activeTabId;if(!i||!this.tabsInnerContainer||!this.tabsScrollContainer)return;const n=this.tabsInnerContainer.querySelector(`[data-id="${i}"]`),a=this.tabsScrollContainer;if(!n||!a)return;const o=n.offsetLeft,r=o+n.offsetWidth,l=a.scrollLeft,c=a.clientWidth,d=l+c;if(o>=l&&r<=d)return;let h;h=o<l?o-t:r>d?r-c+t:o-t;let m=Math.max(0,h);const u=a.scrollWidth-c;if(m=Math.min(m,u),"smooth"===e){if(this.isSmoothScrolling)return void(this.nextSmoothScrollTarget={tabId:i,behavior:e,offset:t});this.isSmoothScrolling=!0,this.nextSmoothScrollTarget=null,a.scrollTo({left:m,behavior:"smooth"}),this.scrollEndTimeout&&clearTimeout(this.scrollEndTimeout),this.scrollEndTimeout=setTimeout((()=>{this._finalizeSmoothScroll()}),this.SMOOTH_SCROLL_DURATION)}else this.isSmoothScrolling&&(this.scrollEndTimeout&&clearTimeout(this.scrollEndTimeout),this.isSmoothScrolling=!1,this.nextSmoothScrollTarget=null),a.scrollTo({left:m,behavior:"auto"})}renderActions(){if(!this.actionsContainer)return;this.actionsContainer.innerHTML="";const e=document.createElement("div");e.className="flex items-center pr-2";const t=document.createElement("button");t.type="button",t.className=`group flex items-center justify-center h-8 w-8 cursor-pointer rounded-md backdrop-blur-sm transition-all duration-150 ${this.theme.iconColor} ${this.theme.menuIconHoverColor}`,t.setAttribute("aria-label","More actions");const s=o.A.name("ellipsisVertical"),i=new r.I({pathData:s.path,viewBox:s.viewBox||"0 0 128 512",sizeClasses:"w-4 h-4"});i.element&&t.appendChild(i.element),t.addEventListener("click",(e=>{e.stopPropagation(),new he(t,{onNewTab:()=>{ke.sessionTabs&&"function"==typeof ke.sessionTabs.onNewTab&&ke.sessionTabs.onNewTab()},onCloseAllTabs:async()=>{const e=this.activeTabId,t=this.tabs.filter((t=>!t.isPinned&&t.id!==e));if(0!==t.length)for(const e of t)this.onTabClose?await this.onTabClose(e.id):await this.removeTab(e.id)}})})),e.appendChild(t),this.specialTabs.forEach((t=>{if(t.permission&&!u.K.hasPermission(t.permission))return;const s=this.activeSpecialTabId===t.id,i=document.createElement("button");i.type="button",i.className="group flex items-center h-8 px-2 cursor-pointer rounded-md backdrop-blur-sm transition-all duration-150 whitespace-nowrap text-sm font-medium align-middle",i.className+=s?` ${this.theme.navTabActiveBackgroundColor||this.theme.tabSelectedBackground} ${this.theme.navTabActiveTextColor||this.theme.tabSelectedTextColor}`:` ${this.theme.iconColor} ${this.theme.menuIconHoverColor}`,i.setAttribute("aria-label",t.title),s&&i.setAttribute("aria-current","page");const n=new r.I({pathData:t.icon,viewBox:t.viewBox||"0 0 512 512",sizeClasses:"w-5 h-5"});if(n.element)i.appendChild(n.element);else{const e=document.createElement("span");e.textContent=t.title.substring(0,1),i.appendChild(e)}"tasks"===t.id?i.addEventListener("click",(()=>{window.taskBarInstance&&window.taskBarInstance.isOpen?(window.taskBarInstance.close(),this.setActiveSpecialTab(null)):(oe.getInstance(),this.setActiveSpecialTab(t.id),this.setActiveTab(null)),this.renderActions()})):i.addEventListener("click",(()=>{this.setActiveSpecialTab(t.id),v.view(t.route)})),e.appendChild(i)}));const n=this.renderProfileButton();e.appendChild(n),this.actionsContainer.appendChild(e)}renderProfileButton(){const e=document.createElement("button");return e.type="button",e.className=`${this.theme.secondaryButtonTransparent} rounded-full ml-2 transition-opacity duration-300 h-7 w-7 flex items-center justify-center`,e.draggable=!1,e.id="profileButton",e.setAttribute("aria-label","Open user menu"),e.setAttribute("aria-haspopup","true"),e.setAttribute("aria-expanded","false"),e.innerHTML=`<img src="${u.K.profileImage}" draggable="false" class="w-7 h-7 rounded-full profile-image">`,e.addEventListener("click",(e=>{e.stopPropagation(),this.showProfileMenu(e)})),e}async showProfileMenu(e){e.stopPropagation();const t=document.querySelector(".profile-menu");if(t)return t.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0),void e.target.closest("button").setAttribute("aria-expanded","false");const s=document.createElement("div");s.className=`profile-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-50 text-sm min-w-[200px] flex flex-col overflow-hidden`;const i=document.createElement("ul");if(i.className="py-1 overflow-y-auto hide-scrollbar flex-grow",i.style.position="relative",0===this.workspaces.length){const e=document.createElement("div");e.className="flex flex-col w-full";const t=document.createElement("button");t.className="\n                rounded-md ring-indigo-600 ring-1 py-3 px-3 text-xs text-zinc-900 m-2 text-left\n                relative overflow-hidden group\n                transition duration-300 ease-in-out\n                shadow-md\n                bg-indigo-200\n            ",t.innerHTML='\n                <div class="font-medium text-sm text-black flex items-center"><span>Add your team &rarr; </span></div>\n                <div class="font-normal pt-0.5">Create an AI workspace</div>\n            ',e.appendChild(t),i.appendChild(e),t.onclick=e=>{e.stopPropagation(),window.open("/accounts/workspace/new/","_blank"),s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)}}else{if(this.selectedWorkspace=await u.K.getSelectedWorkspace(),"None"!==window.personal_plan){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const l=document.createElement("div");l.className="w-7 h-7 rounded-full flex items-center justify-center overflow-hidden",l.innerHTML=`<img src="${u.K.profileImage}" class="w-full h-full object-cover profile-image">`,a.appendChild(l);const c=document.createElement("span");c.textContent="My workspace",a.appendChild(c),n.appendChild(a);const d=document.createElement("div");if(d.className="flex pl-2",n.appendChild(d),!y.a.config||"Personal"===y.a.workspace.name){const e=o.A.name("check"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",colorClass:"text-green-500"});t.element&&d.appendChild(t.element)}t.appendChild(n),t.onclick=e=>{e.stopPropagation();window.location.pathname="/accounts/switch/0/",s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}const e=3;let t=[];if(this.selectedWorkspace&&this.selectedWorkspace.slug){const e=this.workspaces.find((e=>e.slug===this.selectedWorkspace.slug));e&&t.push(e)}if(this.workspaces.forEach((s=>{t.length<e&&(!this.selectedWorkspace?.slug||s.slug!==this.selectedWorkspace.slug)&&t.push(s)})),t.forEach((e=>{const t=document.createElement("li"),n=document.createElement("button");n.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const a=document.createElement("div");a.className="flex flex-grow justify-between align-middle items-center";const l=document.createElement("div");l.className="flex items-center gap-2";const c=document.createElement("div");if(c.className="w-7 h-7 rounded-full flex items-center justify-center overflow-hidden",e.image)c.innerHTML=`<img src="${e.image}" class="w-full h-full object-cover">`;else{c.className+=` ${this.theme.workspaceDefaultIcon}`;const e=o.A.name("buildings"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3",additionalClasses:this.theme.workspaceDefaultIcon});c.appendChild(t.element)}l.appendChild(c);const d=document.createElement("span");d.textContent=e.workspace_name,l.appendChild(d),a.appendChild(l);const h=document.createElement("div");if(h.className="flex pl-2",a.appendChild(h),y.a.workspace?.slug===e.slug){const e=o.A.name("check"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",colorClass:"text-green-500"});t.element&&h.appendChild(t.element)}n.appendChild(a),n.onclick=t=>{t.stopPropagation();const i=`/accounts/workspace/login/${e.slug}/`;window.location.pathname=i,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},t.appendChild(n),i.appendChild(t)})),this.workspaces.length>e){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const l=document.createElement("div");l.className=`w-7 h-7 rounded-full flex items-center justify-center ${this.theme.secondaryBackground}`;const c=o.A.name("ellipsis"),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});l.appendChild(d.element),a.appendChild(l);const h=document.createElement("span");h.textContent="View all",a.appendChild(h),n.appendChild(a),t.appendChild(n),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspaces"),s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}else if("Personal"===y.a.workspace.name){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const o=document.createElement("div");o.className=`w-7 h-7 rounded-full flex items-center justify-center ${this.theme.secondaryBackground}`;const l={pathData:"M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 144L48 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0 0 144c0 17.7 14.3 32 32 32s32-14.3 32-32l0-144 144 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-144 0 0-144z",viewBox:"0 0 448 512",sizeClasses:"w-4 h-4"},c=new r.I(l);c.element&&o.appendChild(c.element),a.appendChild(o);const d=document.createElement("span");d.textContent="Create workspace",a.appendChild(d),n.appendChild(a),t.appendChild(n),t.onclick=e=>{e.stopPropagation(),window.open("/accounts/workspace/new/","_blank"),s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}const n=this.workspaces.find((e=>e.slug===this.selectedWorkspace?.slug));if("Personal"!==y.a.workspace.name&&n?.workspace_manage){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="flex flex-grow justify-between align-middle items-center";const a=document.createElement("div");a.className="flex items-center gap-2";const l=document.createElement("div");l.className=`w-7 h-7 rounded-full flex items-center justify-center ${this.theme.secondaryBackground}`;const c=o.A.name("sliders"),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",additionalClasses:"fill-current"});l.appendChild(d.element),a.appendChild(l);const h=document.createElement("span");h.textContent="Manage",a.appendChild(h),n.appendChild(a),t.appendChild(n),t.onclick=e=>{e.stopPropagation(),v.view("/chat/workspace/admin"),s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}}const n=document.createElement("li");if(n.className=`border-t ${this.theme.tableDividerLine} my-1`,i.appendChild(n),u.K.hasPermission("feature:mcps")){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",t.appendChild(n);const a=o.A.name("store"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});n.appendChild(l.element);const c=document.createElement("div");c.className="flex h-5 align-middle items-center",c.textContent="MCP store",t.appendChild(c),t.onclick=e=>{e.stopPropagation(),new A,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}if(u.K.hasPermission("theme:switch")){const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",t.appendChild(n);const a=o.A.name("paintbrushPencil"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});n.appendChild(l.element);const c=document.createElement("div");c.className="flex h-5 align-middle items-center",c.textContent="Theme",t.appendChild(c),t.onclick=e=>{e.stopPropagation(),new L,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)}const a=document.createElement("li"),l=document.createElement("button");l.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const c=document.createElement("div");c.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",l.appendChild(c);const d=o.A.name("cog"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});c.appendChild(h.element);const m=document.createElement("div");m.className="flex h-5 align-middle items-center",m.textContent="Settings",l.appendChild(m),l.onclick=e=>{e.stopPropagation(),new q,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},a.appendChild(l),i.appendChild(a);const p=document.createElement("li");p.className=`border-t ${this.theme.tableDividerLine} my-1`,i.appendChild(p);const g=()=>{const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",t.appendChild(n);const a=o.A.name("help"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});n.appendChild(l.element);const c=document.createElement("div");c.className="flex h-5 align-middle items-center",c.textContent="Support",t.appendChild(c),t.onclick=e=>{e.stopPropagation(),new f,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)};window.workspace_context&&window.workspace_support.state?window.workspace_support&&!window.workspace_support.disable_support&&g():g();const w=()=>{const e=document.createElement("li"),t=document.createElement("button");t.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const n=document.createElement("div");n.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",t.appendChild(n);const a=o.A.name("toolbox"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});n.appendChild(l.element);const c=document.createElement("div");c.className="flex h-5 align-middle items-center",c.textContent="MCP admin",t.appendChild(c),t.onclick=e=>{e.stopPropagation(),new ce,s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},e.appendChild(t),i.appendChild(e)};window.isAdmin()&&w();const b=document.createElement("li"),C=document.createElement("button");C.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover} flex gap-2 items-center`;const x=document.createElement("div");x.className="w-7 h-5 rounded-full flex items-center justify-center overflow-hidden",C.appendChild(x);const k=o.A.name("rightFromBracket"),E=new r.I({pathData:k.path,viewBox:k.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"fill-current"});x.appendChild(E.element);const S=document.createElement("div");S.className="flex h-5 align-middle items-center",S.textContent="Logout",C.appendChild(S),C.onclick=e=>{e.stopPropagation(),u.K.signOut(),s.remove(),this.closeProfileMenuHandler&&document.removeEventListener("click",this.closeProfileMenuHandler,!0)},b.appendChild(C),i.appendChild(b),s.appendChild(i),document.body.appendChild(s),e.target.closest("button").setAttribute("aria-expanded","true");const T=e.target.closest("button").getBoundingClientRect(),_=window.innerHeight,I=.7*_;s.style.visibility="hidden",s.style.position="absolute",s.style.maxHeight=`${I}px`;const M=i.scrollHeight>I;s.style.visibility="",s.style.position="absolute",M?(s.classList.add("profile-menu-scrollable"),i.classList.add("profile-menu-scrollable-list")):(s.style.maxHeight="",s.style.height="auto");let B=T.bottom+5,D=T.right-s.offsetWidth;if(D<5&&(D=5),B+s.offsetHeight>_&&T.top>s.offsetHeight+5?B=T.top-s.offsetHeight-5:B+s.offsetHeight>_&&(B=_-s.offsetHeight-5,B<5&&(B=5)),s.style.top=`${B+window.scrollY}px`,s.style.left=`${D+window.scrollX}px`,this.closeProfileMenuHandler=t=>{s.contains(t.target)||e.target.closest("button").contains(t.target)||(e.target.closest("button").setAttribute("aria-expanded","false"),s.remove(),document.removeEventListener("click",this.closeProfileMenuHandler,!0))},setTimeout((()=>{document.addEventListener("click",this.closeProfileMenuHandler,!0)}),0),M){const e=()=>{i.scrollHeight-i.scrollTop<=i.clientHeight+1?i.classList.add("scrolled-to-bottom"):i.classList.remove("scrolled-to-bottom")};i.addEventListener("scroll",e),e()}}render(){this.element=document.createElement("div"),this.element.className="w-full z-40 sticky top-0 box-border relative",this.element.style.height="45px",this.element.style.minHeight="45px";const e=document.createElement("div");e.className="absolute inset-0 bg-[rgba(var(--bg-color-rgb),0.7)] backdrop-blur-md z-0",this.element.appendChild(e);const t=document.createElement("div");if(t.className="relative flex items-center h-full z-10 gap-1.5 px-2",this.element.appendChild(t),window.workspace&&window.workspace.brand){const e=document.createElement("div");e.className="flex-shrink-0 w-8 h-8 rounded-md flex items-center justify-center overflow-hidden",e.innerHTML=`<img src="${window.workspace.brand}" class="w-full h-full object-cover" alt="${window.workspace.name} logo">`,t.appendChild(e)}this.tabsScrollContainer=document.createElement("div"),this.tabsScrollContainer.className="flex flex-grow min-w-0 overflow-x-auto hide-scrollbar hide-scrollbar items-center py-1.5 gap-1.5 relative",t.appendChild(this.tabsScrollContainer),this.tabsScrollContainer&&!this.tabsScrollContainer._scrollEndListenerAttached&&(this.tabsScrollContainer.addEventListener("scrollend",this._onScrollEnd.bind(this)),this.tabsScrollContainer._scrollEndListenerAttached=!0),this.tabsInnerContainer=document.createElement("div"),this.tabsInnerContainer.className="flex items-center gap-1.5 tabs-inner-container",this.tabsInnerContainer.setAttribute("role","tablist"),this.tabsInnerContainer.setAttribute("aria-label","Open chat sessions"),this.tabsScrollContainer.appendChild(this.tabsInnerContainer);const s=document.createElement("button");s.type="button",s.className=`sticky right-0 flex items-center justify-center h-6 w-6 rounded-full cursor-pointer transition-colors duration-150 hover:bg-black/10 dark:hover:bg-white/10 flex-shrink-0 ml-1 z-10 ${this.theme.iconColor}`,s.style.background="rgba(var(--bg-color-rgb), 0.7)",s.style.backdropFilter="blur(8px)",s.setAttribute("aria-label","New session");const i=new r.I({pathData:o.A.name("plus").path,viewBox:o.A.name("plus").viewBox,sizeClasses:"w-3.5 h-3.5",colorClass:this.theme.iconColor});i.element&&s.appendChild(i.element),s.addEventListener("click",(()=>{ke.sessionTabs&&"function"==typeof ke.sessionTabs.onNewTab&&ke.sessionTabs.onNewTab()})),this.tabsScrollContainer.appendChild(s),this.actionsContainer=document.createElement("div"),this.actionsContainer.className="flex items-center py-1.5 flex-shrink-0 ml-auto z-20",t.appendChild(this.actionsContainer),this.renderTabs(),this.renderActions(),setTimeout((()=>this.scrollToActiveTab("auto")),0);try{const e=document.getElementById("chat-menu");e&&(e.style.display="none")}catch(e){}return this.element}setNotificationLight(e,t){const s=this.tabs.find((t=>t.id===e));if(!s)return;const i=s.hasNotification;if(s.hasNotification=t,this.tabsInnerContainer){const s=this.tabsInnerContainer.querySelector(`[data-id="${e}"]`);if(s){const i=s.querySelector(`[data-notification-light-id="${e}"]`);i&&(t?i.classList.remove("hidden"):i.classList.add("hidden"))}}i!==t&&this.debouncedSave()}setTabWorkingState(e,t){const s=this.tabs.find((t=>t.id===e));if(s&&s.isWorking!==t&&(s.isWorking=t,this.tabsInnerContainer)){const i=this.tabsInnerContainer.querySelector(`[data-id="${e}"]`);if(i){const n=i.querySelector(`[data-spinner-overlay-id="${e}"]`),a=i.querySelector("img.w-5.h-5.rounded-full");n?t?(n.classList.remove("hidden"),a&&(a.style.opacity="0.6")):(n.classList.add("hidden"),a&&(a.style.opacity="1")):t&&s.assistantImage}}}}class ge{constructor(e=null){this.theme=i.A.theme,this.assistant=e||{},this.editMode=!(!e||!e.id),this.isLoading=e?.isLoading||!e,this.container=null,this.builderEl=null,this.headerEl=null,this.footerEl=null,this.tabsEl=null,this.contentEl=null,this.titleInput=null,this.avatarComponent=null,this.instructionsTextarea=null,this.saveButton=null,this.isDirty=!1,this.lastNameForAvatar=null,this.activeTemplateKey=null,this.instructionsEditedSinceTemplate=!1,this.pollingInterval=null,this.pollingDelay=3e3,this.sourcesContainer=null,this.sourcesContainer=null,this.knowledgePanelEl=null,this.instructionsPanelEl=null,this.toolsPanelEl=null,this.settingsPanelEl=null,this.availableTools=[],this.allowAllTools=!0,this.selectedTools=[],this.availableModels=[],this.defaultModelId=null,this.setDefaultModel=!1,this.activeTab="knowledge",this.isEditingTitle=!1,this.groundedMemory=[],this.editMode&&this.assistant&&this.assistant.grounded_memories&&(this.groundedMemory=this.assistant.grounded_memories.map((e=>{const t=e.status||"processed";return{id:e.id,type:e.type,name:e.name||e.file_name||e.web_crawl_url||e.youtube_url||e.text_title,status:t,lastUpdated:e.last_updated,payload:{url:e.web_crawl_url||e.youtube_url,depth:e.web_crawl_depth,frequency:e.web_crawl_frequency,text:e.text_content,file:{name:e.file_name,type:e.file_mime_type}}}}))),this.handleKeyDown=this.handleKeyDown.bind(this),this.close=this.close.bind(this),this._performClose=this._performClose.bind(this),this.destroy=this.destroy.bind(this),this.switchTab=this.switchTab.bind(this),this.showAddSourceModal=this.showAddSourceModal.bind(this),this.showFileUploadModal=this.showFileUploadModal.bind(this),this.showWebCrawlModal=this.showWebCrawlModal.bind(this),this.showYouTubeModal=this.showYouTubeModal.bind(this),this.showTextModal=this.showTextModal.bind(this),this.addMemorySource=this.addMemorySource.bind(this),this.removeMemorySource=this.removeMemorySource.bind(this),this.updateMemoryTile=this.updateMemoryTile.bind(this),this.createSourceOptionTiles=this.createSourceOptionTiles.bind(this),this.createSourceListItem=this.createSourceListItem.bind(this),this.save=this.save.bind(this)}static edit(e){if(!e)return;new ge({id:e,isLoading:!0}).show()}show(){this.renderShell(),document.body.appendChild(this.container),document.addEventListener("keydown",this.handleKeyDown),document.body.classList.add("overflow-hidden"),requestAnimationFrame((()=>{this.container.style.opacity="1",this.builderEl.style.opacity="1",this.builderEl.style.transform="scale(1)",this.editMode||this.isLoading||!this.titleInput||this.titleInput.focus()})),this.isLoading&&(this.editMode?this.fetchAndPopulateData():this.fetchBuilderData())}renderShell(){this.container=document.createElement("div"),this.container.className="assistant-builder-container fixed inset-0 flex items-center justify-center backdrop-blur-xs md:items-start md:pt-[120px] pt-[80px]",this.container.style.zIndex=40,this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.container.style.opacity="0",this.builderEl=document.createElement("div"),this.builderEl.className=`${this.theme.modalBackground} w-[95vw] sm:w-[90vw] md:w-[700px] h-[60vh] sm:h-[80vh] md:h-[580px] rounded-lg shadow-xl flex flex-col overflow-hidden ring-1 ${this.theme.ringColor} relative transition-all duration-200 ease-out`,this.builderEl.style.opacity="0",this.builderEl.style.transform="scale(0.95)",this.renderHeader(),this.renderTabs(),this.renderContent(),this.renderFooter(),this.container.appendChild(this.builderEl)}renderHeader(){this.headerEl||(this.headerEl=document.createElement("div"),this.headerEl.className="px-4 pt-4 pb-1 flex items-center relative flex-shrink-0",this.builderEl.appendChild(this.headerEl)),this.headerEl.innerHTML="";const e=document.createElement("div");this.isLoading?e.className=`w-10 h-10 ${this.theme.loadBackground} rounded-full animate-pulse`:(e.className="cursor-pointer",this.avatarComponent=new S(null,this.assistant?.img_url||null,"Change icon",["image","prompt"],"rounded-full",null,!0),this.avatarComponent.render(e));const t=document.createElement("div");if(t.className="flex-grow ml-2.5",this.isLoading){const e=document.createElement("div");e.className=`h-7 ${this.theme.loadBackground} rounded w-1/2 animate-pulse`,t.appendChild(e)}else t.classList.add("cursor-pointer","group",`hover:${this.theme.secondaryBackground}`,"sm:mr-20","rounded-lg"),this.titleInput=document.createElement("input"),this.titleInput.type="text",this.titleInput.value=this.assistant?.name||"",this.titleInput.placeholder="e.g. Researcher",this.titleInput.className=`text-2xl font-medium ${this.theme.text} ${this.theme.placeholderText} w-full bg-transparent border-none outline-none focus:ring-0 truncate cursor-pointer px-2 py-1`,t.appendChild(this.titleInput),this.titleInput.addEventListener("input",(()=>{this.isDirty=!0,clearTimeout(this.nameChangeDebounce);const e=this.titleInput.value.trim();!this.editMode&&e&&this.avatarComponent&&!this.avatarComponent.value.imgUploadId&&(this.nameChangeDebounce=setTimeout((()=>{this.avatarComponent&&!this.avatarComponent.isGenerating&&e!==this.lastNameForAvatar&&(this.avatarComponent.generateAvatarFromName(e),this.lastNameForAvatar=e)}),500))})),this.titleInput.addEventListener("focus",(()=>{this.titleInput.classList.remove("truncate"),t.classList.remove(`hover:${this.theme.secondaryBackground}`),t.classList.add(this.theme.secondaryBackground),this.titleInput.select()})),this.titleInput.addEventListener("blur",(()=>{const e=this.titleInput.value.trim();this.assistant&&(this.assistant.name=e),this.titleInput.value=e,this.titleInput.classList.add("truncate"),t.classList.add(`hover:${this.theme.secondaryBackground}`),t.classList.remove(this.theme.secondaryBackground),clearTimeout(this.nameChangeDebounce);!this.editMode&&e&&this.avatarComponent&&!this.avatarComponent.value.imgUploadId&&!this.avatarComponent.isGenerating&&e!==this.lastNameForAvatar&&(this.avatarComponent.generateAvatarFromName(e),this.lastNameForAvatar=e)})),this.titleInput.addEventListener("keydown",(e=>{"Enter"===e.key?(e.preventDefault(),this.titleInput.blur()):"Escape"===e.key&&(this.titleInput.value=this.assistant?.name||"",this.titleInput.blur())})),t.addEventListener("click",(()=>this.titleInput.focus()));const s=document.createElement("div");s.className="absolute top-3 right-3";const i=o.A.name("tabClose"),a=new n.$({svgPathData:i.path,svgViewBox:i.viewBox,type:"icon",size:"small",iconHeightAndWidth:"h-5 w-5"});a.onClick(this.close),a.render(s),this.headerEl.appendChild(e),this.headerEl.appendChild(t),this.headerEl.appendChild(s)}renderTabs(){this.tabsEl=document.createElement("div"),this.tabsEl.className=`flex items-center border-b ${this.theme.tableBorder} px-4 flex-shrink-0`;["Knowledge","Instructions","MCPs","Settings"].forEach((e=>{const t=document.createElement("button");t.dataset.tab=e.toLowerCase(),t.textContent=e;const s="py-3 px-2 sm:px-4 text-base font-medium border-b-2 transition-colors duration-150";e.toLowerCase()===this.activeTab?t.className=`${s} ${this.theme.text} ${this.theme.primaryBorder}`:t.className=`${s} ${this.theme.fadedText} border-transparent hover:${this.theme.text}`,t.addEventListener("click",(()=>this.switchTab(e.toLowerCase()))),this.tabsEl.appendChild(t)})),this.builderEl.appendChild(this.tabsEl)}renderContent(){this.contentEl=document.createElement("div"),this.contentEl.className="flex-1 overflow-y-auto",this.builderEl.appendChild(this.contentEl),this.renderActiveTabContent()}renderFooter(){this.footerEl||(this.footerEl=document.createElement("div"),this.footerEl.className=`p-4 flex justify-end items-center gap-2 ${this.theme.modalBackground} border-t ${this.theme.tableBorder} flex-shrink-0`,this.builderEl.appendChild(this.footerEl)),this.footerEl.innerHTML="";const e=new n.$({text:"Cancel",type:"secondary",size:"medium"});e.onClick(this.close),e.render(this.footerEl),this.saveButton=new n.$({text:this.editMode?"Save & update":"Create",type:"primary",size:"medium"}),this.saveButton.onClick(this.save),this.saveButton.render(this.footerEl)}switchTab(e){this.activeTab=e,this.tabsEl.querySelectorAll("button").forEach((e=>{const t="py-3 px-2 sm:px-4 text-base font-medium border-b-2 transition-colors duration-150";e.dataset.tab===this.activeTab?e.className=`${t} ${this.theme.text} ${this.theme.primaryBorder}`:e.className=`${t} ${this.theme.fadedText} border-transparent hover:${this.theme.text}`})),"knowledge"===this.activeTab?this.startPolling():this.stopPolling(),this.renderActiveTabContent()}renderActiveTabContent(){if(this.contentEl.innerHTML="",this.isLoading)this.renderKnowledgePanelSkeleton();else switch(this.activeTab){case"knowledge":this.knowledgePanelEl||(this.knowledgePanelEl=document.createElement("div"),this.renderKnowledgePanel(this.knowledgePanelEl)),this.contentEl.appendChild(this.knowledgePanelEl),this.startPolling();break;case"instructions":this.instructionsPanelEl||(this.instructionsPanelEl=document.createElement("div"),this.renderInstructionsPanel(this.instructionsPanelEl)),this.contentEl.appendChild(this.instructionsPanelEl);break;case"mcps":this.toolsPanelEl||(this.toolsPanelEl=document.createElement("div"),this.renderToolsPanel(this.toolsPanelEl)),this.contentEl.appendChild(this.toolsPanelEl);break;case"settings":this.settingsPanelEl||(this.settingsPanelEl=document.createElement("div"),this.renderSettingsPanel(this.settingsPanelEl)),this.contentEl.appendChild(this.settingsPanelEl);break;default:this.contentEl.innerHTML=`<p class="${this.theme.fadedText}">${this.activeTab.charAt(0).toUpperCase()+this.activeTab.slice(1)} settings will be available here.</p>`}}renderKnowledgePanel(e){e.className="flex flex-col h-full space-y-2 p-4";const t=document.createElement("div");t.className="flex justify-between items-center mx-3",e.appendChild(t);const s=document.createElement("div");s.className=`text-base font-medium ${this.theme.text}`,t.appendChild(s);const i=document.createElement("div");if(i.className="flex-grow overflow-y-auto",e.appendChild(i),this.sourcesContainer=document.createElement("div"),i.appendChild(this.sourcesContainer),0===this.groundedMemory.length)t.classList.add("hidden"),this.sourcesContainer.className="grid grid-cols-1 sm:grid-cols-2 gap-2 mx-2",this.createSourceOptionTiles(this.sourcesContainer);else{t.classList.remove("hidden"),s.textContent="Sources";const e=new n.$({text:"+ Add source",type:"link",size:"link-sm"});e.render(t),e.onClick(this.showAddSourceModal),this.sourcesContainer.className="flex flex-col mx-2 gap-1",this.groundedMemory.forEach((e=>{const t=this.createSourceListItem(e);this.sourcesContainer.appendChild(t)}))}}updateSourcesView(){this.knowledgePanelEl&&(this.knowledgePanelEl.innerHTML="",this.renderKnowledgePanel(this.knowledgePanelEl))}createSourceListItem(e){const t=document.createElement("div");t.dataset.id=e.id,t.className=`flex items-center gap-3 p-2 m-0.5 rounded-md ${this.theme.secondaryBackground} ring-1 ${this.theme.inputRing} h-16`;const s=document.createElement("div");if(s.className="w-10 h-10 rounded-md flex items-center justify-center flex-shrink-0","file"===e.type){const t=e.name.split(".").pop().toLowerCase(),i=Y.getFileColor(e.type,t),n=Y.getFileIcon(e,t),a=(i||"").trim().split(/\s+/).filter(Boolean),o=(this.theme.fileIconColor||"").trim().split(/\s+/).filter(Boolean);a.length&&s.classList.add(...a),o.length&&s.classList.add(...o),s.innerHTML=n}else{let t,i;switch(e.type){case"crawl":t="globe",i=this.theme.fileDocColor;break;case"video":t="youtube",i=this.theme.fileVideoColor;break;default:t="fileLines",i=this.theme.fileOtherColor}const n=(i||"").trim().split(/\s+/).filter(Boolean);n.length&&s.classList.add(...n);const a=o.A.name(t);new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.fileIconColor}).render(s)}const i=document.createElement("div");i.className="flex-1 flex flex-col justify-center truncate";const a=document.createElement("div");a.className="text-sm font-medium truncate memory-name",a.textContent=e.name,i.appendChild(a);const l=document.createElement("div");l.className=`text-xs ${this.theme.fadedText} truncate memory-byline`,l.textContent=this.getMemoryByline(e),l.textContent&&i.appendChild(l);const c=document.createElement("div");c.className=`flex items-center gap-2 text-sm flex-shrink-0 memory-status ${this.theme.fadedText}`,this.updateStatusIndicator(c,e.status);const d=document.createElement("div");d.className="flex-shrink-0";const h=new n.$({svgPathData:o.A.name("ellipsis").path,type:"icon",size:"small"});return h.render(d),h.onClick((()=>{this.showSourceItemMenu(h.element,e)})),t.appendChild(s),t.appendChild(i),t.appendChild(c),t.appendChild(d),t}showSourceItemMenu(e,t){const s=document.querySelector(".source-item-context-menu");s&&s.remove();const i=document.createElement("div");i.className=`source-item-context-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-50 text-sm min-w-[160px] flex flex-col overflow-hidden py-1 ring-1 ${this.theme.inputRing}`;const n=(e,t)=>{const s=document.createElement("li"),n=document.createElement("button");return n.className=`w-full text-left px-3 py-1.5 ${this.theme.tableMenuButtonHover} flex items-center`,n.textContent=e,n.onclick=e=>{e.stopPropagation(),t(),i.remove(),document.removeEventListener("click",h,!0)},s.appendChild(n),s},o=document.createElement("ul");"file"===t.type?o.appendChild(n("Download",(()=>{}))):o.appendChild(n("Edit",(()=>{"crawl"===t.type&&this.showWebCrawlModal(t),"video"===t.type&&this.showYouTubeModal(t),"text"===t.type&&this.showTextModal(t)}))),o.appendChild(n("Remove",(()=>{new a("Remove source?",`Are you sure you want to remove ${t.name}? This cannot be undone.`).onConfirm((()=>{this.removeMemorySource(t.id)}))}))),i.appendChild(o),document.body.appendChild(i);const r=e.getBoundingClientRect(),l=i.getBoundingClientRect();let c=r.bottom+5,d=r.right-l.width;d<5&&(d=5),c+l.height>window.innerHeight&&(c=r.top-l.height-5),i.style.top=`${c}px`,i.style.left=`${d}px`;const h=t=>{i.contains(t.target)||e.contains(t.target)||(i.remove(),document.removeEventListener("click",h,!0))};setTimeout((()=>{document.addEventListener("click",h,!0)}),0)}createSourceOptionTiles(e,t=null){[{id:"upload-files",icon:"folder",title:"Upload files",description:"e.g. PDF, CSV, audio, video",action:this.showFileUploadModal},{id:"add-website",icon:"globe",title:"Add website",description:"Crawl a website e.g. docs",action:this.showWebCrawlModal},{id:"add-text",icon:"fileLines",title:"Add text",description:"Paste in raw text e.g. code",action:this.showTextModal}].forEach((s=>{const i=document.createElement("button");i.className=`p-4 rounded-lg text-left flex items-start gap-4 transition-colors duration-150 ${this.theme.secondaryBackground} ${this.theme.listTableHover} ring-1 ${this.theme.inputRing} m-0.5`;const n=o.A.name(s.icon),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-6 h-6 flex-shrink-0 mt-1",colorClass:this.theme.iconColor}),l=document.createElement("div"),c=document.createElement("div");c.className=`font-semibold ${this.theme.text}`,c.textContent=s.title;const d=document.createElement("div");d.className=`text-sm ${this.theme.fadedText}`,d.textContent=s.description,l.appendChild(c),l.appendChild(d);const h=document.createElement("div");a.render(h),i.appendChild(h),i.appendChild(l),i.addEventListener("click",(()=>{t&&t.close(),s.action()})),e.appendChild(i)}))}showAddSourceModal(){const e=document.createElement("div");e.className="py-2 grid grid-cols-1 sm:grid-cols-2 gap-2";const t=new l({size:"medium",title:"Add a new source",body:e,closeX:!0});this.createSourceOptionTiles(e,t)}addMemorySource(e){this.groundedMemory.push(e),this.isDirty=!0,"knowledge"===this.activeTab&&this.updateSourcesView()}removeMemorySource(e){this.groundedMemory=this.groundedMemory.filter((t=>t.id!==e)),this.isDirty=!0,"knowledge"===this.activeTab&&this.updateSourcesView()}renderInstructionsPanel(e){e.className="flex flex-col h-full p-4",this.instructionsTextarea=new p({label:"",placeholder:"e.g. You are an expert Researcher. You help the user find information and synthesize it using all avilable sources...",rows:8,canGrow:!0,value:this.assistant?.instructions||"",minChar:10,maxChar:2e6,required:!0,helpText:""}),this.instructionsTextarea.render(e),this.instructionsTextarea.textarea.addEventListener("input",(()=>{this.isDirty=!0,this.instructionsEditedSinceTemplate=!0,this.assistant.instructions=this.instructionsTextarea.textarea.value}));const t=document.createElement("div");t.className="mt-2",e.appendChild(t);const s=document.createElement("button");s.className=`${this.theme.link} text-sm font-medium hover:underline`,t.appendChild(s);const i=document.createElement("div");i.className="pb-4 pt-2 flex items-center gap-2 flex-wrap",t.appendChild(i);const n=this.getInstructionTemplates();for(const e in n){const t=n[e],s=document.createElement("button");s.className=`${this.theme.secondaryButton} ${this.theme.listTableHover} text-xs font-medium px-2.5 py-1 rounded-full transition-transform transform hover:scale-105`,s.textContent=t.name,s.title=t.prompt,s.addEventListener("click",(()=>{const s=e,i=this.instructionsTextarea.textarea.value.trim(),n=()=>{this.instructionsTextarea.textarea.value=t.prompt,this.isDirty=!0,this.instructionsEditedSinceTemplate=!1,this.activeTemplateKey=s,this.instructionsTextarea.textarea.dispatchEvent(new Event("input",{bubbles:!0})),this.instructionsEditedSinceTemplate=!1},o=this.instructionsEditedSinceTemplate||!this.activeTemplateKey;i&&o?new a("Replace instructions?","This will replace your current instructions with the selected template. Are you sure?").onConfirm(n):n()})),i.appendChild(s)}let o=!1;const r=()=>{o?(i.style.display="flex",s.textContent="Hide templates"):(i.style.display="none",s.textContent="Show templates")};s.addEventListener("click",(e=>{e.preventDefault(),o=!o,r()})),r()}getInstructionTemplates(){return{researcher:{name:"Researcher",prompt:"You are a world-class researcher. Your primary goal is to provide accurate, well-sourced, and comprehensive information to the user.\n\nCore Directives:\n- Always strive for factual accuracy. Verify information from multiple reputable sources before presenting it.\n- When presenting information, cite your sources clearly. Use footnotes or a bibliography section at the end of your response.\n- Break down complex topics into understandable segments. Use analogies and simple language where appropriate, without sacrificing accuracy.\n- If a query is ambiguous, ask clarifying questions to ensure you understand the user's intent.\n\nTool Usage:\n- You will heavily rely on academic search engines, deep research tools (like Perplexity and Grok), and web crawling to gather information.\n- Synthesize information from various sources; do not rely on a single tool or website.\n- Cross-reference findings between different tools to identify consensus and discrepancies."},personalAssistant:{name:"Personal assistant",prompt:'You are a helpful and efficient personal assistant. Your purpose is to help the user manage their tasks, schedule, and communications.\n\nCore Directives:\n- Be proactive and anticipate the user\'s needs.\n- Maintain a friendly, professional, and supportive tone.\n- Prioritize clarity and conciseness in your communication.\n- Handle personal information with the utmost discretion and privacy.\n\nCommon Tasks:\n- "Read my latest emails and summarize them."\n- "Draft a reply to this message..."\n- "Check my calendar for any appointments tomorrow."\n- "Remind me to call John at 5 PM."\n\nTool Usage:\n- Always use my \'work\' Gmail account \n- Always use my \'work\' Gmail calendar\n- Always draft emails first and confirm before sending.\n- When scheduling, I don\'t like meetings before 10AM and after 4PM on weekdays.\n\nExamples of how I write emails:\n- "Hi [Name], I hope you\'re doing well. I wanted to follow up on our last conversation regarding [topic]. Could you please provide an update on that? Thanks"\n- ...'},studyPartner:{name:"Study partner",prompt:"You are a dedicated and knowledgeable Study Partner. Your goal is to help the user understand complex subjects, prepare for exams, and make learning a collaborative and engaging process.\n            \nCore Directives:\n- Break down complex topics into simple, easy-to-understand explanations. Use analogies and real-world examples to make concepts stick.\n- Help the user test their knowledge. Create summaries, quizzes, and flashcards to reinforce learning and prepare for exams.\n- Act as a research assistant. Find relevant articles, academic papers, and educational videos to support their studies.\n- Maintain an encouraging and patient tone. Learning is a journey, and you're here to support them every step of the way.\n\nTool Usage:\n- You will heavily rely on academic search tools to find relevant papers and studies.\n- Use deep research and web search tools to gather comprehensive information, find different perspectives, and create detailed summaries on any topic.\n- When asked, scrape specific web pages to extract key information for study notes."},projectManager:{name:"Project manager",prompt:"You are a diligent and organized project manager. Your role is to help the user complete a project efficiently and effectively and help them stay on task throughout the process.\n\nCore Directives:\n- Focus on clear goals, timelines, and deliverables.\n- Structure your responses using lists, tables, and clear headings to enhance readability.\n- Proactively identify potential risks or roadblocks in a project plan.\n- Maintain a neutral and objective tone, focusing on facts and project status.\n\nTool Usage:\n- We will be tracking this project in Trello using the 'Legal project' board.\n- You will use task management tools to create, assign, and track tasks.\n- When ask to write a daily report use my 'work' gmail account and draft the report first so I can review it before sending."},codeHelper:{name:"Coding partner",prompt:"You are an expert programmer and pair programming partner. Your goal is to help the user write clean, efficient, and bug-free code.\n\nCore Directives:\n- Provide code examples in clear, well-formatted blocks.\n- Never return full code files, always return code snippets that can be easily integrated with clear instructions on how to use them.\n- When debugging, ask for the relevant code, error messages, and the expected outcome to effectively diagnose the issue.\n- We use Python, Javascript and Tailwinds be sure to use the correct syntax and conventions for these languages.\n- If you need up to date code examples, libraries or docs use Google search, Perplexity or Grok deep research to find the most relevant and recent information."},lawyer:{name:"Legal expert",prompt:"You are a legal expert specializing in corporate law. Your role is to provide accurate legal information and advice to the user.\n                \nCore Directives:\n- Always provide well-researched, accurate, and up-to-date legal information.\n- Use clear, concise language and avoid legal jargon where possible.\n- When providing legal advice, always include relevant laws, regulations, and case law to support your response.\n- If you are unsure about a legal matter, advise the user to consult a qualified attorney\n- Always use my 'work' Gmail account when drafting legal documents or emails.\n- Refer to legal document templates in your knowledge base when drafting legal documents.\n\nTool Usage:\n- Draft legal documents when asked in Google Docs using Google Doc approapriate styles. Never use markdown.\n- Use Google search, Perplexity or Grok deep research to find the most relevant and recent legal information."},financialAdvisor:{name:"Financial controller",prompt:"You are a financial controller. Your role is to help the user manage business finances, budgets, tax strategy, and financial planning.\n\nCore Directives:\n- Always provide accurate, well-researched financial information and advice.\n- Use clear, concise language and avoid financial jargon where possible.\n- When providing financial advice, always include relevant laws, regulations, and case law to support your response.\n- If you are unsure about a financial matter, advise the user to consult a qualified financial advisor.\n\nTool Usage:\n- Use Google search, Perplexity or Grok deep research to find the most relevant and recent financial information.\n- Use Finance MCP to retrieve financial data and reports.\n- Use Google Sheets to create and manage budgets, financial reports, and forecasts.\n- Use Google Docs to draft financial reports, budgets, and other financial documents."},financialAnalyst:{name:"Financial analyst",prompt:"You are a sharp and insightful financial analyst. Your expertise lies in dissecting financial data, building predictive models, and uncovering actionable insights to guide investment and business strategy.\n        \nCore Directives:\n- Provide deep, data-driven analysis of financial statements, market trends, and economic indicators.\n- Construct clear and robust financial models for forecasting, valuation, and what-if analysis.\n- Translate complex data into compelling narratives, using charts and visualizations to support your conclusions.\n- Clearly identify key performance indicators (KPIs), risks, and opportunities within the data.\n- Always maintain an objective, evidence-based perspective.\n\nTool Usage:\n- Heavily utilize spreadsheet applications like Google Sheets for financial modeling and data manipulation.\n- Employ search tools and deep research to gather market data, competitor information, and industry reports.\n- Use data visualization tools to create charts and graphs that clearly communicate your findings."},healthAndWellbeingCoach:{name:"Health coach",prompt:"You are a supportive and knowledgeable Health & Wellbeing Coach. Your purpose is to help the user understand and improve their physical and mental wellness based on the data they provide.\n        \nCore Directives:\n- Promote a holistic view of health, considering fitness, sleep, nutrition, and mental wellbeing.\n- Interpret data from health trackers to identify trends, patterns, and areas for improvement.\n- Provide encouraging, evidence-based suggestions to help the user achieve their wellness goals.\n- Prioritize safety and always include a disclaimer about consulting with a real healthcare professional.\n\nTool Usage:\n- You will analyze and interpret data from the user's connected health services like Oura, Strava, and Garmin.\n- Use your ability to read sleep data from Oura to provide insights on sleep quality and readiness.\n- Analyze activity logs from Strava or Garmin to track fitness progress and suggest workout adjustments.\n- Use search tools to find general information on nutrition, exercise science, and wellness topics when the user asks."},investmentResearcher:{name:"Investment researcher",prompt:"You are a meticulous and insightful Investment Researcher. Your purpose is to identify and analyze investment opportunities by combining hard financial data with qualitative market intelligence.\n        \nCore Directives:\n- Conduct thorough due diligence on potential investments, from individual stocks to entire market sectors.\n- Synthesize data from diverse sources to build a comprehensive and unbiased investment thesis.\n- Clearly articulate the potential risks, rewards, and key catalysts for each investment idea.\n- Present your findings in a structured, data-driven report.\n\nTool Usage:\n- You will heavily rely on the Finance MCP to retrieve real-time and historical financial data, company fundamentals, and key market statistics.\n- Use deep research tools like Perplexity, Grok, and Google Search to gather news, industry analysis, and sentiment reports.\n- When analyzing a specific company, you should crawl their corporate website for the latest press releases and investor relations documents.\n- Organize your findings and financial models in spreadsheets for clear analysis and presentation.\n"},customerSupportPro:{name:"Customer support pro",prompt:"You are a patient, empathetic, and highly efficient Customer Support Professional. Your mission is to resolve customer issues quickly and leave them feeling heard, valued, and supported.\n        \nCore Directives:\n- Always communicate with a friendly, patient, and professional tone. Empathy is your superpower.\n- Carefully read and understand the customer's issue before offering a solution.\n- Provide clear, step-by-step instructions and accurate information.\n- If you don't know the answer, be honest and commit to finding it and following up promptly.\n\nTool Usage:\n- Your primary workspace is HelpScout. You will use it to read, manage, and respond to all customer support conversations.\n- Before answering any query, your first step is to thoroughly search the company's internal knowledge base for existing articles and established procedures.\n- You will draft all responses first so they can be reviewed for accuracy and tone before being sent.\n- If the knowledge base doesn't have the answer, use search tools to find relevant external information."}}}startPolling(){this.stopPolling();0!==this.groundedMemory.filter((e=>"pending"===e.status||"processing"===e.status)).length&&(this.pollingInterval=setInterval((()=>this.pollMemoryStatus()),this.pollingDelay))}stopPolling(){this.pollingInterval&&(clearInterval(this.pollingInterval),this.pollingInterval=null)}async pollMemoryStatus(){if(this.assistant&&this.assistant.id)try{const e=await g.G.fetchData(`/chat/assistants/${this.assistant.id}/memory-status/`);if(e&&e.statuses){let t=!1;e.statuses.forEach((e=>{const s=this.groundedMemory.find((t=>t.id===e.id));if(s&&s.status!==e.memory_state){s.status=e.memory_state;const i=this.sourcesContainer.querySelector(`[data-id="${s.id}"]`);if(i){const e=i.querySelector(".memory-status");e&&this.updateStatusIndicator(e,s.status)}t=!0}}));this.groundedMemory.some((e=>"pending"===e.status||"processing"===e.status))||this.stopPolling()}}catch(e){this.stopPolling()}}showFileUploadModal(){const e=document.createElement("div");e.className="py-2";const t=new J({uiType:"uploadBox",label:"",allowedTypes:["*"],maxFiles:20,maxSizePerFile:20,maxTotalSize:400,required:!0,showUploadButton:!1,uploadBoxHeight:"h-[250px]",placeholderText:"Drag & drop files here or click to select"});t.render(e);new l({size:"medium",title:"Upload files",body:e,confirm:!0,cancel:!0,confirmText:"Add files",cancelText:"Cancel",validationFunction:()=>t.validate(),onConfirm:()=>{const e=t.files;e.length>0&&e.forEach((e=>{const s=t.fileUploadIds[e.name],i={id:this.createTempID(),type:"file",name:e.name,status:"pending",upload_id:s,payload:{file:e}};this.addMemorySource(i)}))}})}showWebCrawlModal(e=null){const t=document.createElement("div");t.className="py-2 space-y-4";const s=new d({label:"Website URL",type:"url",placeholder:"e.g. https://www.zencorp.com/knowledgebase",value:e?e.payload.url:"",required:!0}),i=new E({label:"Crawl depth",value:e?e.payload.depth:"1",required:!0,options:[{value:"0",label:"This URL only"},{value:"1",label:"One level deep"},{value:"2",label:"Two levels deep"}]}),n=new E({label:"Crawl frequency",value:e?e.payload.frequency:"never",required:!0,options:[{value:"never",label:"Only once"},{value:"day",label:"Update daily"},{value:"week",label:"Update weekly"},{value:"month",label:"Update monthly"}]});s.render(t),i.render(t),n.render(t);new l({size:"medium",title:e?"Edit website":"Add website to crawl",body:t,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",validationFunction:()=>s.validate()&&i.validate()&&n.validate(),onConfirm:()=>{if(e)e.payload.url=s.value,e.payload.depth=i.value,e.payload.frequency=n.value,e.name=s.value,this.isDirty=!0,this.updateMemoryTile(e);else{const e={id:this.createTempID(),type:"crawl",name:s.value,status:"pending",lastUpdated:new Date,payload:{url:s.value,depth:i.value,frequency:n.value}};this.addMemorySource(e)}}})}showYouTubeModal(e=null){const t=document.createElement("div");t.className="py-2 space-y-4";const s=new d({label:"YouTube URL",type:"youtube",placeholder:"https://www.youtube.com/watch?v=...",value:e?e.payload.url:"",required:!0});s.render(t);new l({size:"medium",title:e?"Edit YouTube video":"Add YouTube video",body:t,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",validationFunction:()=>s.validate(),onConfirm:()=>{if(e)e.payload.url=s.value,e.name=s.value,this.updateMemoryTile(e);else{const e={id:this.createTempID(),type:"video",name:s.value,status:"pending",payload:{url:s.value}};this.addMemorySource(e)}}})}showTextModal(e=null){const t=document.createElement("div");t.className="py-2 space-y-4";const s=new d({label:"Title",type:"text",placeholder:"e.g. Product specifications",value:e?e.name:"",required:!0}),i=new p({label:"Content",placeholder:"Paste your text here...",value:e?e.payload.text:"",rows:6,canGrow:!0,required:!0});s.render(t),i.render(t);new l({size:"medium",title:e?"Edit text":"Add custom text",body:t,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",validationFunction:()=>s.validate()&&i.validate(),onConfirm:()=>{if(e)e.name=s.value,e.payload.text=i.value,this.isDirty=!0,this.updateMemoryTile(e);else{const e={id:this.createTempID(),type:"text",name:s.value,status:"processed",payload:{text:i.value}};this.addMemorySource(e)}}})}createTempID(){return`${Date.now()}-${Math.floor(1e4*Math.random())}`}formatTimestamp(e){return e?new Intl.DateTimeFormat("en-US",{year:"numeric",month:"long",day:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).format(new Date(e)):""}addMemoryTile(e,t=!1){this.updateSourcesView()}updateMemoryTile(e){const t=this.sourcesContainer.querySelector(`[data-id="${e.id}"]`);if(!t)return;const s=this.groundedMemory.findIndex((t=>t.id===e.id));-1!==s&&(this.groundedMemory[s]={...this.groundedMemory[s],...e});const i=this.groundedMemory[s],n=t.querySelector(".memory-name");n&&(n.textContent=i.name);const a=t.querySelector(".memory-byline");a&&(a.textContent=this.getMemoryByline(i));const o=t.querySelector(".memory-status");o&&this.updateStatusIndicator(o,i.status),this.isDirty=!0}showIconEditor(){}handleKeyDown(e){"Escape"===e.key&&this.close()}async save(){if(this.avatarComponent&&this.avatarComponent.isGenerating&&this.avatarComponent.cancelGeneration(),!this.saveButton)return;const e=this.titleInput.value.trim();if(!e)return void new c.y("Please enter a name for your assistant.","error");this.saveButton.toggleLoading("Saving...");const t=this.avatarComponent.value,s={assistantName:e,assistantInstructions:this.assistant.instructions||"",groundedMemory:this.groundedMemory,imgUrl:t.imgUrl,imgPrompt:t.imgPrompt,imgUploadId:t.imgUploadId,allowAllTools:this.allowAllTools,selectedTools:this.allowAllTools?[]:this.selectedTools,defaultModelId:this.setDefaultModel?this.defaultModelId:null};try{let e;const t=!this.editMode;if(e=this.editMode?await g.G.postData(`/chat/assistants/${this.assistant.id}/update/`,s):await g.G.postData("/chat/assistants/new/",s),e&&e.assistant){const s=e.assistant;if(t)window.initial_assistants.push(s);else{const e=window.initial_assistants.findIndex((e=>e.id===s.id));-1!==e?window.initial_assistants[e]=s:window.initial_assistants.push(s)}t&&window.location.pathname.startsWith("/chat/assistants")&&await ke.createNewChatWithAssistant(s.id),document.dispatchEvent(new CustomEvent("update-assistant-buttons",{detail:{assistantId:s.id,isCreate:t}})),this.isDirty=!1,this.close()}else new c.y(e.detail||"Failed to save assistant.","error"),this.saveButton.toggleLoading()}catch(e){new c.y("An unexpected error occurred while saving the assistant.","error"),this.saveButton.toggleLoading()}}close(){this.isDirty?new a("Are you sure?","You have unsaved changes. Are you sure you want to discard them?").onConfirm((()=>{this._performClose()})):this._performClose()}_performClose(){this.container&&(this.container.style.opacity="0",this.builderEl.style.transform="scale(0.95)",this.builderEl.addEventListener("transitionend",this.destroy,{once:!0}),setTimeout(this.destroy,250))}destroy(){this.container&&(this.stopPolling(),document.removeEventListener("keydown",this.handleKeyDown),document.body.classList.remove("overflow-hidden"),this.container.remove(),this.container=null)}renderKnowledgePanelSkeleton(){const e=document.createElement("div");e.className="flex flex-col h-full space-y-2 p-4",this.contentEl.appendChild(e);const t=document.createElement("div");t.className="flex justify-between items-center mx-3";const s=document.createElement("div");s.className=`h-5 ${this.theme.loadBackground} rounded w-24 animate-pulse`,t.appendChild(s),e.appendChild(t);const i=document.createElement("div");i.className="flex-grow overflow-y-auto",e.appendChild(i),this.sourcesContainer=document.createElement("div"),this.sourcesContainer.className="flex flex-col mx-2 gap-1",i.appendChild(this.sourcesContainer);for(let e=0;e<3;e++){const e=this.createSkeletonListItem();this.sourcesContainer.appendChild(e)}}createSkeletonListItem(){const e=document.createElement("div");e.className="flex items-center gap-3 p-2 m-0.5 rounded-md h-16 animate-pulse";const t=document.createElement("div");t.className=`w-10 h-10 ${this.theme.loadBackground} rounded-md flex-shrink-0`,e.appendChild(t);const s=document.createElement("div");s.className="flex-1 flex flex-col gap-2 py-1";const i=document.createElement("div");i.className=`h-4 ${this.theme.loadBackground} rounded w-3/4`;const n=document.createElement("div");return n.className=`h-3 ${this.theme.loadBackground} rounded w-1/2`,s.appendChild(i),s.appendChild(n),e.appendChild(s),e}getMemoryByline(e){if("pending"===e.status)return"Will be processed after saving.";if("processing"===e.status)return"Processing, please wait...";if("failed"===e.status||"error"===e.status)return"Failed to process this source.";switch(e.type){case"file":const t=e.name.split(".").pop().toLowerCase();return Y.getFileType(e.payload.file.type,t);case"crawl":return e.lastUpdated?`Last crawled: ${this.formatTimestamp(e.lastUpdated)}`:"Scheduled for crawling.";case"video":return e.lastUpdated?`Transcribed: ${this.formatTimestamp(e.lastUpdated)}`:"Pending transcription.";case"text":return e.payload.text?e.payload.text:"Custom text content.";default:return""}}updateStatusIndicator(e,t){let s,i,n,a;switch(e.innerHTML="",t){case"pending":n=o.A.name("clock"),s=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4"}),i="Pending",e.classList.remove(this.theme.errorColor),e.classList.add(this.theme.fadedText);break;case"processing":n=o.A.name("spinner"),s=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4 animate-spin"}),i="Processing",e.classList.remove(this.theme.errorColor),e.classList.add(this.theme.fadedText);break;case"failed":case"error":n=o.A.name("warning"),a=this.theme.errorColor,s=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:a}),i="error"===t?"Error":"Failed",e.classList.remove(this.theme.fadedText),e.classList.add(a);break;default:n=o.A.name("checkCircle"),s=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.successColor}),i="Processed",e.classList.remove(this.theme.errorColor),e.classList.add(this.theme.fadedText)}s.render(e),e.append(i)}async fetchBuilderData(){try{let e="/chat/assistants/builder-data/";const t=await g.G.fetchData(e);t?(this.availableTools=t.available_tools||[],this.availableModels=t.available_models||[],this.isLoading=!1,this.renderHeader(),this.renderActiveTabContent(),this.renderFooter(),this.titleInput&&this.titleInput.focus()):(new c.y("Could not load required data for the builder.","error"),this.close())}catch(e){new c.y("An unexpected error occurred while loading builder data.","error"),this.close()}}async fetchAndPopulateData(){try{const e=await g.G.fetchData(`/chat/assistants/${this.assistant.id}/get/`);if(e&&e.assistant){this.assistant=e.assistant,this.isLoading=!1,this.editMode=!0,this.assistant.grounded_memories&&(this.groundedMemory=this.assistant.grounded_memories.map((e=>{const t=e.payload||{};return{id:e.id,type:e.type,name:e.name,status:e.status||"processed",lastUpdated:e.lastUpdated,payload:{url:t.url,depth:t.depth,frequency:t.frequency,text:t.text,file:t.file||{name:e.name,type:null}}}}))),this.availableTools=e.available_tools||[];const t=this.assistant.tools||[];this.allowAllTools=!(this.assistant.hasOwnProperty("tools")&&this.assistant.tools&&this.assistant.tools.length>0),this.selectedTools=t,this.availableModels=e.available_models||[],this.defaultModelId=this.assistant.default_model_id||null,this.setDefaultModel=!!this.assistant.default_model_id,this.renderHeader(),this.renderActiveTabContent(),this.renderFooter()}else new c.y(e.detail||"Could not load assistant data.","error"),this.close()}catch(e){new c.y("An unexpected error occurred while loading the assistant.","error"),this.close()}}renderToolsPanel(e){e.className="flex flex-col h-full space-y-4 p-4";const t=document.createElement("div");t.className="rounded-lg px-2",e.appendChild(t);const s=document.createElement("div");s.className="px-2 space-y-2",e.appendChild(s);const i=new C({label:"Restrict access to specific MCPs",labelPosition:"left",helpTextPostion:"below",helpText:"Enable this to select which MCPs this assistant is allowed to use. If disabled, your asssistant can access all enabled MCPs.",value:!this.allowAllTools});i.render(t);const n=new x({label:"Select MCPs:",placeholder:"e.g. Gmail (Work), Google Calendar (Work)...",items:this._formatToolsForMultiSelect(this.availableTools),value:this.availableTools.filter((e=>this.selectedTools.includes(e.id)))});n.render(s);const a=e=>{e?s.classList.remove("hidden"):s.classList.add("hidden")};i.onChange((e=>{this.allowAllTools=!e,this.isDirty=!0,a(e)})),n.onChange((e=>{this.selectedTools=e.map((e=>e.id)),this.isDirty=!0})),a(!this.allowAllTools)}renderSettingsPanel(e){e.className="flex flex-col h-full space-y-4 p-4";const t=document.createElement("div");t.className="rounded-lg px-2",e.appendChild(t);const s=document.createElement("div");s.className="px-2 space-y-2",e.appendChild(s);const i=new C({label:"Set default model for this assistant",labelPosition:"left",helpTextPostion:"below",helpText:"Override the default chat model and lock this assistant to a specific model.",value:this.setDefaultModel});i.render(t);const n=this.availableModels.find((e=>e.id===this.defaultModelId)),a=new k({label:"Select a default model:",placeholder:"e.g. Claude 4 Sonnet...",items:this._formatModelsForMultiSelect(this.availableModels),value:n||null});a.render(s);const o=()=>{this.setDefaultModel?s.classList.remove("hidden"):s.classList.add("hidden")};i.onChange((e=>{this.setDefaultModel=e,this.isDirty=!0,e||(this.defaultModelId=null,a.value=null),o()})),a.onChange((e=>{const t=e[0];this.defaultModelId=t?t.id:null,this.isDirty=!0})),o()}_formatModelsForMultiSelect(e){return e&&0!==e.length?e.map((e=>({id:e.id,label:`${e.name}`,image:e.image}))):[]}_formatToolsForMultiSelect(e){if(!e||0===e.length)return[];const t=e.reduce(((e,t)=>{const s=t.mcp_listing.id;return e[s]||(e[s]=[]),e[s].push(t),e}),{}),s=[];for(const e in t){const i=t[e],n=i[0].mcp_listing;1===i.length?s.push({id:i[0].id,label:n.name,image:n.image_url,icon:"mcp"}):i.forEach((e=>{s.push({id:e.id,label:`${n.name} (${e.connection_name})`,image:n.image_url,icon:"mcp"})}))}return s}static create(e=null){const t=new ge(e);return t.show(),t}}class fe{constructor(e,t,s,n,a,o,r){this.triggerElement=e,this.onSelectCallback=n,this.onBrowseAllCallback=a,this.onCreateNewCallback=o,this.theme=i.A.theme,this.menuContainer=null,this.assistantListContainer=null,this.footerContainer=null,this.chatInstance=r,this.allAvailableAssistants=(t||[]).map((e=>({...e,selected:e.id===s}))),this.currentAssistantId=s,this.favoritedAssistants=this.allAvailableAssistants.filter((e=>e.is_favorited)),this.isDisplayingFavoritesView=this.favoritedAssistants.length>0,this.isLoading=!1,this._boundHandleOutsideClick=null,this.searchInput=null,this.highlightedIndex=-1,this.keyboardHighlightClass=this.theme.tableButtonSelectedBackground,this._boundHandleKeyDown=this._handleKeyDown.bind(this),this.init()}_ensurePinnedAssistants(e){const t=this.allAvailableAssistants.filter((e=>e.is_simtheory||e.is_workspace_default)),s=[...e];return t.forEach((e=>{s.some((t=>t.id===e.id))||s.push(e)})),s}_getAssistantsForCurrentView(e){const t=this.allAvailableAssistants.find((e=>e.selected));let s;if(e&&this.favoritedAssistants.length>0){if(s=[...this.favoritedAssistants],t&&!t.is_favorited){s.some((e=>e.id===t.id))||s.push(t)}s=this._ensurePinnedAssistants(s)}else s=[...this.allAvailableAssistants];return s.sort(((e,t)=>e.selected&&!t.selected?-1:t.selected&&!e.selected?1:e.name.localeCompare(t.name)))}async init(){if(this.menuContainer)return void this.removeExisting();this.menuContainer=document.createElement("div"),this.menuContainer.className=`assistant-selector-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-lg z-30 text-sm w-72 flex flex-col max-h-[calc(100vh-theme(space.16))] py-1 max-w-[260px] overflow-hidden`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="opacity 0.2s ease-in-out";const e=document.createElement("div");e.className="px-3 pt-1",this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search assistants",this.searchInput.className=`w-full p-2 rounded-md ${this.theme.inputBackground} ${this.theme.text} text-sm border-0 focus:outline-none focus:ring-0 focus:border-0 focus:shadow-none text-medium placeholder:${this.theme.text} placeholder:text-medium`;const t=o.A.name("search");if(t){const s=document.createElement("div");s.className="relative flex items-center";const i=document.createElement("div");i.className="absolute left-1.5 top-1/2 -translate-y-1/2 pointer-events-none";const n=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:`${this.theme.fadedText}`});i.appendChild(n.element),s.appendChild(i),s.appendChild(this.searchInput),e.appendChild(s),this.searchInput.className+=" pl-8"}else e.appendChild(this.searchInput);this.menuContainer.appendChild(e),this.assistantListContainer=document.createElement("div"),this.assistantListContainer.className=`flex-grow overflow-y-auto min-h-[250px] max-h-[250px] mt-1 pb-1 transition-opacity duration-200 ease-in-out scrollbar-thin ${this.theme.scrollbarThumb} ${this.theme.scrollbarTrack}`,this.menuContainer.appendChild(this.assistantListContainer);const s=this._createLoadingIndicator();this.assistantListContainer.appendChild(s),this.footerContainer=document.createElement("div"),this.footerContainer.className="flex-shrink-0",this.menuContainer.appendChild(this.footerContainer),document.body.appendChild(this.menuContainer),this._addCloseListener(),await this._loadAndRenderAssistants(s),this.searchInput.addEventListener("input",(()=>{const e=this.searchInput.value.toLowerCase();e.length>0?(this.isDisplayingFavoritesView=!1,this._loadAndRenderAssistants(null,this.allAvailableAssistants,e)):(this.isDisplayingFavoritesView=this.favoritedAssistants.length>0,this._loadAndRenderAssistants(null))})),this.searchInput.addEventListener("keydown",this._boundHandleKeyDown),this.menuContainer&&(this._positionMenu(),this.menuContainer.style.visibility="visible",requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.opacity="1",this._focusTimer&&clearTimeout(this._focusTimer),this._focusTimer=setTimeout((()=>{if(document.body.classList.contains("tab-dragging"))return;if(!this.menuContainer||!this.menuContainer.isConnected)return;const e=this.searchInput;e&&e.isConnected&&e.focus({preventScroll:!0})}),100))})))}_createLoadingIndicator(){const e=document.createElement("div");e.className=`px-3 py-2 text-center ${this.theme.fadedText} flex items-center justify-center`;const t=o.A.name("spinner"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"animate-spin mr-2"});return e.innerHTML=`${s.element.outerHTML}Loading assistants...`,e}_filterAssistants(e){if(!this.assistantListContainer||!this.menuContainer)return;const t=this._getNavigableItems();-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),this.highlightedIndex=-1;const s=this.assistantListContainer.querySelectorAll(".assistant-item.navigable-menu-item");let i=!1;s.forEach((t=>{if(!t.dataset.assistantName)return;const s=t.dataset.assistantName.toLowerCase().includes(e);t.style.display=s?"flex":"none",s&&(i=!0)}));const n=this.assistantListContainer.querySelector(".no-results-message");if(!i&&e.length>0)if(n)n.style.display="block";else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText} no-results-message`,e.textContent="No assistants found",this.assistantListContainer.appendChild(e)}else(n||i&&n)&&(n.style.display="none")}async _loadAndRenderAssistants(e,t=null,s=""){this.isLoading=!0;try{t||0!==this.favoritedAssistants.length||(this.isDisplayingFavoritesView=!1);const i=t?[...t]:this._getAssistantsForCurrentView(this.isDisplayingFavoritesView);if(e&&e.parentNode&&e.remove(),this.assistantListContainer.innerHTML="",i&&0!==i.length)i.forEach((e=>{const t=this._createAssistantItem(e);this.assistantListContainer.appendChild(t)})),s.length>0&&this._filterAssistants(s);else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText}`,e.textContent=this.isDisplayingFavoritesView?"No favorited assistants":"No assistants available",this.assistantListContainer.appendChild(e)}this.footerContainer.innerHTML="";const n=document.createElement("div");if(n.className=`border-t ${this.theme.tableDividerLine} mt-1 mb-1 mx-2`,this.footerContainer.appendChild(n),u.K.hasPermission("assistants:crud")){const e=this._createFooterItem({name:"Create new assistant",icon:"plus",onClick:()=>{this.onCreateNewCallback&&(this.remove(),ge.create())}});this.footerContainer.appendChild(e)}}catch(e){this.assistantListContainer.innerHTML="";const t=document.createElement("div");t.className=`px-3 py-2 text-center ${this.theme.errorText||"text-red-600"}`,t.textContent="Failed to load assistants.",this.assistantListContainer.appendChild(t),new c.y("Error loading assistants","error")}finally{this.isLoading=!1}}_createAssistantItem(e){const t=document.createElement("div"),s=e.selected?this.theme.tableButtonSelectedBackground:"";t.className=`px-3 py-1.5 flex items-center justify-between h-9 ${this.theme.tableMenuButtonHover} ${s} rounded mx-1 cursor-pointer group assistant-item navigable-menu-item`,t.dataset.assistantName=e.name,t.dataset.assistantId=e.id;const i=document.createElement("div");i.className="flex items-center gap-2 flex-grow min-w-0";const n=document.createElement("div");if(n.className="w-5 h-5 flex-shrink-0",e.image)n.innerHTML=`<img src="${e.image}" class="w-full h-full rounded-full object-cover" draggable="false" alt="${e.name}">`;else{const e=o.A.name("user");if(e){const t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-full h-full",additionalClasses:`${this.theme.iconColor}`});n.className+=` flex items-center justify-center ${this.theme.inputBackground} rounded-full p-0.5`,n.appendChild(t.element)}}i.appendChild(n);const a=document.createElement("div");a.className="flex flex-col overflow-hidden flex-grow";const l=document.createElement("span");l.className=`${this.theme.text} font-medium text-sm truncate`,l.textContent=e.name,l.title=e.name,a.appendChild(l),i.appendChild(a),t.appendChild(i);const d=document.createElement("div");d.className="ml-2 flex-shrink-0 flex items-center gap-1";let h=null,m=null;if(e.can_edit){const t=o.A.name("edit");if(t){h=document.createElement("div"),h.className=`p-1.5 rounded-md ${this.theme.tableMenuBackground} hover:${this.theme.tableMenuButtonHover} cursor-pointer flex items-center justify-center`;const s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-3 h-3",additionalClasses:`${this.theme.iconColor}`});h.appendChild(s.element),h.setAttribute("title","Edit Assistant"),d.appendChild(h),h.addEventListener("click",(t=>{t.stopPropagation(),ge.edit(e.id),this.remove()}))}}if(e.selected){const t=e.knowledge_graph_on?"stack":"clearStack",s=o.A.name(t);if(s){m=document.createElement("div");const t=e.knowledge_graph_on?"Memory is ON":"Memory is OFF";m.setAttribute("title",t),m.className=`p-1.5 rounded-md ${this.theme.tableMenuBackground} hover:${this.theme.tableMenuButtonHover} cursor-pointer flex items-center justify-center`;const i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-3 h-3",additionalClasses:`${this.theme.iconColor}`});m.appendChild(i.element),d.appendChild(m),m.addEventListener("click",(e=>{e.stopPropagation(),this.chatInstance&&"function"==typeof this.chatInstance.loadMemoryDialogue?(this.chatInstance.loadMemoryDialogue(),this.remove()):new c.y("Could not open memory settings.","error")}))}}if(d.hasChildNodes()){const s=u.K.isMobile();let i="";i=e.selected||s?"flex":"hidden group-hover:flex",d.classList.add(...i.split(" ")),t.appendChild(d)}return t.addEventListener("click",(t=>{h&&h.contains(t.target)||m&&m.contains(t.target)||(this.allAvailableAssistants.forEach((t=>{t.selected=t.id===e.id})),this.favoritedAssistants=this.allAvailableAssistants.filter((e=>e.is_favorited)),this.onSelectCallback&&(this.onSelectCallback(e),this.remove()))})),t}_createFooterItem({name:e,icon:t,onClick:s}){const i=document.createElement("div");i.className="px-3 py-2 flex items-center gap-3 rounded mx-1 cursor-pointer group navigable-menu-item",i.addEventListener("click",s);const n=o.A.name(t);if(n){const e=document.createElement("div");e.className="w-4 h-4 flex-shrink-0 flex items-center justify-center";const t=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-full h-full",additionalClasses:`${this.theme.primaryText} group-hover:${this.theme.primaryTextHover}`});e.appendChild(t.element),i.appendChild(e)}const a=document.createElement("span");return a.className=`${this.theme.primaryText} font-medium text-sm group-hover:${this.theme.primaryTextHover}`,a.textContent=e,a.title=e,i.appendChild(a),i}_getNavigableItems(){if(!this.menuContainer)return[];return[...Array.from(this.assistantListContainer.querySelectorAll(".navigable-menu-item.assistant-item")).filter((e=>"none"!==e.style.display)),...Array.from(this.footerContainer.querySelectorAll(".navigable-menu-item"))]}_handleKeyDown(e){const t=this._getNavigableItems();if("Escape"===e.key)return e.preventDefault(),void this.remove();if(t.length)switch(e.key){case"ArrowDown":e.preventDefault();let s=this.highlightedIndex+1;s>=t.length&&(s=0),this._updateHighlight(s,t);break;case"ArrowUp":e.preventDefault();let i=this.highlightedIndex-1;i<0&&(i=t.length-1),this._updateHighlight(i,t);break;case"Enter":e.preventDefault(),-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].click()}}_updateHighlight(e,t){-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),-1!==e&&t[e]&&(t[e].classList.add(this.keyboardHighlightClass),t[e].scrollIntoView({block:"nearest"})),this.highlightedIndex=e}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect(),t=this.menuContainer.offsetHeight,s=this.menuContainer.offsetWidth;let i=e.top-t-8,n=e.left;i<8||i+t>window.innerHeight-8&&e.bottom+8+t<=window.innerHeight-8?i=e.bottom+8:i+t>window.innerHeight-8&&(i=window.innerHeight-t-8),i<8&&(i=8),n<8?n=8:n+s>window.innerWidth-8&&(n=window.innerWidth-s-8),this.menuContainer.style.top=`${i+window.scrollY}px`,this.menuContainer.style.left=`${n+window.scrollX}px`}_addCloseListener(){this._boundHandleOutsideClick&&this._removeCloseListener(),setTimeout((()=>{this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),document.addEventListener("click",this._boundHandleOutsideClick,{capture:!0,once:!1})}),0)}_removeCloseListener(){this._boundHandleOutsideClick&&(document.removeEventListener("click",this._boundHandleOutsideClick,{capture:!0}),this._boundHandleOutsideClick=null)}_handleOutsideClick(e){const t=this.menuContainer&&!this.menuContainer.contains(e.target),s=this.triggerElement&&!this.triggerElement.contains(e.target);t&&s&&this.remove()}removeExisting(){document.querySelectorAll(".assistant-selector-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(){if(this._removeCloseListener(),this.searchInput&&this._boundHandleKeyDown&&this.searchInput.removeEventListener("keydown",this._boundHandleKeyDown),this.menuContainer){const e=this.menuContainer;this.menuContainer=null,this.assistantListContainer=null,this.footerContainer=null,this.searchInput=null,this.highlightedIndex=-1,e.style.opacity="0";const t=setTimeout((()=>{e.parentNode&&e.remove()}),250);e.addEventListener("transitionend",(s=>{"opacity"===s.propertyName&&(clearTimeout(t),e.parentNode&&e.remove())}),{once:!0})}}}class ve{constructor(e,t,s,n,a,o){this.triggerElement=e,this.onSelectCallback=n,this.onBrowseCatalogueCallback=a,this.onCancelCallback=o,this.theme=i.A.theme,this.menuContainer=null,this.modelListContainer=null,this.footerContainer=null,this.allAvailableModels=(t||[]).map((e=>({...e,selected:e.id===s}))),this.currentModelId=s,this.favoritedModels=this.allAvailableModels.filter((e=>e.is_favorite)),this.isDisplayingFavoritesView=this.favoritedModels.length>0,this.isLoading=!1,this._boundHandleOutsideClick=null,this.searchInput=null,this.highlightedIndex=-1,this.keyboardHighlightClass=this.theme.tableButtonSelectedBackground,this._boundHandleKeyDown=this._handleKeyDown.bind(this),this._focusTimer=null,this.init()}_prioritizeCurrentModel(e){if(!Array.isArray(e)||!e.length)return e;const t=e.findIndex((e=>e.id===this.currentModelId));if(t<=0)return e;const[s]=e.splice(t,1);return e.unshift(s),e}_getModelsForCurrentView(e){let t;if(e&&this.favoritedModels.length>0){t=[...this.favoritedModels];const e=this.allAvailableModels.find((e=>e.id===this.currentModelId));e&&!e.is_favorite&&(t.some((t=>t.id===e.id))||t.push(e)),t.sort(((e,t)=>(e.order??1/0)-(t.order??1/0)))}else t=[...this.allAvailableModels];return this._prioritizeCurrentModel(t)}async init(){if(this.menuContainer)return void this.removeExisting();this.menuContainer=document.createElement("div"),this.menuContainer.className=`model-selector-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-lg z-30 text-sm w-72 flex flex-col max-h-[calc(100vh-theme(space.16))] py-1 max-w-[260px] overflow-hidden`,this.menuContainer.style.visibility="hidden",this.menuContainer.style.opacity="0",this.menuContainer.style.transition="opacity 0.2s ease-in-out";const e=document.createElement("div");e.className="px-3 pt-1",this.searchInput=document.createElement("input"),this.searchInput.type="text",this.searchInput.placeholder="Search models",this.searchInput.className=`w-full p-2 rounded-md ${this.theme.inputBackground} ${this.theme.text} text-sm border-0 focus:outline-none focus:ring-0 focus:border-0 focus:shadow-none text-medium placeholder:${this.theme.text} placeholder:text-medium`;const t=o.A.name("search");if(t){const s=document.createElement("div");s.className="relative flex items-center";const i=document.createElement("div");i.className="absolute left-1.5 top-1/2 -translate-y-1/2 pointer-events-none";const n=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:`${this.theme.fadedText}`});i.appendChild(n.element),s.appendChild(i),s.appendChild(this.searchInput),e.appendChild(s),this.searchInput.className+=" pl-8"}else e.appendChild(this.searchInput);this.menuContainer.appendChild(e),this.modelListContainer=document.createElement("div"),this.modelListContainer.className=`flex-grow overflow-y-auto min-h-[250px] max-h-[250px] mt-1 pb-1 transition-opacity duration-200 ease-in-out scrollbar-thin ${this.theme.scrollbarThumb} ${this.theme.scrollbarTrack}`,this.menuContainer.appendChild(this.modelListContainer);const s=this._createLoadingIndicator();this.modelListContainer.appendChild(s),this.footerContainer=document.createElement("div"),this.footerContainer.className="flex-shrink-0",this.menuContainer.appendChild(this.footerContainer),document.body.appendChild(this.menuContainer),this._addCloseListener();const i=this._getModelsForCurrentView(this.isDisplayingFavoritesView);await this._loadAndRenderModels(s,i),this.searchInput.addEventListener("input",(()=>{const e=this.searchInput.value.toLowerCase();if(e.length>0)this.isDisplayingFavoritesView=!1,this._loadAndRenderModels(null,this.allAvailableModels,e);else if(this.favoritedModels.length>0){this.isDisplayingFavoritesView=!0;const e=this._getModelsForCurrentView(!0);this._loadAndRenderModels(null,e)}else this.isDisplayingFavoritesView=!1,this._loadAndRenderModels(null,this.allAvailableModels)})),this.searchInput.addEventListener("keydown",this._boundHandleKeyDown),this.menuContainer&&(this._positionMenu(),this.menuContainer.style.visibility="visible",requestAnimationFrame((()=>{this.menuContainer&&(this.menuContainer.style.opacity="1",this._focusTimer&&clearTimeout(this._focusTimer),this._focusTimer=setTimeout((()=>{if(document.body.classList.contains("tab-dragging"))return;if(!this.menuContainer||!this.menuContainer.isConnected)return;const e=this.searchInput;e&&e.isConnected&&e.focus({preventScroll:!0})}),100))})))}_createLoadingIndicator(){const e=document.createElement("div");e.className=`px-3 py-2 text-center ${this.theme.fadedText} flex items-center justify-center`;const t=o.A.name("spinner"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",additionalClasses:"animate-spin mr-2"});return e.innerHTML=`${s.element.outerHTML}Loading models...`,e}_filterModels(e){if(!this.modelListContainer||!this.menuContainer)return;const t=this._getNavigableItems();-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),this.highlightedIndex=-1;const s=this.modelListContainer.querySelectorAll(".model-item.navigable-menu-item");let i=!1;s.forEach((t=>{if(!t.dataset.modelName)return;const s=t.dataset.modelName.toLowerCase().includes(e);t.style.display=s?"flex":"none",s&&(i=!0)}));const n=this.modelListContainer.querySelector(".no-results-message");if(!i&&e.length>0)if(n)n.style.display="block";else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText} no-results-message`,e.textContent="No models found",this.modelListContainer.appendChild(e)}else(n||i&&n)&&(n.style.display="none")}async _loadAndRenderModels(e,t,s=""){this.isLoading=!0;try{const i=[...t];if(e&&e.parentNode&&e.remove(),this.modelListContainer.innerHTML="",i&&0!==i.length)i.forEach((e=>{const t=this._createModelItem(e);this.modelListContainer.appendChild(t)})),s.length>0&&this._filterModels(s);else{const e=document.createElement("div");e.className=`px-3 py-3 text-center ${this.theme.fadedText}`,e.textContent=this.isDisplayingFavoritesView?"No favorited models":"No models available",this.modelListContainer.appendChild(e)}if(""===this.footerContainer.innerHTML.trim()){const e=document.createElement("div");e.className=`border-t ${this.theme.tableDividerLine} mt-1 mb-1 mx-2`,this.footerContainer.appendChild(e);const t=this._createFooterItem({name:"Model catalogue",icon:"cube",onClick:()=>{this.onBrowseCatalogueCallback&&(this.onBrowseCatalogueCallback(),this.remove(!1))}});this.footerContainer.appendChild(t)}}catch(e){this.modelListContainer.innerHTML="";const t=document.createElement("div");t.className=`px-3 py-2 text-center ${this.theme.errorText||"text-red-600"}`,t.textContent="Failed to load models.",this.modelListContainer.appendChild(t),new c.y("Error loading models","error")}finally{this.isLoading=!1}}_createModelItem(e){const t=document.createElement("div"),s=e.selected?this.theme.tableButtonSelectedBackground:"";t.className=`px-3 py-1.5 flex items-center justify-between ${this.theme.tableMenuButtonHover} ${s} rounded mx-1 cursor-pointer group model-item navigable-menu-item`,t.dataset.modelName=e.name,t.dataset.modelId=e.id;const i=document.createElement("div");i.className="flex items-center gap-2 flex-grow min-w-0";const n=document.createElement("div");n.className="w-5 h-5 flex-shrink-0",e.image&&(n.innerHTML=`<img src="${e.image}" class="w-full h-full rounded-full object-cover" draggable="false" alt="${e.name}">`),i.appendChild(n);const a=document.createElement("div");a.className="flex flex-col overflow-hidden flex-grow";const o=document.createElement("span");return o.className=`${this.theme.text} font-medium text-sm truncate`,o.textContent=e.name,o.title=e.name,a.appendChild(o),i.appendChild(a),t.appendChild(i),t.addEventListener("click",(()=>{this.onSelectCallback&&(this.onSelectCallback(e),this.remove(!1))})),t}_createFooterItem({name:e,icon:t,onClick:s}){const i=document.createElement("div");i.className=`px-3 py-2 flex items-center gap-3 rounded mx-1 cursor-pointer group navigable-menu-item ${this.theme.tableMenuButtonHover}`,i.addEventListener("click",s);const n=o.A.name(t);if(n){const e=document.createElement("div");e.className="w-4 h-4 flex-shrink-0 flex items-center justify-center";const t=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-full h-full",additionalClasses:`${this.theme.primaryText} group-hover:${this.theme.primaryTextHover}`});e.appendChild(t.element),i.appendChild(e)}const a=document.createElement("span");return a.className=`${this.theme.primaryText} font-medium text-sm group-hover:${this.theme.primaryTextHover}`,a.textContent=e,a.title=e,i.appendChild(a),i}_getNavigableItems(){if(!this.menuContainer)return[];return[...Array.from(this.modelListContainer.querySelectorAll(".navigable-menu-item.model-item")).filter((e=>"none"!==e.style.display)),...Array.from(this.footerContainer.querySelectorAll(".navigable-menu-item"))]}_handleKeyDown(e){const t=this._getNavigableItems();if("Escape"===e.key)return e.preventDefault(),void this.remove(!0);if(t.length)switch(e.key){case"ArrowDown":e.preventDefault();let s=this.highlightedIndex+1;s>=t.length&&(s=0),this._updateHighlight(s,t);break;case"ArrowUp":e.preventDefault();let i=this.highlightedIndex-1;i<0&&(i=t.length-1),this._updateHighlight(i,t);break;case"Enter":e.preventDefault(),-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].click()}}_updateHighlight(e,t){-1!==this.highlightedIndex&&t[this.highlightedIndex]&&t[this.highlightedIndex].classList.remove(this.keyboardHighlightClass),-1!==e&&t[e]&&(t[e].classList.add(this.keyboardHighlightClass),t[e].scrollIntoView({block:"nearest"})),this.highlightedIndex=e}_positionMenu(){if(!this.menuContainer||!this.triggerElement)return;const e=this.triggerElement.getBoundingClientRect(),t=this.menuContainer.offsetHeight,s=this.menuContainer.offsetWidth;let i=e.top-t-8,n=e.left;i<8||i+t>window.innerHeight-8&&e.bottom+8+t<=window.innerHeight-8?i=e.bottom+8:i+t>window.innerHeight-8&&(i=window.innerHeight-t-8),i<8&&(i=8),n<8?n=8:n+s>window.innerWidth-8&&(n=window.innerWidth-s-8),this.menuContainer.style.top=`${i+window.scrollY}px`,this.menuContainer.style.left=`${n+window.scrollX}px`}_addCloseListener(){this._boundHandleOutsideClick&&this._removeCloseListener(),setTimeout((()=>{this._boundHandleOutsideClick=this._handleOutsideClick.bind(this),document.addEventListener("click",this._boundHandleOutsideClick,{capture:!0,once:!1})}),0)}_removeCloseListener(){this._boundHandleOutsideClick&&(document.removeEventListener("click",this._boundHandleOutsideClick,{capture:!0}),this._boundHandleOutsideClick=null)}_handleOutsideClick(e){const t=this.menuContainer&&!this.menuContainer.contains(e.target),s=this.triggerElement&&!this.triggerElement.contains(e.target);t&&s&&this.remove(!0)}removeExisting(){document.querySelectorAll(".model-selector-menu").forEach((e=>{e!==this.menuContainer&&e.remove()}))}remove(e=!0){this._removeCloseListener(),this.searchInput&&this._boundHandleKeyDown&&this.searchInput.removeEventListener("keydown",this._boundHandleKeyDown);const t=this.menuContainer;if(e&&this.onCancelCallback&&this.onCancelCallback(),this.menuContainer=null,this.modelListContainer=null,this.footerContainer=null,this.searchInput=null,this.highlightedIndex=-1,t){t.style.opacity="0";const e=setTimeout((()=>{t.parentNode&&t.remove()}),250);t.addEventListener("transitionend",(s=>{"opacity"===s.propertyName&&(clearTimeout(e),t.parentNode&&t.remove())}),{once:!0})}}}class ye{constructor(e,t,s,n){this.theme=i.A.theme,this.allModels=e||[],this.currentModelId=t,this.onSelectCallback=s,this.onCancelCallback=n,this.activeFilters={category:"all",bestForTag:null,aiLab:null},this.searchQuery="",this.container=null,this.catalogueEl=null,this.sidebarEl=null,this.contentEl=null,this.searchInput=null,this.mobileSearchInput=null,this.mobileMenuButton=null,this.sidebarVisible=!1,this.sidebarOverlay=null,this.mobileSidebar=null,this.sidebarCategories=[{id:"favorites",name:"Favorites",icon:"star"},{id:"all",name:"All models",icon:"cube"}],this.bestForTagsList=[],this.aiLabsList=[],this.isLoading=!1,this._boundHandleKeyDown=this.handleKeyDown.bind(this),this._boundHandleSearch=this.handleSearch.bind(this),this._boundToggleSidebar=this.toggleSidebar.bind(this),this._boundHandleResize=this.handleResize.bind(this),this.init()}init(){this.extractSidebarFiltersData(),this.renderShell(),this.renderSidebar(),this.renderContentAreaHeader(),this.refreshContent(),this.show(),window.addEventListener("resize",this._boundHandleResize),this.handleResize()}_toTitleCase(e){return e?e.toLowerCase().split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "):""}extractSidebarFiltersData(){const e=new Set,t=new Set,s=new Set;let i=!1,n=!1,a=!1,o=!1;this.allModels.forEach((r=>{r.ai_lab&&t.add(r.ai_lab),r.best_for_tags&&Array.isArray(r.best_for_tags)&&r.best_for_tags.forEach((t=>e.add(t))),r.categories&&Array.isArray(r.categories)&&r.categories.forEach((e=>s.add(e))),!0===r.reasoning&&(i=!0),!0===r.supports_vision&&(n=!0),!0===r.mcp_capable&&(a=!0),r.max_context_size&&r.max_context_size>199e3&&(o=!0),void 0===r.is_favorite&&(r.is_favorite=!1)})),this.bestForTagsList=Array.from(e).sort().map((e=>({id:e,name:this._toTitleCase(e)}))),this.aiLabsList=Array.from(t).sort().map((e=>({id:e,name:this._toTitleCase(e)}))),i&&s.add("reasoning"),o&&s.add("large_context"),n&&s.add("vision"),a&&s.add("mcp_capable");const r=new Set(this.sidebarCategories.map((e=>e.name.toLowerCase()))),l=["reasoning","large_context","vision","mcp_capable"];Array.from(s).sort(((e,t)=>{const s=l.indexOf(e),i=l.indexOf(t);return-1!==s&&-1!==i?s-i:-1!==s?-1:-1!==i?1:e.localeCompare(t)})).forEach((e=>{let t,s="tag";switch(e){case"reasoning":t="Reasoning",s="brain";break;case"large_context":t="Large Context",s="bookOpen";break;case"vision":t="Vision",s="eye";break;case"mcp_capable":t="Works with MCP",s="boxOpen";break;default:t=this._toTitleCase(e);const i=t.toLowerCase();i.includes("popular")?s="fire":i.includes("new")?s="sparkles":i.includes("experimental")?s="beaker":i.includes("recommended")&&(s="checkCircle")}r.has(t.toLowerCase())||(this.sidebarCategories.push({id:e,name:t,icon:s}),r.add(t.toLowerCase()))}))}renderShell(){this.container=document.createElement("div"),this.container.className="model-catalogue-container fixed inset-0 z-40 flex items-start justify-center backdrop-blur-xs pt-5 sm:pt-10",this.container.style.backgroundColor="rgba(0, 0, 0, 0.5)",this.container.addEventListener("click",(e=>{e.target===this.container&&this.close()})),this.catalogueEl=document.createElement("div"),this.catalogueEl.className=`${this.theme.modalBackground} w-[95vw] sm:w-[90vw] md:w-[85vw] lg:w-[80vw] h-[90dvh] sm:h-[80dvh] md:h-[75dvh] rounded-lg shadow-xl flex overflow-hidden ring-1 ${this.theme.ringColor} relative`;const e=document.createElement("div");e.className="absolute top-4 right-3 z-10";const t=o.A.name("tabClose"),s=new n.$({svgPathData:t.path,svgViewBox:t.viewBox,type:"focus",size:"small",iconHeightAndWidth:"h-6 w-6"});s.onClick((()=>this.close())),s.render(e),this.catalogueEl.appendChild(e),this.sidebarEl=document.createElement("div"),this.sidebarEl.className=`${this.theme.secondaryBackground} w-60 lg:w-64 flex-shrink-0 flex flex-col border-r ${this.theme.tableBorder} hidden md:flex`,this.sidebarEl.dataset.id="desktop-sidebar",this.contentEl=document.createElement("div"),this.contentEl.className="flex-1 flex flex-col overflow-hidden",this.contentEl.dataset.id="content-area",this.sidebarOverlay=document.createElement("div"),this.sidebarOverlay.className="absolute inset-0 bg-black bg-opacity-50 z-20 md:hidden hidden",this.sidebarOverlay.addEventListener("click",(()=>this.toggleSidebar(!1))),this.mobileSidebar=document.createElement("div"),this.mobileSidebar.className=`${this.theme.modalBackground} absolute inset-y-0 left-0 w-64 z-30 flex flex-col transform -translate-x-full transition-transform duration-300 ease-in-out md:hidden border-r ${this.theme.tableBorder}`,this.mobileSidebar.dataset.id="mobile-sidebar",this.catalogueEl.appendChild(this.sidebarEl),this.catalogueEl.appendChild(this.contentEl),this.catalogueEl.appendChild(this.sidebarOverlay),this.catalogueEl.appendChild(this.mobileSidebar),this.container.appendChild(this.catalogueEl),document.body.appendChild(this.container)}renderSidebar(){const e=(e,t,s,i,n=!1,a=!1)=>{if(0===t.length&&"category"!==s)return;const l=document.createElement("div");if(l.className="py-2",e){const t=document.createElement("h4");t.className=`px-4 pt-2 pb-1 text-xs ${this.theme.fadedText} uppercase tracking-wider`,n&&t.classList.add("font-semibold"),t.textContent=e,l.appendChild(t)}const c=document.createElement("ul");t.forEach((e=>{const t=document.createElement("li"),n=document.createElement("button");n.dataset.filterType=s,n.dataset.filterValue=e.id,n.className=`w-full text-left px-3 py-1.5 flex items-center gap-3 rounded-md mx-1 transition-colors duration-150 text-sm ${this.theme.text} ${this.theme.tableMenuButtonHover}`;const l=document.createElement("span");if(l.textContent=e.name,a)n.appendChild(l);else{const t=document.createElement("div");if(t.className="w-4 h-4 flex-shrink-0 flex items-center justify-center",e.icon){const s=o.A.name(e.icon);if(s){const e=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-full h-full",additionalClasses:`${this.theme.fadedText}`});t.appendChild(e.element)}}n.appendChild(t),n.appendChild(l)}n.addEventListener("click",(()=>{this.applyFilter(s,e.id),i===this.mobileSidebar&&this.toggleSidebar(!1)})),t.appendChild(n),c.appendChild(t)})),l.appendChild(c),i.appendChild(l)},t=t=>{if(t.innerHTML="",t===this.sidebarEl){const e=document.createElement("div");e.className=`p-3 border-b ${this.theme.tableBorder} sticky top-0 z-10`,e.style.backgroundColor=this.theme.secondaryBackground.startsWith("bg-")?`var(--${this.theme.secondaryBackground.substring(3)})`:this.theme.secondaryBackground;const s={type:"search",placeholder:"Search models...",size:"small",onChange:this._boundHandleSearch,value:this.searchQuery};this.searchInput=new d(s),this.searchInput.render(e),t.appendChild(e)}else{const e=document.createElement("div");e.className=`p-3 flex items-center justify-between border-b ${this.theme.tableBorder} flex-shrink-0`;const s=document.createElement("span");s.className=`font-medium ${this.theme.text}`,s.textContent="Filter Models";const i=o.A.name("tabClose"),a=new n.$({svgPathData:i.path,svgViewBox:i.viewBox,type:"icon",size:"small",iconHeightAndWidth:"h-5 w-5"});a.onClick((()=>this.toggleSidebar(!1))),e.appendChild(s),a.render(e),t.appendChild(e)}const s=document.createElement("div");s.className="flex-grow overflow-y-auto pb-4 overflow-x-hidden",e(null,this.sidebarCategories,"category",s,!1,!1),e("BEST FOR",this.bestForTagsList,"bestForTag",s,!0,!0),e("BY LAB",this.aiLabsList,"aiLab",s,!0,!0),t.appendChild(s),this.updateSidebarHighlighting()};t(this.sidebarEl),t(this.mobileSidebar)}renderContentAreaHeader(){if(!this.contentEl)return;const e=this.contentEl.querySelector('[data-id="content-header"]');e&&e.remove();const t=document.createElement("div");t.className=`p-3 sm:p-4 pr-12 border-b ${this.theme.tableBorder} ${this.theme.modalBackground} flex flex-wrap sm:flex-nowrap items-center gap-2 sm:gap-4`,t.dataset.id="content-header";const s=o.A.name("bars");this.mobileMenuButton=new n.$({svgPathData:s.path,svgViewBox:s.viewBox,type:"secondaryTransparent",size:"icon",iconHeightAndWidth:"w-5 h-5",additionalClasses:"md:hidden"}),this.mobileMenuButton.onClick(this._boundToggleSidebar);const i=document.createElement("h3");i.className=`font-medium ${this.theme.text} flex-1 text-base sm:text-lg`,i.dataset.id="content-title",i.textContent=this.getContentTitle();const a=document.createElement("div");a.className="w-full sm:w-auto md:hidden order-first sm:order-none mb-2 sm:mb-0";const r={type:"search",placeholder:"Search models...",size:"small",onChange:this._boundHandleSearch,value:this.searchQuery};this.mobileSearchInput=new d(r),this.mobileSearchInput.render(a),t.appendChild(this.mobileMenuButton.element),t.appendChild(i),t.appendChild(a),this.contentEl.firstChild?this.contentEl.insertBefore(t,this.contentEl.firstChild):this.contentEl.appendChild(t);let l=this.contentEl.querySelector('[data-id="content-body"]');l||(l=document.createElement("div"),l.className="flex-1 overflow-y-auto p-3 sm:p-4 md:p-6",l.dataset.id="content-body",this.contentEl.appendChild(l))}getContentTitle(){if(this.searchQuery)return"Search Results";if(this.activeFilters.category&&"all"!==this.activeFilters.category){const e=this.sidebarCategories.find((e=>e.id===this.activeFilters.category));return e?e.name:"Models"}if(this.activeFilters.bestForTag){const e=this.bestForTagsList.find((e=>e.id===this.activeFilters.bestForTag));return e?e.name:"Models"}if(this.activeFilters.aiLab){const e=this.aiLabsList.find((e=>e.id===this.activeFilters.aiLab));return e?e.name:"Models"}return"All Models"}applyFilter(e,t){this.activeFilters={category:null,bestForTag:null,aiLab:null},this.activeFilters[e]=t,this.searchQuery="",this.searchInput&&(this.searchInput.value=""),this.mobileSearchInput&&(this.mobileSearchInput.value=""),this.refreshContent(),this.updateSidebarHighlighting()}handleSearch(e){this.searchQuery=e.toLowerCase(),this.searchQuery&&(this.activeFilters={category:"all",bestForTag:null,aiLab:null},this.updateSidebarHighlighting()),this.refreshContent()}updateSidebarHighlighting(){const e=e=>{e.querySelectorAll("ul button").forEach((e=>{const t=e.dataset.filterType,s=e.dataset.filterValue;e.classList.remove(...this.theme.menuSelectedItem.split(" "),"font-semibold"),e.classList.add(...this.theme.tableMenuButtonHover.split(" ")),this.activeFilters[t]===s&&(e.classList.add(...this.theme.menuSelectedItem.split(" "),"font-semibold"),e.classList.remove(...this.theme.tableMenuButtonHover.split(" ")))}))};this.sidebarEl&&e(this.sidebarEl),this.mobileSidebar&&e(this.mobileSidebar)}getFilteredModels(){let e=[...this.allModels];if(this.activeFilters.category&&"all"!==this.activeFilters.category){const t=this.activeFilters.category;e="favorites"===t?e.filter((e=>e.is_favorite)):"reasoning"===t?e.filter((e=>!0===e.reasoning)):"large_context"===t?e.filter((e=>e.max_context_size&&e.max_context_size>199e3)):"vision"===t?e.filter((e=>!0===e.supports_vision)):"mcp_capable"===t?e.filter((e=>!0===e.mcp_capable)):e.filter((e=>e.categories&&e.categories.includes(t)))}return this.activeFilters.bestForTag&&(e=e.filter((e=>e.best_for_tags&&e.best_for_tags.includes(this.activeFilters.bestForTag)))),this.activeFilters.aiLab&&(e=e.filter((e=>e.ai_lab===this.activeFilters.aiLab))),this.searchQuery&&(e=e.filter((e=>e.name.toLowerCase().includes(this.searchQuery)||e.description&&e.description.toLowerCase().includes(this.searchQuery)||e.ai_lab&&e.ai_lab.toLowerCase().includes(this.searchQuery)))),e}refreshContent(){const e=this.contentEl?.querySelector('[data-id="content-title"]');e&&(e.textContent=this.getContentTitle());const t=this.contentEl?.querySelector('[data-id="content-body"]');if(!t)return this.renderContentAreaHeader(),this.refreshContent();t.innerHTML="";const s=this.getFilteredModels();if(0===s.length){const e=document.createElement("div");e.className="col-span-1 text-center py-8 sm:py-12 flex flex-col items-center justify-center h-full";const s=document.createElement("div");s.className=`text-3xl sm:text-4xl mb-3 ${this.theme.iconColor}`;let i="boxOpen",n=this.searchQuery?"No models match your search.":"No models found for this filter.";"favorites"!==this.activeFilters.category||this.searchQuery||(i="star",n="No favorites yet. Favorite a model to see it here.");const a=o.A.name(i),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-12 h-12 sm:w-16 sm:h-16"});s.appendChild(l.element);const c=document.createElement("p");return c.className=`${this.theme.fadedText} text-base`,c.textContent=n,e.appendChild(s),e.appendChild(c),void t.appendChild(e)}const i=document.createElement("div");i.className="grid grid-cols-1 gap-3 sm:gap-4",s.forEach((e=>{i.appendChild(this.createModelCard(e))})),t.appendChild(i)}createModelCard(e){const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} overflow-hidden shadow-sm hover:shadow-md transition-shadow cursor-pointer relative`,t.classList.add(...this.theme.ringHover.split(" ")),t.addEventListener("click",(()=>{this.onSelectCallback&&(this.onSelectCallback(e),this.close())}));const s=document.createElement("div");s.className="p-3 sm:p-4 flex flex-col h-full";const i=document.createElement("div");i.className=`absolute top-2 right-2 z-10 p-1 rounded-full cursor-pointer transition-colors ${this.theme.tableMenuButtonHover}`,i.setAttribute("role","button"),i.setAttribute("aria-label",e.is_favorite?"Remove from favorites":"Add to favorites"),i.title=e.is_favorite?"Remove from favorites":"Add to favorites";const n=e.is_favorite?"star":"starOutline",a=o.A.name(n);if(a){const t=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-5 h-5",colorClass:e.is_favorite?"text-yellow-400":`${this.theme.fadedText} group-hover:text-yellow-400`});i.appendChild(t.element)}i.addEventListener("click",(t=>{t.stopPropagation(),this.toggleFavorite(e,i)})),t.appendChild(i);const l=document.createElement("div");l.className="flex items-center mb-2 sm:mb-3";const c=document.createElement("div");c.className="w-10 h-10 sm:w-12 sm:h-12 rounded-md overflow-hidden mr-2 sm:mr-3 flex-shrink-0 drop-shadow-sm";const d=document.createElement("img");d.src=e.image,d.alt=`${e.name} logo`,d.className="w-full h-full object-contain",c.appendChild(d);const h=document.createElement("div");h.className="flex-1 min-w-0";const m=document.createElement("h5");m.className=`font-medium text-base ${this.theme.tablePrimaryColumnText} line-clamp-2`,m.textContent=e.name;const u=document.createElement("p");u.className=`${this.theme.fadedText} text-xs`,u.textContent=`by ${e.ai_lab||"Unknown Lab"}`,h.appendChild(m),h.appendChild(u),l.appendChild(c),l.appendChild(h);const p=document.createElement("div");p.className="flex flex-wrap gap-1.5 mt-2 mb-2 sm:mb-2 items-center";const g=(e,t=null,s="")=>{const i=document.createElement("span");if(i.className=`${this.theme.skillTag} text-xs px-2 py-0.5 rounded-full flex items-center gap-1 ${s}`,t){const e=o.A.name(t);if(e){const t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-3 h-3"});i.appendChild(t.element)}}const n=document.createElement("span");return n.textContent=e,i.appendChild(n),i};if(e.mcp_capable&&p.appendChild(g("Works with MCP","boxOpen")),e.supports_vision&&p.appendChild(g("Vision","eye")),e.max_context_size){let t;const s=e.max_context_size;if(s>=1e6){t=`${parseFloat((s/1e6).toFixed(1))}M`}else t=s>=1e3?`${Math.floor(s/1e3)}k`:`${s}`;p.appendChild(g(`${t} context`,"stack"))}return e.reasoning&&p.appendChild(g("Reasoning","brain")),s.appendChild(l),s.appendChild(p),t.appendChild(s),t}async toggleFavorite(e,t){e.is_favorite=!e.is_favorite,t.setAttribute("aria-label",e.is_favorite?"Remove from favorites":"Add to favorites"),t.title=e.is_favorite?"Remove from favorites":"Add to favorites";const s=e.is_favorite?"star":"starOutline",i=o.A.name(s);if(i&&t){const s=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-5 h-5",colorClass:e.is_favorite?"text-yellow-400":`${this.theme.fadedText} group-hover:text-yellow-400`});t.innerHTML="",t.appendChild(s.element)}"favorites"===this.activeFilters.category&&this.refreshContent();try{await u.K.toggleModelFavorite(e.id,e.is_favorite),window.initial_models=window.initial_models.map((t=>(t.id===e.id&&(t.is_favorite=e.is_favorite),t)))}catch(s){e.is_favorite=!e.is_favorite,t.setAttribute("aria-label",e.is_favorite?"Remove from favorites":"Add to favorites"),t.title=e.is_favorite?"Remove from favorites":"Add to favorites";const i=e.is_favorite?"star":"starOutline",n=o.A.name(i);if(n&&t){const s=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-6 h-6 sm:w-7 sm:h-7",additionalClasses:e.is_favorite?"text-yellow-400":`${this.theme.fadedText} group-hover:text-yellow-400`});t.innerHTML="",t.appendChild(s.element)}new c.y("Could not update favorite status.","error")}}toggleSidebar(e=null){const t=null!==e?e:!this.sidebarVisible;this.sidebarVisible=t,this.mobileSidebar&&this.sidebarOverlay&&(t?(this.mobileSidebar.classList.remove("-translate-x-full"),this.mobileSidebar.classList.add("translate-x-0"),this.sidebarOverlay.classList.remove("hidden")):(this.mobileSidebar.classList.remove("translate-x-0"),this.mobileSidebar.classList.add("-translate-x-full"),this.sidebarOverlay.classList.add("hidden")))}handleResize(){window.innerWidth>=768&&this.sidebarVisible&&this.toggleSidebar(!1)}handleKeyDown(e){"Escape"===e.key&&this.close()}show(){this.container&&(document.addEventListener("keydown",this._boundHandleKeyDown),document.body.classList.add("overflow-hidden"),this.container.style.opacity="0",this.catalogueEl.style.transform="scale(0.95)",this.catalogueEl.style.opacity="0",this.container.style.display="flex",requestAnimationFrame((()=>{this.container.style.opacity="1",this.catalogueEl.style.opacity="1",this.catalogueEl.style.transform="scale(1)",this.container.style.transition="opacity 0.2s ease-out",this.catalogueEl.style.transition="opacity 0.2s ease-out, transform 0.2s ease-out"})))}close(){this.container&&(document.removeEventListener("keydown",this._boundHandleKeyDown),window.removeEventListener("resize",this._boundHandleResize),this.container.style.opacity="0",this.catalogueEl.style.opacity="0",this.catalogueEl.style.transform="scale(0.95)",setTimeout((()=>{document.body.classList.remove("overflow-hidden"),this.destroy(),this.onCancelCallback&&this.onCancelCallback()}),200))}destroy(){this.container?.parentNode&&this.container.parentNode.removeChild(this.container),this.container=null,this.catalogueEl=null,this.sidebarEl=null,this.contentEl=null,this.searchInput=null,this.mobileSearchInput=null,this.mobileMenuButton=null,this.mobileSidebar=null,this.sidebarOverlay=null,document.removeEventListener("keydown",this._boundHandleKeyDown),window.removeEventListener("resize",this._boundHandleResize),document.body.classList.remove("overflow-hidden")}}class we extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._minimize=!1,this._mode="",this._language="",this._title="",this._code="",this.messageId="",this.blockId="",this.versions=[],this.selectedVersion=0,this.highlightPending=!1,this.published=!1,this.published_url="",this.published_version=null,this.isUserDetached=!0,this.scrollContainer=null,this.undoStack=[],this.redoStack=[],this.focusInstance=null,this.autoTitleSetAttempted=!1,this.previewIframe=null,this.lastConsoleMessageTime=0,this.consoleMessageCount=0,this.consoleVisible=!1,this.consoleHeight=400,this.searchVisible=!1,this.searchMatches=[],this.currentMatch=0,this.searchBar=null,this.validForPreview=!1,this.validHTML=!1,this.validSVG=!1,this.isCodeTabActive=!0,this.isRendering=!1,this.pendingContentUpdate=null,this.highlightPending=!1,this.lastHighlightTime=0,this.highlightTimer=null,this.scrollRAF=null,this.previewUpdateTimeout=null,this.finalUpdateTimeout=null,this.iframeMessageListenerAdded=!1,this.debouncedSave=this.debounce(this.save.bind(this),1e3),this.debouncedLoadVersions=this.debounce(this.loadVersions.bind(this),1e3),this.handleScroll=this.handleScroll.bind(this),this.handleSelection=this.handleSelection.bind(this),this.handleIframeMessage=this.handleIframeMessage.bind(this),this.handleInput=this.handleInput.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleVisibilityChange=this.handleVisibilityChange.bind(this),this.SELECTION_START_MARK="",this.SELECTION_END_MARK="",this._pendingSelectionSnapshot=null}debounce(e,t){let s;return function(...i){clearTimeout(s),s=setTimeout((()=>e.apply(this,i)),t)}}debounceLoadVersions(){this._debounceTimeout||(this._debounceTimeout=null),clearTimeout(this._debounceTimeout),this._debounceTimeout=setTimeout((()=>{this.loadVersions()}),1e3)}static get observedAttributes(){return["file-title","language","mode","minimize","code","data-streaming","code-load","readonly","block-id","message-id","chat-id"]}shouldDeferHighlight(){return"focus"!==this._mode&&!this.contains(document.activeElement)}get minimize(){return this._minimize}set minimize(e){!0===e||"true"===e||""===e?(this._minimize=!0,this.setAttribute("minimize","true")):(this._minimize=!1,this.setAttribute("minimize","false"))}get mode(){return this.DOCUMENT_FRAGMENT_NODE}set mode(e){this._mode!==e&&(this._mode=e,this.setAttribute("mode",e))}get title(){return this._title}set title(e){this._title=e,this.setAttribute("file-title",e)}get language(){return this._language}set language(e){this._language!==e&&(this._language=e,this.setAttribute("language",e))}set code(e){this._code=e,this.updateCodeAttribute(),this.updateCodeContent(e),this.setTitleFromContent(),this.debounceLoadVersions()}updateCodeContent(e){if(!this.codeBlock)return;const t=this.createSelectionSnapshotForNewContent(e);this._code=e,this.updateCodeAttribute(),this.showLoadingOverlay(!0),this.codeBlock.textContent=this._code,this.applyHighlighting(t),"html"!==this._language&&"svg"!==this._language||this.isCodeTabActive?requestAnimationFrame((()=>{this.removeLoadingOverlay()})):this.updatePreviewIframe()}handleVersionUpdate(e){const{code:t,version:s}=e,i=this.versions.findIndex((e=>e.version===s));-1!==i?this.versions[i].code=t:this.versions.push({version:s,code:t,url:null,title:this.title||"Untitled"}),this.populateVersions(this.versions,0),setTimeout((()=>{this.removeLoadingOverlay()}),500)}get code(){return this.codeBlock?this.codeBlock.textContent:this.initialContent}set streaming(e){!0===e||"true"===e?(this._streaming=!0,this._titleSet=!1):this._streaming=!1}get streaming(){return this._streaming}set readonly(e){this._readonly=!0===e||"true"===e}get readonly(){return this._readonly}updateCodeAttribute(){const e=btoa(encodeURIComponent(this._code));this.setAttribute("code",e)}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"file-title":this.title=s;break;case"language":s&&(this.language=s);break;case"mode":this.mode=s;break;case"minimize":this.minimize=s;break;case"code":this.code=decodeURIComponent(atob(s)),this.debounceLoadVersions();break;case"data-streaming":this.streaming="true"===s,"true"!==t||"false"!==s&&s||this.checkAndOpenFocus();break;case"code-load":this.showLoadingOverlay();break;case"block-id":this.blockId=s;break;case"message-id":s&&(this.messageId=s);break;case"chat-id":s&&(this.chatId=s);break;case"readonly":this.readonly=s}}async loadVersions(){try{const e=await g.G.postData("/chat/get-code-versions/",{chat_message_id:this.messageId}),t=this.selectedVersion;if(!e.versions)return;const s=e.versions.map((e=>({version:e.version,code:e.file_content,url:e.url,title:e.title})));this.published=e.published,this.published_url=e.published_url,this.published_title=e.published_title,this.published_version=e.published_version,this.populateVersions(s,t)}catch(e){}}async connectedCallback(){const e=this.getAttribute("code")||"";this._code=decodeURIComponent(atob(e)),this.innerHTML="",this.chatId=this.getAttribute("chat-id"),!this.chatId&&ke.activeChat&&(this.chatId=ke.activeChat.chat_id,this.setAttribute("chat-id",this.chatId)),"focus"!==this._mode&&(this.marginWrapper=document.createElement("div"),this.marginWrapper.classList.add("code-block-margin-wrapper","my-2"),this.appendChild(this.marginWrapper)),this.wrapper=document.createElement("div"),this.wrapper.classList.add("rounded-t-lg","rounded-b-md"),"focus"===this._mode?(this.wrapper.classList.add("h-full","flex","flex-col"),this.appendChild(this.wrapper)):this.marginWrapper.appendChild(this.wrapper),this.validForPreview=!1,this.isValidForPreview(this._code)&&(this.validForPreview=!0),this.renderToolbar(),this.renderCodeEditor();const t=this.closest("markdown-content");t&&(this.streaming=t.isStreaming,this.setAttribute("data-streaming",this.streaming.toString())),await this.loadVersions(),document.addEventListener("visibilitychange",this.handleVisibilityChange)}disconnectedCallback(){this.scrollContainer&&this.scrollContainer.removeEventListener("scroll",this.handleScroll),this.codeBlock&&(this.codeBlock.removeEventListener("mouseup",this.handleSelection),this.codeBlock.removeEventListener("input",this.handleInput),this.codeBlock.removeEventListener("keydown",this.handleKeyDown)),this._documentMousedownHandler&&(document.removeEventListener("mousedown",this._documentMousedownHandler),this._documentMousedownHandler=null),this.iframeMessageListenerAdded&&(window.removeEventListener("message",this.handleIframeMessage),this.iframeMessageListenerAdded=!1),document.removeEventListener("visibilitychange",this.handleVisibilityChange),clearTimeout(this.finalUpdateTimeout),clearTimeout(this.previewUpdateTimeout),clearTimeout(this.highlightTimer),cancelAnimationFrame(this.scrollRAF),this.previewIframe=null,this.codeBlock=null,this.scrollContainer=null,this.consoleContainer=null,this.floatingMenu=null}handleStreaming(){if(!this._streaming){if(!this._language&&this._code){const e=this._code.trim();(e.startsWith("<!")||e.startsWith("<html")||e.startsWith("<head")||e.startsWith("<")&&e.includes("html"))&&(this._language="html",this.validForPreview=!0)}return this._titleSet||"html"!==this._language||this.title||this.setTitleFromContent(),void this.checkAndOpenFocus()}}setTitleFromContent(){const e=decodeURIComponent(atob(this.getAttribute("code")||"")).match(/<title>(.*?)<\/title>/i);e&&(this.title=e[1].trim(),this._titleSet=!0)}renderToolbar(){const e={title:this._title,mode:this._mode,simpleModeTitle:this._language,extension:we.getLanguageFileExtension(this._language,!0),fileMenu:[{type:"item",label:"Save",onClick:()=>{this.save(!1,!1,!0)}},{type:"item",label:"Save as new version",onClick:()=>{this.saveNewVersion(!1,!0)}},{type:"divider"},{type:"item",label:"Download",onClick:()=>this.download()},{type:"divider"},...this.isPreviewValid()?[{type:"item",label:"Share",onClick:()=>this.getPublishStatus(this.blockId)}]:[]],editMenu:[{type:"item",label:"Undo",onClick:()=>this.undo()},{type:"item",label:"Redo",onClick:()=>this.redo()},{type:"divider"},{type:"item",label:"Cut",onClick:()=>{this.cutSelection()}},{type:"item",label:"Copy",onClick:()=>{this.copySelection()}},{type:"item",label:"Paste",onClick:()=>{this.paste()}},{type:"item",label:"Select All",onClick:()=>{this.selectAll()}}],viewMenu:[...this.isPreviewValid()?[{type:"item",label:"Enter full screen",onClick:()=>this.openFullScreen()},{type:"divider"}]:[],{type:"item",label:"Word wrap",onClick:()=>{this.toggleCodeWrap()}},...this.isPreviewValid()?[{type:"item",label:"Developer console",onClick:()=>{this.toggleConsole()}}]:[],...this.isPreviewValid()?[{type:"divider"},{type:"item",label:"App data settings",onClick:()=>this.showAppDataSettings(this.blockId)}]:[]],quickActions:[{type:"icon",icon:"copy",hoverText:"Copy",onClick:()=>{this.copyToClipboard()}}],onTitleChange:e=>{this.title=e},onEnterFocus:()=>{this.streaming||this.handleFocus()},onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus(),this.cleanup()}};this.focusWindowMenu=new D(e),this.menuElement=this.focusWindowMenu.create(),this.wrapper.appendChild(this.menuElement)}toggleCodeWrap(){this.codeBlock.classList.contains("whitespace-pre-wrap")?(this.codeBlock.classList.remove("whitespace-pre-wrap"),this.codeBlock.classList.add("whitespace-pre"),this.scrollContainer.classList.remove("overflow-y-auto"),this.scrollContainer.classList.add("overflow-auto")):(this.codeBlock.classList.remove("whitespace-pre"),this.codeBlock.classList.add("whitespace-pre-wrap"),this.scrollContainer.classList.remove("overflow-auto"),this.scrollContainer.classList.add("overflow-y-auto")),this.save()}renderCodeEditor(){this.codeContainer=document.createElement("div"),this.codeContainer.classList="relative w-full max-w-full overflow-hidden flex flex-col",this.contentContainer=document.createElement("div"),this.contentContainer.classList="relative flex flex-grow overflow-hidden","focus"===this._mode?this.codeContainer.style.height="calc(var(--vh)*100 - 83px)":(u.K.isMobile()?this.codeContainer.classList.add("min-h-[40px]","max-h-[270px]","rounded-b-md"):this.codeContainer.classList.add("min-h-[40px]","max-h-[650px]","rounded-b-md"),this.codeContainer.classList.add("rounded-b-md")),this.scrollContainer=document.createElement("div"),this.scrollContainer.classList="w-full flex flex-grow scroll-container overflow-auto",this.scrollContainer.addEventListener("scroll",this.handleScroll,{passive:!0}),this.preBlock=document.createElement("pre"),this.preBlock.classList="text-sm w-full h-full","focus"===this._mode&&this.preBlock.classList.add("flex"),this.preBlock.classList.add("code-block-content"),this.codeBlock=document.createElement("code"),"focus"===this._mode?this.codeBlock.contentEditable=!0:this.codeBlock.contentEditable=!1,this.codeBlock.spellcheck=!1,this.codeBlock.className=this._language?`language-${this._language} hljs`:"hljs",this.codeBlock.classList="w-full leading-5 focus:outline-none focus:ring-0 block flex flex-grow";window.user.preferences.wrapCodeBlocks||!1?this.codeBlock.classList.add("whitespace-pre-wrap"):this.codeBlock.classList.add("whitespace-pre"),this.codeBlock.addEventListener("focus",(()=>this.runPendingHighlight())),this.codeBlock.addEventListener("click",(()=>this.runPendingHighlight())),this.codeBlock.textContent=this._code||"","focus"===this._mode&&(this.createFloatingMenu(),this.codeBlock.addEventListener("mouseup",this.handleSelection),this._documentMousedownHandler=e=>{e.target&&this.floatingMenu&&this.codeBlock&&(this.floatingMenu.contains(e.target)||this.codeBlock.contains(e.target)||this.hideFloatingMenu())},document.addEventListener("mousedown",this._documentMousedownHandler)),this.initialState={content:this.codeBlock.textContent,cursorPosition:0},this.undoStack.push(this.initialState),this.codeBlock.addEventListener("input",(()=>this.handleInput())),this.codeBlock.addEventListener("keydown",(e=>this.handleKeyDown(e))),this.preBlock.appendChild(this.codeBlock),this.scrollContainer.appendChild(this.preBlock),this.contentContainer.appendChild(this.scrollContainer),this.codeContainer.appendChild(this.contentContainer),"focus"===this._mode&&(this.createConsoleContainer(),this.statusBar=this.createStatusBar(),this.codeContainer.appendChild(this.consoleContainer),this.codeContainer.appendChild(this.statusBar),this.codeContainer.style.position="relative",this.consoleContainer.style.position="absolute",this.consoleContainer.style.bottom="0",this.consoleContainer.style.left="0",this.consoleContainer.style.right="0"),this.wrapper.appendChild(this.codeContainer),this.applyHighlighting(),requestAnimationFrame((()=>{"focus"===this._mode&&this.validForPreview&&this.showPreview(!1)}))}createStatusBar(){this.statusBarItems=document.createElement("div"),this.statusBarItems.classList=`flex justify-between items-center w-full py-1.5 ${this.theme.focusBackground} ${this.theme.focusMenuTextColor}  min-h-[50px] max-h-[50px] h-[50px] z-20`,this.lhsItems=document.createElement("div"),this.lhsItems.classList="flex-1 flex justify-start items-center px-2 gap-2 lg:gap-4",this.centerItems=document.createElement("div"),this.centerItems.classList="flex-1 flex justify-center",this.rhsItems=document.createElement("div"),this.rhsItems.classList="flex-1 flex justify-end items-center px-2",this.versionControl=document.createElement("div"),this.versionControl.classList="flex items-center",this.leftArrowContainer=document.createElement("div"),this.leftArrowButton=document.createElement("button"),this.leftArrowButton.classList.add("text-sm",...this.theme.focusMenuHover.split(" "),"rounded-md","py-1","px-1","flex","items-center","justify-center","cursor-pointer");const e=o.A.name("chevronLeft"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4"});this.leftArrowButton.appendChild(t.element),this.leftArrowButton.addEventListener("click",(()=>this.showPreviousVersion())),this.leftArrowContainer.appendChild(this.leftArrowButton),this.middleLabel=document.createElement("div"),this.middleLabel.classList="text-sm w-[40px] truncate lg:w-auto lg:max-w-[80px] px-0.5",this.versions&&this.versions.length>0?this.middleLabel.textContent=`Version ${this.versions[0].version}`:this.middleLabel.textContent="Version 1",this.rightArrowContainer=document.createElement("div"),this.rightArrowButton=document.createElement("button"),this.rightArrowButton.classList.add("text-sm",...this.theme.focusMenuHover.split(" "),"rounded-md","py-1","px-1","flex","items-center","justify-center","cursor-pointer");const s=o.A.name("chevronRight"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4"});if(this.rightArrowButton.appendChild(i.element),this.rightArrowButton.addEventListener("click",(()=>this.showNextVersion())),this.rightArrowContainer.appendChild(this.rightArrowButton),this.versionControl.appendChild(this.leftArrowContainer),this.versionControl.appendChild(this.middleLabel),this.versionControl.appendChild(this.rightArrowContainer),this.lhsItems.appendChild(this.versionControl),this.validForPreview){this.refreshButtonDiv=document.createElement("div"),this.refreshButtonDiv.classList="hidden",this.refreshButton=document.createElement("button"),this.refreshButton.classList.add("text-sm",...this.theme.focusMenuHover.split(" "),"rounded-md","py-1","px-2","cursor-pointer");const e=document.createElement("div");e.classList.add("flex","items-center","gap-1");const t=o.A.name("rotate"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});e.appendChild(s.element);const i=document.createElement("div");i.classList.add("select-none","hidden","sm:block"),i.textContent="Refresh",e.appendChild(i),this.refreshButton.appendChild(e),this.refreshButton.addEventListener("click",(()=>{this._code=this.codeBlock.textContent,this.updatePreviewIframe(),this.clearConsole(),this.previewIframe.contentWindow.focus()})),this.refreshButtonDiv.appendChild(this.refreshButton),this.lhsItems.appendChild(this.refreshButtonDiv),this.codeAndPreviewTab=new w({tabs:[{title:"Preview",value:"preview",selected:!0},{title:"Code",value:"code",selected:!1}],onTabChange:e=>{"preview"===e?this.showPreview():this.showCode()}}),this.codeTab=document.createElement("div"),this.codeAndPreviewTab.render(this.codeTab),this.centerItems.appendChild(this.codeTab),this.consoleToggleButton=document.createElement("button"),this.consoleToggleButton.classList.add("text-sm",...this.theme.focusMenuHover.split(" "),"rounded-md","py-1","px-2","cursor-pointer");const n=document.createElement("div");n.classList.add("flex","items-center","gap-1");const a=o.A.name("terminal"),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4"});n.appendChild(l.element);const c=document.createElement("div");c.textContent="Console",c.classList.add("select-none"),n.appendChild(c),this.consoleCountDiv=document.createElement("div"),this.consoleCountDiv.classList.add("flex","justify-center","align-middle","items-center","text-xs",...this.theme.toastError.split(" "),"rounded-full","w-5","h-5","hidden"),this.consoleCountDiv.textContent="0",n.appendChild(this.consoleCountDiv),this.consoleToggleButton.appendChild(n),this.consoleToggleButton.addEventListener("click",(()=>this.toggleConsole())),this.consoleToggleButton.style.display="none",this.rhsItems.appendChild(this.consoleToggleButton)}return this.statusBarItems.appendChild(this.lhsItems),this.statusBarItems.appendChild(this.centerItems),this.statusBarItems.appendChild(this.rhsItems),this.updateVersionUI(),this.statusBarItems}populateVersions(e,t=null){this.versions=e.sort(((e,t)=>{const s="string"==typeof e.version?parseInt(e.version,10):e.version;return("string"==typeof t.version?parseInt(t.version,10):t.version)-s})),this.versions.length>0?(null!==t&&t<this.versions.length?this.selectedVersion=t:this.selectedVersion=0,this.showVersion(this.selectedVersion)):this.selectedVersion=void 0,this.updateVersionUI()}addVersion(e,t){this.versions.push({version:e,code:t}),this.updateVersionUI()}showVersion(e){void 0===e||e>=this.versions.length||(this.saveCurrentVersion(),this.selectedVersion=e,this._code=this.versions[e].code,this.updateCodeContent(this._code),this.updateCodeAttribute(),this.applyHighlighting(),this.isCodeTabActive||this.updatePreviewIframe(),this.updateVersionUI())}async saveCurrentVersion(e=!1){if(this.codeBlock&&void 0!==this.selectedVersion&&this.versions&&this.versions[this.selectedVersion]&&(this.versions[this.selectedVersion].code=this.codeBlock.textContent,e)){const e=await g.G.postData("/chat/save-version/",{chat_message_id:this.messageId,version:this.versions[this.selectedVersion].version,code:this.versions[this.selectedVersion].code,wants_new_version:!1});e.success?this.showToast(`Version ${e.version} saved successfully`,"success"):this.showToast("Failed to save version","error")}}async saveNewVersion(){if(void 0!==this.selectedVersion&&this.versions&&this.versions[this.selectedVersion]){this.versions[this.selectedVersion].code=this.codeBlock.textContent;const e=await g.G.postData("/chat/save-version/",{chat_message_id:this.messageId,version:this.versions[this.selectedVersion].version,code:this.versions[this.selectedVersion].code,wants_new_version:!0});e.success?(this.addVersion(e.version,e.code),this.populateVersions(this.versions,0),this.showToast(`New version ${e.version} saved successfully`,"success")):this.showToast("Failed to save new version","error")}}getCurrentVersion(){return void 0!==this.selectedVersion&&this.versions&&this.versions[this.selectedVersion]?this.versions[this.selectedVersion]:null}updateVersionUI(){this.versionControl&&(0!==this.versions.length&&void 0!==this.selectedVersion?(this.versionControl.classList.remove("hidden"),this.middleLabel.textContent=`Version ${this.versions[this.selectedVersion].version}`,this.leftArrowButton.disabled=this.selectedVersion===this.versions.length-1,this.rightArrowButton.disabled=0===this.selectedVersion,this.leftArrowButton.classList.add(this.selectedVersion===this.versions.length-1?"opacity-50":"opacity-100"),this.leftArrowButton.classList.remove(this.selectedVersion===this.versions.length-1?"opacity-100":"opacity-50"),this.rightArrowButton.classList.add(0===this.selectedVersion?"opacity-50":"opacity-100"),this.rightArrowButton.classList.remove(0===this.selectedVersion?"opacity-100":"opacity-50")):this.versionControl.classList.add("hidden"))}showNextVersion(){this.selectedVersion>0&&this.showVersion(this.selectedVersion-1)}showPreviousVersion(){this.selectedVersion<this.versions.length-1&&this.showVersion(this.selectedVersion+1)}toggleConsole(){"translateY(100%)"===this.consoleContainer.style.transform?(this.consoleContainer.style.display="block",setTimeout((()=>{this.consoleContainer.style.height="400px",this.consoleContainer.style.transform="translateY(0)"}),10)):(this.consoleContainer.style.height="0px",this.consoleContainer.style.transform="translateY(100%)",setTimeout((()=>{this.consoleContainer.style.display="none"}),300)),this.previewIframe.contentWindow.focus()}updateLineColInfo(){const e=window.getSelection().getRangeAt(0),t=this.codeBlock.textContent,s=this.getTextOffset(this.codeBlock,e.startContainer,e.startOffset),i=t.substr(0,s).split("\n"),n=i.length,a=i[i.length-1].length+1;this.lineColInfo.textContent=`Line ${n}, Column ${a}`}overrideConsole(){if(!this.previewIframe||!this.previewIframe.contentWindow)return;const e=this.previewIframe.contentWindow.console,t=this;this.previewIframe.contentWindow.console=new Proxy(e,{get:(e,s)=>["log","info","warn","error"].includes(s)?function(...i){e[s].apply(e,i),setTimeout((()=>{t.showConsoleMessage(s,i)}),0)}:e[s]}),this.previewIframe.contentWindow.addEventListener("error",(e=>{t.showConsoleMessage("error",[`${e.message} at ${e.filename}:${e.lineno}:${e.colno}`]),e.preventDefault()}),!0),this.previewIframe.contentWindow.addEventListener("unhandledrejection",(e=>{t.showConsoleMessage("error",[`Unhandled Promise Rejection: ${e.reason}`]),e.preventDefault()}));const s=this.previewIframe.contentWindow.requestAnimationFrame;this.previewIframe.contentWindow.requestAnimationFrame=e=>s.call(this.previewIframe.contentWindow,((...s)=>{try{e(...s)}catch(e){throw t.showConsoleMessage("error",[`Error in requestAnimationFrame: ${e.message}`]),e}}))}getTextOffset(e,t,s){let i=document.createRange();return i.selectNodeContents(e),i.setEnd(t,s),i.toString().length}sandboxJavaScript(e){return`\n            <script>\n            (function() {\n                try {\n                    ${e.replace(/\b(alert|prompt|confirm)\(/g,'console.log("$1: " + ')}\n                } catch (error) {\n                    console.error('Script error:', error.message);\n                }\n            })();\n            <\/script>\n        `}isValidForPreview(e){return"html"===this._language?this.validateHTML(e):"svg"===this._language?this.validateSVG(e):void 0}validateSVG(e){if(!/<svg/i.test(e))return!1;const t=(new DOMParser).parseFromString(e,"image/svg+xml");return 0===t.getElementsByTagName("parsererror").length&&"svg"===t.documentElement.tagName.toLowerCase()}validateHTML(e){if(e=e.trim(),!/^<!DOCTYPE html|^<html|^<head|^<body/i.test(e))return!1;const t=(new DOMParser).parseFromString(e,"text/html");if(t.getElementsByTagName("parsererror").length>0)return!1;const s=t.documentElement;if("html"!==s.tagName.toLowerCase())return!1;const i=s.querySelector("head"),n=s.querySelector("body");return!(!i||!n)&&(0!==n.textContent.trim().length||0!==n.children.length)}removeIframeEventListeners(){window.removeEventListener("message",this.handleIframeMessage)}updatePreviewIframe(){if(this.isCodeTabActive)return;this._code=this.codeBlock.textContent,this.save(),this.showLoadingOverlay(),this.previewIframe||(this.previewIframe=document.createElement("iframe"),this.previewIframe.className="w-full h-full border-none hidden preview-iframe",this.previewIframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),this.contentContainer.appendChild(this.previewIframe));let e=this._code;let t="https://simtheory.ai/chat/save-csv/",s="https://simtheory.ai/chat/load-csv/",i="https://simtheory.ai/chat/llm/";"localhost"===window.location.hostname?(t="http://localhost:8000/chat/save-csv/",s="http://localhost:8000/chat/load-csv/",i="http://localhost:8000/chat/llm/"):"staging.simtheory.ai"===window.location.hostname&&(t="https://staging.simtheory.ai/chat/save-csv/",s="https://staging.simtheory.ai/chat/load-csv/",i="https://staging.simtheory.ai/chat/llm/");const n=this.messageId,a=`<script>\n        (function() {\n            // Debug logging enhancement\n            const DEBUG = false;\n            const debugLog = (category, message, data = null) => {\n                if (!DEBUG) return;\n                const timestamp = new Date().toISOString();\n                const logMessage = data \n                    ? "[" + timestamp + "] [" + category + "] " + message + " | Data: " + JSON.stringify(data)\n                    : "[" + timestamp + "] [" + category + "] " + message;\n                window.parent.postMessage({ type: 'debug', args: [logMessage] }, '*');\n            };\n        \n            // Define the base message sending function\n            const sendMessage = (type, args) => {\n                window.parent.postMessage({ \n                    source: 'code-block-preview',\n                    type, \n                    args: args.map(arg => \n                        typeof arg === 'object' ? JSON.stringify(arg) : String(arg)\n                    )\n                }, '*');\n            };\n        \n            // Store original console and alert\n            const originalConsole = window.console;\n            const originalAlert = window.alert;\n\n            // Override console methods\n            window.console = {\n                log: (...args) => { \n                    originalConsole.log(...args);\n                    sendMessage('log', args); \n                },\n                info: (...args) => { \n                    originalConsole.info(...args);\n                    sendMessage('info', args); \n                },\n                warn: (...args) => { \n                    originalConsole.warn(...args);\n                    sendMessage('warn', args); \n                },\n                error: (...args) => { \n                    originalConsole.error(...args);\n                    sendMessage('error', args); \n                }\n            };\n\n            // Override alert\n            window.alert = (message) => {\n                sendMessage('log', ["Alert: " + message]);\n                return originalAlert.call(window, message);\n            };\n        \n            const reportedErrors = new Set();\n            let hasSignaledReady = false;\n        \n            // Enhanced loading states\n            const loadingStates = {\n                domContentLoaded: false,\n                windowLoaded: false,\n                initialCheckDone: false,\n                resourceCounts: {\n                    images: 0,\n                    scripts: 0,\n                    styles: 0,\n                    iframes: 0\n                },\n                loadedCounts: {\n                    images: 0,\n                    scripts: 0,\n                    styles: 0,\n                    iframes: 0\n                }\n            };\n        \n            const signalReady = () => {\n                if (!hasSignaledReady) {\n                    debugLog('READY', ' Signaling ready state!', loadingStates);\n                    hasSignaledReady = true;\n                    window.parent.postMessage({ type: 'allImagesLoaded' }, '*');\n                }\n            };\n        \n            const updateResourceCounts = () => {\n                const images = Array.from(document.images);\n                const scripts = Array.from(document.getElementsByTagName('script'));\n                const links = Array.from(document.getElementsByTagName('link'));\n                const iframes = Array.from(document.getElementsByTagName('iframe'));\n        \n                loadingStates.resourceCounts = {\n                    images: images.length,\n                    scripts: scripts.length,\n                    styles: links.filter(link => link.rel === 'stylesheet').length,\n                    iframes: iframes.length\n                };\n        \n                loadingStates.loadedCounts = {\n                    images: images.filter(img => img.complete).length,\n                    scripts: scripts.filter(script => !script.defer || script.loaded).length,\n                    styles: links.filter(link => link.rel !== 'stylesheet' || link.sheet !== null).length,\n                    iframes: iframes.filter(iframe => iframe.complete).length\n                };\n        \n                debugLog('RESOURCES', 'Resource counts updated', {\n                    counts: loadingStates.resourceCounts,\n                    loaded: loadingStates.loadedCounts\n                });\n            };\n        \n            const checkPageReady = () => {\n                if (hasSignaledReady) {\n                    debugLog('CHECK', 'Skipping check - already signaled ready');\n                    return;\n                }\n\n                updateResourceCounts();\n                \n                const hasResources = Object.values(loadingStates.resourceCounts).some(count => count > 0);\n                \n                debugLog('CHECK', 'Checking page ready state', {\n                    hasResources,\n                    loadingStates,\n                    domContentLoaded: loadingStates.domContentLoaded\n                });\n\n                // NEW: If we have no resources at all and DOM is ready, signal immediately\n                if (!hasResources && loadingStates.domContentLoaded) {\n                    debugLog('CHECK', 'No resources to load and DOM is ready - signaling ready');\n                    signalReady();\n                    return;\n                }\n\n                // NEW: Check if images are cached\n                if (hasResources) {\n                    const images = Array.from(document.images);\n                    const allImagesComplete = images.every(img => {\n                        // Check if image is already complete or cached\n                        if (img.complete) {\n                            // If complete, check naturalWidth to confirm it actually loaded\n                            return img.naturalWidth !== 0 || img.naturalHeight !== 0;\n                        }\n                        return false;\n                    });\n\n                    const otherResourcesLoaded = Object.entries(loadingStates.resourceCounts)\n                        .filter(([key]) => key !== 'images')\n                        .every(([key, count]) => count === loadingStates.loadedCounts[key]);\n\n                    if (allImagesComplete && otherResourcesLoaded && loadingStates.domContentLoaded) {\n                        debugLog('CHECK', 'All resources (including cached) loaded and DOM is ready - signaling ready');\n                        signalReady();\n                        return;\n                    }\n                }\n\n                // Existing resource check logic\n                const allResourcesLoaded = Object.entries(loadingStates.resourceCounts).every(([key, count]) => \n                    count === loadingStates.loadedCounts[key]\n                );\n\n                if (allResourcesLoaded && loadingStates.domContentLoaded) {\n                    debugLog('CHECK', 'All resources loaded and DOM is ready - signaling ready');\n                    signalReady();\n                }\n            };\n        \n            // Modify the startPeriodicCheck to be more aggressive with timeouts\n            const startPeriodicCheck = () => {\n                let checksRemaining = 30; // Reduced from 50 to 30 (3 seconds total)\n                debugLog('PERIODIC', 'Starting periodic checks');\n                \n                const intervalId = setInterval(() => {\n                    checksRemaining--;\n                    debugLog('PERIODIC', "Periodic check running. Remaining: " + checksRemaining);\n                    \n                    checkPageReady();\n                    \n                    // Force ready state if we've been waiting too long\n                    if (!hasSignaledReady && checksRemaining <= 0) {\n                        debugLog('PERIODIC', ' Forcing ready state after timeout', loadingStates);\n                        console.warn('Forcing ready state after timeout');\n                        signalReady();\n                        clearInterval(intervalId);\n                    } else if (hasSignaledReady) {\n                        clearInterval(intervalId);\n                    }\n                }, 100);\n            };\n        \n            // Initial check\n            setTimeout(() => {\n                debugLog('INIT', 'Performing initial check');\n                loadingStates.initialCheckDone = true;\n                checkPageReady();\n            }, 0);\n        \n            // Event listeners\n            document.addEventListener('DOMContentLoaded', () => {\n                debugLog('EVENT', 'DOMContentLoaded fired');\n                loadingStates.domContentLoaded = true;\n                checkPageReady();\n            });\n        \n            window.addEventListener('load', () => {\n                debugLog('EVENT', 'Window load event fired');\n                loadingStates.windowLoaded = true;\n                checkPageReady();\n                startPeriodicCheck();\n            });\n        \n            // Mutation observer\n            const observer = new MutationObserver((mutations) => {\n                let hasNewResources = false;\n                mutations.forEach(mutation => {\n                    mutation.addedNodes.forEach(node => {\n                        if (node.nodeType === 1) {\n                            hasNewResources = true;\n                            debugLog('MUTATION', 'New resource detected', {\n                                nodeType: node.nodeName,\n                                attributes: node instanceof Element ? Array.from(node.attributes).map(attr => ({\n                                    name: attr.name,\n                                    value: attr.value\n                                })) : null\n                            });\n                        }\n                    });\n                });\n                \n                if (hasNewResources && !hasSignaledReady) {\n                    debugLog('MUTATION', 'New resources detected, scheduling check');\n                    setTimeout(checkPageReady, 100);\n                }\n            });\n        \n            observer.observe(document.documentElement, {\n                childList: true,\n                subtree: true,\n                attributes: true,\n                attributeFilter: ['src', 'href']\n            });\n        \n            // Error handling\n            window.addEventListener('error', (event) => {\n                let errorMessage;\n                \n                if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || \n                    event.target.tagName === 'LINK' || event.target.tagName === 'IFRAME')) {\n                    errorMessage = 'Failed to load resource: ' + (event.target.src || event.target.href);\n                    debugLog('ERROR', 'Resource loading error', {\n                        type: event.target.tagName,\n                        source: event.target.src || event.target.href\n                    });\n                    \n                    setTimeout(checkPageReady, 100);\n                } else {\n                    errorMessage = 'JavaScript error: ' + event.message + \n                                 ' at ' + (event.filename || 'unknown') + \n                                 ':' + (event.lineno || 'unknown') + \n                                 ':' + (event.colno || 'unknown');\n                    debugLog('ERROR', 'JavaScript runtime error', {\n                        message: event.message,\n                        filename: event.filename,\n                        line: event.lineno,\n                        column: event.colno\n                    });\n                }\n        \n                if (!reportedErrors.has(errorMessage)) {\n                    reportedErrors.add(errorMessage);\n                    sendMessage('error', [errorMessage]);\n                }\n        \n                event.preventDefault();\n                return true;\n            }, true);\n        \n            window.addEventListener('unhandledrejection', (event) => {\n                const errorMessage = 'Unhandled Promise Rejection: ' + (event.reason || 'Unknown reason');\n                debugLog('ERROR', 'Unhandled promise rejection', {\n                    reason: event.reason\n                });\n                \n                if (!reportedErrors.has(errorMessage)) {\n                    reportedErrors.add(errorMessage);\n                    sendMessage('error', [errorMessage]);\n                }\n                \n                event.preventDefault();\n                return true;\n            });\n        \n            // RAF override\n            const originalRAF = window.requestAnimationFrame;\n            window.requestAnimationFrame = (callback) => {\n                return originalRAF.call(window, (...args) => {\n                    try {\n                        callback(...args);\n                    } catch (error) {\n                        const errorMessage = 'Error in requestAnimationFrame: ' + error.message;\n                        debugLog('ERROR', 'RAF error', {\n                            message: error.message,\n                            stack: error.stack\n                        });\n                        \n                        if (!reportedErrors.has(errorMessage)) {\n                            reportedErrors.add(errorMessage);\n                            sendMessage('error', [errorMessage]);\n                        }\n                        return true;\n                    }\n                });\n            };\n        \n            // Visibility handling\n            document.addEventListener('visibilitychange', () => {\n                debugLog('VISIBILITY', 'Visibility changed', {\n                    hidden: document.hidden,\n                    hasSignaledReady\n                });\n                \n                if (!document.hidden && !hasSignaledReady) {\n                    checkPageReady();\n                }\n            });\n\n            window.load_data_from_csv = async (filename) => {\n                // First check if we're in an iframe\n                const isInIframe = (() => {\n                    try {\n                        return window.self !== window.top;\n                    } catch (e) {\n                        return true;\n                    }\n                })();\n\n                // Construct the URL based on iframe status\n                const submissionUrl = isInIframe ? \n                    '/chat/load_csv/' : \n                    '${s}';\n\n                try {\n                    // First fetch the CSV data\n                    const response = await fetch(submissionUrl, {\n                        method: 'POST',\n                        headers: {\n                            'Content-Type': 'application/json'\n                        },\n                        body: JSON.stringify({\n                            filename: filename,\n                            block_id: '${n}',\n                            is_iframe: isInIframe\n                        }),\n                        credentials: 'include'\n                    });\n\n                    if (!response.ok) {\n                        throw new Error("HTTP error! status:", response.status);\n                    }\n\n                    const result = await response.json();\n                    \n                    if (!result.success) {\n                        throw new Error(result.error || 'Failed to fetch CSV data');\n                    }\n\n                    // Parse the CSV data using Papa Parse\n                    return new Promise((resolve, reject) => {\n                        Papa.parse(result.data, {\n                            header: true,          // Treat first row as headers\n                            dynamicTyping: true,   // Automatically convert numbers\n                            skipEmptyLines: true,  // Skip empty lines\n                            complete: (results) => {\n                                resolve({\n                                    success: true,\n                                    data: results.data,\n                                    meta: results.meta,\n                                    filename: filename\n                                });\n                            },\n                            error: (error) => {\n                                reject(new Error("CSV parsing error", error));\n                            }\n                        });\n                    });\n\n                } catch (error) {\n                    console.error('Error processing CSV:', error);\n                    throw error;\n                }\n            };\n\n            window.save_data_to_csv = (filename, data) => {\n                const isInIframe = (() => {\n                    try {\n                        return window.self !== window.top;\n                    } catch (e) {\n                        return true;\n                    }\n                })();\n                const submissionUrl = isInIframe ? \n                    '/chat/save_csv/' : \n                    '${t}';\n\n                const payload = {\n                    filename: filename,\n                    data: data,\n                    is_iframe: isInIframe\n                };\n                payload.block_id = '${n}';\n                let headers = {\n                    'Content-Type': 'application/json'\n                };\n                return fetch(submissionUrl, {\n                    method: 'POST',\n                    headers: headers,\n                    body: JSON.stringify(payload),\n                    credentials: 'include'\n                })\n                .then(response => response.json())\n                .then(data => {\n                    if (data.success) {\n                        return data;\n                    } else {\n                        console.error('Error saving data:', data.error);\n                        throw new Error(data.error);\n                    }\n                })\n                .catch(error => {\n                    console.error('Error saving data:', error);\n                    throw error;\n                });\n            };\n\n            window.call_llm = (system_prompt, user_messages, json_fields) => {\n                const isInIframe = (() => {\n                    try {\n                        return window.self !== window.top;\n                    } catch (e) {\n                        return true;\n                    }\n                })();\n\n                const llmUrl = isInIframe ? '/chat/llm/' : '${i}';\n\n                const payload = {\n                    system_prompt: system_prompt,\n                    messages: user_messages,\n                    json_fields: json_fields,\n                    block_id: '${n}'\n                };\n\n                const headers = {\n                    'Content-Type': 'application/json'\n                };\n\n                return fetch(llmUrl, {\n                    method: 'POST',\n                    headers: headers,\n                    body: JSON.stringify(payload),\n                    credentials: 'include'\n                })\n                .then(response => {\n                    if (!response.ok) {\n                        throw new Error("HTTP error!");\n                    }\n                    return response.json();\n                })\n                .then(data => {\n                    if (data.success) {\n                        return data.response; // Return just the text response\n                    } else {\n                        console.error('Error calling LLM:', data.error);\n                        throw new Error(data.error);\n                    }\n                })\n                .catch(error => {\n                    console.error('Error in LLM call:', error);\n                    throw error;\n                });\n            };\n\n        })();<\/script>\n        `,o=this.generatePermissiveCSP();e=e.replace("<head>",`<head>${o}\n\n\n            <base target="_blank">\n            <script>\n            (function() {\n                document.addEventListener('click', function(e) {\n                    const anchor = e.target.closest('a');\n                    if (!anchor) return;\n\n                    const href = anchor.getAttribute('href');\n\n                    if (href && href.startsWith('#')) {\n                        e.preventDefault();\n                        e.stopPropagation();\n\n                        try {\n                            const targetElement = document.querySelector(href);\n                            if (targetElement) {\n                                const targetPosition = targetElement.offsetTop;\n                                window.scrollTo({\n                                    top: targetPosition,\n                                    behavior: 'smooth'\n                                });\n                            }\n                        } catch (err) {\n                            console.error("Failed to scroll to anchor:", href, err);\n                        }\n                        return;\n                    }\n\n                    if (anchor.href) {\n                        e.preventDefault();\n                        window.parent.postMessage({ type: 'link', href: anchor.href }, '*');\n                    }\n                }, true);\n            })();\n            <\/script>\n        \n\n${a}`),this.previewIframe.srcdoc=e,this.iframeMessageListenerAdded||(window.addEventListener("message",this.handleIframeMessage),this.iframeMessageListenerAdded=!0)}generatePermissiveCSP(){return"\n            <meta http-equiv=\"Content-Security-Policy\" content=\"\n                default-src 'self' 'unsafe-inline' 'unsafe-eval' * cdn.simulationtheory.ai;\n                script-src 'self' 'unsafe-inline' 'unsafe-eval' * blob: cdn.simulationtheory.ai;\n                style-src 'self' 'unsafe-inline' * cdn.simulationtheory.ai;\n                img-src 'self' data: * cdn.simulationtheory.ai;\n                font-src 'self' data: * cdn.simulationtheory.ai;\n                connect-src 'self' * cdn.simulationtheory.ai;\n                media-src 'self' * cdn.simulationtheory.ai;\n            \">\n        "}refreshIframe(){this.previewIframe.contentWindow.location.reload()}showPreview(){this.isCodeTabActive=!1,this.previewIframe||(this.previewIframe=document.createElement("iframe"),this.previewIframe.className="w-full h-full border-none preview-iframe",this.previewIframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms"),this.contentContainer.appendChild(this.previewIframe)),this.scrollContainer.classList.add("hidden"),this.previewIframe.classList.remove("hidden"),this.updatePreviewIframe(),this.refreshButtonDiv&&this.refreshButtonDiv.classList.remove("hidden"),this.consoleToggleButton&&(this.consoleToggleButton.style.display="inline-block"),this.previewIframe.contentWindow.focus()}showCode(){this.isCodeTabActive=!0,this.previewIframe&&(this.previewIframe.classList.add("hidden"),this.previewIframe.srcdoc="about:blank"),this.scrollContainer.classList.remove("hidden"),this.refreshButtonDiv&&this.refreshButtonDiv.classList.add("hidden"),this.consoleToggleButton&&(this.consoleToggleButton.style.display="none"),this.consoleContainer&&"translateY(0)"===this.consoleContainer.style.transform&&this.toggleConsole()}cleanup(){this.previewIframe&&(this.previewIframe.remove(),this.previewIframe=null),this.iframeMessageListenerAdded&&(window.removeEventListener("message",this.handleIframeMessage),this.iframeMessageListenerAdded=!1),this.previewIframe=null,this.codeBlock=null,this.scrollContainer=null,this.consoleContainer=null,this.floatingMenu=null}handleIframeMessage=e=>{if("allImagesLoaded"===e.data.type&&this.removeLoadingOverlay(),e.source===this.previewIframe?.contentWindow){const{source:t,type:s,args:i,href:n}=e.data;"code-block-preview"===t&&("link"===s?window.open(n,"_blank"):this.showConsoleMessage(s,i))}};handleIframeError(e){const t=`Error: ${e.message} at line ${e.lineno}:${e.colno}`;this.showConsoleMessage("error",[t])}createConsoleContainer(){this.consoleContainer=document.createElement("div"),this.consoleContainer.classList=`absolute bottom-0 ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} w-full overflow-hidden transition-all duration-300 ease-in-out z-10`,this.consoleContainer.style.height="0px",this.consoleContainer.style.display="none",this.consoleContainer.style.transform="translateY(100%)";const e=document.createElement("div");e.classList="flex justify-between px-4 pt-4";const t=document.createElement("div");t.classList="flex items-center";const s=document.createElement("span");s.textContent="Console",s.classList="font-bold text-sm",t.appendChild(s);const i=document.createElement("div");i.classList="flex justify-center align-middle items-center gap-1 text-xs rounded px-2 py-2 cursor-pointer";const n=o.A.name("chevronDown"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4"});i.appendChild(a.element),i.addEventListener("click",(()=>{this.toggleConsole()})),e.appendChild(t),e.appendChild(i),this.consoleContainer.appendChild(e),this.consoleContent=document.createElement("div"),this.consoleContent.classList="px-4 pb-2 overflow-y-auto",this.consoleContent.style.height="calc(100% - 100px)",this.consoleContainer.appendChild(this.consoleContent),this.consolePlaceholder=document.createElement("div"),this.consolePlaceholder.textContent="No console messages",this.consolePlaceholder.classList=`flex justify-center align-middle items-center text-center text-sm ${this.theme.fadedText} w-full h-full`,this.consoleContent.appendChild(this.consolePlaceholder)}showConsoleMessage(e,t){if(this.consoleContainer||this.createConsoleContainer(),this.consoleContent){this.consolePlaceholder&&this.consolePlaceholder.classList.add("hidden"),this.consoleMessageCount>=99&&(this.consoleContent.removeChild(this.consoleContent.firstChild),this.consoleMessageCount--);const s=t&&t.map((e=>"object"==typeof e?JSON.stringify(e):String(e))).join(" ")||"";if(!s.trim())return;const i=document.createElement("div");switch(i.textContent=s.trim(),e){case"error":i.classList=this.theme.toastError;break;case"warn":return;case"info":i.classList=this.theme.toastInfo;break;default:i.classList=this.theme.toastSuccess}if(i.classList.add("p-2","mb-2","rounded","text-sm"),this.consoleContent.insertBefore(i,this.consoleContent.firstChild),this.consoleMessageCount++,this.consoleCountDiv&&(this.consoleCountDiv.classList.remove("hidden"),this.consoleCountDiv.textContent=this.consoleMessageCount),"error"===e)return}}ensureErrorBannerAtTop(){if(this.consoleContent.querySelector(".error-info-banner"))return;const e=document.createElement("div");e.classList=`error-info-banner flex justify-between items-center p-2 mb-2 rounded text-base ${this.theme.toastInfo}`;const t=document.createElement("span");t.textContent="We've detected problems in your project";const s=new n.$({text:"Fix it now",type:"primary",size:"small"});s.button.style.backgroundColor="#8b5cf6",s.button.style.color="#ffffff",s.onClick((()=>{})),e.appendChild(t),e.appendChild(s.button),this.consoleContent.prepend(e)}clearConsole(){this.consoleContent&&(this.consoleContent.innerHTML="",this.consoleMessageCount=0,this.consoleCountDiv.classList.add("hidden"),this.consolePlaceholder&&this.consolePlaceholder.classList.remove("hidden"))}copyToClipboard(e=null){const t=e??this.codeBlock?.textContent??"";if(!t)return;const s=/^((?!chrome|android).)*safari/i.test(navigator.userAgent),i=!!(navigator.clipboard&&navigator.clipboard.write&&window.ClipboardItem),n="function"==typeof window.ClipboardItem?.supports?window.ClipboardItem.supports("text/html"):!s,a=t.length>8e5;if(s||!i||!n||a)return void(navigator.clipboard?.writeText?navigator.clipboard.writeText(t):Promise.reject()).then((()=>this.showToast("Copied to clipboard","success"))).catch((()=>this.fallbackCopyToClipboard(t)));const o=`<pre><code>${r=t,r.replace(/[&<>"']/g,(e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e])))}</code></pre>`;var r;const l=new ClipboardItem({"text/plain":new Blob([t],{type:"text/plain"}),"text/html":new Blob([o],{type:"text/html"})});navigator.clipboard.write([l]).then((()=>this.showToast("Copied to clipboard","success"))).catch((()=>{(navigator.clipboard?.writeText?navigator.clipboard.writeText(t):Promise.reject()).then((()=>this.showToast("Copied to clipboard","success"))).catch((()=>this.fallbackCopyToClipboard(t)))}))}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.style.position="fixed",t.style.top="0",t.style.left="0",t.style.width="2em",t.style.height="2em",t.style.padding="0",t.style.border="none",t.style.outline="none",t.style.boxShadow="none",t.style.background="transparent",t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showToast("Copied to clipboard","success")}catch(e){}document.body.removeChild(t)}showToast(e,t="success"){new c.y(e,t,!0,!0,3e3)}handleInput(){this.saveState(),this.updateCode(),this.debouncedSave(),void 0!==this.selectedVersion&&(this.versions[this.selectedVersion].code=this.codeBlock.textContent)}updateLanguage(e){this._language!==e&&(this._language=e,this.codeBlock.className=`language-${this._language} hljs`,this.applyHighlighting())}updateCode(){clearTimeout(this.highlightTimer),this.highlightTimer=setTimeout((()=>{const e=this.codeBlock.contains(document.activeElement),t=e?this.getCursorPosition():null;this.applyHighlighting(e,t)}),30)}runPendingHighlight(){this.highlightPending&&this.applyHighlighting()}applyHighlighting(e=null){if(!this.codeBlock)return;const t=ke.chatInstances[this.chatId];if(t&&ke.activeChat!==t||document.hidden)return this.highlightPending=!0,void(this._pendingSelectionSnapshot=e||this._pendingSelectionSnapshot||null);this.highlightPending=!1;const s=this.codeBlock.textContent||this._code||"";if(!s)return;!e&&this._pendingSelectionSnapshot&&(e=this._pendingSelectionSnapshot,this._pendingSelectionSnapshot=null);const i=this.codeBlock.contains(document.activeElement),n=this.captureSelectionOffsets(),a=!n&&i?this.getCursorPosition():null;let o=s,r=!1;if(e&&e.valid){const t=this.injectMarkers(s,e);t&&t.marked&&(o=t.marked,r=!0)}try{this.codeBlock.className=this.codeBlock.className.split(" ").filter((e=>!e.startsWith("language-"))).join(" ");let e,t=this._language;if(!t){if(/^\s*<!DOCTYPE\s+html/i.test(o)||/^\s*<html/i.test(o)||/^\s*<!DOCTYPE/i.test(o)||/^\s*<head/i.test(o)||/^\s*<meta/i.test(o)||/^\s*<title/i.test(o)||o.trim().startsWith("<")&&o.includes("html"))t="html",this.validForPreview=!0;else if(/^\s*<svg/i.test(o))t="svg",this.validForPreview=!0,this.validSVG=!0;else{const e=o.slice(0,1e3);t=X.A.highlightAuto(e).language||"plaintext"}this._language=t}try{e=X.A.highlight(o,{language:t}).value}catch(t){e=X.A.highlight(o,{language:"plaintext"}).value}this.codeBlock.classList.add(`language-${t}`),this.codeBlock.classList.add("hljs"),this.codeBlock.innerHTML=e,t!==this.getAttribute("language")&&this.setAttribute("language",t),this.validSVG&&(this._language="svg",this.setAttribute("language","svg")),r?this.restoreSelectionFromMarkers():n&&!n.collapsed?this.restoreSelectionFromOffsets(n):i&&null!==a&&this.setCursorPosition(a)}catch(e){this.codeBlock.textContent=s,r?this.restoreSelectionFromMarkers():n&&!n.collapsed?this.restoreSelectionFromOffsets(n):i&&null!==a&&this.setCursorPosition(a)}}getCursorPosition(){if(!this.codeBlock)return 0;try{const e=window.getSelection();if(0===e.rangeCount)return 0;const t=e.getRangeAt(0),s=t.cloneRange();return s.selectNodeContents(this.codeBlock),s.setEnd(t.endContainer,t.endOffset),s.toString().length}catch(e){return 0}}setCursorPosition(e){if(this.codeBlock&&null!==e)try{const t=window.getSelection(),s=document.createRange();let i=0,n=!1;const a=t=>{if(!n)if(t.nodeType===Node.TEXT_NODE){const a=t.textContent.length;i+a>=e?(s.setStart(t,e-i),s.collapse(!0),n=!0):i+=a}else for(let e=0;e<t.childNodes.length&&!n;e++)a(t.childNodes[e])};a(this.codeBlock),n&&(t.removeAllRanges(),t.addRange(s))}catch(e){}}handleKeyDown(e){"Enter"===e.key?(e.preventDefault(),this.handleEnterKey(e)):"Tab"===e.key?(e.preventDefault(),this.handleTabKey(e.shiftKey)):"Backspace"===e.key?this.handleBackspaceKey(e):(e.ctrlKey||e.metaKey)&&("z"===e.key?(e.preventDefault(),e.shiftKey?this.redo():this.undo()):"y"===e.key?(e.preventDefault(),this.redo()):"x"===e.key?(e.preventDefault(),this.cutSelection()):"v"===e.key&&(e.preventDefault(),this.paste()))}handleTabKey(e){this.saveState();const t=window.getSelection().getRangeAt(0),s=this.getLineNumber(t.startContainer,t.startOffset),i=this.getLineNumber(t.endContainer,t.endOffset),n=this.getSelectionInfo(t);if(s===i&&t.collapsed)if(e)this.unindentLine(s,n);else{const e=this.getCursorPosition(),t=this.codeBlock.textContent,s=t.slice(0,e)+"    "+t.slice(e);this.codeBlock.textContent=s,n.startOffset+=4,n.endOffset+=4}else this.indentSelectedLines(e,n);this.updateCode(),this.attemptRestoreSelection(n,5)}attemptRestoreSelection(e,t){t<=0||setTimeout((()=>{this.restoreSelection(e)?this.triggerSelectionChange():this.attemptRestoreSelection(e,t-1)}),50*(6-t))}getSelectionInfo(e){const t=e.startContainer,s=e.endContainer,i=e.startOffset,n=e.endOffset;return{startLine:this.getLineNumber(t,i),endLine:this.getLineNumber(s,n),startOffset:this.getTextOffset(this.codeBlock,t,i),endOffset:this.getTextOffset(this.codeBlock,s,n)}}getLineNumber(e,t){const s=this.codeBlock.textContent,i=this.getTextOffset(this.codeBlock,e,t);return s.substr(0,i).split("\n").length-1}handleBackspaceKey(e){const t=window.getSelection().getRangeAt(0);if(!t.collapsed)return this.saveState(),t.deleteContents(),void this.updateCode();const s=this.getCursorPosition(),i=this.codeBlock.textContent.lastIndexOf("\n",s-1)+1,n=this.codeBlock.textContent.substring(i,s);if(0===n.length)return;const a=" ".repeat(4);if(n.endsWith(a)){e.preventDefault(),this.saveState();const t=this.codeBlock.textContent.substring(0,s-4)+this.codeBlock.textContent.substring(s);this.codeBlock.textContent=t,this.setCursorPosition(s-4),this.updateCode()}else if(n.endsWith("\t")){e.preventDefault(),this.saveState();const t=this.codeBlock.textContent.substring(0,s-1)+this.codeBlock.textContent.substring(s);this.codeBlock.textContent=t,this.setCursorPosition(s-1),this.updateCode()}}indentSelectedLines(e,t){let s=this.codeBlock.textContent.split("\n");const{startLine:i,endLine:n,startOffset:a,endOffset:o}=t;let r=a,l=o;for(let t=i;t<=n;t++)if(e){const e=s[t].match(/^( {1,4}|\t)/);s[t]=s[t].replace(/^( {1,4}|\t)/,""),t===i&&(r=Math.max(0,r-(e?e[0].length:0))),l-=e?e[0].length:0}else s[t]="    "+s[t],t===i&&(r+=4),l+=4;this.codeBlock.textContent=s.join("\n"),t.startOffset=r,t.endOffset=l}unindentLine(e,t){let s=this.codeBlock.textContent.split("\n");if(e>=0&&e<s.length){const i=s[e].match(/^( {1,4}|\t)/);s[e]=s[e].replace(/^( {1,4}|\t)/,""),this.codeBlock.textContent=s.join("\n");const n=i?i[0].length:0;t.startOffset=Math.max(0,t.startOffset-n),t.endOffset=Math.max(0,t.endOffset-n)}}triggerSelectionChange(){const e=new Event("selectionchange",{bubbles:!0,cancelable:!0});document.dispatchEvent(e)}restoreSelection(e){const{startOffset:t,endOffset:s}=e,i=this.codeBlock.textContent;if(t>i.length||s>i.length)return!1;const n=document.createRange(),a=window.getSelection();try{return this.setRangeStart(n,this.codeBlock,t),this.setRangeEnd(n,this.codeBlock,s),a.removeAllRanges(),a.addRange(n),!0}catch(e){return!1}}setRangeStart(e,t,s){this.setRangePoint(e,t,s,!0)}setRangeEnd(e,t,s){this.setRangePoint(e,t,s,!1)}setRangePoint(e,t,s,i){let n=0,a=!1;if(function t(o){if(!a)if(o.nodeType===Node.TEXT_NODE){const t=n+o.length;if(s<=t)return i?e.setStart(o,s-n):e.setEnd(o,s-n),void(a=!0);n=t}else for(let e of o.childNodes)if(t(e),a)return}(t),!a)throw new Error(`Could not set range ${i?"start":"end"} for offset ${s}`)}getTextNode(e){if(e.nodeType===Node.TEXT_NODE)return e;for(let t of e.childNodes){const e=this.getTextNode(t);if(e)return e}return null}getTextOffset(e,t,s){let i=document.createRange();return i.selectNodeContents(e),i.setEnd(t,s),i.toString().length}adjustSelectionAfterIndent(e,t,s,i){const n=this.codeBlock.textContent.split("\n"),a=n.slice(0,e).join("\n").length+(e>0?1:0)+s,o=n.slice(0,t).join("\n").length+(t>0?1:0)+i,r=document.createRange(),l=this.codeBlock.firstChild;r.setStart(l,a),r.setEnd(l,o);const c=window.getSelection();c.removeAllRanges(),c.addRange(r)}handleEnterKey(e){e.preventDefault(),this.saveState();const t=window.getSelection().getRangeAt(0);if(!this.codeBlock.contains(t.startContainer))return;const s=this.codeBlock.textContent,i=this.getCursorPosition();if(0===i)return this.insertTextAtCursor("\n"),this.setCursorPosition(1),void this.updateCode();const n=s.lastIndexOf("\n",i-1)+1,a=s.substring(n,i),o=a.match(/^(\s*)/);let r="\n"+(o?o[1]:"");/[{[(]$/.test(a.trim())&&(r+="    ");const l=s.substring(0,i)+r+s.substring(i);this.codeBlock.textContent=l;const c=i+r.length;this.setCursorPosition(c),this.updateCode()}setCursorPosition(e){const t=document.createRange(),s=window.getSelection();let i=0,n=!1;!function s(a){if(!n)if(a.nodeType===Node.TEXT_NODE)i+a.length>=e?(t.setStart(a,e-i),t.setEnd(a,e-i),n=!0):i+=a.length;else for(let e of a.childNodes)s(e)}(this.codeBlock),n&&(s.removeAllRanges(),s.addRange(t))}insertTextAtCursor(e){const t=window.getSelection(),s=t.getRangeAt(0);s.deleteContents();const i=e.split("\n");let n=null;i.forEach(((e,t)=>{if(t>0){const e=document.createElement("br");s.insertNode(e),n=e}const i=document.createTextNode(e);s.insertNode(i),n=i})),n&&(s.setStartAfter(n),s.setEndAfter(n)),t.removeAllRanges(),t.addRange(s)}saveState(){const e={content:this.codeBlock.textContent,cursorPosition:this.getCursorPosition()};this.undoStack.push(e),this.redoStack=[]}save(e=!1,t=!1,s=!1){if(!this.codeBlock)return;const i=this.getCursorPosition(),n=btoa(encodeURIComponent(this.codeBlock.textContent));this.setAttribute("code",n),this._code=this.codeBlock.textContent,t?this.saveNewVersion():this.saveCurrentVersion(s),this.applyHighlighting(),this.setCursorPosition(i),e&&this.showToast("Code saved successfully","success")}undo(){if(this.undoStack.length>1){const e=this.undoStack.pop();this.redoStack.push(e);const t=this.undoStack[this.undoStack.length-1];this.applyState(t)}}redo(){if(this.redoStack.length>0){const e=this.redoStack.pop();this.undoStack.push(e),this.applyState(e)}}selectAll(){const e=document.createRange();e.selectNodeContents(this.codeBlock);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)}cutSelection(){this.saveState(),this.copySelection(),this.deleteSelection()}deleteSelection(){const e=window.getSelection();if(0===e.rangeCount)return;e.getRangeAt(0).deleteContents()}paste(){this.saveState(),navigator.clipboard.readText().then((e=>{const t=window.getSelection().getRangeAt(0);t.deleteContents(),t.insertNode(document.createTextNode(e)),this.updateCode()})).catch((e=>{}))}copySelection(){this.copyToClipboard(this.getSelection())}createFloatingMenu(){}showFloatingMenu(e){if(!this.floatingMenu)return;const{left:t,right:s,top:i,bottom:n}=e,a=this.codeBlock.getBoundingClientRect();this.floatingMenu.classList.remove("hidden");const o=this.floatingMenu.offsetHeight,r=this.floatingMenu.offsetWidth;this.floatingMenu.classList.add("hidden");const l=window.scrollY,c=window.scrollX,d=a.bottom-n,h=i-a.top,m=a.right-s,u=t-a.left;let p,g;p=d>=o||d>h?Math.min(n,a.bottom-o):Math.max(i-o,a.top),g=u>=r?t:m>=r?s-r:Math.max(a.left,Math.min(s-r/2,a.right-r)),g=Math.max(a.left,Math.min(g,a.right-r)),p=Math.max(a.top,Math.min(p,a.bottom-o)),this.floatingMenu.style.top=`${p+l}px`,this.floatingMenu.style.left=`${g+c}px`,this.floatingMenu.style.right="auto",this.floatingMenu.style.bottom="auto",this.floatingMenu.classList.remove("hidden")}hideFloatingMenu(){this.floatingMenu&&this.floatingMenu.classList.add("hidden")}getSelection(){const e=window.getSelection();return 0===e.rangeCount?"":e.toString()}handleSelection=()=>{const e=window.getSelection(),t=e.toString().trim();if(t){const s=e.getRangeAt(0).getBoundingClientRect();this.showFloatingMenu(s),this.selectedText=t}else this.hideFloatingMenu()};handleRefine(){this.selectedText&&this.dispatchCodeSelectedEvent(this.selectedText),this.hideFloatingMenu()}handleCopy(){this.selectedText&&this.copyToClipboard(this.selectedText),this.hideFloatingMenu()}dispatchCodeSelectedEvent(e){const t=new CustomEvent("codeSelected",{bubbles:!0,detail:{code:e,chatId:this.chatId}});this.dispatchEvent(t)}dispatchCodeDeselectedEvent(){const e=new CustomEvent("codeDeselected",{bubbles:!0,detail:{chatId:this.chatId}});this.dispatchEvent(e)}replaceText(e,t){this.saveState();const s=this.codeBlock.textContent,i=s.indexOf(e);if(-1===i)return!1;const n=i+e.length,a=s.substring(0,i)+t+s.substring(n);this.codeBlock.textContent=a,this.updateCode();const o=i+t.length;return this.setCursorPosition(o),this.code=a,this.save(),this.previewIframe&&this.isPreviewValid()&&!this.isCodeTabActive&&this.updatePreviewIframe(),!0}async getPublishStatus(){this.published?this.getShareURL({published:!0,published_url:this.published_url,published_version:this.published_version,title:this.published_title}):this.publishDialog()}async publishDialog(){const e=document.createElement("div");e.classList="flex flex-col gap-4";const t=document.createElement("p");t.textContent="Sharing will make this app accessible to anyone on the internet. Your session will remain private.",t.classList=this.theme.regularText;const s=document.createElement("div");s.classList=`flex items-center gap-3 p-4 rounded-lg ${this.theme.secondaryBackground}`;const i=o.A.name("lock"),a=new r.I({pathData:i.path,viewBox:i.viewBox,colorClass:this.theme.fadedText,sizeClasses:"w-5 h-5"}),d=document.createElement("div");d.classList="flex flex-col";const h=document.createElement("div");h.textContent="Unpublished",h.classList="font-bold text-base";const m=document.createElement("div");m.textContent="Only you have access",m.classList=`${this.theme.fadedText} text-sm`,d.appendChild(h),d.appendChild(m),s.appendChild(a.element),s.appendChild(d);const u=new n.$({text:"Share & copy link",type:"primary",size:"large",width:"full"});e.appendChild(t),e.appendChild(s),u.render(e),this.modalConfig={size:"small",title:"Share",body:e,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1};const p=new l(this.modalConfig);u.onClick((async()=>{p.close();const e=this.showLoadingModal("Generating sharing link...","Sharing");try{this.save();const t=await g.G.postData("/chat/publish-code-project/",{chat_message_id:this.messageId});if(!t||!t.published_url)throw new Error("Invalid response from server");const s={published:!0,published_url:t.published_url,published_version:t.published_version,title:t.published_title};e.close(),this.getShareURL(s)}catch(t){e.close(),new c.y("Failed to publish. Please try again.","error")}}))}showLoadingModal(e,t="Loading"){const s=document.createElement("div");s.classList="flex items-center justify-center align-middle gap-4 h-[250px]";const i=o.A.name("spinner"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"}),a=document.createElement("div");a.classList.add(this.theme.fadedText,"flex","flex-col","items-center","justify-center"),n.render(a);const c=document.createElement("div");c.classList.add("py-6","space-y-2"),c.appendChild(a);const d=document.createElement("div");d.classList.add("text-lg","font-bold","text-center"),d.textContent=t,c.appendChild(d);const h=document.createElement("div");h.classList.add("text-base","text-center"),h.textContent=e,c.appendChild(h),s.appendChild(c);return new l({size:"small",title:"",body:s,closeX:!1,confirmOnExit:!1,confirm:!1,cancel:!1})}async getShareURL(e){const t=e.published_url,s=document.createElement("div");s.classList="flex flex-col gap-1";const i=document.createElement("div");i.classList=`flex items-center gap-3 p-4 rounded-lg ${this.theme.secondaryBackground} mt-2`;const h=o.A.name("globe"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.fadedText}),u=document.createElement("div");u.classList="flex flex-col max-w-[300px]";const p=e.title||"Untitled",f=e.published_version||"Unknown",v=document.createElement("div");v.textContent=`Sharing ${p}`,v.classList="font-bold text-base truncate";const y=document.createElement("div");y.textContent=`Version ${f} is available to anyone with the link`,y.classList=`${this.theme.fadedText} text-sm`,u.appendChild(v),u.appendChild(y),i.appendChild(m.element),i.appendChild(u);const w=document.createElement("div");w.classList=`${this.theme.regularText} text-sm pt-2`,w.textContent="Share this unique URL to allow others to view:";const b=new d({type:"text",value:t,readonly:!0,copyButton:!0,label:"",enableCopy:!0}),C=new n.$({text:"Stop sharing",type:"secondary",size:"large",width:"full"}),x=e.published_version;if(this.versions[0].version>x){const e={text:"Update to latest version",type:"primary",size:"large",width:"full"};this.updateVersion=new n.$(e)}else this.updateVersion=null;const k=document.createElement("div");k.classList="flex flex-col items-center gap-2 mt-4",C.render(k),this.updateVersion?.render(k),s.appendChild(i),s.appendChild(w),b.render(s),s.appendChild(k),this.modalConfig={size:"small",title:"Sharing",body:s,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1};const E=new l(this.modalConfig);C.onClick((()=>{new a("Stop Sharing?","This will remove access for anyone with the shared link. You can always share again later.").onConfirm((async()=>{E.close();const e=this.showLoadingModal("Removing shared access...","Processing");try{(await g.G.postData("/chat/unpublish-code-project/",{chat_message_id:this.messageId})).success?(e.close(),new c.y("Project is no longer shared","success"),this.loadVersions(),this.publishDialog()):new c.y("Failed to stop sharing. Please try again.","error")}catch(t){e.close(),new c.y("Failed to stop sharing. Please try again.","error")}}))})),this.updateVersion?.onClick((async()=>{new a("Are your sure?","This will publish the latest version of your project.").onConfirm((async()=>{E.close();const e=this.showLoadingModal("Publishing latest version...","Publishing");try{this.save();const t=await g.G.postData("/chat/publish-code-project/",{chat_message_id:this.messageId});if(!t||!t.published_url)throw new Error("Invalid response from server");this.published=!0,this.published_url=t.published_url,this.published_version=t.published_version,this.published_title=t.published_title,e.close(),new c.y("New version published successfully!","success"),this.getShareURL({published:!0,published_url:t.published_url,published_version:t.published_version,title:t.published_title})}catch(t){e.close(),new c.y("Failed to publish new version. Please try again.","error")}}))}))}async visualizeFormSubmissions(){this.dataModal&&this.dataModal.close();const e=new CustomEvent("triggerVisualization",{bubbles:!0,detail:{messageId:this.messageId,blockId:this.blockId}});document.dispatchEvent(e),"focus"===this._mode&&this.originalInstance&&this.originalInstance.closeFocus(),this.cleanup()}async downloadFormSubmissions(){const e=await g.G.postData(`/chat/code-project-submissions/${this.messageId}/`,{});if(e&&e.rawCSVData){const t=e.rawCSVData,s=e.csvFilename,i=encodeURI(`data:text/csv;charset=utf-8,${t}`),n=document.createElement("a");n.setAttribute("href",i),n.setAttribute("download",s||"submissions.csv"),document.body.appendChild(n),n.click()}else{if(""===e.rawCSVData)return void new c.y("No submissions found","info");new c.y("Failed to fetch submissions","error")}}async download(){try{const e=this.showLoadingModal("Preparing download...","Downloading"),t=await g.G.postData("/chat/initiate-download/",{chat_message_id:this.messageId,code:this.codeBlock.textContent,language:this._language,title:this.title||"Untitled"});if(!t.task_id)throw new Error("Failed to initiate download");const s=60;let i=0;const n=async()=>{try{const a=await g.G.postData(`/chat/download-status/${t.task_id}/`);if("completed"===a.status){const t=document.createElement("a");return t.href=a.download_url,t.download=a.filename,document.body.appendChild(t),t.click(),document.body.removeChild(t),e.close(),void this.showToast("Download complete","success")}if("error"===a.status)throw e.close(),new Error(a.error||"Download processing failed");if(i++,i>=s)throw e.close(),new Error("Download timed out");if(i%5==0){const t=["Processing assets...","Packaging files...","Almost there...","Finalizing package..."],s=Math.floor(i/5)%t.length;e.body.querySelector(".text-base").textContent=t[s]}await new Promise((e=>setTimeout(e,1e3))),await n()}catch(t){throw e.close(),t}};await n()}catch(e){this.showToast(e.message||"Download failed. Please try again.","error")}}async fallbackDownload(e,t,s){const i=new Blob([e],{type:s}),n=URL.createObjectURL(i),a=document.createElement("a");if(a.href=n,a.download=t,/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream)return!!confirm("Your browser doesn't support direct downloads. The file will open in a new tab. You can save it from there. Proceed?")&&(window.open(n,"_blank"),!0);try{return document.body.appendChild(a),a.click(),document.body.removeChild(a),!0}catch(e){return!1}finally{setTimeout((()=>URL.revokeObjectURL(n)),100)}}getMimeType(e){return{txt:"text/plain",html:"text/html",css:"text/css",js:"text/javascript",json:"application/json",xml:"application/xml",py:"text/x-python",svg:"image/svg+xml",java:"text/x-java-source",cpp:"text/x-c++src",md:"text/markdown",tex:"application/x-latex",rst:"text/x-rst",adoc:"text/x-asciidoc",yml:"text/x-yaml",toml:"text/x-toml",ini:"text/x-ini",csv:"text/csv",tsv:"text/tab-separated-values",proto:"text/x-protobuf",sh:"application/x-sh",ps1:"application/x-powershell",bat:"application/x-bat",awk:"application/x-awk",sed:"application/x-sed",sql:"application/sql",sqlite:"application/x-sqlite3",pls:"text/x-plsql",jsx:"text/jsx",tsx:"text/tsx",vue:"text/vue",svelte:"text/x-svelte",sass:"text/x-sass",scss:"text/x-scss",less:"text/x-less",Dockerfile:"text/x-dockerfile",Makefile:"text/x-makefile",gitignore:"text/x-gitignore",Jenkinsfile:"text/x-jenkinsfile",graphql:"application/graphql",regex:"application/x-regex"}[e]||"text/plain"}applyState(e){this.getCursorPosition();this.codeBlock.textContent=e.content,this.applyHighlighting(),this.setCursorPosition(e.cursorPosition)}isPreviewValid(){return this.validateHTML(this._code)||this.validateSVG(this._code)}checkAndOpenFocus(){this.isPreviewValid()&&setTimeout((()=>{const e=ke.chatInstances[this.chatId];e&&(e===ke.activeChat?this.handleFocus():(e._pendingFocusBlock=this,ke.sessionTabs&&ke.sessionTabs.setNotificationLight(this.chatId,!0)))}),0)}handleFocus(e=0){this.runPendingHighlight(),this.focusInstance?this.focusCodeEditor.showVersion(e):(this.save(),this.focusInstance=new G(this.chatId,this,{versionToLoad:e,versions:this.versions}),this.minimizeInChat())}maximizeInChat(){this.setAttribute("minimize","false"),this.focusInstance=null,this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null),this.wrapper.style.display="block"}closeFocus(){this.focusCodeEditor&&(this.code=this.focusCodeEditor.code),this.focusInstance&&(this.focusInstance.close(),this.focusInstance=null,setTimeout((()=>{this.focusCodeEditor.remove(),this.focusCodeEditor=null}),300)),this.wrapper.style.opacity="0",this.wrapper.style.display="block",setTimeout((()=>{this.wrapper.style.transition="opacity 0.5s ease-in",this.wrapper.style.opacity="1"}),10),this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null),this.setAttribute("minimize","false"),this.applyHighlighting()}focus(e){const t=btoa(encodeURIComponent(this._code));this.focusCodeEditor=document.createElement("code-block"),this.focusCodeEditor.setAttribute("file-title",this._title),this.focusCodeEditor.setAttribute("language",this._language),this.focusCodeEditor.setAttribute("code",t),this.focusCodeEditor.setAttribute("mode","focus"),this.focusCodeEditor.setAttribute("readonly","false"),this.focusCodeEditor.setAttribute("chat-id",this.chatId),this.focusCodeEditor.setAttribute("block-id",this.blockId),this.focusCodeEditor.setAttribute("message-id",this.messageId),this.focusCodeEditor.originalInstance=this,e.versions.length>1&&e.versionToLoad&&this.focusCodeEditor.showVersion(e.versionToLoad);return new MutationObserver((e=>{e.forEach((e=>{if("attributes"===e.type&&"title"===e.attributeName){const e=this.focusCodeEditor.getAttribute("title");this.title=e,this.updateMinimizedView()}}))})).observe(this.focusCodeEditor,{attributes:!0,attributeFilter:["title"]}),this.focusCodeEditor}minimizeInChat(){this._minimize||(this.setAttribute("minimize","true"),this.initialContent=this._code,this.wrapper&&(this.wrapper.style.display="none"),this.minimizedView||(this.minimizedView=this.createMinimizedView()),this.appendChild(this.minimizedView))}updateVersionTiles(){this.querySelectorAll(".version-tile").forEach((e=>e.remove())),this.versions.forEach(((e,t)=>{const s=this.createVersionTile(t);this.appendChild(s)}))}createVersionTile(e){const t={name:this.title||"Untitled",type:"code",extension:we.getLanguageFileExtension(this.language,!0),version:e+1},s=document.createElement("div");s.classList=`pb-4 version-tile version-[${e}] parent-block-id-[${this.blockId}]`;const i=new Y([t],null).createFileItem(t,t.extension);return s.appendChild(i),i.addEventListener("click",(()=>{this.focusInstance?this.focusCodeEditor.showVersion(e):this.handeFocus(e)})),s}createMinimizedView(){const e={name:this.title||"Untitled",type:"code",extension:we.getLanguageFileExtension(this.language,!0)},t=document.createElement("div");t.classList="pb-4 version-master version-[0] cursor-pointer z-30";const s=new Y([e],null).createFileItem(e,e.extension);return t.appendChild(s),s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()})),s.style.pointerEvents="auto",s.style.cursor="pointer",t}updateMinimizedView(){this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=this.createMinimizedView(),this.appendChild(this.minimizedView))}scrollToBottom(){cancelAnimationFrame(this.scrollRAF),this.isUserDetached||(this.scrollRAF=requestAnimationFrame((()=>{if(!this.isUserDetached){if(!this.scrollContainer)return;const{scrollHeight:e,clientHeight:t}=this.scrollContainer,s=e-t;this.scrollContainer.scrollTop=s}})))}updateScrollPosition(){this.isUserDetached||requestAnimationFrame((()=>{this.scrollContainer.scrollTop=this.scrollContainer.scrollHeight}))}handleScroll(){if(!this.scrollContainer)return;const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.scrollContainer,i=t-e<=s+100;this.isUserDetached!==!i&&(this.isUserDetached=!i,this.isUserDetached&&cancelAnimationFrame(this.scrollRAF))}isAtBottom(){const{scrollTop:e,scrollHeight:t,clientHeight:s}=this.scrollContainer;return t-e<=s+50}static getLanguageFileExtension(e,t=!1){const s={python:".py",java:".java",c:".c","c++":".cpp",cpp:".cpp","c#":".cs",csharp:".cs",javascript:".js",typescript:".ts",ruby:".rb",php:".php","php-template":".php",swift:".swift",go:".go",rust:".rs",kotlin:".kt",scala:".scala",r:".r",matlab:".m",perl:".pl",lua:".lua",haskell:".hs",julia:".jl",dart:".dart",groovy:".groovy",fortran:".f90",assembly:".asm","vb.net":".vb",vbnet:".vb","f#":".fs",fsharp:".fs",elixir:".ex",clojure:".clj",html:".html",css:".css",xml:".xml",markdown:".md",latex:".tex",restructuredtext:".rst",asciidoc:".adoc",svg:".svg",json:".json",yaml:".yml",toml:".toml",ini:".ini",csv:".csv",tsv:".tsv",protobuf:".proto",bash:".sh",shell:".sh",powershell:".ps1",batch:".bat",awk:".awk",sed:".sed",sql:".sql",sqlite:".sqlite",plsql:".pls",jsx:".jsx",tsx:".tsx",vue:".vue",svelte:".svelte",sass:".sass",scss:".scss",less:".less",dockerfile:"Dockerfile",makefile:"Makefile",gitignore:".gitignore",jenkinsfile:"Jenkinsfile",graphql:".graphql",regex:".regex",plaintext:".txt",text:".txt"}[e=e.toLowerCase()]||".txt";return t?s.replace(/^\./,""):s}openFullScreen(){const e=document.createElement("div");e.classList=`fixed inset-0 w-full h-full z-50 ${this.theme.background}`,e.style.height="100vh";const t=document.createElement("div");t.classList=`flex justify-between items-center px-4 ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} rounded-t-md`;const s=document.createElement("div");s.classList="flex items-center gap-2",s.innerHTML=`\n            <span class="text-sm">${this.title||"Untitled"}</span>\n        `;const i=document.createElement("div");i.classList="flex items-center gap-4";const a=o.A.name("rotate"),r=new n.$({svgPathData:a.path,svgViewBox:a.viewBox,type:"secondaryTransparent",size:"icon",additionalClasses:`${this.theme.focusMenuHover} p-2 rounded`}),l=r.element;l.title="Refresh",r.onClick((()=>{this.updateFullScreenPreview(m),setTimeout((()=>m.contentWindow.focus()),100)}));const c=o.A.name("tabClose"),d=new n.$({svgPathData:c.path,svgViewBox:c.viewBox,type:"secondaryTransparent",size:"icon",additionalClasses:`${this.theme.focusMenuHover} p-2 rounded`}),h=d.element;h.title="Exit full screen",i.appendChild(l),i.appendChild(h),t.appendChild(s),t.appendChild(i);const m=document.createElement("iframe");m.classList="w-full h-full border-none",m.style.height="calc(100vh - 40px)",m.setAttribute("sandbox","allow-scripts allow-same-origin allow-popups allow-forms allow-popups-to-escape-sandbox"),e.appendChild(t),e.appendChild(m),document.body.appendChild(e),this.updateFullScreenPreview(m);const u=t=>{"Escape"===t.key&&(document.body.contains(e)&&document.body.removeChild(e),document.removeEventListener("keydown",u),m.contentWindow&&m.contentWindow.removeEventListener("keydown",u))};d.onClick((()=>{document.body.contains(e)&&document.body.removeChild(e),document.removeEventListener("keydown",u),m.contentWindow&&m.contentWindow.removeEventListener("keydown",u)})),m.addEventListener("load",(()=>{m.contentWindow.focus(),m.contentWindow.addEventListener("keydown",u),e.addEventListener("click",(e=>{t.contains(e.target)||m.contentWindow.focus()}))})),document.addEventListener("keydown",u)}updateFullScreenPreview(e){let t=this._code;const s=`<script>\n            (function() {\n                // Debug logging enhancement\n                const DEBUG = false;\n                const debugLog = (category, message, data = null) => {\n                    if (!DEBUG) return;\n                    const timestamp = new Date().toISOString();\n                    const logMessage = data \n                        ? "[" + timestamp + "] [" + category + "] " + message + " | Data: " + JSON.stringify(data)\n                        : "[" + timestamp + "] [" + category + "] " + message;\n                    window.parent.postMessage({ type: 'debug', args: [logMessage] }, '*');\n                };\n        \n                // Define the base message sending function\n                const sendMessage = (type, args) => {\n                    window.parent.postMessage({ \n                        source: 'code-block-preview',\n                        type, \n                        args: args.map(arg => \n                            typeof arg === 'object' ? JSON.stringify(arg) : String(arg)\n                        )\n                    }, '*');\n                };\n        \n                // Store original console and alert\n                const originalConsole = window.console;\n                const originalAlert = window.alert;\n        \n                // Override console methods\n                window.console = {\n                    log: (...args) => { \n                        originalConsole.log(...args);\n                        sendMessage('log', args); \n                    },\n                    info: (...args) => { \n                        originalConsole.info(...args);\n                        sendMessage('info', args); \n                    },\n                    warn: (...args) => { \n                        originalConsole.warn(...args);\n                        sendMessage('warn', args); \n                    },\n                    error: (...args) => { \n                        originalConsole.error(...args);\n                        sendMessage('error', args); \n                    }\n                };\n        \n                // Override alert\n                window.alert = (message) => {\n                    sendMessage('log', ["Alert: " + message]);\n                    return originalAlert.call(window, message);\n                };\n        \n                const reportedErrors = new Set();\n                let hasSignaledReady = false;\n        \n                // Enhanced loading states\n                const loadingStates = {\n                    domContentLoaded: false,\n                    windowLoaded: false,\n                    initialCheckDone: false,\n                    resourceCounts: {\n                        images: 0,\n                        scripts: 0,\n                        styles: 0,\n                        iframes: 0\n                    },\n                    loadedCounts: {\n                        images: 0,\n                        scripts: 0,\n                        styles: 0,\n                        iframes: 0\n                    }\n                };\n        \n                const signalReady = () => {\n                    if (!hasSignaledReady) {\n                        debugLog('READY', ' Signaling ready state!', loadingStates);\n                        hasSignaledReady = true;\n                        window.parent.postMessage({ type: 'allImagesLoaded' }, '*');\n                    }\n                };\n        \n                const updateResourceCounts = () => {\n                    const images = Array.from(document.images);\n                    const scripts = Array.from(document.getElementsByTagName('script'));\n                    const links = Array.from(document.getElementsByTagName('link'));\n                    const iframes = Array.from(document.getElementsByTagName('iframe'));\n        \n                    loadingStates.resourceCounts = {\n                        images: images.length,\n                        scripts: scripts.length,\n                        styles: links.filter(link => link.rel === 'stylesheet').length,\n                        iframes: iframes.length\n                    };\n        \n                    loadingStates.loadedCounts = {\n                        images: images.filter(img => img.complete).length,\n                        scripts: scripts.filter(script => !script.defer || script.loaded).length,\n                        styles: links.filter(link => link.rel !== 'stylesheet' || link.sheet !== null).length,\n                        iframes: iframes.filter(iframe => iframe.complete).length\n                    };\n        \n                    debugLog('RESOURCES', 'Resource counts updated', {\n                        counts: loadingStates.resourceCounts,\n                        loaded: loadingStates.loadedCounts\n                    });\n                };\n        \n                const checkPageReady = () => {\n                    if (hasSignaledReady) {\n                        debugLog('CHECK', 'Skipping check - already signaled ready');\n                        return;\n                    }\n        \n                    updateResourceCounts();\n                    \n                    const hasResources = Object.values(loadingStates.resourceCounts).some(count => count > 0);\n                    \n                    debugLog('CHECK', 'Checking page ready state', {\n                        hasResources,\n                        loadingStates,\n                        domContentLoaded: loadingStates.domContentLoaded\n                    });\n        \n                    if (!hasResources && loadingStates.domContentLoaded) {\n                        debugLog('CHECK', 'No resources to load and DOM is ready - signaling ready');\n                        signalReady();\n                        return;\n                    }\n        \n                    if (hasResources) {\n                        const images = Array.from(document.images);\n                        const allImagesComplete = images.every(img => {\n                            if (img.complete) {\n                                return img.naturalWidth !== 0 || img.naturalHeight !== 0;\n                            }\n                            return false;\n                        });\n        \n                        const otherResourcesLoaded = Object.entries(loadingStates.resourceCounts)\n                            .filter(([key]) => key !== 'images')\n                            .every(([key, count]) => count === loadingStates.loadedCounts[key]);\n        \n                        if (allImagesComplete && otherResourcesLoaded && loadingStates.domContentLoaded) {\n                            debugLog('CHECK', 'All resources (including cached) loaded and DOM is ready - signaling ready');\n                            signalReady();\n                            return;\n                        }\n                    }\n        \n                    const allResourcesLoaded = Object.entries(loadingStates.resourceCounts).every(([key, count]) => \n                        count === loadingStates.loadedCounts[key]\n                    );\n        \n                    if (allResourcesLoaded && loadingStates.domContentLoaded) {\n                        debugLog('CHECK', 'All resources loaded and DOM is ready - signaling ready');\n                        signalReady();\n                    }\n                };\n        \n                const startPeriodicCheck = () => {\n                    let checksRemaining = 30;\n                    debugLog('PERIODIC', 'Starting periodic checks');\n                    \n                    const intervalId = setInterval(() => {\n                        checksRemaining--;\n                        debugLog('PERIODIC', "Periodic check running. Remaining: " + checksRemaining);\n                        \n                        checkPageReady();\n                        \n                        if (!hasSignaledReady && checksRemaining <= 0) {\n                            debugLog('PERIODIC', ' Forcing ready state after timeout', loadingStates);\n                            console.warn('Forcing ready state after timeout');\n                            signalReady();\n                            clearInterval(intervalId);\n                        } else if (hasSignaledReady) {\n                            clearInterval(intervalId);\n                        }\n                    }, 100);\n                };\n        \n                setTimeout(() => {\n                    debugLog('INIT', 'Performing initial check');\n                    loadingStates.initialCheckDone = true;\n                    checkPageReady();\n                }, 0);\n        \n                document.addEventListener('DOMContentLoaded', () => {\n                    debugLog('EVENT', 'DOMContentLoaded fired');\n                    loadingStates.domContentLoaded = true;\n                    checkPageReady();\n                });\n        \n                window.addEventListener('load', () => {\n                    debugLog('EVENT', 'Window load event fired');\n                    loadingStates.windowLoaded = true;\n                    checkPageReady();\n                    startPeriodicCheck();\n                });\n        \n                const observer = new MutationObserver((mutations) => {\n                    let hasNewResources = false;\n                    mutations.forEach(mutation => {\n                        mutation.addedNodes.forEach(node => {\n                            if (node.nodeType === 1) {\n                                hasNewResources = true;\n                                debugLog('MUTATION', 'New resource detected', {\n                                    nodeType: node.nodeName,\n                                    attributes: node instanceof Element ? Array.from(node.attributes).map(attr => ({\n                                        name: attr.name,\n                                        value: attr.value\n                                    })) : null\n                                });\n                            }\n                        });\n                    });\n                    \n                    if (hasNewResources && !hasSignaledReady) {\n                        debugLog('MUTATION', 'New resources detected, scheduling check');\n                        setTimeout(checkPageReady, 100);\n                    }\n                });\n        \n                observer.observe(document.documentElement, {\n                    childList: true,\n                    subtree: true,\n                    attributes: true,\n                    attributeFilter: ['src', 'href']\n                });\n        \n                window.addEventListener('error', (event) => {\n                    let errorMessage;\n                    \n                    if (event.target && (event.target.tagName === 'IMG' || event.target.tagName === 'SCRIPT' || \n                        event.target.tagName === 'LINK' || event.target.tagName === 'IFRAME')) {\n                        errorMessage = 'Failed to load resource: ' + (event.target.src || event.target.href);\n                        debugLog('ERROR', 'Resource loading error', {\n                            type: event.target.tagName,\n                            source: event.target.src || event.target.href\n                        });\n                        \n                        setTimeout(checkPageReady, 100);\n                    } else {\n                        errorMessage = 'JavaScript error: ' + event.message + \n                                    ' at ' + (event.filename || 'unknown') + \n                                    ':' + (event.lineno || 'unknown') + \n                                    ':' + (event.colno || 'unknown');\n                        debugLog('ERROR', 'JavaScript runtime error', {\n                            message: event.message,\n                            filename: event.filename,\n                            line: event.lineno,\n                            column: event.colno\n                        });\n                    }\n        \n                    if (!reportedErrors.has(errorMessage)) {\n                        reportedErrors.add(errorMessage);\n                        sendMessage('error', [errorMessage]);\n                    }\n        \n                    event.preventDefault();\n                    return true;\n                }, true);\n        \n                window.addEventListener('unhandledrejection', (event) => {\n                    const errorMessage = 'Unhandled Promise Rejection: ' + (event.reason || 'Unknown reason');\n                    debugLog('ERROR', 'Unhandled promise rejection', {\n                        reason: event.reason\n                    });\n                    \n                    if (!reportedErrors.has(errorMessage)) {\n                        reportedErrors.add(errorMessage);\n                        sendMessage('error', [errorMessage]);\n                    }\n                    \n                    event.preventDefault();\n                    return true;\n                });\n        \n                const originalRAF = window.requestAnimationFrame;\n                window.requestAnimationFrame = (callback) => {\n                    return originalRAF.call(window, (...args) => {\n                        try {\n                            callback(...args);\n                        } catch (error) {\n                            const errorMessage = 'Error in requestAnimationFrame: ' + error.message;\n                            debugLog('ERROR', 'RAF error', {\n                                message: error.message,\n                                stack: error.stack\n                            });\n                            \n                            if (!reportedErrors.has(errorMessage)) {\n                                reportedErrors.add(errorMessage);\n                                sendMessage('error', [errorMessage]);\n                            }\n                            return true;\n                        }\n                    });\n                };\n        \n                document.addEventListener('visibilitychange', () => {\n                    debugLog('VISIBILITY', 'Visibility changed', {\n                        hidden: document.hidden,\n                        hasSignaledReady\n                    });\n                    \n                    if (!document.hidden && !hasSignaledReady) {\n                        checkPageReady();\n                    }\n                });\n        \n                // Add helper functions for CSV and data handling\n                window.load_data_from_csv = async (filename) => {\n                    const isInIframe = (() => {\n                        try {\n                            return window.self !== window.top;\n                        } catch (e) {\n                            return true;\n                        }\n                    })();\n        \n                    const submissionUrl = isInIframe ? \n                        '/chat/load_csv/' : \n                        '${this.csvLoadUrl}';\n        \n                    try {\n                        const response = await fetch(submissionUrl, {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                            body: JSON.stringify({\n                                filename: filename,\n                                block_id: '${this.messageId}',\n                                is_iframe: isInIframe\n                            }),\n                            credentials: 'include'\n                        });\n        \n                        if (!response.ok) {\n                            throw new Error("HTTP error! status: " + response.status);\n                        }\n        \n                        const result = await response.json();\n                        \n                        if (!result.success) {\n                            throw new Error(result.error || 'Failed to fetch CSV data');\n                        }\n        \n                        return new Promise((resolve, reject) => {\n                            Papa.parse(result.data, {\n                                header: true,\n                                dynamicTyping: true,\n                                skipEmptyLines: true,\n                                complete: (results) => {\n                                    resolve({\n                                        success: true,\n                                        data: results.data,\n                                        meta: results.meta,\n                                        filename: filename\n                                    });\n                                },\n                                error: (error) => {\n                                    reject(new Error("CSV parsing error: " + error));\n                                }\n                            });\n                        });\n        \n                    } catch (error) {\n                        console.error('Error processing CSV:', error);\n                        throw error;\n                    }\n                };\n        \n                window.save_data_to_csv = async (filename, data) => {\n                    const isInIframe = (() => {\n                        try {\n                            return window.self !== window.top;\n                        } catch (e) {\n                            return true;\n                        }\n                    })();\n        \n                    const submissionUrl = isInIframe ? \n                        '/chat/save_csv/' : \n                        '${this.csvSubmissionUrl}';\n        \n                    const payload = {\n                        filename: filename,\n                        data: data,\n                        block_id: '${this.messageId}',\n                        is_iframe: isInIframe\n                    };\n        \n                    try {\n                        const response = await fetch(submissionUrl, {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                            body: JSON.stringify(payload),\n                            credentials: 'include'\n                        });\n        \n                        const result = await response.json();\n                        \n                        if (result.success) {\n                            return result;\n                        } else {\n                            console.error('Error saving data:', result.error);\n                            throw new Error(result.error);\n                        }\n                    } catch (error) {\n                        console.error('Error saving data:', error);\n                        throw error;\n                    }\n                };\n        \n                window.call_llm = async (system_prompt, user_messages, json_fields) => {\n                    const isInIframe = (() => {\n                        try {\n                            return window.self !== window.top;\n                        } catch (e) {\n                            return true;\n                        }\n                    })();\n        \n                    const llmUrl = isInIframe ? '/chat/llm/' : '${this.llmUrl}';\n        \n                    const payload = {\n                        system_prompt: system_prompt,\n                        messages: user_messages,\n                        json_fields: json_fields,\n                        block_id: '${this.messageId}'\n                    };\n        \n                    try {\n                        const response = await fetch(llmUrl, {\n                            method: 'POST',\n                            headers: {\n                                'Content-Type': 'application/json'\n                            },\n                        body: JSON.stringify(payload),\n                        credentials: 'include'\n                    });\n\n                    if (!response.ok) {\n                        throw new Error("HTTP error!");\n                    }\n\n                    const data = await response.json();\n                    if (data.success) {\n                        return data.response;\n                    } else {\n                        console.error('Error calling LLM:', data.error);\n                        throw new Error(data.error);\n                    }\n                } catch (error) {\n                    console.error('Error in LLM call:', error);\n                    throw error;\n                }\n            };\n        })();<\/script>`,i=this.generatePermissiveCSP();t=t.replace("<head>",`<head>${i}\n\n\n            <base target="_blank">\n            <script>\n            (function() {\n                document.addEventListener('click', function(e) {\n                    if (e.target.tagName === 'A' && e.target.href) {\n                        e.preventDefault();\n                        window.parent.postMessage({ \n                            source: 'code-block-preview',\n                            type: 'link', \n                            href: e.target.href \n                        }, '*');\n                    }\n                }, true);\n            })();\n            <\/script>\n        \n\n${s}`),e.srcdoc=t,this.iframeMessageListenerAdded||(window.addEventListener("message",this.handleIframeMessage),this.iframeMessageListenerAdded=!0)}showLoadingOverlay(e=!1){if("focus"!==this._mode)return;if(!this.initialLoad&&!e&&"html"!==this._language&&"svg"!==this._language)return;if(this.contentContainer.querySelector("#focus-loading-overlay"))return this.loadingOverlayTimeout&&clearTimeout(this.loadingOverlayTimeout),void(this.loadingOverlayTimeout=setTimeout((()=>{this.removeLoadingOverlay()}),26e3));const t=document.createElement("div");t.id="focus-loading-overlay",t.className="absolute inset-0 z-[9999] overflow-hidden flex items-center justify-center",t.style.cssText="\n            background-color: rgba(0, 0, 0, 0.5);\n            backdrop-filter: blur(1px);\n            -webkit-backdrop-filter: blur(1px);\n            opacity: 0;\n            transition: opacity 0.3s ease-in-out;\n        ",t.innerHTML='\n            <div class="thinking-dots-container-quad text-white">\n                <div class="thinking-dot-quad thinking-dot-1-quad"></div>\n                <div class="thinking-dot-quad thinking-dot-2-quad"></div>\n                <div class="thinking-dot-quad thinking-dot-3-quad"></div>\n            </div>\n        ',this.contentContainer&&(this.contentContainer.style.position="relative",this.contentContainer.appendChild(t),requestAnimationFrame((()=>{t.style.opacity="1"}))),this.loadingOverlayTimeout=setTimeout((()=>{this.removeLoadingOverlay()}),26e3)}removeLoadingOverlay(){const e=document.getElementById("focus-loading-overlay");e&&(e.style.opacity="0",setTimeout((()=>e.remove()),300))}bindSearchShortcut(){}createSearchBar(){const e=document.createElement("div");e.classList=`absolute top-2 right-2 z-40 ${this.theme.focusBackground} rounded-lg shadow-lg transition-all duration-300 transform scale-95 opacity-0 invisible flex flex-col`;const t=document.createElement("div");t.classList="flex items-center gap-2 p-2";const s={type:"search",placeholder:"Find",size:"small",width:"200px",onChange:e=>{this.handleSearch()}};this.searchInput=new d(s);this.replaceInput=new d({type:"text",placeholder:"Replace",size:"small",width:"200px"});const i=document.createElement("div");i.classList=`${this.theme.fadedText} text-sm min-w-[60px]`,i.textContent="0/0",this.matchCounter=i;const n=document.createElement("div");n.classList="flex items-center gap-1";const a=document.createElement("button");a.classList=`${this.theme.buttonSecondary} p-1 rounded disabled:opacity-50`,a.innerHTML='<i class="fas fa-chevron-up"></i>',a.addEventListener("click",(()=>this.previousMatch()));const o=document.createElement("button");o.classList=`${this.theme.buttonSecondary} p-1 rounded disabled:opacity-50`,o.innerHTML='<i class="fas fa-chevron-down"></i>',o.addEventListener("click",(()=>this.nextMatch()));const r=document.createElement("button");r.classList=`${this.theme.buttonSecondary} p-1 rounded`,r.innerHTML='<i class="fas fa-exchange-alt"></i>',r.title="Toggle Replace",r.addEventListener("click",(()=>this.toggleReplace()));const l=document.createElement("button");l.classList=`${this.theme.buttonSecondary} p-1 rounded`,l.innerHTML='<i class="fas fa-times"></i>',l.addEventListener("click",(()=>this.hideSearch()));const c=document.createElement("div");c.classList="flex items-center gap-2 p-2 hidden",this.replaceButtons=c;const h=document.createElement("button");h.classList=`${this.theme.buttonSecondary} text-sm px-2 py-1 rounded`,h.textContent="Replace",h.addEventListener("click",(()=>this.replace()));const m=document.createElement("button");m.classList=`${this.theme.buttonSecondary} text-sm px-2 py-1 rounded`,m.textContent="Replace All",m.addEventListener("click",(()=>this.replaceAll())),n.appendChild(a),n.appendChild(o);const u=document.createElement("div");this.searchInput.render(u);const p=document.createElement("div");return p.classList.add("hidden"),this.replaceInput.render(p),t.appendChild(u),t.appendChild(p),t.appendChild(i),t.appendChild(n),t.appendChild(r),t.appendChild(l),c.appendChild(h),c.appendChild(m),e.appendChild(t),e.appendChild(c),this.searchInput.inputField.addEventListener("keydown",(e=>this.handleSearchKeyDown(e))),e}toggleSearch(){this.searchBar||(this.searchBar=this.createSearchBar(),this.contentContainer.appendChild(this.searchBar)),this.searchVisible?this.hideSearch():this.showSearch()}showSearch(){this.searchVisible=!0,this.searchBar.classList.remove("invisible"),requestAnimationFrame((()=>{this.searchBar.classList.remove("scale-95","opacity-0"),this.searchInput.focus()}))}hideSearch(){this.searchVisible=!1,this.searchBar.classList.add("scale-95","opacity-0"),setTimeout((()=>{this.searchBar.classList.add("invisible"),this.clearHighlights()}),300)}toggleReplace(){const e=this.replaceInput.classList.contains("hidden");this.replaceInput.classList.toggle("hidden"),this.replaceButtons.classList.toggle("hidden"),e?this.replaceInput.focus():this.searchInput.focus()}handleSearch(){clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((()=>{const e=this.searchInput.value;if(!e||0===e.length)return void this.clearHighlights();const t=this.codeBlock.textContent;try{const s=new RegExp(e,"gi");let i;for(this.searchMatches=[];null!==(i=s.exec(t));)this.searchMatches.push({start:i.index,end:i.index+i[0].length,text:i[0]});this.currentMatch=this.searchMatches.length>0?0:-1,this.matchCounter.textContent=`${this.searchMatches.length?this.currentMatch+1:0}/${this.searchMatches.length}`,this.searchMatches.length>0?(this.highlightMatches(),this.scrollToMatch(0)):this.clearHighlights()}catch(e){}}),100)}handleSearchKeyDown(e){"Enter"===e.key?(e.preventDefault(),e.shiftKey?this.previousMatch():this.nextMatch()):"Escape"===e.key&&(e.preventDefault(),this.hideSearch())}findMatches(e){if(!e||0===e.length)return void this.clearHighlights();const t=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");try{const e=new RegExp(t,"gi"),s=this.codeBlock.textContent;let i;for(this.searchMatches=[];null!==(i=e.exec(s));)this.searchMatches.push({start:i.index,end:i.index+i[0].length,text:i[0]});this.currentMatch=this.searchMatches.length>0?0:-1,this.matchCounter.textContent=`${this.searchMatches.length?this.currentMatch+1:0}/${this.searchMatches.length}`,this.searchMatches.length>0?(this.highlightMatches(),this.scrollToMatch(0)):this.clearHighlights()}catch(e){this.clearHighlights()}}clearHighlights(){this.codeBlock.querySelectorAll(".search-highlight").forEach((e=>{e.parentNode.replaceChild(document.createTextNode(e.textContent),e)})),this.searchMatches=[],this.currentMatch=0,this.matchCounter.textContent="0/0"}highlightMatches(){const e=this.codeBlock.innerHTML,t=document.createElement("div");t.innerHTML=e;this.codeBlock.textContent;const s=[];this.searchMatches.forEach(((e,t)=>{s.push({index:e.start,type:"start",matchIndex:t}),s.push({index:e.end,type:"end",matchIndex:t})})),s.sort(((e,t)=>e.index-t.index));let i="",n=0,a=!1;s.forEach((e=>{"start"===e.type?(i+=t.innerHTML.substring(n,e.index),i+=`<span class="search-highlight ${e.matchIndex===this.currentMatch?"current-match":""}" \n                          style="background-color: ${e.matchIndex===this.currentMatch?"rgba(255, 255, 0, 0.3)":"rgba(255, 255, 0, 0.2)"}">`,a=!0):(i+="</span>",n=e.index,a=!1)})),i+=t.innerHTML.substring(n),this.codeBlock.innerHTML=i,this.matchCounter.textContent=`${this.searchMatches.length?this.currentMatch+1:0}/${this.searchMatches.length}`}scrollToMatch(e){if(!this.searchMatches[e])return;const t=this.codeBlock.querySelectorAll(".search-highlight")[e];t&&t.scrollIntoView({behavior:"smooth",block:"center"}),this.currentMatch=e,this.matchCounter.textContent=`${e+1}/${this.searchMatches.length}`,this.highlightMatches()}nextMatch(){0!==this.searchMatches.length&&(this.currentMatch=(this.currentMatch+1)%this.searchMatches.length,this.scrollToMatch(this.currentMatch))}previousMatch(){0!==this.searchMatches.length&&(this.currentMatch=(this.currentMatch-1+this.searchMatches.length)%this.searchMatches.length,this.scrollToMatch(this.currentMatch))}replace(){if(0===this.searchMatches.length||this.currentMatch>=this.searchMatches.length)return;const e=this.searchMatches[this.currentMatch],t=this.replaceInput.value,s=this.codeBlock.textContent,i=s.substring(0,e.start)+t+s.substring(e.end);this.codeBlock.textContent=i,this.saveState(),this.handleSearch()}replaceAll(){if(0===this.searchMatches.length)return;const e=this.searchInput.value,t=this.replaceInput.value,s=this.codeBlock.textContent.replace(new RegExp(e,"g"),t);this.codeBlock.textContent=s,this.saveState(),this.handleSearch()}async getDataSettings(){try{const e=await g.G.postData("/chat/get-code-data-settings/",{chat_message_id:this.messageId});if(!e.success)throw new Error(e.error||"Failed to fetch settings");return{enabled:e.settings.enabled||!1,emails:e.settings.emails||""}}catch(e){return{enabled:!1,emails:""}}}async saveDataSettings(e,t){try{const s=await g.G.postData("/chat/save-code-data-settings/",{chat_message_id:this.messageId,enabled:e,emails:t});if(s.success)return this.showToast("Settings saved successfully","success"),!0;throw new Error(s.error||"Failed to save settings")}catch(e){return this.showToast(e.message||"Failed to save settings","error"),!1}}validateEmails(e){if(!e.trim())return!0;const t=e.split(",").map((e=>e.trim())),s=/^[^\s@]+@[^\s@]+\.[^\s@]+$/,i=t.filter((e=>!s.test(e)));return!(i.length>0)||(this.showToast(`Invalid email(s): ${i.join(", ")}`,"error"),!1)}async clearAllData(e){try{return await g.G.postData(`/chat/clear-project-submissions/${this.messageId}/`,{}),!0}catch(e){throw e}}async showAppDataSettings(e){const t=this.showLoadingModal("Loading settings...","App Data Settings"),s=await this.getDataSettings();t.close();const i=document.createElement("div");i.className="pt-4 space-y-6";const a=document.createElement("div");a.className=`${this.theme.secondaryBackground} rounded-lg p-4 flex justify-between items-start`;const h=document.createElement("div");h.className="flex items-start gap-3";const m=document.createElement("div"),u=o.A.name("database"),p=new r.I({pathData:u.path,viewBox:u.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.text});m.appendChild(p.element);const g=document.createElement("div");g.className="space-y-0.5";const f=document.createElement("div");f.className=`${this.theme.text} font-semibold text-base`,f.textContent="Enable app storage";const v=document.createElement("div");v.className=`${this.theme.fadedText} text-sm`,v.textContent="This enables a basic database for your app. Only you will be able to access the stored data.",g.appendChild(f),g.appendChild(v),h.appendChild(m),h.appendChild(g);const y=new C({size:"normal",value:s.enabled});a.appendChild(h),y.render(a);const w=document.createElement("div");w.className=`${this.theme.secondaryBackground} rounded-lg p-4 space-y-6`,w.style.display=y.value?"block":"none";const b=document.createElement("div");b.className="space-y-1";const x=document.createElement("div");x.className=`${this.theme.text} font-bold text-xl`,x.textContent="Data export options:";const k=document.createElement("div");k.className="flex gap-2 pt-2";const E=o.A.name("file");!E||E.path;const S=new n.$({text:"Download as CSV",type:"primary",size:"small",...E&&E.path?{svgPathData:E.path,svgViewBox:E.viewBox}:{}});S.onClick((()=>{this.downloadFormSubmissions()}));const T=o.A.name("chart");!T||T.path;const L=new n.$({text:"Create visualization",type:"primary",size:"small",...T&&T.path?{svgPathData:T.path,svgViewBox:T.viewBox}:{}});L.onClick((async()=>{await this.visualizeFormSubmissions()})),k.appendChild(S.element),k.appendChild(L.element);const _=o.A.name("trash");!_||_.path;const I=new n.$({text:"Clear all data",type:"secondary",size:"small",..._&&_.path?{svgPathData:_.path,svgViewBox:_.viewBox}:{}});I.onClick((async()=>{const t=new l({size:"small",title:"Clear all data",body:`\n                    <div class="space-y-2">\n                        <div class="${this.theme.text}">\n                            Are you sure you want to clear all stored data? This action cannot be undone.\n                        </div>\n                    </div>\n                `,closeX:!0,confirm:!0,cancel:!0,buttonWidth:"full",confirmText:"Yes, clear all data",cancelText:"Cancel"});t.onConfirm((async()=>{const s=this.showLoadingModal("Clearing data...","Please wait");try{await this.clearAllData(e),s.close(),t.close(),new c.y("Form data has been cleared successfully","success")}catch(e){s.close(),new c.y("Form data could not be cleared","error")}}))})),k.appendChild(I.element),b.appendChild(x),b.appendChild(k),b.appendChild(x),b.appendChild(k);const A=document.createElement("div");A.className="space-y-1";const M=document.createElement("div");M.className=`${this.theme.text} font-bold`,M.textContent="Notify by email of new data:";const B=new d({placeholder:"Enter email addresses separated by commas",value:s.emails||"",type:"text",helpText:"Multiple emails can be separated by commas. Leave empty to disable notifications.",onChange:e=>{B.inputField.classList.remove("border-red-500")}});A.appendChild(M),A.appendChild(B.inputContainer),w.appendChild(b),w.appendChild(A),y.onChange((e=>{w.style.display=e?"block":"none",e||(B.value="")})),i.appendChild(a),i.appendChild(w);const D=new l({size:"medium",title:"App data settings",body:i,closeX:!0,confirm:!0,cancel:!1,buttonWidth:"full",buttonSize:"large",confirmText:"Save settings",manualCloseOnConfirm:!0});this.dataModal=D,D.onConfirm((async()=>{const e=this.showLoadingModal("Saving settings...","Saving"),t=B.value.trim();if(!this.validateEmails(t))return e.close(),void B.inputField.classList.add("border-red-500");const s=await this.saveDataSettings(y.value,t);e.close(),s&&D.close()}))}handleVisibilityChange(){!document.hidden&&this.highlightPending&&this.runPendingHighlight()}createSelectionSnapshotForNewContent(e){const t=document.getSelection();if(!t||0===t.rangeCount||!this.codeBlock)return null;const s=t.getRangeAt(0);if(!(this.codeBlock.contains(s.startContainer)||this.codeBlock.contains(s.endContainer)))return null;const i=this.codeBlock.textContent||"",n=this.getTextOffset(this.codeBlock,s.startContainer,s.startOffset),a=this.getTextOffset(this.codeBlock,s.endContainer,s.endOffset),o=t.isCollapsed,r=this.mapSelectionToNewContent(i,e,n,a,o);return r?{start:r.start,end:r.end,collapsed:o,valid:!0}:null}mapSelectionToNewContent(e,t,s,i,n){if(t.length>=s&&e.slice(0,s)===t.slice(0,s))return n?{start:s,end:s}:(t.length>=i&&(e.slice(0,i),t.slice(0,i)),{start:s,end:i});if(!n){const n=e.slice(s,i);if(n){const e=t.indexOf(n);if(-1!==e)return{start:e,end:e+n.length}}}if(n){const i=e.slice(0,s),n=t;let a=0;const o=Math.min(i.length,n.length);for(;a<o&&i[a]===n[a];)a++;return{start:a,end:a}}const a=Math.min(s,t.length);return{start:a,end:a}}injectMarkers(e,t){const s=Math.max(0,Math.min(t.start,e.length)),i=Math.max(0,Math.min(t.end,e.length)),n=this.SELECTION_START_MARK,a=this.SELECTION_END_MARK;if(t.collapsed){return{marked:e.slice(0,s)+n+e.slice(s)}}return{marked:e.slice(0,s)+n+e.slice(s,i)+a+e.slice(i)}}restoreSelectionFromMarkers(){const e=this.SELECTION_START_MARK,t=this.SELECTION_END_MARK,s=document.createTreeWalker(this.codeBlock,NodeFilter.SHOW_TEXT,null);let i=null,n=0,a=null,o=0;const r=[];for(;s.nextNode();)r.push(s.currentNode);for(const t of r){const s=t.nodeValue||"",a=s.indexOf(e);-1!==a&&(i=t,n=a,t.nodeValue=s.replace(e,""))}for(const e of r){const s=e.nodeValue||"",i=s.indexOf(t);-1!==i&&(a=e,o=i,e.nodeValue=s.replace(t,""))}const l=document.getSelection();if(!l)return;const c=document.createRange();if(i&&!a)c.setStart(i,Math.max(0,Math.min(n,i.nodeValue.length))),c.collapse(!0);else{if(!i||!a)return;c.setStart(i,Math.max(0,Math.min(n,i.nodeValue.length))),c.setEnd(a,Math.max(0,Math.min(o,a.nodeValue.length)))}l.removeAllRanges(),l.addRange(c)}captureSelectionOffsets(){const e=document.getSelection();if(!e||0===e.rangeCount||!this.codeBlock)return null;const t=e.getRangeAt(0);if(!(this.codeBlock.contains(t.startContainer)||this.codeBlock.contains(t.endContainer)))return null;return{start:this.getTextOffset(this.codeBlock,t.startContainer,t.startOffset),end:this.getTextOffset(this.codeBlock,t.endContainer,t.endOffset),collapsed:e.isCollapsed}}restoreSelectionFromOffsets(e){try{const t=document.createRange();this.setRangePoint(t,this.codeBlock,e.start,!0),this.setRangePoint(t,this.codeBlock,e.collapsed?e.start:e.end,!1);const s=document.getSelection();s.removeAllRanges(),s.addRange(t)}catch(e){}}}customElements.define("code-block",we);let be=null;class Ce extends HTMLElement{constructor(){super(),this.structureDisplayContainer=null,this._src="",this._uniprotId="",this._format="pdb",this._rightAlign=!1,this._fullWidth=!1,this._loading=!1,this.theme=i.A.theme,this.viewer=null,this._metadata=null,this._showMetadata=!0,this._highlightResidues=null,this.focusInstance=null,this.minimizedView=null,this._minimize=!1,this._mode="",this.originalInstance=null,this._bindMethods()}_bindMethods(){this.downloadStructure=this.downloadStructure.bind(this),this.handleFocus=this.handleFocus.bind(this),this.closeFocus=this.closeFocus.bind(this),this.loadFromAlphaFold=this.loadFromAlphaFold.bind(this),this.copyShareLink=this.copyShareLink.bind(this),this.copyPDBLink=this.copyPDBLink.bind(this),this.toggleMetadata=this.toggleMetadata.bind(this)}static get observedAttributes(){return["src","uniprot-id","format","right-align","full-width","loading","chat-id","mode","minimize","compare-ids","highlight-residues","show-metadata"]}attributeChangedCallback(e,t,s){if(t!==s||"src"===e||"uniprot-id"===e||"loading"===e)switch(e){case"src":this._src=s,this._src&&(this._loading=!1,this.hasAttribute("loading")&&this.removeAttribute("loading")),this.isConnected&&this._render();break;case"uniprot-id":this._uniprotId=s,this._uniprotId&&this.isConnected&&this.loadFromAlphaFold();break;case"format":this._format=s||"pdb";break;case"right-align":this._rightAlign=this.hasAttribute("right-align"),"focus"!==this._mode&&this._updateContainerClasses();break;case"full-width":this._fullWidth=this.hasAttribute("full-width"),"focus"!==this._mode&&this._updateContainerClasses();break;case"loading":const e=this.hasAttribute("loading");this._loading!==e&&(this._loading=e,this._render());break;case"chat-id":this.chatId=s;break;case"mode":this._mode=s;break;case"minimize":this._minimize=this.hasAttribute("minimize");break;case"highlight-residues":this._highlightResidues=s,this._highlightResidues&&this.viewer&&this.highlightResidues(this._highlightResidues);break;case"show-metadata":this._showMetadata=this.hasAttribute("show-metadata"),this._showMetadata&&this._metadata&&this._addMetadataBadge()}}async connectedCallback(){if(this.style.display="block",this._mode=this.getAttribute("mode")||"",this._format=this.getAttribute("format")||"pdb",this.chatId=this.getAttribute("chat-id"),this._highlightResidues=this.getAttribute("highlight-residues"),this.hasAttribute("src")&&(this._src=this.getAttribute("src")),this.hasAttribute("uniprot-id")&&(this._uniprotId=this.getAttribute("uniprot-id")),"focus"===this._mode){this.classList.add("h-full","flex","flex-col");const e=this._createFocusMenuOptions();this.focusWindowMenu=new D(e);const t=this.focusWindowMenu.create();this.appendChild(t),this.structureDisplayContainer||this._createStructureDisplayContainer(),await this._loadMolstarLibrary(),this._uniprotId?(await this.loadFromAlphaFold(),this.hasAttribute("show-metadata")&&await this._fetchMetadata()):this._render()}else this.classList.add("my-2"),this._renderFileView()}async loadFromAlphaFold(){if(this._uniprotId){this._loading=!0,this._render();try{const e=`https://alphafold.ebi.ac.uk/files/AF-${this._uniprotId}-F1-model_v4.${this._format}`;this._src=e,this._loading=!1,this._render()}catch(e){this._renderError("Failed to load structure from AlphaFold")}}}async _fetchMetadata(){if(this._uniprotId)try{const e=await fetch(`https://alphafold.ebi.ac.uk/api/prediction/${this._uniprotId}`);if(e.ok){const t=await e.json();this._metadata=t[0]}}catch(e){}}async _loadMolstarLibrary(){return be||(be=new Promise((async(e,t)=>{try{const s="molstar-css";if(!document.getElementById(s)){const e=document.createElement("link");e.id=s,e.rel="stylesheet",e.href="https://www.ebi.ac.uk/pdbe/pdb-component-library/css/pdbe-molstar-3.1.0.css",document.head.appendChild(e)}const i="molstar-js";if(document.getElementById(i))window.PDBeMolstarPlugin&&e();else{const s=document.createElement("script");s.id=i,s.type="text/javascript",s.src="https://www.ebi.ac.uk/pdbe/pdb-component-library/js/pdbe-molstar-plugin-3.1.0.js",s.onload=()=>{setTimeout((()=>{window.PDBeMolstarPlugin?e():t(new Error("PDBe Molstar failed to initialize"))}),100)},s.onerror=()=>t(new Error("Failed to load PDBe Molstar library")),document.head.appendChild(s)}}catch(e){t(e)}}))),be}_createStructureDisplayContainer(){const e=document.createElement("div");"focus"===this._mode?e.className="flex-grow relative bg-gray-900 overflow-hidden h-[calc(100dvh-75px)]":(e.className="relative",e.style.minHeight="400px"),this.appendChild(e),this.structureDisplayContainer=document.createElement("div"),this.structureDisplayContainer.style.width="100%",this.structureDisplayContainer.style.height="100%","focus"!==this._mode&&(this.structureDisplayContainer.style.minHeight="400px"),e.appendChild(this.structureDisplayContainer)}_updateContainerClasses(){if(!this.structureDisplayContainer)return;if("focus"===this._mode)return this.structureDisplayContainer.className="w-full h-full",void(this.structureDisplayContainer.style.minHeight="600px");const e=this.structureDisplayContainer.parentElement;e.className="flex w-full",e.classList.add(this._rightAlign?"justify-end":"justify-start");let t=["relative","aspect-square","rounded-lg","overflow-hidden","bg-black"];t.push(this._fullWidth?"w-full":"w-full max-w-2xl"),this.structureDisplayContainer.className=t.join(" "),this.structureDisplayContainer.style.minHeight="400px",this.structureDisplayContainer.style.minWidth="400px"}async _render(){this.structureDisplayContainer||this._createStructureDisplayContainer(),this._updateContainerClasses();try{await this._loadMolstarLibrary(),this._loading?this._renderLoading():this._src?await this._renderStructure():this._renderPlaceholder()}catch(e){this._renderError("Failed to load structure viewer.")}}_renderPlaceholder(){this._clearContent(),this.structureDisplayContainer.innerHTML='<div class="w-full h-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 p-4 text-center">\n            <p class="text-4xl mb-2"></p>\n            <p class="text-sm font-medium">Protein Structure Viewer</p>\n            <p class="text-xs opacity-75">Waiting for structure...</p>\n        </div>'}_renderError(e){this._clearContent(),this.structureDisplayContainer.innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center text-red-500 dark:text-red-400 p-4 text-center">\n            <p class="text-4xl mb-2"></p>\n            <p class="text-sm font-medium">${e}</p>\n        </div>`}_renderLoading(){this._clearContent();const e=document.createElement("div");e.className="w-full h-full flex items-center justify-center opacity-50 p-2";const t=document.createElement("div"),s=o.A.name("spinner"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-8 h-8",additionalClasses:`animate-spin ${this.theme.iconColor}`});t.appendChild(i.element),e.appendChild(t),this.structureDisplayContainer.appendChild(e)}_removeExpandedViewportButton(e){const t=e.querySelector('button[title="Toggle Expanded Viewport"], [aria-label="Toggle Expanded Viewport"]');t&&(t.style.display="none")}async _renderStructure(){this.structureDisplayContainer&&this.structureDisplayContainer.querySelector('[id^="molstar-"]')&&this._clearContent();const e=document.createElement("div");e.id=`molstar-${Date.now()}`,e.style.width="100%",e.style.height="100%",e.style.position="relative","focus"!==this._mode&&(e.style.minHeight="400px"),this.structureDisplayContainer.appendChild(e),await new Promise((e=>setTimeout(e,100)));try{if(window.PDBeMolstarPlugin){const t=e.getBoundingClientRect();0!==t.width&&0!==t.height||(e.style.width="600px",e.style.height="600px");const s=["expand",..."focus"!==this._mode?["selection","animation","controlToggle"]:[]],i={customData:{url:this._src,format:"cif"===this._format?"mmcif":this._format,binary:!1},alphafoldView:!!this._uniprotId,bgColor:{r:0,g:0,b:0},hideCanvasControls:s,sequencePanel:!0,hideControls:!1,viewport:{canvas:{width:t.width||600,height:t.height||600}}};this.viewer=new window.PDBeMolstarPlugin,await this.viewer.render(e,i),this._removeExpandedViewportButton(e),this._highlightResidues&&this.highlightResidues(this._highlightResidues),this._showMetadata&&this._metadata&&this._addMetadataBadge(),"focus"===this._mode&&this._setupResizeObserver()}}catch(e){this._renderError("Failed to load protein structure")}if("focus"!==this._mode){const e=document.createElement("div");e.className="absolute top-2 right-2 z-10 hidden";const t=document.createElement("div");t.className="flex gap-0.5",e.appendChild(t);const s=new n.$({text:"",type:"focus",size:"icon",svgPathData:o.A.name("cloudDownload").path,svgViewBox:o.A.name("cloudDownload").viewBox,width:"full",iconHeightAndWidth:"w-6 h-6"});s.onClick(this.downloadStructure),s.render(t);const i=new n.$({text:"",type:"focus",size:"icon",svgPathData:o.A.name("focus").path,svgViewBox:o.A.name("focus").viewBox,width:"full",iconHeightAndWidth:"w-6 h-6"});i.onClick(this.handleFocus),i.render(t),this.structureDisplayContainer.appendChild(e),u.K.isOnTouchDevice?e.classList.remove("hidden"):(this.structureDisplayContainer.addEventListener("mouseenter",(()=>e.classList.remove("hidden"))),this.structureDisplayContainer.addEventListener("mouseleave",(()=>e.classList.add("hidden"))))}}_addMetadataBadge(){if(!this._metadata)return;const e=this.structureDisplayContainer.querySelector(".metadata-badge");e&&e.remove();const t=document.createElement("div");t.className="metadata-badge absolute top-2 left-2 bg-black/70 backdrop-blur-sm rounded-md px-3 py-2 text-white text-xs z-20",t.innerHTML=`\n            <div class="flex items-center gap-2">\n                <span class="font-semibold">${this._metadata.gene||this._uniprotId}</span>\n                <span class="text-gray-300"></span>\n                <span class="text-gray-300">${this._metadata.organism||"Unknown"}</span>\n                <span class="text-gray-300"></span>\n                <span class="text-green-400">pLDDT: ${this._metadata.confidenceAvg?.toFixed(1)||"N/A"}</span>\n            </div>\n            <div class="text-gray-400 mt-1">\n                ${this._metadata.uniprotDescription||""}\n            </div>\n        `,this.structureDisplayContainer.appendChild(t)}async loadComparisonStructures(){if(!this.viewer)return;const e=this._compareIds.split(",");for(let t=0;t<e.length;t++){const s=e[t].trim();try{const e=`https://alphafold.ebi.ac.uk/files/AF-${s}-F1-model_v4.${this._format}`;await this.viewer.load({customData:{url:e,format:"cif"===this._format?"mmcif":this._format,binary:!1},superpose:!0,representationStyle:"cartoon",representationColor:0===t?"#ff0000":1===t?"#00ff00":"#ffff00"})}catch(e){}}}highlightResidues(e){if(this.viewer&&e)try{e.split(",").forEach((e=>{const[t,s]=e.includes("-")?e.split("-").map((e=>parseInt(e.trim()))):[parseInt(e.trim()),parseInt(e.trim())];this.viewer.visual.select({data:[{start_residue_number:t,end_residue_number:s}],nonSelectedColor:{r:200,g:200,b:200},hideNonSelected:!1})}))}catch(e){}}async copyShareLink(){const e=this._uniprotId?`https://alphafold.ebi.ac.uk/entry/${this._uniprotId}`:this._src;try{await navigator.clipboard.writeText(e),new c.y("AlphaFold link copied!","success")}catch(e){new c.y("Failed to copy link","error")}}async copyPDBLink(){try{await navigator.clipboard.writeText(this._src),new c.y("PDB file link copied!","success")}catch(e){new c.y("Failed to copy link","error")}}toggleMetadata(){const e=this.structureDisplayContainer.querySelector(".metadata-badge");e&&(e.style.display="none"===e.style.display?"block":"none")}async downloadStructure(){if(this._src)try{const e=await fetch(this._src);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.blob();let s=this._uniprotId?`AF-${this._uniprotId}-F1-model.${this._format}`:this._src.split("/").pop().split("?")[0]||`structure.${this._format}`;const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout((()=>URL.revokeObjectURL(i)),100)}catch(e){alert(`Download failed: ${e.message}. Please try again.`)}}_createFocusMenuOptions(){return{title:this._uniprotId?`AlphaFold: ${this._uniprotId}`:this._src.split("/").pop().split("?")[0]||"Protein Structure",mode:"focus",fileMenu:[{type:"item",label:"Download Structure",onClick:this.downloadStructure},{type:"item",label:"Copy AlphaFold Link",onClick:this.copyShareLink},{type:"item",label:"Copy PDB URL",onClick:this.copyPDBLink}],quickActions:[{type:"icon",icon:"cloudDownload",hoverText:"Download",onClick:this.downloadStructure},{type:"icon",icon:"copy",hoverText:"Copy Link",onClick:this.copyShareLink}],onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus()}}}async handleFocus(){this.focusInstance||(await this._loadMolstarLibrary(),this.focusInstance=new G(this.chatId,this,{src:this._src,uniprotId:this._uniprotId,format:this._format,highlightResidues:this._highlightResidues}))}focus(e){const t=document.createElement("output-protein-structure");return e.src&&t.setAttribute("src",e.src),e.uniprotId&&t.setAttribute("uniprot-id",e.uniprotId),e.format&&t.setAttribute("format",e.format),e.highlightResidues&&t.setAttribute("highlight-residues",e.highlightResidues),t.setAttribute("mode","focus"),t.setAttribute("chat-id",this.chatId),t.setAttribute("show-metadata","true"),t.originalInstance=this,t}closeFocus(){this.focusInstance&&(this.focusInstance.close(),this.focusInstance=null)}_renderFileView(){this.innerHTML="";const e={name:this._uniprotId?`${this._uniprotId}.${this._format}`:this._src.split("/").pop().split("?")[0]||`structure.${this._format}`,type:"code",extension:this._format},t=document.createElement("div");t.className="pb-4 cursor-pointer z-30";const s=new Y([e],null).createFileItem(e,e.extension);t.appendChild(s),this.appendChild(t),s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()}))}_clearContent(){if(this.viewer=null,this.structureDisplayContainer){this.structureDisplayContainer.querySelectorAll('[id^="molstar-"], .msp-plugin, .pdbe-molstar-plugin').forEach((e=>e.remove())),this.structureDisplayContainer.children.length>0&&(this.structureDisplayContainer.innerHTML="")}}disconnectedCallback(){this.resizeObserver&&(this.resizeObserver.disconnect(),this.resizeObserver=null),this.resizeTimeout&&(clearTimeout(this.resizeTimeout),this.resizeTimeout=null),this.windowResizeHandler&&(window.removeEventListener("resize",this.windowResizeHandler),this.windowResizeHandler=null),this.viewer&&"function"==typeof this.viewer.dispose&&this.viewer.dispose(),this.viewer=null}handleResize(){if(this.viewer&&this.structureDisplayContainer&&!this._isResizing){this._isResizing=!0;try{const e=this.structureDisplayContainer.querySelector('[id^="molstar-"]');if(!e)return void(this._isResizing=!1);const t=e.getBoundingClientRect();if(t.width<=0||t.height<=0)return void(this._isResizing=!1);this.viewer.plugin&&(this.viewer.plugin.canvas3d&&this.viewer.plugin.canvas3d.handleResize&&this.viewer.plugin.canvas3d.handleResize(),this.viewer.plugin.layout&&this.viewer.plugin.layout.events&&this.viewer.plugin.layout.events.updated.next())}catch(e){}finally{this._isResizing=!1}}}_setupResizeObserver(){"focus"===this._mode&&(this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeObserver=new ResizeObserver((e=>{for(let t of e)this.resizeTimeout&&clearTimeout(this.resizeTimeout),this.resizeTimeout=setTimeout((()=>{this.handleResize()}),100)})),this.structureDisplayContainer&&this.resizeObserver.observe(this.structureDisplayContainer))}}window.customElements&&!window.customElements.get("output-protein-structure")&&window.customElements.define("output-protein-structure",Ce);N.instance.registerType("document",z.document,{update(e,t){e&&"function"==typeof e.handleDocumentUpdate?e.handleDocumentUpdate(t):"function"==typeof e.setAttribute&&null!=t.revision&&e.setAttribute("revision",String(t.revision))}});const xe=new class{constructor(){this.isChecking=!1}async checkAndUpdate(){if(!this.isChecking&&window.user&&window.user.preferences&&window.user.preferences.useTime)try{this.isChecking=!0;const e=Intl.DateTimeFormat().resolvedOptions().timeZone,t=window.user.timezone;if(!e||!t||e===t)return void(this.isChecking=!1);(await u.K.savePersonalizationData({...window.user,timezone:e})).success&&(window.user.timezone=e)}catch(e){}finally{this.isChecking=!1}}};document.addEventListener("DOMContentLoaded",(()=>{xe.checkAndUpdate()}));class ke{static chatInstances={};static activeChat=null;static sessionTabs=null;static pendingDroppedImage=null;static activePrimaryContentSpinnerInstance=null;static ALLOWED_UPLOAD_FILE_TYPES=["image/*","video/*","audio/*","application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-powerpoint","application/vnd.openxmlformats-officedocument.presentationml.presentation","text/plain","text/csv","application/json","application/xml","text/html","text/javascript","application/javascript","text/x-javascript","application/x-javascript","text/x-python","text/x-python-script","application/x-python","text/x-java","text/x-java-source","text/x-c","text/x-c++","text/x-c++src","text/x-csharp","text/x-ruby","text/x-php","application/x-httpd-php","text/x-perl","application/x-perl","text/x-go","text/x-swift","text/x-kotlin","text/x-scala","text/x-typescript","application/typescript","text/x-rust","text/x-haskell","text/x-lua","text/x-sql","text/x-yaml","application/x-yaml","text/x-markdown","text/markdown","text/x-sh","application/x-sh","text/x-fortran","text/x-pascal","text/x-asm","text/x-matlab","text/x-r","text/x-julia","text/x-dart",".js",".py",".java",".c",".cpp",".cs",".rb",".php",".pl",".go",".swift",".kt",".scala",".ts",".rs",".hs",".lua",".sql",".yaml",".yml",".md",".sh",".bash",".f",".f90",".pas",".asm",".m",".r",".jl",".dart"];_showPrimaryContentSpinner(){if(ke.activePrimaryContentSpinnerInstance&&ke.activePrimaryContentSpinnerInstance!==this&&ke.activePrimaryContentSpinnerInstance._removePrimaryContentSpinner(),this.primaryContent){for(;this.primaryContent.firstChild;)this.primaryContent.removeChild(this.primaryContent.firstChild);const e=document.createElement("div");e.className="flex flex-col h-full w-full items-center justify-center text-gray-500 dark:text-gray-400 chat-primary-spinner",e.innerHTML='\n                <div class="thinking-dots-container-quad mb-3">\n                    <div class="thinking-dot-quad thinking-dot-1-quad"></div>\n                    <div class="thinking-dot-quad thinking-dot-2-quad"></div>\n                    <div class="thinking-dot-quad thinking-dot-3-quad"></div>\n                </div>\n            ',this.primaryContent.appendChild(e),ke.activePrimaryContentSpinnerInstance=this}}_removePrimaryContentSpinner(){if(this.primaryContent&&ke.activePrimaryContentSpinnerInstance===this){const e=this.primaryContent.querySelector(".chat-primary-spinner");e&&this.primaryContent.removeChild(e),ke.activePrimaryContentSpinnerInstance=null}else if(this.primaryContent){const e=this.primaryContent.querySelector(".chat-primary-spinner");e&&this.primaryContent.removeChild(e)}}constructor(e=null,t=null,s={}){if(this.isPlaceholder=!!s.isPlaceholder,this.thread=t,this.lastScrollTop=0,this.screenShareBox=null,this.inVoiceMode=!1,this.theme=i.A.theme,this.currentStreamId=null,this.stoppedStreamIds={},this.mcpMenuInstance=null,this.assistantSelectorInstance=null,this.user=u.K.user,this.models=window.initial_models,this.assistants=window.initial_assistants,this.model=null,this.assistant=null,this.chat=null,this.memoryDialogue=null,this.modelChangeResolver=null,this.chatFiles=null,this.isInitializingFork=!1,this._pendingFocusBlock=null,this.isDestroyed=!1,this._boundAssistantListUpdate=this._handleAssistantListUpdate.bind(this),this._boundHandleAssistantButtonsUpdate=this._handleAssistantButtonsUpdate.bind(this),this.chat_id=e,this.parentChat=null,this.isPlaceholder){const e=s.inheritedAssistantId||window.current_assistant_id,t=s.inheritedModelId||window.current_model_id;this._setSelectedAssistant(e),this._setSelectedModel(t),this.chat={name:"",messages:[],pinned:!1,assistant_id:e,model_id:t,uuid:this.chat_id},this.forceNewChat=!1,this.isInitialLoad=!1}else this.forceNewChat=s.forceNewChat||!1,this.isInitialLoad=void 0!==s.isInitialLoad&&s.isInitialLoad;if(this.thread)this.primaryContent=document.createElement("div");else{if(this.primaryContent=document.createElement("div"),this.primaryContent.classList.add("flex","flex-col","h-full","w-full"),this.primaryContent.id=`chat-container-${this.chat_id||"temp-fallback-"+Date.now()}`,this.primaryContent.classList.add("hidden"),this.primaryContent.style.display="none",!this.isPlaceholder&&!this.thread){(this.forceNewChat&&!this.isInitialLoad||this.chat_id&&!this.isInitialLoad&&!ke.chatInstances[this.chat_id])&&this._showPrimaryContentSpinner()}const e=document.getElementById("views-container")?.querySelector("#primary-content")||document.getElementById("primary-content");e&&(e.querySelector(`#${this.primaryContent.id}`)||e.appendChild(this.primaryContent))}this.scrollViewAttachedBottom=!0,this.isPlaceholder?this.initializationPromise=this._initializeUIPlaceholder():this.initializationPromise=this._initializeStandardChat(),document.addEventListener("assistant-list-updated",this._boundAssistantListUpdate),document.addEventListener("update-assistant-buttons",this._boundHandleAssistantButtonsUpdate),this.thread||this.initializationPromise.then((()=>{if(!this.isPlaceholder)if(this.chat_id&&(this.primaryContent.setAttribute("data-chat-container",this.chat_id),this.primaryContent.id=`chat-container-${this.chat_id}`),!this.chat_id||ke.chatInstances[this.chat_id]&&ke.chatInstances[this.chat_id]!==this)this.chat_id&&ke.chatInstances[this.chat_id]!==this||this.chat_id;else{if(ke.chatInstances[this.chat_id]=this,ke.sessionTabs){const e=this.assistant?this.assistant.image:null,t=this.getConversationName();ke.sessionTabs.addTab(this.chat_id,t,e,!1,!1);const s=window.location.pathname.split("/chat/")[1]?.split("/")[0];this.chat_id!==s||this.isInitialLoad||ke.sessionTabs.activeTabId===this.chat_id||ke.sessionTabs.setActiveTab(this.chat_id)}this.chatSession&&Object.defineProperty(this.chatSession,"assistant",{set:e=>{if(this.chatSession._assistant=e,this.chatSession.onChangeAssistant(e),ke.sessionTabs){const t=this.getConversationName(),s=e?e.image:null;ke.sessionTabs.updateTabTitle(this.chat_id,t,s)}},get:()=>this.chatSession._assistant,configurable:!0,enumerable:!0}),ke.activeChat===this&&"function"==typeof this.focusInChatInput&&this.focusInChatInput()}})).catch((e=>{if(this._removePrimaryContentSpinner(),ke.sessionTabs){const e=this.chat_id||(this.isPlaceholder&&this.primaryContent?.id?.startsWith("chat-container-placeholder-")?this.primaryContent.id.replace("chat-container-",""):null);e&&ke.sessionTabs.setTabWorkingState(e,!1)}this.chat_id&&ke.chatInstances[this.chat_id]===this&&(delete ke.chatInstances[this.chat_id],ke.sessionTabs&&ke.sessionTabs.removeTabSilently(this.chat_id)),this.primaryContent&&this.primaryContent.parentNode&&this.primaryContent.parentNode.removeChild(this.primaryContent)}))}static _generateTempChatId(){return`${crypto.randomUUID()}-ttt`}static async openChatFromHistory(e,t){if(!e||!t)return void new c.y("Error opening chat.","error");ke.sessionTabs||ke.initSessionTabs(),ke.sessionTabs.addTab(e,t.name,t.assistantImage,!1,!0),ke.sessionTabs.setActiveTab(e),window.appController&&"function"==typeof window.appController.switchToView&&window.appController.switchToView("chat");let s=ke.chatInstances[e],i=!1;if(s||(s=new ke(e,null,{isInitialLoad:!1}),ke.chatInstances[e]=s,i=!0),await ke.switchToChat(e,s,!1),i&&s.initializationPromise)try{await s.initializationPromise}catch(t){return void(ke.sessionTabs&&ke.sessionTabs.setTabWorkingState(e,!1))}}static initSessionTabs(){if(ke.sessionTabs)return{active_chat_id:ke.sessionTabs.activeTabId,active_special_tab_id:ke.sessionTabs.activeSpecialTabId};{ke.sessionTabs=new pe;const{active_chat_id:e,active_special_tab_id:t}=ke.sessionTabs.loadInitialState();ke.sessionTabs.setCallbacks((()=>ke.createNewChat()),(e=>{const t=ke.chatInstances[e];t&&t.isPlaceholder||window.appController.routeTo(`/chat/${e}`)}),(e=>ke.closeChat(e)),(async e=>{const t=ke.chatInstances[e];t&&t.isPlaceholder?new c.y("Cannot rename session until it's fully created.","info"):await ke.promptAndRenameChat(e)}),(async(e,t)=>{const s=ke.chatInstances[e];s&&s.isPlaceholder?new c.y("Cannot pin session until it's fully created.","info"):await ke.pinChat(e,t)}),(e=>{const t=ke.chatInstances[e];t&&t.isPlaceholder?new c.y("Cannot delete session until it's fully created.","info"):ke.deleteChat(e)}),(async e=>{const t=ke.chatInstances[e];t&&t.isPlaceholder?new c.y("Cannot share session until it's fully created.","info"):await ke.shareChat(e)}),(e=>ke.refreshChat(e)));const s=document.getElementById("views-container"),i=ke.sessionTabs.render();return s&&i&&(s.contains(i)||s.insertBefore(i,s.firstChild)),{active_chat_id:e,active_special_tab_id:t}}}static async createNewChat(){if(!window.initial_assistants||0===window.initial_assistants.length)return new c.y("Critical Error: No assistants available.","error"),null;const e=ke._generateTempChatId();let t=window.current_assistant_id,s=window.current_model_id;if(ke.activeChat&&ke.activeChat.assistant&&ke.activeChat.model){t=ke.activeChat.assistant.id,s=ke.activeChat.model.id,window.current_assistant_id=t;u.K.hasPermission("feature:assistant-switching")?window.current_assistant_id=t:window.workspace&&window.workspace.default_assistant&&window.workspace.default_assistant.id&&(t=window.workspace.default_assistant.id,window.current_assistant_id=t);u.K.hasPermission("feature:model-switching")?window.current_model_id=s:window.workspace&&window.workspace.default_model&&window.workspace.default_model.id&&(s=window.workspace.default_model.id,window.current_model_id=s)}const i=new ke(e,null,{isPlaceholder:!0,inheritedAssistantId:t,inheritedModelId:s});ke.chatInstances[e]=i;let n=null;return i.assistant&&(n=i.assistant.image),ke.sessionTabs?(ke.sessionTabs.addTab(e,"New session",n,!0),window.appController&&"function"==typeof window.appController.switchToView&&window.appController.switchToView("chat"),await ke.switchToChat(e,i,!0),i._fetchRealChatDataAndFinalize(e).catch((t=>{new c.y("Failed to create new session. Please try again.","error"),ke.doCloseChat(e)})),i):(i.destroy(),delete ke.chatInstances[e],null)}static async createNewChatWithAssistant(e){const t=ke._generateTempChatId(),s=e;let i=window.current_model_id;const n=window.initial_assistants.find((t=>String(t.id)===String(e)));n&&n.default_model&&n.default_model.id?i=n.default_model.id:ke.activeChat&&ke.activeChat.model&&(i=ke.activeChat.model.id),window.current_assistant_id=s,window.current_model_id=i;const a=new ke(t,null,{isPlaceholder:!0,inheritedAssistantId:s,inheritedModelId:i});ke.chatInstances[t]=a;let o=null;return a.assistant&&(o=a.assistant.image),ke.sessionTabs?(ke.sessionTabs.addTab(t,"New session",o,!0),window.appController&&"function"==typeof window.appController.switchToView&&window.appController.switchToView("chat"),await ke.switchToChat(t,a,!0),a._fetchRealChatDataAndFinalize(t).catch((e=>{new c.y("Failed to create new session. Please try again.","error"),ke.doCloseChat(t)})),a):(a.destroy(),delete ke.chatInstances[t],null)}async _initializeUIPlaceholder(){this.primaryContent&&(this.primaryContent.classList.remove("hidden"),this.primaryContent.style.display="flex"),this.chatInput=new W(this.chat_id,this,this.assistant,this.model,this.assistant?.knowledge_graph_on,null),this.chatSession=new F(this.model,this.assistant,this.chat,this.thread,this),F.tellMeAboutFocus(((e,t)=>{this.chatInput&&this.chatInput.focusMode(e,t)})),this.chatInput&&u.K.hasPermission("feature:mcps")&&this.chatInput.onMCPControl(((e,t)=>{this.mcpMenuInstance&&this.mcpMenuInstance.remove();const s=t&&t.has_forced_mcps?t:null;this.mcpMenuInstance=new R(e,this._updateMCPIconForMenu,this.chatInput,s)})),this.chatSession&&this.chatSession.onReplyTo((e=>{this.chatInput&&this.chatInput.showReplyTo(e)})),this.chatFiles=new J({uiType:"chat",chatId:this.chat_id,maxFiles:20,maxSizePerFile:1024,maxTotalSize:1024,allowedTypes:ke.ALLOWED_UPLOAD_FILE_TYPES,required:!1}),this.render(),this.setListeners(),this.chatInput.focus(),this.chatSession&&"function"==typeof this.chatSession.updateScrollPosition&&requestAnimationFrame((()=>{this.chatSession.updateScrollPosition(),"function"==typeof this.chatSession.togglePlaceholder&&this.chatSession.togglePlaceholder()}))}async _initializeStandardChat(){try{if(this.isDestroyed)return;if(this.forceNewChat||!this.chat_id&&!this.isInitialLoad)await this.createChat();else if(this.chat_id){const e=await this.loadChat();if(this.isDestroyed||!e){if(!e&&!this.isDestroyed)throw new Error(`Failed to load chat data for ${this.chat_id}.`);return}if(await this.connect(),this.isDestroyed)return}else this.isInitialLoad||await this.createChat()}catch(e){if(!this.isDestroyed)throw e}}async _fetchRealChatDataAndFinalize(e){try{const t={assistant_id:this.assistant?this.assistant.id:window.current_assistant_id,model_id:this.model?this.model.id:window.current_model_id},s=await g.G.postData("/chat/new/",t);if(this.isDestroyed)return void ke.doCloseChat(e);if(!s||!s.chat_id||!s.chat)throw new Error("Failed to finalize chat session due to API response.");const i=s.chat_id,n=this.chat_id;if(this.chat=s.chat,this.chat_id=i,this.isPlaceholder=!1,delete ke.chatInstances[n],ke.chatInstances[this.chat_id]=this,this.primaryContent&&(this.primaryContent.id=`chat-container-${this.chat_id}`,this.primaryContent.setAttribute("data-chat-container",this.chat_id)),this._setSelectedAssistant(this.chat.assistant_id),this._setSelectedModel(this.chat.model_id),ke.sessionTabs){const e=this.assistant?this.assistant.image:null;ke.sessionTabs.resolvePlaceholderTab(n,this.chat_id,this.getConversationName(),e)}if(ke.activeChat&&ke.activeChat===this){const e=`/chat/${this.chat_id}`,t=window.location.pathname;t!==`/chat/${n}`&&t===e||(window.history.replaceState({chatId:this.chat_id},"",e),document.title=`${this.getConversationName()} - ${"Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name||"Simtheory"}`)}if(this.chatInput&&(this.chatInput.chatId=this.chat_id,this.chatInput.assistant=this.assistant,this.chatInput.model=this.model,"function"==typeof this.chatInput.updateModelDisplay&&this.chatInput.updateModelDisplay(),"function"==typeof this.chatInput.updateAssistantDisplay&&this.chatInput.updateAssistantDisplay()),this.chatSession&&(this.chatSession.chat=this.chat,this.chatSession.assistant=this.assistant,this.chatSession.model=this.model,this.chatSession.chatId=this.chat_id),this.chatFiles&&(this.chatFiles.chatId=this.chat_id),await this.connect(),this.isDestroyed)return;this.chatSession&&"function"==typeof this.chatSession.togglePlaceholder&&requestAnimationFrame((()=>{this.chatSession.togglePlaceholder()})),"function"==typeof this.focusInChatInput&&requestAnimationFrame((()=>{this.focusInChatInput()}))}catch(e){if(!this.isDestroyed)throw e}}async handleSessionReplySend(e,t){if(!e.reply_to_session_id||!e.reply_to_assistant_message_id)return new c.y("Error: Missing context for session reply.","error"),void("function"==typeof this.showAssistantError&&this.showAssistantError("Could not initiate the new session due to missing context."));const s=e.reply_to_session_id,i=e.reply_to_assistant_message_id,n=ke._generateTempChatId(),a=ke.chatInstances[s],o=`RE: ${a?.getConversationName()||"session"}`,r=new ke(n,null,{isPlaceholder:!0,inheritedAssistantId:e.fork_assistant_id,inheritedModelId:e.fork_model_id,forkContext:{parentChatId:s,continuedFromMessageId:i,initialUserMessage:e}});r.isInitializingFork=!0,ke.chatInstances[n]=r;let l=null;if(r.assistant&&(l=r.assistant.image),!ke.sessionTabs)return r.destroy(),delete ke.chatInstances[n],void new c.y("Error: Could not open new session tab.","error");ke.sessionTabs.addTab(n,o,l,!0),window.appController&&"function"==typeof window.appController.switchToView&&window.appController.switchToView("chat"),await ke.switchToChat(n,r,!0),r._finalizeForkedChat(n,s,i,e,t).catch((e=>{new c.y("Failed to create new session from reply. Please try again.","error"),ke.doCloseChat(n)}))}async _finalizeForkedChat(e,t,s,i,n){try{const n={parent_chat_id:t,continued_from_message_id:s,model_id:this.model?this.model.id:window.current_model_id,assistant_id:this.assistant?this.assistant.id:window.current_assistant_id},a=await g.G.postData("/chat/new/",n);if(this.isDestroyed)return void ke.doCloseChat(e);if(!a||!a.chat_id||!a.chat)throw new Error("Failed to finalize forked chat session due to API response.");const o=a.chat_id;if(this.chat=a.chat,this.chat_id=o,this.isPlaceholder=!1,delete ke.chatInstances[e],ke.chatInstances[this.chat_id]=this,this.primaryContent&&(this.primaryContent.id=`chat-container-${this.chat_id}`,this.primaryContent.setAttribute("data-chat-container",this.chat_id)),this._setSelectedAssistant(this.chat.assistant_id),this._setSelectedModel(this.chat.model_id),ke.sessionTabs){const t=this.assistant?this.assistant.image:null;ke.sessionTabs.resolvePlaceholderTab(e,this.chat_id,this.getConversationName(),t)}if(ke.activeChat&&ke.activeChat===this){const t=`/chat/${this.chat_id}`,s=window.location.pathname;(s===`/chat/${e}`||s.endsWith("/new")||s!==t)&&(window.history.replaceState({chatId:this.chat_id},"",t),document.title=`${this.getConversationName()} - ${"Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name||"Simtheory"}`)}if(await this.connect(),this.isDestroyed)return;if(this.chatInput&&(this.chatInput.chatId=this.chat_id,this.chatInput.assistant=this.assistant,this.chatInput.model=this.model,"function"==typeof this.chatInput.updateModelDisplay&&this.chatInput.updateModelDisplay(),"function"==typeof this.chatInput.updateAssistantDisplay&&this.chatInput.updateAssistantDisplay()),this.chatSession&&(this.chatSession.chat=this.chat,this.chatSession.assistant=this.assistant,this.chatSession.model=this.model,this.chatSession.chatId=this.chat_id),this.chatFiles&&(this.chatFiles.chatId=this.chat_id),this.loadInitialMessages(),this.render(),this.chatSession&&"function"==typeof this.chatSession.togglePlaceholder&&requestAnimationFrame((()=>{this.chatSession.togglePlaceholder(!1)})),"function"==typeof this.focusInChatInput&&requestAnimationFrame((()=>{this.focusInChatInput()})),i){this.chat.parent_chat_details&&this.chatSession.createParentReferenceBlock(this.chat.parent_chat_details),this.chatSession.addMessage(i,i.run_id),this.chatSession.toggleAssistantThinking(!0),this.chatSession.updateScrollPosition();const e={...i,is_screen_sharing:!1};this.isStreaming=!0,this.chatInput&&this.chatInput.toggleStopButton(!0),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!0);await g.G.postData(`/chat/${this.chat_id}/message/`,e);this.isInitializingFork=!1}}catch(t){if(this.isInitializingFork=!1,!this.isDestroyed)throw ke.sessionTabs&&ke.sessionTabs.setTabWorkingState(e,!1),t}}static async switchToChat(e,t=null,s=!1){if(!e)return;let i=t||ke.chatInstances[e];if(!i)return new c.y("Error: Chat instance unavailable for switch.","error"),void(ke.sessionTabs&&ke.sessionTabs.removeTabSilently(e));window.appController&&"function"==typeof window.appController.getCurrentView&&"chat"!==window.appController.getCurrentView()&&"function"==typeof window.appController.switchToView&&window.appController.switchToView("chat");const n="Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name||"Simtheory",a=`${s||i.isPlaceholder||!i.chat?"New session":i.getConversationName()} - ${n}`;document.title=a;if(i.primaryContent&&"none"!==window.getComputedStyle(i.primaryContent).display&&!s&&ke.activeChat?.chat_id===e&&!i.isPlaceholder)return ke.sessionTabs&&ke.sessionTabs.setActiveTab(e),void("function"==typeof i.focusInChatInput&&i.focusInChatInput());if(!i.primaryContent)return;document.body.setAttribute("data-switching-tabs","true");const o=document.getElementById("views-container")?.querySelector("#primary-content")||document.getElementById("primary-content");Object.values(ke.chatInstances).forEach((t=>{if(t&&t.chat_id!==e&&t.primaryContent&&t.primaryContent.parentNode)if("none"!==window.getComputedStyle(t.primaryContent).display||"none"!==t.primaryContent.style.display){if(t.chatSession){const e=t.chatSession.getScrollContainer();e&&(t.lastScrollTop=e.scrollTop),"function"==typeof t.chatSession.disableDragAndDropFileUpload&&t.chatSession.disableDragAndDropFileUpload()}if(G.openFocuses.has(t.chat_id)){const e=G.openFocuses.get(t.chat_id);e&&e.originalChatContentWrapper&&(e._preservedChatWidth=e.originalChatContentWrapper.style.width,e._preservedChatMinWidth=e.originalChatContentWrapper.style.minWidth,e._preservedChatFlexGrow=e.originalChatContentWrapper.style.flexGrow)}t.primaryContent.style.transition="none",t.primaryContent.style.opacity="0",t.primaryContent.classList.add("hidden"),t.primaryContent.style.display="none"}else t.chatSession&&"function"==typeof t.chatSession.disableDragAndDropFileUpload&&t.chatSession.disableDragAndDropFileUpload()})),!i.primaryContent.isConnected&&o&&o.appendChild(i.primaryContent),i.primaryContent.style.transition="none",i.primaryContent.style.opacity="0",i.primaryContent.classList.remove("hidden"),i.primaryContent.style.display="flex",i.chatSession&&"function"==typeof i.chatSession.enableDragAndDropFileUpload&&i.chatSession.enableDragAndDropFileUpload(),ke.activeChat=i,ke.sessionTabs&&ke.sessionTabs.setActiveTab(e);const r=window.location.pathname.replace(/\/$/,""),l=`/chat/${e}`;i.isPlaceholder?r!==l&&window.history.pushState({placeholderChatId:e},"",l):r!==l&&window.history.pushState({chatId:e},"",l),requestAnimationFrame((()=>{requestAnimationFrame((()=>{if(i.primaryContent.style.transition="opacity 150ms ease-in-out",i.primaryContent.style.opacity="1",G.openFocuses.has(e)){const t=G.openFocuses.get(e);t&&(t._preservedChatWidth?(t.originalChatContentWrapper.style.width=t._preservedChatWidth,t._preservedChatMinWidth&&(t.originalChatContentWrapper.style.minWidth=t._preservedChatMinWidth),t._preservedChatFlexGrow&&(t.originalChatContentWrapper.style.flexGrow=t._preservedChatFlexGrow),delete t._preservedChatWidth,delete t._preservedChatMinWidth,delete t._preservedChatFlexGrow):t.recalculateWidths())}s||i.isPlaceholder?setTimeout((()=>{document.body.removeAttribute("data-switching-tabs"),i.primaryContent&&(i.primaryContent.style.transition=""),i.isPlaceholder&&(i._pendingFocusBlock&&"function"==typeof i._pendingFocusBlock.handleFocus?(i._pendingFocusBlock.handleFocus(),i._pendingFocusBlock=null):"function"==typeof i.focusInChatInput&&i.focusInChatInput())}),150):(()=>{if(i.chat&&!i.isPlaceholder){const e=`${i.getConversationName()} - ${n}`;document.title!==e&&(document.title=e)}if(i.chatSession&&void 0!==i.lastScrollTop){const e=i.chatSession.getScrollContainer();e&&(e.scrollTop=i.lastScrollTop)}i.primaryContent&&i.primaryContent.querySelectorAll("code-block").forEach((e=>{"function"==typeof e.runPendingHighlight&&e.runPendingHighlight()}));if(i._pendingFocusBlock&&"function"==typeof i._pendingFocusBlock.handleFocus?(i._pendingFocusBlock.handleFocus(),i._pendingFocusBlock=null):"function"==typeof i.focusInChatInput&&i.focusInChatInput(),ke.pendingDroppedImage&&ke.pendingDroppedImage.tabId===e){const e=ke.pendingDroppedImage;ke.pendingDroppedImage=null,i&&"function"==typeof i.acceptDroppedImage&&setTimeout((()=>{i.acceptDroppedImage(e.imageObject)}),50)}i.chatInput&&"function"==typeof i.chatInput.adjustTextarea&&i.chatInput.adjustTextarea(),setTimeout((()=>{document.body.removeAttribute("data-switching-tabs"),i.primaryContent&&(i.primaryContent.style.transition="")}),150)})()}))}))}static switchToView(e){window.appController&&window.appController.switchToView(e)}static closeChat(e){ke.doCloseChat(e)}static async doCloseChat(e){const t=ke.chatInstances[e];if(t&&(t.destroy(),delete ke.chatInstances[e]),ke.sessionTabs){const t=await ke.sessionTabs.removeTab(e);if(t.error){if(ke.sessionTabs.tabs.length>0&&!ke.sessionTabs.activeTabId){const e=ke.sessionTabs.tabs[0].id;ke.sessionTabs.setActiveTab(e),window.appController&&window.appController.routeTo(`/chat/${e}`)}else if(0===ke.sessionTabs.tabs.length&&!ke._isCreatingNewChat){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}finally{ke._isCreatingNewChat=!1}}return}if(t.wasActive){if(t.tabsRemaining>0&&t.newActiveTabId)window.appController&&window.appController.routeTo(`/chat/${t.newActiveTabId}`);else if(0===t.tabsRemaining&&!ke._isCreatingNewChat){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}catch(e){}finally{ke._isCreatingNewChat=!1}}}else if(ke.sessionTabs.activeTabId);else if(ke.sessionTabs.tabs.length>0){const e=ke.sessionTabs.tabs[0].id;window.appController&&window.appController.routeTo(`/chat/${e}`)}else if(0===ke.sessionTabs.tabs.length&&!ke._isCreatingNewChat){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}catch(e){}finally{ke._isCreatingNewChat=!1}}}}destroy(){if(this.isDestroyed=!0,ke.activePrimaryContentSpinnerInstance===this&&this._removePrimaryContentSpinner(),document.removeEventListener("assistant-list-updated",this._boundAssistantListUpdate),document.removeEventListener("update-assistant-buttons",this._boundHandleAssistantButtonsUpdate),this.removeListeners(),this.wsManager&&(this.wsManager.close(),this.wsManager=null),this.memoryDialogue&&(this.memoryDialogue=null),this.chatFiles&&(this.chatFiles=null),this.switchModal&&(this.switchModal=null),this.assistantSwitchModal&&(this.assistantSwitchModal=null),this.voiceModal&&(this.voiceModal.destroy(),this.voiceModal=null),this.primaryContent&&this.primaryContent.parentNode&&this.primaryContent.parentNode.removeChild(this.primaryContent),G.openFocuses&&G.openFocuses.has(this.chat_id)){const e=G.openFocuses.get(this.chat_id);e&&e.close()}}async initializeChat(){try{if(this.forceNewChat||!this.chat_id&&!this.isInitialLoad)await this.createChat();else if(this.chat_id){if(!await this.loadChat())throw new Error(`Failed to load chat data for ${this.chat_id}.`);await this.connect()}else this.isInitialLoad||await this.createChat()}catch(e){throw e}}async loadLastChat(){try{const e=await g.G.postData("/chat/load/",{assistant_id:window.current_assistant_id,model_id:window.current_model_id});if(!e||!e.chat_id)return;this.thread||window.history.pushState({},"Chat",`/chat/${e.chat_id}/`),this.chat_id=e.chat_id,await this.loadChat(),await this.connect()}catch(e){}}async connect(){if(!this.isPlaceholder&&this.chat_id&&!this.chat_id.startsWith("placeholder-"))try{this.wsManager=new Q(this.chat_id),this.wsManager.registerMsgListener(this.onMessage.bind(this),"chat.message"),this.wsManager.registerMsgListener(this.onNameUpdate.bind(this),"chat.name_update"),this.wsManager.registerMsgListener(this.onDocDelta.bind(this),"chat.message.docdelta"),this.wsManager.registerMsgListener(this.onError.bind(this),"chat.error"),this.wsManager.registerMsgListener(this.onUpgradeRequired.bind(this),"chat.upgrade_required"),this.wsManager.registerMsgListener(this.onImageLoading.bind(this),"chat.image.loading"),this.wsManager.registerMsgListener(this.onVideoLoading.bind(this),"chat.video.loading"),this.wsManager.registerMsgListener(this.onMusicLoading.bind(this),"chat.music.loading"),this.wsManager.registerMsgListener(this.onLongLoad.bind(this),"chat.long_load"),this.wsManager.registerMsgListener(this.onNormalLoad.bind(this),"chat.loading"),this.wsManager.registerMsgListener(this.onAThink.bind(this),"chat.athink"),this.wsManager.registerMsgListener(this.onCodeLoad.bind(this),"chat.code.loading"),this.wsManager.registerMsgListener(this.onModelSwitch.bind(this),"chat.model_switch"),this.wsManager.registerMsgListener(this.onAssistantSwitch.bind(this),"chat.assistant_switch"),this.wsManager.registerMsgListener(this.searchImagesReady.bind(this),"chat.search.images_ready"),this.wsManager.registerMsgListener(this.onUpdateCode.bind(this),"chat.code.update"),this.wsManager.registerMsgListener(this.onVoiceAudioChunk.bind(this),"voice.audio.chunk"),this.wsManager.registerMsgListener(this.onVoiceAudioEnd.bind(this),"voice.audio.end"),this.wsManager.registerMsgListener(this.onVoiceError.bind(this),"voice.error"),this.wsManager.registerMsgListener(this.onDocumentUpdate.bind(this),"document.update"),this.wsManager.connect();const e=await this.loadChat();if(this.isDestroyed)return void(this.wsManager&&this.wsManager.close());if(!e)throw new Error(`Failed to load chat data for ${this.chat_id}`);ke.activeChat===this&&(document.title=`${this.getConversationName()} - `+("Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name)),this.stVoice||(this.stVoice=new ne(this)),this.models=window.initial_models,this.assistants=window.initial_assistants,this._setSelectedModel(this.chat.model_id),this._setSelectedAssistant(this.chat.assistant_id),this.switchAIModel=this.switchAIModel.bind(this),this.switchAssistant=this.switchAssistant.bind(this),this.scrollPanel=null,this.messagesContainer=null,this.selectedSkill=null,this.chatInput?(this.chatInput.chatId=this.chat_id,this.chatInput.assistant=this.assistant,this.chatInput.model=this.model,this.chatInput.memoryStatus=this.assistant?.knowledge_graph_on,"function"==typeof this.chatInput.updateModelDisplay&&this.chatInput.updateModelDisplay(),"function"==typeof this.chatInput.updateAssistantDisplay&&this.chatInput.updateAssistantDisplay(),"function"==typeof this.chatInput.updateMemoryIcon&&this.chatInput.updateMemoryIcon()):(this.chatInput=new W(this.chat_id,this,this.assistant,this.model,this.assistant?.knowledge_graph_on,null),window._ci=this.chatInput),this.chatSession?(this.chatSession.model=this.model,this.chatSession.assistant=this.assistant,this.chatSession.chat=this.chat,this.chatSession.chatId=this.chat_id):this.chatSession=new F(this.model,this.assistant,this.chat,this.thread,this),F.tellMeAboutFocus(((e,t)=>{this.chatInput&&this.chatInput.focusMode(e,t)})),this.chatInput&&u.K.hasPermission("feature:mcps")&&this.chatInput.onMCPControl(((e,t)=>{this.mcpMenuInstance&&(this.mcpMenuInstance.remove(),this.mcpMenuInstance=null);const s=t&&t.has_forced_mcps?t:null;this.mcpMenuInstance=new R(e,this._updateMCPIconForMenu,this.chatInput,s)})),this.chatSession&&this.chatSession.onReplyTo((e=>{this.chatInput&&this.chatInput.showReplyTo(e)})),this.chatFiles=new J({uiType:"chat",chatId:this.chat_id,maxFiles:20,maxSizePerFile:1024,maxTotalSize:1024,allowedTypes:ke.ALLOWED_UPLOAD_FILE_TYPES,required:!1}),this.chat&&this.chat.parent_chat_details&&this.chatSession&&this.chatSession.createParentReferenceBlock(this.chat.parent_chat_details),this.loadInitialMessages(),this.render(),this._ensureScrolledToBottom()}catch(e){if(this.isDestroyed)return;if(this._removePrimaryContentSpinner(),this.wsManager&&(this.wsManager.close(),this.wsManager=null),this.chat_id)ke.doCloseChat(this.chat_id);else{for(const e in ke.chatInstances)if(ke.chatInstances[e]===this){delete ke.chatInstances[e];break}0===Object.keys(ke.chatInstances).length&&ke.sessionTabs&&ke.createNewChat()}}}_ensureScrolledToBottom(){const e=this.chatSession?.getScrollContainer?.();if(!e)return;const t=()=>{e.scrollTop=e.scrollHeight};t();let s=e.scrollHeight,i=0;const n=setInterval((()=>{e.scrollHeight!==s?(s=e.scrollHeight,t(),i=0):++i>10&&clearInterval(n)}),120);e.querySelectorAll("img").forEach((e=>{e.complete||e.addEventListener("load",t,{once:!0})}));const a=new MutationObserver(t);a.observe(e,{childList:!0,subtree:!0}),setTimeout((()=>a.disconnect()),3e3)}_updateMCPIconForMenu=e=>{this.chatInput&&this.chatInput.updateMCPIcon(e)};async generateNewModelReply(e,t=null){return new Promise(((s,i)=>{try{const i=Math.random().toString(36).substring(7),n={model:"",response:"",runId:i,files:[],sources:[],simages:[],search_image_count:0,finished:!1};this.wsManager.send({type:"chat.regenerate",chat_id:this.chat_id,message_id:e,run_id:i,model_codename:t});const a=t=>{t.run_id===i&&("chat.regenerate.start"===t.type?n.model=t.model:"chat.regenerate.chunk"===t.type?(n.response+=t.content,this.chatSession.updateStreamingResponse(e,n)):"chat.regenerate.files"===t.type?(n.files=t.files,this.chatSession.updateStreamingResponse(e,n)):"chat.regenerate.sources"===t.type?(n.sources=t.sources,this.chatSession.updateStreamingResponse(e,n)):"chat.regenerate.simages"===t.type?(n.simages=t.simages,this.chatSession.updateStreamingResponse(e,n)):"chat.regenerate.search_image_count"===t.type?(n.search_image_count=t.search_image_count,this.chatSession.updateStreamingResponse(e,n)):"chat.regenerate.end"===t.type&&(n.finished=!0,this.wsManager.unregisterMsgListener(a),loadingToast.hide(),s(n)))};this.wsManager.registerMsgListener(a)}catch(e){new c.y("Failed to generate new response","error"),i(e)}}))}async acceptDroppedImage(e){this.chatInput&&"function"==typeof this.chatInput.addFileFromObject?(this.chatInput.focus(),await this.chatInput.addFileFromObject(e)):new c.y("Cannot add image to input.","error")}restoreLastInput(){this.chatInput.restoreLastInput()}getFileData(){return this.chatFiles&&this.chatFiles.files?this.chatFiles.files.map((e=>({name:e.name,type:e.type,content:e}))):[]}restoreFiles(e){if(e&&e.length>0){const t=e.map((e=>new File([e.content],e.name,{type:e.type})));this.chatFiles.processFiles(t)}}_setSelectedModel(e){let t=null;if(e&&(t=this.models.find((t=>t.id==e))),t)this.model=t;else{const t=this.models.find((e=>e.id==window.current_model_id))||this.models[0];e&&t&&new c.y(`This chat's model is unavailable. Switched to ${t.name}.`,"info",5e3),t?this.model=t:new c.y("Critical Error: No AI models are configured.","error")}this.models.forEach((e=>{e.selected=this.model&&e.id==this.model.id}))}_setSelectedAssistant(e){let t=null;if(e&&(t=this.assistants.find((t=>String(t.id)===String(e)))),t)this.assistant=t;else{const t=this.assistants.find((e=>String(e.id)===String(window.current_assistant_id)))||this.assistants[0];e&&t&&new c.y(`This chat's assistant is unavailable. Switched to ${t.name}.`,"info",5e3),t?this.assistant=t:new c.y("Critical Error: No assistants are configured.","error")}this.assistant&&(this.chatInput&&(this.chatInput.memoryStatus=this.assistant.knowledge_graph_on||!1),this.chatSession&&(this.chatSession.assistant=this.assistant)),this.assistants.forEach((e=>{e.selected=this.assistant&&String(e.id)===String(this.assistant.id)}))}async loadChat(){if(!this.chat_id)throw new Error("Cannot load chat without a chat_id.");try{const e=await g.G.fetchData(`/chat/${this.chat_id}/get`);if(this.isDestroyed)return!1;if(!e||e.error)throw new Error(e?.error||`Failed to fetch chat data for ${this.chat_id}.`);return this.chat=e.chat,!0}catch(e){if(this.isDestroyed)return!1;throw e}}async loadModels(){try{this.models=u.K.fetchModels(),this._setSelectedModel(this.chat.model_id)}catch(e){this.models=[]}}async loadAssistants(){try{this.assistants=u.K.fetchAssistants(),this._setSelectedAssistant(this.chat.assistant_id)}catch(e){this.assistants=[]}}async loadInitialMessages(){const e=this;if(this.chat&&this.chat.messages)for(const t of this.chat.messages)"text"===t.msg_type||"skill"===t.msg_type?e.onMessage(t):"model_switch"===t.msg_type?e.onModelSwitch(t):"assistant_switch"===t.msg_type&&e.onAssistantSwitch(t);this.chatSession.initialLoadComplete()}openSkill(e){e&&("more"!==e.value?(this.chatInput.selectedSkill=e,this.chatInput.toggleSelectedSkill(e),this.focusInChatInput()):this.chatInput.toggleSkillsMenu())}onModelSwitch(e){this.isInitializingFork||this.chatSession.onChangeModel(e.content),this.modelChangeResolver&&(this.modelChangeResolver(e.content),this.modelChangeResolver=null)}waitForModelChange(){return new Promise((e=>{this.modelChangeResolver=e}))}onAssistantSwitch(e){if(e.assistant_id){const t=this.assistants.find((t=>t.id===e.assistant_id));t&&(this.chatSession.assistant=t,this.isInitializingFork||"function"!=typeof this.chatSession.onChangeAssistant||this.chatSession.onChangeAssistant(t,!0))}}searchImagesReady(e){this.chatSession.updateSImages(e.content,e.run_id)}onUpdateCode(e){this.chat_id===e.chat_id&&(ke.sessionTabs&&ke.sessionTabs.setTabWorkingState(this.chat_id,!1),this.chatSession.updateCode(e.content,e.run_id,e.version))}async onVoiceAudioChunk(e){this.stVoice&&await this.stVoice.handleWebSocketMessage(e)}async onVoiceAudioEnd(e){this.stVoice&&this.stVoice.handleWebSocketMessage(e)}async onVoiceError(e){this.stVoice&&this.stVoice.handleWebSocketMessage(e)}onDocumentUpdate(e){const t=e.document_id||e.doc_id;t&&N.instance.update("document",t,e)}onImageLoading(e){let t;this.chatSession?.toggleAssistantThinking(!1);const s=e.model,i=this.models.find((e=>e.value===s)),n=this.assistants.find((t=>t.id===e.assistant_id)),a=i?i.name:s,o=n&&n.image||(i?i.image:null);if(!n)return;let r=4;"stabilityimg2video"===e.skill_used&&(r=1),e.skill_params?.num_images&&(r=e.skill_params.num_images);const l=[];for(let e=0;e<r;e++)l.push({loading:!0,type:"image",file:{name:"tmp.webp"}});t={id:e.run_id||e.id,type:"assistant",nickname:n.name,timestamp:e.timestamp,responses:[{model:a,modelImage:o,response:e.content||""}],loading:!0,files:l},this.chatSession.addMessage(t,e.run_id,!0)}onVideoLoading(e){let t;this.chatSession?.toggleAssistantThinking(!1);const s=e.model,i=this.models.find((e=>e.value===s)),n=this.assistants.find((t=>t.id===e.assistant_id)),a=i?i.name:s,o=n&&n.image||(i?i.image:null);if(!n)return;const r=[];r.push({loading:!0,type:"video",file:{name:"tmp.mp4"}}),t={id:e.run_id||e.id,type:"assistant",nickname:n.name,timestamp:e.timestamp,responses:[{model:a,modelImage:o,response:e.content||""}],loading:!0,files:r},this.chatSession.addMessage(t,e.run_id,!0)}onMusicLoading(e){let t;this.chatSession?.toggleAssistantThinking(!1);const s=e.model,i=this.models.find((e=>e.value===s)),n=this.assistants.find((t=>t.id===e.assistant_id)),a=i?i.name:s,o=n&&n.image||(i?i.image:null);if(!n)return;const r=[];r.push({loading:!0,type:"video",file:{name:"music.mp3",type:"music"}}),t={id:e.run_id||e.id,type:"assistant",nickname:n.name,timestamp:e.timestamp,responses:[{model:a,modelImage:o,response:e.content||""}],loading:!0,files:r},this.chatSession.addMessage(t,e.run_id,!0)}onLongLoad(){}onNormalLoad(){this.chatSession.toggleAssistantThinking(!0),this.onCodeLoad()}onAThink(e){e.off?this.chatSession.toggleAssistantMessageThinking(!1):this.chatSession.toggleAssistantMessageThinking(!0)}onCodeLoad(){this.chatSession.codeLoad()}onMessage(e){let t;if(e.streaming){if(this.currentStreamId=e.run_id,this.stoppedStreamIds[e.run_id])return;e.finished&&(this.stoppedStreamIds[e.run_id]=!0,this.currentStreamId=null)}if(e.finished&&(this.stoppedStreamIds[e.run_id]=!0,this.currentStreamId=null,this.isStreaming=!1,this.chatInput.toggleStopButton(!1),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!1),"assistant"===e.role&&ke.sessionTabs&&this.chat_id&&ke.sessionTabs.activeTabId!==this.chat_id&&ke.sessionTabs.setNotificationLight(this.chat_id,!0)),"assistant"===e.role){const s=e.model,i=this.models.find((e=>e.value===s)),n=this.assistants.find((t=>t.id===e.assistant_id)),a=i?i.name:s,o=n&&n.image||(i?i.image:null);if(!n)return void new c.y("This assistant does not exist.","error");t={id:e.run_id||e.id,run_id:e.run_id,msg_id:e.id,chat_id:e.chat_id,type:"assistant",nickname:n.name,timestamp:e.timestamp,responses:[{model:a,modelImage:o,response:e.content}],files:e.files,skill:e.skill_used,skill_params:e.skill_params,thinking_steps:e.thinking_steps,tool_calls:e.tool_calls,tool_call_group_data:e.tool_call_group_data,transcripts:e.transcripts,thought_stream:e.thought_stream,sources:e.sources,simages:e.simages,search_image_count:e.search_image_count,finished:e.finished}}else t={id:e.run_id||e.id||e.chat_id,run_id:e.run_id,msg_id:e.id,type:"user",nickname:this.user.nickname,profileImage:this.user.profileImage,timestamp:e.timestamp,body:e.content,files:e.files,skill:e.skill_used,skill_params:e.skill_params,in_reply_to:e.in_reply_to};e.finished&&(t.final_msg_id=e.msg_id),this.chatSession.addMessage(t,e.run_id,e.loading)}onNameUpdate(e){e.chat_id===this.chat_id&&(this.chat&&(this.chat.name=e.name),this.updateDefaultTitle(e.name))}onDocDelta(e){this.chatSession.docDelta(e)}onError(e){this.chatSession.removeLoadingMessage(),this.chatSession.toggleAssistantThinking(!1),this.chatSession.toggleUserVoiceInput(!1),ke.sessionTabs&&this.chat_id&&(ke.sessionTabs.setTabWorkingState(this.chat_id,!1),ke.sessionTabs.activeTabId!==this.chat_id&&ke.sessionTabs.setNotificationLight(this.chat_id,!0));let t="error";e.error_type&&(t=e.error_type),this.chatSession.showAssistantError(e.chat_id,e.content,e.crash_id,t,e.id)}onUpgradeRequired(e){this.chatSession.removeLoadingMessage(),this.chatSession.toggleAssistantThinking(!1),this.chatSession.toggleUserVoiceInput(!1),this.isStreaming=!1,this.chatInput&&this.chatInput.toggleStopButton(!1),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!1);new j(e.usage.reason,e.usage,e.chat_id,e.usage.reason_description,e.usage.reset_date)}render(){if(this._removePrimaryContentSpinner(),this.chatSession){for(;this.primaryContent.firstChild;)this.primaryContent.removeChild(this.primaryContent.firstChild);this.flexContainer=document.createElement("div"),this.flexContainer.classList.add("flex","gap-2","w-full","h-full"),this.flexContainer.id=`focus-mode-${this.chat_id||Date.now()}`,this.chatSession.render(this.flexContainer,this.chatInput.render(this.inputSection),this.taskBar),this.primaryContent.appendChild(this.flexContainer),this.chatInput&&(this.chatInput.model=this.model,this.chatInput.assistant=this.assistant,this.chatInput.placeholder="Compose a message..."),this.setListeners()}}stopStreaming(){this.isStreaming&&(this.stoppedStreamIds[this.currentStreamId]=!0,this.wsManager&&this.wsManager.stopStream(this.chat_id,this.currentStreamId),this.isStreaming=!1,this.chatInput.toggleStopButton(!1),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!1),this.chatSession.updateLastMessage())}removeListeners(){this.modelSelector?.removeEventListener("click",this.switchAIModel),this.assistantSelector?.removeEventListener("click",this.switchAssistant),this.memoryButton?.removeEventListener("click",this.loadMemoryDialogue)}setListeners(){this._suppressFileUploadClear=!1,this.chatInput.toggleScreenShare(!1),this.chatInput.onPaste((e=>{this.chatFiles.processFiles(e)})),this.chatInput.onStop((()=>{this.stopStreaming()})),this.chatSession.onFilesDrop((e=>{this.chatFiles?.processFiles(e)})),this.chatFiles.onFileAdded((e=>{this.chatInput.addFile(e),this.chatSession.updateScrollPosition()})),this.chatFiles.onFileRemoved((()=>{this.chatInput.onFileRemoved()})),this.chatInput.onAllFilesRemoved((()=>{this._suppressFileUploadClear||this.chatFiles.clearAllFiles()})),this.chatInput.onUploadingFilesCheckCallback=()=>this.chatFiles.isUploadInProgress,this.chatInput.onSend((async(e,t)=>{e.reply_to_session_id||this.isStreaming&&(this.stopStreaming(),this.chatSession.markThinkingAsInterrupted());let s=null,i=null;t&&(s=this.chatFiles?.files?[...this.chatFiles.files]:[],i=this.chatFiles?.fileUploadIds?{...this.chatFiles.fileUploadIds}:{},e.files=s,e.upload_ids=i),e.run_id=Math.random().toString(36).substring(7),this._suppressFileUploadClear=!0;try{if(e.reply_to_session_id)await this.handleSessionReplySend(e,t);else{this.chatSession.addMessage(e,e.run_id),this.chatSession.toggleAssistantThinking(!0),this.chatSession.updateScrollPosition(),e.is_screen_sharing=!!this.screenShareBox;try{this.isStreaming=!0,this.chatInput.toggleStopButton(!0),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!0),await g.G.postData(`/chat/${this.chat_id}/message/`,e)}catch(t){this.isStreaming=!1,this.chatInput.toggleStopButton(!1),this.chatSession.toggleAssistantThinking(!1),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!1),this.chatSession.showAssistantError(this.chat_id,"You're not connected to the internet. Check your connection and try again.",null,"disconnected",e.run_id),this.chatInput.restoreLastInput()}}}finally{this._suppressFileUploadClear=!1,this.chatFiles.clearAllFiles()}})),this.chatInput.onScreenShare((()=>{this.screenShareBox&&this.screenShareBox.getSharingStatus()?new a("Are you sure?","This will end screen sharing with your assistant").onConfirm((()=>{this.screenShareBox.stopCapture(),this.screenShareBox=null})):this.shareScreen()})),this.chatInput.onVoiceMode((()=>{this.toggleVoiceMode()})),this.chatInput.onModelSwitch((()=>{this.switchAIModel()})),this.chatInput.onAssistantSwitch((()=>{this.switchAssistant()})),this.chatInput.onMemorySwitch((()=>{this.loadMemoryDialogue()})),this.chatInput.onSkillSelected((e=>{e.enableFileUpload||this.chatSession.disableDragAndDropFileUpload()})),this.chatInput.onSkillClosed((()=>{this.chatSession.enableDragAndDropFileUpload()}))}shareScreen(){this.screenShareBox=new te(this.chat_id,(e=>{this.chatFiles.processFiles(e)})),this.screenShareBox.startCapture(),this.screenShareBox.onStart((()=>{this.chatInput.toggleScreenShare(!0)})),this.screenShareBox.onStop((()=>{this.chatInput.toggleScreenShare(!1)}))}stopScreenSharingIfActive(){this.screenShareBox&&this.screenShareBox.stopCapture()}loadMemoryDialogue(){const e=this.assistant?.knowledge_graph_on||!1;this.memoryDialogue=new ee(e),this.memoryDialogue.onMemoryOff((async()=>{this.assistant&&(this.assistant.knowledge_graph_on=!1),this.chatInput.memoryStatus=!1,this.chatInput.updateMemoryIcon(),await u.K.toggleKnowledgeGraphOff()})),this.memoryDialogue.onMemoryOn((async()=>{this.assistant&&(this.assistant.knowledge_graph_on=!0),this.chatInput.memoryStatus=!0,this.chatInput.updateMemoryIcon(),await u.K.toggleKnowledgeGraphOn()}))}async getPrimaryContainer(){return await this.initializationPromise,window.appController&&window.appController.switchToView("chat"),this.primaryContent}async switchAIModel(){if(this.chatInput?.forkSessionMessage){const e=this.chatInput.modelSelection.element;return void new ve(e,this.models,this.chatInput.forkSessionMessage.model.id,(e=>{e&&(this.chatInput.forkSessionMessage.model=e,this.chatInput.model=e)}),(()=>{}),(()=>{}))}if(!u.K.hasPermission("feature:model-switching"))return Promise.resolve({changed:!1,model:this.model?.name||null});this.modelSelectorInstance&&(this.modelSelectorInstance.remove(!0),this.modelSelectorInstance=null),this.modelCatalogueInstance&&(this.modelCatalogueInstance.close(),this.modelCatalogueInstance=null);const e=this.chatInput?.modelSelection?.element;if(!e)return new c.y("Could not open model switcher.","error"),Promise.resolve({changed:!1,model:this.model?.name||null});const t=this.model,s=this.model?.name||null;return new Promise((i=>{this.modelSelectorInstance=new ve(e,this.models,t?.id,(async e=>{this.modelSelectorInstance=null,await this._performModelSwitch(e,t,s,i)}),(()=>{this.modelSelectorInstance=null,this.modelCatalogueInstance&&(this.modelCatalogueInstance.close(),this.modelCatalogueInstance=null),this.modelCatalogueInstance=new ye(this.models,t?.id,(async e=>{this.modelCatalogueInstance=null,await this._performModelSwitch(e,t,s,i)}),(()=>{this.modelCatalogueInstance=null,i({changed:!1,model:s})}))}),(()=>{this.modelSelectorInstance=null,i({changed:!1,model:s})}))}))}async _performModelSwitch(e,t,s,i,n=!1){if(e&&e.id!==t?.id){this.model=e,this.chatInput&&(this.chatInput.model=this.model,"function"==typeof this.chatInput.updateModelDisplay&&this.chatInput.updateModelDisplay()),this._setSelectedModel(this.model.id),window.current_model_id=this.model.id,this.chatInput?.focus(),this.chatSession?.updateScrollPosition&&this.chatSession.updateScrollPosition();try{await g.G.postData(`/chat/${this.chat_id}/model/`,{codename:this.model.value,is_automatic:n}),n||this.onModelSwitch({content:`Switched to model ${this.model.name}`}),i({changed:!0,model:this.model.name})}catch(e){new c.y("Failed to switch model. Reverting.","error"),this.model=t,this.chatInput&&(this.chatInput.model=this.model,"function"==typeof this.chatInput.updateModelDisplay&&this.chatInput.updateModelDisplay()),this._setSelectedModel(t?.id),window.current_model_id=t?.id,i({changed:!1,model:s})}}else i({changed:!1,model:s})}async getNewModelResponse(e,t){const s=this.models.filter((t=>!e.responses.some((e=>e.model===t.name))));if(0===s.length)return void new c.y("No more models available for this message","info");const i=new h({enableCreate:!1,maxSelections:1,options:s,enableSearch:!0,searchPlaceholder:"Search models..."}),n=new l({size:"medium",title:"Select AI model",body:i.create(),closeX:!0,confirmOnExit:!1,confirm:!0,cancel:!1,confirmText:"Generate new response",buttonStyleConfirm:"ringPrimary",buttonStyleCancel:"ringSecondary",buttonSize:"large",buttonWidth:"full"});return new Promise((s=>{n.onConfirm((async()=>{i.save();const n=i.getSelected();if(n)try{const i=await this.generateNewModelReply(e.id,n.value);e.responses.push(i),this.chatSession.updateMessageResponses(e,t),new c.y("New response generated successfully","success"),s(i)}catch(e){new c.y("Failed to generate new response","error"),s(null)}else new c.y("No model selected","info"),s(null)})),n.onClose((()=>{s(null)}))}))}async switchAssistant(){if(this.chatInput?.forkSessionMessage){const e=this.chatInput.assistantSelection.element;return void new fe(e,this.assistants,this.chatInput.forkSessionMessage.assistant.id,(e=>{if(e){const t=this.assistants.find((t=>t.id===e.id))||e;this.chatInput.forkSessionMessage.assistant=t,this.chatInput.assistant=t}}),(()=>{}),(()=>{}),this)}this.assistantSelectorInstance&&(this.assistantSelectorInstance.remove(),this.assistantSelectorInstance=null);const e=this.chatInput?.assistantSelection?.element;e?(!this.assistants||this.assistants.length,this.assistantSelectorInstance=new fe(e,this.assistants,this.assistant?.id,(async e=>{if(e&&e.id!==this.assistant?.id){const t=this.assistant,s=this.assistants.find((t=>t.id===e.id));if(this.assistant=s||e,this.chatInput.assistant=this.assistant,this._setSelectedAssistant(this.assistant.id),window.current_assistant_id=this.assistant.id,this.assistant.default_model){const e=this.models.find((e=>e.id===this.assistant.default_model.id||e.value===this.assistant.default_model.codename));e&&e.id!==this.model.id&&await this._performModelSwitch(e,this.model,this.model.name,(()=>{}),!0)}ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,this.getConversationName(),this.assistant.image),this.chatInput.focus(),this.chatSession&&this.chatSession.updateScrollPosition();try{this.isPlaceholder||await g.G.postData(`/chat/${this.chat_id}/assistant/`,{assistant_id:this.assistant.id})}catch(e){new c.y("Failed to switch assistant. Reverting.","error"),this.assistant=t,this.chatInput.assistant=this.assistant,this._setSelectedAssistant(this.assistant?.id),window.current_assistant_id=this.assistant?.id,ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,this.getConversationName(),this.assistant.image)}}this.assistantSelectorInstance=null}),(()=>{v.view("/chat/assistants/"),this.assistantSelectorInstance&&this.assistantSelectorInstance.remove(),this.assistantSelectorInstance=null}),(()=>{v.view("/chat/assistants/new"),this.assistantSelectorInstance&&this.assistantSelectorInstance.remove(),this.assistantSelectorInstance=null}),this)):new c.y("Could not open assistant switcher.","error")}getConversationName(){return this.chat&&this.chat.name||"New session"}showSessionReplyUI(e,t,s){this.chatInput&&"function"==typeof this.chatInput.displaySessionReplyIndicator?this.chatInput.displaySessionReplyIndicator(e,t,s):new c.y("Cannot display session reply UI.","error")}focusInChatInput(){this.chatInput&&"function"==typeof this.chatInput.focus&&this.chatInput.focus()}static async pinChat(e,t){const s=ke.chatInstances[e];let i=!1,n=!1,a=null;if(s&&s.chat)a=s.isPinned();else if(ke.sessionTabs){const t=ke.sessionTabs.tabs.find((t=>t.id===e));t&&(a=t.isPinned)}if(t!==a||null===a){n=!0;try{await g.G.postData(`/chat/${e}/pinned/`,{pinned:t}),i=!0,s&&s.chat?s.chat.pinned=t:s&&s.initializationPromise&&s.initializationPromise.then((()=>{s.chat&&(s.chat.pinned=t)}))}catch(s){if(new c.y(`Failed to ${t?"pin":"unpin"} session. Please try again.`,"error"),i=!1,ke.sessionTabs){const s=ke.sessionTabs.tabs.find((t=>t.id===e));s&&s.isPinned===t&&(s.isPinned=!t,ke.sessionTabs.sortTabs(),ke.sessionTabs.renderTabs())}return}if(i){if(ke.sessionTabs){const s=ke.sessionTabs.tabs.find((t=>t.id===e));s&&(s.isPinned=t),ke.sessionTabs.sortTabs(),ke.sessionTabs.renderTabs(),setTimeout((()=>{ke.sessionTabs.scrollToActiveTab("smooth",45,e)}),160),ke.sessionTabs.debouncedSave()}}else true}else if(ke.sessionTabs){const s=ke.sessionTabs.tabs.find((t=>t.id===e));s&&s.isPinned!==t&&(s.isPinned=t,ke.sessionTabs.sortTabs(),ke.sessionTabs.renderTabs(),ke.sessionTabs.debouncedSave())}}async setPinned(e){this.chat?e!==this.chat.pinned&&(this.chat.pinned=e):new c.y("Error: Chat data unavailable.","error")}isPinned(){return!!this.chat&&!!this.chat.pinned}updateDefaultTitle(e){if(document.title=e+" - "+("Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name),ke.sessionTabs&&this.chat_id){const t=this.assistant?this.assistant.image:null;ke.sessionTabs.updateTabTitle(this.chat_id,e,t,!1)}}static async promptAndRenameChat(e){let t="New session";const s=ke.sessionTabs?.tabs.find((t=>t.id===e));if(s&&s.title&&(t=s.title),"New session"===t){const s=ke.chatInstances[e];if(s&&s.chat){const e=s.getConversationName();e&&"New session"!==e&&(t=e)}}const i=document.createElement("div");i.className="space-y-4 p-1";const n=new d({label:"",type:"text",placeholder:"Enter new name...",value:t,required:!0,minChar:1,id:"rename-chat-input"});n.render(i);const a=new l({title:"Rename session",body:i,size:"small",closeX:!1,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",buttonStyleConfirm:"primary",buttonStyleCancel:"secondary",buttonSize:"medium",manualCloseOnConfirm:!0,onConfirm:async()=>{if(a.toggleConfirmLoading(!0),!n.validate())return a.toggleConfirmLoading(!1),!1;const t=n.value.trim(),s=ke.chatInstances[e],i=ke.sessionTabs?.tabs.find((t=>t.id===e));let o;if(o=s&&s.chat?s.getConversationName():i?i.title:"New session",t!==o)if(t)if(s)try{await s.renameChat(t),a.close()}catch(e){a.toggleConfirmLoading(!1)}else{const s=i?.title||"New session",n=i?.assistantImage||null;ke.sessionTabs&&ke.sessionTabs.updateTabTitle(e,t,n,!1);let o=document.title,r=!1;if(ke.sessionTabs?.activeTabId===e){const e="Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name||"Simtheory";document.title=`${t} - ${e}`,r=!0}try{await g.G.postData("/chat/rename_chat/",{chatId:e,newName:t}),ke.sessionTabs&&ke.sessionTabs.debouncedSave(),a.close()}catch(t){ke.sessionTabs&&ke.sessionTabs.updateTabTitle(e,s,n,!1),r&&(document.title=o),new c.y("Failed to rename session. Please try again.","error"),a.toggleConfirmLoading(!1)}}else new c.y("Name cannot be empty.","error"),a.toggleConfirmLoading(!1);else a.close()},onClose:()=>{a.toggleConfirmLoading(!1)}});setTimeout((()=>n.focus()),100)}async renameChat(e){const t=e.trim();if(!t)return void new c.y("Name cannot be empty.","error");let s="New session",i=this.assistant?this.assistant.image:null;if(this.chat){if(t===this.chat.name)return;s=this.chat.name,this.chat.name=t}else{const e=ke.sessionTabs?.tabs.find((e=>e.id===this.chat_id));if(e){if(t===e.title)return;s=e.title,e.assistantImage&&(i=e.assistantImage)}}ke.sessionTabs&&this.chat_id&&ke.sessionTabs.updateTabTitle(this.chat_id,t,i,!1),ke.activeChat&&ke.activeChat.chat_id===this.chat_id&&this.updateDefaultTitle(t);try{await g.G.postData("/chat/rename_chat/",{chatId:this.chat_id,newName:t}),this.initializationPromise&&this.initializationPromise.then((()=>{this.chat&&(this.chat.name=t)})).catch((e=>{})),ke.sessionTabs&&ke.sessionTabs.debouncedSave()}catch(e){throw this.chat&&(this.chat.name=s),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.updateTabTitle(this.chat_id,s,i,!1),ke.activeChat&&ke.activeChat.chat_id===this.chat_id&&this.updateDefaultTitle(s),new c.y("Failed to rename session. Please try again.","error"),e}}async toggleVoiceMode(){this.inVoiceMode&&this.voiceModal?(this.inVoiceMode=!1,new a("Are you sure?","This will disconnect voice mode").onConfirm((()=>{this.voiceModal.destroy()}))):(this.inVoiceMode=!0,this.voiceModal=new ae(this.chat,this.assistant,this.stVoice,(e=>{"start"===e&&this.stVoice.togglePushToTalk(!0),"end"===e&&this.stVoice.togglePushToTalk(!1),"stop"===e&&this.stVoice.togglePushToTalk(!1),"interrupt"===e&&this.stVoice.handleInterrupt()})),this.voiceModal.onVoiceClosed((()=>{this.inVoiceMode=!1})),this.voiceModal.connect())}static async refreshChat(e){const t=ke.chatInstances[e];if(!t)return;const s=ke.activeChat&&ke.activeChat.chat_id===e;t.destroy(),delete ke.chatInstances[e],ke.activeChat&&ke.activeChat.chat_id===e&&(ke.activeChat=null),await new Promise((e=>setTimeout(e,50)));const i=new ke(e,null,{isInitialLoad:!1});ke.chatInstances[e]=i;try{await i.initializationPromise,s&&await ke.switchToChat(e,i,!1)}catch(t){new c.y("Failed to refresh session.","error"),ke.chatInstances[e]===i&&(i.destroy(),delete ke.chatInstances[e]),await ke.doCloseChat(e)}}static async deleteChat(e){const t=ke.chatInstances[e];let s="this session";if(t&&t.chat)s=t.getConversationName();else if(ke.sessionTabs){const t=ke.sessionTabs.tabs.find((t=>t.id===e));t&&t.title&&(s=t.title)}new a("Delete session?",`Are you sure you want to permanently delete "${s}"? This action cannot be undone.`).onConfirm((async()=>{try{const s={uuid:e};if(await g.G.postData("/chat/delete/",s),t)t.destroy(),delete ke.chatInstances[e];else{const t=document.getElementById(`chat-container-${e}`);t&&t.parentNode&&t.parentNode.removeChild(t)}ke.activeChat&&ke.activeChat.chat_id===e&&(ke.activeChat=null);let i=null;if(ke.sessionTabs){const t=await ke.sessionTabs.removeTab(e);if(t.wasActive){if(t.tabsRemaining>0&&t.newActiveTabId)i=t.newActiveTabId;else if(0===t.tabsRemaining&&!ke._isCreatingNewChat){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}finally{ke._isCreatingNewChat=!1}}}else if(!ke.sessionTabs.activeTabId&&ke.sessionTabs.tabs.length>0)i=ke.sessionTabs.tabs[0].id;else if(0===ke.sessionTabs.tabs.length&&!ke.sessionTabs.activeSpecialTabId&&!ke._isCreatingNewChat){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}finally{ke._isCreatingNewChat=!1}}}if(i&&window.appController)window.appController.routeTo(`/chat/${i}`);else if(!(ke.sessionTabs&&(0!==ke.sessionTabs.tabs.length||ke.sessionTabs.activeSpecialTabId||ke._isCreatingNewChat)||ke._isCreatingNewChat)){ke._isCreatingNewChat=!0;try{await ke.createNewChat()}finally{ke._isCreatingNewChat=!1}}}catch(e){new c.y("Failed to delete session. Check connection.","error")}}))}async _handleAssistantListUpdate(){const e=this.assistant?.id;this.assistant;this.assistants=window.initial_assistants;if(this.assistants.some((t=>t.id===e))){const t=this.assistants.find((t=>t.id===e));t&&(this.assistant=t,this.chatInput&&(this.chatInput.assistant=this.assistant,this.chatInput.updateAssistantDisplay()),ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,null,this.assistant.image))}else if(e){let e=this.assistants.find((e=>e.id===window.current_assistant_id))||this.assistants[0];if(e){if(this.assistant=e,this._setSelectedAssistant(this.assistant.id),this.chatInput&&(this.chatInput.assistant=this.assistant,this.chatInput.updateAssistantDisplay()),this.chatSession&&(this.chatSession.assistant=this.assistant),ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,null,this.assistant.image),!this.isPlaceholder&&this.chat_id)try{await g.G.postData(`/chat/${this.chat_id}/assistant/`,{assistant_id:this.assistant.id})}catch(e){new c.y("Could not save the new assistant for this chat.","error")}}else new c.y("CRITICAL: No assistants available. Please contact support.","error"),this.chatSession&&this.chatSession.showAssistantError(this.chat_id,"No assistants are available in your workspace. This chat cannot continue.",null,"error")}}async _handleAssistantButtonsUpdate(e){if(!e.detail||!e.detail.assistantId)return;const{assistantId:t,isCreate:s}=e.detail;if(s&&ke.activeChat===this){const e=window.initial_assistants.find((e=>e.id===t));e&&await this._switchToNewAssistant(e)}else if(!s&&this.assistant&&this.assistant.id===t){const e=window.initial_assistants.find((e=>e.id===t));e&&(this.assistant=e,this.chatInput&&(this.chatInput.assistant=this.assistant),this.chatSession&&(this.chatSession.assistant=this.assistant),ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,this.getConversationName(),this.assistant.image))}}async _switchToNewAssistant(e){if(e&&(this.assistant=e,this._setSelectedAssistant(this.assistant.id),window.current_assistant_id=this.assistant.id,this.chatInput&&(this.chatInput.assistant=this.assistant,"function"==typeof this.chatInput.updateAssistantDisplay&&this.chatInput.updateAssistantDisplay()),this.chatSession&&(this.chatSession.assistant=this.assistant),ke.sessionTabs&&ke.sessionTabs.updateTabTitle(this.chat_id,this.getConversationName(),this.assistant.image),!this.isPlaceholder))try{await g.G.postData(`/chat/${this.chat_id}/assistant/`,{assistant_id:this.assistant.id}),this.onAssistantSwitch({assistant_id:this.assistant.id})}catch(e){new c.y("Could not save the new assistant to the current chat.","error")}}async sendObjectActionMessage(e){this.isStreaming&&(this.stopStreaming(),this.chatSession.markThinkingAsInterrupted());const t=e||{},s=t.prompt||"",i=t.objectType||null,n=t.objectTitle||null,a=t.objectId||null,o=t.selection?t.selection:t.contextText?{markdown:t.contextText}:null,r={id:Math.random().toString(36).substring(7),run_id:Math.random().toString(36).substring(7),type:"user",nickname:this.user.nickname,profileImage:this.user.profileImage,timestamp:(new Date).toISOString(),body:s,action_context:{type:t.type||"edit",objectType:i,objectTitle:n,contextText:t.contextText||null,contextPayload:t.contextPayload||null},object_context:{object_id:a,object_type:i,selection:o||null,range:t.range||null,heading_path:t.heading_path||[],doc:t.doc||null,expected_revision:t.expected_revision??null,mode:t.mode||null,meta:t.meta||null}};return this.chatSession.addMessage(r,r.run_id),this.chatSession.toggleAssistantThinking(!0),this.chatSession.updateScrollPosition(),this.isStreaming=!0,this.chatInput.toggleStopButton(!0),ke.sessionTabs&&this.chat_id&&ke.sessionTabs.setTabWorkingState(this.chat_id,!0),await g.G.postData(`/chat/${this.chat_id}/message/`,r),r.run_id}}class Ee{constructor(e){this.theme=i.A.theme,this.records=e.records,this.clickOnRecord=e.clickOnRecord,this.optionMenu=e.optionMenu,this.options=e.options,this.theme=i.A.theme,this.title=e.title,this.createButton=e.createButton,this.createButtonText=e.createButtonText,this.createPermission=e.createPermission,this.search=e.search,this.searchPlaceholder=e.searchPlaceholder,this.searchValue=e.searchValue,this.scrollOffset=e.scrollOffset,this.showBackButton=e.showBackButton,this.backButtonRoute=e.backButtonRoute,this.callbacks={},this.onCreateCallback=null,this.onSelectCallback=null,this.listContainer=null,this.headerContainer=null,this.heading=null,this.newButton=null,this.list=null,this.headingWrapper=null,this.backButton=null,this.init()}init(){this.listContainer=document.createElement("div"),this.listContainer.className=`${this.theme.text} sm:max-w-[700px] leading-7 tracking-wide w-full sm:mx-0 space-y-4 py-2`,this.headerContainer=document.createElement("div"),this.headerContainer.className="flex justify-between items-center gap-2",this.headingWrapper=document.createElement("div"),this.headingWrapper.className="flex items-center align-middle justify-center gap-2",this.showBackButton&&this.backButtonRoute&&(this.backButton=document.createElement("button"),this.backButton.type="button",this.backButton.className=`rounded-md ${this.theme.text} font-medium text-sm flex items-center align-middle justify-center`,this.backButton.innerHTML='<i class="fa-solid fa-chevron-left fa-lg"></i>',this.backButton.addEventListener("click",(()=>{v.view(this.backButtonRoute)})),this.headingWrapper.appendChild(this.backButton)),this.heading=document.createElement("div"),this.heading.className=`text-xl md:text-2xl font-bold ${this.theme.text}`,this.heading.textContent=this.title,this.headingWrapper.appendChild(this.heading),this.createButton&&this.createPermission?(this.newButton=document.createElement("button"),this.newButton.type="button",this.newButton.className=`rounded-md px-4 py-0.5 ring-2 ${this.theme.ringSelected} ${this.theme.text} font-medium text-sm`,this.newButton.textContent=this.createButtonText,this.newButton.addEventListener("click",(()=>this.newRecord())),this.headerContainer.appendChild(this.headingWrapper),this.headerContainer.appendChild(this.newButton)):this.headerContainer.appendChild(this.headingWrapper),this.listContainer.appendChild(this.headerContainer),this.list=document.createElement("div"),this.list.className="space-y-4 pb-6",this.listContainer.appendChild(this.list),this.records.forEach((e=>{this.list.appendChild(this.renderRow(e))}))}render(e){e.innerHTML="",e.appendChild(this.listContainer)}renderRow(e){const t=document.createElement("div");t.id=`record-${e.id}`,this.clickOnRecord?(t.className=`${this.theme.listTableItem} ${this.theme.listTableHover} ring-1 rounded-md py-3 px-4 w-full text-left flex justify-between items-center gap-4 cursor-pointer select-none`,t.addEventListener("click",(()=>this.selectRecord(e)))):t.className=`${this.theme.listTableItem} ring-1 rounded-md py-3 px-4 w-full text-left flex justify-between items-center gap-4 cursor-default select-none`;const s=document.createElement("div");if(s.className="flex gap-4 items-center overflow-x-hidden truncate leading-5",e.image){const t=document.createElement("div");t.className="flex flex-shrink-0 w-12 h-12 rounded-full",t.innerHTML=`<img src="${e.image}" class="w-12 h-12 rounded-full" />`,s.appendChild(t)}if(e.icon){const t=document.createElement("div");t.className="flex flex-shrink-0 rounded-full w-6 h-6",t.innerHTML=`<i class="${e.icon} w-6 h-6"></i>`,s.appendChild(t)}const i=document.createElement("div");i.className="truncate";const n=document.createElement("div");if(n.className=`text-base ${this.theme.text} leading-5`,n.textContent=e.title,e.sub_text){const t=document.createElement("div");t.className=`text-sm ${this.theme.fadedText} leading-5 truncate`,t.textContent=e.sub_text,i.appendChild(n),i.appendChild(t)}else i.appendChild(n);s.appendChild(i),t.appendChild(s);let a=null,o=null,r=null,l=null;this.optionMenu&&(a=this.options.some((e=>e.permission)),o=this.options.some((e=>e.showIfRecordOwner)),r=this.options.some((e=>!e.showIfRecordOwner)),e.options&&e.options.length>0&&(l=!0));const c=document.createElement("div");if(c.className="flex gap-6 items-center",e.statusTag){const t=document.createElement("div");t.className="w-[60px] lg:w-[100px] flex justify-center";const s=document.createElement("div");s.className=`flex flex-shrink-0 px-1 py-0.5 rounded-md justify-center items-center ${this.theme.listStatusTag} ${this.theme.text}`,s.innerHTML=`<div class="text-xs max-w-[60px] lg:max-w-[100px] truncate overflow-ellipsis">${e.statusText}</div>`,t.appendChild(s),c.appendChild(t)}if(this.optionMenu&&a&&l&&(e.recordOwner&&o||!e.recordOwner&&r)){const t=document.createElement("div"),s=document.createElement("button");s.type="button",s.className=`${this.theme.text} focus:outline-none`,s.innerHTML='<i class="fa-solid fa-ellipsis-h fa-lg"></i>',s.addEventListener("click",(t=>{t.stopPropagation(),this.showOptionsMenu(e)})),t.appendChild(s),c.appendChild(t)}return t.appendChild(c),t}showOptionsMenu(e){this.menuContainer=document.createElement("div"),this.menuContainer.className="flex flex-col gap-3 py-4",this.options.forEach((t=>{if(!t.permission)return;if(t.showIfRecordOwner&&!e.recordOwner)return;if(!t.showIfRecordOwner&&e.recordOwner)return;if(e.options&&e.options.length>0){if(!e.options.find((e=>e===t.action)))return}const s=document.createElement("button");s.type="button",s.className=`rounded-md px-3 py-2 text-base font-medium ring-2 ${this.theme.ringSelected}`,s.textContent=t.text,s.addEventListener("click",(()=>this.handleOption(t.action,e))),this.menuContainer.appendChild(s)})),this.modalConfig={size:"small",title:"",body:this.menuContainer,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1},this.modal=new l(this.modalConfig)}handleOption(e,t){this.modal.close(),this.modal&&this.modal.close(),this.callbacks[e]&&"function"==typeof this.callbacks[e]&&this.callbacks[e](t)}onCreate(e){"function"==typeof e&&(this.onCreateCallback=e)}newRecord(){"function"==typeof this.onCreateCallback&&this.onCreateCallback()}selectRecord(e){"function"==typeof this.onSelectCallback&&this.onSelectCallback(e)}onSelect(e){"function"==typeof e&&(this.onSelectCallback=e)}onAction(e,t){this.callbacks[e]=t}appendNewRow(e){this.list.appendChild(this.renderRow(e))}removeRow(e){const t=document.getElementById(`record-${e.id}`);t&&t.remove()}}class Se{constructor(e,t,s=null){this.primaryContent=s||document.getElementById("primary-content"),this.primaryView=null,this.renderElement=s,this.theme=i.A.theme,this.tableConfig=e,this.tableData=t,this.currentSortColumn=this.tableConfig.sortOptions.defaultSortColumn,this.currentSortOrder=this.tableConfig.sortOptions.defaultSortOrder,this.callbacks={},this.currentView=this.tableConfig.initialLayout||"table",this.latestSearchTerm="",this.isUpdating=!1,this.isLoading=!1,this.currentPage=1,this.hasMoreData=!0,this.itemsPerPage=e.itemsPerPage,this.contentView=null,this.MIN_COLUMN_WIDTH=50,this.dragGhostElement=null,this.isDragging=!1,this.dragStartX=0,this.dragStartY=0,this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.tableConfig.filters?this.currentFilter=this.tableConfig.filters[0].value:this.currentFilter=null,this.isManageMode=!1,this.openFolders=new Set,this.selectedRecords=new Set,this.selectedFolderId=null,this.selectedAssistantId=null,this.showAllAssistants=!1,this.toggleFolder=this.toggleFolder.bind(this),this.selectFolder=this.selectFolder.bind(this),this.dragOverFolder=null,this.dragLeaveTimer=null,this.isMobile=u.K.isMobile(),this.tableButtonElement=null,this.gridButtonElement=null,this.loadMoreData=this.loadMoreData.bind(this),this.handleFilterChange=this.handleFilterChange.bind(this),this.handleAssistantChange=this.handleAssistantChange.bind(this),this.handleFolderChange=this.handleFolderChange.bind(this),this.handleSort=this.handleSort.bind(this),this.handleCreateClick=this.handleCreateClick.bind(this),this.handleResize=this.handleResize.bind(this),this.stopResize=this.stopResize.bind(this)}render(){this.primaryContent.innerHTML="";const e=()=>document.documentElement.style.setProperty("--vh",window.innerHeight/100+"px");e(),window.__vhSetOnce||(window.addEventListener("resize",e),window.addEventListener("orientationchange",e),window.__vhSetOnce=!0);const t="top"===this.tableConfig.lhsMenuPosition?"lg:mt-0 mt-0":"mt-6",s=document.createElement("div");s.classList=`flex flex-col w-full leading-7 py-2 justify-center items-center px-2 sm:px-4 lg:pl-5 ${t} ${this.renderElement}`;const i=document.createElement("div");i.classList="w-full";const a=document.createElement("div");"top"===this.tableConfig.lhsMenuPosition?a.classList="w-full flex-shrink-0 overflow-x-auto mb-4 mt-2":a.classList="w-[180px] flex-shrink-0 hidden sm:block overflow-y-auto h-[calc(var(--vh)*100-72px)]";const r=document.createElement("div");r.classList="top"===this.tableConfig.lhsMenuPosition?"text-2xl font-bold pb-1 sm:flex":"text-2xl font-bold pb-4 sm:flex",r.textContent=this.tableConfig.tableTitle,a.appendChild(r);const l=document.createElement("ul");if(l.classList="top"===this.tableConfig.lhsMenuPosition?"flex h-[44px] items-center":"space-y-1 pt-1",this.tableConfig.filters&&this.tableConfig.filters.length>1?this.tableConfig.filters.forEach((e=>{const t=document.createElement("li");t.id="filter-"+e.value,"top"===this.tableConfig.lhsMenuPosition?t.classList=e.value===this.currentFilter?`flex justify-center align-middle items-center ${this.theme.tabSelectedBackground} ${this.theme.tabSelectedTextColor} rounded-lg px-3`:"cursor-pointer px-3":(t.classList.add("cursor-pointer","py-1","px-2.5","rounded-md"),e.value===this.currentFilter?t.classList.add(...this.theme.menuSelectedItem.split(" "),"font-semibold"):t.classList.add(this.theme.tableHoverBackground)),t.textContent=e.name,t.onclick=()=>this.handleFilterChange(e.value),l.appendChild(t)})):"top"===this.tableConfig.lhsMenuPosition&&l.classList.remove("h-[44px]"),this.tableConfig.assistants&&this.tableConfig.assistants.length>0){const e=document.createElement("div");e.classList=`pt-2 border-b ${this.theme.tableBorder} w-10 my-2`,l.appendChild(e);const t=document.createElement("ul");t.classList.add("space-y-0.5","pt-2");if((this.showAllAssistants?this.tableConfig.assistants:this.tableConfig.assistants.slice(0,5)).forEach((e=>{const s=document.createElement("li");s.id=`assistant-${e.id}`,s.classList.add("flex","items-center","gap-2","p-1","rounded-md","cursor-pointer"),String(e.id)===String(this.selectedAssistantId)?s.classList.add(...this.theme.menuSelectedItem.split(" "),"font-semibold"):s.classList.add(this.theme.tableHoverBackground);const i=document.createElement("img");i.src=e.image,i.classList="w-6 h-6 rounded-full object-cover flex-shrink-0";const n=document.createElement("span");n.textContent=e.name,n.classList=`text-sm ${this.theme.text} truncate whitespace-nowrap overflow-hidden`,s.appendChild(i),s.appendChild(n),s.onclick=()=>this.handleAssistantChange(e.id),t.appendChild(s)})),l.appendChild(t),this.tableConfig.assistants.length>5){const e=document.createElement("li"),t=document.createElement("button");t.textContent=this.showAllAssistants?"Show less":"Show all",t.classList=`text-sm ${this.theme.fadedText} cursor-pointer pl-1 pt-1`,t.onclick=()=>{this.showAllAssistants=!this.showAllAssistants,this.render()},e.appendChild(t),l.appendChild(e)}}if(this.tableConfig.enableFolders){const e=document.createElement("div");e.classList=`pt-2 border-b ${this.theme.tableBorder} w-10 my-2`,l.appendChild(e);const t=document.createElement("div");this.folderSelector=new de(this.tableConfig.folders,{openFolders:this.openFolders,selectedFolderId:this.selectedFolderId,onFolderSelect:e=>{this.selectFolder(e)},onFolderToggle:(e,t)=>{t?this.openFolders.add(e):this.openFolders.delete(e)},onFolderDrop:(e,t)=>{this.callbacks.onMoveToFolder&&this.callbacks.onMoveToFolder(e,t)},onFolderCreate:async e=>{if(!this.callbacks.onFolderCreate)return null;try{return await this.callbacks.onFolderCreate(e)}catch(e){throw e}},onFolderRename:async e=>{if(this.callbacks.onFolderRename)try{await this.callbacks.onFolderRename(e)}catch(e){throw e}},onFolderDelete:async e=>{if(this.callbacks.onFolderDelete)try{await this.callbacks.onFolderDelete(e)}catch(e){throw e}},onFolderPositionChange:async e=>{if(this.callbacks.onFolderPositionChange)try{await this.callbacks.onFolderPositionChange(e)}catch(e){}}}),this.folderSelector.render(t),l.appendChild(t)}a.appendChild(l),i.appendChild(a);const c=document.createElement("div");c.classList="flex flex-col overflow-x-hidden w-full";const h=document.createElement("div");h.classList="flex justify-between items-center align-middle pb-4 sm:hidden px-2";const m=document.createElement("div"),u=document.createElement("div");m.innerText=this.tableConfig.tableTitle,m.classList="text-2xl font-bold",this.isMobile&&(this.mobileFilterAndFolderToggleButton=new n.$({type:"secondary",text:this.currentFilter?this.tableConfig.filters.find((e=>e.value===this.currentFilter)).name:"All",svgPathData:o.A.name("filter").path,svgViewBox:o.A.name("filter").viewBox,size:"small"}),this.mobileFilterAndFolderToggleButton.onClick((()=>{this.showFilterAndFolderModal()})),this.mobileFilterAndFolderToggleButton.render(u)),h.appendChild(m),h.appendChild(u),c.appendChild(h);const p=document.createElement("div");p.classList="top"===this.tableConfig.lhsMenuPosition?"flex justify-between items-center gap-2":"flex justify-between items-center mx-2 gap-2";const g=document.createElement("div");if(g.classList="flex gap-2 max-w-[250px] lg:max-w-full",this.tableConfig.enableSearch){let e;this.searchInput=new d({type:"search",placeholder:"Search...",size:"small",search:!0,value:this.latestSearchTerm});const t=t=>{clearTimeout(e),e=setTimeout((()=>this.handleSearch(t.trim())),200)};this.searchInput.onChange(t),this.searchInput.render(g)}if(this.tableConfig.enableGridLayout&&this.tableConfig.enableListLayout){const e=this.createViewToggle();g.appendChild(e)}p.appendChild(g);const f=document.createElement("div");if(f.classList="flex gap-2 table-action-buttons",this.tableConfig.enableManage){const e=new n.$({type:"secondary",text:this.isManageMode?"Cancel":"Manage",size:"extraSmall"});e.render(f),e.onClick((()=>{this.handleMassOperation()}))}if(this.tableConfig.enableCreate){const e=new n.$({type:"primary",svgPathData:o.A.name("plus").path,svgViewBox:o.A.name("plus").viewBox,text:this.tableConfig.createButtonText||"Create",size:"extraSmall"});e.render(f),e.onClick((()=>{this.handleCreateClick()}))}p.appendChild(f);const v=document.createElement("div");return v.classList="flex flex-col text-base font-bold mx-2 pb-2",v.textContent="All > Code projects",c.appendChild(p),this.contentViewWrapper=document.createElement("div"),this.contentViewWrapper.classList="content-view-wrapper",this.contentView="grid"===this.currentView?this.renderGridView():this.renderTableView(),this.contentViewWrapper.appendChild(this.contentView),c.appendChild(this.contentViewWrapper),i.appendChild(c),"top"===this.tableConfig.lhsMenuPosition?(i.appendChild(a),i.appendChild(c)):(i.classList+=" flex gap-5",i.appendChild(a),i.appendChild(c)),s.appendChild(i),this.primaryContent.appendChild(s),this.tableConfig.enableGridLayout&&this.tableConfig.enableListLayout&&this.updateViewToggle(),0===this.tableData.length&&this.showEmptyState(),s}showFilterAndFolderModal(){const e=()=>{let e="All";if(!this.mobileFolderSelected){e=this.tableConfig.filters.find((e=>e.value===this.currentFilter))?.name;const t=o.A.name("filter");return this.mobileFilterAndFolderToggleButton.setSvgIcon(t.path,t.viewBox),void(this.mobileFilterAndFolderToggleButton.text=e)}{e=this.mobileFolderSelector.getFolderNameById(this.mobileFolderSelected);const t=o.A.name("folder");this.mobileFilterAndFolderToggleButton.setSvgIcon(t.path,t.viewBox),this.mobileFilterAndFolderToggleButton.text=e}};e();const t=document.createElement("div");t.classList="flex flex-col h-full py-2";const s=document.createElement("div");s.classList="mb-4";const i=document.createElement("ul");if(i.classList="space-y-2",this.tableConfig.filters.forEach((e=>{const t=document.createElement("li");t.classList=`rounded-md cursor-pointer ${this.currentFilter===e.value?this.theme.selectedBackground:""}`,t.textContent=e.name,t.onclick=()=>{this.mobileFolderSelected=null,this.handleFilterChange(e.value),n.close()},i.appendChild(t)})),s.appendChild(i),t.appendChild(s),this.tableConfig.enableFolders){const e=document.createElement("div");e.classList="flex-grow overflow-y-auto";const s=document.createElement("div");s.classList="folders-container",this.mobileFolderSelector=new de(this.tableConfig.folders,{disableSettings:!0,openFolders:this.openFolders,selectedFolderId:this.selectedFolderId,onFolderSelect:e=>{this.selectFolder(e),this.mobileFolderSelected=e,n.close()}}),this.mobileFolderSelector.render(s),e.appendChild(s),t.appendChild(e)}const n=new l({title:"Filter by:",body:t,size:"small",fullHeightMobile:!0,closeX:!0});n.onClose((()=>{this.updateMassOperationButtonStates(),e()}))}toggleFolder(e){const t=document.getElementById(`folder-${e}`);if(!t)return;const s=t.querySelector(".chevron-icon-container"),i=t.querySelector(".folder-icon-container"),n=document.getElementById(`subfolders-${e}`);if(!s||!i)return;let a,l;this.openFolders.has(e)?(this.openFolders.delete(e),a="chevronRight",l="folder",n&&(n.style.display="none")):(this.openFolders.add(e),a="chevronDown",l="folder",n&&(n.style.display="block")),s.innerHTML="";const c=o.A.name(a),d=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.iconColor});s.appendChild(d.element),i.innerHTML="";const h=o.A.name(l),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.iconColor});i.appendChild(m.element)}selectFolder(e){this.exitManageMode(),this.currentFilter=null,this.selectedAssistantId=null,this.selectedFolderId=e,this.render(),this.folderSelector&&"function"==typeof this.folderSelector.setSelectedFolder&&this.folderSelector.setSelectedFolder(e),"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState(),this.callbacks.onFolderChange&&this.callbacks.onFolderChange(e)}handleFolderDragStart(e,t){this.folderSelector.exitEditMode(),e.dataTransfer.setData("application/json",JSON.stringify({type:"record",id:t.id})),e.dataTransfer.effectAllowed="move";const s=this.createDragImage(t);document.body.appendChild(s),e.dataTransfer.setDragImage(s,10,10),setTimeout((()=>{document.body.removeChild(s)}),0),e.target.classList.add("opacity-50")}handleFolderDragEnd(e){e.target.classList.remove("opacity-50")}handleFolderDragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move",this.dragLeaveTimer&&(clearTimeout(this.dragLeaveTimer),this.dragLeaveTimer=null);const t=e.currentTarget;if(this.dragOverFolder===t)return;this.dragOverFolder&&this.resetFolderState(this.dragOverFolder),this.dragOverFolder=t,this.dragOverFolder.classList.add(this.theme.folderDragOverBackground||"bg-gray-100");const s=this.dragOverFolder.querySelector(".folder-icon-wrapper");if(s){s.innerHTML="";const e=o.A.name("folder"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColorActive||this.theme.fileFolderIconColor});s.appendChild(t.element)}}handleFolderDragLeave(e){const t=e.relatedTarget,s=e.currentTarget;this.dragOverFolder!==s||t&&s.contains(t)||(this.dragLeaveTimer=setTimeout((()=>{this.dragOverFolder===s&&(this.resetFolderState(this.dragOverFolder),this.dragOverFolder=null)}),50))}handleFolderDrop(e){let t;e.preventDefault(),this.dragOverFolder&&(this.resetFolderState(this.dragOverFolder),this.dragOverFolder=null);try{t=JSON.parse(e.dataTransfer.getData("application/json"))}catch(e){return}if("record"!==t.type)return;const s=t.id,i=e.currentTarget.id.split("-")[1],n=document.getElementById(`record-id-${s}`);n&&(n.classList.add("opacity-0","transition-opacity","duration-300"),setTimeout((()=>n.remove()),300)),this.moveRecordToFolder(s,i)}resetFolderState(e){if(!e)return;e.classList.remove(this.theme.folderDragOverBackground||"bg-gray-100");const t=e.querySelector(".folder-icon-wrapper");if(t){t.innerHTML="";const s=e.dataset.folderId;let i="folder";s&&this.openFolders&&this.openFolders.has(s);const n=o.A.name(i),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fileFolderIconColor});t.appendChild(a.element)}}moveRecordToFolder(e,t){const s=this.tableData.findIndex((t=>t.id===e));if(-1===s)return;this.tableData[s].folderId=t,this.tableData.splice(s,1),this.updateContentView(),this.callbacks.onMoveToFolder&&this.callbacks.onMoveToFolder(e,t)}createDragImage(e){const t=document.createElement("div");t.classList=`${this.theme.tableCardBackground} ${this.theme.tableCardBorder} p-2 rounded-md shadow-lg border absolute top-[-1000px] left-[-1000px] z-50 pointer-events-none`,t.style.width="200px";const s=document.createElement("div");s.classList="flex items-center";const i=this.getIconAndColorByType(e.type),n=document.createElement("div");n.classList.add("p-2","rounded","mr-2","w-8","h-8","flex","items-center","justify-center"),i.bgColor&&n.classList.add(i.bgColor);const a=o.A.name(i.icon),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-4 h-4",colorClass:i.color});n.appendChild(l.element);const c=document.createElement("div");return c.classList=`${this.theme.text} font-semibold text-sm truncate`,c.textContent=e.name,s.appendChild(n),s.appendChild(c),t.appendChild(s),t}showFolderSelectionDialog(e){const t=this.tableConfig.folders,s=document.createElement("div");let i;s.classList=`max-h-full py-2 mt-2 px-4 ${this.theme.secondaryBackground} rounded-md`,s.classList.add("folder-selection");new de(t,{mode:"modal",openFolders:this.openFolders,selectedFolderId:this.selectedFolderId,onFolderSelect:e=>{this.selectedFolderId=e,i&&i.enableConfirmButton()},onFolderToggle:(e,t)=>{t?this.openFolders.add(e):this.openFolders.delete(e)},onFolderDrop:(e,t)=>{this.callbacks.onMoveToFolder&&this.callbacks.onMoveToFolder(e,t)},onFolderCreate:async e=>{if(!this.callbacks.onFolderCreate)return null;try{return await this.callbacks.onFolderCreate(e)}catch(e){throw e}},onFolderRename:async e=>{if(this.callbacks.onFolderRename)try{await this.callbacks.onFolderRename(e)}catch(e){throw e}},onFolderDelete:async e=>{if(this.callbacks.onFolderDelete)try{await this.callbacks.onFolderDelete(e)}catch(e){throw e}},onFolderPositionChange:async e=>{if(this.callbacks.onFolderPositionChange)try{await this.callbacks.onFolderPositionChange(e)}catch(e){}}}).render(s),i=new l({size:"small",title:"Add to folder",body:s,closeX:!0,confirm:!0,cancel:!0,confirmText:"Move",cancelText:"Cancel",buttonWidth:"full",buttonStyleConfirm:"primary",buttonStyleCancel:"secondary",buttonSize:"medium"}),i.disableConfirmButton(),i.onConfirm((()=>{this.selectedFolderId&&this.moveSelectedToFolder(this.selectedFolderId,e)})),i.onClose((()=>{this.selectedFolderId=null,this.render()}))}moveSelectedToFolder(e){const t=Array.from(this.selectedRecords);this.exitManageMode(),this.callbacks.onMoveToFolder(t,e).then((()=>{this.updateRecordsAfterFolderMove(t,e),this.selectedRecords.clear()})).catch((e=>{}))}updateRecordsAfterFolderMove(e,t){e.forEach((e=>{const s=this.tableData.find((t=>t.id===e));s&&(s.folderId=t)})),this.exitManageMode()}addToFolder(){this.selectedRecords.size>0&&this.showFolderSelectionDialog()}removeFromFolder(){this.selectedRecords.size>0&&this.callbacks.onRemoveFromFolders&&this.callbacks.onRemoveFromFolders(Array.from(this.selectedRecords))}async handleSearch(e){if(!this.isSearching&&this.latestSearchTerm!==e){this.isSearching=!0;try{this.callbacks.onResetPagination&&this.callbacks.onResetPagination(),"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState(),this.latestSearchTerm=e,this.currentPage=1,this.hasMoreData=!0,await this.loadData(),this.updateContentView()}catch(e){}finally{this.isSearching=!1}}}showLoadingView(){this.isLoading=!0,"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState()}showGridRecordsLoadingState(){const e=this.contentViewWrapper.querySelector(".grid");if(e){e.innerHTML="";this.createLoadingItems("grid",8).forEach((t=>e.appendChild(t)))}}showTableRecordsLoadingState(){const e=this.contentViewWrapper.querySelector("tbody");if(e){e.innerHTML="";this.createLoadingItems("table",10).forEach((t=>e.appendChild(t)))}}fetchAndUpdateContentView(){this.isLoading||(this.showLoadingView(),this.hasMoreData=!0,this.currentPage=1,this.loadMoreData())}updateContentView(e=null){if(e&&(this.tableData=e),this.contentViewWrapper.innerHTML="",0===this.tableData.length)this.showEmptyState();else{const e="grid"===this.currentView?this.renderGridView():this.renderTableView();if(this.contentViewWrapper.appendChild(e),this.contentView=e,"table"===this.currentView&&this.rebuildTableHeader(),this.isManageMode){this.contentViewWrapper.querySelectorAll('input[type="checkbox"]').forEach((e=>{e.checked=this.selectedRecords.has(e.dataset.recordId)}))}}this.saveTableState()}createViewToggle(){const e=document.createElement("div");e.classList.add("flex","gap-1","items-center");const t=o.A.name("tableList"),s=document.createElement("button");s.classList=`flex items-center justify-center w-8 h-8 ring-1 ring-inset ${this.theme.tableButton} rounded-md`,"table"===this.currentView&&s.classList.add(this.theme.tableButtonSelectedBackground);const i=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.iconColor});s.appendChild(i.element),s.onclick=()=>this.switchView("table"),this.tableButtonElement=s;const n=o.A.name("grid2"),a=document.createElement("button");a.classList=`flex items-center justify-center w-8 h-8 ring-1 ring-inset ${this.theme.tableButton} rounded-md`,"grid"===this.currentView&&a.classList.add(this.theme.tableButtonSelectedBackground);const l=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.iconColor});return a.appendChild(l.element),a.onclick=()=>this.switchView("grid"),this.gridButtonElement=a,e.appendChild(this.tableButtonElement),e.appendChild(this.gridButtonElement),e}updateViewToggle(){if(this.tableConfig.enableGridLayout&&this.tableConfig.enableListLayout){if(!this.tableButtonElement||!this.gridButtonElement)return;this.tableButtonElement.classList.remove(this.theme.tableButtonSelectedBackground),this.gridButtonElement.classList.remove(this.theme.tableButtonSelectedBackground),"table"===this.currentView?this.tableButtonElement.classList.add(this.theme.tableButtonSelectedBackground):this.gridButtonElement.classList.add(this.theme.tableButtonSelectedBackground)}}switchView(e){this.currentView!==e&&(this.currentView=e,this.updateContentView(),this.updateViewToggle(),"table"===e&&setTimeout((()=>{this.rebuildTableHeader()}),0),this.callbacks.onViewChange&&this.callbacks.onViewChange(this.getCurrentTableState()))}createResizeHandle(){const e=document.createElement("div");e.classList="resize-handle-container absolute right-0 top-0 h-full cursor-col-resize",e.style.width="16px",e.style.transform="translateX(8px)";const t=document.createElement("div");return t.classList="resize-handle h-full w-1 absolute left-1/2 transform -translate-x-1/2",e.appendChild(t),e.addEventListener("mousedown",(e=>{if(e.stopPropagation(),e.preventDefault(),this.isMobile)return;this.isResizing=!0,this.currentResizingColumn=e.target.closest("th"),this.startX=e.clientX,this.startWidth=this.currentResizingColumn.offsetWidth;const t=document.createElement("div");t.classList="resize-line fixed h-full w-0.5 bg-blue-500",t.style.pointerEvents="none",t.style.zIndex="1000",document.body.appendChild(t);const s=this.currentResizingColumn.getBoundingClientRect(),i=this.primaryContent.querySelector("table").getBoundingClientRect();t.style.left=`${s.right}px`,t.style.top=`${i.top}px`,t.style.height=`${i.height}px`,this.resizeLine=t,this.tableRect=i,this.columnRect=s,document.addEventListener("mousemove",this.handleResize),document.addEventListener("mouseup",this.stopResize)})),e}handleResize=e=>{if(!this.isResizing||!this.currentResizingColumn)return;const t=e.clientX-this.startX;let s=this.startWidth+t;s=Math.max(this.MIN_COLUMN_WIDTH,s);const i=Array.from(this.primaryContent.querySelector("table").querySelectorAll("th")),n=i.indexOf(this.currentResizingColumn),a=n>0?i[n-1]:null,o=this.primaryContent.querySelector("table").offsetWidth-(i.length-1)*this.MIN_COLUMN_WIDTH;s=Math.min(s,o);const r=s-this.startWidth,l=this.columnRect.right+r;if(this.resizeLine.style.left=`${l}px`,this.potentialNewWidth=s,r<0&&a){const e=a.offsetWidth+Math.abs(r);a.style.width=`${e}px`}this.currentResizingColumn.style.width=`${s}px`};stopResize=()=>{if(this.isResizing&&(this.isResizing=!1,document.removeEventListener("mousemove",this.handleResize),document.removeEventListener("mouseup",this.stopResize),this.currentResizingColumn&&this.resizeLine)){const e=this.potentialNewWidth,t=Array.from(this.primaryContent.querySelector("table").querySelectorAll("th")).indexOf(this.currentResizingColumn);this.tableConfig.tableColumns[t].savedWidth=`${e}px`,document.body.removeChild(this.resizeLine),this.resizeLine=null,this.updateContentView(null);const s=this.getCurrentTableState();this.callbacks.onResizeCols&&this.callbacks.onResizeCols(s),this.currentResizingColumn=null,this.potentialNewWidth=null}};hideAllResizeLines(){this.primaryContent.querySelectorAll(".resize-line").forEach((e=>e.classList.add("hidden")))}updateBodyCellWidths(e,t){this.primaryContent.querySelector("table").querySelectorAll(`tbody tr td:nth-child(${e+1})`).forEach((e=>{e.style.width=`${t}px`}))}moveColumn(e,t,s){if(e===this.actionColumnIndex||t>=this.actionColumnIndex)return;s&&t<this.actionColumnIndex-1&&t++;const i=this.tableConfig.tableColumns.map((e=>e.savedWidth)),[n]=this.tableConfig.tableColumns.splice(e,1);this.tableConfig.tableColumns.splice(t,0,n);const[a]=i.splice(e,1);i.splice(t,0,a),this.tableConfig.tableColumns.forEach(((e,t)=>{e.savedWidth=i[t]}));const o=this.primaryContent.querySelector("table");Array.from(o.querySelectorAll("tr")).forEach((s=>{const n=Array.from(s.cells),[a]=n.splice(e,1);n.splice(t,0,a),s.innerHTML="",n.forEach(((e,t)=>{s.appendChild(e),e.style.width=i[t]}))})),this.rebuildTableHeader(),this.saveColumnOrder()}rebuildTableHeader(){const e=this.contentView?this.contentView.querySelector("table"):null;if(!e)return;const t=e.querySelector("thead");if(!t)return;const s=document.createElement("thead");s.classList="sticky top-0 z-30";const i=document.createElement("tr");i.classList=`text-left text-sm ${this.theme.tableHeaderText}`,i.style.backgroundColor=this.theme.backgroundHEX;let n=0;if(this.isManageMode){n=1;const e=document.createElement("th");e.classList="pb-2 px-2 font-semibold sticky left-0 z-30",e.style.width="25px",e.style.minWidth="25px",e.style.maxWidth="25px";const t=document.createElement("input");t.type="checkbox",t.classList="form-checkbox h-4 w-4 text-blue-600",t.addEventListener("change",this.handleSelectAll.bind(this)),this.updateSelectAllCheckboxState(t),e.appendChild(t),i.appendChild(e)}if(this.tableConfig.tableColumns.forEach(((e,s)=>{const a=t.querySelector(`th:nth-child(${s+1+n})`),l=document.createElement("th");l.classList="pb-2 px-2 font-semibold cursor-pointer relative select-none truncate";let c=e.savedWidth;if(!c&&a&&a.style.width&&(c=a.style.width),c&&(l.style.width=c),"actions"!==e.value&&(l.style.minWidth=`${this.MIN_COLUMN_WIDTH}px`),"actions"===e.value&&(l.classList.add("w-[40px]","sticky","right-0","z-20"),l.style.width="40px",l.style.minWidth="40px",l.style.maxWidth="40px"),l.textContent=e.name,e.sortable){l.onclick=t=>{setTimeout((()=>{this.isResizing||this.handleSort(e.value)}),50)};const t=document.createElement("span");if(t.classList="ml-1 inline-flex align-middle",this.currentSortColumn===e.value){const e="asc"===this.currentSortOrder?"chevronUp":"chevronDown",s=o.A.name(e),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.iconColor});t.appendChild(i.element)}l.appendChild(t)}if(s<this.tableConfig.tableColumns.length-1&&"actions"!==e.value){const e=this.createResizeHandle();l.appendChild(e)}"actions"!==e.value&&(l.setAttribute("draggable",!0),l.addEventListener("dragstart",(e=>{this.isResizing?e.preventDefault():this.handleDragStart(e,s)}))),i.appendChild(l)})),s.appendChild(i),e.contains(t))e.replaceChild(s,t);else{const t=e.querySelector("thead");t&&t.remove(),e.appendChild(s)}}updateSelectAllCheckboxState(e){if(!e||!this.contentViewWrapper)return;const t=this.contentViewWrapper.querySelectorAll('td input[type="checkbox"]');if(0===t.length)return e.checked=!1,void(e.indeterminate=!1);const s=Array.from(t).map((e=>e.dataset.recordId)),i=s.length>0&&s.every((e=>this.selectedRecords.has(e))),n=s.some((e=>this.selectedRecords.has(e))),a=this.selectedRecords.size>s.length&&n;i&&!a?(e.checked=!0,e.indeterminate=!1):n||a?(e.checked=!1,e.indeterminate=!0):(e.checked=!1,e.indeterminate=!1)}handleDragStart(e,t){if(this.isResizing)return void e.preventDefault();this.isDragging=!0,this.draggedColumnIndex=t,this.dragStartX=e.clientX,this.dragStartY=e.clientY,this.actionColumnIndex=this.tableConfig.tableColumns.findIndex((e=>"actions"===e.value));const s=e.target;this.dragGhostElement=document.createElement("div"),this.dragGhostElement.textContent=s.textContent,this.dragGhostElement.classList.add("column-ghost","fixed","pointer-events-none","z-[1000]",this.theme.background,"bg-opacity-80","shadow-lg","opacity-50","w-[150px]","h-[300px]",this.theme.fadedText,"text-sm","p-4"),this.dragGhostElement.style.position="fixed",this.dragGhostElement.style.left=`${e.clientX}px`,this.dragGhostElement.style.top=`${e.clientY}px`,document.body.appendChild(this.dragGhostElement),s.closest("table").querySelectorAll(`tr > :nth-child(${t+1})`).forEach((e=>{e.classList.add("dragging-cell")})),document.addEventListener("mousemove",this.handleMouseMove),document.addEventListener("mouseup",this.handleMouseUp),document.body.style.userSelect="none",document.body.style.mozUserSelect="none",document.body.style.msUserSelect="none",e.preventDefault()}handleMouseMove(e){if(this.isDragging&&this.dragGhostElement){requestAnimationFrame((()=>{this.dragGhostElement.style.left=`${e.clientX}px`,this.dragGhostElement.style.top=`${e.clientY}px`}));const t=document.elementFromPoint(e.clientX,e.clientY),s=t?.closest("th");if(s){const t=Array.from(s.parentNode.children).indexOf(s);if(s.closest("thead").querySelectorAll("th").forEach((e=>e.classList.remove("drag-over","drag-over-left","drag-over-right"))),t<this.actionColumnIndex){const t=s.getBoundingClientRect(),i=t.left+t.width/2;e.clientX<i?s.classList.add("drag-over","drag-over-left"):s.classList.add("drag-over","drag-over-right")}}}}handleMouseUp(e){if(this.isDragging){const t=document.elementFromPoint(e.clientX,e.clientY),s=t?.closest("th");if(s){const t=Array.from(s.parentNode.children).indexOf(s);if(t<this.actionColumnIndex){const i=s.getBoundingClientRect(),n=i.left+i.width/2,a=e.clientX>n;this.draggedColumnIndex!==t&&this.moveColumn(this.draggedColumnIndex,t,a)}}this.cleanupDrag()}}cleanupDrag(){this.dragGhostElement&&(document.body.removeChild(this.dragGhostElement),this.dragGhostElement=null),document.removeEventListener("mousemove",this.handleMouseMove),document.removeEventListener("mouseup",this.handleMouseUp),document.querySelectorAll(".dragging-cell").forEach((e=>e.classList.remove("dragging-cell"))),document.querySelectorAll("th").forEach((e=>e.classList.remove("drag-over","drag-over-left","drag-over-right"))),document.body.style.userSelect="",document.body.style.webkitUserSelect="",document.body.style.mozUserSelect="",document.body.style.msUserSelect="",this.isDragging=!1,this.draggedColumnIndex=null}renderTableView(){const e=document.createElement("div");e.classList="relative w-full overflow-x-auto";const t=document.createElement("div");let s="sm:h-[calc(var(--vh)*100-72px)] h-[calc(var(--vh)*100-72px)]";"top"===this.tableConfig.lhsMenuPosition&&(s="sm:h-[calc(var(--vh)*100-210px)] h-[calc(var(--vh)*100-210px)]"),t.classList=`table-container w-full pt-2 flex flex-col ${s} overflow-x-auto`;const i=document.createElement("table");i.classList="w-full table-fixed min-w-full";const n=document.createElement("colgroup");let a=0;if(this.isManageMode){const e=document.createElement("col");e.style.width="25px",n.appendChild(e)}this.tableConfig.tableColumns.forEach((e=>{const t=document.createElement("col");if("actions"===e.value)t.style.width="40px";else{const s=Math.max(parseInt(e.savedWidth)||this.MIN_COLUMN_WIDTH,this.MIN_COLUMN_WIDTH);t.style.width=`${s}px`,a+=s}n.appendChild(t)})),i.appendChild(n);const l=document.createElement("thead");l.classList="sticky top-0 z-30";const c=document.createElement("tr");if(c.classList=`text-left text-sm ${this.theme.tableHeaderText}`,c.style.backgroundColor=this.theme.backgroundHEX,this.isManageMode){const e=document.createElement("th");e.classList="pb-2 px-2 font-semibold";const t=document.createElement("input");t.type="checkbox",t.classList="form-checkbox h-4 w-4 text-blue-600",t.addEventListener("change",this.handleSelectAll.bind(this)),e.appendChild(t),c.appendChild(e)}this.tableConfig.tableColumns.forEach(((e,t)=>{const s=document.createElement("th");s.classList="pb-2 px-2 font-semibold cursor-pointer relative select-none truncate","actions"===e.value?(s.classList+=" sticky right-0 z-20",s.style.cssText+="\n                    width: 40px !important;\n                    min-width: 40px !important;\n                    max-width: 40px !important;\n                    flex: 0 0 40px !important;\n                "):e.savedWidth&&(s.style.width=`${e.savedWidth}px`,s.style.minWidth=`${this.MIN_COLUMN_WIDTH}px`);const i=document.createElement("div");if(i.classList="truncate",i.textContent=e.name,s.appendChild(i),e.sortable){s.onclick=t=>{this.justFinishedResizing?t.preventDefault():this.handleSort(e.value)};const t=document.createElement("span");if(t.classList="ml-1 inline-flex align-middle",this.currentSortColumn===e.value){const e="asc"===this.currentSortOrder?"chevronUp":"chevronDown",s=o.A.name(e),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-3 h-3",colorClass:this.theme.iconColor});t.appendChild(i.element)}i.appendChild(t)}if(t<this.tableConfig.tableColumns.length-1&&"actions"!==e.value){const e=this.createResizeHandle();s.appendChild(e)}"actions"!==e.value&&(s.setAttribute("draggable",!0),s.addEventListener("dragstart",(e=>this.handleDragStart(e,t))),s.addEventListener("drop",(e=>this.handleDrop(e,t))),s.addEventListener("dragend",this.handleDragEnd)),c.appendChild(s)})),l.appendChild(c),i.appendChild(l);const d=document.createElement("tbody");this.tableData.forEach((e=>{const t=this.createTableRow(e);d.appendChild(t)})),i.appendChild(d);const h=document.createElement("div");h.classList="overflow-auto flex-grow",h.appendChild(i),t.appendChild(h),e.appendChild(t);let m=0;return h.addEventListener("scroll",(()=>{const e=h.scrollTop;e>m&&h.scrollTop+h.clientHeight>=h.scrollHeight-100&&this.hasMoreData&&this.loadMoreData(),m=e})),e}renderGridView(){const e=document.createElement("div");e.classList="overflow-y-auto flex-grow sm:h-[calc(var(--vh)*100-70px)] h-[calc(var(--vh)*100-160px)]",e.addEventListener("scroll",(()=>{e.scrollTop+e.clientHeight>=e.scrollHeight-100&&this.loadMoreData()}));const t=document.createElement("div");return t.classList="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-2 px-2 pb-2 pt-4",e.appendChild(t),this.tableData.forEach((e=>{const s=this.createGridCard(e);t.appendChild(s)})),e}showOptionsMenu(e,t){e.stopPropagation();const s=document.querySelector(`.options-menu[data-record-id="${t.id}"]`);if(s)return void s.remove();document.querySelectorAll(".options-menu").forEach((e=>e.remove()));const i=document.createElement("div");i.className=`options-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-30 text-sm`,i.dataset.recordId=t.id;const n=document.createElement("ul");n.className="py-1",t.actions.forEach((e=>{if(e.divider){const e=document.createElement("li");return e.className=`border-t ${this.theme.tableDividerLine} my-1`,void n.appendChild(e)}const s=document.createElement("li"),a=document.createElement("button");a.className=`w-full text-left px-4 py-2 ${this.theme.tableMenuButtonHover}`,a.textContent=e.label,a.onclick=s=>{s.stopPropagation(),this.handleOption(e,t),i.remove()},s.appendChild(a),n.appendChild(s)})),i.appendChild(n),document.body.appendChild(i);const a=e.target.getBoundingClientRect(),o=i.getBoundingClientRect(),r=window.innerWidth-a.right;let l,c;l=window.innerHeight-a.bottom<o.height&&a.top>o.height?a.top-o.height:a.bottom,c=r<o.width&&a.left>o.width?a.right-o.width:a.left,i.style.top=`${l+window.scrollY}px`,i.style.left=`${c+window.scrollX}px`;const d=t=>{i.contains(t.target)||t.target===e.target||(i.remove(),document.removeEventListener("click",d))};document.addEventListener("click",d),requestAnimationFrame((()=>{i.style.pointerEvents="auto"})),i.style.pointerEvents="none"}saveColumnOrder(){if(this.callbacks.onColumnOrderChange){const e=this.tableConfig.tableColumns.map((e=>e.value));this.callbacks.onColumnOrderChange(e)}this.saveTableState()}handleOption(e,t){this.callbacks.onAction&&this.callbacks.onAction(e.value,t)}handleClick(e){this.callbacks.onRowClick&&this.callbacks.onRowClick(e)}setCallbacks(e){this.callbacks=e}handleFilterChange(e){this.exitManageMode(),this.currentFilter=e,this.selectedFolderId=null,this.selectedAssistantId=null,this.render(),this.searchInput.value=this.latestSearchTerm,this.currentPage=1,this.hasMoreData=!0,"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState(),this.callbacks.onFilterChange&&this.callbacks.onFilterChange(e,this.latestSearchTerm)}handleFolderChange(e){}async handleSort(e){this.currentSortColumn===e?this.currentSortOrder="asc"===this.currentSortOrder?"desc":"asc":(this.currentSortColumn=e,this.currentSortOrder="asc"),this.currentPage=1,this.hasMoreData=!0,"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState();try{if(await this.loadData(),this.callbacks.onSort&&this.callbacks.onSort(this.getCurrentTableState()),this.contentViewWrapper){const e=this.contentViewWrapper.querySelector(".overflow-auto, .overflow-y-auto");e&&(e.scrollTop=0)}}catch(e){}}handleCreateClick(){if(this.callbacks.onCreate){let e=null;this.callbacks.getCreatePayload&&(e=this.callbacks.getCreatePayload()),this.callbacks.onCreate(e)}}sortTable(e){const t=["modified","created","date_modified","date_created"];this.tableData.sort(((s,i)=>{let n=s[e],a=i[e];return t.includes(e)?(n=n&&n.date?new Date(n.date):null,a=a&&a.date?new Date(a.date):null):(n&&"object"==typeof n&&"date"===n.type&&(n=new Date(n.date)),a&&"object"==typeof a&&"date"===a.type&&(a=new Date(a.date))),null==n?"asc"===this.currentSortOrder?-1:1:null==a?"asc"===this.currentSortOrder?1:-1:n instanceof Date&&a instanceof Date?"asc"===this.currentSortOrder?n-a:a-n:"string"==typeof n&&"string"==typeof a?"asc"===this.currentSortOrder?n.localeCompare(a):a.localeCompare(n):"asc"===this.currentSortOrder?n<a?-1:n>a?1:0:n<a?1:n>a?-1:0})),this.updateContentView()}saveTableState(){const e={columnOrder:this.tableConfig.tableColumns.map((e=>e.value)),columnWidths:this.getCurrentColumnWidths(),sortColumn:this.currentSortColumn,sortOrder:this.currentSortOrder,view:this.currentView,filter:this.currentFilter};this.callbacks.onTableStateChange&&this.callbacks.onTableStateChange(e)}getCurrentTableState(){return{columnOrder:this.tableConfig.tableColumns.map((e=>e.value)),columnWidths:this.getCurrentColumnWidths(),sortColumn:this.currentSortColumn,sortOrder:this.currentSortOrder,view:this.currentView,filter:this.currentFilter,folderId:this.selectedFolderId,assistantId:this.selectedAssistantId,search:this.latestSearchTerm}}getCurrentColumnWidths(){const e={};return this.tableConfig.tableColumns.forEach((t=>{let s=this.MIN_COLUMN_WIDTH;t.savedWidth&&("string"==typeof t.savedWidth?s=parseInt(t.savedWidth.replace("px","")):"number"==typeof t.savedWidth&&(s=t.savedWidth)),e[t.value]=s})),e}getIconAndColorByType(e){const t={doc:{iconKey:"file",bgColor:"bg-purple-100",color:"text-purple-600"},folder:{iconKey:"folder",bgColor:"bg-blue-100",color:"text-blue-600"},image:{iconKey:"image",bgColor:"bg-purple-200",color:"text-purple-600"},code:{iconKey:"code",bgColor:"bg-cyan-200",color:"text-cyan-600"},person:{iconKey:"user",color:this.theme.fileSessionColor},permission:{iconKey:"layerGroup",color:this.theme.fileSessionColor},team:{iconKey:"users",color:this.theme.fileSessionColor},theme:{iconKey:"paintbrushPencil",color:this.theme.fileSessionColor}}[e];return t?{icon:t.iconKey,bgColor:t.bgColor||"",color:t.color||this.theme.fileSessionColor}:{icon:"comment",bgColor:"",color:this.theme.fileSessionColor}}async loadData(e=!1){try{const t=await this.callbacks.loadMore(this.currentPage,this.itemsPerPage,this.currentSortColumn,this.currentSortOrder,this.latestSearchTerm,this.currentFilter);Array.isArray(t)?(this.tableData=t,0===this.tableData.length&&this.showEmptyState()):this.tableData=[],e||this.updateContentView(),this.hasMoreData=t.length===this.itemsPerPage}catch(t){this.tableData=[],e||this.updateContentView(),this.showEmptyState()}}showEmptyState(e=null,t=null){if(this.currentFilter&&this.tableConfig.filters){const s=this.tableConfig.filters.find((e=>e.value===this.currentFilter));s&&(e=s.empty_message,t=s.empty_description)}this.selectedFolderId&&""===this.latestSearchTerm?(e="This folder is empty",t="Add items to this folder from your inbox by dragging and dropping."):this.selectedFolderId&&""!==this.latestSearchTerm?(e="No results in this folder",t="Try changing your search query or clearing the search to see more results."):""!==this.latestSearchTerm&&(e="No results found",t="Try changing your search query or clearing the search to see more results."),this.contentViewWrapper&&(this.contentViewWrapper.innerHTML="",this.contentViewWrapper.appendChild(this.createEmptyState(e,t)))}async loadMoreData(){if(this.isLoading||!this.hasMoreData)return;this.isLoading=!0;const e=this.createLoadingItems(this.currentView);let t;t="table"===this.currentView?this.contentViewWrapper.querySelector("tbody"):this.contentViewWrapper.querySelector(".grid"),e.forEach((e=>t.appendChild(e)));try{const e=await this.callbacks.loadMore(this.currentPage+1,this.itemsPerPage,this.currentSortColumn,this.currentSortOrder,this.latestSearchTerm,this.currentFilter);t.querySelectorAll(".loading-row, .loading-grid-item").forEach((e=>e.remove()));const s=Array.isArray(e)?e:e.tableData;if(s&&s.length>0){const i=new Set(this.tableData.map((e=>e.id))),n=s.filter((e=>!i.has(e.id)));n.length>0?(this.tableData=[...this.tableData,...n],e.currentPage?(this.currentPage=e.currentPage,this.hasMoreData=!e.endOfData):(this.currentPage++,this.hasMoreData=s.length===this.itemsPerPage),n.forEach((e=>{const s="table"===this.currentView?this.createTableRow(e):this.createGridCard(e);t.appendChild(s)})),this.updateSelectionUI()):this.hasMoreData=!1}else this.hasMoreData=!1}catch(e){this.hasMoreData=!1}finally{this.isLoading=!1}}onDataLoad(e){this.dataLoad=e}createLoadingItems(e,t=5){const s=[];for(let i=0;i<t;i++)"table"===e?s.push(this.createLoadingTableRow()):s.push(this.createLoadingGridItem());return s}createLoadingTableRow(){const e=document.createElement("tr");return e.classList="loading-row",this.tableConfig.tableColumns.forEach((t=>{const s=document.createElement("td");s.classList="py-2 px-2";const n=document.createElement("div");n.classList=`h-4 ${i.A.theme.loadBackground} rounded animate-pulse`,s.appendChild(n),e.appendChild(s)})),e}createLoadingGridItem(){const e=document.createElement("div");e.classList=`loading-grid-item animate-pulse ${i.A.theme.background} p-4 rounded-md shadow-sm border h-[160px] relative`;const t=document.createElement("div");t.classList="flex items-center mb-2";const s=document.createElement("div");s.classList=`w-10 h-10 ${i.A.theme.loadBackground} rounded-full mr-2 flex-shrink-0`,t.appendChild(s);const n=document.createElement("div");n.classList=`h-4 ${i.A.theme.loadBackground} rounded w-1/2 flex-grow`,t.appendChild(n),e.appendChild(t);const a=document.createElement("div");a.classList=`h-4 ${i.A.theme.loadBackground} rounded w-3/4 mt-2`,e.appendChild(a);const o=document.createElement("div");return o.classList=`h-4 ${i.A.theme.loadBackground} rounded w-1/4 mt-2`,e.appendChild(o),e}createLoadingState(e="table"){const t=document.createElement("div");return t.classList="animate-pulse","table"===e?t.appendChild(this.createLoadingTable()):t.appendChild(this.createLoadingGrid()),t}createLoadingTable(){const e=document.createElement("div");e.classList="relative w-full overflow-x-auto pt-6";const t=document.createElement("table");t.classList="w-full table-fixed";const s=document.createElement("thead");s.classList="sticky top-0 z-30";const n=document.createElement("tr");for(let e=0;e<6;e++){const e=document.createElement("th");e.classList="pb-2 px-2 text-left";const t=document.createElement("div");t.classList=`h-6 ${i.A.theme.loadBackground} rounded animate-pulse-effect`,e.appendChild(t),n.appendChild(e)}s.appendChild(n),t.appendChild(s);const a=document.createElement("tbody");for(let e=0;e<10;e++){const e=document.createElement("tr");for(let t=0;t<6;t++){const t=document.createElement("td");t.classList="py-2 px-2";const s=document.createElement("div");s.classList=`h-4 ${i.A.theme.loadBackground} rounded animate-pulse-effect`,t.appendChild(s),e.appendChild(t)}a.appendChild(e)}return t.appendChild(a),e.appendChild(t),e}createLoadingGrid(){const e=document.createElement("div");e.classList="overflow-y-auto flex-grow h-[calc(var(--vh)*100-70px)]";const t=document.createElement("div");t.classList="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-2 px-2 pb-2 pt-4";for(let e=0;e<8;e++){const e=document.createElement("div");e.classList="bg-white p-4 rounded-md shadow-sm border h-[160px] relative";const s=document.createElement("div");s.classList="flex items-center mb-2";const n=document.createElement("div");n.classList=`w-10 h-10 ${i.A.theme.loadBackground} rounded-full mr-2 flex-shrink-0`,s.appendChild(n);const a=document.createElement("div");a.classList="h-4 rounded w-1/2 flex-grow",s.appendChild(a),e.appendChild(s);const o=document.createElement("div");o.classList=`h-4 ${i.A.theme.loadBackground} rounded w-3/4 mt-2`,e.appendChild(o);const r=document.createElement("div");r.classList=`h-4 ${i.A.theme.loadBackground} rounded w-1/4 mt-2`,e.appendChild(r);const l=document.createElement("div");l.classList=`w-6 h-6 ${i.A.theme.loadBackground} rounded-full absolute top-2 right-2`,e.appendChild(l),t.appendChild(e)}return e.appendChild(t),e}static renderLoadingState(e,t,s="table",n=!1){e.innerHTML="";const a=document.createElement("div");a.classList="";const o=document.createElement("div");o.classList="flex flex-col w-full leading-7 py-2 sm:max-w-full md:max-w-full lg:max-w-full xl:max-w-full 2xl:max-w-full justify-center items-center px-2 sm:px-4 lg:pl-5 lg:mt-6 mt-16";const r=document.createElement("div");if(r.classList="flex gap-5 w-full",!n){const e=document.createElement("div");e.classList="w-[120px] flex-shrink-0 hidden sm:block";for(let t=0;t<5;t++){const t=document.createElement("div");t.classList=`h-4 ${i.A.theme.loadBackground}  rounded mb-2`,e.appendChild(t)}r.appendChild(e)}const l=document.createElement("div");l.classList="flex flex-col overflow-x-hidden flex-grow";const c=document.createElement("div");c.classList="flex justify-between items-center mx-2";const d=document.createElement("div");d.classList=`w-32 h-8 ${i.A.theme.loadBackground} rounded`,c.appendChild(d);const h=document.createElement("div");h.classList=`w-24 h-8 ${i.A.theme.loadBackground} rounded`,c.appendChild(h),l.appendChild(c),"table"===s?l.appendChild(this.createLoadingTable(t)):l.appendChild(this.createLoadingGrid()),r.appendChild(l),o.appendChild(r),a.appendChild(o),e.appendChild(a)}static createLoadingTable(e){const t=document.createElement("div");t.classList="relative w-full overflow-x-auto";const s=document.createElement("div");s.classList="table-container w-full pt-4 flex flex-col h-[calc(var(--vh)*100-72px)] overflow-x-auto";const n=document.createElement("table");n.classList="w-full table-fixed";const a=document.createElement("thead");a.classList="sticky top-0 z-30";const o=document.createElement("tr");e.tableColumns.forEach((e=>{const t=document.createElement("th");t.classList="pb-2 px-2 text-left";const s=document.createElement("div");s.classList=`h-6 ${i.A.theme.loadBackground} rounded`,t.appendChild(s),o.appendChild(t)})),a.appendChild(o),n.appendChild(a);const r=document.createElement("tbody");for(let t=0;t<10;t++){const t=document.createElement("tr");e.tableColumns.forEach((e=>{const s=document.createElement("td");if(s.classList="py-2 px-2","name"===e.value){const e=document.createElement("div");e.classList="flex items-center";const t=document.createElement("div");t.classList=`w-8 h-8 ${i.A.theme.loadBackground} rounded-full mr-2 flex-shrink-0`,e.appendChild(t);const n=document.createElement("div");n.classList=`h-4 ${i.A.theme.loadBackground} rounded w-3/4 flex-grow`,e.appendChild(n),s.appendChild(e)}else if("actions"===e.value){const e=document.createElement("div");e.classList=`w-6 h-6 ${i.A.theme.loadBackground} rounded-full mx-auto`,s.appendChild(e)}else{const e=document.createElement("div");e.classList=`h-4 ${i.A.theme.loadBackground} rounded`,s.appendChild(e)}t.appendChild(s)})),r.appendChild(t)}return n.appendChild(r),s.appendChild(n),t.appendChild(s),t}static createLoadingGrid(){const e=document.createElement("div");e.classList="overflow-y-auto flex-grow h-[calc(var(--vh)*100-70px)]";const t=document.createElement("div");t.classList="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-2 lg:grid-cols-2 xl:grid-cols-3 gap-2 px-2 pb-2 pt-4";for(let e=0;e<8;e++){const e=document.createElement("div");e.classList=`${i.A.theme.background} p-4 rounded-md shadow-sm border h-[160px] relative`;const s=document.createElement("div");s.classList="flex items-center mb-2";const n=document.createElement("div");n.classList=`w-10 h-10 ${i.A.theme.loadBackground} rounded-full mr-2 flex-shrink-0`,s.appendChild(n);const a=document.createElement("div");a.classList=`h-4 ${i.A.theme.loadBackground} rounded w-1/2 flex-grow`,s.appendChild(a),e.appendChild(s);const o=document.createElement("div");o.classList=`h-4 ${i.A.theme.loadBackground} rounded w-3/4 mt-2`,e.appendChild(o);const r=document.createElement("div");r.classList=`h-4 ${i.A.theme.loadBackground} rounded w-1/4 mt-2`,e.appendChild(r),t.appendChild(e)}return e.appendChild(t),e}removeRecord(e){const t=this.tableData.findIndex((t=>t.id===e));if(t>-1){this.tableData.splice(t,1);const s=document.getElementById(`record-id-${e}`);s&&s.remove()}0===this.tableData.length&&this.showEmptyState()}addRecord(e){if(this.tableData.push(e),"table"===this.currentView){const t=this.contentViewWrapper.querySelector("tbody"),s=this.createTableRow(e);t.appendChild(s)}else{const t=this.contentViewWrapper.querySelector(".grid"),s=this.createGridCard(e);t.appendChild(s)}this.updateContentView(this.tableData)}refreshSort(){this.handleSort(this.currentSortColumn)}createRecordElement(e){return"table"===this.currentView?this.createTableRow(e):this.createGridCard(e)}createTableRow(e){const t=document.createElement("tr");if(t.id=`record-id-${e.id}`,t.classList=`border-t ${this.theme.tableDividerLine} ${this.theme.tableHoverBackground} transition duration-200 ease-in-out`,this.tableConfig.enableFolders&&!this.isManageMode&&(t.draggable=!0,t.addEventListener("dragstart",(t=>this.handleFolderDragStart(t,e))),t.addEventListener("dragend",(t=>this.handleFolderDragEnd(t,e)))),this.isManageMode){const s=document.createElement("td");s.classList="py-2 px-2 sticky left-0 z-20",s.style.width="25px",s.style.minWidth="25px",s.style.maxWidth="25px";const i=document.createElement("input");i.type="checkbox",i.classList="form-checkbox h-4 w-4 text-blue-600",i.dataset.recordId=e.id,i.checked=this.selectedRecords.has(e.id),i.addEventListener("change",(t=>this.handleCheckboxChange(t,e.id))),s.appendChild(i),t.appendChild(s)}return this.tableConfig.tableColumns.forEach((s=>{const i=document.createElement("td");i.classList="py-2 px-2 cursor-pointer","actions"===s.value?(i.classList+=" sticky right-0 z-20",i.style.cssText+="\n                    width: 40px !important;\n                    min-width: 40px !important;\n                    max-width: 40px !important;\n                    flex: 0 0 40px !important;\n                "):s.savedWidth?(i.style.width=`${s.savedWidth}px`,i.style.minWidth=`${this.MIN_COLUMN_WIDTH}px`):(i.style.width=`${this.MIN_COLUMN_WIDTH}px`,i.style.minWidth=`${this.MIN_COLUMN_WIDTH}px`);const n=document.createElement("div");if(n.classList="actions"!==s.value?"overflow-hidden text-ellipsis whitespace-nowrap":"flex items-center justify-center","actions"===s.value){const t=document.createElement("button");t.classList=`${this.theme.menuIconColor} ${this.theme.menuIconHoverColor} rounded-md w-[28px] h-[28px] mx-4 sm:mx-6 py-1.5 px-2 flex items-center justify-center`,t.style.backgroundColor=this.theme.backgroundHEX,t.dataset.recordId=e.id;const s=o.A.name("ellipsis"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"h-6 w-6"});t.appendChild(i.element),t.onclick=t=>this.showOptionsMenu(t,e),n.appendChild(t)}else if("name"===s.value){const t=document.createElement("div");t.classList="flex items-center";const i=document.createElement("div");if(i.classList="flex flex-shrink-0 items-center justify-center mr-2 w-8 h-8",e.img){i.classList.add("p-1");const t=document.createElement("img");t.src=e.img;const s=e.img_style||"rounded-full";t.classList=`${s} w-full h-full object-cover`,t.draggable=!1,i.appendChild(t)}else{let t,s=this.theme.iconColor,n="",a="rounded-md";if(i.classList.add("p-2"),e.icon){t={"fa-youtube":"youtube"}[e.icon]||e.icon,s=e.icon_brand||this.theme.fileSessionColor||this.theme.iconColor,n=this.theme.fileSessionColor}else{const i=this.getIconAndColorByType(e.type);t=i.icon,s=i.color||this.theme.iconColor,n=i.bgColor||"","person"===e.type&&(a="rounded-full")}n&&"string"==typeof n&&n.split(" ").forEach((e=>{e.trim()&&i.classList.add(e.trim())})),i.classList.add(a);const l=o.A.name(t),c=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:"w-4 h-4",colorClass:s});i.appendChild(c.element)}t.appendChild(i);const a=document.createElement("span");a.classList=`${this.theme.tablePrimaryColumnText} overflow-hidden text-ellipsis whitespace-nowrap flex-grow`,a.textContent=e[s.value],t.appendChild(a),n.appendChild(t),n.onclick=()=>this.handleClick(e.id)}else if("circle-overlap"===s.type)n.appendChild(this.createCircleOverlap(e[s.value]));else if(e[s.value]&&"object"==typeof e[s.value]&&"date"===e[s.value].type){const t=document.createElement("span");t.classList=`${this.theme.text}`,t.textContent=e[s.value].simple_date,t.dataset.date=e[s.value].date,n.appendChild(t)}else{const t=document.createElement("span");t.classList=`${this.theme.text}`,t.textContent=e[s.value],n.appendChild(t)}i.appendChild(n),t.appendChild(i)})),t}createCircleOverlap(e){const t=document.createElement("div");if(t.classList="flex -space-x-1.5 overflow-hidden",e.payload.slice(0,3).forEach(((e,s)=>{const i=document.createElement("img");i.classList="inline-block h-6 w-6 rounded-full",i.style.zIndex=3-s,i.src=e.img_url||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png",i.alt=e.name,i.title=e.name,t.appendChild(i)})),e.total>3){const s=document.createElement("span");s.classList=`inline-flex items-center justify-center h-6 w-6 rounded-full text-xs font-medium ${this.theme.secondaryButtonTransparent}`,s.textContent="+"+(e.total-3),s.style.zIndex=0,t.appendChild(s)}return t}createGridCard(e){const t=document.createElement("div");t.id=`record-id-${e.id}`,t.classList=`${this.theme.tableCardBackground} ${this.theme.tableCardBorder} p-4 rounded-md shadow-sm border h-[160px] relative cursor-pointer transition duration-200 ease-in-out`,this.tableConfig.enableFolders&&!this.isManageMode&&(t.draggable=!0,t.addEventListener("dragstart",(t=>this.handleFolderDragStart(t,e)))),t.addEventListener("click",(t=>{t.target.closest(".ellipsis-button-wrapper")||this.handleClick(e.id)}));const s=document.createElement("div");s.classList="flex items-center mb-2 flex-grow";const i=document.createElement("div");if(i.classList="rounded-md mr-2 flex items-center justify-center flex-shrink-0","assistant"===e.type&&e.img){i.classList.remove("rounded-md"),i.classList.add("p-0");const t=document.createElement("img");t.src=e.img,t.classList="rounded-full w-12 h-12 object-cover",i.appendChild(t)}else{const t=this.getIconAndColorByType(e.type),s=["p-2","w-8","h-8"];i.classList.add(...s),t.bgColor&&"string"==typeof t.bgColor&&t.bgColor.split(" ").forEach((e=>{e.trim()&&i.classList.add(e.trim())}));const n=o.A.name(t.icon),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:t.color});i.appendChild(a.element)}s.appendChild(i);const n=document.createElement("div");n.classList="font-bold",n.textContent=e.name,s.appendChild(n),t.appendChild(s);const a=document.createElement("div");if(a.classList="space-y-1","agent"===e.type&&e.tile_description){const t=document.createElement("div");t.classList=`text-sm ${this.theme.fadedText} line-clamp-2 leading-5`,t.textContent=e.tile_description,a.appendChild(t)}const l=document.createElement("div");l.classList=`${this.theme.fadedText} text-sm`,e.modified&&"object"==typeof e.modified&&"date"===e.modified.type?(l.textContent=`Last used ${e.modified.simple_date}`,l.dataset.date=e.modified.date):l.textContent=`Last used ${e.modified}`,a.appendChild(l),t.appendChild(a);const c=document.createElement("div");c.classList="ellipsis-button-wrapper absolute top-3 right-2 w-6 h-6 flex items-center justify-end rounded";const d=document.createElement("button");d.classList=`${this.theme.iconColor} ${this.theme.menuIconHoverColor} rounded-md h-6 w-6 flex items-center justify-center`,d.dataset.recordId=e.id;const h=o.A.name("ellipsisVertical"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-4 h-4"});return d.appendChild(m.element),d.onclick=t=>{t.stopPropagation(),this.showOptionsMenu(t,e)},c.appendChild(d),t.appendChild(c),t}async updateRecord(e){const t=this.tableData.findIndex((t=>t.id===e.id));if(t>-1){e.actions=this.updateRecordActions(e),this.tableData[t]=e;const s=document.getElementById(`record-id-${e.id}`);if(s){const t=this.createRecordElement(e);s.replaceWith(t)}}if(await this.loadData(!0),!this.tableData.find((t=>t.id===e.id))){const t=document.getElementById(`record-id-${e.id}`);t&&t.remove()}0===this.tableData.length&&this.updateContentView()}updateRecordActions(e){const t=[...e.actions];if(this.tableConfig.enableFolders){const e=t.findIndex((e=>"remove_from_folder"===e.value));if(-1!==e)t[e]={label:"Add to folder",value:"add_to_folder",icon:"folder-plus"};else{-1===t.findIndex((e=>"add_to_folder"===e.value))&&t.push({label:"Add to folder",value:"add_to_folder",icon:"folder-plus"})}}return t}createEmptyState(e,t){null===e&&(e="No results found",t="Try adjusting your search or filter criteria.");const s=document.createElement("div");s.classList="flex flex-col items-center justify-center h-[calc(var(--vh)*100-200px)]";const i=o.A.name("search"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-16 h-16",colorClass:"text-gray-300",additionalClasses:"mb-4"});s.appendChild(n.element);const a=document.createElement("p");a.classList="text-center justify-center leading-5 text-xl font-semibold text-gray-500 mb-2",a.textContent=e;const l=document.createElement("p");return l.classList="text-center justify-center leading-5 text-sm text-gray-400",l.textContent=t,s.appendChild(a),s.appendChild(l),s}handleMassOperation(){"table"!==this.currentView&&this.switchView("table"),this.tableConfig.enableFolders&&this.folderSelector.exitEditMode(),this.isManageMode=!this.isManageMode,this.isManageMode||this.selectedRecords.clear(),this.updateHeaderForMassOperation(),this.updateContentView()}async handleSelectAll(e){const t=e.target.checked;e.target.indeterminate=!1,t||this.selectedRecords.clear();if(this.contentViewWrapper.querySelectorAll('td input[type="checkbox"]').forEach((e=>{e.checked=t;const s=e.dataset.recordId;t&&this.selectedRecords.add(s)})),this.updateSelectionUI(),this.updateMassOperationButtonStates(),t)try{(await this.callbacks.getAllMatchingRecordIds(this.currentSortColumn,this.currentSortOrder,this.latestSearchTerm,this.currentFilter,this.selectedFolderId)).forEach((e=>this.selectedRecords.add(e))),this.updateSelectionUI()}catch(e){}}handleCheckboxChange(e,t){e.target.checked?this.selectedRecords.add(t):this.selectedRecords.delete(t),this.updateMassOperationButtonStates(),this.updateSelectionUI()}updateSelectionUI(){const e=this.contentViewWrapper.querySelector('th input[type="checkbox"]'),t=this.contentViewWrapper.querySelectorAll('td input[type="checkbox"]');if(t.forEach((e=>{e.checked=this.selectedRecords.has(e.dataset.recordId)})),e){const s=Array.from(t).map((e=>e.dataset.recordId)),i=s.every((e=>this.selectedRecords.has(e))),n=s.some((e=>this.selectedRecords.has(e))),a=this.selectedRecords.size>s.length;e.checked=i||a,e.indeterminate=n&&!i||a}this.updateSelectionCountDisplay(),this.updateMassOperationButtonStates()}exitManageMode(){this.isManageMode=!1,this.selectedRecords.clear(),this.updateHeaderForMassOperation(),this.updateContentView()}updateHeaderForMassOperation(){const e=this.primaryContent.querySelector(".table-action-buttons");if(e)if(e.innerHTML="",this.isManageMode){const t=this.createMassOperationMenu();e.appendChild(t),this.updateMassOperationButtonStates()}else this.renderHeaderButtons(e)}createMassOperationMenu(){const e=document.createDocumentFragment();this.massOperationButtons=[];const t=document.createElement("div");t.classList=`${this.theme.text} text-sm mr-2 flex items-center selection-count hidden lg:block`,this.updateSelectionCountDisplay(t),e.appendChild(t);const s=[];if(this.tableConfig.enableFolders){if("all"===this.currentFilter||this.selectedFolderId){const e=o.A.name("minus");s.push({text:"Remove",svgPathData:e.path,svgViewBox:e.viewBox,action:()=>this.removeFromFolder()})}const e=o.A.name("plus");s.push({text:"Add to folder",svgPathData:e.path,svgViewBox:e.viewBox,action:()=>this.addToFolder()})}const i=o.A.name("trash");s.push({text:"Delete",svgPathData:i.path,svgViewBox:i.viewBox,action:()=>this.deleteSelected()}),s.forEach((t=>{const s=new n.$({type:"secondary",text:t.text,svgPathData:t.svgPathData,svgViewBox:t.svgViewBox,size:"extraSmall",truncateMobile:!0});s.render(e),s.onClick(t.action),s.disableButton(),this.massOperationButtons.push(s)}));const a=new n.$({type:"primary",text:"Cancel",size:"extraSmall"});return a.render(e),a.onClick((()=>this.handleMassOperation())),e}updateSelectionCountDisplay(e=null){const t=`${this.selectedRecords.size||0} selected`;if(e)e.textContent=t,e.classList.add("truncate","line-clamp-1");else{const e=this.primaryContent.querySelector(".selection-count");e&&(e.textContent=t)}}updateMassOperationButtonStates(){if(!this.isManageMode||!this.massOperationButtons||0===this.massOperationButtons.length)return;const e=this.selectedRecords.size>0;this.massOperationButtons.forEach((t=>{e?t.enableButton():t.disableButton()}))}renderHeaderButtons(e){if(this.tableConfig.enableManage){const t=new n.$({type:"secondary",text:"Manage",size:"extraSmall"});t.render(e),t.onClick((()=>{this.handleMassOperation()}))}if(this.tableConfig.enableCreate){const t=o.A.name("plus"),s=new n.$({type:"primary",svgPathData:t.path,svgViewBox:t.viewBox,text:this.tableConfig.createButtonText||"Create",size:"extraSmall"});s.render(e),s.onClick((()=>{this.handleCreateClick()}))}}async deleteSelected(){if(0===this.selectedRecords.size)return;const e=Array.from(this.selectedRecords);if(this.callbacks.onMassDelete)try{await this.callbacks.onMassDelete(e)}catch(e){new c.y("Error deleting records","error")}}handleAssistantChange(e){this.exitManageMode(),this.currentFilter=null,this.selectedFolderId=null,this.selectedAssistantId=e,this.render(),this.currentPage=1,this.hasMoreData=!0,"table"===this.currentView?this.showTableRecordsLoadingState():this.showGridRecordsLoadingState(),this.callbacks.onAssistantChange&&this.callbacks.onAssistantChange(e)}}class Te{constructor(e=null){this.container=e,this.tableIndex=null,this.tableConfig=null,this.tableData=null,this.currentColumnOrder=null,this.endOfData=!1,this.currentSearchTerm="",this.PAGESIZE=50,this.initialLoadDone=!1,this.currentFolderId=null,this.currentAssistantId=null}async quickRender(e=null){if(e&&(this.container=e),!this.container||!this.tableIndex)return void await this.init(e);this.container.innerHTML="";const t=this.tableIndex.render();this.container.appendChild(t),this.refreshTableData(),this.tableIndex.exitManageMode()}async init(e=null){e&&(this.container=e);try{this.initialLoadDone?await this.refreshTableData():(this.showLoadingState(),await this.getChatData(),this.render(),this.initialLoadDone=!0)}catch(e){this.showErrorMessage("Failed to load chat history. Please try again later.")}}showLoadingState(){this.container&&(this.container.innerHTML="",Se.renderLoadingState(this.container,this.tableConfig||{tableColumns:[{value:"name",name:"Name"},{value:"last_updated_at",name:"Last Updated"},{value:"timestamp",name:"Created"},{value:"assistants",name:"Assistants"},{value:"models",name:"Models"}]},"table"))}async getChatData(e=1,t=this.PAGESIZE,s=null,i=null,n="",a="inbox",o=null,r=null){try{const l="/chat/chats/",c={page:e,itemsPerPage:t,sortColumn:s||this.currentSortColumn,sortOrder:i||this.currentSortOrder,search:n,filter:a,folderId:o,assistantId:r},d=await g.G.postData(l,c);return d.tableConfig&&(this.tableConfig=d.tableConfig),this.tableData=d.tableData,this.currentPage=d.currentPage,this.totalPages=d.totalPages,this.endOfData=d.endOfData||this.currentPage>=this.totalPages,this.tableData}catch(e){throw new c.y("Failed to load chat history. Please try again later.","error"),e}}async loadMore(e,t,s,i,n="",a="all",o=null,r=null){const l=this.tableIndex.getCurrentTableState();return await this.getChatData(e,t,s,i,n,l.filter,this.currentFolderId,this.currentAssistantId)}render(){this.container&&(this.container.innerHTML="",this.tableConfig&&this.tableData?this.tableIndex?this.updateContentView(this.tableData):(this.tableIndex=new Se(this.tableConfig,this.tableData,this.container),this.tableIndex.setCallbacks({onAction:this.onAction.bind(this),loadMore:this.loadMore.bind(this),onResizeCols:this.onResize.bind(this),onRowClick:this.onRecordClick.bind(this),onCreate:this.onCreate.bind(this),getCreatePayload:this.getCreatePayload.bind(this),onSort:this.onSort.bind(this),onColumnOrderChange:this.onColumnOrderChange.bind(this),onResetPagination:this.resetPagination.bind(this),onFilterChange:this.onFilterChange.bind(this),onAssistantChange:this.onAssistantChange.bind(this),getAllMatchingRecordIds:this.getAllMatchingRecordIds.bind(this),onMassDelete:this.onMassDelete.bind(this),onFolderCreate:this.onFolderCreate.bind(this),onFolderRename:this.handleFolderRename.bind(this),onFolderDelete:this.handleFolderDelete.bind(this),onFolderPositionChange:this.handleFolderPositionChange.bind(this),onMoveToFolder:this.handleMoveToFolder.bind(this),onFolderChange:this.onFolderChange.bind(this),onRemoveFromFolders:this.removeFromFolders.bind(this),onTableStateChange:this.saveWidthOrderAndSort.bind(this)}),this.container.appendChild(this.tableIndex.render())):this.tableConfig&&this.tableData?this.showErrorMessage("No data available to display."):this.showLoadingState())}getCreatePayload(){return{assistantId:this.currentAssistantId}}onCreate(e){const t=e?e.assistantId:null;t?ke.createNewChatWithAssistant(t):ke.createNewChat()}updateContentView(e){this.tableIndex?(this.tableIndex.tableData=e,this.tableIndex.updateContentView(e)):this.render()}onAction(e,t){switch(e){case"delete":this.deleteChat(t);break;case"toggle_pin":this.togglePin(t);break;case"share":this.shareChat(t);break;case"rename":this.renameChat(t);break;case"add_to_folder":this.addSingleChatToFolder(t);break;case"remove_from_folder":this.removeFromFolders(t)}}onRecordClick(e){const t=this.tableIndex.tableData.find((t=>t.id===e));if(!t)return void new c.y("Chat not found. Please try again.","error");const s=t.name||"New session";let i=null,n=null;if(t.assistants&&t.assistants.payload&&t.assistants.payload.length>0){const e=t.assistants.payload[0];i=e.img_url,n=e.name}!i&&n&&"simtheory"===n.toLowerCase()&&(i="https://res.cloudinary.com/dimqqmfx6/image/upload/w_64,h_64,c_fit/v1738751469/assets/simtchat_ef7pyv.png"),ke.openChatFromHistory(e,{name:s,assistantImage:i})}async togglePin(e){try{if(await g.G.postData("/chat/toggle-pin/",{uuid:e.id})){for(let t of e.actions)"toggle_pin"===t.value&&(t.label=e.pinned?"Pin":"Remove pin");this.tableIndex.updateRecord({...e,pinned:!e.pinned}),new c.y((e.pinned?"Unpinned":"Pinned")+" session successfully","success")}}catch(e){new c.y("Failed to update favorite status","error")}}shareChat(e){new c.y("Sharing feature not implemented yet","info")}onResize(e){}async saveWidthOrderAndSort(e){try{const t="/chat/save-chat-table-preferences/",s={column_widths:e.columnWidths,column_order:e.columnOrder,sort_column:e.sortColumn,sort_order:e.sortOrder,view:e.view,filter:e.filter};await g.G.postData(t,s)}catch(e){new c.y("Failed to save table preferences. Please try again.","error")}}deleteChat(e){new a("Are you sure?",`This will delete "${e.name}" permanently.`).onConfirm((async()=>{try{await g.G.postData("/chat/delete/",{uuid:e.id}),this.tableIndex.removeRecord(e.id)}catch(e){new c.y("Failed to delete chat","error")}}))}resetPagination(){this.currentPage=1,this.endOfData=!1}async updateTableData(){this.resetPagination(),await this.getChatData(1,this.PAGESIZE,this.tableIndex.currentSortColumn,this.tableIndex.currentSortOrder,this.tableIndex.filter,this.currentFolderId)}showErrorMessage(e){new c.y(e,"error")}onColumnOrderChange(e){this.currentColumnOrder=e}onSort(e){}async onFilterChange(e){this.currentFilter=e,this.currentFolderId=null,this.currentAssistantId=null;const t=this.tableIndex.getCurrentTableState();this.resetPagination(),await this.getChatData(1,this.PAGESIZE,t.sortColumn,t.sortOrder,t.search,t.filter,null,null),this.tableIndex.updateContentView(this.tableData)}async getAllMatchingRecordIds(e,t,s,i,n){try{const a="/chat/get-all-matching-chat-ids/",o={sortColumn:e,sortOrder:t,search:s,filter:i,folderId:n,assistantId:this.currentAssistantId};return(await g.G.postData(a,o)).chatIds}catch(e){return new c.y("Failed to fetch all matching chats. Please try again.","error"),[]}}async onMassDelete(e){try{new a("Delete multiple chats?",`This will delete ${e.length} chats permanently.`).onConfirm((async()=>{await g.G.postData("/chat/mass-delete/",{uuids:e});new c.y(`Successfully deleted ${e.length} chats`,"success"),e.forEach((e=>this.tableIndex.removeRecord(e))),this.tableIndex.exitManageMode()}))}catch(e){}}async onFolderCreate(e){try{const t=await g.G.postData("/chat/create-chat-folder/",e);if(t&&t.folder&&t.folder.id)return t.folder;throw new Error("Invalid response from server: Missing folder data or folder ID")}catch(e){throw new c.y("Failed to create folder. Please try again.","error"),e}}async handleFolderRename(e){try{await g.G.postData("/chat/rename-folder/",e)}catch(e){new c.y("Failed to update folder. Please try again.","error")}}async handleFolderDelete(e){try{const t=await g.G.postData("/chat/delete-folder/",{id:e});if(!t||!t.success)throw new Error("Failed to delete folder");this.tableConfig.folders=this.tableConfig.folders.filter((t=>t.id!==e))}catch(e){new c.y("Failed to delete folder. Please try again.","error")}}async handleFolderPositionChange(e){try{const t=await g.G.postData("/chat/move-folder/",e);if(!t||!t.success)throw new Error("Failed to move folder");this.tableConfig.folders=t.folders}catch(e){}}async handleMoveToFolder(e,t){try{const s=Array.isArray(e)?e:[e],i=(e,t)=>{for(let s of e){if(s.id===t)return s;if(s.subfolders){const e=i(s.subfolders,t);if(e)return e}}return null},n=i(this.tableIndex.tableConfig.folders,t);if(!n)throw new Error("Folder not found");1===s.length?("all"===this.tableIndex.currentFilter||this.showAddedToFolderMessage)&&new c.y(`Added session to ${n.name}`,"success"):new c.y(`Added ${s.length} sessions to ${n.name}`,"success");const a={chat_ids:s,folder_id:t};await g.G.postData("/chat/add-chats-to-folder/",a);await this.refreshTableData()}catch(e){new c.y("Failed to move chats to folder. Please try again.","error")}this.showAddedToFolderMessage=!1}async onFolderChange(e){this.currentFolderId=e,this.currentFilter=null,this.currentAssistantId=null;const t=this.tableIndex.getCurrentTableState();this.resetPagination(),await this.getChatData(1,this.PAGESIZE,t.sortColumn,t.sortOrder,t.search,t.filter,e,null),this.tableIndex.updateContentView(this.tableData)}async onAssistantChange(e){this.currentAssistantId=e,this.currentFolderId=null,this.currentFilter=null;const t=this.tableIndex.getCurrentTableState();this.resetPagination(),await this.getChatData(1,this.PAGESIZE,t.sortColumn,t.sortOrder,t.search,null,null,e),this.tableIndex.updateContentView(this.tableData)}async refreshFolderStructure(){try{const e=await g.G.fetchData("/chat/get-folder-structure/");e&&e.folders&&(this.tableConfig.folders=e.folders,this.tableIndex&&this.tableIndex.updateFolderStructure(e.folders))}catch(e){new c.y("Failed to refresh folder structure. Please try again.","error")}}async refreshTableData(){this.resetPagination();const e=this.tableIndex.getCurrentTableState();await this.getChatData(1,this.PAGESIZE,e.sortColumn,e.sortOrder,e.search,e.filter,this.currentFolderId,this.currentAssistantId),this.tableIndex.updateContentView(this.tableData)}async renameChat(e){this.tableIndex.exitManageMode();const t=document.createElement("div");t.classList="max-h-full py-2";const s=new d({id:"rename-input",label:"",value:e.name,placeholder:"Enter new name",required:!0,maxLength:100});s.render(t);const i=new l({size:"small",title:"Rename session",body:t,closeX:!1,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",buttonWidth:"full",buttonStyleConfirm:"primary",buttonStyleCancel:"secondary",buttonSize:"large"});s.focus(),s.selectAll(),s.onChange((e=>{e.length>0?i.enableConfirmButton():i.disableConfirmButton()})),i.onConfirm((async()=>{0!==s.value.length&&this.updateSessionName(s.value,e)}))}async updateSessionName(e,t){try{const s={chatId:t.id,newName:e};await g.G.postData("/chat/rename_chat/",s),this.tableIndex.updateRecord({...t,name:e})}catch(e){new c.y("There was a problem renaming the session, check your internet.","error")}}addSingleChatToFolder(e){this.tableIndex.selectedRecords.add(e.id),this.tableIndex.showFolderSelectionDialog(),this.showAddedToFolderMessage=!0}async removeFromFolders(e){let t=[];const s=Array.isArray(e)?e:[e];for(let e of s)e.id?t.push(e.id):t.push(e);try{const e={chat_ids:t};if(await g.G.postData("/chat/remove-chats-from-folders/",e)){if(this.tableIndex.getCurrentTableState().folderId)t.forEach((e=>{this.tableIndex.removeRecord(e)}));else for(let e of t){const t={...this.tableIndex.tableData.find((t=>t.id===e)),folders:[]};this.tableIndex.updateRecord(t);const s=this.tableIndex.tableData.find((t=>t.id===e.id));s&&("remove_from_folder"===s.action.value?(s.action.label="Add to folder",s.action.value="add_to_folder"):"add_to_folder"===s.action.value&&(s.action.label="Remove from folder",s.action.value="remove_from_folder"))}this.tableIndex.exitManageMode(),new c.y("Successfully removed from folder","success")}}catch(e){new c.y("Failed to remove from folders. Please try again.","error")}}}class Le{constructor(e){this.theme=i.A.theme,this.config={title:e.title||"Untitled",objectType:e.objectType||"object",objectId:e.objectId,owner:e.owner||null,userAndTeamSharingPermission:e.userAndTeamSharingPermission||!1,generalAccess:e.generalAccess||{workspace:{enabled:!1,label:"Workspace",description:"Everyone in your workspace can access"},public:{enabled:!1,label:"Public",description:"Anyone with the link can access"}},permissions:e.permissions||[]},this.GENERAL_ACCESS_OPTIONS={restricted:{icon:"lock",label:"Restricted",description:"Only people with access can use this assistant"},workspace:{icon:"buildings",label:"Workspace",description:"Everyone in your workspace can access"},public:{icon:"globe",label:"Anyone with a link",description:`Anyone can view and use this ${this.config.objectType}`},public_share:{icon:"shareAlt",label:"Open source to anyone with a link",description:"Anyone can view, use, and create their own copy"}},this.shares=new Map,this.modal=null,this.shareUrl=null,this.modalInternal=null,this.loadingPlaceholder=null,this.shareContent=null,this.init()}async init(){this.modalInternal=document.createElement("div"),this.loadingPlaceholder=document.createElement("div"),this.loadingPlaceholder.appendChild(this.createLoadingContent()),this.loadingPlaceholder.classList.add("hidden"),this.shareContent=document.createElement("div"),this.shareContent.classList="pt-4",this.modalInternal.appendChild(this.shareContent),this.modalInternal.appendChild(this.loadingPlaceholder),this.personalWorkspace="Personal"===y.a._workspace.name,this.modal=new l({size:"medium",closeX:!0,confirm:!1,conformOnClose:!0,cancel:!1,title:`Share '${this.config.title}'`,body:this.modalInternal}),this.render()}async render(){this.modal.confirmOnExit=!1,this.modal.unSavedChanges=!1,this.shareContent.innerHTML="",this.sharePermissionMode=!1,this.userOrTeamPermissionDropDown=null,this.topShareContent=null,this.generalAccessContent=null,this.currentPermissions=null,this.toggleLoading(!0,"Loading sharing settings...");try{if(this.mainContent=document.createElement("div"),this.currentPermissions=await u.K.getObjectPermissions(this.config.objectType,this.config.objectId),this.currentGeneralAccess=this.currentPermissions?.currentAccess||"restricted",this.config.userAndTeamSharingPermission){let e=null;this.personalWorkspace||(e=await y.a.getShareableUsersAndTeams(this.config.objectType,this.config.objectId),this.shareList=[...e.users,...e.teams],this.usersOnTeam=new x({placeholder:"Add people or teams",label:"",required:!0,items:this.shareList,autoBlur:!0})),this.topShareContent=document.createElement("div"),this.topShareContent.classList="flex gap-2",this.personalWorkspace||this.usersOnTeam.render(this.topShareContent),this.shareContent.appendChild(this.topShareContent),this.mainContent.appendChild(this.renderAccessPermissions())}if(this.mainContent.appendChild(this.renderGeneralAccess()),this.shareContent.appendChild(this.mainContent),this.bottomButtons=document.createElement("div"),this.bottomButtons.classList="flex justify-between items-center py-2",this.leftButtons=document.createElement("div"),this.leftButtons.classList="flex gap-2",this.rightButtons=document.createElement("div"),this.rightButtons.classList="flex gap-2",this.bottomButtons.appendChild(this.leftButtons),this.bottomButtons.appendChild(this.rightButtons),this.shareContent.appendChild(this.bottomButtons),this.currentPermissions.share_link){this.shareUrl=this.currentPermissions.share_link;const e=o.A.name("copy");this.getShareURLButton=new n.$({type:"secondary",size:"small",text:"Copy link",svgPathData:e.path,svgViewBox:e.viewBox}),this.getShareURLButton.render(this.leftButtons)}this.addEventListeners(),this.toggleLoading(!1)}catch(e){new c.y("Error loading sharing options","error"),this.toggleLoading(!1)}}addEventListeners(){this.config.userAndTeamSharingPermission&&!this.personalWorkspace&&this.usersOnTeam.onChange((e=>{this.toggleSharePermissions(e)})),this.getShareURLButton&&this.getShareURLButton.onClick((()=>{navigator.clipboard.writeText(this.shareUrl).then((()=>{new c.y("Share link copied to clipboard","success")}),(()=>{new c.y("Error copying share link to clipboard","error")}))}))}toggleSharePermissions(e){if(e&&e.length>0){if(this.sharePermissionMode)return;this.modal.confirmOnExit=!0,this.modal.unSavedChanges=!0;let e=[];this.config.permissions.forEach((t=>{e.push({value:t.value,label:t.label})}));const t=this.config.permissions.find((e=>e.default)),s={label:"",placeholder:"Select permission",value:t?t.value:"",required:!0,disabled:!1,readonly:!1,error:"",helpText:"",options:e};this.userOrTeamPermissionDropDown=new E(s),this.userOrTeamPermissionDropDown.render(this.topShareContent),this.mainContent.innerHTML="",this.mainContent.classList="flex flex-col pt-4",this.shareMessage=new p({label:"Send an optional message:",placeholder:`e.g. I thought you might like this ${this.config.objectType}`,required:!1,minChar:5,maxChar:500,value:"",type:"text"}),this.shareMessage.onChange((e=>{e&&e.length>0?this.savePermissionsButton.text="Save & send":this.savePermissionsButton.text="Save"})),this.shareMessage.render(this.mainContent),this.rightButtons.innerHTML="",this.leftButtons.innerHTML="",this.savePermissionsButton=new n.$({text:"Share",type:"primary",size:"large"}),this.cancelPermissionsButton=new n.$({text:"Cancel",type:"secondary",size:"large"}),this.cancelPermissionsButton.onClick((()=>{this.render()})),this.cancelPermissionsButton.render(this.rightButtons),this.savePermissionsButton.render(this.rightButtons),this.getLinkButton=new n.$({text:"Share & copy link",type:"secondary",size:"large",hoverText:"Get a link to share this item"}),this.getLinkButton.render(this.leftButtons),this.sharePermissionMode=!0,this.shareMessage.focus();const i=()=>({permission:this.userOrTeamPermissionDropDown.value,users:this.usersOnTeam.value,message:this.shareMessage.value});this.savePermissionsButton.onClick((()=>{const e=i();this.share(!1,e)})),this.getLinkButton.onClick((()=>{const e=i();this.share(!0,e)}))}else this.sharePermissionMode=!1,this.render()}renderAccessPermissions(){const e=document.createElement("div");e.classList="py-4";const t=document.createElement("div");t.classList="font-bold text-base",t.textContent="Who has access?",e.appendChild(t);const s=document.createElement("div");s.classList="flex flex-col gap-3 my-2 rounded-md cursor-normal";try{if(this.currentPermissions.owner){const e=this.renderShareTeamOrUserTile(this.currentPermissions.owner.profile_image,`${this.currentPermissions.owner.name} (you)`,this.currentPermissions.owner.email,"Owner",!0,this.currentPermissions.owner.id,null);s.appendChild(e)}Array.isArray(this.currentPermissions.permissions)&&this.currentPermissions.permissions.forEach((e=>{const t="team"===e.type,i=this.renderShareTeamOrUserTile(t?"users":e.user.profile_image,t?e.team.name:e.user.name,t?`${e.team.member_count} members`:e.user.email,this.getPermissionDisplayText(e.permission_level),!1,t?null:e.user.id,t?e.team.id:null);s.appendChild(i)}))}catch(e){const t=document.createElement("div");t.classList=`${this.theme.errorText} text-sm`,t.textContent="Error loading current permissions",s.appendChild(t)}return e.appendChild(s),e}getPermissionDisplayText(e){const t=this.config.permissions.find((t=>t.value===e));return t?t.label:e}showPermissionOptions(e,t,s){const i=[...this.config.permissions.map((t=>{const s=t.label===e.getData("currentPermission");return{label:t.label,description:t.description,value:t.value,icon:this.getPermissionIcon(t.value),selected:s}})).map((i=>({label:i.label,description:i.description,icon:i.icon,selected:i.label===e.getData("currentPermission"),onClick:()=>this.updatePermission(e,i,t,s)}))),{type:"separator"},{label:"Remove access",description:"Remove all access for this user/team",icon:"usersSlash",onClick:()=>this.removeAccess(e,t,s),danger:!0}];this.attachDropdownMenu(e,i)}async updatePermission(e,t,s,i){try{this.toggleLoading(!0,"Updating permission...");const n={object:this.config.objectId,object_type:this.config.objectType,permission:t.value,user_id:s,team_id:i,action:"update"};(await u.K.updateObjectPermissions(n)).success?(this.updateUserPermission(e,t.value),new c.y("Permission updated successfully","success")):new c.y("Failed to update permission","error")}catch(e){new c.y("Error updating permission","error")}finally{this.toggleLoading(!1)}}async removeAccess(e,t,s){new a("Are you sure?",`This will immediately remove access for this ${t?"user":"team"}`).onConfirm((async()=>{try{this.toggleLoading(!0,"Removing access...");const e={object:this.config.objectId,object_type:this.config.objectType,action:"remove",user_id:t,team_id:s},i=await u.K.updateObjectPermissions(e);if(i.success){let e="";if(t?e=`[data-user-id="${t}"]`:s&&(e=`[data-team-id="${s}"]`),e){const t=document.querySelector(e);t?.remove()}new c.y("Access removed successfully","success"),this.updateMultiSelectOptions()}else new c.y(`Failed to remove access: ${i.error}`,"error")}catch(e){new c.y("Error removing access","error")}finally{this.toggleLoading(!1)}}))}async updateMultiSelectOptions(){const e=await y.a.getShareableUsersAndTeams(this.config.objectType,this.config.objectId);this.shareList=[...e.users,...e.teams],this.usersOnTeam.setItems(this.shareList)}getPermissionIcon(e){return{read_only:"eye",full_access:"edit"}[e]||"user"}updateUserPermission(e,t){const s=this.config.permissions.find((e=>e.value===t));s&&(e.text=s.label,e.setData("currentPermission",s.label))}showGeneralAccessOptions(e){const t=[];t.push({...this.GENERAL_ACCESS_OPTIONS.restricted,onClick:()=>this.updateGeneralAccess("restricted")}),this.config.generalAccess.workspace.enabled&&t.push({...this.GENERAL_ACCESS_OPTIONS.workspace,onClick:()=>this.updateGeneralAccess("workspace")}),this.config.generalAccess.public.enabled&&t.push({...this.GENERAL_ACCESS_OPTIONS.public,onClick:()=>this.updateGeneralAccess("public")}),this.config.generalAccess.public_share?.enabled&&t.push({...this.GENERAL_ACCESS_OPTIONS.public_share,onClick:()=>this.updateGeneralAccess("public_share")}),t.length<=1||this.attachDropdownMenu(e,t)}renderGeneralAccess(){const e=document.createElement("div");e.classList="pb-4";const t=document.createElement("div");t.classList="font-bold text-base",t.textContent="General access",e.appendChild(t);const s=document.createElement("div");s.classList="flex flex-col gap-2 my-2 cursor-normal general-access";const i=this.config.generalAccess.workspace.enabled||this.config.generalAccess.public.enabled,n=this.currentPermissions?.currentAccess||"restricted",a=this.GENERAL_ACCESS_OPTIONS[n]||this.GENERAL_ACCESS_OPTIONS.restricted,o=this.renderShareTeamOrUserTile(a.icon,a.label,a.description,i?"Change":null,!1);if(i){const e=o.querySelector("button");e&&e.addEventListener("click",(t=>{this.showGeneralAccessOptions(e)}))}return s.appendChild(o),e.appendChild(s),e}updateGeneralAccessTile(e){const t=document.querySelector(".general-access");if(!t)return;const s=this.GENERAL_ACCESS_OPTIONS[e]||this.GENERAL_ACCESS_OPTIONS.restricted,i=this.config.generalAccess.workspace.enabled||this.config.generalAccess.public.enabled,n=this.renderShareTeamOrUserTile(s.icon,s.label,s.description,i?"Change":null,!1);if(i){const e=n.querySelector("button");e&&e.addEventListener("click",(t=>{this.showGeneralAccessOptions(e)}))}t.innerHTML="",t.appendChild(n)}async updateGeneralAccess(e){if(this.currentGeneralAccess!==e)try{this.toggleLoading(!0,"Updating general access...");const t={object:this.config.objectId,object_type:this.config.objectType,permission:e,action:"update-general-access"},s=await u.K.updateObjectPermissions(t);if(s.success)this.currentGeneralAccess=e,this.updateGeneralAccessTile(e),new c.y("General access updated successfully","success");else{s.detail;new c.y(s.detail,"error")}}catch(e){new c.y("Error updating general access","error")}finally{this.toggleLoading(!1)}}attachDropdownMenu(e,t){let s=null;const i=document.querySelector(".focus-dropdown-menu");if(i&&i.remove(),i&&s===e)return void(s=null);const n=document.createElement("div");n.className=`focus-dropdown-menu absolute ${this.theme.tableMenuBackground} shadow-md rounded-md z-50 text-sm max-w-[320px] flex flex-col overflow-hidden py-1 ring-1 ${this.theme.inputRing}`,s=e;const a=document.createElement("ul");t.forEach((e=>{if("separator"===e.type){const e=document.createElement("li");return e.className=`border-t ${this.theme.tableBorder} my-1`,void a.appendChild(e)}const t=document.createElement("li"),i=document.createElement("button"),l=document.createElement("div");if(l.className="flex items-center gap-3 w-full px-3 py-1.5",e.icon&&!e.selected){const t=o.A.name(e.icon);new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"}).render(l)}else if(e.selected){const e=o.A.name("check");new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.selectCheckColor}).render(l)}const c=document.createElement("div");c.className="flex flex-col text-left";const d=document.createElement("div");if(d.textContent=e.label,e.danger&&(d.className=this.theme.dangerText),c.appendChild(d),e.description){const t=document.createElement("div");t.className=`${this.theme.fadedText} text-xs`,t.textContent=e.description,c.appendChild(t)}l.appendChild(c),i.appendChild(l),i.className=`w-full text-left ${this.theme.tableMenuButtonHover}`,i.onclick=t=>{t.stopPropagation(),e.onClick(),n.remove(),s=null},t.appendChild(i),a.appendChild(t)})),n.appendChild(a),document.body.appendChild(n);const l=e.getBoundingClientRect(),c=n.getBoundingClientRect(),d=window.innerWidth-l.right;let h,m;h=window.innerHeight-l.bottom<c.height&&l.top>c.height?l.top-c.height-5:l.bottom+5,m=d<c.width&&l.left>c.width?l.right-c.width:l.left,n.style.top=`${h}px`,n.style.left=`${m}px`,requestAnimationFrame((()=>{n.classList.add("show")}));const u=t=>{n.contains(t.target)||e.contains(t.target)||(n.classList.remove("show"),setTimeout((()=>{n.remove(),s=null}),150),document.removeEventListener("click",u,!0))};setTimeout((()=>document.addEventListener("click",u,!0)),0)}renderShareTeamOrUserTile(e,t,s,i,a=!1,r,l){const c=document.createElement("div");c.classList="flex justify-between items-center w-full rounded-md p-2",c.dataset.userId=r,c.dataset.teamId=l;const d=document.createElement("div");d.classList="flex gap-2 items-center";const h=this.createAvatar(e);d.appendChild(h);const m=document.createElement("div"),u=document.createElement("div");u.textContent=t;const p=document.createElement("div");p.classList=`${this.theme.fadedText} text-sm`,p.textContent=s,m.appendChild(u),m.appendChild(p),d.appendChild(m);const g=document.createElement("div");if(g.classList="px-2 text-sm",a)g.textContent="Owner";else if(this.config.generalAccess.public.enabled||this.config.generalAccess.workspace.enabled){const e=o.A.name("chevronDown"),t=new n.$({text:i,type:"secondaryTransparent",size:"small",svgPathData:e.path,svgViewBox:e.viewBox,currentPermission:i});t.render(g),t.onClick((()=>{this.showPermissionOptions(t,r,l)}))}return c.appendChild(d),c.appendChild(g),c}createAvatar(e){document.createElement("div");return this.isValidImageUrl(e)?this.createImageAvatar(e):o.A.icon[e]?this.createIconAvatar(e):this.createFallbackAvatar()}isValidImageUrl(e){return!!e&&(e.startsWith("http")||e.startsWith("/")||e.startsWith("data:image"))}createImageAvatar(e){const t=document.createElement("div"),s=document.createElement("img");return s.src=e,s.classList="w-10 h-10 rounded-full object-cover",s.onerror=()=>{t.replaceWith(this.createFallbackAvatar())},t.appendChild(s),t}createIconAvatar(e){const t=document.createElement("div");t.classList=`flex w-10 h-10 items-center justify-center align-middle rounded-full ${this.theme.focusButton}`;const s=o.A.name(e);return new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-5 h-5"}).render(t),t}createFallbackAvatar(){const e=document.createElement("div");e.classList=`flex w-10 h-10 items-center justify-center align-middle rounded-full ${this.theme.secondaryBackground}`;return new r.I({...o.A.name("user"),sizeClasses:"w-5 h-5"}).render(e),e}onShare(e){}onCancel(e){}async share(e=!1,t){try{this.toggleLoading(!0,"Updating sharing settings..."),this.modal.unSavedChanges=!1,t.object=this.config.objectId,t.object_type=this.config.objectType,t.action="add",t.get_link=e;const s=await u.K.updateObjectPermissions(t);s.success?(this.toggleLoading(!1),s.link,new c.y("Sharing settings updated successfully","success"),this.render()):(this.toggleLoading(!1),this.modal.unSavedChanges=!0,new c.y("Error updating sharing settings","error"))}catch(e){this.toggleLoading(!1),this.modal.unSavedChanges=!0,new c.y("Error updating sharing settings","error")}}toggleLoading(e,t="Loading sharing settings..."){e?(this.shareContent.classList.add("hidden"),this.loadingPlaceholder.innerHTML="",this.loadingPlaceholder.appendChild(this.createLoadingContent(t)),this.loadingPlaceholder.classList.remove("hidden")):(this.shareContent.classList.remove("hidden"),this.loadingPlaceholder.classList.add("hidden"))}createLoadingContent(e="Loading sharing settings..."){const t=document.createElement("div");t.classList="flex items-center justify-center align-middle gap-4 h-[250px]";const s=document.createElement("div");s.className="py-6 space-y-2";const i=document.createElement("div");i.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;new r.I({...o.A.name("spinner"),sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"}).render(i);const n=document.createElement("div");n.className="text-lg font-bold text-center",n.textContent="Loading";const a=document.createElement("div");return a.className="text-base text-center",a.textContent=e,s.appendChild(i),s.appendChild(n),s.appendChild(a),t.appendChild(s),t}}class _e{constructor(e=null){this.container=e,this.tableIndex=null,this.tableConfig=null,this.tableData=null,this.currentSortColumn="modified",this.currentSortOrder="desc",this.currentColumnOrder=null,this.endOfData=!1,this.currentSearchTerm="",this.PAGESIZE=100,this.currentFilter="all",window.assistantsPollingInterval=null,this.pollingDelay=5e3}async init(e=null){e&&(this.container=e);try{this.showLoadingState(),await this.getAssistantData(),this.render()}catch(e){this.showErrorMessage("Failed to load assistants. Please try again later.")}}showLoadingState(){this.container&&(this.container.innerHTML="",Se.renderLoadingState(this.container,this.tableConfig||{tableColumns:[{value:"name",name:"Name"},{value:"type",name:"Type"},{value:"modified",name:"Modified"},{value:"modified",name:"Modified"},{value:"modified",name:"Modified"},{value:"modified",name:"Modified"}]},"grid"))}startPolling(){this.stopPolling(),window.assistantsPollingInterval&&clearInterval(window.assistantsPollingInterval),window.assistantsPollingInterval=setInterval((()=>this.pollStatuses()),this.pollingDelay)}stopPolling(){window.assistantsPollingInterval&&(clearInterval(window.assistantsPollingInterval),window.assistantsPollingInterval=null)}async pollStatuses(){if(this.tableIndex&&this.tableData)try{const e=await g.G.fetchData("/chat/get-assistants-status/");e&&e.statuses&&e.statuses.forEach((e=>{const t=this.tableData.find((t=>t.id===e.id.toString()));t&&t.memory_state!==e.memory_state&&(t.memory_state=e.memory_state,t.memory_processing_progress=e.memory_processing_progress,this.tableIndex.updateRecord(t))}))}catch(e){this.stopPolling()}else this.stopPolling()}render(){this.container&&(this.container.innerHTML="",this.tableConfig&&this.tableData?this.tableIndex?this.updateContentView(this.tableData):(this.tableIndex=new Se(this.tableConfig,this.tableData,this.container),this.tableIndex.setCallbacks({onAction:this.onAction.bind(this),loadMore:this.loadMore.bind(this),onResizeCols:this.onResize.bind(this),onRowClick:this.onRecordClick.bind(this),onCreate:this.onCreate.bind(this),onSort:this.onSort.bind(this),onColumnOrderChange:this.onColumnOrderChange.bind(this),onResetPagination:this.resetPagination.bind(this),onFilterChange:this.onFilterChange.bind(this),getAllMatchingRecordIds:this.getAllMatchingAssistantIds.bind(this),onTableStateChange:this.saveWidthOrderAndSort.bind(this)}),this.container.appendChild(this.tableIndex.render()),this.startPolling()):this.tableConfig&&this.tableData?this.showErrorMessage("No data available to display."):this.showLoadingState())}async getAssistantData(e=1,t=this.PAGESIZE,s=null,i=null,n="",a="all"){try{const o="/chat/get-assistants/",r={page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a},l=await g.G.postData(o,r);return l.tableConfig&&(this.tableConfig=l.tableConfig),this.tableData=l.tableData,this.currentPage=l.currentPage,this.totalPages=l.totalPages,this.endOfData=l.endOfData||this.currentPage>=this.totalPages,this.tableData}catch(e){throw new c.y("Failed to load assistants. Please try again later.","error"),e}}async loadMore(e,t,s,i,n="",a="all"){return await this.getAssistantData(e,t,s,i,n,a)}async quickRender(e=null){if(e&&(this.container=e),!this.container||!this.tableIndex)return void await this.init(e);this.container.innerHTML="";const t=this.tableIndex.render();this.container.appendChild(t),this.startPolling()}updateContentView(e){this.tableIndex?(this.tableIndex.tableData=e,this.tableIndex.updateContentView(e)):this.render()}onAction(e,t){switch(e){case"edit":ge.edit(t.id);break;case"delete":this.deleteAssistant(t);break;case"duplicate":this.duplicateAssistant(t);break;case"toggle_favorite":this.toggleFavorite(t);break;case"share":this.shareAssistant(t);break;case"remove_share":this.removeSharedAssistant(t);break;case"archive":this.archiveAssistant(t);break;case"unarchive":this.unarchiveAssistant(t)}}async onRecordClick(e){await ke.createNewChatWithAssistant(e)}async toggleFavorite(e){"favorite"===(e.is_favorited?"unfavorite":"favorite")?new c.y(`Added ${e.name} to favorites`,"success"):new c.y(`Removed ${e.name} from favorites`,"success");const t=await g.G.postData("/chat/assistants/toggle-favorite/",{assistant_id:e.id});t&&t.assistant_data&&(this.tableIndex.updateRecord(t.assistant_data),u.K.updateAssistantSelector())}shareAssistant(e){const t=e.actions.find((e=>"share"===e.value)),s=t?.share_permissions||{team_share:!1,workspace_share:!1,public_share:!1},i={title:e.name,objectType:"assistant",objectId:e.id,generalAccess:{workspace:{enabled:s.workspace_share},public:{enabled:s.public_share},public_share:{enabled:s.public_duplicate||!1}},userAndTeamSharingPermission:s.team_share,permissions:[{label:"Read only",description:"Can use but not edit or duplicate",value:"read_only",default:!0},{label:"Full access",description:"Can duplicate assistant and access stored knowledge",value:"full_access"}]};new Le(i)}destroy(){this.stopPolling(),this.container&&(this.container.innerHTML=""),this.tableIndex=null}onCreate(){ge.create()}onResize(e){}async saveWidthOrderAndSort(){const e=this.tableIndex.getCurrentTableState();try{const t="/chat/save-assistant-table-preferences/",s={column_widths:e.columnWidths,column_order:e.columnOrder,sort_column:e.sortColumn||"modified",sort_order:e.sortOrder||"desc",view:e.view};await g.G.postData(t,s)}catch(e){new c.y("Failed to save table preferences. Please try again.","error")}}archiveAssistant(e){new a("Archive assistant?",`This will archive "${e.name}". Archived assistants no longer can be selected in the assistant list, but can be restored later.`).onConfirm((async()=>{try{const t=await g.G.postData("/chat/assistants/archive/",{assistant_id:e.id});t.success?("archived"!==this.currentFilter?this.tableIndex.removeRecord(e.id):await this.refreshTableData(),new c.y(`"${e.name}" archived successfully`,"success"),u.K.updateAssistantSelector()):new c.y(t.detail||"Failed to archive assistant","error")}catch(e){new c.y("Failed to archive assistant. Please try again.","error")}}))}unarchiveAssistant(e){new a("Unarchive assistant?",`This will unarchive "${e.name}" and make it visible in your main assistant list again.`).onConfirm((async()=>{try{const t=await g.G.postData("/chat/assistants/unarchive/",{assistant_id:e.id});t.success?("archived"===this.currentFilter?this.tableIndex.removeRecord(e.id):await this.refreshTableData(),new c.y(`"${e.name}" unarchived successfully`,"success"),u.K.updateAssistantSelector()):new c.y(t.detail||"Failed to unarchive assistant","error")}catch(e){new c.y("Failed to unarchive assistant. Please try again.","error")}}))}removeSharedAssistant(e){new a("Are you sure?",`This will remove "${e.name}" from your assistants. To regain access you will need to be re-invited by the owner.`).onConfirm((async()=>{this.tableIndex.removeRecord(e.id),await g.G.postData("/chat/assistants/remove-shared/",{assistant_id:e.id}),u.K.updateAssistantSelector()}))}deleteAssistant(e){new a("Are you sure?",`This will delete "${e.name}" permanently.`).onConfirm((async()=>{try{const t=await g.G.postData("/chat/assistants/delete/",{assistant_id:e.id}),s=t;s.success?(this.tableIndex.removeRecord(e.id),new c.y("Assistant deleted successfully","success"),u.K.updateAssistantSelector()):(new c.y(s.detail,"error"),400!==t.status&&404!==t.status||this.tableIndex.refreshData())}catch(e){new c.y("Failed to delete assistant. Please try again.","error"),this.tableIndex.refreshData()}}))}async duplicateAssistant(e){new a("Are you sure?",`This will create a copy of "${e.name}".`).onConfirm((async()=>{const t=await g.G.postData("/chat/assistants/duplicate/",{assistant_id:e.id});t&&t.new_assistant_data?(this.tableIndex.addRecord(t.new_assistant_data),new c.y("Assistant duplicated successfully","success"),u.K.updateAssistantSelector()):new c.y("Failed to duplicate assistant. Please try again.","error")}))}resetPagination(){this.currentPage=1,this.endOfData=!1}async updateTableData(){this.resetPagination(),await this.getAssistantData(1,this.PAGESIZE,this.tableIndex.currentSortColumn,this.tableIndex.currentSortOrder,this.tableIndex.filter)}showErrorMessage(e){new c.y(e,"error")}onColumnOrderChange(e){this.currentColumnOrder=e}onSort(e){}async onFilterChange(e){this.currentFilter=e;const t=this.tableIndex.getCurrentTableState();this.resetPagination(),await this.getAssistantData(1,this.PAGESIZE,t.sortColumn,t.sortOrder,t.search,t.filter),this.tableIndex.updateContentView(this.tableData)}async getAllMatchingAssistantIds(e,t,s,i){try{const n="/chat/get-all-matching-assistant-ids/",a={sortColumn:e,sortOrder:t,search:s,filter:i};return(await g.G.postData(n,a)).assistantIds}catch(e){return new c.y("Failed to fetch all matching assistants. Please try again.","error"),[]}}}class Ie{constructor(){this.workspaceConnections=y.a.workspace.appConnections,this.availableConnections=y.a.workspace.availableConnections,this.theme=i.A.theme,this.onConnectCallback=null,this.onCancelCallback=null}showConnectionOptionsModal(){this.appOptions=new h({options:this.availableConnections.map((e=>({name:e.name,subtext:e.subText,icon:e.icon,iconBrand:!0,value:e.id,selected:!1}))),enableCreate:!1,maxSelection:1}),this.connectionModal=new l({size:"medium",title:"Select an app to connect:",body:this.appOptions.create(),closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1,onConfirm:()=>{if(this.connectionNameInput.value)resolve(),this.connectionModal.close();else{new c.y("Please name the connection before saving","warning")}}}),this.appOptions.onSelect((()=>{const e=this.appOptions.getSelectedValue();this.appOptions.destroy(),this.connectionModal.close(),this.showConnectionModal(e)}))}showConnectionModal(e){return new Promise(((t,s)=>{this.appId=e;const i=this.availableConnections.find((e=>e.id===this.appId));i?(this.connectModalContainer=document.createElement("div"),this.connectModalContainer.classList="flex flex-col py-4 gap-2",this.connectionNameInput=new d({type:"text",placeholder:"e.g. Work Slack",label:"Name this connection:",value:"",required:!0}),this.connectionNameInput.render(this.connectModalContainer),this.connectionText=document.createElement("div"),this.connectionText.innerHTML="Authorize your account:",this.connectionText.classList="font-medium pt-2",this.connectModalContainer.appendChild(this.connectionText),this.buttonContainer=document.createElement("div"),this.buttonContainer.classList="",this.connectModalContainer.appendChild(this.buttonContainer),this.connectButton=new n.$({text:`Connect ${i.name}`,type:"primary",size:"large",width:"auto",icon:"fa-solid fa-arrow-up-right-from-square"}),this.connectButton.render(this.buttonContainer),this.connectionModal=new l({size:"medium",title:`Connect to ${i.name}`,body:this.connectModalContainer,closeX:!1,confirmOnExit:!0,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",onConfirm:()=>{const e=this.connectionNameInput.value;this.appId;if(e)t(),this.connectionModal.closeProcess(),this.connectCallback();else{new c.y("Please name the connection before saving","warning")}},onClose:()=>{this.cancelCallback()}}),this.connectionModal.waitingOnData(!0),this.connectionNameInput.onChange((()=>{this.connectionModal.hasUnSavedChanges(!0)})),this.connectButton.onClick((async()=>{if(this.connectionNameInput.value){this.connectButton.toggleLoading("Waiting authorization...");try{const e=await this.getAuthURL(this.appId);if(e)window.open(e,"_blank","noopener,noreferrer"),this.waitForConnection().then((()=>{this.connectButton.toggleLoading(),this.connectionModal.waitingOnData(!1),this.connectButton.disableButton(),this.connectButton.text="Success!",this.connectButton.icon="fa-solid fa-check-circle",t()})).catch((e=>{this.connectButton.toggleLoading();new c.y(`Authorization failed: ${e.message}`,"error");s(e)}));else{new c.y("We couldn't open the authorization window. Check you are not blocking popups.","error")}}catch(e){new c.y(`We couldn't get the auth URL for ${i.name}`,"error");s(e)}}else{new c.y("Please name the connection before authorizing","warning")}}))):s(new Error("App connection not found"))}))}async getAuthURL(e){const t=this.availableConnections.find((e=>e.id===this.appId));try{return"https://google.com/"}catch(e){new c.y(`We couldn't get the auth URL for ${t.name}`,"error");return null}}async waitForConnection(){return new Promise(((e,t)=>{const s=setInterval((async()=>{try{await this.checkAuthorizationStatus(this.appId)&&(clearInterval(s),e())}catch(e){clearInterval(s),t(e)}}),3e3)}))}async checkAuthorizationStatus(e){return Math.random()>.5}connectCallback(){"function"==typeof this.onConnectCallback&&this.onConnectCallback()}cancelCallback(){"function"==typeof this.onCancelCallback&&this.onCancelCallback()}onConnect(e){"function"==typeof e&&(this.onConnectCallback=e)}onCancel(e){"function"==typeof e&&(this.onCancelCallback=e)}}class Ae{constructor(e=null,t=null){this.container=e,this.theme=i.A.theme,this.scrollPanel=null,this.createAssistantContainer=null,this.headerContainer=null,this.heading=null,this.formContainer=null,this.assistantName=null,this.assistantInstructions=null,this.createButton=null,this.cancelButton=null,this.buttonContainer=null,this.avatar=null,this.deploymentOptions=null,this.unSavedChanges=!1,this.optionFields=[],this.groundedMemory=[],this.editMode=!!t,this.assistant=t}async init(e=null,t=null){e&&(this.container=e),this.container&&(this.assistant=t,this.editMode=!!t,this.groundedMemory=[],this.render(),this.editMode&&this.assistant&&this.assistant.grounded_memories&&this.assistant.grounded_memories.forEach((e=>{this.addMemoryTile(e)})))}render(){this.container&&(this.container.innerHTML="",this.scrollPanel=document.createElement("div"),this.scrollPanel.className="h-full overflow-y-auto",this.container.appendChild(this.scrollPanel),this.createAssistantContainer=document.createElement("div"),this.createAssistantContainer.className=`${this.theme.text} sm:max-w-[700px] tracking-wide w-full sm:mx-auto space-y-4 py-6 px-4`,this.scrollPanel.appendChild(this.createAssistantContainer),this.heading=document.createElement("div"),this.heading.className=`flex flex-col text-xl md:text-2xl font-bold ${this.theme.text}`,this.editMode?this.heading.textContent="Edit assistant":this.heading.textContent="New assistant",this.createAssistantContainer.appendChild(this.heading),this.formContainer=document.createElement("div"),this.formContainer.className="space-y-4 pb-4",this.createAssistantContainer.appendChild(this.formContainer),this.avatar=new S("Avatar",this.editMode&&this.assistant?this.assistant.img_url:null,"Create avatar"),this.avatar.render(this.formContainer),this.groundedMemoryContainer=document.createElement("div"),this.assistantName=new d({label:"Name",type:"text",placeholder:"e.g. HR Bot",value:this.editMode&&this.assistant?this.assistant.name:"",minChar:3,maxChar:50,required:!0,disabled:!1,readonly:!1,error:"An assistant name is required",helpText:"Please enter an assistant name"}),this.assistantInstructions=new p({label:"Instructions",type:"text",placeholder:"e.g. You are ZenCorp's HR Bot. You help the user with HR related queries. You always refer to ZenCorp's HR policy when answering questions.",rows:8,canGrow:!0,value:this.editMode&&this.assistant?this.assistant.instructions:"",minChar:10,maxChar:2e6,required:!0,disabled:!1,readonly:!1,error:"Assistant instructions are required",helpText:"Please enter assistant instructions"}),this.createButton=new n.$({text:this.editMode?"Save assistant":"Create assistant",type:"ringPrimary",size:"medium",disabled:!1}),this.cancelButton=new n.$({text:"Cancel",type:"ringSecondary",size:"medium",disabled:!1}),this.assistantName.render(this.formContainer),this.assistantInstructions.render(this.formContainer),this.buttonContainer=document.createElement("div"),this.buttonContainer.className="flex gap-4 align-middle items-center justify-end py-2",this.formContainer.appendChild(this.groundedMemoryContainer),this.cancelButton.render(this.buttonContainer),this.createButton.render(this.buttonContainer),this.createMemoryContainer(),this.createDeployContainer(),this.formContainer.appendChild(this.buttonContainer),this.addEventListeners())}createMemoryContainer(){this.memoryContainer=document.createElement("div"),this.memoryHeaderContainer=document.createElement("div"),this.memoryHeaderContainer.classList="flex gap-2 justify-between align-middle items-center pb-2",this.memoryLabel=document.createElement("div"),this.memoryLabel.className="text-base font-medium ",this.memoryLabel.textContent="Knowledge",this.memoryHeaderContainer.appendChild(this.memoryLabel),this.addMemoryButtonContainer=document.createElement("div"),this.addMemoryButton=new n.$({text:"+ Add knowledge",type:"link",size:"link-base",disabled:!1}),this.addMemoryButton.render(this.addMemoryButtonContainer),this.memoryHeaderContainer.appendChild(this.addMemoryButtonContainer),this.memoriesContainer=document.createElement("div"),this.memoriesContainer.classList=`ring-inset ring-2 ${this.theme.inputRing} rounded-md p-4 flex flex-wrap gap-2 min-h-[160px] justify-center align-middle items-center md:justify-start md:align-start md:items-start ${this.theme.inputBackground} appearance-none border-0`,this.memoryContainer.appendChild(this.memoryHeaderContainer),this.memoryContainer.appendChild(this.memoriesContainer),this.groundedMemoryContainer.appendChild(this.memoryContainer),this.memoryFileUploadTab=document.createElement("div"),this.addMemoryButton.onClick((()=>{this.showAddMemoryDialog()})),this.checkPlaceholder()}createTempID(){return`${Date.now()}-${Math.floor(1e4*Math.random())}`}showAddMemoryDialog(){this.memoryOptions=[{name:"Files",subtext:"Documents, PDFs, images, videos, audio",icon:"fa-file",value:"upload",selected:!1},{name:"Web crawl",subtext:"Crawl a website for knowledge",icon:"fa-spider",value:"crawl",selected:!1},{name:"YouTube video",subtext:"Add a YouTube video as memory",icon:"fa-video",value:"video",selected:!1}],this.addMemorySelector=new h({enableCreate:!1,maxSelections:1,options:this.memoryOptions}),this.addMemorySelectorModal=new l({size:"medium",title:"Add knowledge",body:this.addMemorySelector.create(),closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1}),this.addMemorySelector.onSelect((()=>{switch(this.addMemorySelector.getSelectedValue()){case"upload":this.showFileUpload();break;case"crawl":this.showWebCrawl();break;case"video":this.showYouTubeVideo()}this.addMemorySelectorModal.close(),this.addMemorySelector.destroy()}))}showFileUpload(){this.memoryFileUpload=new J({uiType:"uploadBox",label:"",allowedTypes:["*"],maxFiles:20,maxSizePerFile:20,maxTotalSize:400,required:!1}),this.memoryFileUpload.onChange((()=>{this.fileUploadModal.hasUnSavedChanges(!0),this.memoryFileUpload.uploadInProgress?this.memoryFileUpload.waitingOnData(!0):this.memoryFileUpload.waitingOnData(!1)}));const e=document.createElement("div");e.classList="py-2",this.memoryFileUpload.render(e),this.fileUploadModal=new l({size:"large",title:"Upload files",body:e,closeX:!1,confirmOnExit:!0,confirm:!0,confirmText:"Save",cancel:!0,cancelText:"Cancel",buttonWidth:"auto",buttonStyleConfirm:"ringPrimary",buttonSize:"medium",skipFade:!0}),this.fileUploadModal.waitingOnData(!0),this.memoryFileUpload.onChange((()=>{this.fileUploadModal.hasUnSavedChanges(!1),(this.memoryFileUpload.isUploadInProgress||this.memoryFileUpload.files.length>0)&&this.fileUploadModal.hasUnSavedChanges(!0),this.memoryFileUpload.files&&this.memoryFileUpload.files.length>0&&!this.memoryFileUpload.isUploadInProgress?this.fileUploadModal.waitingOnData(!1):this.fileUploadModal.waitingOnData(!0)})),this.fileUploadModal.onConfirm((()=>{0!=this.memoryFileUpload.files.length&&this.memoryFileUpload.files.forEach((e=>{const t=this.memoryFileUpload.fileUploadIds[e.name],s={id:this.createTempID(),type:"file",name:e.name,upload_id:t,payload:{file:e}};this.addMemoryTile(s)}))}))}showWebCrawl(e=null){this.webCrawlContainer=document.createElement("div"),this.webCrawlContainer.classList="py-2 space-y-4",this.webCrawlURL=new d({label:"Website URL",type:"url",placeholder:"e.g. https://www.zencorp.com/knowledgebase",value:e?e.payload.url:"",minChar:10,maxChar:500,required:!0,disabled:!1,readonly:!1,error:"A website URL is required",helpText:"Please enter a website URL"}),this.webCrawlDepth=new E({label:"Crawl depth",placeholder:"Select depth",value:e?e.payload.depth:"",required:!0,disabled:!1,readonly:!1,error:"Please select a crawl depth",helpText:"Please select a crawl depth",options:[{value:"1",label:"This URL only"},{value:"2",label:"One level deep"},{value:"3",label:"Two levels deep"}]}),this.webCrawlFrequency=new E({label:"Crawl frequency",placeholder:"Select frequency",value:e?e.payload.frequency:"",required:!0,disabled:!1,readonly:!1,error:"Please select a crawl frequency",helpText:"Please select a crawl frequency",options:[{value:"never",label:"Only once"},{value:"day",label:"Update daily"},{value:"week",label:"Update weekly"},{value:"month",label:"Update monthly"}]}),this.webCrawlURL.render(this.webCrawlContainer),this.webCrawlDepth.render(this.webCrawlContainer),this.webCrawlFrequency.render(this.webCrawlContainer),this.webCrawlModal=new l({size:"medium",title:"Crawl setup",body:this.webCrawlContainer,closeX:!1,confirmOnExit:!0,confirm:!0,confirmText:"Save",cancel:!0,cancelText:"Cancel",buttonWidth:"auto",buttonStyleConfirm:"ringPrimary",buttonSize:"medium",skipFade:!0,validationFunction:()=>this.webCrawlURL.validate()&&this.webCrawlDepth.validate()&&this.webCrawlFrequency.validate()});let t=!1,s=!1,i=!1;e?(this.webCrawlModal.waitingOnData(!1),t=this.webCrawlURL.value.length>0,s=""!=this.webCrawlDepth.value,i=""!=this.webCrawlFrequency.value):this.webCrawlModal.waitingOnData(!0);const n=()=>{t&&s&&i?(this.webCrawlModal.hasUnSavedChanges(!0),this.webCrawlModal.waitingOnData(!1)):this.webCrawlModal.waitingOnData(!0)};this.webCrawlURL.onChange((()=>{this.webCrawlModal.hasUnSavedChanges(!0),t=this.webCrawlURL.value.length>0,n()})),this.webCrawlDepth.onChange((()=>{this.webCrawlModal.hasUnSavedChanges(!0),s=""!=this.webCrawlDepth.value,n()})),this.webCrawlFrequency.onChange((()=>{this.webCrawlModal.hasUnSavedChanges(!0),i=""!=this.webCrawlFrequency.value,n()})),this.webCrawlModal.onConfirm((()=>{if(e)e.payload.url=this.webCrawlURL.value,e.payload.depth=this.webCrawlDepth.value,e.payload.frequency=this.webCrawlFrequency.value,e.name=this.webCrawlURL.value,this.updateMemoryTile(e);else{const e={id:this.createTempID(),type:"crawl",name:this.webCrawlURL.value,payload:{url:this.webCrawlURL.value,depth:this.webCrawlDepth.value,frequency:this.webCrawlFrequency.value}};this.addMemoryTile(e)}}))}showYouTubeVideo(e=null){this.youtubeVideoContainer=document.createElement("div"),this.youtubeVideoContainer.classList="py-2 space-y-4";const t={label:"YouTube URL",type:"youtube",placeholder:"e.g. https://www.youtube.com/watch?v=videoID",value:e?e.payload.url:"",minChar:10,maxChar:500,required:!0,disabled:!1,readonly:!1,error:"A YouTube URL is required",helpText:"Please enter a YouTube URL"};this.youtubeVideoURL=new d(t),this.youtubeVideoURL.render(this.youtubeVideoContainer),this.youtubeVideoModal=new l({size:"medium",title:"Add YouTube video",body:this.youtubeVideoContainer,closeX:!1,confirmOnExit:!0,confirm:!0,confirmText:"Save",cancel:!0,cancelText:"Cancel",buttonWidth:"auto",buttonStyleConfirm:"ringPrimary",buttonSize:"medium",skipFade:!0,validationFunction:()=>this.youtubeVideoURL.validate()}),e?this.youtubeVideoModal.waitingOnData(!1):this.youtubeVideoModal.waitingOnData(!0),this.youtubeVideoURL.onChange((()=>{this.youtubeVideoModal.waitingOnData(!1),this.youtubeVideoModal.hasUnSavedChanges(!0)})),this.youtubeVideoModal.onConfirm((()=>{if(e)e.payload.url=this.youtubeVideoURL.value,e.name=this.youtubeVideoURL.value,this.updateMemoryTile(e);else{const e={id:this.createTempID(),type:"video",name:this.youtubeVideoURL.value,payload:{url:this.youtubeVideoURL.value}};this.addMemoryTile(e)}}))}addMemoryTile(e){const t=document.createElement("div");t.dataset.id=e.id,t.classList=`rounded-md ring-1 ${i.A.theme.fileItemRing} ${i.A.theme.fileItemBackground} ${this.theme.text} w-full md:w-[330px] h-[64px] p-3 flex-none justify-start items-center align-middle text-white relative memory-item`;const s=document.createElement("div");s.classList=`flex gap-2 items-center justify-between relative z-10 w-full ${this.theme.text}`;const a=document.createElement("div");a.classList="w-10 h-10 rounded-md flex justify-center items-center align-middle flex-shrink-0";let o=null,r="";if("file"==e.type){if(!e.payload.file?.name)return;const t=e.thumbnail,s=e.payload.file.name.split(".").pop().toLowerCase(),n=["jpg","jpeg","png","gif","svg","webp"].includes(s);if(t)o=document.createElement("img"),o.classList="w-10 h-10 rounded-md object-cover flex flex-shrink-0",o.alt=e.payload.file.name,o.src=t;else if(n){o=document.createElement("img"),o.classList="w-10 h-10 rounded-md object-cover flex flex-shrink-0",o.alt=e.payload.file.name;const t=new FileReader;t.onload=e=>{o.src=e.target.result},t.readAsDataURL(e.payload.file)}else{const e=Y.getFileColor(null,s);o=document.createElement("div"),o.classList=`w-10 h-10 rounded-md ${e} ${i.A.theme.fileIconColor} flex justify-center items-center align-middle flex-shrink-0`,o.innerHTML=Y.getFileIcon(null,s)}r="File"}else if("crawl"==e.type){o=document.createElement("div"),o.classList=`w-10 h-10 rounded-md ${i.A.theme.memoryCrawlIconColor} ${i.A.theme.fileIconColor} flex justify-center items-center align-middle flex-shrink-0`,o.innerHTML='<i class="fa-solid fa-spider fa-lg"></i>';r=`Web crawl, ${(e=>{switch(e){case"never":return"only once";case"start":return"on start";case"day":return"daily";case"week":return"weekly";case"month":return"monthly"}})(e.payload.frequency)}`}else"video"==e.type&&(o=document.createElement("div"),o.classList=`w-10 h-10 rounded-md ${i.A.theme.memoryVideoIconColor} ${i.A.theme.fileIconColor} flex justify-center items-center align-middle flex-shrink-0`,o.innerHTML='<i class="fa-brands fa-youtube fa-lg"></i>',r="YouTube Video");const d=document.createElement("div");d.classList="flex flex-col text-left truncate w-full flex-shrink-1";const h=document.createElement("div");h.classList="text-sm text-left font-medium truncate memory-name",h.textContent=e.name;const m=document.createElement("div");m.classList="text-xs text-left truncate memory-subtext",m.textContent=r;const u=document.createElement("div");u.classList="flex gap-2 items-center justify-end align-middle";const p=document.createElement("button");p.type="button",p.classList=`p-2 ${i.A.theme.iconColor}`,p.innerHTML='<i class="fa-solid fa-ellipsis-h"></i>',u.appendChild(p),p.addEventListener("click",(s=>{s.stopPropagation();const i=document.createElement("div");if(i.classList="flex flex-col gap-3 py-4","crawl"==e.type||"video"==e.type){const t=new n.$({text:"Edit",type:"ringPrimary",size:"large",width:"full",disabled:!1});t.render(i),t.onClick((()=>{"crawl"==e.type?(o.close(),this.showWebCrawl(e)):"video"==e.type&&(o.close(),this.showYouTubeVideo(e))}))}const a=new n.$({text:"Remove",type:"ringPrimary",size:"large",width:"full",disabled:!1});a.render(i),a.onClick((()=>{t.remove(),this.groundedMemory=this.groundedMemory.filter((t=>t.name!=e.name));new c.y("Memory removed","success",!0,!0);o.close(),this.checkPlaceholder()}));const o=new l({size:"small",title:"",body:i,closeX:!0,confirmOnExit:!1,confirm:!1,cancel:!1})})),a.appendChild(o),t.appendChild(s),s.appendChild(a),s.appendChild(d),d.appendChild(h),d.appendChild(m),s.appendChild(u),this.memoriesContainer.appendChild(t),this.checkPlaceholder(),this.groundedMemory.push(e)}updateMemoryTile(e){if(!e||"crawl"!=e.type&&"video"!=e.type)return;const t=this.groundedMemory.findIndex((t=>t.id==e.id));this.groundedMemory[t]=e;const s=this.memoriesContainer.querySelector(`[data-id="${e.id}"]`);if(s){const t=s.querySelector(".memory-name"),i=s.querySelector(".memory-subtext");if(t.textContent=e.name,"crawl"==e.type){const t=e=>{switch(e){case"never":return"only once";case"start":return"on start";case"day":return"daily";case"week":return"weekly";case"month":return"monthly"}};i.textContent=`Web crawl, ${t(e.payload.frequency)}`}}}checkPlaceholder(){const e=this.memoriesContainer?.querySelectorAll(".memory-item");if(0==e.length)this.memoriesContainer.classList=`ring-inset ring-1 ${this.theme.inputRing} rounded-md p-4 flex flex-wrap gap-2 min-h-[160px] justify-center align-middle items-center ${this.theme.inputBackground} appearance-none border-0`,this.memoriesContainer.innerHTML=`\n                <div id="placeholder" class="flex flex-grow flex-col justify-center align-middle items-center text-center ${i.A.theme.memoryPlaceholderText} memory-placeholder cursor-pointer">Train your assistant with knowledge from files, web crawls and videos.</div>\n            `,this.placeholderDiv=this.memoriesContainer.querySelector("#placeholder"),this.placeholderDiv.addEventListener("click",(()=>{this.showAddMemoryDialog()}));else{const e=this.memoriesContainer.querySelector(".memory-placeholder");e&&e.remove(),this.memoriesContainer.classList=`ring-inset ring-2 ${this.theme.inputRing} rounded-md p-4 flex flex-wrap gap-2 min-h-[160px] justify-center align-middle items-center md:justify-start md:align-start md:items-start ${this.theme.inputBackground} appearance-none border-0`}}createDeployContainer(){}addEventListeners(){this.assistantName.onChange((()=>{this.unSavedChanges=!0})),this.assistantInstructions.onChange((()=>{this.unSavedChanges=!0})),this.cancelButton.onClick((()=>{if(this.unSavedChanges){new a("Are you sure you want to leave?","Your changes will not be saved.").onConfirm((()=>{v.view("/chat/assistants")}))}else v.view("/chat/assistants")})),this.createButton.onClick((async()=>{if(!this.assistantName.validate())return;if(!this.assistantInstructions.validate())return;if(!this.avatar.validate())return;const e=this.assistantName.value,t=this.assistantInstructions.value,s=this.avatar.value;const i={imgUrl:s.imgUrl,imgPrompt:s.imgPrompt,imgUploadId:s.imgUploadId,assistantName:e,assistantInstructions:t,groundedMemory:this.groundedMemory,deploymentOptions:[]};let n;if(this.createButton.toggleLoading("Saving..."),this.cancelButton.disableButton(),n=this.editMode?await g.G.postData(`/chat/assistants/${this.assistant.id}/update/`,i):await g.G.postData("/chat/assistants/new/",i),n?.assistant_id)u.K.updateAssistantSelector(),v.view("/chat/assistants");else{const e=n.detail||"There was an error updating the assistant. Please try again.";this.editMode,new c.y(e,"error",!0,!0),this.createButton.toggleLoading("Save"),this.cancelButton.enableButton()}}))}}class Me{constructor(){this.theme=i.A.theme,this.render()}render(){this.modalConfig={size:"medium",title:"Partner Program Application",closeX:!0,confirmOnExit:!0,confirm:!0,confirmText:"Submit Application",cancel:!1,buttonWidth:"full",buttonStyleConfirm:"ringPrimary",buttonSize:"large",manualCloseOnConfirm:!0,body:this.createApplicationForm()},this.modal=new l(this.modalConfig),this.modal.onConfirm((async()=>{if(!this.validateForm())return;const e=this.targetIndustries.value.map((e=>e.id)),t={first_name:this.firstName.value,last_name:this.lastName.value,contact_email:this.contactEmail.value,contact_number:this.contactNumber.value,company:this.company.value,years_in_business:this.yearsInBusiness.value,about_business:this.aboutBusiness.value,role:this.role.value,estimated_workspaces:this.estimatedWorkspaces.value,target_industries:e,comments:this.comments.value};try{this.modal.toggleConfirmLoading("Submitting...");"success"===(await g.G.postData("/accounts/partner-program-application/",t)).status?(new c.y("Thank you for your interest! We'll be in touch soon.","success"),this.modal.hasUnSavedChanges(!1),this.modal.close()):(this.modal.toggleConfirmLoading(),new c.y("There was an error submitting your application. Please try again.","error"))}catch(e){this.modal.toggleConfirmLoading(),new c.y("There was an error submitting your application. Please try again.","error")}}));[this.firstName,this.lastName,this.contactEmail,this.contactNumber,this.company,this.yearsInBusiness,this.aboutBusiness,this.role,this.estimatedWorkspaces,this.targetIndustries,this.comments].forEach((e=>{e.onChange((()=>{this.modal.hasUnSavedChanges(!0)}))}))}createApplicationForm(){const e=document.createElement("div");e.classList="flex flex-col gap-3",e.id="partner-application-form";const t=document.createElement("div");t.classList=`${this.theme.text} text-sm mb-2`,t.innerHTML="Our partner program is currently in an invite-only stage. Please fill out the application below to be considered for the program. We are looking for high quality partners who can help support workspace customers and introduce new customers to the platform.",e.appendChild(t),this.firstName=new d({label:"First Name:",placeholder:"Enter your first name",type:"text",minChar:2,maxChar:50,required:!0,error:"First name is required"}),this.firstName.render(e),this.lastName=new d({label:"Last Name:",placeholder:"Enter your last name",type:"text",minChar:2,maxChar:50,required:!0,error:"Last name is required"}),this.lastName.render(e);const s=document.createElement("div");return s.classList="flex flex-col gap-3",e.appendChild(s),this.contactEmail=new d({label:"Best Contact Email:",placeholder:"Enter your work email",type:"email",required:!0,error:"Valid email address is required"}),this.contactEmail.render(s),this.contactNumber=new d({label:"Contact Number:",placeholder:"Enter your contact number",type:"tel",required:!0,error:"Valid contact number is required"}),this.contactNumber.render(s),this.company=new d({label:"Company:",placeholder:"Enter your company name",type:"text",minChar:2,maxChar:100,required:!0,error:"Company name is required"}),this.company.render(e),this.yearsInBusiness=new d({label:"How long have you been in business?",placeholder:"Enter number of years",type:"number",min:0,max:100,required:!0,error:"Please enter valid number of years"}),this.yearsInBusiness.render(e),this.aboutBusiness=new p({label:"About your business:",placeholder:"Tell us about your business and the services you provide",rows:4,canGrow:!0,minChar:20,maxChar:2e3,required:!0,error:"Please provide information about your business (minimum 50 characters)"}),this.aboutBusiness.render(e),this.role=new d({label:"Role:",placeholder:"Enter your role (e.g., CEO, Consultant)",type:"text",minChar:2,maxChar:100,required:!0,error:"Role is required"}),this.role.render(e),this.estimatedWorkspaces=new d({label:"Estimated New Workspaces per Month:",placeholder:"Enter estimated number",type:"number",min:1,max:1e3,required:!0,error:"Please enter a valid number"}),this.estimatedWorkspaces.render(e),this.targetIndustries=new x({label:"Target Industries:",placeholder:"Select target industries",required:!0,error:"Please select at least one industry",minItems:1,maxItems:5,items:[{id:"software",label:"Software"},{id:"hardware",label:"Hardware"},{id:"technology",label:"Technology"},{id:"telecom",label:"Telecom"},{id:"e-commerce",label:"E-Commerce"},{id:"gaming",label:"Gaming"},{id:"healthcare",label:"Healthcare"},{id:"biotech",label:"Biotech"},{id:"fitness",label:"Fitness"},{id:"finance",label:"Finance"},{id:"insurance",label:"Insurance"},{id:"consulting",label:"Consulting"},{id:"legal",label:"Legal"},{id:"education",label:"Education"},{id:"government",label:"Government"},{id:"non-profit",label:"Non-Profit"},{id:"retail",label:"Retail"},{id:"fashion",label:"Fashion"},{id:"food",label:"Food"},{id:"media",label:"Media"},{id:"entertainment",label:"Entertainment"},{id:"music",label:"Music"},{id:"sports",label:"Sports"},{id:"manufacturing",label:"Manufacturing"},{id:"construction",label:"Construction"},{id:"energy",label:"Energy"},{id:"automotive",label:"Automotive"},{id:"transportation",label:"Transportation"},{id:"real-estate",label:"Real Estate"},{id:"hospitality",label:"Hospitality"},{id:"travel",label:"Travel"},{id:"agriculture",label:"Agriculture"},{id:"marketing",label:"Marketing"},{id:"other",label:"Other"}],autoBlur:!0}),this.targetIndustries.render(e),this.comments=new p({label:"Additional Comments:",placeholder:"Tell us more about how you plan to partner with Simtheory",rows:4,canGrow:!0,minChar:10,maxChar:1e3,required:!0,error:"Please provide some additional information"}),this.comments.render(e),e}validateForm(){const e=[{field:this.firstName,name:"First name"},{field:this.lastName,name:"Last name"},{field:this.contactEmail,name:"Email"},{field:this.contactNumber,name:"Contact number"},{field:this.company,name:"Company"},{field:this.yearsInBusiness,name:"Years in business"},{field:this.aboutBusiness,name:"About business"},{field:this.role,name:"Role"},{field:this.estimatedWorkspaces,name:"Estimated workspaces"},{field:this.targetIndustries,name:"Target industries"},{field:this.comments,name:"Comments"}];for(const{field:t,name:s}of e)if("function"==typeof t.validate){if(!t.validate())return!1}return!0}}class Be{constructor(){this.theme=i.A.theme,this.container=null,this.scrollPanel=null,this.scrollView=null,this.innerContainer=null,this.workspaces=[]}async init(e){e&&(this.container=e,this.container.innerHTML="",this.scrollPanel=document.createElement("div"),this.scrollView=new Z(this.scrollPanel),this.container.appendChild(this.scrollPanel),this.innerContainer=document.createElement("div"),this.innerContainer.className="mx-auto max-w-7xl px-4 py-6 sm:px-6 lg:px-8 w-full",this.scrollView.addContainer(this.innerContainer),this.renderLoadingState(),await this.getWorkspaces())}renderLoadingState(){if(!this.innerContainer)return;const e=Array(3).fill().map((()=>`\n            <div class="flex justify-between align-middle items-center rounded-md ${this.theme.secondaryBackground} p-4 w-full min-w-[300px] flex-1 basis-[300px] max-w-full sm:max-w-[450px] leading-5">\n                <div class="flex gap-3 items-center flex-1">\n                    <div class="animate-pulse">\n                        <div class="w-20 h-20 rounded-md ${this.theme.loadBackground}"></div>\n                    </div>\n                    <div class="flex-1">\n                        <div class="animate-pulse ${this.theme.loadBackground} h-5 w-32 rounded mb-2"></div>\n                        <div class="animate-pulse ${this.theme.loadBackground} h-4 w-20 rounded"></div>\n                    </div>\n                </div>\n                <div class="animate-pulse">\n                    <div class="w-8 h-8 rounded-md ${this.theme.loadBackground}"></div>\n                </div>\n            </div>\n        `)).join("");this.innerContainer.innerHTML=`\n            <div class="flex justify-between items-center mb-4">\n                <div class="text-2xl font-bold">Workspaces</div>\n                <div class="flex gap-2">\n                    <div class="animate-pulse ${this.theme.loadBackground} w-32 h-8 rounded-md"></div>\n                    <div class="animate-pulse ${this.theme.loadBackground} w-32 h-8 rounded-md"></div>\n                </div>\n            </div>\n            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4">\n                ${e}\n            </div>\n        `}async getWorkspaces(){try{this.workspaces=await y.a.getWorkspaces(),this.renderWorkspaces()}catch(e){this.innerContainer&&(this.innerContainer.innerHTML=`<div class="p-4 ${this.theme.errorText}">Failed to load workspaces. Please try again later.</div>`)}}renderWorkspaces(){if(!this.innerContainer)return;const e=o.A.name("buildings"),t=o.A.name("cog");let s=this.workspaces.map((s=>{const i=`/accounts/workspace/login/${s.slug}/`,n=s.members||0,a=1===n?"member":"members",o=s.image?`<img src="${s.image}" class="rounded-md w-20 h-20 object-cover">`:`<div class="w-20 h-20 rounded-md ${this.theme.workspaceDefaultIcon} flex justify-center align-middle items-center">\n                        <svg viewBox="${e.viewBox}" class="w-7 h-7 fill-current" aria-hidden="true" focusable="false"><path d="${e.path}"></path></svg>\n                   </div>`,r=s.workspace_manage?`<button\n                    data-workspace-edit="${s.slug}"\n                    class="workspace-edit-button p-2 ${this.theme.iconColor} ${this.theme.secondaryButton} rounded-md transition-colors">\n                    <svg viewBox="${t.viewBox}" class="w-4 h-4 fill-current" aria-hidden="true" focusable="false"><path d="${t.path}"></path></svg>\n                   </button>`:"";return`\n                <div data-workspace-url="${i}" class="workspace-button flex justify-between align-middle items-center rounded-md ${this.theme.secondaryBackground} p-4 w-full min-w-[300px] flex-1 basis-[300px] max-w-full sm:max-w-[450px] leading-5 cursor-pointer">\n                    <div class="flex gap-3 items-center flex-1">\n                        <div>\n                            ${o}\n                        </div>\n                        <div>\n                            <div class="font-bold truncate w-full">${s.workspace_name}</div>\n                            <div class="${this.theme.fadedText} text-sm">${n} ${a}</div>\n                        </div>\n                    </div>\n                    ${r}\n                </div>\n            `})).join("");this.innerContainer.innerHTML=`\n            <div class="flex justify-between items-center mb-4">\n                <div class="text-2xl font-bold">Workspaces</div>\n                <div class="flex gap-2 items-center">\n                    <div id="partner-program-button"></div>\n                    <div id="create-workspace-button"></div>\n                </div>\n            </div>\n            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-3 2xl:grid-cols-4 gap-4 pb-10">\n                ${s}\n            </div>\n        `;const i=new n.$({text:"Create workspace",type:"primary",size:"medium"}),a=new n.$({text:"Become a partner",type:"link",size:"link-sm"}),r=this.innerContainer.querySelector("#create-workspace-button");r&&(i.render(r),i.onClick((()=>{window.location.href="/accounts/workspace/new/"})));const l=this.innerContainer.querySelector("#partner-program-button");l&&(a.render(l),a.onClick((()=>{new Me}))),this.addEventListeners()}addEventListeners(){if(!this.innerContainer)return;this.innerContainer.querySelectorAll(".workspace-button").forEach((e=>{e.addEventListener("click",(t=>{if(!t.target.closest(".workspace-edit-button")){const t=e.dataset.workspaceUrl;window.location.href=t}}));const t=e.querySelector(".workspace-edit-button");t&&t.addEventListener("click",(e=>{e.stopPropagation();const s=`/accounts/workspace/${t.dataset.workspaceEdit}/admin`;window.location.href=s}))}))}}class De{constructor(){this.primaryContent=document.getElementById("primary-content"),this.primaryView=null,this.scrollPanel=null,this.listConfig={title:"",clickOnRecord:!0,createButton:!1,optionMenu:!1,records:[{id:1,recordOwner:!0,title:"Personalization",sub_text:"Manage information shared with agents to personalize your experience"},{id:2,recordOwner:!0,title:"Refer a friend",sub_text:"Share Simtheory with friends and get rewarded"},{id:3,recordOwner:!0,title:"Theme",sub_text:"Style your experience with a theme of your choice"},{id:4,recordOwner:!0,title:"Billing",sub_text:"Manage billing and subscription"},{id:6,recordOwner:!0,title:"Support",sub_text:"Log a ticket or read our documentation"},{id:5,recordOwner:!0,title:"Sign out",sub_text:"Securely sign out of your account"}]},this.render()}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.primaryView=new Ee(this.listConfig),this.primaryView.render(this.scrollPanel),this.addCallbacks()}addCallbacks(){this.primaryView.onSelect((e=>{switch(e.id){case 1:new T;break;case 2:new b;case 3:new L;break;case 4:v.view("/chat/settings/billing");break;case 5:u.K.signOut();break;case 6:new f}}))}}class $e{constructor(){this.theme=i.A.theme,this.primaryContent=document.getElementById("primary-content"),this.appsView=null,this.scrollPanel=null,this.apps=null,this.render()}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.appsView=document.createElement("div"),this.appsView.classList=`${this.theme.text} sm:max-w-[700px] leading-7 tracking-wide w-full mx-4 sm:mx-0 space-y-4 py-2`,this.scrollPanel.appendChild(this.appsView),this.appsView.innerHTML=`\n\n        <div class="text-2xl font-bold text-white">Apps</div>\n\n        <div class="flex flex-wrap gap-4">\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/phone.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">AI Phone</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}/img/defaultapp.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">Simtheory Help</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/contract.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">Contract Analysis</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/fileanalysis.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">File Analysis</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/voicechanger.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">Voice Changer</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/rfp.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">RFP Responder</div>\n            </div>\n            <div class="flex flex-col gap-2">\n                <div class="w-36 h-36 md:w-[163px] md:h-[163px] rounded-lg drop-shadow-lg">\n                    <img src="${window.static_ur()}img/knowledge.png" class="w-full h-full object-cover rounded-md" />\n                </div>\n                <div class="text-center text-sm w-36 sm:w-[160px] leading-snug">Company knowledge search</div>\n            </div>\n        </div>\n        \n        \n        \n\n        \n        \n \n        `}}class Pe{constructor(){if(!1===u.K.hasPermission("admin:connected-apps"))return void v.view("/chat");this.primaryContent=document.getElementById("primary-content"),this.membersView=null,this.appConnections=y.a.workspace.appConnections;const e=y.a.workspace.availableConnections.reduce(((e,t)=>(e[t.id]={icon:t.icon,subText:t.subText},e)),{});this.records=this.appConnections.map((t=>({id:t.id,recordOwner:!0,icon:e[t.app_id].icon,title:t.name,sub_text:e[t.app_id].subText,statusTag:t.status,statusText:"connected"===t.status?"Connected":"Disconnected",options:["connected"===t.status?"disconnect":"reconnect","remove"]}))),this.appsTableConfig={title:"Connected apps",clickOnRecord:!1,createButton:!0,createButtonText:"Connect app",createPermission:u.K.hasPermission("admin:connected-apps:connect"),showBackButton:!0,backButtonRoute:"/chat/workspace",optionMenu:!0,options:[{text:"Reconnect",action:"reconnect",permission:u.K.hasPermission("admin:connected-apps:reconnect"),showIfRecordOwner:!0},{text:"Disconnect",action:"disconnect",permission:u.K.hasPermission("admin:connected-apps:disconnect"),showIfRecordOwner:!0},{text:"Remove",action:"remove",permission:u.K.hasPermission("admin:connected-apps:remove"),showIfRecordOwner:!0}],records:this.records},this.render()}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.appsView=new Ee(this.appsTableConfig),this.appsView.render(this.scrollPanel),this.addCallbacks()}addCallbacks(){this.appsView.onCreate((()=>{this.appConnection=new Ie,this.appConnection.showConnectionOptionsModal()}))}}class Ne{constructor(){this.primaryContent=document.getElementById("primary-content"),this.theme=i.A.theme,B.xI.setOptions({gfm:!0,breaks:!0,pedantic:!1}),this.init()}changelog(){return"# Beta changelog & known issues\nWant to suggest features or report bugs? [Join the discord](https://discord.gg/Ar6GeQnAR7) to help us improve the beta!\n\n## 1.3 Updates (23 Aug 2024)\n\n- Added Ideogram 2.0\n- Added Ideogram 2.0 Image2Image\n- Added Stable Diffusion Image2Image\n- Added Phi 3.5 Vision Instruction model\n- Various bug fixes\n\n## 1.2 Updates\n- Direct login to new Simtheory\n- Search images now lazy-load leading to much faster search\n- Errors now displayed when there are failues in skill execution\n- You can now expand images in search results\n- Removed conversation starters\n- Added LLAMA3.1 models\n- You can now search from the context menu when highlighting text\n- You can now add to knowledge graph from the context menu\n- Fixed issue with screen sharing incorrectly persisting between chats\n- Removing grounded memory from agents now works correctly\n- Transcripts from audio and video are now available to all models when uploading a file in chat\n\n## 1.1 Updates\n- Added search, click the + then search or use shortcuts /se and start typing\n- Added Mistral Codestral, Mistral Codestral Mamba, Open Mistral NeMo\n- Added GPT4o-mini\n- Added MidJourney image generation\n- Added Stable Diffusion image generation\n- Added DALL-E image generation\n- Added Stability AI image generation\n- Image download now works properly\n- Mobile UI/UX improvements\n- Added focus mode (click on an image or [ ] on a a code block to enlarge)\n- When you select text there are new options: Copy, Reply, Snippet, Search and Save to Memory. Only copy works right now. We will rapidly add the others.\n\n\n## 1.1 Known Issues\n- You still can't copy code when data is streaming, we will fix this soon\n- Some models may stop responding due to lack of context optimisation\n- When you login we redirect to old Simtheory, soon we will make it aware of source and redirect to the correct place\n- \"Preview\" in the code focus is not ready yet and has been disabled\n- Focus mode does not actually focus on that content, it will just keep chatting\n- In focus code mode the code won't update as you chat to the agent, this is coming soon\n- You can't rename conversations yet, it will be added very soon\n- You can't expand images in search results yet, we will add this soon\n\n\n## 1.0 Beta\n\n- Initial release\n- Switch between LLM models and agents\n- Share your screen or a window with an agent (they see what you see)\n- On mobile, share your camera with an agent (they see what you see)\n- Context is retained when switching between models and agents\n- Chat history shows agents and models\n- Create and edit agents\n- Ground an agents memory with with crawled web pages, files, and YouTube videos\n- Drag and drop files into the chat\n- Interupt an agent or tell them to \"stop\"\n- Switch themes (including the Rabbit r1 theme)\n\n## 1.0 Known Issues\n\n- If the model has an error it may just stop responding, there is no UI indication of this yet\n- Some models may stop responding due to lack of context optimization\n- Formatting in chat is not in a final state, we're aware it needs lots of work\n- Agent creation is missing planned features e.g. permissions, roles, deployment, skills etc. you will see notices that features don't work yet.\n- You can't copy code when data is streaming, we know how to fix this and will do so soon\n- When you login it will redirect to old Simtheory, soon we will make it aware of source and redirect to the correct place\n\n## Planned features\n\n- Focus mode (focus the agent on a specific task e.g. code, document, image etc.)\n- File manager (save, upload and manage project files in folders)\n- Image gallery (create, share and browse images)\n- Background tasks (let the agent work on a task in the background)\n- Search conversations\n- Share conversations\n- Ability to pin a conversation or part of a conversation and name it\n- Full theme control (including custom themes, fonts, font size, code style) and theme sharing\n- Add custom skills (via API and eventually builder)\n- Pin skills to the menu\n- Invite friends or coworkers to a conversation\n- Improved sorting, searching and favorites for agents\n- MathJax support\n- Ability to share agents\n- Ability to customize models e.g. temperature, max tokens, top p etc.\n- Workspaces (add a team or group of friends to your account)\n\n        "}init(){this.render()}render(){this.primaryContent.innerHTML="",this.container=document.createElement("div"),this.scrollView=new Z(this.container),this.contentContainer=document.createElement("div"),this.contentContainer.className=`max-w-md sm:max-w-[700px] leading-7 tracking-wide w-[100%] sm:w-[70%] ${this.theme.text} flex flex-col gap-3 markdown-style`,this.innerContent=document.createElement("div"),this.innerContent.className="py-4 leading-7 markdown-style flex flex-col gap-3",this.container.appendChild(this.contentContainer),this.primaryContent.appendChild(this.container);const e=this.changelog();this.changelogContent=B.xI.parse(e),this.innerContent.innerHTML=this.changelogContent,this.contentContainer.appendChild(this.innerContent)}}class ze{constructor(){this.primaryContent=document.getElementById("primary-content"),this.scrollPanel=null,this.theme=i.A.theme,this.render()}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.innerScrollView=document.createElement("div"),this.innerScrollView.classList="flex flex-col w-full leading-7 pb-8 pt-4 sm:pt-0 max-w-[700px] mx-auto",this.scrollView.addContainer(this.innerScrollView),this.innerContainer=document.createElement("div"),this.innerContainer.classList="flex flex-col bg-white text-black rounded-md shadow-md px-6 py-8 justify-center",this.innerScrollView.appendChild(this.innerContainer),this.renderHeader(),this.renderContent(),this.addCallbacks()}renderHeader(){const e=document.createElement("div");e.className="text-center mb-4 mx-6";const t=document.createElement("div");t.className="px-2 py-1 rounded-full bg-indigo-200 text-indigo-800 text-xs inline-block my-2",t.textContent="Available Early 2025";const s=document.createElement("img");s.className="mx-auto w-[160px] py-2",s.src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1724845304/model_logos/stbrandblack_lisjbt.svg";const i=document.createElement("h1");i.className="text-3xl font-black mb-2",i.textContent="AI Workspaces for Teams";const a=document.createElement("p");a.className="text-base py-2",a.textContent="You're invited to revolutionize the way your organization works, with a highly customizable AI workspace designed to make teams more productive.";const o=document.createElement("div");o.className="flex justify-center pt-4";const r=new n.$({text:"Register interest",size:"medium",type:"primary",width:"auto"});r.onClick((()=>{this.showRegisterInterestModal()})),r.render(o);const l=document.createElement("div");l.className="flex flex-col text-xs text-center text-gray-600 pt-2",l.textContent="Our pilot is now over. Register your interest to be the first to know when the AI workspace is available.",e.appendChild(t),e.appendChild(s),e.appendChild(i),e.appendChild(a),e.appendChild(o),e.appendChild(l),this.innerContainer.appendChild(e)}renderContent(){const e=document.createElement("div");e.className="flex flex-col gap-2";const t=document.createElement("div");t.className="grid grid-cols-2 gap-4 mt-6";["Shared workspaces for teams","Granular roles and permissions","Share agents across teams","Brand your entire AI workspace","Host on your own domain","Deploy agents to Slack & Teams","AI workspace training program","Bulk team management, SSO, adoption analytics","Access to all selected AI models","Create & share skills with your team"].forEach((e=>{const s=document.createElement("div");s.className="flex justify-center items-center align-middle p-4 border border-gray-200 rounded-md text-center h-[100px] font-bold",s.textContent=e,t.appendChild(s)})),e.appendChild(t),this.innerContainer.appendChild(e);const s=document.createElement("div");s.classList="h-8",s.innerHTML="&nbsp;",this.innerScrollView.appendChild(s)}addCallbacks(){}showRegisterInterestModal(){this.modalConfig={size:"medium",title:"Register your internet",closeX:!0,confirmOnExit:!0,confirm:!0,confirmText:"Submit",cancel:!1,buttonWidth:"full",buttonStyleConfirm:"ringPrimary",buttonSize:"large",body:this.createForm(),validationFunction:()=>this.business.validate()&&this.position.validate()&&this.useCase.validate()&&this.orgSize.validate()&&this.phone.validate()&&this.description.validate()},this.registerForm=new l(this.modalConfig),this.registerForm.onConfirm((()=>{this.sendRegistration()}))}createForm(){const e=document.createElement("div");e.classList="flex flex-col gap-3",e.id="register-form";const t=document.createElement("div");t.classList=`${i.A.theme.text} text-base`,t.innerHTML="Thanks for your interest in the AI workspace. Complete the form and we will be in touch soon.",e.appendChild(t),this.business=new d({label:"Organization name:",placeholder:"e.g. Acme Inc.",type:"text",minChar:2,maxChar:150,required:!0,error:"Organization is required",helpText:"Please enter your organization name",value:""}),this.business.render(e),this.position=new d({label:"Position at organization:",placeholder:"e.g. Operations",type:"text",minChar:2,maxChar:350,required:!0,error:"Position is required",helpText:"Please enter your position",value:""}),this.position.render(e),this.useCase=new E({label:"Organization type",placeholder:"Select organization type",value:"",required:!0,disabled:!1,readonly:!1,error:"Please select an organization type",options:[{value:"enterprise",label:"Enterprise"},{value:"team",label:"Team"},{value:"educational",label:"Educational"},{value:"not-for-profit",label:"Not-for-profit"},{value:"family",label:"Family"},{value:"government",label:"Government"},{value:"startup",label:"Startup"},{value:"small-business",label:"Small Business"},{value:"healthcare",label:"Healthcare"},{value:"research",label:"Research Institution"},{value:"other",label:"Other"}]}),this.useCase.render(e),this.orgSize=new E({label:"Workspace seats:",placeholder:"Select number of seats",value:"",required:!0,disabled:!1,readonly:!1,error:"Please select the number of seats",options:[{value:"1-10",label:"1-10 seats"},{value:"11-50",label:"11-50 seats"},{value:"51-200",label:"51-200 seats"},{value:"201-500",label:"201-500 seats"},{value:"501-1000",label:"501-1000 seats"},{value:"1000+",label:"100+ seats"}]}),this.orgSize.render(e),this.phone=new d({label:"Best contact number:",placeholder:"e.g. +1 310 745 1001",type:"phone",minChar:10,maxChar:150,required:!0,error:"Please enter a valid phone number",helpText:"Please enter your organization email",value:""}),this.phone.render(e),this.description=new p({label:"Goal for workspace:",type:"text",placeholder:"What do you hope to achieve with the AI workspace?",rows:4,canGrow:!0,minChar:2,maxChar:1e4,required:!0,error:"Description is required",helpText:"Please enter a description",value:this.body}),this.description.render(e);const s=()=>{n&&a&&o&&r&&l&&c?(this.registerForm.hasUnSavedChanges(!0),this.registerForm.waitingOnData(!1)):this.registerForm.waitingOnData(!0)};let n=!1;this.business.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),n=this.business.value.length>=2,s()}));let a=!1;this.position.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),a=this.position.value.length>=2,s()}));let o=!1;this.useCase.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),o=""!==this.useCase.value,s()}));let r=!1;this.orgSize.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),r=""!==this.orgSize.value,s()}));let l=!1;this.phone.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),l=this.phone.value.length>=10,s()}));let c=!1;return this.description.onChange((()=>{this.registerForm.hasUnSavedChanges(!0),c=this.description.value.length>=2,s()})),e}compilePayload(){return{business:this.business.value,position:this.position.value,useCase:this.useCase.value,orgSize:this.orgSize.value,phone:this.phone.value,description:this.description.value}}async sendRegistration(){const e=this.compilePayload();new c.y("Thanks for your interest! We'll be in touch soon.","success"),this.registerForm.hasUnSavedChanges(!1);await g.G.postData("/chat/workspace-interest/",e)}}var Fe=s(69661),Re=s(8352);class He{static#e=null;static#t=!1;static#s=!1;constructor(e){if(this.id="coloris-"+Math.random().toString(36).substr(2,9),this.config=e,this.inputContainer=null,this.inputField=null,this.label=null,this.theme=i.A.theme,this.width=e.width||null,this.onChangeCallback=null,this.validate=this.validate.bind(this),this.initialValue=e.value||"",this.showResetButton=e.showResetButton||!1,!He.#s){const e=document.createElement("style");e.textContent="\n                .clr-field {\n                    border-radius: 0.375rem !important;\n                    overflow: hidden !important;\n                    display: inline-block !important;\n                    position: relative !important;\n                }\n                \n                .clr-field button {\n                    width: 40px !important;\n                    border-radius: 0.375rem 0.375rem 0.375rem 0.375rem !important;\n                    margin: 0 !important;\n                    position: absolute !important;\n                    right: 6px !important;\n                    top: 24px !important;\n                    bottom: 0 !important;\n                    height: 38px !important;\n                    z-index: 2 !important;\n                    display: flex !important;\n                    align-items: stretch !important;\n                    padding: 0 !important;\n                }\n                \n                .clr-field button span {\n                    width: 100% !important;\n                    height: auto !important;\n                    display: block !important;\n                    flex: 1 !important;\n                }\n                \n                .clr-field input {\n                    border-radius: 0.375rem !important;\n                    padding-right: 45px !important;\n                }\n\n                .color-picker-wrapper {\n                    display: flex;\n                    align-items: flex-end;\n                    gap: 0.5rem;\n                }\n            ",document.head.appendChild(e),He.#s=!0}this.init()}async init(){Re.Ay.init(),this.inputContainer=document.createElement("div"),this.inputContainer.classList.add("space-y-1"),this.config.label&&(this.label=document.createElement("label"),this.label.classList=`${this.theme.text} truncate`,this.label.textContent=this.config.label,this.label.setAttribute("for",this.id),this.inputContainer.appendChild(this.label));const e=document.createElement("div");this.inputField=document.createElement("input"),this.inputField.type="text",this.inputField.id=this.id,this.inputField.setAttribute("data-coloris",this.id),this.inputField.placeholder=this.config.placeholder||"Select color",this.inputField.value=this.config.value||"",this.inputField.required=!!this.config.required,this.inputField.disabled=!!this.config.disabled,this.inputField.readOnly=!!this.config.readonly;let t=`rounded-md ring-1 ring-inset ${this.theme.inputRing} ${this.theme.inputBackground} ${this.theme.inputText} focus:outline-none focus:ring-2 focus:ring-inset ${this.theme.inputFocus} ${this.theme.placeholderText} appearance-none border-0`;"small"===this.config.size?t+=" px-2 py-1 text-sm":t+=" px-3 py-3",this.width?this.inputField.style.width=this.width:t+=" w-full",this.inputField.className=t;const s=document.createElement("div");if(s.classList.add("relative"),s.appendChild(this.inputField),e.appendChild(s),this.showResetButton&&this.initialValue){const t=document.createElement("button");t.type="button",t.classList.add("inline-flex","items-center","text-sm","font-medium","rounded-md",this.theme.buttonSecondaryBackground,this.theme.buttonSecondaryText,this.theme.buttonSecondaryHover,this.theme.buttonSecondaryFocus);const s=document.createElement("i");s.classList.add("fas","fa-clock-rotate-left"),t.appendChild(s);const i=document.createElement("span");i.textContent=" Reset",i.classList.add("ml-1"),t.appendChild(i),t.setAttribute("title","Reset to default color"),t.addEventListener("click",(()=>this.resetToDefault())),e.appendChild(t)}this.inputContainer.appendChild(e)}resetToDefault(){if(this.initialValue){this.inputField.value=this.initialValue;const e=this.inputField.parentElement.querySelector("button");if(e){const t=e.querySelector("span");t&&(t.style.backgroundColor=this.initialValue)}const t=new Event("input",{bubbles:!0});this.inputField.dispatchEvent(t);const s=new Event("change",{bubbles:!0});this.inputField.dispatchEvent(s),this.config.onChange&&this.config.onChange(this.initialValue),this.onChangeCallback&&this.onChangeCallback(this.initialValue)}}render(e){e&&(e.appendChild(this.inputContainer),setTimeout((()=>{Re.Ay&&((0,Re.Ay)({el:`[data-coloris="${this.id}"]`,theme:this.config.theme||"default",themeMode:this.config.themeMode||"light",format:this.config.format||"hex",alpha:this.config.alpha||!1,focusInput:!1,clearButton:!1,closeButton:this.config.closeButton||!1,swatches:this.config.swatches||["#264653","#2a9d8f","#e9c46a","#f4a261","#e76f51"],...this.config.colorisOptions,onChange:e=>{this.config.onChange&&this.config.onChange(e),this.onChangeCallback&&this.onChangeCallback(e)}}),"function"==typeof this.config.onChange&&this.inputField.addEventListener("change",(e=>{this.config.onChange(e.target.value)})))}),100))}validate(){if(!this.config.required&&0===this.inputField.value.length)return!0;if(this.config.required&&0===this.inputField.value.length)return new c.y(this.config.error||"Color is required","error",!0,!0),!1;const e=this.inputField.value;return!(!/^#([A-Fa-f0-9]{6}|[A-Fa-f0-9]{3})$/.test(e)&&!/^rgba?\(\s*\d+\s*,\s*\d+\s*,\s*\d+\s*(,\s*\d*\.?\d+\s*)?\)$/.test(e))||(new c.y("Please enter a valid color format","error",!0,!0),!1)}onChange(e){"function"==typeof e&&(this.onChangeCallback=e,this.inputField.addEventListener("change",(e=>{this.onChangeCallback(e.target.value)})))}disable(){this.inputField.disabled=!0}enable(){this.inputField.disabled=!1}focus(){this.inputField.focus()}get value(){return this.inputField.value}set value(e){this.inputField.value=e;const t=new Event("change",{bubbles:!0});this.inputField.dispatchEvent(t)}}const Oe={light:{name:"Light usage",values:{input:7e6,output:1e6,images:110}},medium:{name:"Medium usage",values:{input:12e6,output:2e6,images:250}},high:{name:"High usage",values:{input:6e7,output:8e6,images:1200}}};class qe{constructor(e,t){!1!==u.K.hasPermission("workspace:read")?(this.theme=i.A.theme,this.slug=e,this.initialRoute=t,this.tableIndex=null,this.tableConfig=null,this.tableData=null,this.currentColumnOrder=null,this.currentSortOrder=null,this.endOfData=!1,this.currentSearchTerm="",this.PAGESIZE=100,this.initialLoadDone=!1,this.currentFilter="all",this.workspace=null,this.contentContainer=null,this.membersTable=null,this.teamsTable=null,this.rolesTable=null,this.modelsTable=null,this.skillsTable=null,this.themesTable=null,this.assistantsTable=null,this.sessionsChart=null,this.messagesChart=null,this.modelsChart=null,this.skillsChart=null,this.tabs=null,this.filterButton=null,this.exportButton=null,this.filters={},this.inviteModal=null,this.addTeamModal=null,this.roleModal=null,this.themeColorPickers={},this.advancedThemeColors={mainBackground:null,hoverBackground:null},this.tabControl=null,this.billingData=null,this.autoRechargeUpdateTimeout=null):v.view("/chat")}async getWorkspace(e){try{const t=await y.a.getWorkspace(e);if(this.workspace=t,!this.workspace||!this.workspace.name)throw new Error(this.workspace?.error||"You don't have permission to manage this workspace.");this.createInitialView()}catch(e){throw e}}async init(e,t,s){if(!e||!t)return new c.y("Cannot load workspace admin.","error"),void v.view("/chat/workspaces");this.container=e,this.slug=t,this.initialRoute=s,this.container.innerHTML="";try{await this.getWorkspace(this.slug)}catch(e){}}createInitialView(){this.workspace&&(this.render(),this.navigateToSection(this.initialRoute))}navigateToSection(e){const t=e||"setup";if(this.contentContainer){switch(t){case"members":this.renderWorkspaceMembers();break;case"teams":this.renderWorkspaceTeams();break;case"roles":this.renderWorkspaceRoles();break;case"models":this.renderWorkspaceModels();break;case"themes":this.renderWorkspaceThemes();break;case"mcps":this.renderWorkspaceMCPs();break;case"skills":this.renderWorkspaceSkills();break;case"settings":this.renderWorkspaceSettings();break;case"assistants":this.renderWorkspaceAssistants();break;case"analytics":this.renderWorkspaceAnalytics();break;case"setup":this.completeSetup();break;case"logs":this.renderWorkspaceLogs();break;case"billing":this.renderWorkspaceBilling();break;case"support":this.renderWorkspaceSupport();break;default:this.initialRoute="setup",this.completeSetup(),t="setup"}this.updateMenuSelection(t)}}render(){if(!this.container)return;this.container.innerHTML="";const e=document.createElement("div");e.classList="flex flex-col w-full leading-7 py-2 mt-2 px-2 sm:px-4 h-full";const t=document.createElement("div");t.classList="flex gap-5 w-full h-full";const s=document.createElement("div");if(s.classList="w-[180px] flex-shrink-0 hidden sm:block overflow-y-auto h-full main-menu",this.workspace.image){const e=document.createElement("div");e.classList="flex pb-4 px-4",e.innerHTML=`<img src="${this.workspace.image}" class="rounded-lg w-16 h-16 workspace-image">`,s.appendChild(e)}else{const e=document.createElement("div");e.classList="flex pb-4 px-4";const t=o.A.name("buildings");e.innerHTML=`<div class="rounded-lg w-16 h-16 ${this.theme.workspaceDefaultIcon} flex justify-center align-middle items-center workspace-image-placeholder">\n                                        <svg viewBox="${t.viewBox}" class="w-7 h-7 fill-current" aria-hidden="true" focusable="false">\n                                            <path d="${t.path}"></path>\n                                        </svg>\n                                       </div>`,s.appendChild(e)}const i=document.createElement("div");i.classList="text-xl font-bold pb-2 px-4 w-[180px] block overflow-hidden whitespace-nowrap text-overflow-ellipsis truncate workspace-name",i.textContent=this.workspace.name,s.appendChild(i);const n=document.createElement("ul");n.classList="space-y-1 pt-4 menu-list",this.renderMenuItems(n),s.appendChild(n),t.appendChild(s);const a=document.createElement("div");a.classList="flex-1 min-h-0 relative overflow-hidden",this.contentContainer=document.createElement("div"),this.contentContainer.classList="flex flex-col w-full h-full",a.appendChild(this.contentContainer),t.appendChild(a),e.appendChild(t),this.container.appendChild(e);const r=this.container.querySelector(".menu-list");r&&this.renderMenuItems(r)}renderMenuItems(e){const t=document.querySelector(".menu-list");t&&(t.innerHTML="",e=t);const s=[{name:"Analytics",value:"analytics",active:!0,family:!0,has_permission:"workspace:analytics"},{name:"Members",value:"members",active:!1,family:!0,has_permission:"workspace:add-members"},{name:"Teams",value:"teams",active:!1,family:!1,has_permission:"workspace:add-remove-team"},{name:"Roles",value:"roles",active:!1,family:!0,has_permission:"workspace:assign-role"},{name:"Logs",value:"logs",active:!1,family:!1,has_permission:"workspace:logs"},{name:"Theme",value:"themes",active:!1,family:!0,has_permission:"workspace:theme"},{name:"Assistants",value:"assistants",active:!1,has_permission:"workspace:manage-assistants"},{name:"MCPs",value:"mcps",active:!1,family:!0,has_permission:"workspace:manage-mcps"},{name:"Models",value:"models",active:!1,family:!0,has_permission:"workspace:manage-models"},{name:"Skills",value:"skills",family:!0,active:!1,has_permission:"workspace:manage-skills"},{name:"Billing",value:"billing",active:!1,family:!0,has_permission:"workspace:billing"},{name:"Settings",value:"settings",active:!1,family:!0,has_permission:"workspace:settings"},{name:"Support",value:"support",active:!1,family:!1}];this.workspace.getting_started&&s.unshift({name:"Getting started",value:"setup",active:!1,family:!0,has_permission:"workspace:read"});if(!s.some((e=>u.K.hasPermission(e.has_permission))))return new c.y("You don't have any valid adminstrative permissions for this workspace. Contact you workspace admin.","info"),void v.view("/chat/workspace");if(!this.initialRoute)for(let e=0;e<s.length;e++)if(u.K.hasPermission(s[e].has_permission)){this.initialRoute=s[e].value;break}s.forEach((e=>{e.active=e.value===this.initialRoute})),s.forEach((t=>{if(t.has_permission&&!u.K.hasPermission(t.has_permission))return;if(!t.family&&("family"==this.workspace.plan_type||"family_max"==this.workspace.plan_type))return;const s=document.createElement("li");s.id="menu-item-"+t.value,s.innerHTML=`<div class="px-4">${t.name}</div>`,s.classList=t.active?`cursor-pointer py-1 rounded-lg ${this.theme.menuSelectedItem}`:`cursor-pointer py-1 rounded-lg hover:${this.theme.secondaryBackground} `,s.onclick=()=>this.menuClick(t.value),e.appendChild(s)}))}updateMenuSelection(e){document.querySelector(".main-menu").querySelectorAll("li").forEach((t=>{const s=t.id.replace("menu-item-","");t.classList=s===e?`cursor-pointer py-1 rounded-lg ${this.theme.menuSelectedItem}`:`cursor-pointer py-1 rounded-lg hover:${this.theme.secondaryBackground}`}))}menuClick(e){const t=e&&"setup"!==e?`/chat/workspace/admin/${e}`:"/chat/workspace/admin";window.history.pushState({},`${this.workspace.name} ${e}`,t),document.title=`${this.workspace.name} ${e}`,this.navigateToSection(e)}completeSetup(){this.contentContainer.innerHTML='\n        <div class="flex flex-col w-full items-center leading-7 pb-2 gap-2 mt-0 sm:mt-4 px-0.5 overflow-y-auto h-full">\n            <div class="w-full max-w-4xl">\n                <div class="flex justify-center mt-2 mb-6">\n                    <div id="tabs-container"></div>\n                </div>\n                <div class="flex justify-center text-3xl tracking-tight mb-4 setup-title">Let\'s get your workspace setup:</div>\n                <div id="tab-content" class="w-full pb-10"></div>\n            </div>\n        </div>';const e=this.contentContainer.querySelector("#tabs-container"),t=this.contentContainer.querySelector("#tab-content"),s={tabs:[{title:"Setup",value:"setup",selected:!0},{title:"Tutorials",value:"tutorials",selected:!1}],onTabChange:e=>this.handleTabChange(e,t)};this.tabs=new w(s),this.tabs.render(e),this.handleTabChange("setup",t)}handleTabChange(e,t){(t||(t=this.contentContainer.querySelector("#tab-content")))&&(t.innerHTML="","setup"===e?this.renderSetupContent(t):"tutorials"===e&&this.renderTutorialsContent(t))}renderSetupContent(e){let t=[];t.push({title:"family"===this.workspace.plan_type||"family_max"===this.workspace.plan_type?"Add your family members":"Invite team members",description:"family"===this.workspace.plan_type||"family_max"===this.workspace.plan_type?"Invite your family to your workspace by email.":"Share an invite, mass add team members or send individual invites.",icon:"users",button:"Invite members",action:"members",completed:this.workspace.members>1,tipTitle:"How to invite team members",tipVideo:"https://youtu.be/cl-atZCdLKg",tipContent:'\n                <div class="space-y-4">\n                    <p>Inviting team members is easy! You can:</p>\n                    <ul class="list-disc pl-5 space-y-2">\n                        <li>Send individual email invites</li>\n                        <li>Bulk import members with comma seperated emails</li>\n                        <li>Allow members to join automatically with their work email</li>\n                    </ul>\n                    <p>Team members will receive an email with instructions to join your workspace. To enable auto-join with a verified work email navigate to settings and enable this feature.</p>\n                </div>\n            '}),"family"!==this.workspace.plan_type&&t.push({title:"Add your brand and favicon",description:"Upload your brand and a custom favicon",icon:"paintbrushPencil",button:"Add brand",action:"settings",completed:this.workspace.brand&&this.workspace.favicon,tipTitle:"Customizing Your Brand",tipVideo:"https://youtu.be/btFayF-rjP8",tipContent:'\n                    <div class="space-y-4">\n                        <p>Make your workspace your own by adding your brand elements:</p>\n                        <ul class="list-disc pl-5 space-y-2">\n                            <li>Upload your company logo</li>\n                            <li>Add a custom favicon that appears in browser tabs</li>\n                            <li>Choose brand colors that match your identity</li>\n                        </ul>\n                        <p>Your brand will appear throughout the workspace, creating a consistent experience.</p>\n                    </div>\n                '}),"family"!==this.workspace.plan_type&&t.push({title:"Create & assign teams",description:"Create specialist teams for marketing, sales, and finance.",icon:"users",button:"Create a team",action:"teams",completed:this.workspace.has_teams>0,tipTitle:"How to create a team",tipVideo:"https://youtu.be/Y20yFoxXpyc",tipContent:'\n                    <div class="space-y-4">\n                        <p>Teams help organize your workspace members by department or function:</p>\n                        <ul class="list-disc pl-5 space-y-2">\n                            <li>Create teams for different departments (Marketing, Sales, etc.)</li>\n                            <li>Assign members to one or multiple teams</li>\n                            <li>Set team permissions and access levels</li>\n                        </ul>\n                        <p>Teams make it easier to manage permissions and share resources with specific groups.</p>\n                        <div class="mt-2">\n                            <img src="/static/images/tips/teams-management.png" alt="Teams management screenshot" class="rounded-md w-full">\n                        </div>\n                    </div>\n                '});const s=o.A.name("ellipsis"),i=`<svg viewBox="${s.viewBox}" class="w-4 h-4 fill-current inline-block mx-1"><path d="${s.path}"></path></svg>`;t.push({title:"Create and set a default assistant",description:"Create, share and set a default assistant for your workspace",icon:"userCircle",button:"Set default assistant",action:"settings",completed:"Simtheory"!==this.workspace.default_assistant.name,tipTitle:"Creating default assistant",tipVideo:"https://youtu.be/mRwEqeR5st0",tipContent:`\n                <div class="space-y-4">\n                    <p>By default Simtheory is the default assistant. This can be changed by creating and sharing an assistant then setting that assistant as default.</p>\n                    <p>Steps to create a default assistant:</p>\n                    <ul class="list-decimal pl-5 space-y-2">\n                        <li>Create an assistant (if you haven't already)</li>\n                        <li>In the assistants menu click the ${i} and select Share</li>\n                        <li>Set the sharing permission to Workspace</li>\n                        <li>In your workspace setttings click "Change" next to Default workspace assistant</li>\n                        <li>Select the assistant you shared</li>\n                    </ul>\n                    <p>This will set the default assistant all members of the workspace when they start a new session if they have not previously selected an assistant.</p>\n                </div>\n            `}),"family"!==this.workspace.plan_type&&t.push({title:"Setup a custom workspace domain",description:"Host your workspace on your domain e.g. chat.yourbusiness.com",icon:"globe",button:"Setup domain",action:"settings",completed:this.workspace.custom_domain,tipTitle:"Setting up a custom domain",tipVideo:"https://youtu.be/tGPDaZ6M_ic",tipContent:'\n                    <div class="space-y-4">\n                        <p>Use your own domain for your workspace:</p>\n                        <ul class="list-disc pl-5 space-y-2">\n                            <li>Configure a subdomain like chat.brand.com</li>\n                            <li>Set up DNS records with your domain provider</li>\n                            <li>Verify domain ownership and activate SSL</li>\n                        </ul>\n                        <p>A custom domain makes accessing your workspace easier for your team.</p>\n                    </div>\n                '}),t.push({title:"Create a custom theme",description:"family"!==this.workspace.plan?"Design a theme that matches your brand identity":"Design a custom theme for your family",icon:"paintbrushPencil",button:"Create new theme",action:"theme",completed:this.workspace.has_created_theme,tipTitle:"Creating a theme",tipVideo:"https://youtu.be/HcNN2nlTOlM",tipContent:'\n                <div class="space-y-4">\n                    <p>You can create a custom theme and then set that theme as default. Depending on your workspace permissions you can enforce this theme or allow members to select from enabled themes. To do this:</p>\n                    <ul class="list-disc pl-5 space-y-2">\n                        <li>Create a new theme</li>\n                        <li>Test the theme by switching to it</li>\n                        <li>Adjust the theme as required in advanced mode</li>\n                    </ul>\n                    <p>Once a theme is created you can adjust individual colors and parameters. By default members cannot switch themes and are forced to the workspace default.</p>\n                </div>\n            '});const l=[...t.filter((e=>!e.completed)),...t.filter((e=>e.completed))],c=t.filter((e=>e.completed)).length/t.length*100;let d="Setup progress";if(100===c){d="Setup complete!";const e=document.querySelector(".setup-title");if(e){e.innerHTML="",e.classList="flex flex-col justify-center";const t=document.createElement("div");t.classList="flex text-3xl tracking-tight mb-1 justify-center",t.textContent=" Congratulations, you're all setup!";const s=document.createElement("div");s.classList="flex justify-center";const i=new n.$({text:"Hide Getting started",type:"link",size:"small",width:"auto"});i.render(s),e.appendChild(t),e.appendChild(s),i.onClick((()=>{new a("Are you sure?","Getting started will no longer be accessible in the menu. To bring it back you will need to go to settings and enable it.").onConfirm((()=>{y.a.setGettingStarted(!1),this.workspace.getting_started=!1,this.menuClick("analytics");const e=document.getElementById("menu-item-setup");e&&e.remove()}))}))}}e.innerHTML=`            \n            <div class="mt-2 mb-4 w-full">\n                <div class="flex justify-between text-sm mb-1">\n                    <span>${d}</span>\n                    <span>${Math.round(c)}% complete</span>\n                </div>\n                <div class="w-full h-4 ${this.theme.sliderRailColor||"bg-gray-300"} rounded-full overflow-hidden">\n                    <div class="h-full ${this.theme.progressBarBackground||"bg-indigo-600"} rounded-full" style="width: ${c}%"></div>\n                </div>\n            </div>\n            \n            <div class="flex flex-col gap-3 mt-2 w-full">\n                ${l.map(((e,t)=>`\n                    <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor} ${e.completed?"opacity-50":""}">\n                        <div class="flex justify-between gap-4 items-center align-middle">\n                            <div class="flex gap-3 align-middle items-center">\n                                <div id="tip-icon-${t}" class="flex items-center align-middle justify-center ${this.theme.secondaryBackground} rounded-full p-0.5 w-10 h-10">\n                                </div>\n                                <div>\n                                    <div class="text-bold text-lg">${e.title}</div>\n                                    <div class="text-sm ${this.theme.fadedText}">${e.description}</div>\n                                </div>\n                            </div>\n                            <div class="button-container-${t}"></div>\n                        </div>\n                    </div>\n                `)).join("")}\n            </div>\n        `,l.forEach(((e,t)=>{const s=document.getElementById(`tip-icon-${t}`);if(s){const t=e.completed?"check":e.icon,i=o.A.name(t);new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-5 h-5",colorClass:e.completed?"text-green-500":""}).render(s)}const i=new n.$({text:e.button,type:"primaryTransparent",size:"small",width:"auto"});i.onClick((()=>{this.showTipModal(e)}));const a=document.querySelector(`.button-container-${t}`);a&&i.render(a)}))}showTipModal(e){let t="";if(e.tipVideo){let s=e.tipVideo;if(s.includes("youtube.com")||s.includes("youtu.be")){let e;s.includes("youtu.be")?e=s.split("/").pop():s.includes("watch?v=")&&(e=new URL(s).searchParams.get("v")),e&&(s=`https://www.youtube.com/embed/${e}?si=P_TMKjKKSdGDJOlY`)}t+=`\n                <div class="mb-6 mt-2">\n                    <div class="relative w-full" style="padding-top: 56.25%;">\n                        <iframe \n                            src="${s}" \n                            title="YouTube video player" \n                            frameborder="0" \n                            allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" \n                            referrerpolicy="strict-origin-when-cross-origin" \n                            allowfullscreen\n                            class="absolute top-0 left-0 w-full h-full rounded-md"\n                        ></iframe>\n                    </div>\n                </div>\n            `}t+=e.tipContent;new l({size:"medium",title:e.tipTitle,body:t,closeX:!0,confirm:!0,confirmText:"Got it, let's go!",buttonWidth:"full",buttonStyleConfirm:"primary",buttonSize:"large"}).onConfirm((()=>{this.menuClick(e.action)}))}renderTutorialsContent(e){const t=[{title:"Inviting team members",description:"Learn how to send individual invites, bulk import members, or enable auto-join with work email",videoURL:"https://youtu.be/cl-atZCdLKg",thumbnail:"https://res.cloudinary.com/dimqqmfx6/image/upload/f_auto,q_auto/v1/assets/tutorial%20videos/l5zmilc4mjt4kw7uo8ff"},{title:"Customizing Your Brand",description:"Upload your company logo, add a custom favicon, and choose brand colors that match your identity",videoURL:"https://youtu.be/btFayF-rjP8",thumbnail:"https://img.youtube.com/vi/btFayF-rjP8/maxresdefault.jpg"},{title:"Creating and managing teams",description:"Organize workspace members by department, assign members to teams, and set team permissions",videoURL:"https://youtu.be/Y20yFoxXpyc",thumbnail:"https://img.youtube.com/vi/Y20yFoxXpyc/maxresdefault.jpg"},{title:"Creating a default assistant",description:"Learn how to create, share and set a custom default assistant for your workspace",videoURL:"https://youtu.be/mRwEqeR5st0",thumbnail:"https://img.youtube.com/vi/mRwEqeR5st0/maxresdefault.jpg"},{title:"Setting up a custom domain",description:"Configure a subdomain, set up DNS records, and verify domain ownership for your workspace",videoURL:"https://youtu.be/tGPDaZ6M_ic",thumbnail:"https://img.youtube.com/vi/tGPDaZ6M_ic/maxresdefault.jpg"},{title:"Creating a custom theme",description:"Design a theme that matches your brand identity and set it as the default for your workspace",videoURL:"https://youtu.be/HcNN2nlTOlM",thumbnail:"https://img.youtube.com/vi/HcNN2nlTOlM/maxresdefault.jpg"},{title:"Managing your billing",description:"Demonstration of adding and removing seats and modifying billing",videoURL:"https://youtu.be/rNqmbJ9Y3nk",thumbnail:"https://img.youtube.com/vi/rNqmbJ9Y3nk/maxresdefault.jpg"}];e.innerHTML=`\n            <div class="text-xl tracking-tight mb-4">Tutorials</div>\n            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">\n                ${t.map(((e,t)=>`\n                    <div class="flex flex-col rounded-md overflow-hidden ring-1 ${this.theme.ringColor}">\n                        <div class="relative pb-[56.25%] cursor-pointer video-thumbnail" \n                             data-video-id="${e.videoId||""}" \n                             data-video-url="${e.videoURL||""}">\n                            <img src="${e.thumbnail}" alt="${e.title}" class="absolute inset-0 w-full h-full object-cover">\n                            <div class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-20 hover:bg-opacity-30 transition-opacity">\n                                <div class="w-16 h-16 rounded-full bg-white bg-opacity-80 flex items-center justify-center">\n                                    <div id="play-icon-${t}"></div>\n                                </div>\n                            </div>\n                        </div>\n                        <div class="p-4">\n                            <h3 class="font-medium text-lg mb-1">${e.title}</h3>\n                            <p class="text-sm leading-5 ${this.theme.fadedText}">${e.description}</p>\n                        </div>\n                    </div>\n                `)).join("")}\n            </div>\n        `,t.forEach(((e,t)=>{const s=document.getElementById(`play-icon-${t}`);if(s){const e=o.A.name("play");new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-5 h-5",colorClass:this.theme.accentText}).render(s)}})),document.querySelectorAll(".video-thumbnail").forEach((e=>{e.addEventListener("click",(()=>{const t=e.getAttribute("data-video-id"),s=e.getAttribute("data-video-url");this.openVideoModal(t,s)}))}))}openVideoModal(e,t){const s=document.createElement("div");s.classList="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-75";let i="";if(t){if(t.includes("youtube.com")||t.includes("youtu.be")){let e;t.includes("youtu.be")?e=t.split("/").pop():t.includes("watch?v=")&&(e=new URL(t).searchParams.get("v")),e&&(i=`https://www.youtube.com/embed/${e}?si=P_TMKjKKSdGDJOlY&autoplay=1`)}}else e&&(i=`https://www.youtube.com/embed/${e}?si=P_TMKjKKSdGDJOlY&autoplay=1`);s.innerHTML=`\n            <div class="relative w-full max-w-3xl mx-4">\n                <div class="absolute top-4 right-4 z-10">\n                    <button id="close-video-modal" class="p-2 rounded-full bg-black bg-opacity-50 text-white hover:bg-opacity-70 transition-colors flex items-center justify-center">\n                        \x3c!-- SVG will be inserted here --\x3e\n                    </button>\n                </div>\n                <div class="relative pb-[56.25%] bg-black rounded-lg overflow-hidden">\n                    <iframe \n                        src="${i}" \n                        class="absolute inset-0 w-full h-full" \n                        title="YouTube video player" \n                        frameborder="0" \n                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" \n                        referrerpolicy="strict-origin-when-cross-origin" \n                        allowfullscreen>\n                    </iframe>\n                </div>\n            </div>\n        `;const n=s.querySelector("#close-video-modal");if(n){const e=o.A.name("xmark"),t=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:"w-5 h-5"});t.element&&n.appendChild(t.element)}document.body.appendChild(s),document.getElementById("close-video-modal").addEventListener("click",(()=>{document.body.removeChild(s)})),s.addEventListener("click",(e=>{e.target===s&&document.body.removeChild(s)}))}showTableLoadingState(){this.contentContainer.innerHTML="",Se.renderLoadingState(this.contentContainer,this.tableConfig||{tableColumns:[{value:"name",name:"Name"},{value:"status",name:"Status"},{value:"role",name:"Role"},{value:"email",name:"Email"},{value:"actions",name:"Actions"}]},"table",!0)}async getMemberData(){await y.a.getMembers(this.workspace.slug).then((e=>{this.workspace.members=e.members}))}async renderWorkspaceMembers(){u.K.hasPermission("workspace:add-members")?(this.contentContainer.innerHTML="",this.showTableLoadingState(),await this.getMemberData(),await y.a.getMembers(this.workspace.slug).then((e=>{this.tableConfig=e.tableConfig,this.tableData=e.tableData})),this.membersTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.membersTable.setCallbacks({loadMore:this.loadMembers.bind(this),onFilterChange:this.handleMemberFilterChange.bind(this),onSort:this.handleMemberSort.bind(this),onCreate:this.handleInviteMember.bind(this),onAction:this.handleMemberAction.bind(this)}),this.membersTable.render()):new c.y("You don't have permission to manage workspace members. Speak to your workspace administrator","info")}async loadMembers(e=1,t=100,s="name",i="asc",n="",a="all"){return(await y.a.getMembers(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a})).tableData}handleMemberFilterChange(e,t){this.membersTable.loadData()}handleMemberSort(e){this.membersTable.loadData()}handleInviteMember(){this.inviteMode="manual";const e=e=>/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e),t=()=>{if(this.inviteModal.hasUnSavedChanges(!0),"manual"===this.inviteMode&&this.inputFields){const t=this.inputFields.querySelectorAll("input"),s=Array.from(t).some((t=>e(t.value.trim())));this.inviteModal.waitingOnData(!s)}else if("bulk"===this.inviteMode){const t=s.querySelector("textarea");if(t){const s=t.value.split(/[\s,]+/).some((t=>e(t.trim())));this.inviteModal.waitingOnData(!s)}else this.inviteModal.waitingOnData(!0)}},s=document.createElement("div");s.classList="flex flex-col py-3";const i=()=>{this.inviteMode="bulk",s.innerHTML="";const e=document.createElement("div");e.classList="text-base pb-4",e.textContent="Copy and paste a list of email addresses to send bulk invites. Seperate with a comma or new line.",s.appendChild(e);const i=new p({label:"",type:"text",placeholder:"firstuser@company.com, seconduser@company.com",rows:6,canGrow:!0,value:"",minChar:10,maxChar:5e5,required:!0,disabled:!1,readonly:!1,error:"Email addresses are required",helpText:"Please enter email addresses separated by a comma or new line."});i.render(s);const l=new n.$({text:"Back to manual",type:"link",svgPathData:o.A.name("chevronLeft").path,svgViewBox:o.A.name("chevronLeft").viewBox,size:"link-sm",width:"auto"}),c=document.createElement("div");c.classList="flex justify-start",l.onClick((()=>{if(i.value=i.value.trim(),i.value.length>0){new a("Are you sure?","Emails entered will be lost!").onConfirm((()=>{r(),t()}))}else r(),t()})),l.render(c),s.appendChild(c),i.onChange((()=>{t()})),setTimeout((()=>{i.focus()}),0)},r=()=>{this.inviteMode="manual",s.innerHTML="";const e=document.createElement("div");e.classList="text-base pb-4",e.textContent="Each team member will receive an email invitation to join your workspace.",s.appendChild(e),this.inputFields=document.createElement("div"),this.inputFields.classList="flex flex-col gap-2",s.appendChild(this.inputFields);for(let e=0;e<3;e++){const e=new d({label:"",placeholder:"person@yourbusiness.com",required:!0});e.render(this.inputFields),e.onChange(t)}const a=document.createElement("div");a.classList="flex justify-between pt-4";const r=new n.$({text:"Add another",type:"link",svgPathData:o.A.name("plus").path,svgViewBox:o.A.name("plus").viewBox,size:"link-md",width:"auto"}),l=new n.$({text:"Bulk add",type:"link",svgPathData:o.A.name("upload").path,svgViewBox:o.A.name("upload").viewBox,size:"link-md",width:"auto"});r.render(a),l.render(a),s.appendChild(a),r.onClick((()=>{const e=new d({label:"",placeholder:"person@yourbusiness.com",required:!0});e.render(this.inputFields),e.focus(),e.onChange(t)})),l.onClick((()=>{i(),t()})),setTimeout((()=>{this.inputFields&&this.inputFields.querySelector("input")&&this.inputFields.querySelector("input").focus()}),10)};r(),this.inviteModal=new l({size:"medium",title:"Invite members",closeX:!0,confirmOnExit:!0,confirmText:"Send invites",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:s}),this.inviteModal.waitingOnData(!0),t(),this.inviteModal.onConfirm((()=>{this.inviteModal.hasUnSavedChanges(!1);let t=[];if("manual"===this.inviteMode){const e=this.inputFields.querySelectorAll("input");t=Array.from(e).map((e=>e.value.trim()))}else{const e=s.querySelector("textarea");t=e.value.split(/[\s,]+/)}const i=t.some((t=>e(t.trim())));t=t.filter((e=>e.length>0));const n=t.length,a=1===n?"invite":"invites";if(i){this.inviteModal.hideConfirmCancelButtons(),this.inviteModal.hideCloseButton();const e=document.createElement("div");e.classList="text-center";const i=o.A.name("spinner");e.innerHTML=`\n                <div class="py-6 space-y-2">\n                    <div class="${this.theme.fadedText}">\n                        <svg viewBox="${i.viewBox}" class="w-16 h-16 fill-current animate-spin mx-auto" aria-hidden="true" focusable="false">\n                            <path d="${i.path}"></path>\n                        </svg>\n                    </div>\n                    <div class="text-lg font-bold">Sending ${n} ${a}...</div>\n                </div>\n                `,s.innerHTML="",s.appendChild(e),y.a.getAvailableSeats(this.workspace.slug,n).then((e=>{if(e.availableSeats>=n)this.addMembers(t);else{this.inviteModal.close();if(this.billingData.plan_name.toLowerCase().includes("family")){const e=new l({size:"medium",title:"",closeX:!0,confirm:!0,confirmText:"OK, got it",buttonWidth:"full",buttonSize:"large",cancel:!1,body:document.createElement("div")});e.body.innerHTML=`\n                                <div class="p-4 space-y-4 text-center ${this.theme.text}">\n                                    <div class="text-2xl font-bold">Seat limit reached</div>\n                                    <p>You've reached the member limit for the ${this.billingData.plan_name} plan. You cannot invite more members on this plan. You'll need to revoke an invite or remove a member to add someone else.</p>\n                                </div>\n                            `,e.onConfirm((()=>{e.close()}))}else{const e=new l({size:"medium",title:"",closeX:!0,confirm:!0,confirmText:"Upgrade plan",buttonWidth:"full",buttonSize:"large",cancel:!1,manualCloseOnConfirm:!0,body:document.createElement("div")});e.body.innerHTML=`\n                                <div class="p-4 space-y-4 text-center ${this.theme.text}">\n                                    <div class="text-2xl font-bold">Seat limit reached</div>\n                                    <p>You've reached the member limit for the ${this.billingData.plan_name} plan. You cannot invite more members on this plan. Upgrade your plan to invite more members to this workspace.</p>\n                                </div>\n                            `,e.onConfirm((()=>{e.toggleConfirmLoading(!0),window.location.href="/accounts/change-plan/"}))}}}))}else new c.y("Please enter at least one valid email address.","error")}))}async showSeatUpgradeForInvites(e,t){const s=document.createElement("div");s.classList="py-3";const i=o.A.name("spinner");s.innerHTML=`\n            <div class="gap-2 flex flex-col justify-center py-6">\n                <div class="${this.theme.fadedText} flex justify-center">\n                    <svg viewBox="${i.viewBox}" class="w-16 h-16 fill-current animate-spin" aria-hidden="true" focusable="false">\n                        <path d="${i.path}"></path>\n                    </svg>\n                </div>\n                <div class="text-lg font-bold flex justify-center">Loading plan information...</div>\n            </div>\n        `;const n=new l({size:"small",title:"Additional seats required",body:s,closeX:!0,confirm:!0,cancel:!1,confirmText:"Purchase seats",buttonWidth:"full",buttonStyle:"primary",buttonSize:"large",manualCloseOnConfirm:!0});n.disableConfirmButton();const a=await y.a.getSeatData(),r=a.total_seats+e,d=e=>e.toLocaleString("en-US",{style:"currency",currency:"USD"}),h=o.A.name("info"),m=o.A.name("file"),u=o.A.name("error");s.innerHTML=`\n            <div class="flex flex-col gap-4">\n                <div class="${this.theme.toastInfo} p-3 rounded-md text-sm">\n                    <div class="flex items-start">\n                        <div class="mr-2 pt-0.5">\n                            <svg viewBox="${h.viewBox}" class="w-4 h-4 fill-current" aria-hidden="true" focusable="false">\n                                <path d="${h.path}"></path>\n                            </svg>\n                        </div>\n                        <div>\n                            You need <strong>${e}</strong> more seat${e>1?"s":""} to invite \n                            ${t.length} new member${t.length>1?"s":""} to your workspace.\n                        </div>\n                    </div>\n                </div>\n                \n                <div class="font-bold">Current plan:</div>\n                <div class="${this.theme.secondaryBackground} rounded-md p-3">\n                    <ul class="list-inside list-disc ml-2 text-sm ${this.theme.fadedText}">\n                        <li>Business plan</li>\n                        <li>${a.total_seats} seats</li>\n                        <li>${d(19*a.total_seats*12)} per year</li>\n                    </ul>\n                </div>\n                \n                <div class="font-bold">New plan:</div>\n                <div class="${this.theme.secondaryBackground} rounded-md p-3">\n                    <ul class="list-inside list-disc ml-2 text-sm ${this.theme.fadedText}">\n                        <li>Business plan</li>\n                        <li>${r} seats</li>\n                        <li>${d(19*r*12)} per year</li>\n                    </ul>\n                </div>\n                \n                <div id="pro-rata-loading" class="p-3 rounded-md ${this.theme.toastInfo} flex items-center gap-2 text-sm">\n                    <svg viewBox="${i.viewBox}" class="w-4 h-4 fill-current animate-spin" aria-hidden="true" focusable="false">\n                        <path d="${i.path}"></path>\n                    </svg>\n                    <span>Calculating pro-rated amount...</span>\n                </div>\n                \n                <div id="pro-rata-content" class="hidden"></div>\n            </div>\n        `;try{const t=await y.a.getProRataAmount(e);if(!t.success)throw new Error(t.error||"Failed to calculate pro-rata amount");const s=t.pro_rata_amount,i=document.getElementById("pro-rata-content");i.innerHTML=`\n                <div class="p-3 rounded-md ${this.theme.toastSuccess}">\n                    <div class="font-semibold mb-1 text-sm">\n                        <div class="flex items-start">\n                            <div class="mr-2">\n                                <svg viewBox="${m.viewBox}" class="w-4 h-4 fill-current" aria-hidden="true" focusable="false">\n                                    <path d="${m.path}"></path>\n                                </svg>\n                            </div>\n                            <div>Summary of charges:</div>\n                        </div>\n                    </div>\n                    <ul class="list-disc pl-5 space-y-1 text-sm">\n                        <li><strong>Due today:</strong> ${d(s/100)} (prorated amount)</li>\n                        <li><strong>Next billing cycle:</strong> ${d(19*r*12)} per year</li>\n                    </ul>\n                </div>\n                \n                <div class="mt-2 text-xs ${this.theme.fadedText}">\n                    Applicable taxes will be calculated at checkout and will appear on your invoice. \n                    Your default payment method will be charged immediately upon confirmation.\n                </div>\n            `,document.getElementById("pro-rata-loading").classList.add("hidden"),i.classList.remove("hidden"),n.updateConfirmButtonText(`Purchase ${1===e?"seat":"seats"} (${d(s/100)})`),n.enableConfirmButton()}catch(e){document.getElementById("pro-rata-loading").innerHTML=`\n                <div class="text-red-500 flex items-center">\n                    <svg viewBox="${u.viewBox}" class="w-4 h-4 fill-current mr-2" aria-hidden="true" focusable="false">\n                        <path d="${u.path}"></path>\n                    </svg>\n                    Failed to calculate pro-rated amount. Please try again.\n                </div>\n            `}return new Promise(((t,s)=>{let i=!1;n.onConfirm((async()=>{try{n.updateConfirmButtonText("Processing..."),n.disableConfirmButton();const a=await y.a.updateSeatCount(r);if(a.success){i=!0,n.close();const s=1===e?"seat":"seats";new c.y(`Successfully added ${e} new ${s}`,"success"),t(!0)}else n.enableConfirmButton(),n.updateConfirmButtonText("Purchase seats"),new c.y(a.error||"Failed to update seat count","error"),s(new Error(a.error))}catch(e){n.enableConfirmButton(),n.updateConfirmButtonText("Purchase seats"),new c.y("An error occurred while updating seats","error"),s(e)}})),n.onClose((()=>{i||(this.inviteModal&&"function"==typeof this.inviteModal.close&&this.inviteModal.close(),new c.y("You don't have enough seats to send these invites.","info"),s(new Error("Modal closed without purchasing seats")))}))}))}async addMembers(e){const t=e.length,s=1===t?"invite":"invites";y.a.addMembers(e,this.workspace.slug).then((e=>{e.success?(this.inviteModal.close(),new c.y(`${t} ${s} sent successfully`,"success"),this.membersTable.loadData()):(this.inviteModal.close(),new c.y("We encountered an error sending the invites. Check your connection.","error"))}))}handleMemberAction(e,t){switch(e){case"change_role":this.changeMemberRole(t);break;case"add_to_team":this.addMemberToTeam(t);break;case"disable":this.revokeMemberAccess(t);break;case"cancel_invite":this.cancelInvite(t);break;case"resend_invite":this.resendInvite(t);break;case"reactivate":this.reactivateMember(t);break;case"transfer_ownership":this.transferOwnership(t);break;case"view_token_usage":this.showMemberUsageModal(t)}}async reactivateMember(e){new a("Reactivate member","Are you sure you want to reactivate this member?").onConfirm((()=>{y.a.getAvailableSeats(this.workspace.slug).then((t=>{t.availableSeats>=1?y.a.reactivateMember(this.workspace.slug,e.id).then((e=>{e.success?(new c.y("Member reactivated successfully","success"),this.membersTable.loadData()):new c.y("Failed to reactivate member","error")})):new c.y("There is not enough seats available to reactivate this member.","info")})).catch((e=>{new c.y("Failed to reactivate member","error")}))}))}async resendInvite(e){new a("Resend invite","Are you sure you want to resend the invite to this member?").onConfirm((()=>{new c.y("Invite resent successfully","success"),y.a.resendInvite(this.workspace.slug,e.email).then((e=>{e.success||new c.y("Failed to resend invite, check your internet connection","error")})).catch((e=>{new c.y("Failed to resend invite","error")}))}))}async cancelInvite(e){new a("Cancel invite","Are you sure you want to cancel the invite for this member?").onConfirm((()=>{new c.y("Invite cancelled successfully","success"),y.a.cancelInvite(this.workspace.slug,e.email).then((e=>{e.success?this.membersTable.loadData():new c.y("Failed to cancel invite, check your internet connection","error")})).catch((e=>{new c.y("Failed to cancel invite","error")}))}))}async showMemberUsageModal(e){const t=document.createElement("div");t.className="flex flex-col min-h-[500px]";const s=e.name.trim()?e.name:e.email,i=new l({size:"large",title:"Usage for "+s,closeX:!0,body:t,confirm:!1});t.innerHTML=`\n            <div class="flex-1 flex flex-col items-center justify-center py-4">\n                <div class="animate-spin rounded-full h-8 w-8 border-b-2 ${this.theme.ringColor}"></div>\n                <p class="mt-2 ${this.theme.fadedText}">Loading usage data...</p>\n            </div>\n        `;try{const s=await y.a.getMemberUsage(this.workspace.slug,e.id);if(!s.success)throw new Error(s.error||"Failed to load usage data.");this.renderMemberUsageContent(t,e,s.data,i)}catch(e){t.innerHTML=`\n                <div class="flex-1 flex flex-col items-center justify-center py-4 text-red-500">\n                    <p>Failed to load usage data.</p>\n                    <p class="text-sm text-gray-500 mt-2">${e.message}</p>\n                </div>\n            `,new c.y("Failed to load usage data","error")}}async showModifyLimitsModal(e,t,s,i){const a=document.createElement("div");a.className="flex flex-col gap-4";const o=new l({size:"medium",title:"Modify limits",closeX:!0,body:a,confirm:!1}),r=document.createElement("p");r.className=`text-sm ${this.theme.fadedText} mb-4`,r.textContent="By default the limits for this member are set to the role defaults. You can override these limits here. You cannot clear usage, to enable more usage you must increase the limits.",a.appendChild(r);const h=document.createElement("div");h.className="grid grid-cols-1 gap-4";const m=new d({label:"Input tokens",type:"number",placeholder:`Role default: ${s.role_limits.input_tokens?s.role_limits.input_tokens.toLocaleString():"Unlimited"}`,value:null!==s.limits.input_tokens_override?s.limits.input_tokens_override:""});m.render(h);const u=new d({label:"Output tokens",type:"number",placeholder:`Role default: ${s.role_limits.output_tokens?s.role_limits.output_tokens.toLocaleString():"Unlimited"}`,value:null!==s.limits.output_tokens_override?s.limits.output_tokens_override:""});u.render(h);const p=new d({label:"Premium tokens",type:"number",placeholder:`Role default: ${s.role_limits.images?s.role_limits.images.toLocaleString():"Unlimited"}`,value:null!==s.limits.images_override?s.limits.images_override:""});p.render(h),a.appendChild(h);const g=document.createElement("div");g.className="flex justify-end mt-4";const f=new n.$({text:"Save limits",type:"primary",size:"medium"});f.onClick((async()=>{f.toggleLoading("Saving...");const s={input:""===m.value?null:parseInt(m.value),output:""===u.value?null:parseInt(u.value),images:""===p.value?null:parseInt(p.value)};try{const n=await y.a.updateMemberLimits(this.workspace.slug,t.id,s);if(!n.success)throw new Error(n.error||"Failed to save limits.");new c.y("Limits updated successfully","success"),this.renderMemberUsageContent(e,t,n.data,i),o.close()}catch(e){new c.y(e.message,"error")}finally{f.toggleLoading()}})),f.render(g),a.appendChild(g)}renderMemberUsageContent(e,t,s,i){e.innerHTML="",e.className="flex flex-col gap-6 p-2";const a=document.createElement("div");a.className="space-y-2 pt-3";const l=document.createElement("div");l.className="flex justify-between items-center";const c=document.createElement("div"),d=document.createElement("div");if(d.className=`text-lg font-medium ${this.theme.text}`,d.textContent="This month",c.appendChild(d),s.limits_reset_date){const e=document.createElement("div");e.className=`${this.theme.fadedText} text-sm`;const t=new Date(s.limits_reset_date).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"});e.textContent=`Tokens next reset on ${t}`,c.appendChild(e)}l.appendChild(c);const h=new n.$({text:"Modify user limits",type:"secondary",size:"medium"});h.onClick((()=>{this.showModifyLimitsModal(e,t,s,i)}));const m=document.createElement("div");h.render(m),l.appendChild(m),a.appendChild(l);const u=document.createElement("div");u.className=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full space-y-4`;const p=(e,t,s)=>{const i=s>0?t/s*100:0,n=document.createElement("div"),a=document.createElement("div");a.className="flex justify-between items-center text-base mb-2",a.innerHTML=`\n                <span class="font-medium ${this.theme.text}">${e}</span>\n                <span class="text-sm ${this.theme.fadedText}">${t.toLocaleString()} / ${s?s.toLocaleString():"Unlimited"}</span>\n            `;const o=document.createElement("div");o.className=`h-3 w-full ${this.theme.sliderRailColor} rounded-full overflow-hidden`;const r=document.createElement("div");return r.className="h-full rounded-full transition-all duration-300",i>=90?r.classList.add("bg-red-500"):i>=75?r.classList.add("bg-yellow-500"):r.classList.add(this.theme.progressBarBackground),r.style.width=`${Math.min(i,100)}%`,o.appendChild(r),n.appendChild(a),n.appendChild(o),n};u.appendChild(p("Frontier input tokens",s.usage.input_tokens,s.limits.input_tokens)),u.appendChild(p("Frontier output tokens",s.usage.output_tokens,s.limits.output_tokens)),u.appendChild(p("Premium tokens",s.usage.images,s.limits.images)),a.appendChild(u),e.appendChild(a);const g=document.createElement("div");g.className="pt-0";const f=document.createElement("h4");f.className="text-lg font-medium mb-1",f.textContent="History",g.appendChild(f);const v=document.createElement("div");if(v.className="space-y-3 max-h-96 overflow-y-auto p-0.5",s.history&&0!==s.history.length){const e={};s.history.forEach((t=>{const s=new Date(t.date_used).toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});e[s]||(e[s]={entries:[],totals:{input:0,output:0,premium:0}}),e[s].entries.push(t),"token"===t.type&&t.frontier_model?(e[s].totals.input+=t.input_tokens,e[s].totals.output+=t.output_tokens):"image"===t.type&&t.frontier_model&&(e[s].totals.premium+=t.quantity||1)}));Object.keys(e).sort(((e,t)=>new Date(t)-new Date(e))).forEach((t=>{const s=e[t],i=document.createElement("div");i.className=`${this.theme.listTableItem} ring-1 rounded-lg p-4`;const n=document.createElement("div");n.className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2";const a=document.createElement("h4");a.className=`font-medium ${this.theme.text}`,a.textContent=t;const l=document.createElement("div");l.className=`text-sm ${this.theme.fadedText} flex flex-wrap gap-4`,l.innerHTML=`\n                    <span>${s.totals.input.toLocaleString()} input</span>\n                    <span>${s.totals.output.toLocaleString()} output</span>\n                    <span>${s.totals.premium.toLocaleString()} premium</span>\n                `,n.appendChild(a),n.appendChild(l),i.appendChild(n),v.appendChild(i);const c=document.createElement("div");c.className="space-y-2",s.entries.sort(((e,t)=>new Date(t.date_used)-new Date(e.date_used))).forEach((e=>{const t=document.createElement("div");t.className=`${this.theme.tableCardBackground} border ${this.theme.tableCardBorder} rounded-lg p-3 ${this.theme.tableHoverBackground}`;const s=document.createElement("div");s.className="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-2";const i=document.createElement("div");i.className="flex items-center gap-3";const n=document.createElement("div");n.className=`text-sm ${this.theme.fadedText} min-w-[60px]`,n.textContent=new Date(e.date_used).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});const a=document.createElement("div");a.className="flex flex-col";const l=document.createElement("div");l.className="flex items-center gap-2";let d=e.model;d.startsWith("gpt-")?d=d.replace("gpt-","GPT ").toUpperCase():d.includes("claude")&&(d=d.replace(/-/g," ").replace(/claude/i,"Claude"),d=d.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "));const h=document.createElement("span");if(h.className=`text-sm font-medium ${e.frontier_model?this.theme.text:this.theme.fadedText}`,h.textContent=d,l.appendChild(h),e.frontier_model){const e=document.createElement("span");e.className=`px-2 py-0.5 text-xs rounded-full ${this.theme.skillTag} font-medium`,e.textContent="Frontier",l.appendChild(e)}if(e.from_recharge){const e=document.createElement("span");e.className=`px-2 py-0.5 text-xs rounded-full ${this.theme.cpuActionClick} font-medium flex items-center gap-1`;const t=o.A.name("bolt");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-2.5 h-2.5"}).render(e),e.appendChild(document.createTextNode("Recharge tokens used")),l.appendChild(e)}const m=document.createElement("div");m.className=`text-xs ${this.theme.fadedText}`;let u=(e.usage_type||"").replace(/_/g," ");m.textContent=u.charAt(0).toUpperCase()+u.slice(1),a.appendChild(l),a.appendChild(m),i.appendChild(n),i.appendChild(a);const p=document.createElement("div");p.className="flex items-center gap-4 text-sm","token"===e.type?p.innerHTML=`\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Input</span>\n                                <span class="font-medium ${this.theme.text}">${e.input_tokens.toLocaleString()}</span>\n                            </div>\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Output</span>\n                                <span class="font-medium ${this.theme.text}">${e.output_tokens.toLocaleString()}</span>\n                            </div>\n                        `:p.innerHTML=`\n                            <div class="flex flex-col items-end">\n                                <span class="text-xs ${this.theme.fadedText}">Premium</span>\n                                <span class="font-medium ${this.theme.text}">${e.quantity}</span>\n                            </div>\n                        `,s.appendChild(i),s.appendChild(p),t.appendChild(s),c.appendChild(t)})),v.appendChild(c)}))}else v.innerHTML=`<div class="text-center ${this.theme.fadedText} p-4">No usage history for this period.</div>`;g.appendChild(v),e.appendChild(g)}async transferOwnership(e){const t=document.createElement("div");t.className="flex flex-col min-h-[250px]";const s=o.A.name("spinner");t.innerHTML=`\n            <div class="flex-1 flex flex-col items-center justify-center py-4">\n                <svg viewBox="${s.viewBox}" class="w-8 h-8 fill-current animate-spin" aria-hidden="true" focusable="false">\n                    <path d="${s.path}"></path>\n                </svg>\n                <p class="mt-2">Loading members...</p>\n            </div>\n        `;const i=new l({size:"small",title:"Transfer ownership",closeX:!0,confirmText:"Transfer ownership",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:t});let n=null;try{const s=(await y.a.getMemberList(this.workspace.slug)).members.filter((t=>t.id!==e.id));if(0===s.length){const e=o.A.name("usersSlash");return t.innerHTML=`\n                    <div class="flex-1 flex flex-col items-center justify-center py-4">\n                        <svg viewBox="${e.viewBox}" class="w-8 h-8 fill-current mb-2" aria-hidden="true" focusable="false">\n                            <path d="${e.path}"></path>\n                        </svg>\n                        <p class="${this.theme.fadedText} text-center">No active members available to transfer ownership to.</p>\n                        <p class="text-sm text-gray-500 mt-2">Invite and activate members first.</p>\n                    </div>\n                `,void i.hideConfirmCancelButtons()}t.innerHTML='\n                <div class="space-y-4 flex-1">\n                    <div id="selector-container" class="pt-3"></div>\n                    <div class="mt-1 mb-4">\n                        This action will transfer all ownership rights to the selected member. You cannot undo this action.\n                    </div>\n                </div>\n            ',n=new k({label:"Select new owner",placeholder:"Select a member...",items:s,required:!0,error:"Please select a member to transfer ownership to",autoBlur:!0}),n.render(t.querySelector("#selector-container")),i.onConfirm((()=>{if(!n.validate())return;const e=n.value;if(!e)return void new c.y("Please select a member to transfer ownership to","error");new a("Confirm ownership transfer",`Are you sure you want to transfer ownership to ${e.label}? This action cannot be undone.`).onConfirm((()=>{i.close(),y.a.transferOwnership(e.id).then((e=>{e.success?(new c.y("Ownership transferred successfully","success"),this.membersTable.loadData()):new c.y(e.error||"Failed to transfer ownership","error")})).catch((e=>{new c.y("Failed to transfer ownership","error")}))}))}))}catch(e){const s=o.A.name("error");t.innerHTML=`\n                <div class="flex-1 flex flex-col items-center justify-center py-4">\n                    <svg viewBox="${s.viewBox}" class="w-8 h-8 fill-current text-red-500 mb-2" aria-hidden="true" focusable="false">\n                        <path d="${s.path}"></path>\n                    </svg>\n                    <p>Failed to load members.</p>\n                    <p class="text-sm text-gray-500 mt-2">Please try again later.</p>\n                </div>\n            `,i.hideConfirmCancelButtons(),new c.y("Failed to load members","error")}}async revokeMemberAccess(e){if(!u.K.hasPermission("workspace:revoke-members"))return void new c.y("You don't have permission to revoke member access. Speak to your workspace administrator","info");new a("Are you sure?","This will revoke access to the workspace for this member.").onConfirm((()=>{y.a.revokeMemberAccess(this.workspace.slug,e.id).then((e=>{e.success?(new c.y("Member access revoked successfully","success"),this.membersTable.loadData()):new c.y("Failed to revoke member access","error")})).catch((e=>{new c.y("Failed to revoke member access","error")}))}))}async addMemberToTeam(e){if(!u.K.hasPermission("workspace:add-remove-team"))return void new c.y("You don't have permission to add members to teams. Speak to your workspace administrator","info");let t=null,s=null,i=null,n=null;await y.a.getMemberTeams(this.workspace.slug,e.id).then((e=>{i=e.current,n=e.all_teams;let a=[];n.forEach((e=>{a.push({value:e.id,name:e.name,subtext:"",selected:i.some((t=>parseInt(t.id)===parseInt(e.id))),icon:"users"})})),t=new h({enableCreate:!0,emptyCreateText:"Create a team",createText:"Create new team",options:a,multiple:!0}),s=new l({size:"medium",title:"Select teams:",closeX:!0,confirmOnExit:!0,confirmText:"Save teams",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:t.create()}),0===a.length&&s.waitingOnData(!0)})),t.onCreate((()=>{s.close(),this.menuClick("teams"),this.handleCreateTeam()})),s.onConfirm((()=>{this.updateMemberTeams(e.id,t.save()),s.close()}))}async updateMemberTeams(e,t){const s={slug:this.workspace.slug,memberId:e,teams:t};try{(await y.a.updateMemberTeams(s)).success?new c.y("Teams updated successfully","success"):new c.y("Failed to add member to team","error")}catch(e){new c.y("Failed to add member to team","error")}}async changeMemberRole(e){if(!u.K.hasPermission("workspace:assign-role"))return void new c.y("You don't have permission to change member roles. Speak to your workspace administrator","info");let t=null,s=null,i=null,n=null;await y.a.getMemberRole(this.workspace.slug,e.id).then((e=>{i=e.current,n=e.all_roles;let a=[];n.forEach((e=>{a.push({value:e.id,name:e.name,subtext:e.description,selected:parseInt(e.id)===parseInt(i.id),icon:"layerGroup"})})),t=new h({enableCreate:!1,maxSelections:1,options:a,enableSearch:!0,searchPlaceholder:"Search roles..."}),s=new l({size:"medium",title:"Select a new role",closeX:!0,confirmOnExit:!0,confirmText:"Change role",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:t.create()})})).catch((e=>{new c.y("Failed to get role","error")})),s.onConfirm((()=>{const n=t.save();parseInt(n.value)!==parseInt(i.id)?y.a.changeMemberRole(this.workspace.slug,e.id,parseInt(n.value)).then((e=>{e.success?(new c.y("Role changed successfully","success"),s.close(),this.membersTable.loadData()):new c.y("Failed to change role","error")})).catch((e=>{new c.y("Failed to change role","error")})):s.close()}))}async getTeamData(){await y.a.getWorkspaceTeams(this.workspace.slug).then((e=>{this.workspace.teams=e.teams}))}async renderWorkspaceTeams(){window.history.pushState({},`${this.workspace.name} teams`,"/chat/workspace/admin/teams"),document.title=`${this.workspace.name} teams`,this.contentContainer.innerHTML="",this.showTableLoadingState(),await this.getTeamData(),await y.a.getWorkspaceTeams(this.workspace.slug).then((e=>{this.tableConfig=e.tableConfig,this.tableData=e.tableData})),this.teamsTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.teamsTable.setCallbacks({loadMore:this.loadTeams.bind(this),onFilterChange:this.handleTeamFilterChange.bind(this),onSort:this.handleTeamSort.bind(this),onCreate:this.handleCreateTeam.bind(this),onAction:this.handleTeamAction.bind(this)}),this.teamsTable.render()}async loadTeams(e=1,t=100,s="name",i="asc",n="",a="all"){return(await y.a.getWorkspaceTeams(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a})).tableData}handleTeamFilterChange(e){}handleTeamSort(e,t){}async deleteTeam(e){new a("Are you sure?","This will delete the team and remove all members.").onConfirm((()=>{y.a.deleteTeam(this.workspace.slug,e).then((e=>{e.success?(new c.y("Team deleted successfully","success"),this.teamsTable.loadData()):new c.y("Failed to delete team","error")})).catch((e=>{new c.y("Failed to delete team","error")}))}))}async handleCreateTeam(e=null,t=null){await y.a.getMemberList(this.workspace.slug,e).then((s=>{const i=s.members.map((e=>({id:e.id,label:e.label,image:e.image}))),n=s.selected_members.map((e=>({id:e.id,label:e.label,image:e.image}))),a=document.createElement("div");a.classList="flex flex-col py-3 h-[400px] gap-3";const o=new d({label:"Team name",placeholder:"e.g. Marketing",required:!0,value:t||""}),r=new x({placeholder:"Select members",label:"Team members",required:!0,items:i});r.value=n||[],o.render(a),r.render(a),this.addTeamModal=new l({size:"medium",title:"Create a team",closeX:!0,confirmOnExit:!0,confirmText:e?"Update team":"Create team",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:a}),o.onChange((()=>{this.addTeamModal.hasUnSavedChanges(!0),o.value.length<3?this.addTeamModal.waitingOnData(!0):this.addTeamModal.waitingOnData(!1)})),e?this.addTeamModal.waitingOnData(!1):this.addTeamModal.waitingOnData(!0),setTimeout((()=>{o.focus()}),0),this.addTeamModal.onConfirm((()=>{if(this.addTeamModal.hasUnSavedChanges(!1),o.value.length<3)return void new c.y("Team name must be at least 3 characters","info");const t={slug:this.workspace.slug,teamName:o.value,members:r.selectedIds,teamId:e||null};this.createOrUpdateTeam(t)}))})).catch((e=>{new c.y("Failed to get current team list","error")}))}async createOrUpdateTeam(e){try{const t=await y.a.createOrEditTeam(e);t.success?(new c.y("Team created successfully","success"),this.addTeamModal.close(),this.teamsTable.loadData()):new c.y(t.error||"Failed to create team","error")}catch(e){new c.y("Failed to create team","error")}}handleTeamAction(e,t){switch(e){case"edit":this.handleCreateTeam(t.id,t.name);break;case"delete":this.deleteTeam(t.id)}}async getRoleData(){await y.a.getWorkspaceRoles(this.workspace.slug).then((e=>{this.workspace.roles=e.roles}))}async renderWorkspaceRoles(){u.K.hasPermission("workspace:create-modify-roles")?(window.history.pushState({},`${this.workspace.name} roles`,"/chat/workspace/admin/roles"),document.title=`${this.workspace.name} roles`,this.contentContainer.innerHTML="",this.showTableLoadingState(),await this.getRoleData(),await y.a.getWorkspaceRoles(this.workspace.slug).then((e=>{this.tableConfig=e.tableConfig,this.tableData=e.tableData})),this.rolesTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.rolesTable.setCallbacks({loadMore:this.loadRoles.bind(this),onFilterChange:this.handleRoleFilterChange.bind(this),onSort:this.handleRoleSort.bind(this),onCreate:this.handleRoleCreateAndEdit.bind(this),onAction:this.handleRoleAction.bind(this),onRowClick:this.handleRoleAction.bind(this)}),this.rolesTable.render()):new c.y("You don't have permission to manage roles. Speak to your workspace administrator","info")}async loadRoles(e=1,t=100,s="name",i="asc",n=""){return(await y.a.getWorkspaceRoles(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n})).tableData}handleRoleFilterChange(e){}handleRoleSort(e,t){}handleCreateRole(){this.handleRoleCreateAndEdit()}async handleRoleCreateAndEdit(e=null){const t=document.createElement("div");t.classList="flex flex-col py-3 gap-4",this.roleModal=new l({size:"medium",title:e?"Edit role":"Create a role",closeX:!0,confirmOnExit:!0,confirmText:e?"Update role":"Create role",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:t});(e=>{e.innerHTML="";const t=document.createElement("div");t.className="space-y-6 animate-pulse p-4";const s=(e="h-10",t="w-full")=>{const s=document.createElement("div");return s.className=`${e} ${t} ${this.theme.loadBackground} rounded`,s},i=e=>{const s=document.createElement("div");s.className="space-y-3",e.forEach((e=>s.appendChild(e))),t.appendChild(s)};i([s("h-6","w-1/3"),s()]),i([s("h-6","w-1/3"),s("h-20")]);const n=document.createElement("div");n.className="h-px bg-gray-200 dark:bg-gray-700 my-6",t.appendChild(n),i([s("h-8","w-1/2")]),i([s("h-20")]),i([s("h-20")]),e.appendChild(t)})(t),this.roleModal.waitingOnData(!0);try{const s=await y.a.getRoleModalData(e?e.id:null);if(!s.success)throw new Error(s.error||"Failed to load role data");t.innerHTML="";const i=s.rolePermissions?s.rolePermissions.role:null,n=i&&("Admin"===i.name||"Owner"===i.name),a=i&&"Member"===i.name,o=document.createElement("div"),r=new d({label:"Role name",placeholder:"e.g. Assistant designer",required:!0,value:i?i.name:""}),l=new d({label:"Description",placeholder:"e.g. Can share agents with workspace",type:"textarea",value:i?i.description:""});r.render(o),l.render(o),t.appendChild(o),(n||a)&&(o.classList.add("opacity-50"),r.disable(),l.disable());const h="business"!==this.workspace.plan_type&&"enterprise"!==this.workspace.plan_type;let m,u,p;if(h&&!n){const e=document.createElement("div");e.classList="mt-2",t.appendChild(e);const s=document.createElement("div");s.classList="font-bold",s.textContent="Monthly token limits for this role",e.appendChild(s);const n=document.createElement("div");n.classList=`text-sm ${this.theme.fadedText} pb-3`,n.textContent="Leave blank for default limits",e.appendChild(n);const a=document.createElement("div");a.classList=`flex flex-col gap-4 rounded-md ${this.theme.inputText}`,e.appendChild(a);const o=document.createElement("div");o.classList="grid grid-cols-1 md:grid-cols-2 gap-4",a.appendChild(o),m=new d({label:"Input tokens",type:"number",placeholder:"e.g. 7,000,000",value:i&&null!==i.max_input_tokens_per_month?i.max_input_tokens_per_month:"",min:0}),u=new d({label:"Output tokens",type:"number",placeholder:"e.g. 1,000,000",value:i&&null!==i.max_output_tokens_per_month?i.max_output_tokens_per_month:"",min:0}),p=new d({label:"Premium tokens",type:"number",placeholder:"e.g. 110",value:i&&null!==i.max_images_per_month?i.max_images_per_month:"",min:0}),m.render(o),u.render(o),p.render(o);const r=document.createElement("div");r.className="mt-1 flex gap-2 items-center align-center",a.appendChild(r);const l=document.createElement("div");l.className="text-sm font-medium",l.textContent="Set for:",r.appendChild(l);const c=document.createElement("div");c.className="flex items-center gap-2 flex-wrap",r.appendChild(c);const h=Oe;if(h)for(const e in h){const t=h[e],s=document.createElement("button");s.className=`${this.theme.secondaryButton} ${this.theme.listTableHover} text-xs font-medium px-2.5 py-1 rounded-full transition-transform transform hover:scale-105`,s.textContent=t.name,s.addEventListener("click",(()=>{m.value=t.values.input,u.value=t.values.output,p.value=t.values.images,this.roleModal.hasUnSavedChanges(!0)})),c.appendChild(s)}}const g=document.createElement("div");g.classList="mt-2",t.appendChild(g);const f=document.createElement("div");f.classList="font-bold pb-2",f.textContent="Select role permissions";const v=document.createElement("div");v.classList=`flex flex-col gap-2 py-6 px-6 ${this.theme.inputBackground} border ${this.theme.inputBorder} rounded-md ${this.theme.inputText}`,g.appendChild(f),g.appendChild(v);const w=document.createElement("div");w.classList="mt-4 pb-2";const b=new C({label:"Restrict MCPs for this role",helpText:"When enabled, this role will only have access to the selected MCPs.",value:!!i&&i.restricted_mcps});b.render(w);const k=document.createElement("div");k.classList="mt-4"+(b.value?"":" hidden");const E=s.workspaceMCPs.tableData.map((e=>({id:e.id,label:e.name,image:e.image||null}))),S=new x({label:"",placeholder:"Search MCPs...",items:E,width:"100%"});S.render(k),w.appendChild(k);const T=document.createElement("div");T.classList="mt-2 pb-2";const L=new C({label:"Restrict models for this role",helpText:"When enabled, this role will only have access to the selected models. If you disable or remove an enabled model for this role it will automatically be removed.",value:!!i&&i.restricted_models});L.render(T);const _=document.createElement("div");_.classList="mt-4"+(L.value?"":" hidden");const I=s.workspaceModels.tableData.map((e=>({id:e.id,label:e.name,image:e.image||null}))),A=new x({label:"",placeholder:"Search models...",items:I,width:"100%"});A.render(_),T.appendChild(_),t.appendChild(w),t.appendChild(T),b.onChange((e=>{k.classList.toggle("hidden",!e),this.roleModal.hasUnSavedChanges(!0),$()})),L.onChange((e=>{_.classList.toggle("hidden",!e),this.roleModal.hasUnSavedChanges(!0),$()})),n&&(b.setDisabled(!0),L.setDisabled(!0));let M=[];if(s.rolePermissions){const e=s.rolePermissions;if(M=e.permissions,e.role.restricted_mcps&&e.allowed_mcps.length>0){const t=E.filter((t=>e.allowed_mcps.includes(t.id)));S.value=t}if(e.role.restricted_models&&e.allowed_models.length>0){const t=I.filter((t=>e.allowed_models.includes(t.id)));A.value=t}}const B=s.permissionsManifest.permissions,D=e=>{const t=e.querySelector('input[type="checkbox"][id^="select-all-"]'),s=e.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])'),i=Array.from(s).every((e=>e.checked)),n=Array.from(s).some((e=>e.checked));t.checked=i,t.indeterminate=n&&!i};Object.entries(B).forEach((([e,t])=>{const s=document.createElement("div");s.classList="mb-4";const i=document.createElement("div");i.classList="flex items-center mb-2";const a=document.createElement("input");a.type="checkbox",a.classList="mr-2",a.id=`select-all-${e}`;const o=document.createElement("label");o.htmlFor=`select-all-${e}`,o.classList="font-bold text-base",o.textContent=e,i.appendChild(a),i.appendChild(o),s.appendChild(i),t.forEach((e=>{const t=document.createElement("div");t.classList="ml-6 mb-2";const i=document.createElement("input");i.type="checkbox",i.id=`permission-${e.id}`,i.classList="mr-2",M.includes(e.id.toString())&&(i.checked=!0),n&&(i.disabled=!0);const a=document.createElement("label");a.htmlFor=`permission-${e.id}`,a.classList="font-medium text-sm",a.textContent=e.name;const o=document.createElement("p");o.classList=`text-sm ${this.theme.fadedText} ml-6`,o.textContent=e.description,t.appendChild(i),t.appendChild(a),t.appendChild(o),s.appendChild(t),i.addEventListener("change",(()=>{D(s),$(),this.roleModal.hasUnSavedChanges(!0)}))})),a.addEventListener("change",(e=>{s.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])').forEach((t=>{t.checked=e.target.checked})),D(s),$(),this.roleModal.hasUnSavedChanges(!0)})),n&&(a.disabled=!0),v.appendChild(s),D(s)}));const $=()=>{if(n)return void this.roleModal.waitingOnData(!0);const e=r.value.trim(),t=l.value.trim(),s=v.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])'),i=Array.from(s).some((e=>e.checked)),a=!b.value||S.value.length>0,o=!L.value||A.value.length>0;this.roleModal.waitingOnData(!(e.length>0&&t.length>0&&i&&a&&o))};r.onChange((()=>{$(),this.roleModal.hasUnSavedChanges(!0)})),l.onChange((()=>{$(),this.roleModal.hasUnSavedChanges(!0)})),S.onChange((()=>{$(),this.roleModal.hasUnSavedChanges(!0)})),A.onChange((()=>{$(),this.roleModal.hasUnSavedChanges(!0)})),h&&!n&&(m.onChange((()=>this.roleModal.hasUnSavedChanges(!0))),u.onChange((()=>this.roleModal.hasUnSavedChanges(!0))),p.onChange((()=>this.roleModal.hasUnSavedChanges(!0)))),setTimeout((()=>{e||r.focus()}),0),this.roleModal.onConfirm((()=>{if(n)return this.roleModal.close(),void new c.y("You can't edit the Admin, Owner, or Member roles.","info");this.roleModal.hasUnSavedChanges(!1);const t=r.value.trim(),s=l.value.trim(),i=v.querySelectorAll('input[type="checkbox"]:not([id^="select-all-"])'),a=Array.from(i).filter((e=>e.checked)).map((e=>e.id.replace("permission-",""))),o=b.value,d=o?S.selectedIds:[],g=L.value,f=g?A.selectedIds:[],w={roleName:t,roleDescription:s,selectedPermissions:a,restrictMCPs:o,selectedMCPs:d,restrictModels:g,selectedModels:f};h&&!n&&(w.max_input_tokens_per_month=m.value?parseInt(m.value):null,w.max_output_tokens_per_month=u.value?parseInt(u.value):null,w.max_images_per_month=p.value?parseInt(p.value):null),e?(w.roleId=e.id,y.a.updateRole(this.workspace.slug,w).then((e=>{e.success?(this.roleModal.close(),new c.y(`${t} role was updated successfully`,"success"),this.rolesTable.loadData()):(this.roleModal.close(),new c.y(`Error updating role: ${e.error}`,"error"))}))):y.a.createRole(this.workspace.slug,w).then((e=>{e.success?(this.roleModal.close(),new c.y(`${t} role was created successfully`,"success"),this.rolesTable.loadData()):(this.roleModal.close(),new c.y(`Error creating role: ${e.error}`,"error"))}))})),this.roleModal.waitingOnData(!1),$()}catch(e){new c.y("Error loading data for role modal","error"),this.roleModal.close()}}handleRoleAction(e,t){switch(e){case"edit":case"view":this.handleRoleCreateAndEdit(t);break;case"delete":this.deleteRole(t)}}deleteRole(e){new a("Are you sure?","This role will be permanently deleted and all members defaulted to Member role").onConfirm((()=>{y.a.deleteRole(this.workspace.slug,e.id).then((e=>{e.success?(new c.y("Role deleted successfully","success"),this.rolesTable.loadData()):new c.y("Error deleting role","error")}))}))}async getModelData(){await y.a.getWorkspaceModels(this.workspace.slug).then((e=>{this.workspace.models=e.models}))}async renderWorkspaceModels(){window.history.pushState({},`${this.workspace.name} models`,"/chat/workspace/admin/models"),document.title=`${this.workspace.name} models`,this.contentContainer.innerHTML="",this.showTableLoadingState();const e=await y.a.getWorkspaceModels(this.workspace.slug,{page:1,itemsPerPage:50,sortColumn:"name",sortOrder:"asc",search:"",filter:"all"});this.tableConfig=e.tableConfig,this.tableData=e.tableData,this.currentPage=e.currentPage,this.totalPages=e.totalPages,this.endOfData=e.endOfData||this.currentPage>=this.totalPages,this.modelsTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.modelsTable.setCallbacks({loadMore:this.loadModels.bind(this),onFilterChange:this.handleModelFilterChange.bind(this),onSort:this.handleModelSort.bind(this),onCreate:this.handleAddModel.bind(this),onAction:this.handleModelAction.bind(this)}),this.modelsTable.render()}async loadModels(e,t=50,s="name",i="asc",n="",a="all"){const o=await y.a.getWorkspaceModels(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a});return this.currentPage=o.currentPage,this.totalPages=o.totalPages,this.endOfData=o.endOfData,o.tableData}handleModelFilterChange(e,t){this.modelsTable.loadData()}handleModelSort(e){this.modelsTable.loadData({sortColumn:e.column,sortOrder:e.order})}handleAddModel(){}handleModelAction(e,t){switch(e){case"edit_settings":this.handleForkModel(t,!0);break;case"enable":this.enableModel(t);break;case"disable":this.disableModel(t);break;case"delete":this.deleteModel(t);break;case"fork":this.handleForkModel(t,!1)}}async enableModel(e){try{const t=await y.a.updateModelStatus(this.workspace.slug,e.id,!0);t.success&&(new c.y(t.message||"Model enabled successfully","success"),this.modelsTable.loadData())}catch(e){new c.y(e.message||"Error enabling model","error")}}async disableModel(e){try{const t=await y.a.updateModelStatus(this.workspace.slug,e.id,!1);t.success&&(t.message?new c.y(t.message,"info"):(new c.y("Model disabled successfully","success"),this.modelsTable.loadData()))}catch(e){new c.y(e.message||"Error disabling model","error")}}async handleForkModel(e,t=!1){const s=document.createElement("div");s.classList="flex flex-col pt-4";const i=document.createElement("div");i.classList="space-y-6";const n=new d({label:"Custom model name",placeholder:`e.g. ${e.name} (Creative)`,required:!0,value:t?e.name:"",helpText:"Give your customized model a unique name"}),a=new S("Custom model logo",t?e.img:null,"Custom model logo"),h=new d({label:"Model description",placeholder:"Describe your forked model",value:t?e.custom_model_description:"",type:"text",helpText:"This description will appear in the model picker."});let m,u,g,f,v;n.render(i),a.render(i),h.render(i),s.appendChild(i),e.supports_system_prompt&&(m=new p({label:"System prompt (optional)",placeholder:"Enter a system prompt that will be prepended to all interactions",value:t?e.system_prompt:"",type:"textarea",helpText:"This prompt will guide the model's behavior across all interactions"}),m.render(i)),e.supports_temperature&&(u=new $({label:"Temperature",value:t?e.temperature:e.default_temperature||.7,showValue:!0,min:e.min_temperature||0,max:e.max_temperature||1,step:.1,helpText:"Higher values make output more creative, lower values make it more focused",minLabel:"Focused",maxLabel:"Creative"}),u.render(i)),e.supports_reasoning_effort&&(g=new $({label:"Reasoning Effort",value:t?e.reasoning_effort:e.reasoning_effort||3,showValue:!0,min:1,max:5,step:1,helpText:"The model will think for longer with higher values",minLabel:"Less thinking",maxLabel:"More thinking"}),g.render(i)),e.supports_top_p&&(f=new $({label:"Top P",value:t?e.top_p:e.default_top_p||1,showValue:!0,min:0,max:1,step:.1,helpText:"Controls diversity of token selection",minLabel:"Focused",maxLabel:"Diverse"}),f.render(i)),e.supports_reasoning&&(v=new $({label:"Reasoning effort",value:t&&e.default_reasoning_effort||3,showValue:!0,min:1,max:5,step:1,helpText:"Controls how much effort the model puts into reasoning (1-5)",minLabel:"Quick",maxLabel:"Thorough"}),v.render(i));const w=document.createElement("div");w.classList="hidden mt-6";const b=document.createElement("button");b.classList="w-full text-left py-2 rounded-md pt-6";const x=document.createElement("div");x.classList="flex gap-2 items-center";const k=document.createElement("div");k.classList="mr-1";const E=o.A.name("chevronRight"),T=new r.I({pathData:E.path,viewBox:E.viewBox,sizeClasses:"w-4 h-4"});T.element&&k.appendChild(T.element);const L=document.createElement("span");L.classList="font-medium text-base",L.textContent="Show advanced",x.appendChild(k),x.appendChild(L),b.appendChild(x),b.addEventListener("click",(()=>{w.classList.toggle("hidden");const e=k.firstChild&&k.firstChild.querySelector("path").getAttribute("d")===o.A.name("chevronRight").path;L.textContent=e?"Hide advanced":"Show advanced",k.innerHTML="";const t=e?o.A.name("chevronDown"):o.A.name("chevronRight"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-4 h-4"});s.element&&k.appendChild(s.element)}));const _=document.createElement("div");_.classList="space-y-4 border-b pb-6";const I=document.createElement("h3");I.classList="font-bold text-base mb-4",I.textContent="Token control",_.appendChild(I);const A=new d({label:"Max Context Size",type:"number",value:t?e.max_context_size:e.default_max_context_size||128e3,min:1e3,max:2e6,helpText:"Maximum number of tokens to consider from conversation history"}),M=new d({label:"Max Output Size",type:"number",value:t?e.max_output_size:e.default_max_tokens||4096,min:100,max:128e3,helpText:"Maximum number of tokens in the model's response"});let B,D,P,N,z;if(A.render(_),M.render(_),w.appendChild(_),e.supports_frequency_penalty||e.supports_presence_penalty||e.supports_repetition_penalty){const s=document.createElement("div");s.classList="space-y-4 border-b pb-6 mt-6";const i=document.createElement("h3");i.classList="font-bold text-base mb-4",i.textContent="Response tuning",s.appendChild(i),e.supports_frequency_penalty&&(B=new $({label:"Frequency Penalty",value:t?e.frequency_penalty:e.default_frequency_penalty||0,showValue:!0,min:0,max:2,step:.1,helpText:"Reduces repetition by penalizing tokens that have already appeared",minLabel:"None",maxLabel:"High"}),B.render(s)),e.supports_presence_penalty&&(D=new $({label:"Presence Penalty",value:t?e.presence_penalty:e.default_presence_penalty||0,showValue:!0,min:0,max:2,step:.1,helpText:"Encourages new topics by penalizing tokens that appear in the entire text",minLabel:"None",maxLabel:"High"}),D.render(s)),e.supports_repetition_penalty&&(P=new $({label:"Repetition Penalty",value:t?e.repetition_penalty:e.default_repetition_penalty||1,showValue:!0,min:1,max:2,step:.1,helpText:"Higher values reduce exact repetition of phrases",minLabel:"None",maxLabel:"High"}),P.render(s)),w.appendChild(s)}if(e.supports_stop_sequences){const s=document.createElement("div");s.classList="space-y-4 mt-6";const i=document.createElement("h3");i.classList="font-bold text-base mb-4",i.textContent="Stop Sequence",s.appendChild(i),N=new C({label:"Enable Stop Sequence",value:!!t&&e.stop_sequence_enabled,helpText:"Stop generation when specific sequences are encountered"}),z=new p({label:"Stop Sequences",placeholder:"Enter sequences separated by newlines",value:t?e.stop_sequence:"",disabled:!e.stop_sequence_enabled,helpText:"The model will stop generating when it encounters these sequences"}),N.onChange((e=>{e?z.enable():z.disable()})),N.render(s),z.render(s),w.appendChild(s)}s.appendChild(b),s.appendChild(w);const F=t?`Edit ${e.name}`:`Fork ${e.name}`,R=new l({size:"medium",title:F,closeX:!0,confirmOnExit:!0,confirmText:t?"Save changes":"Create fork",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:s}),H=()=>{const e=n.value.trim().length>0;R.waitingOnData(!e)},O=[n];e.supports_system_prompt&&O.push(m),e.supports_temperature&&O.push(u),e.supports_top_p&&O.push(f),e.supports_reasoning&&O.push(v),O.forEach((e=>{e.onChange((()=>{H(),R.hasUnSavedChanges(!0)}))})),R.onConfirm((()=>{R.hasUnSavedChanges(!1);const s={avatar:a.value?.imgUrl,name:n.value.trim(),base_model_id:e.base_model_id,custom_model_description:h.value.trim()};e.supports_system_prompt&&(s.system_prompt=m.value.trim()),e.supports_temperature&&(s.temperature=u.value),e.supports_top_p&&(s.top_p=f.value),e.supports_reasoning&&(s.reasoning_effort=v.value),e.supports_stop_sequences&&(s.stop_sequence=N.value?z.value.trim():"",s.stop_sequence_enabled=N.value),t&&(s.model_id=e.id),s.max_context_size=parseInt(A.value),s.max_output_size=parseInt(M.value),e.supports_frequency_penalty&&(s.frequency_penalty=B.value),e.supports_presence_penalty&&(s.presence_penalty=D.value),e.supports_repetition_penalty&&(s.repetition_penalty=P.value);(t?y.a.updateModel:y.a.forkModel)(this.workspace.slug,s,!1).then((e=>{e.success?(R.close(),new c.y(`Model ${t?"updated":"forked"} successfully`,"success"),this.modelsTable.loadData()):new c.y(`Error: ${e.error}`,"error")})).catch((e=>{new c.y(`Error ${t?"updating":"forking"} model`,"error")}))})),H()}async renderWorkspaceSkills(){window.history.pushState({},`${this.workspace.name} skills`,"/chat/workspace/admin/skills"),document.title=`${this.workspace.name} skills`,this.contentContainer.innerHTML="",Se.renderLoadingState(this.contentContainer,{tableColumns:[{name:"Name",value:"name"},{name:"Status",value:"status"},{name:"Commmand",value:"command"},{name:"Featured",value:"featured"},{name:"Last updaed",value:"last_updated"},{name:"Actions",value:"actions"}]});const e=await y.a.getWorkspaceSkills(this.workspace.slug,{page:1,itemsPerPage:50,sortColumn:"name",sortOrder:"asc",search:"",filter:"all"});this.skillsTable=new Se(e.tableConfig,e.tableData,this.contentContainer),this.skillsTable.setCallbacks({loadMore:this.loadSkills.bind(this),onFilterChange:this.handleSkillFilterChange.bind(this),onSort:this.handleSkillSort.bind(this),onAction:this.handleSkillAction.bind(this),getAllMatchingRecordIds:this.getAllSkillIds.bind(this),onTableStateChange:this.handleTableStateChange.bind(this)}),this.skillsTable.render()}async loadSkills(e,t=50,s="name",i="asc",n="",a="all"){try{return(await y.a.getWorkspaceSkills(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a})).tableData}catch(e){return[]}}async handleSkillFilterChange(e,t){try{await this.skillsTable.loadData({filter:e,search:t}),this.skillsTable.updateContentView()}catch(e){}}async handleSkillSort(e,t){try{await this.skillsTable.loadData({sortColumn:e,sortOrder:t})}catch(e){}}async getAllSkillIds(e,t,s,i){try{return(await y.a.getAllSkillIds(this.workspace.slug,{sortColumn:e,sortOrder:t,search:s,filter:i})).ids||[]}catch(e){return[]}}handleTableStateChange(e){}handleSkillAction(e,t){switch(e){case"enable":case"disable":this.toggleSkillStatus(t,"enable"===e);break;case"add_featured":this.toggleSkillFeatured(t,!0);break;case"remove_featured":this.toggleSkillFeatured(t,!1)}}async toggleSkillFeatured(e,t){try{const s=await y.a.updateSkillFeatured(this.workspace.slug,e.id,t);s.success&&(this.skillsTable.updateRecord(s.skill),new c.y(`Skill ${t?"featured":"unfeatured"} successfully`,"success"))}catch(e){new c.y("Error updating skill featured","error")}}async toggleSkillStatus(e,t){try{const s=await y.a.updateSkillStatus(this.workspace.slug,e.id,t);s.success&&(this.skillsTable.updateRecord(s.skill),new c.y(`Skill ${t?"enabled":"disabled"} successfully`,"success"))}catch(e){new c.y("Error updating skill status","error")}}async renderWorkspaceMCPs(){if(this.workspace&&this.workspace.slug){window.history.pushState({},`${this.workspace.name} MCPs`,"/chat/workspace/admin/mcps"),document.title=`${this.workspace.name} MCPs`,this.contentContainer.innerHTML="",Se.renderLoadingState(this.contentContainer,{tableColumns:[{name:"Name",value:"name",sortable:!0},{name:"Category",value:"category_name",sortable:!0},{name:"Publisher",value:"publisher_name",sortable:!0},{name:"Version",value:"version",sortable:!1},{name:"Status",value:"is_enabled_in_workspace",type:"toggle",sortable:!0},{name:"Actions",value:"actions",type:"actions",sortable:!1}]});try{const e=await y.a.getWorkspaceMCPs(this.workspace.slug,{page:1,itemsPerPage:50,sortColumn:"name",sortOrder:"asc",search:"",filter:"all"});if(!e||!e.tableConfig||!e.tableData)throw new Error("Invalid response structure from getWorkspaceMCPs");this.mcpTable=new Se(e.tableConfig,e.tableData,this.contentContainer),this.mcpTable.setCallbacks({loadMore:this.loadMCPs.bind(this),onFilterChange:this.handleMCPFilterChange.bind(this),onSort:this.handleMCPSort.bind(this),onAction:this.handleMCPAction.bind(this),getAllMatchingRecordIds:this.getAllMCPIdsForTable.bind(this),onTableStateChange:this.handleTableStateChange.bind(this)}),this.mcpTable.render()}catch(e){this.contentContainer.innerHTML=`<p class="text-red-500 p-4">Error loading MCPs: ${e.message}</p>`,new c.y("Error loading MCPs.","error")}}else this.contentContainer.innerHTML='<p class="text-red-500 p-4">Error: Workspace information is missing.</p>'}async loadMCPs(e,t=50,s="name",i="asc",n="",a="all"){try{return(await y.a.getWorkspaceMCPs(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a})).tableData||[]}catch(e){return new c.y("Error fetching more MCPs.","error"),[]}}async handleMCPFilterChange(e,t){if(this.mcpTable)try{await this.mcpTable.loadData({filter:e,search:t}),this.mcpTable.updateContentView()}catch(e){new c.y("Error filtering MCPs.","error")}}async handleMCPSort(e,t){if(this.mcpTable)try{await this.mcpTable.loadData({sortColumn:e,sortOrder:t})}catch(e){new c.y("Error sorting MCPs.","error")}}async getAllMCPIdsForTable(e,t,s,i){try{return(await y.a.getAllMCPIds(this.workspace.slug,{sortColumn:e,sortOrder:t,search:s,filter:i})).ids||[]}catch(e){return new c.y("Error fetching MCP identifiers.","error"),[]}}handleMCPAction(e,t){switch(e){case"enable":case"disable":this.toggleMCPStatus(t,"enable"===e)}}async toggleMCPStatus(e,t){if(e&&void 0!==e.skill_pk)if(this.mcpTable)try{const s=await y.a.updateSkillStatus(this.workspace.slug,e.skill_pk,t);s.success?(await this.mcpTable.loadData(),new c.y(`MCP ${e.name} ${t?"enabled":"disabled"} successfully.`,"success")):new c.y(`Failed to update MCP ${e.name} status. ${s.message||""}`,"error")}catch(t){new c.y(`Error updating MCP ${e.name} status.`,"error")}else new c.y("Error: MCP table not initialized.","error");else new c.y("Error: Cannot update MCP status due to missing information.","error")}async renderWorkspaceThemes(){if(!u.K.hasPermission("workspace:theme"))return void new c.y("You do not have permission to view this page","info");window.history.pushState({},`${this.workspace.name} themes`,"/chat/workspace/admin/themes"),document.title=`${this.workspace.name} theme manager`,this.contentContainer.innerHTML="",this.showTableLoadingState();const e=await y.a.getWorkspaceThemes(this.workspace.slug,{page:1,itemsPerPage:50,sortColumn:"updated_at",sortOrder:"desc",search:"",filter:"all"});this.tableConfig=e.tableConfig,this.tableData=e.tableData,this.currentPage=e.currentPage,this.totalPages=e.totalPages,this.endOfData=e.endOfData||this.currentPage>=this.totalPages,this.themesTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.themesTable.setCallbacks({loadMore:this.loadThemes.bind(this),onFilterChange:this.handleThemeFilterChange.bind(this),onSort:this.handleThemeSort.bind(this),onCreate:this.handleCreateAndEditTheme.bind(this),onAction:this.handleThemeAction.bind(this)}),this.themesTable.render()}async loadThemes(e,t=50,s="updated_at",i="desc",n="",a="all"){const o=await y.a.getWorkspaceThemes(this.workspace.slug,{page:this.currentPage,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a});return this.currentPage=o.currentPage,this.totalPages=o.totalPages,this.endOfData=o.endOfData,o.tableData}handleThemeFilterChange(e,t){this.themesTable.loadData()}handleThemeSort(e){this.themesTable.loadData()}async handleCreateAndEditTheme(e=null){function t(e){e=e.replace("#","");return(.299*parseInt(e.substr(0,2),16)+.587*parseInt(e.substr(2,2),16)+.114*parseInt(e.substr(4,2),16))/255>.5?"#000000":"#ffffff"}function s(e,s,n,a=""){const o=document.createElement("link");o.href=`https://fonts.googleapis.com/css2?family=${n.replace(" ","+")}:wght@400;500;600&display=swap`,o.rel="stylesheet",document.head.appendChild(o);const r=t(e),l=t(s),c=a.trim()||"My great theme";return`\n                <h2 class="text-lg font-bold">Preview</h2>\n                <div class="w-full rounded-md overflow-hidden shadow-sm text-sm ring-1 ${i.A.theme.ringColor}" \n                     style="background-color: ${e}; color: ${r};">\n                    \x3c!-- Header Preview --\x3e\n                    <div class="p-4 border-b" style="border-color: ${s}20;">\n                        <div class="w-auto px-3 h-6 rounded flex items-center justify-center" \n                             style="background-color: ${s}20; font-family: '${n}', sans-serif;">\n                            ${c}\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Content Preview --\x3e\n                    <div class="p-4 space-y-3">\n                        \x3c!-- Message Bubbles --\x3e\n                        <div class="w-3/4 h-auto p-3 rounded" \n                             style="background-color: ${s}10; font-family: '${n}', sans-serif;">\n                            How can I help?\n                        </div>\n                        <div class="w-2/3 h-auto p-3 rounded ml-auto" \n                             style="background-color: ${s}20; font-family: '${n}', sans-serif;">\n                            I'd like to learn more about this theme.\n                        </div>\n                        \n                        \x3c!-- Input Preview --\x3e\n                        <div class="mt-4 p-2 rounded border" style="border-color: ${s}30;">\n                            <div class="flex justify-between items-center">\n                                <div class="w-6 h-6 rounded flex items-center justify-center">\n                                    <i class="fa-solid fa-circle-plus w-6 h-6" style="${l} op"></i>\n                                </div>\n                                <div class="w-full mx-2 p-2 rounded" \n                                     style="background-color: ${s}15; font-family: '${n}', sans-serif;">\n                                    Send a message...\n                                </div>\n                                <div class="w-8 h-6 rounded flex items-center justify-center" \n                                     style="background-color: ${s}; color: ${l}; font-family: '${n}', sans-serif;">\n                                    <i class="fa-solid fa-up w-4 h-4"></i>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `}this.themeColorPickers={},this.advancedThemeColors={mainBackground:null,hoverBackground:null};const n=(e=!1,t=null,i=null)=>{if(e){const e=t||this.advancedThemeColors.mainBackground||"#ffffff",n=i||this.advancedThemeColors.hoverBackground||"#f0f0f0";I.innerHTML=s(e,n,g.value)}else{const e=v.value||"#ffffff",t=C.value||"#000000",i=g.value||"Inter",n=x.value;I.innerHTML=s(e,t,i,n)}},h=["Inter","Open Sans","Roboto","Poppins","Noto Sans","Source Sans Pro","Work Sans","Merriweather","DM Sans","Quicksand","Varela Round","Comfortaa","Maven Pro","SF Pro Text","Roboto Flex","Public Sans","JetBrains Mono","IBM Plex Mono","Space Mono"].map((e=>({value:e,label:e}))),m=e=>{const t=document.createElement("div");t.classList="flex flex-col gap-1";const s={Background:{"Base Backgrounds":{"Main Background":e.colors.background.main,"Main Background HEX":e.colors.background.mainHex,"Hover Background":e.colors.background.hover,"Selected Background":e.colors.background.selected,"Secondary Background":e.colors.background.secondary},"Modal & Overlay Backgrounds":{"Modal Background":e.colors.background.modal,"Modal Fade Background":e.colors.background.modalFade,"Overlay Background":e.colors.background.overlay,"Lightbox Background":e.colors.background.lightbox},"Specialized Backgrounds":{"Focus Mode Background":e.colors.background.focusMode,"Screen Capture Background":e.colors.background.screenCapture,"Load Indicator Background":e.colors.background.loadIndicator,"Widget Background":e.colors.background.widget}},"Text & Cursor":{"General Text":{"Primary Text":e.colors.text.primary,"Faded Text":e.colors.text.faded,"Link Text":e.colors.text.link,"Placeholder Text":e.colors.text.placeholder,"Switch Control Text":e.colors.text.switch},"File & Table Text":{"File Name Text":e.colors.text.fileName,"File Sub-text":e.colors.text.fileSub,"Table Header Text":e.colors.text.tableHeader,"Table Primary Column Text":e.colors.text.tablePrimaryColumn,"Focus Menu Text":e.colors.text.focusMenu},"Source Text":{"Source Tile Text":e.colors.text.sourceTile,"Source Tile Faded Text":e.colors.text.sourceTileFaded,"Source Number Text (Direct HEX)":e.colors.memoryAndSources.sourceNumberTextColor},Cursor:{"Cursor HEX":e.colors.cursor.hex}},"Borders & Rings":{"General Rings":{"Main Ring Color":e.colors.bordersAndRings.mainRing,"Secondary Ring Color":e.colors.bordersAndRings.secondaryRing,"Error Ring Color":e.colors.bordersAndRings.errorRing,"Selected Ring Color":e.colors.bordersAndRings.selectedRing,"Hover Ring Color":e.colors.bordersAndRings.hoverRing},"Specific Borders & Rings":{"Modal Separation Border":e.colors.bordersAndRings.modalSeparationBorder,"Input Border":e.colors.bordersAndRings.inputBorder,"Input Selected Border":e.colors.bordersAndRings.inputSelectedBorder,"Input Ring":e.colors.bordersAndRings.inputRing,"Table Border":e.colors.bordersAndRings.tableBorder,"Table Divider Line":e.colors.bordersAndRings.tableDividerLine,"Table Card Border":e.colors.bordersAndRings.tableCardBorder,"Select Menu Ring":e.colors.bordersAndRings.selectMenuRing,"File Item Ring":e.colors.bordersAndRings.fileItemRing,"Memory Item Ring":e.colors.bordersAndRings.memoryItemRing,"Switch Ring":e.colors.bordersAndRings.switchRing,"Tab Outer Ring":e.colors.bordersAndRings.tabOuterRing,"Tab Selected Ring":e.colors.bordersAndRings.tabSelectedRing}},Buttons:{"Primary Buttons":{"Default (Text & BG)":e.colors.buttons.primary.default,"Transparent (Text & BG)":e.colors.buttons.primary.transparent},"Secondary Buttons":{"Default (Text & BG)":e.colors.buttons.secondary.default,"Transparent (Text & BG)":e.colors.buttons.secondary.transparent},"Specialized Buttons":{"Link Button (Text & Hover)":e.colors.buttons.link,"Ring Button (Ring & Text)":e.colors.buttons.ring,"Secondary Ring Button (Ring & Text)":e.colors.buttons.ringSecondary,"Focus Button BG":e.colors.buttons.focus,"Code Block Button (Text & BG)":e.colors.buttons.codeBlock},"Table & Chat Buttons":{"Table Button (Ring & BG)":e.colors.buttons.table,"Table Selected Button BG":e.colors.buttons.tableSelectedBackground,"Chat Enabled Button (BG, Text, Hover)":e.colors.buttons.chatEnabled,"Chat Disabled Button (BG & Text/Opacity)":e.colors.buttons.chatDisabled}},"Inputs & Controls":{"General Input Styling":{"Input Background":e.colors.inputsGeneral.background,"Input Text":e.colors.inputsGeneral.text,"Input Focus State":e.colors.inputsGeneral.focus,"Chat Input Background & Ring":e.colors.inputsGeneral.chatBackground},"Switch Controls":{"Switch On Background":e.colors.switchControls.onBackground,"Switch Off Background":e.colors.switchControls.offBackground,"Switch Indicator Background":e.colors.switchControls.indicatorBackground,"Switch Container Background":e.colors.switchControls.containerBackground,"Switch Form Container Background":e.colors.switchControls.formContainerBackground},"Select (Dropdown) Controls":{"Select Menu Background":e.colors.selectControls.menuBackground,"Select Icon (BG & Text)":e.colors.selectControls.iconBackgroundAndText,"Select Item Background":e.colors.selectControls.itemBackground,"Select Selected Item Background":e.colors.selectControls.selectedItemBackground,"Select Tag Background":e.colors.selectControls.tagBackground,"Select Background Hover":e.colors.selectControls.backgroundHover,"Select Remove Button (Text)":e.colors.selectControls.removeButton,"Select Remove Button Hover (Text)":e.colors.selectControls.removeButtonHover,"Select Focused Item Background":e.colors.selectControls.focusedItemBackground,"Select Check Color":e.colors.selectControls.checkColor}},"Navigation & Menus":{"Content Tabs":{"Tab Background":e.colors.navigation.tabs.background,"Tab Selected Background":e.colors.navigation.tabs.selectedBackground,"Tab Selected Text Color":e.colors.navigation.tabs.selectedTextColor,"Tab Text Color":e.colors.navigation.tabs.textColor},"Main & Chat Menus":{"Menu Selected Item (BG & Text)":e.colors.navigation.mainMenu.selectedItem,"Menu Icon Color":e.colors.navigation.mainMenu.iconColor,"Menu Icon Hover (BG & Text)":e.colors.navigation.mainMenu.iconHover,"Chat Menu Background":e.colors.navigation.mainMenu.chatMenuBackground,"Chat Title Menu Background":e.colors.navigation.mainMenu.chatTitleMenuBackground,"Thumbtack Selected Color":e.colors.navigation.mainMenu.thumbtackSelectedColor,"Table Menu Background":e.colors.navigation.mainMenu.tableMenuBackground,"Table Menu Button Hover BG":e.colors.navigation.mainMenu.tableMenuButtonHover},"Focus Mode Menu":{"Focus Menu Hover Background":e.colors.navigation.focusModeMenu.hoverBackground,"Focus Menu Item Background":e.colors.navigation.focusModeMenu.itemBackground},"Application Nav Tabs":{"Nav Tab Background":e.colors.navigation.navTabs.background,"Nav Tab Text Color":e.colors.navigation.navTabs.textColor,"Nav Tab Active Background":e.colors.navigation.navTabs.activeBackground,"Nav Tab Active Text Color":e.colors.navigation.navTabs.activeTextColor,"Nav Tab Indicator Light":e.colors.navigation.navTabs.indicatorLight}},"File System":{"General File Styling":{"File Item Background":e.colors.fileSystem.itemBackground,"Default File Icon Color":e.colors.fileSystem.iconDefault,"Folder Icon Color":e.colors.fileSystem.iconFolder},"File Type Indicators (Backgrounds)":{"PDF Type BG":e.colors.fileSystem.typePdf,"Image Type BG":e.colors.fileSystem.typeImage,"Audio Type BG":e.colors.fileSystem.typeAudio,"Video Type BG":e.colors.fileSystem.typeVideo,"Document Type BG":e.colors.fileSystem.typeDoc,"Folder Type BG":e.colors.fileSystem.typeFolder,"Spreadsheet Type BG":e.colors.fileSystem.typeSpreadsheet,"Text File Type BG":e.colors.fileSystem.typeText,"Other File Type BG":e.colors.fileSystem.typeOther},"File Additional":{"File Progress Bar Background":e.colors.fileSystem.progressBackground,"File Session (BG & Text)":e.colors.fileSystem.session}},"Lists & Tables":{"General List Items":{"List Item (BG & Ring)":e.colors.listsAndTables.listItem,"List Item Hover BG":e.colors.listsAndTables.listHover,"List Status Tag (BG & Text)":e.colors.listsAndTables.listStatusTag},"Table Specific Styling":{"Table Hover Background":e.colors.listsAndTables.tableHoverBackground,"Table Drag Background":e.colors.listsAndTables.tableDragBackground,"Table Card Background":e.colors.listsAndTables.tableCardBackground,"Table Resize Handle BG":e.colors.listsAndTables.tableResizeHandle}},"Notifications (Toasts)":{"Toast Styles (BG, Text, Border)":{"Success Toast":e.colors.notifications.success,"Error Toast":e.colors.notifications.error,"Warning Toast":e.colors.notifications.warning,"Info Toast":e.colors.notifications.info}},"CPU Actions":{"Action Indicator Backgrounds":{"Load Action BG":e.colors.cpuActions.load,"Click Action BG":e.colors.cpuActions.click,"Input Action BG":e.colors.cpuActions.input,"Generic Action BG":e.colors.cpuActions.action,"Thinking Action BG":e.colors.cpuActions.thinking,"Goal Action BG":e.colors.cpuActions.goal,"Stop Action BG":e.colors.cpuActions.stop}},"Markdown & Content":{"Blockquote (Direct Values)":{"Blockquote Border Color":e.colors.markdown.blockquoteBorderColor,"Blockquote Background Color":e.colors.markdown.blockquoteBackgroundColor,"Blockquote Text Color":e.colors.markdown.blockquoteTextColor},"Links (Direct Values)":{"Markdown Link Color":e.colors.markdown.linkColor,"Markdown Link Hover Color":e.colors.markdown.linkHoverColor}},"Memory & Sources":{"Memory UI":{"Memory Placeholder Text":e.colors.memoryAndSources.memoryPlaceholderText,"Memory Crawl Icon BG":e.colors.memoryAndSources.memoryCrawlIconBackground,"Memory Video Icon BG":e.colors.memoryAndSources.memoryVideoIconBackground},"Source Display":{"Source Tile Background":e.colors.memoryAndSources.sourceTileBackground,"Source Tile Hover Background":e.colors.memoryAndSources.sourceTileHoverBackground,"Source Number Background (Direct HEX)":e.colors.memoryAndSources.sourceNumberBackgroundHex,"Source Number Background (Tailwind)":e.colors.memoryAndSources.sourceNumberBackground,"Source Number Hover (BG & Text)":e.colors.memoryAndSources.sourceNumberHover,"Suggestion (Text, Ring, Hover BG)":e.colors.memoryAndSources.suggestion}},"Miscellaneous UI Elements":{"General UI":{"Selector Unselected Background":e.colors.uiElementsMisc.selectorUnselectedBackground,"Helper Hover State (BG & Text)":e.colors.uiElementsMisc.helperHoverState,"Global Icon Color":e.colors.uiElementsMisc.iconColor,"Workspace Default Icon (BG & Text)":e.colors.uiElementsMisc.workspaceDefaultIcon},"Progress Bars & Sliders":{"Progress Bar Background":e.colors.uiElementsMisc.progressBarBackground,"Slider Thumb Color (Direct HEX)":e.colors.uiElementsMisc.sliderThumbColor,"Slider Rail Color":e.colors.uiElementsMisc.sliderRailColor},"Skills UI":{"Skill Tag (BG & Text)":e.colors.uiElementsMisc.skillTag,"Skill Container Background":e.colors.uiElementsMisc.skillContainerBackground}}},i=e=>{try{if(Array.isArray(e)){const t=e.find((e=>e.color));return t?t.color:"#000000"}return"string"==typeof e&&e.startsWith("#")?e:"object"==typeof e&&null!==e&&e.color||"#000000"}catch(e){return"#000000"}};return Object.entries(s).forEach((([e,s])=>{const a=document.createElement("div");a.classList=`${this.theme.modalSeperationBorderColor} border rounded-md overflow-hidden`;const l=document.createElement("div");l.classList=`p-4 cursor-pointer ${this.theme.selectMenuBackground}`;const c=document.createElement("div");c.className="flex justify-between items-center";const d=document.createElement("span");d.className="font-medium",d.textContent=e;const h=document.createElement("div");new r.I({...o.A.name("chevronDown"),sizeClasses:"w-4 h-4"}).render(h),c.appendChild(d),c.appendChild(h),l.appendChild(c);const m=document.createElement("div");m.classList="p-4 space-y-4 hidden",Object.entries(s).forEach((([t,s])=>{const a=document.createElement("div");a.classList="mb-6";const o=document.createElement("div");o.classList="text-sm font-medium mb-3",o.textContent=t,a.appendChild(o);const r=document.createElement("div");r.classList="grid grid-cols-2 gap-4 text-sm",Object.entries(s).forEach((([s,a])=>{const o=document.createElement("div"),l={label:s,placeholder:"Select a color",value:i(a),showResetButton:!0,required:!0,theme:"default",themeMode:"dark",format:"hex",alpha:!0,swatches:[],closeButton:!1,onChange:()=>{A.hasUnSavedChanges(!0),A.waitingOnData(!1)}};"Main Background"===s?l.onChange=e=>{A.hasUnSavedChanges(!0),this.advancedThemeColors.mainBackground=e,n(!0,e)}:"Default Background"===s&&(l.onChange=e=>{A.hasUnSavedChanges(!0),this.advancedThemeColors.hoverBackground=e,n(!0,this.advancedThemeColors.mainBackground,e)});const c=new He(l),d=`${e}.${t}.${s}`;this.themeColorPickers[d]=c,c.render(o),r.appendChild(o)})),a.appendChild(r),m.appendChild(a)})),l.addEventListener("click",(()=>{const e=m.classList.toggle("hidden");h.innerHTML="";const t=e?"chevronDown":"chevronUp";new r.I({...o.A.name(t),sizeClasses:"w-4 h-4"}).render(h)})),a.appendChild(l),a.appendChild(m),t.appendChild(a)})),t};let u=null;if(e)try{await y.a.getWorkspaceTheme(this.workspace.slug,e.id).then((e=>{u=e.theme}))}catch(e){return void new c.y("Failed to get theme data","error")}function p(e){return e.match(/bg-\[(#[A-Fa-f0-9]+)\]/)?.[1]||null}e&&(this.initialBackgroundColor=p(e.preview.background),this.initialPrimaryColor=p(e.preview.primary));const g=new E({label:"Font",placeholder:"Select a font",options:h,required:!0,disabled:!1,required:!0,value:e?e.preview.font:null,error:"Please select a font",helpText:""}),f={label:"Background color",placeholder:"Select a color",value:e?p(e.preview.background):"#ffffff",required:!0,theme:"default",themeMode:"dark",format:"hex",showResetButton:!!e,alpha:!0,swatches:[],closeButton:!1},v=new He(f),b={label:"Primary color",placeholder:"Select a color",value:e?p(e.preview.primary):"#000000",required:!0,theme:"default",themeMode:"dark",format:"hex",showResetButton:!!e,alpha:!0,swatches:[],closeButton:!1},C=new He(b),x=new d({label:"Theme name",placeholder:"e.g. Corporate theme",required:!0,value:e?e.name:"",width:"full"});let k=null;if(u){k=document.createElement("div"),k.classList="flex justify-center align-middle items-center";const e=u&&"advanced"===u.mode;this.tabControl=new w({tabs:[{title:"Simple",value:"simple",selected:!e},{title:"Advanced",value:"advanced",selected:e}],onTabChange:e=>{if("simple"===e)new a("Are your sure you want to discard changes?","Switching to simple theme mode will discard all changes you have made.").onConfirm((()=>{T.innerHTML="",T.appendChild(L)}));else{const e=v.value,t=C.value;e!==this.initialBackgroundColor||t!==this.initialPrimaryColor?new a("Are your sure you want to discard changes?","Switching to advanced theme mode will discard all changes you have made.").onConfirm((()=>{T.innerHTML="",T.appendChild(m(u))})):(T.innerHTML="",T.appendChild(m(u)))}}}),setTimeout((()=>{this.tabControl.render(k)}),0)}const S=document.createElement("div");S.classList="flex w-[100%] gap-6 pt-6";const T=document.createElement("div"),L=document.createElement("div");L.classList="flex justify-between gap-4";const _=document.createElement("div");_.classList="flex flex-col gap-3 w-[100%] sm:w-[55%]";const I=document.createElement("div");I.classList="sm:flex flex-col gap-4 w-[40%] hidden",I.innerHTML='<h2 class="text-lg font-bold">Preview</h2><div class="w-full h-[40%] bg-gray-200 rounded-md"></div>',x.render(_),u&&_.appendChild(k),v.render(L),C.render(L),u&&"advanced"===u.mode?T.appendChild(m(u)):T.appendChild(L),_.appendChild(T),g.render(_),S.appendChild(_),S.appendChild(I);const A=new l({size:"extraLarge",title:e?"Edit theme":"Create a theme",closeX:!0,confirmOnExit:!0,confirmText:e?"Update theme":"Create theme",confirm:!0,manualCloseOnConfirm:!0,buttonWidth:"full",buttonSize:"large",body:S});A.waitingOnData(!0);const M=()=>{const e=x.value.trim(),t=g.value;e.length<3?A.waitingOnData(!0):v.value&&C.value&&t?A.waitingOnData(!1):A.waitingOnData(!0)};I.innerHTML=e?s(p(e.preview.background),p(e.preview.primary),e.preview.font):s("#ffffff","#000000","Inter"),x.onChange((()=>{M(),A.hasUnSavedChanges(!0),n()})),v.onChange((()=>{M(),A.hasUnSavedChanges(!0),n()})),C.onChange((()=>{M(),A.hasUnSavedChanges(!0),n()})),g.onChange((()=>{M(),A.hasUnSavedChanges(!0),n()})),A.onConfirm((()=>{A.hasUnSavedChanges(!1),A.close();const t=e?"Updating your theme...":"Creating your theme...",s=e?"Please be patient as we update your theme. It may take up to 5 minutes to generate using AI.":"Please be patient as we create your theme. It may take up to 5 minutes to generate.",i=document.createElement("div");i.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const n=document.createElement("div");n.classList.add("py-6","space-y-2");const a=document.createElement("div");a.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16 animate-spin",colorClass:this.theme.iconColor});a.appendChild(h.element),n.appendChild(a);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent=t,n.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent=s,n.appendChild(u),i.appendChild(n);const p=new l({size:"small",title:"",closeX:!1,body:i}),f=e=>{y.a.updateTheme(e).then((e=>{e.success&&(p.close(),new c.y(`${x.value} theme was updated successfully`,"success"),this.themesTable.loadData())})).catch((e=>{p.close(),new c.y("Error updating theme","error")}))};let w="simple";if(e){let t={slug:this.workspace.slug,themeName:x.value.trim(),font:g.value,mode:"simple",themeId:e.id};switch(w=this.tabControl.value,w){case"simple":t.backgroundColor=v.value,t.primaryColor=C.value,f(t);break;case"advanced":const e={};Object.entries(this.themeColorPickers).forEach((([t,s])=>{const[i,n,a]=t.split(".");e[i]=e[i]||{},e[i][n]=e[i][n]||{},e[i][n][a]=s.value})),t.advancedColors=e,t.mode="advanced",f(t)}}else{const e=x.value.trim(),t=v.value,s=C.value,i=g.value,n={slug:this.workspace.slug,themeName:e,backgroundColor:t,primaryColor:s,font:i};y.a.createTheme(n).then((t=>{t.success?(p.close(),new c.y(`${e} theme was created successfully`,"success"),this.themesTable.loadData()):(p.close(),new c.y(`Error creating theme: ${t.error}`,"error"))})).catch((e=>{p.close(),new c.y("Error creating theme","error")}))}}))}handleThemeAction(e,t){switch(e){case"preview":this.handleThemePreview(t);break;case"edit_settings":this.handleThemeSettings(t);break;case"enable":this.enableTheme(t);break;case"disable":this.disableTheme(t);break;case"delete":this.handleThemeDelete(t)}}async handleThemePreview(e){}async handleThemeSettings(e){this.handleCreateAndEditTheme(e)}async disableTheme(e){try{const t={slug:this.workspace.slug,themeId:e.id,status:!1},s=await y.a.updateThemeStatus(t);if(!s.success||s.message)return new c.y(s.message,"info"),void this.themesTable.loadData();new c.y("Theme disabled successfully","success"),this.themesTable.loadData()}catch(e){new c.y("There was a problem updating the theme status","error")}}async enableTheme(e){try{const t={slug:this.workspace.slug,themeId:e.id,status:!0};(await y.a.updateThemeStatus(t)).success&&(new c.y("Theme enabled successfully","success"),this.themesTable.loadData())}catch(e){new c.y("There was a problem updating the theme status","error")}}async deleteTheme(e){try{const t={slug:this.workspace.slug,themeId:e.id},s=await y.a.deleteTheme(t);s.error&&s.default_theme?new c.y(s.error,"info"):s.success?new c.y("Theme deleted successfully","success"):new c.y(s.error||"There was an unknown error","error"),this.themesTable.loadData()}catch(e){}}async handleThemeDelete(e){new a("Are you sure?","This theme will be permanently deleted").onConfirm((()=>{this.deleteTheme(e)}))}async renderWorkspaceSettings(){if(!u.K.hasPermission("workspace:settings"))return void new c.y("You do not have permission to view this page","info");this.contentContainer.innerHTML="";const e=document.createElement("div");e.classList="flex flex-col w-full leading-7 pb-2 sm:max-w-full md:max-w-full lg:max-w-full xl:max-w-full 2xl:max-w-full gap-2 mt-0 sm:mt-4 items-center px-0.5 overflow-y-auto",this.contentContainer.appendChild(e);const t=document.createElement("div");t.classList="flex flex-col px-4 w-full gap-4",e.appendChild(t);const s=document.createElement("div");s.classList="w-full flex flex-col text-2xl font-bold mb-2",s.innerText="Settings",t.appendChild(s);const i=[{type:"text",title:this.workspace.name,description:"Workspace name",action:{type:"button",text:"Edit",buttonType:"secondary",onClick:()=>this.showWorkspaceNameModal()},family:!0},{type:"image",title:"Logo",description:"This image is used in the menu and as a the loading image.",preview:{type:"image",id:"logoPreview",size:"w-16 h-16",value:this.workspace.image,defaultIcon:"buildings"},action:{type:"button",text:"Upload",buttonType:"secondary",onClick:()=>this.showLogoUploadModal()},family:!0},{type:"image",title:"Favicon",description:"This icon appears in browser tabs and bookmarks.",preview:{type:"image",size:"w-8 h-8",value:this.workspace.favicon,defaultIcon:"star"},action:{type:"button",text:"Upload",buttonType:"secondary",onClick:()=>this.showFaviconUploadModal()},family:!0},{type:"text",title:this.workspace.default_model.name,description:"Default AI model",preview:{type:"image",rounded:"rounded-full",size:"w-8 h-8",value:this.workspace.default_model.image,defaultIcon:"star"},action:{type:"button",text:"Change",buttonType:"secondary",onClick:()=>this.showDefaultModelModal()},family:!0},{type:"text",title:this.workspace.default_assistant.name,description:"Default workspace assistant",preview:{type:"image",rounded:"rounded-full",size:"w-8 h-8",value:this.workspace.default_assistant.image,defaultIcon:"star"},action:{type:"button",text:"Change",buttonType:"secondary",onClick:()=>this.showDefaultAssistantModal()},family:!0},{type:"text",title:this.workspace.default_theme.theme_name,description:"Default theme",action:{type:"button",text:"Change",buttonType:"secondary",onClick:()=>this.showThemeSelectionModal()},family:!0},{type:"text",title:this.workspace.custom_domain?`${this.workspace.custom_domain}`:`https://${this.workspace.slug}.simtheory.ai`,titleClass:"workspace-URL",description:"Workspace domain",action:{type:"multiButton",buttons:[{text:this.workspace.custom_domain?"Manage domain":"Setup custom domain",buttonType:"primary",onClick:()=>this.showCustomDomainModal()},{text:"Edit",buttonType:"secondary",onClick:()=>this.showWorkspaceSlugModal()}]},family:!1},{type:"switch",title:"Enable custom workspace support",description:"Configure a custom support setup",action:{type:"multiButton",buttons:[{text:this.workspace.custom_support?"Edit configuration":"Configure",buttonType:"link",onClick:()=>this.editCustomSupport()},{type:"switch",value:this.workspace.custom_support.state||!1,onChange:async e=>{try{if(e&&!this.workspace.custom_support.disable_support&&!this.workspace.custom_support.email&&!this.workspace.custom_support.documentation_url)return new c.y("Please configure your support before switching on","info"),!1;const t={custom_support_state:e},s=await y.a.updateCustomSupport(t);return s.success?(this.workspace.custom_support.state=e,new c.y("Custom support setting has been updated successfully","success"),!0):(new c.y(s.message||"Failed to update setting","error"),!1)}catch(e){return new c.y("Failed to update setting","error"),!1}}}]},family:!1},{type:"switch",title:"Show Getting Started in menu",description:"When disabled, the Getting Started section will be hidden from the menu",action:{type:"switch",value:!1!==this.workspace.getting_started,onChange:async e=>{try{if(e){const t=await y.a.setGettingStarted(e);return t.success?(this.workspace.getting_started=e,e&&this.renderMenuItems(),!0):(new c.y(t.message||"Failed to update setting","error"),!1)}{const t=await y.a.setGettingStarted(e);if(t.success){if(this.workspace.getting_started=e,!e){const e=document.getElementById("menu-item-setup");e&&e.remove()}return!0}return new c.y(t.message||"Failed to update setting","error"),!1}}catch(e){return new c.y("Failed to update setting","error"),!1}}}}],a=e=>{if(("family"===this.workspace.plan_type||"family_max"===this.workspace.plan_type)&&!e.family)return;const t=document.createElement("div");t.classList=`flex flex-col w-full gap-4 ${this.theme.listTableItem} ring-1 rounded-md p-4`;const s=document.createElement("div");s.classList="flex gap-4";const i=document.createElement("div");if(i.classList="flex gap-4 flex-1 items-center",e.preview){let t="rounded-lg";e.preview.rounded&&(t=e.preview.rounded);const s=document.createElement("div");if(s.classList="flex shrink-0",e.preview.value)s.innerHTML=`<img src="${e.preview.value}" class="${t} ${e.preview.size} object-cover">`;else{const i=document.createElement("div");i.className=`${t} ${e.preview.size} ${this.theme.workspaceDefaultIcon} flex justify-center align-middle items-center`;const n=o.A.name(e.preview.defaultIcon),a=new r.I({pathData:n.path,viewBox:n.viewBox});a.element&&i.appendChild(a.element),s.innerHTML="",s.appendChild(i)}i.appendChild(s)}const a=document.createElement("div");a.classList="flex flex-col leading-5 min-w-0";const l=document.createElement("div");e.titleClass?l.classList=`text-base font-bold truncate ${e.titleClass}`:l.classList="text-base font-bold truncate",l.textContent=e.title;const c=document.createElement("div");c.classList=`text-sm ${this.theme.fadedText} truncate`,c.textContent=e.description,a.appendChild(l),a.appendChild(c),i.appendChild(a);const d=document.createElement("div");d.classList="flex flex-none items-center";const h=document.createElement("div");if(h.classList="flex gap-x-2 h-8 shrink-0","button"===e.action.type){const t=new n.$({text:e.action.text,size:"small",type:e.action.buttonType,width:"auto"});t.render(h),e.action.onClick&&t.onClick(e.action.onClick)}else if("multiButton"===e.action.type)e.action.buttons&&e.action.buttons.forEach((e=>{if("switch"===e.type){const t=new C({size:"medium",value:e.value,disabled:e.disabled||!1});t.render(h),e.onChange&&t.onChange((async s=>{!1===await e.onChange(s)&&t.setValue(!s,!0)})),h.classList.add("pt-1.5")}else{const t=new n.$({text:e.text,size:"small",type:e.buttonType,width:"auto"});t.render(h),e.onClick&&t.onClick(e.onClick)}}));else if("switch"===e.action.type){const t=new C({size:"medium",value:e.action.value,disabled:e.action.disabled||!1});t.render(h),e.action.onChange&&t.onChange((async s=>{!1===await e.action.onChange(s)&&t.setValue(!s)}))}return d.appendChild(h),s.appendChild(i),s.appendChild(d),t.appendChild(s),t};i.forEach((e=>{t.appendChild(a(e))}))}editCustomSupport(){const e=document.createElement("div");e.classList="space-y-6";const t=document.createElement("div");t.classList=`${this.theme.fadedText} text-base mb-4`,t.innerHTML="Configure your workspace to send support emails to your own support inbox and link to your own documentation. You can also disable the support features completely.",e.appendChild(t);const s=document.createElement("div");s.classList=`py-3 ${this.theme.secondaryBackground} rounded-md px-4`;const i=!0===this.workspace.custom_support.disable_support,n=new C({label:"Disable support features",value:i,helpText:"WARNING: Users will not see any support options in your workspace",size:"normal"});n.render(s),e.appendChild(s);const a=document.createElement("div");a.classList="mt-4";const o={label:"Support email address:",type:"email",placeholder:"support@yourdomain.com",value:this.workspace.custom_support.email||"",helpText:"Ticket emails will come from <simulation@simtheory.ai>, please white list this email."},r=new d(o);r.render(a),e.appendChild(a);const h=document.createElement("div");h.classList="mt-4";const m={label:"Documentation URL:",type:"url",placeholder:"https://docs.yourdomain.com",value:this.workspace.custom_support.documentation_url||"",helpText:"We will link to this URL in the support menu"},u=new d(m);u.render(h),e.appendChild(h);const p=i,g=this.workspace.custom_support.email||"",f=this.workspace.custom_support.documentation_url||"",v=new l({size:"medium",title:"Configure support options",closeX:!0,confirm:!0,confirmText:"Save",cancel:!1,buttonWidth:"full",buttonSize:"large",body:e,confirmOnExit:!0,manualCloseOnConfirm:!0,onConfirm:async()=>{if(!n.value){if(r.value&&!r.validate())return new c.y("Valid support email is required","error"),!1;if(u.value&&!u.validate())return new c.y("Valid documentation URL is required","error"),!1}try{v.toggleConfirmLoading("Saving...");const e={disable_support:n.value,custom_support_email:r.value,custom_support_documentation_url:u.value},t=await y.a.updateCustomSupport(e);return t.success?(this.workspace.custom_support.disable_support=e.disable_support,this.workspace.custom_support.email=e.custom_support_email,this.workspace.custom_support.documentation_url=e.custom_support_documentation_url,e.custom_support_email||e.custom_support_documentation_url?this.workspace.custom_support.state=!0:this.workspace.custom_support.state=!1,this.renderWorkspaceSettings(),new c.y("Support settings updated successfully","success"),v.closeProcess(),!0):(new c.y(t.error||"Failed to update support settings","error"),v.toggleConfirmLoading(),!1)}catch(e){return new c.y("Failed to update support settings","error"),v.toggleConfirmLoading(),!1}}}),w=()=>{v.hasUnSavedChanges(n.value!==p||r.value!==g||u.value!==f)},b=e=>{e?(r.disable(),u.disable(),a.classList.add("opacity-50"),h.classList.add("opacity-50")):(r.enable(),u.enable(),a.classList.remove("opacity-50"),h.classList.remove("opacity-50"))};n.onChange((()=>{w(),b(n.value)})),r.onChange((()=>{w()})),u.onChange((()=>{w()})),b(i),n.update()}showLogoUploadModal(){const e=document.createElement("div"),t=document.createElement("div");t.classList=`${this.theme.fadedText} text-sm`,t.innerHTML="This logo is used in the menu and as the loading image. <strong>Recommended size:</strong> 250x250px",e.appendChild(t);const s=new J({uiType:"uploadBox",label:"",maxFiles:1,maxSizePerFile:25,maxTotalSize:25,allowedTypes:["image/jpg","image/jpeg","image/png","image/webp"],showUploadButton:!0});s.render(e);const i=new l({size:"small",title:"Upload logo",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Change logo",confirm:!0,buttonWidth:"full",buttonSize:"large",body:e});i.waitingOnData(!0),s.onChange((()=>{i.hasUnSavedChanges(!0),s.files.length>0&&!s.isUploadInProgress?i.waitingOnData(!1):i.waitingOnData(!0)})),i.onConfirm((async()=>{if(i.hasUnSavedChanges(!1),0===s.files.length)return void new c.y("Please upload a file","info");const e=s.files[0];if(!["image/png","image/jpg","image/jpeg"].includes(e.type))return void new c.y("Please upload a PNG, JPG or JPEG file","info");i.close();const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const n=document.createElement("div");n.classList.add("py-6","space-y-2");const a=document.createElement("div");a.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});h.element&&a.appendChild(h.element),n.appendChild(a);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent="Updating logo...",n.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent="Applying the logo to this workspace.",n.appendChild(u),t.appendChild(n);const p=new l({size:"small",title:"",closeX:!1,body:t}),g={workspace:this.workspace.slug,uploadFileID:s.value};await y.a.updateWorkspaceImage(g).then((e=>{if(e.success){p.close(),new c.y("Logo updated successfully","success"),this.workspace.image=e.image;const t=document.querySelector(".workspace-image");if(t)t.src=e.image;else{const t=document.querySelector(".workspace-image-placeholder");t&&(t.outerHTML=`<img src="${e.image}" class="workspace-image w-16 h-16 rounded-lg object-cover">`)}this.renderWorkspaceSettings()}else p.close(),new c.y("Error updating logo","error")}))}))}showFaviconUploadModal(){const e=document.createElement("div"),t=document.createElement("div");t.classList=`${this.theme.fadedText} text-sm`,t.innerHTML="This icon appears in browser tabs and bookmarks. <strong>Recommended size:</strong> 32x32px",e.appendChild(t);const s=new J({uiType:"uploadBox",label:"",maxFiles:1,maxSizePerFile:2,maxTotalSize:2,allowedTypes:["image/png","image/x-icon","image/vnd.microsoft.icon"],showUploadButton:!0});s.render(e);const i=new l({size:"small",title:"Upload favicon",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Change favicon",confirm:!0,buttonWidth:"full",buttonSize:"large",body:e});i.waitingOnData(!0),s.onChange((()=>{i.hasUnSavedChanges(!0),s.files.length>0&&!s.isUploadInProgress?i.waitingOnData(!1):i.waitingOnData(!0)})),i.onConfirm((async()=>{if(i.hasUnSavedChanges(!1),0===s.files.length)return void new c.y("Please upload a file","info");const e=s.files[0];if(!["image/png","image/x-icon","image/vnd.microsoft.icon"].includes(e.type))return void new c.y("Please upload a PNG or ICO file","info");if(e.size>2097152)return new c.y("Please upload a file less than 2MB","info"),void s.clearAllFiles();i.close();const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const n=document.createElement("div");n.classList.add("py-6","space-y-2");const a=document.createElement("div");a.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});h.element&&a.appendChild(h.element),n.appendChild(a);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent="Updating favicon...",n.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent="Applying the favicon to this workspace.",n.appendChild(u),t.appendChild(n);const p=new l({size:"small",title:"",closeX:!1,body:t}),g={workspace:this.workspace.slug,uploadFileID:s.value};await y.a.updateWorkspaceFavicon(g).then((e=>{e.success?(p.close(),new c.y("Favicon updated successfully","success"),this.workspace.favicon=e.favicon,this.renderWorkspaceSettings()):(p.close(),new c.y("Error updating favicon","error"))}))}))}showWorkspaceNameModal(){const e=document.createElement("div");e.classList="space-y-4";const t=document.createElement("div");t.classList=`${this.theme.fadedText} text-sm`,t.innerHTML="This is what your workspace will be called",e.appendChild(t);const s={label:"Name:",type:"text",placeholder:"Enter workspace name",value:this.workspace.name,minChar:2,maxChar:30,required:!0,error:"Workspace name is required"},i=new d(s);i.render(e);const n=new l({size:"small",title:"Workspace name",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Save changes",confirm:!0,buttonWidth:"full",buttonSize:"large",body:e});n.waitingOnData(!0),i.onChange((e=>{n.hasUnSavedChanges(!0),n.waitingOnData(!e.trim())})),n.onConfirm((async()=>{if(n.hasUnSavedChanges(!1),!i.validate())return;const e=i.value.trim();if(e===this.workspace.name)return void n.close();n.close();const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const s=document.createElement("div");s.classList.add("py-6","space-y-2");const a=document.createElement("div");a.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});h.element&&a.appendChild(h.element),s.appendChild(a);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent="Updating workspace name...",s.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent="Applying the new name to this workspace.",s.appendChild(u),t.appendChild(s);const p=new l({size:"small",title:"",closeX:!1,body:t}),g={workspace:this.workspace.slug,name:e};try{if((await y.a.updateWorkspaceName(g)).success){p.close(),new c.y("Workspace name updated successfully","success"),this.workspace.name=e;const t=document.querySelector(".workspace-name");t&&(t.textContent=e),this.renderWorkspaceSettings()}else p.close(),new c.y("Error updating workspace name","error")}catch(e){p.close(),new c.y("Error updating workspace name","error")}}))}async showThemeSelectionModal(){const e=document.createElement("div");e.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const t=document.createElement("div");t.classList.add("py-6","space-y-2");const s=document.createElement("div");s.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const i=o.A.name("spinner"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});n.element&&s.appendChild(n.element),t.appendChild(s);const a=document.createElement("div");a.classList.add("text-lg","font-bold","text-center"),a.textContent="Loading themes...",t.appendChild(a);const d=document.createElement("div");d.classList.add("text-base","text-center"),d.textContent="Fetching available themes for your workspace.",t.appendChild(d),e.appendChild(t);const h=new l({size:"small",title:"",closeX:!1,body:e});try{const e=await y.a.getAvailableThemes(this.workspace.slug);if(!e.success)return h.close(),void new c.y("Error loading themes","error");h.close();const t=document.createElement("div");t.classList="space-y-4";const s=document.createElement("div");s.classList=`${this.theme.fadedText} text-sm`,s.innerHTML="Select the default theme for your workspace. This will be applied to all new users.",t.appendChild(s);const i={label:"Theme:",placeholder:"Select a theme",value:this.workspace.default_theme.theme_id,required:!0,error:"Please select a theme",options:e.themes.map((e=>({value:e.id,label:e.name})))},n=new E(i);n.render(t);const a=new l({size:"small",title:"Change default theme",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Save changes",confirm:!0,buttonWidth:"full",buttonSize:"large",body:t});a.waitingOnData(!1),n.onChange((e=>{a.hasUnSavedChanges(!0),a.waitingOnData(!e)})),a.onConfirm((async()=>{if(a.hasUnSavedChanges(!1),!n.validate())return;const t=n.value;if(t===this.workspace.default_theme.theme_id)return void a.close();a.close();const s=document.createElement("div");s.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const i=document.createElement("div");i.classList.add("py-6","space-y-2");const d=document.createElement("div");d.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const h=o.A.name("spinner"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});m.element&&d.appendChild(m.element),i.appendChild(d);const u=document.createElement("div");u.classList.add("text-lg","font-bold","text-center"),u.textContent="Updating theme...",i.appendChild(u);const p=document.createElement("div");p.classList.add("text-base","text-center"),p.textContent="Setting the new default theme for your workspace.",i.appendChild(p),s.appendChild(i);const g=new l({size:"small",title:"",closeX:!1,body:s});try{(await y.a.updateDefaultTheme({workspace:this.workspace.slug,themeId:t})).success?(g.close(),new c.y("Default theme updated successfully","success"),this.workspace.default_theme={theme_id:t,theme_name:e.themes.find((e=>e.id===t)).name},this.renderWorkspaceSettings()):(g.close(),new c.y("Error updating default theme","error"))}catch(e){g.close(),new c.y("Error updating default theme","error")}}))}catch(e){h.close(),new c.y("Error loading themes","error")}}showWorkspaceSlugModal(){if(this.workspace.custom_domain)return void new c.y("You cannot change the workspace URL because you have a custom domain setup. Remove the custom domain first.","info");const e=document.createElement("div");e.classList="space-y-4";const t=document.createElement("div");t.classList=`${this.theme.fadedText} text-sm`,t.innerHTML="This will change your workspace URL. Only lowercase letters, numbers, and hyphens are allowed.",e.appendChild(t);const s={label:"Workspace URL:",type:"text",placeholder:"enter-workspace-url",value:this.workspace.slug,minChar:3,maxChar:63,required:!0,error:"Workspace URL is required",prefix:"https://",suffix:".simtheory.ai",validation:{pattern:/^[a-z0-9-]+$/,message:"Only lowercase letters, numbers, and hyphens are allowed"}},i=new d(s);i.render(e);const n=new l({size:"small",title:"Edit workspace slug",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Save changes",confirm:!0,buttonWidth:"full",buttonSize:"large",body:e}),a=document.createElement("div");a.classList.add("text-amber-500","dark:text-amber-400","text-sm","font-medium","flex","items-center");const h=o.A.name("warning"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-7 h-7",additionalClasses:"mr-2 fill-current"});m.element&&a.appendChild(m.element);const u=document.createTextNode("Changing the URL will affect all existing bookmarks and links to your workspace.");a.appendChild(u),e.appendChild(a),n.waitingOnData(!0),i.onChange((e=>{n.hasUnSavedChanges(!0),n.waitingOnData(!e.trim()||!s.validation.pattern.test(e))})),n.onConfirm((async()=>{if(n.hasUnSavedChanges(!1),!i.validate())return;const e=i.value.trim();if(e===this.workspace.slug)return void n.close();n.close();const t=document.createElement("div");t.classList.add("space-y-4");const s=document.createElement("div");s.classList.add("text-base"),s.textContent="Are you sure you want to change your workspace URL?",t.appendChild(s);const a=document.createElement("div");a.classList.add("text-sm",this.theme.fadedText),a.innerHTML=`\n                From: https://${this.workspace.slug}.simtheory.ai<br>\n                To: https://${e}.simtheory.ai\n            `,t.appendChild(a);const d=document.createElement("div");d.classList.add("text-amber-500","dark:text-amber-400","text-sm","flex","items-center");const h=o.A.name("warning"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-7 h-7",additionalClasses:"mr-2 fill-current"});m.element&&d.appendChild(m.element);const u=document.createTextNode("This will break all existing bookmarks and links to your workspace.");d.appendChild(u),t.appendChild(d);new l({size:"small",title:"Confirm URL change",closeX:!0,confirm:!0,confirmText:"Yes, change URL",cancelText:"Cancel",buttonWidth:"full",buttonSize:"large",body:t}).onConfirm((async()=>{const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const s=document.createElement("div");s.classList.add("py-6","space-y-2");const i=document.createElement("div");i.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const n=o.A.name("spinner"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});a.element&&i.appendChild(a.element),s.appendChild(i);const d=document.createElement("div");d.classList.add("text-lg","font-bold","text-center"),d.textContent="Updating workspace URL...",s.appendChild(d);const h=document.createElement("div");h.classList.add("text-base","text-center"),h.textContent="This may take a few moments.",s.appendChild(h),t.appendChild(s);const m=new l({size:"small",title:"",closeX:!1,body:t}),u={workspace:this.workspace.slug,newSlug:e};try{const t=await y.a.updateWorkspaceSlug(u);if(t.success){m.close(),new c.y("Workspace URL updated successfully","success"),this.workspace.slug=e;const t="/chat/workspace/admin/billing";window.history.pushState({path:t},"",t);const s=document.querySelector(".workspace-URL");s&&(s.textContent=`https://${e}.simtheory.ai`)}else m.close(),new c.y(t.error||"Error updating workspace URL","error")}catch(e){m.close();const t=e.response?.error||e.message||"Error updating workspace URL";new c.y(t,"error")}}))}))}showCustomDomainModal(){const e=document.createElement("div");e.classList="space-y-6 pt-2";const t=(e,t)=>{const s=document.createElement("div");s.classList.add("flex","justify-between","items-center","gap-4");const i=document.createElement("div");i.classList.add(this.theme.fadedText,"text-sm"),i.textContent=e;const a=document.createElement("div");a.classList.add("flex","items-center","gap-2");const r=document.createElement("code");r.classList.add(this.theme.codeBlock,"px-2","py-1","rounded","text-sm"),r.textContent=t;const l=o.A.name("copy"),d=new n.$({svgPathData:l.path,svgViewBox:l.viewBox,type:"secondary",size:"icon"});return d.onClick((()=>{navigator.clipboard.writeText(t),new c.y("Copied to clipboard","success")})),a.appendChild(r),d.render(a),s.appendChild(i),s.appendChild(a),s},s=()=>{const e=document.createElement("div"),s=document.createElement("div");s.classList="font-medium text-lg",s.textContent="DNS Configuration",e.appendChild(s);const i=document.createElement("div");i.classList=`${this.theme.fadedText} text-base pb-2`,i.innerHTML="To use your custom domain, add these DNS records with your domain provider:",e.appendChild(i);const n=document.createElement("div");n.classList=`${this.theme.secondaryBackground} p-4 rounded-lg space-y-3`;const a=document.createElement("div");a.classList="space-y-2",a.appendChild(t("Type","A")),a.appendChild(t("Name",(e=>{const t=e.replace(/^(https?:\/\/)?(www\.)?/,"").split(".");return t.length>2?t.slice(0,-2).join("."):"@"})(this.workspace.custom_domain))),a.appendChild(t("Value","20.84.51.255")),a.appendChild(t("TTL","3600")),n.appendChild(a),e.appendChild(n);const l=document.createElement("div");l.classList.add("text-base","mt-4");const c=document.createElement("div");c.classList.add("flex","items-start","gap-2");const d=o.A.name("info"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-5 h-5",additionalClasses:`mt-1 ${this.theme.iconColor}`});h.element&&c.appendChild(h.element);const m=document.createElement("div"),u=document.createElement("p");u.classList.add("font-medium",this.theme.text,"pb-1"),u.textContent="Important Notes:",m.appendChild(u);const p=document.createElement("ul");p.classList.add("list-disc","ml-4",this.theme.fadedText,"space-y-1");return["DNS changes may take up to 48 hours to propagate globally.","Make sure to remove any existing A records for the same subdomain.","Some providers may require you to use @ or empty value for root domain."].forEach((e=>{const t=document.createElement("li");t.textContent=e,p.appendChild(t)})),m.appendChild(p),c.appendChild(m),l.appendChild(c),e.appendChild(l),e},i=(e,t,s)=>{e.innerHTML="",e.classList.remove("hidden");const i=(e,t,s=[],i=!1)=>{const n=document.createElement("div");n.classList.add("flex","items-center","gap-2");const a=o.A.name(e),l=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-5 h-5",additionalClasses:[...s,...i?["animate-spin"]:[]].join(" ")});l.element&&n.appendChild(l.element);const c=document.createElement("span");return c.classList.add("font-medium",this.theme.text),c.textContent=t,n.appendChild(c),n};if("checking"===t){e.className=`space-y-2 p-4 rounded-lg ${this.theme.toastInfo}`;const t=i("spinner","Checking domain configuration...",[this.theme.iconColor],!0);e.appendChild(t)}else if("success"===t){e.className=`space-y-2 p-4 rounded-lg ${this.theme.toastSuccess}`;const t=i("success","Domain configured correctly!",[this.theme.iconColor]);e.appendChild(t);const r=document.createElement("div");r.classList.add("text-sm",this.theme.fadedText),r.textContent=s,e.appendChild(r);const l=document.createElement("div");l.classList.add("mt-4");const c=document.createElement("div");c.classList.add("text-sm","mb-2"),c.textContent="Ready to go live? Submit a support ticket to activate your domain:",l.appendChild(c);const d=document.createElement("div");d.id="request-activation-button",l.appendChild(d),e.appendChild(l);const h=o.A.name("envelope"),m=new n.$({text:"Request domain activation",type:"primary",size:"small",svgPathData:h.path,svgViewBox:h.viewBox});m.onClick((()=>{void 0!==a&&a&&"function"==typeof a.close&&a.close(),new f(`Request to activate custom domain: ${this.workspace.custom_domain}`,`Please activate our custom domain:\n\nDomain: ${this.workspace.custom_domain}\nWorkspace: ${this.workspace.name}\nDNS Verification: Completed successfully\n\nPlease proceed with SSL certificate generation and domain activation.`)})),m.render(d)}else if("error"===t){e.className=`space-y-2 p-4 rounded-lg ${this.theme.toastError}`;const t=i("error","Something isn't right...",[this.theme.text]);e.appendChild(t);const n=document.createElement("div");n.classList.add("text-sm",this.theme.text),n.textContent=s,e.appendChild(n)}};let a;if(this.workspace.custom_domain){const t=document.createElement("div");t.classList="space-y-4";const o=document.createElement("div");o.classList=`${this.theme.secondaryBackground} px-4 py-4 rounded-lg pt-2`;const r=document.createElement("div");r.classList="flex justify-between items-center";const l=document.createElement("div");l.innerHTML=`\n                <div class="${this.theme.fadedText} text-sm">Current domain</div>\n                <div class="${this.theme.text} font-medium">${this.workspace.custom_domain}</div>\n            `;const d=new n.$({text:"Remove",type:"secondary",size:"small"});r.appendChild(l),d.render(r),o.appendChild(r),t.appendChild(o);const h=new n.$({text:"Verify Domain",type:"primary",size:"large",width:"full"}),m=(()=>{const e=document.createElement("div");return e.classList="hidden space-y-2 p-4 rounded-lg",e})();h.onClick((async()=>{i(m,"checking");try{const e=await y.a.verifyCustomDomain({workspace:this.workspace.slug,domain:this.workspace.custom_domain});if(e.success)i(m,"success","DNS records are properly configured. Your domain is ready to use.");else if(i(m,"error",e.error||"Failed to verify domain configuration. Please check your DNS settings."),e.details){const t=document.createElement("div");t.classList=`mt-2 text-sm ${this.theme.fadedText}`,t.innerHTML=`\n                                <ul class="list-disc ml-4 space-y-1">\n                                    ${Array.isArray(e.details)?e.details.map((e=>`<li>${e}</li>`)).join(""):`<li>${e.details}</li>`}\n                                </ul>\n                            `,m.appendChild(t)}}catch(e){i(m,"error","Failed to verify domain. Please try again.")}}));const u=document.createElement("div");h.render(u),t.appendChild(u),t.appendChild(m),e.appendChild(t);const p=document.createElement("hr");p.classList=`border-t ${this.theme.modalSeperationBorderColor}`,e.appendChild(p),e.appendChild(s()),d.onClick((async()=>{try{const e=await y.a.removeCustomDomain({workspace:this.workspace.slug});if(e.success){this.workspace.custom_domain=null,a.close(),new c.y("Domain removed successfully","success");const e=document.querySelector(".workspace-URL");e&&(e.textContent=`https://${this.workspace.slug}.simtheory.ai`)}else new c.y(e.error||"Failed to remove domain","error")}catch(e){new c.y("Failed to remove domain","error")}}))}else{const t=document.createElement("div");t.classList="space-y-4 pt-2";const s=new d({label:"Workspace URL:",type:"text",placeholder:"myworkspace.website.com",value:"",minChar:3,maxChar:200,required:!0,error:"Workspace URL is required",validation:{pattern:/^[a-zA-Z0-9][a-zA-Z0-9-_.]+\.[a-zA-Z]{2,}$/,message:"Please enter a valid domain name"}});s.render(t);const i=new n.$({text:"Next",type:"primary",size:"large",width:"full"});i.onClick((async()=>{if(!s.validate())return;i.toggleLoading("Saving...");const e=s.value.trim();try{const t=await y.a.updateCustomDomain({workspace:this.workspace.slug,domain:e});if(t&&t.success){this.workspace.custom_domain=e,a.close(),new c.y("Domain saved successfully","success"),setTimeout((()=>{this.showCustomDomainModal()}),100);const t=document.querySelector(".workspace-URL");t&&(t.textContent=`${e}`)}else new c.y(t.error||"Failed to save domain","error")}catch(e){new c.y("Failed to save domain","error")}finally{i.toggleLoading()}}));const o=document.createElement("div");i.render(o),t.appendChild(o),e.appendChild(t)}a=new l({size:"medium",title:this.workspace.custom_domain?"Custom domain":"Setup custom domain",closeX:!0,confirm:!1,buttonWidth:"full",buttonSize:"large",body:e})}showAllowedDomainsModal(){const e=document.createElement("div");e.classList="space-y-4";const t=document.createElement("div");t.classList=`${this.theme.fadedText} text-sm`,t.innerHTML="Whitelisted domains allow users to sign up with verified email addresses from these domains only.";const s=document.createElement("div");s.classList="space-y-2";const i=document.createElement("div");i.classList="flex flex-col gap-2 pt-2";const a=new d({label:"Add domain:",type:"text",placeholder:"domain.com",validation:{pattern:/^[a-zA-Z0-9][a-zA-Z0-9-_.]+\.[a-zA-Z]{2,}$/,message:"Please enter a valid domain"}});a.render(i);const r=new n.$({text:"Add",type:"secondary",size:"large"});r.render(i),e.appendChild(i),e.appendChild(s),e.appendChild(t);const h=async e=>{try{const t=await y.a.removeAllowedDomain({workspace:this.workspace.slug,domain:e});if(t.success){if(this.workspace.allowed_domains=t.allowed_domains,m(this.workspace.allowed_domains),0===this.workspace.allowed_domains.length&&this.workspace.allow_domain_join)try{(await y.a.updateDomainJoin({slug:this.workspace.slug,allow_domain_join:!1})).success&&(this.workspace.allow_domain_join=!1,this.renderWorkspaceSettings(),new c.y("Domain join has been disabled as there are no allowed domains","info"))}catch(e){new c.y("Failed to update domain join setting","error")}}else new c.y(t.error||"Failed to remove domain","error")}catch(e){new c.y("Failed to remove domain","error")}},m=(e=[])=>{if(s.innerHTML="",0===e.length){const e=document.createElement("div");return e.classList.add(this.theme.secondaryBackground,"rounded-lg","p-4","text-center",this.theme.fadedText),e.textContent="No domains added yet",void s.appendChild(e)}const t=document.createElement("div");t.classList.add(this.theme.fadedText,"text-sm","mb-2"),t.textContent=`${e.length}/3 domains added`,s.appendChild(t),e.forEach((e=>{const t=document.createElement("div");t.classList.add(this.theme.secondaryBackground,"rounded-lg","p-4","flex","justify-between","items-center");const i=document.createElement("div");i.textContent=e;const a=o.A.name("tabClose"),r=new n.$({svgPathData:a.path,svgViewBox:a.viewBox,type:"secondary",size:"small"});r.onClick((()=>h(e))),t.appendChild(i),r.render(t),s.appendChild(t)}))};r.onClick((async()=>{if(!a.validate())return;const e=a.value.trim().toLowerCase();if(this.workspace.allowed_domains||(this.workspace.allowed_domains=[]),this.workspace.allowed_domains.length>=3)new c.y("Maximum 3 domains allowed","error");else try{const t=await y.a.addAllowedDomain({workspace:this.workspace.slug,domain:e});t.success?(this.workspace.allowed_domains=t.allowed_domains||[],a.value="",m(this.workspace.allowed_domains),this.renderWorkspaceSettings()):"Domain already exists"===t.error?(this.workspace.allowed_domains=t.allowed_domains||[],m(this.workspace.allowed_domains),a.value="",new c.y(`Domain ${e} is already added`,"info")):new c.y(t.error||"Failed to add domain","error")}catch(e){new c.y(e.message||"Network error while adding domain","error")}}));new l({size:"small",title:"Manage allowed domains",closeX:!0,confirm:!0,confirmText:"Done",buttonWidth:"full",buttonSize:"large",body:e});m(this.workspace.allowed_domains||[])}deleteModel(e){new a("Are your sure?","Your custom forked model will be deleted.").onConfirm((async()=>{try{const t=await y.a.deleteModel(this.workspace.slug,e.id);t.success?(this.renderWorkspaceModels(),new c.y(t.message||"Model deleted successfully","success")):new c.y(t.error||"Failed to delete model","error")}catch(e){e.response?.data?.error?new c.y(e.response.data.error,"error"):new c.y("Failed to delete model. Please try again.","error")}}))}async renderWorkspaceAssistants(){if(!u.K.hasPermission("workspace:manage-assistants"))return void new c.y("You do not have permission to manage assistants","info");window.history.pushState({},`${this.workspace.name} assistants`,"/chat/workspace/admin/assistants"),document.title=`${this.workspace.name} assistants`,this.contentContainer.innerHTML="",this.showTableLoadingState();const e=await y.a.getWorkspaceAssistants(this.workspace.slug,{page:1,itemsPerPage:50,sortColumn:"name",sortOrder:"asc",search:"",filter:"all"});this.tableConfig=e.tableConfig,this.tableData=e.tableData,this.currentPage=e.currentPage,this.totalPages=e.totalPages,this.endOfData=e.endOfData||this.currentPage>=this.totalPages,this.assistantsTable=new Se(this.tableConfig,this.tableData,this.contentContainer),this.assistantsTable.setCallbacks({loadMore:this.loadAssistants.bind(this),onFilterChange:this.handleAssistantFilterChange.bind(this),onSort:this.handleAssistantSort.bind(this),onAction:this.handleAssistantAction.bind(this)}),this.assistantsTable.render()}async loadAssistants(e,t=50,s="name",i="asc",n="",a="all"){const o=await y.a.getWorkspaceAssistants(this.workspace.slug,{page:e,itemsPerPage:t,sortColumn:s,sortOrder:i,search:n,filter:a});return this.currentPage=o.currentPage,this.totalPages=o.totalPages,this.endOfData=o.endOfData,o.tableData}handleAssistantFilterChange(e,t){this.assistantsTable.loadData()}handleAssistantSort(e){this.assistantsTable.loadData({sortColumn:e.column,sortOrder:e.order})}handleAssistantAction(e,t){switch(e){case"view":window.location.href=t.share_url;break;case"remove":this.removeAssistant(t)}}removeAssistant(e){new a("Are your sure?","This will remove sharing permissions for this assistant.").onConfirm((async()=>{try{const t=await y.a.unshareAssistant(e.id);t.message?(this.renderWorkspaceAssistants(),new c.y(t.message,"success")):new c.y(t.error||"Failed to unshare assistant","error")}catch(e){new c.y("Failed to unshare assistant. Please try again.","error")}}))}async showDefaultAssistantModal(){const e=document.createElement("div");e.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const t=document.createElement("div");t.classList.add("py-6","space-y-2");const s=document.createElement("div");s.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const i=o.A.name("spinner"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});n.element&&s.appendChild(n.element),t.appendChild(s);const a=document.createElement("div");a.classList.add("text-lg","font-bold","text-center"),a.textContent="Loading assistants...",t.appendChild(a);const d=document.createElement("div");d.classList.add("text-base","text-center"),d.textContent="Fetching available assistants for your workspace.",t.appendChild(d),e.appendChild(t);const h=new l({size:"small",title:"",closeX:!1,body:e});try{const e=await y.a.getWorkspaceDefaultAssistantOptions(this.workspace.slug);if(!e.success)return h.close(),void new c.y("Error loading assistants","error");h.close();const t=document.createElement("div");t.classList="space-y-4 min-h-[250px] pt-2";const s=document.createElement("div");s.classList=`${this.theme.fadedText} text-sm`,s.innerHTML="The default assistant is available to every user. To make an assistant the default it must be shared with the workspace. Once an assistant is default it's permissions cannot be modified.";const i={label:"Select default assistant:",placeholder:"Select an assistant",value:this.workspace.default_assistant?{id:this.workspace.default_assistant.id,label:this.workspace.default_assistant.name,image:this.workspace.default_assistant.img_url||"https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751469/assets/simtchat_ef7pyv.png"}:null,required:!0,error:"Please select an assistant",items:e.assistants.map((e=>({id:e.id,label:e.label,image:e.image}))),autoBlur:!0},n=new k(i);n.render(t),t.appendChild(s);const a=new l({size:"small",title:"Default assistant",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Save changes",confirm:!0,buttonWidth:"full",buttonSize:"large",body:t});a.waitingOnData(!1),n.onChange((e=>{a.hasUnSavedChanges(!0),a.waitingOnData(!e)})),a.onConfirm((async()=>{if(a.hasUnSavedChanges(!1),!n.validate())return;const e=n.value;if(this.workspace.default_assistant&&e.id===this.workspace.default_assistant.id)return void a.close();a.close();const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const s=document.createElement("div");s.classList.add("py-6","space-y-2");const i=document.createElement("div");i.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});h.element&&i.appendChild(h.element),s.appendChild(i);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent="Updating default assistant...",s.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent="Setting the new default assistant for your workspace.",s.appendChild(u),t.appendChild(s);const p=new l({size:"small",title:"",closeX:!1,body:t});try{(await y.a.updateDefaultAssistant({workspace:this.workspace.slug,assistantId:e.id})).success?(p.close(),new c.y("Default assistant updated successfully","success"),this.workspace.default_assistant={id:e.id,name:e.label,image:e.image},this.renderWorkspaceSettings()):(p.close(),new c.y("Error updating default assistant","error"))}catch(e){p.close(),new c.y("Error updating default assistant","error")}}))}catch(e){h.close(),new c.y("Error loading assistants","error")}}async showDefaultModelModal(){const e=document.createElement("div");e.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const t=document.createElement("div");t.classList.add("py-6","space-y-2");const s=document.createElement("div");s.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const i=o.A.name("spinner"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});n.element&&s.appendChild(n.element),t.appendChild(s);const a=document.createElement("div");a.classList.add("text-lg","font-bold","text-center"),a.textContent="Loading models...",t.appendChild(a);const d=document.createElement("div");d.classList.add("text-base","text-center"),d.textContent="Fetching available models for your workspace.",t.appendChild(d),e.appendChild(t);const h=new l({size:"small",title:"",closeX:!1,body:e});try{const e=await y.a.getDefaultModelOptions(this.workspace.slug);if(!e.success)return h.close(),void new c.y("Error loading models","error");h.close();const t=document.createElement("div");t.classList="space-y-4 min-h-[250px] pt-2";const s=document.createElement("div");s.classList=`${this.theme.fadedText} text-sm`,s.innerHTML="The default model will be used for all new conversations in this workspace unless specifically overridden.";const i={label:"Select default model:",placeholder:"Select a model",value:this.workspace.default_model?{id:this.workspace.default_model.id,label:this.workspace.default_model.name}:null,required:!0,error:"Please select a model",items:e.models.map((e=>({id:e.id,label:e.label,image:e.image}))),autoBlur:!0},n=new k(i);n.render(t),t.appendChild(s);const a=new l({size:"small",title:"Default model",closeX:!0,confirmOnExit:!0,manualCloseOnConfirm:!0,confirmText:"Save changes",confirm:!0,buttonWidth:"full",buttonSize:"large",body:t});a.waitingOnData(!1),n.onChange((e=>{a.hasUnSavedChanges(!0),a.waitingOnData(!e)})),a.onConfirm((async()=>{if(a.hasUnSavedChanges(!1),!n.validate())return;const e=n.value;if(this.workspace.default_model&&e.id===this.workspace.default_model.id)return void a.close();a.close();const t=document.createElement("div");t.classList.add("flex","items-center","justify-center","align-middle","gap-4","h-[250px]");const s=document.createElement("div");s.classList.add("py-6","space-y-2");const i=document.createElement("div");i.className=`${this.theme.fadedText} flex flex-col items-center justify-center`;const d=o.A.name("spinner"),h=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:"w-16 h-16",additionalClasses:"animate-spin"});h.element&&i.appendChild(h.element),s.appendChild(i);const m=document.createElement("div");m.classList.add("text-lg","font-bold","text-center"),m.textContent="Updating default model...",s.appendChild(m);const u=document.createElement("div");u.classList.add("text-base","text-center"),u.textContent="Setting the new default model for your workspace.",s.appendChild(u),t.appendChild(s);const p=new l({size:"small",title:"",closeX:!1,body:t});try{(await y.a.updateDefaultModel(this.workspace.slug,e.id)).success?(p.close(),new c.y("Default model updated successfully","success"),this.workspace.default_model={id:e.id,name:e.label,image:e.image},this.renderWorkspaceSettings()):(p.close(),new c.y("Error updating default model","error"))}catch(e){p.close(),new c.y("Error updating default model","error")}}))}catch(e){h.close(),new c.y("Error loading models","error")}}async renderWorkspaceAnalytics(){this.sessionsChart=null,this.messagesChart=null,this.modelsChart=null,this.skillsChart=null,this.tokenUsageChart=null,this.mcpChart=null,this.contentContainer.innerHTML=`\n        <div class="flex flex-col h-full justify-center items-center align-middle">\n            <div class="h-full px-2 w-full max-w-[1200px]">\n                <div class="flex items-center justify-between mb-4 sticky top-0 z-10 pt-3">\n                    <div class="text-2xl font-bold">Analytics</div> \n                    <div class="flex gap-2">\n                        <button data-group="day" class="${this.theme.primaryButton} px-3 py-1.5 text-sm rounded-md">Daily</button>\n                        <button data-group="week" class="${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md">Weekly</button>\n                        <button data-group="month" class="${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md">Monthly</button>\n                        <button data-group="year" class="${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md">Yearly</button>\n                    </div>\n                </div>\n                <div class="overflow-y-auto h-[calc(var(--vh)*100-130px)] px-0.5 pt-0.5 pb-2"> \n                    <div class="">\n                        <div class="flex flex-col gap-3">\n                            ${this.renderChartContainers()}\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        `;const e={day:30,week:84,month:365,year:1825},t={day:"dd MMM",week:"dd MMM yyyy",month:"MMM yyyy",year:"yyyy"},s=await y.a.getWorkspaceAnalytics(this.workspace.slug,e.day,"day");if(!s.success)return void new c.y("Error loading analytics","error");if(s.topModels){const e=s.topModels.map((e=>e.model__name)),t=s.topModels.map((e=>e.count));this.modelsChart=new Fe.A(document.querySelector("#models-chart"),{...this.getPieChartOptions("Top Models"),labels:e,series:t}),await this.modelsChart.render()}if(s.topSkills){const e=s.topSkills.map((e=>e.skill_used)),t=s.topSkills.map((e=>e.count));this.skillsChart=new Fe.A(document.querySelector("#skills-chart"),{...this.getPieChartOptions("Top Skills"),labels:e,series:t}),await this.skillsChart.render()}if(s.topMCPs){const e=s.topMCPs.map((e=>e.mcp__name)),t=s.topMCPs.map((e=>e.count));this.mcpChart=new Fe.A(document.querySelector("#mcps-chart"),{...this.getPieChartOptions("Top MCPs"),labels:e,series:t}),await this.mcpChart.render()}const i=this.getChartOptions(t.day),n=this.theme.primaryButton.match(/bg-\[(.*?)\]/)?.[1]||"#2563eb";this.sessionsChart=new Fe.A(document.querySelector("#sessions-chart"),{...i,series:[{name:"Sessions",data:s.sessions.data,color:n}]}),this.messagesChart=new Fe.A(document.querySelector("#messages-chart"),{...i,series:[{name:"Messages",data:s.messages.data,color:n}]}),s.tokenUsage&&(this.tokenUsageChart=new Fe.A(document.querySelector("#token-usage-chart"),{...this.getChartOptions(t.day,"line"),series:[{name:"Input Tokens",data:s.tokenUsage.input_data},{name:"Output Tokens",data:s.tokenUsage.output_data},{name:"Premium Tokens",data:s.tokenUsage.premium_data}],colors:["#60a5fa","#34d399","#c084fc"],stroke:{width:[2,2,2],curve:"smooth"},legend:{position:"top",horizontalAlign:"right",labels:{colors:this.theme.text.match(/text-\[(.*?)\]/)?.[1]||"#71717a"},markers:{width:12,height:12,radius:12},itemMargin:{horizontal:10}},yaxis:{...i.yaxis,labels:{...i.yaxis.labels,formatter:e=>e>=1e6?(e/1e6).toFixed(1)+"M":e>=1e3?(e/1e3).toFixed(1)+"K":Math.round(e)}},tooltip:{...i.tooltip,y:{formatter:e=>e.toLocaleString()}}}),await this.tokenUsageChart.render()),await this.sessionsChart.render(),await this.messagesChart.render(),this.updateTotals(s),this.setupTimeGroupHandlers(e,t)}renderChartContainers(){return`\n            <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                <div class="flex justify-between gap-4 items-center align-middle">\n                    <div>\n                        <div class="text-bold text-lg">Messages</div>\n                        <div class="text-sm ${this.theme.fadedText}">Total number of messages exchanged between users and assistants</div>\n                    </div>\n                    <div class="text-2xl font-bold" id="total-messages"></div>\n                </div>\n                <div id="messages-chart" class="mt-4" style="min-height: 300px;"></div>\n            </div>\n    \n            <div class="grid grid-cols-2 gap-4">\n                <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                    <div class="flex justify-between gap-4 items-center align-middle">\n                        <div>\n                            <div class="text-bold text-lg">Models</div>\n                            <div class="text-sm ${this.theme.fadedText}">Most frequently used models in sessions</div>\n                        </div>\n                    </div>\n                    <div id="models-chart" class="mt-4" style="min-height: 300px;"></div>\n                </div>\n    \n                <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                    <div class="flex justify-between gap-4 items-center align-middle">\n                        <div>\n                            <div class="text-bold text-lg">Skills</div>\n                            <div class="text-sm ${this.theme.fadedText}">Most frequently used skills in sessions</div>\n                        </div>\n                    </div>\n                    <div id="skills-chart" class="mt-4" style="min-height: 300px;"></div>\n                </div>\n            </div>\n    \n            <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                <div class="flex justify-between gap-4 items-center align-middle">\n                    <div>\n                        <div class="text-bold text-lg">Top MCPs</div>\n                        <div class="text-sm ${this.theme.fadedText}">Most frequently installed MCPs in the workspace</div>\n                    </div>\n                </div>\n                <div id="mcps-chart" class="mt-4" style="min-height: 300px;"></div>\n            </div>\n    \n            <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                <div class="flex justify-between gap-4 items-center align-middle">\n                    <div>\n                        <div class="text-bold text-lg">Sessions</div>\n                        <div class="text-sm ${this.theme.fadedText}">The number of new sessions created by users of the workspace</div>\n                    </div>\n                    <div class="text-2xl font-bold" id="total-sessions"></div>\n                </div>\n                <div id="sessions-chart" class="mt-4" style="min-height: 300px;"></div>\n            </div>\n    \n            <div class="flex flex-col rounded-md px-4 py-4 w-full leading-5 ring-1 ${this.theme.ringColor}">\n                <div class="flex justify-between gap-4 items-center align-middle">\n                    <div>\n                        <div class="text-bold text-lg">Token usage</div>\n                        <div class="text-sm ${this.theme.fadedText}">Breakdown of token consumption</div>\n                    </div>\n                    <div class="text-2xl font-bold" id="total-tokens-usage"></div>\n                </div>\n                <div id="token-usage-chart" class="mt-4" style="min-height: 300px;"></div>\n            </div>\n        `}getPieChartOptions(e){const t=this.theme.primaryButton.match(/bg-\[(.*?)\]/)?.[1]||"#2563eb",s=this.theme.secondaryButton.match(/bg-\[(.*?)\]/)?.[1]||"#4b5563",i=[t,s,this.adjustColor(t,20),this.adjustColor(s,20),this.adjustColor(t,-20),this.adjustColor(s,-20),this.adjustColor(t,40),this.adjustColor(s,40),this.adjustColor(t,-40),this.adjustColor(s,-40)];return{chart:{type:"pie",height:300,fontFamily:this.theme.font,background:"transparent"},theme:{mode:"dark"},colors:i,plotOptions:{pie:{dataLabels:{offset:-25,minAngleToShowLabel:10},donut:{size:"0%"}}},legend:{position:"bottom",labels:{colors:this.theme.text.match(/text-\[(.*?)\]/)?.[1]||"#71717a"},markers:{fillColors:i}},dataLabels:{enabled:!0,formatter:function(e,t){return`${t.w.globals.labels[t.seriesIndex]} (${e.toFixed(0)}%)`},style:{fontSize:"12px",fontFamily:this.theme.font,colors:[this.theme.text.match(/text-\[(.*?)\]/)?.[1]||"#ffffff"]},dropShadow:{enabled:!1},textAnchor:"middle",distributed:!0,offsetX:0,offsetY:0},tooltip:{theme:"dark",y:{formatter:function(e){return e+" uses"}},background:this.theme.modalBackground.match(/bg-\[(.*?)\]/)?.[1]||"#27272a"},stroke:{width:0},fill:{opacity:.9,gradient:{enabled:!0,shade:"dark",type:"vertical",shadeIntensity:.2,gradientToColors:void 0,inverseColors:!1,opacityFrom:1,opacityTo:.9,stops:[0,90,100]}},responsive:[{breakpoint:480,options:{chart:{width:200},legend:{position:"bottom"}}}]}}adjustColor(e,t){e=e.replace(/^#/,"");let s=parseInt(e.substring(0,2),16),i=parseInt(e.substring(2,4),16),n=parseInt(e.substring(4,6),16);s=Math.max(0,Math.min(255,s+s*(t/100))),i=Math.max(0,Math.min(255,i+i*(t/100))),n=Math.max(0,Math.min(255,n+n*(t/100)));return`#${Math.round(s).toString(16).padStart(2,"0")}${Math.round(i).toString(16).padStart(2,"0")}${Math.round(n).toString(16).padStart(2,"0")}`}getChartOptions(e,t="area"){return{chart:{type:t,height:300,toolbar:{show:!1},fontFamily:this.theme.font,background:"transparent",animations:{enabled:!0,easing:"easeinout"}},stroke:{curve:"smooth",width:2},theme:{mode:"dark"},dataLabels:{enabled:!1},xaxis:{type:"datetime",labels:{datetimeFormatter:{year:"yyyy",month:"MMM 'yy",week:"dd MMM",day:"dd MMM"},format:e,style:{colors:this.theme.text.match(/text-\[(.*?)\]/)?.[1]||"#71717a"}},axisBorder:{color:this.theme.ringColor.match(/ring-\[(.*?)\]/)?.[1]||"#d4d4d8"},axisTicks:{color:this.theme.ringColor.match(/ring-\[(.*?)\]/)?.[1]||"#d4d4d8"}},yaxis:{labels:{style:{colors:this.theme.text.match(/text-\[(.*?)\]/)?.[1]||"#71717a"},formatter:e=>Math.round(e)}},tooltip:{theme:"dark",x:{format:e},y:{formatter:e=>Math.round(e)},background:this.theme.modalBackground.match(/bg-\[(.*?)\]/)?.[1]||"#27272a"},grid:{borderColor:this.theme.ringColor.match(/ring-\[(.*?)\]/)?.[1]||"#d4d4d8",strokeDashArray:4,yaxis:{lines:{show:!0}}}}}updateTotals(e){if(document.getElementById("total-sessions").textContent=e.sessions.total.toLocaleString()+" total",document.getElementById("total-messages").textContent=e.messages.total.toLocaleString()+" total",e.tokenUsage){const t=e.tokenUsage.total_input+e.tokenUsage.total_output;document.getElementById("total-tokens-usage").textContent=t.toLocaleString()+" tokens"}}setupTimeGroupHandlers(e,t){const s=this.contentContainer.querySelectorAll("[data-group]");s.forEach((i=>{i.addEventListener("click",(async i=>{s.forEach((e=>{e.className=`${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md`})),i.target.className=`${this.theme.primaryButton} px-3 py-1.5 text-sm rounded-md`;const n=await y.a.getWorkspaceAnalytics(this.workspace.slug,e[i.target.dataset.group],i.target.dataset.group);if(n.success){const e=this.getChartOptions(t[i.target.dataset.group]);this.sessionsChart.updateOptions(e,!1,!0),this.messagesChart.updateOptions(e,!1,!0),this.tokenUsageChart&&this.tokenUsageChart.updateOptions(e,!1,!0),this.sessionsChart.updateSeries([{name:"Sessions",data:n.sessions.data}]),this.messagesChart.updateSeries([{name:"Messages",data:n.messages.data}]),n.tokenUsage&&this.tokenUsageChart&&this.tokenUsageChart.updateSeries([{name:"Input Tokens",data:n.tokenUsage.input_data},{name:"Output Tokens",data:n.tokenUsage.output_data},{name:"Premium Tokens",data:n.tokenUsage.premium_data}]),n.topModels&&this.modelsChart&&this.modelsChart.updateOptions({labels:n.topModels.map((e=>e.model__name)),series:n.topModels.map((e=>e.count))},!0),n.topSkills&&this.skillsChart&&this.skillsChart.updateOptions({labels:n.topSkills.map((e=>e.skill_used)),series:n.topSkills.map((e=>e.count))},!0),n.topMCPs&&this.mcpChart&&this.mcpChart.updateOptions({labels:n.topMCPs.map((e=>e.mcp__name)),series:n.topMCPs.map((e=>e.count))},!0),this.updateTotals(n)}else new c.y("Error loading analytics","error")}))}))}async renderWorkspaceLogs(){if(!u.K.hasPermission("workspace:logs"))return void new c.y("You do not have permission to view billing","error");window.history.pushState({},`${this.workspace.name} logs`,"/chat/workspace/admin/logs"),document.title=`${this.workspace.name} workspace logs`,this.contentContainer.innerHTML=`\n        <div class="flex flex-col">\n            <div class="flex-grow flex flex-col">\n                \x3c!-- Header --\x3e\n                <div class="flex items-center justify-between mb-4 sticky top-0 z-10 pt-3">\n                    <div class="text-2xl font-bold">Audit Logs</div> \n                    <div class="flex gap-2" id="header-buttons-container">\n                        \x3c!-- Buttons will be rendered here --\x3e\n                    </div>\n                </div>\n    \n                \x3c!-- Filters Panel --\x3e\n                <div id="filters-panel" class="hidden mb-4 py-2 rounded-md h-[120px]">\n                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">\n                        <div id="category-filter-container"></div>\n                        <div id="user-filter-container"></div>\n                        <div id="date-filter-container"></div>\n                    </div>\n                </div>\n    \n                \x3c!-- Main Content Area with Fixed Height --\x3e\n                <div class="flex-1 flex flex-col min-h-0"> \n                    <div class="flex-1 flex flex-col">\n                        <div class="${this.theme.secondaryBackground} rounded-lg flex flex-col flex-1">\n                            \x3c!-- Scrollable Logs Container --\x3e\n                            <div id="logs-scroll" class="flex overflow-y-auto h-[calc(var(--vh)*100-225px)] p-6 mb-2">\n                                <div id="logs-container" class="flex flex-col gap-6 w-full"> \n                                    \n                                </div>\n                            </div>\n                            \x3c!-- Sticky Pagination --\x3e\n                            <div id="pagination-container" class="border-t ${this.theme.tableDividerLine} p-4">\n                                \n                            </div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        `;const e=o.A.name("filter");this.filterButton=new n.$({text:"Filters",type:"secondary",size:"extraSmall",svgPathData:e.path,svgViewBox:e.viewBox});const t=o.A.name("cloudDownload");this.exportButton=new n.$({text:"Export",type:"secondary",size:"extraSmall",svgPathData:t.path,svgViewBox:t.viewBox});const s=document.getElementById("header-buttons-container");this.filterButton.render(s),this.exportButton.render(s),await this.initializeFilters(),await this.loadLogs(),this.exportButton.onClick((()=>this.exportLogs()))}async initializeFilters(){this.filters={};const e=new E({label:"Category",placeholder:"All Categories",options:[{value:"",label:"All Categories"},{value:"auth",label:"Authentication"},{value:"member",label:"Members"},{value:"team",label:"Teams"},{value:"assistant",label:"Assistants"},{value:"settings",label:"Settings"}]});e.render(document.getElementById("category-filter-container")),e.onChange((()=>this.loadLogs())),this.filters.category=e;const t=new E({label:"Date range",placeholder:"Select date range",options:[{value:"24h",label:"Last 24 hours"},{value:"7d",label:"Last 7 days"},{value:"30d",label:"Last 30 days"},{value:"90d",label:"Last 90 days"}]});t.render(document.getElementById("date-filter-container")),t.onChange((()=>this.loadLogs())),this.filters.dateRange=t;try{const e=await y.a.getMemberList(this.workspace.slug),t=new x({label:"Actor",placeholder:"Select user(s)",items:e.members.map((e=>({id:e.id,label:e.label,image:e.image})))});t.render(document.getElementById("user-filter-container")),t.onChange((()=>this.loadLogs())),this.filters.users=t}catch(e){new c.y("Error loading members list","error");const t=new x({label:"Users",placeholder:"Error loading users",items:[]});t.render(document.getElementById("user-filter-container")),this.filters.users=t}const s=document.getElementById("filters-panel"),i=document.getElementById("logs-scroll");let n=!1;this.filterButton.onClick((()=>{n=!n,n?(s.classList.remove("hidden"),i.classList="flex overflow-y-auto h-[calc(var(--vh)*100-361px)] p-6 mb-2"):(s.classList.add("hidden"),i.classList="flex overflow-y-auto h-[calc(var(--vh)*100-225px)] p-6 mb-2")}))}static async exportLogs(e){try{const t=await fetch("/accounts/export-logs/",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":getCookie("csrftoken")},body:JSON.stringify(e)});if(!t.ok)throw new Error("Export failed");return{success:!0,blob:await t.blob(),filename:t.headers.get("content-disposition")?.split("filename=")[1]?.replace(/"/g,"")||`workspace_logs_${(new Date).toISOString().split("T")[0]}.csv`}}catch(e){throw e}}async exportLogs(){try{this.exportButton.toggleLoading("Exporting...");const e={category:this.filters?.category?.value||"",users:this.filters?.users?.selectedIds||[],dateRange:this.filters?.dateRange?.value||"24h"},t=await y.a.exportLogs(e),s=document.createElement("a");s.href=t.url,s.download=`workspace_logs_${(new Date).toISOString().split("T")[0]}.csv`,s.style.visibility="hidden",document.body.appendChild(s),s.click(),document.body.removeChild(s),window.URL.revokeObjectURL(t.url),new c.y("Logs export started","success")}catch(e){new c.y(e.message||"Failed to export logs","error")}finally{setTimeout((()=>{this.exportButton.toggleLoading()}),1500)}}async loadLogs(e=1){const t={category:this.filters?.category?.value||"",users:this.filters?.users?.selectedIds||[],dateRange:this.filters?.dateRange?.value||"24h",page:e},s=await y.a.getLogs(this.workspace.slug,t);this.renderLogs(s)}renderLogs(e){if(!e.success)return void new c.y(e.error||"Failed to load logs","error");const t=document.getElementById("logs-container");if(0===e.results.length)return void(t.innerHTML=`\n                <div class="text-center ${this.theme.fadedText}">\n                    No logs found\n                </div>\n            `);if(t.innerHTML=e.results.map((e=>{let t,s;switch(e.category.toLowerCase()){case"auth":t="lock",s=this.theme.cpuActionLoad;break;case"member":t="user",s=this.theme.cpuActionInput;break;case"assistant":t="grid2",s=this.theme.cpuActionAction;break;case"team":t="users",s=this.theme.cpuActionClick;break;case"settings":t="cog",s=this.theme.cpuActionThinking;break;default:t="info",s=this.theme.cpuActionAction}const i=o.A.name(t),n=o.A.name("chevronRight"),a=o.A.name("chevronDown");return`\n                <div class="flex gap-3 items-start relative w-full leading-5 mb-4">\n                    <div class="rounded-lg ${s} w-8 h-8 flex flex-shrink-0 justify-center items-center z-10">\n                        <svg viewBox="${i.viewBox}" class="w-4 h-4 fill-current text-sm text-inherit" aria-hidden="true" focusable="false">\n                            <path d="${i.path}"></path>\n                        </svg>\n                    </div>\n                    <div class="flex-1 min-w-0">\n                        <div class="${this.theme.text} font-bold text-base">\n                            ${e.action}\n                        </div>\n                        <div class="${this.theme.fadedText} text-sm mb-2">\n                            ${(e=>{const t=new Date(e),s=t.getDate(),i=t.toLocaleString("default",{month:"short"}),n=t.toLocaleString("default",{hour:"numeric",minute:"2-digit",hour12:!0});return`${s}${["th","st","nd","rd"][s%10>3?0:s%10]} of ${i} at ${n}`})(e.timestamp)}\n                        </div>\n                        \n                        <div class="flex items-center gap-2 mb-2">\n                            <div class="flex items-center gap-2 ${this.theme.sourceTileBackground} px-2 py-1 rounded-md">\n                                <span class="text-xs uppercase ${this.theme.fadedText} ${this.theme.ringColor} ring-1 rounded-md px-1.5 py-1">Actor</span>\n                                ${e.user_image?`<img src="${e.user_image}" alt="${e.user_email}" class="w-6 h-6 rounded-full">`:`<div class="w-6 h-6 rounded-full ${this.theme.sourceNumberBg} flex items-center justify-center">\n                                        <span class="text-xs ${this.theme.text}">${e.user_email.charAt(0).toUpperCase()}</span>\n                                    </div>`}\n                                <span class="text-sm ${this.theme.text}">${e.user_email}</span>\n                            </div>\n        \n                            ${e.target_user_email?`\n                                <svg viewBox="${n.viewBox}" class="w-4 h-4 fill-current ${this.theme.fadedText}" aria-hidden="true" focusable="false">\n                                    <path d="${n.path}"></path>\n                                </svg>\n                                <div class="flex items-center gap-2 ${this.theme.sourceTileBackground} px-2 py-1 rounded-md">\n                                    <span class="text-xs uppercase ${this.theme.fadedText} ${this.theme.ringColor} ring-1 rounded-md px-1.5 py-1">Target</span>\n                                    <div class="w-6 h-6 rounded-full ${this.theme.sourceNumberBg} flex items-center justify-center">\n                                        <span class="text-xs ${this.theme.text}">${e.target_user_email.charAt(0).toUpperCase()}</span>\n                                    </div>\n                                    <span class="text-sm ${this.theme.text}">${e.target_user_email}</span>\n                                </div>\n                            `:""}\n                        </div>\n                        \n                        ${Object.keys(e.details).length>0||e.target_object_type?`\n                            <div class="mt-2 log-details-container">\n                                <button class="toggle-details-btn text-sm ${this.theme.linkButton} hover:underline" data-expanded="false">\n                                    <span class="toggle-icon-container flex items-center">\n                                        <svg viewBox="${a.viewBox}" class="w-3 h-3 fill-current mr-1" aria-hidden="true" focusable="false">\n                                            <path d="${a.path}"></path>\n                                        </svg>\n                                        Show details\n                                    </span>\n                                </button>\n                                <div class="details-content hidden mt-2 pl-2 border-l-2 ${this.theme.tableDividerLine}">\n                                    ${e.target_object_type?`\n                                        <div class="mb-2 text-base ${this.theme.fadedText}">\n                                            <span class="py-1 rounded-md ${this.theme.sourceTileBackground}">\n                                                ${e.target_object_type.charAt(0).toUpperCase()+e.target_object_type.slice(1)} object reference: <span class="${this.theme.text}">${e.target_object_id}</span>\n                                            </span>\n                                        </div>\n                                    `:""}\n                                    ${this.formatLogDetails(e)}\n                                </div>\n                            </div>\n                        `:""}\n                    </div>\n                </div>\n            `})).join(""),document.querySelectorAll(".toggle-details-btn").forEach((e=>{e.addEventListener("click",(function(e){e.preventDefault();const t=this.nextElementSibling;if(t){t.classList.toggle("hidden");const e="true"===this.getAttribute("data-expanded");this.setAttribute("data-expanded",!e);const s=this.querySelector(".toggle-icon-container");if(s){const t=e?"chevronDown":"chevronUp",i=o.A.name(t);s.innerHTML=`\n                            <svg viewBox="${i.viewBox}" class="w-3 h-3 fill-current mr-1" aria-hidden="true" focusable="false">\n                                <path d="${i.path}"></path>\n                            </svg>\n                            ${e?"Show details":"Hide details"}\n                        `}}}))})),e.pagination){const t=document.getElementById("pagination-container");t.innerHTML=`\n                <div class="flex justify-between items-center">\n                    <div class="${this.theme.fadedText} text-sm">\n                        Showing ${e.pagination.start_index} to ${e.pagination.end_index} of ${e.pagination.total} results\n                    </div>\n                    <div class="flex gap-2">\n                        <button \n                            class="${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md ${e.pagination.has_previous?"":"opacity-50 cursor-not-allowed"}"\n                            ${e.pagination.has_previous?"":"disabled"}\n                            data-page="${e.pagination.page-1}">\n                            Previous\n                        </button>\n                        <button \n                            class="${this.theme.secondaryButton} px-3 py-1.5 text-sm rounded-md ${e.pagination.has_next?"":"opacity-50 cursor-not-allowed"}"\n                            ${e.pagination.has_next?"":"disabled"}\n                            data-page="${e.pagination.page+1}">\n                            Next\n                        </button>\n                    </div>\n                </div>\n            `,t.querySelectorAll("button").forEach((e=>{e.addEventListener("click",(()=>{e.disabled||this.loadLogs(parseInt(e.dataset.page))}))}))}}formatLogDetails(e){return e.details&&0!==Object.keys(e.details).length?Object.entries(e.details).map((([e,t])=>{const s=e.replace(/_/g," ").replace(/\w\S*/g,(e=>e.charAt(0).toUpperCase()+e.substr(1).toLowerCase()));let i=t;return"boolean"==typeof t?i=t?"Yes":"No":"object"==typeof t&&(i=JSON.stringify(t,null,2)),`\n                <div class="mb-1">\n                    <span class="${this.theme.fadedText}">${s}:</span>\n                    <span class="${this.theme.text}">${i}</span>\n                </div>\n            `})).join(""):""}async renderWorkspaceBilling(){if(!u.K.hasPermission("workspace:billing"))return void new c.y("You do not have permission to view billing","error");this.contentContainer.innerHTML="";const e=document.createElement("div");e.classList="flex flex-col w-full leading-7 pb-2 sm:max-w-full md:max-w-full lg:max-w-full xl:max-w-full 2xl:max-w-full gap-2 mt-0 sm:mt-4 overflow-y-auto  items-center px-0.5",this.contentContainer.appendChild(e);const t=document.createElement("div");t.classList="w-full px-4",e.appendChild(t);const s=document.createElement("div");s.classList="w-full flex flex-col text-2xl font-bold mb-6",s.innerText="Billing",t.appendChild(s),this.toggleBillingLoading(t,!0),await this.loadBillingData(),await this.loadPaymentMethods(),this.toggleBillingLoading(t,!1),this.renderPlanSection(t),this.renderUsageSection(t),this.renderAddonsSection(t),this.renderSeatsSection(t),this.renderPaymentMethodsSection(t),this.renderInvoicesSection(t)}toggleBillingLoading(e,t){e.innerHTML=t?`\n                <div class="w-full flex flex-col text-2xl font-bold mb-6">Billing</div>\n                \x3c!-- Plan Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-24 mb-4 animate-pulse"></div>\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-48 mb-4 animate-pulse"></div>\n                </div>\n    \n                \x3c!-- Seats Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-24 mb-4 animate-pulse"></div>\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-full mb-4 animate-pulse"></div>\n                    <div class="space-y-2">\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-48 animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-48 animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-48 animate-pulse"></div>\n                    </div>\n                </div>\n    \n                \x3c!-- Addons Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-32 mb-4 animate-pulse"></div>\n                    <div class="space-y-4">\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                    </div>\n                </div>\n    \n                \x3c!-- Payment Methods Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-48 mb-4 animate-pulse"></div>\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-full mt-4 animate-pulse"></div>\n                </div>\n    \n                \x3c!-- Usage Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-32 mb-4 animate-pulse"></div>\n                    <div class="space-y-4">\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                    </div>\n                </div>\n    \n                \x3c!-- Invoices Section Loading --\x3e\n                <div class="${this.theme.listTableItem} ring-1 rounded-md p-6 relative overflow-hidden">\n                    <div class="${this.theme.unselectedSelector} rounded h-4 w-24 mb-4 animate-pulse"></div>\n                    <div class="space-y-4">\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                        <div class="${this.theme.unselectedSelector} rounded h-4 w-full animate-pulse"></div>\n                    </div>\n                </div>\n            `:'<div class="w-full flex flex-col text-2xl font-bold mb-6">Billing</div>'}async loadPaymentMethods(){try{const e=await y.a.getPaymentMethods();if(!e||!e.success)throw new Error(e.error||"Failed to load payment methods.");this.paymentMethods=e.payment_methods}catch(e){new c.y(e.message||"Could not load payment methods.","error"),this.paymentMethods=null}}async loadBillingData(){try{const e=await y.a.getBillingData();this.billingData=e}catch(e){new c.y("Error loading billing data","error")}}renderPlanSection(e){const t=document.createElement("div");t.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4`;const s=document.createElement("div");s.classList="flex justify-between items-start";const i=document.createElement("div");i.classList="flex flex-col gap-2";const a=document.createElement("div");a.classList="text-xl font-bold","custom"===this.billingData.plan_type?a.innerText=this.billingData.plan_name:a.innerText=`${this.billingData.plan_name} plan`;const o=document.createElement("div");o.classList=`${this.theme.fadedText}`;const r=new Date(this.billingData.paid_until).toLocaleString("en-US",{day:"numeric",month:"long",year:"numeric"});this.billingData.is_on_trial?o.innerText=`Your trial ends on ${r}`:o.innerText=this.billingData.cancel_at_period_end?`Expires ${r}`:`Renews ${r}`,i.appendChild(a),i.appendChild(o);const l=new n.$({text:"Manage",size:"small",type:"secondary"});l.onClick((()=>{const e=l.element;document.querySelectorAll(".workspace-billing-menu").forEach((e=>e.remove()));const t=document.createElement("div");t.className=`workspace-billing-menu absolute ${this.theme.tableMenuBackground} shadow-lg rounded-lg z-50 text-sm min-w-[180px] flex flex-col overflow-hidden py-1`,t.style.visibility="hidden",t.style.opacity="0",t.style.transform="scale(0.95)",t.style.transition="opacity 0.1s ease-out, transform 0.1s ease-out";const s=()=>{document.removeEventListener("click",i,!0),t&&(t.style.opacity="0",t.style.transform="scale(0.95)",t.addEventListener("transitionend",(()=>t.remove()),{once:!0}))},i=i=>{!t||t.contains(i.target)||e.contains(i.target)||s()},n=(e,i,n=!1)=>{const a=document.createElement("button"),o=this.theme.text;a.className=`w-full text-left px-4 py-1.5 ${this.theme.tableMenuButtonHover} flex items-center`;const r=document.createElement("span");r.className=`${o} text-sm`,r.textContent=e,a.appendChild(r),a.addEventListener("click",(e=>{e.stopPropagation(),i&&i(),s()})),t.appendChild(a)};this.billingData.cancel_at_period_end?n("Reactivate plan",(()=>{window.location.href="/accounts/reactivate-plan/"})):("custom"!==this.billingData.plan_type&&n("Change plan",(()=>{window.location.href="/accounts/change-plan/"})),n("Cancel plan",(()=>{window.location.href="/accounts/cancel-plan/"}),!0)),document.body.appendChild(t),document.addEventListener("click",i,!0);const a=e.getBoundingClientRect(),o=t.getBoundingClientRect();let r=a.bottom+4,c=a.right-o.width;t.style.top=`${r+window.scrollY}px`,t.style.left=`${c+window.scrollX}px`,requestAnimationFrame((()=>{t.style.visibility="visible",t.style.opacity="1",t.style.transform="scale(1)"}))})),s.appendChild(i),s.appendChild(l.element),t.appendChild(s),e.appendChild(t)}renderSeatsSection(e){const t=document.createElement("div");t.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4`;const s=document.createElement("div");s.classList="text-xl font-bold mb-4",s.innerText="Seats";const i=document.createElement("div");i.classList="mb-6";const a=document.createElement("div");a.classList="flex justify-between items-center mb-2";const o=document.createElement("div");o.classList="flex items-center gap-2";const r=this.billingData.active_members+this.billingData.pending_invites;o.innerHTML=`\n            <span class="font-medium">${r} of ${this.billingData.total_seats} seats used</span>\n        `,a.appendChild(o),i.appendChild(a);const l=document.createElement("div");l.className=`h-3 w-full ${this.theme.sliderRailColor} rounded-full overflow-hidden`;const c=document.createElement("div");c.className=`h-full rounded-full transition-all duration-300 ${this.theme.progressBarBackground}`;const d=r/this.billingData.total_seats*100;c.style.width=`${d}%`,l.appendChild(c),i.appendChild(l);const h=document.createElement("div");h.classList="mt-4 space-y-2";[{label:"Active members",count:this.billingData.active_members},{label:"Pending invites",count:this.billingData.pending_invites},{label:"Available seats",count:this.billingData.seats_available}].forEach((e=>{const t=document.createElement("div");t.classList="flex justify-between items-center text-base",t.innerHTML=`\n                <span class="${this.theme.fadedText}">${e.label}</span>\n                <span class="font-medium">${e.count}</span>\n            `,h.appendChild(t)}));const m=document.createElement("div");m.classList="flex gap-2 mt-6";const u=new n.$({text:"Manage members",size:"small",type:"secondary"});u.onClick((()=>{this.updateMenuSelection("members"),this.renderWorkspaceMembers()})),u.render(m),t.appendChild(s),t.appendChild(i),t.appendChild(h),t.appendChild(m),e.appendChild(t)}renderUsageSection(e){const t="enterprise"===this.billingData.plan_type;if("business"===this.billingData.plan_type)return;const s=document.createElement("div");s.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4`;const i=document.createElement("div");if(i.classList="text-xl font-bold"+(t?" mb-4":""),i.innerText=t?"Usage":"Usage this period",s.appendChild(i),!t&&this.billingData.limits_reset_date){const e=document.createElement("div");e.classList=`text-sm ${this.theme.fadedText} mb-4`,e.innerText=`Monthly limits reset on ${new Date(this.billingData.limits_reset_date).toLocaleDateString()}`,s.appendChild(e)}const n=this.billingData.recharge_details?.input_tokens_remaining||0,a=this.billingData.recharge_details?.output_tokens_remaining||0,l=this.billingData.recharge_details?.premium_images_remaining||0,c=[{label:"Frontier input tokens",current:this.billingData.frontier_input_tokens_used,max:this.billingData.max_frontier_input,additional:n,type:"input"},{label:"Frontier output tokens",current:this.billingData.frontier_output_tokens_used,max:this.billingData.max_frontier_output,additional:a,type:"output"},{label:"Premium images",current:this.billingData.frontier_images_generated,max:this.billingData.max_premium_images,additional:l,type:"premium"}],d=document.createElement("div");d.className="space-y-4",c.forEach((e=>{const t=e.max>0?e.current/e.max*100:0,s=document.createElement("div");s.className="flex flex-col gap-1";const i=document.createElement("div");i.className="flex justify-between items-center text-base mb-2";const n=e.additional>0,a=n?e.additional.toLocaleString():"0",l=document.createElement("span");l.className=`font-medium ${this.theme.text}`,l.textContent=e.label;const c=document.createElement("div");c.className="flex items-center gap-1.5";const h=document.createElement("span");if(h.className=`text-sm ${this.theme.fadedText}`,h.textContent=`${e.current.toLocaleString()} / ${e.max.toLocaleString()}`,c.appendChild(h),n){const e=document.createElement("span");e.className=`${this.theme.skillTag} px-1.5 py-0.5 text-xs rounded-md font-medium flex items-center gap-1`;const t=o.A.name("plus");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-2.5 h-2.5"}).render(e),e.appendChild(document.createTextNode(a)),c.appendChild(e)}i.appendChild(l),i.appendChild(c);const m=document.createElement("div");m.className=`h-3 w-full ${this.theme.sliderRailColor} rounded-full overflow-hidden`;const u=document.createElement("div");if(u.className="h-full rounded-full transition-all duration-300",t>=90?u.classList.add("bg-red-500"):t>=75?u.classList.add("bg-yellow-500"):u.classList.add(this.theme.progressBarBackground),u.style.width=`${Math.min(t,100)}%`,m.appendChild(u),s.appendChild(i),s.appendChild(m),n){const t=document.createElement("div");t.className=`text-xs ${this.theme.successText} mt-2`;const i="premium"===e.type?"premium image tokens":`${e.type} tokens`;t.textContent=`You have ${a} additional ${i} from recharges.`,s.appendChild(t)}d.appendChild(s)})),s.appendChild(d),e.appendChild(s)}renderPaymentMethodsSection(e){const t=document.createElement("div");t.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4`;const s=document.createElement("div");s.className="flex justify-between items-center mb-4";const i=document.createElement("div");i.classList="text-xl font-bold",i.innerText="Payment methods",s.appendChild(i);const a=new n.$({text:"+ Add new",size:"link-sm",type:"link"});a.onClick((()=>this.showAddPaymentMethodModal())),a.render(s),t.appendChild(s);const l=document.createElement("div");if(l.className="space-y-4",null===this.paymentMethods){const s=document.createElement("div");return s.className=`${this.theme.fadedText} p-4 text-center`,s.textContent="Could not load payment methods.",l.appendChild(s),t.appendChild(l),void e.appendChild(t)}if(0===this.paymentMethods.length){const e=document.createElement("div");e.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-6 text-center`,e.innerHTML=`<p class="${this.theme.fadedText}">No payment methods on file.</p>`,l.appendChild(e)}else{const e=document.createElement("div");e.className="space-y-3",this.paymentMethods.forEach((t=>{const s=document.createElement("div");s.className=`${this.theme.tableCardBackground} rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`;const i=document.createElement("div");i.className="flex items-center gap-4";const a=o.A.name("creditCard");new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-8 h-8 flex-shrink-0",colorClass:this.theme.iconColor}).render(i);const l=document.createElement("div");l.className="flex flex-col leading-5";const c=document.createElement("span");c.className=this.theme.text,c.textContent=`${t.brand.charAt(0).toUpperCase()+t.brand.slice(1)} ending in ${t.last4}`;const d=document.createElement("span");if(d.className=`text-sm ${this.theme.fadedText}`,d.textContent=`Expires ${t.exp_month}/${t.exp_year}`,l.appendChild(c),l.appendChild(d),i.appendChild(l),t.is_default){const e=document.createElement("span");e.className=`${this.theme.skillTag} px-2 py-0.5 text-xs rounded-md font-medium ml-4`,e.textContent="Default",i.appendChild(e)}const h=document.createElement("div");if(h.className="flex items-center gap-3 self-end sm:self-center",!t.is_default){const e=new n.$({text:"Set as default",type:"link",size:"link-sm"});e.onClick((()=>this.handleSetDefaultPaymentMethod(t.id))),e.render(h);const s=new n.$({text:"Delete",type:"secondary",size:"small"});s.onClick((()=>this.handleDeletePaymentMethod(t.id,t.is_default))),s.render(h)}s.appendChild(i),s.appendChild(h),e.appendChild(s)})),l.appendChild(e)}t.appendChild(l),e.appendChild(t)}handleSetDefaultPaymentMethod=async e=>{try{const t=await y.a.setDefaultPaymentMethod(e);t.success?(new c.y("Default payment method updated.","success"),this.renderWorkspaceBilling()):new c.y(t.error||"Failed to update payment method.","error")}catch(e){new c.y("Failed to update payment method.","error")}};handleDeletePaymentMethod=(e,t)=>{if(t)return void new c.y("You cannot delete your default payment method.","error");new a("Delete payment method?","Are you sure you want to delete this card? This action cannot be undone.").onConfirm((async()=>{try{const t=await y.a.deletePaymentMethod(e);t.success?(new c.y("Payment method deleted.","success"),this.renderWorkspaceBilling()):new c.y(t.error||"Failed to delete payment method.","error")}catch(e){new c.y("Failed to delete payment method.","error")}}))};showAddPaymentMethodModal=async()=>{try{const e=await y.a.setupPaymentMethod();if(!e.success)return void new c.y(e.error||"Failed to setup payment method","error");e.stripe_publishable_key&&(window.stripePublishableKey=e.stripe_publishable_key);const t=document.createElement("div");t.className="space-y-4 py-2",t.innerHTML=`\n                <div class="text-base ${this.theme.fadedText} mb-4">\n                    Your payment method will be added securely and processed by Stripe.\n                </div>\n                <div id="card-element" class="p-3 border bg-white rounded-md"></div>\n                <div id="card-errors" class="text-red-500 text-sm hidden"></div>\n            `;const s=new l({title:"Add payment method",body:t,size:"medium",closeX:!0,confirm:!0,cancel:!0,confirmText:"Add payment method",cancelText:"Cancel",manualCloseOnConfirm:!0});setTimeout((()=>{this.initializeStripeElementsForWorkspace(e.client_secret,e.setup_intent_id,s)}),100)}catch(e){new c.y("Failed to setup payment method","error")}};initializeStripeElementsForWorkspace=async(e,t,s)=>{try{if(await this.loadStripe(),!window.Stripe||!window.stripePublishableKey)return new c.y("Payment system not loaded. Please refresh and try again.","error"),void s.close();const i=Stripe(window.stripePublishableKey),n=i.elements().create("card",{style:{base:{fontSize:"16px",color:"#1f2937",fontFamily:"ui-sans-serif, system-ui, sans-serif","::placeholder":{color:"#9ca3af"}},invalid:{color:"#dc2626",iconColor:"#dc2626"}},hidePostalCode:!0});n.mount("#card-element"),n.on("change",(({error:e})=>{const t=document.getElementById("card-errors");e?(t.textContent=e.message,t.classList.remove("hidden")):t.classList.add("hidden")})),s.onConfirm((async()=>{s.toggleConfirmLoading(!0);const{error:a}=await i.confirmCardSetup(e,{payment_method:{card:n}});if(a)new c.y(a.message,"error"),s.toggleConfirmLoading(!1);else try{const e=await y.a.confirmPaymentMethod(t);e.success?(new c.y("Payment method added successfully!","success"),s.close(),this.renderWorkspaceBilling()):(new c.y(e.error||"Failed to save payment method","error"),s.toggleConfirmLoading(!1))}catch(e){new c.y("Failed to save payment method","error"),s.toggleConfirmLoading(!1)}}))}catch(e){new c.y("Failed to load payment system","error"),s.close()}};loadStripe=()=>new Promise(((e,t)=>{if(window.Stripe)return void e(window.Stripe);const s=document.createElement("script");s.src="https://js.stripe.com/v3/",s.onload=()=>e(window.Stripe),s.onerror=t,document.head.appendChild(s)}));handleAutoRechargeUpdate=()=>{clearTimeout(this.autoRechargeUpdateTimeout),this.autoRechargeUpdateTimeout=setTimeout((async()=>{if(!this.autoRechargeSwitch||!this.tokenSelectBox||!this.premiumTokenSelectBox)return;const e=this.autoRechargeSwitch.value,t=this.tokenSelectBox.value,s=this.premiumTokenSelectBox.value;try{const i=await y.a.updateAutomaticRecharge(e,t,s);if(!i.success)throw new Error(i.error||"Failed to save settings.");this.billingData.auto_recharge_enabled=e,this.billingData.auto_recharge_token_plan=t,this.billingData.auto_recharge_premium_plan=s}catch(e){new c.y(e.message,"error"),this.renderWorkspaceBilling()}}),1e3)};showWorkspaceRechargeModal=(e,t,s)=>{const i=document.createElement("div");i.classList.add("py-3");const a=t.images>0,r=e=>e>=1e6?e/1e6+"M":e.toLocaleString(),d=t.name,h=`$${t.price}`,m=a?`By recharging, your workspace will be credited with an additional ${t.images.toLocaleString()} premium tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when your workspace is over your existing monthly limits.`:`By recharging, your workspace be credited with an additional ${r(t.input_tokens)} input and ${r(t.output_tokens)} output tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when you are over your existing monthly limits.`,u=o.A.name("info");i.innerHTML=`\n            <div class="flex flex-col gap-4">\n                <div class="flex flex-row items-center gap-4">\n                    <div class="flex-1 ${this.theme.secondaryBackground} rounded-md p-4">\n                        <div class="font-bold mb-0.5">${d}</div>\n                        <div class="text-sm ${this.theme.fadedText} mb-3">${m}</div>\n                        <div class="font-bold text-lg">${h} USD</div>\n                    </div>\n                </div>\n                <div class="p-3 rounded-md ${this.theme.toastInfo} text-sm">\n                    <div class="flex items-start gap-2">\n                        <div><svg viewBox="${u.viewBox}" class="w-4 h-4 fill-current"><path d="${u.path}"></path></svg></div>\n                        <div>Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens can not be refunded.</div>\n                    </div>\n                </div>\n                <div id="recharge-error" class="hidden p-3 rounded-md bg-red-100 text-red-800 text-sm"></div>\n            </div>\n        `;const p=new l({size:"small",title:"Recharge now",body:i,closeX:!0,confirm:!0,cancel:!1,confirmText:`Recharge now for ${h}`,buttonWidth:"full",buttonStyle:"primary",buttonSize:"large",manualCloseOnConfirm:!0});p.onConfirm((async()=>{p.toggleConfirmLoading(!0);try{const i=await y.a.recharge(e);if(!i.success)throw new Error(i.error||"Failed to process recharge");p.close(),s&&s.close(),this.showWorkspaceRechargeSuccess(t)}catch(e){p.toggleConfirmLoading(!1);let t=e.message||"An error occurred while processing your payment.",s=!1;(t.toLowerCase().includes("card was declined")||t.includes("req_"))&&(s=!0,t="Your card was declined. Please update your payment method and try again.");const i=document.getElementById("recharge-error"),a=o.A.name("error");let r=`\n                    <div class="flex flex-col gap-3">\n                        <div class="flex items-start gap-2">\n                            <div><svg viewBox="${a.viewBox}" class="w-4 h-4 fill-current text-red-500"><path d="${a.path}"></path></svg></div>\n                            <div>${t}</div>\n                        </div>\n                `;if(s&&(r+='<div id="manage-billing-button-container" class="flex justify-center mt-2"></div>'),r+="</div>",i.innerHTML=r,i.classList.remove("hidden"),s){const e=document.getElementById("manage-billing-button-container"),t=new n.$({text:"Manage billing",type:"link",size:"link-sm"});t.onClick((async()=>{try{t.toggleLoading(!0);const e=await y.a.getWorkspaceBillingPortal();if(!e.url)throw new Error("Failed to create billing portal session");window.open(e.url,"_blank"),t.toggleLoading(!1),p.close()}catch(e){new c.y("Failed to open billing portal.","error"),t.toggleLoading(!1)}})),t.render(e)}}}))};showWorkspaceRechargeSuccess=e=>{const t=document.createElement("div");t.className="flex flex-col items-center justify-center align-middle space-y-4 h-[250px]";const s=document.createElement("div");s.className="py-4 flex flex-col items-center gap-4 px-10";const i=document.createElement("div"),n=o.A.name("success"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-20 h-20"});i.appendChild(a.element);const c=document.createElement("div"),d=document.createElement("div");d.className="font-bold text-lg text-center",d.textContent=`${e.name} successful!`;const h=document.createElement("div");h.className=`${this.theme.fadedText} text-base text-center`,h.textContent="Your additional credits have been added to your workspace.",c.appendChild(d),c.appendChild(h),s.appendChild(i),s.appendChild(c),t.appendChild(s);const m=new l({size:"medium",title:"",closeX:!0,confirmOnExit:!1,body:t});new H.N,setTimeout((()=>{m.close(),this.renderWorkspaceBilling()}),2500)};renderAddonsSection(e){if(!["ember","spark","ignite","blaze","enterprise","family","family_max","custom"].includes(this.billingData.plan_type))return;const t={token_100:{name:"20M Token Recharge",price:"100",input_tokens:2e7,output_tokens:2e6,images:0,stripe_price_id:"price_1Pg24QGAH3B5g1gJ7dOKs23u"},token_500:{name:"100M Token Recharge",price:"500",input_tokens:1e8,output_tokens:1e7,images:0,stripe_price_id:"price_1Pg25NGAH3B5g1gJvYg4wXvF"},token_1000:{name:"200M Token Recharge",price:"1000",input_tokens:2e8,output_tokens:2e7,images:0,stripe_price_id:"price_1Pg25jGAH3B5g1gJg8z3EzTj"},token_premium_100:{name:"8,000 Premium Token Recharge",price:"100",input_tokens:0,output_tokens:0,images:8e3,stripe_price_id:"price_1Pg26LGAH3B5g1gJpB2m8pYk"},token_premium_500:{name:"40,000 Premium Token Recharge",price:"500",input_tokens:0,output_tokens:0,images:4e4,stripe_price_id:"price_1Pg26fGAH3B5g1gJHx2j6hdb"},token_premium_1000:{name:"80,000 Premium Token Recharge",price:"1000",input_tokens:0,output_tokens:0,images:8e4,stripe_price_id:"price_1Pg274GAH3B5g1gJd2lJ0bJc"}},s=e=>e>=1e6?e/1e6+"M":e.toLocaleString(),i=document.createElement("div");i.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 mb-4`;const a=document.createElement("h3");a.className="text-xl font-bold",a.textContent="Token recharge",i.appendChild(a);const c=document.createElement("div");c.className=`text-sm ${this.theme.fadedText} mb-6 leading-5`,i.appendChild(c);const d=document.createElement("div");d.className="space-y-4";const h=document.createElement("div");h.className=`rounded-lg border ${this.theme.tableCardBorder} p-4`;const m=document.createElement("div");m.className="flex justify-between items-start";const u=document.createElement("div");u.className="flex flex-col gap-1",u.innerHTML=`\n            <div class="text-base font-medium ${this.theme.text}">Enable auto-recharge</div>\n            <div class="text-sm ${this.theme.fadedText} mr-10 leading-5">When you are running low on tokens, we will automatically recharge your account with a new token pack using your primary payment method. You can disable this at any time.</div>\n        `;const p=document.createElement("div");p.className="flex items-center flex-shrink-0";const g=this.billingData.auto_recharge_enabled||!1;this.autoRechargeSwitch=new C({label:"",value:g,size:"medium"}),this.autoRechargeSwitch.render(p),m.appendChild(u),m.appendChild(p),h.appendChild(m);const f=document.createElement("div");f.className="mt-4 space-y-4",g||f.classList.add("hidden");const v=Object.entries(t).filter((([e,t])=>!t.images)).map((([e,t])=>({value:e,label:`$${t.price} - ${s(t.input_tokens)} input / ${s(t.output_tokens)} output`}))),y=Object.entries(t).filter((([e,t])=>t.images>0)).map((([e,t])=>({value:e,label:`$${t.price} - ${t.images.toLocaleString()} premium tokens`})));this.tokenSelectBox=new E({label:"Input/output token auto-recharge",options:v,value:this.billingData.auto_recharge_token_plan||"token_100",size:"medium"}),this.tokenSelectBox.render(f),this.premiumTokenSelectBox=new E({label:"Premium token auto-recharge",options:y,value:this.billingData.auto_recharge_premium_plan||"token_premium_100",size:"medium"}),this.premiumTokenSelectBox.render(f),h.appendChild(f);const w=document.createElement("div");w.className=`mt-4 p-3 rounded-md ${this.theme.toastInfo} text-sm`;const b=document.createElement("div");b.className="flex items-start gap-2";const x=new r.I({pathData:o.A.name("info").path,viewBox:o.A.name("info").viewBox,sizeClasses:"w-4 h-4 flex-shrink-0 mt-0.5",colorClass:"text-blue-600"}),k=document.createElement("div");k.className="leading-relaxed recharge-info-text",k.innerHTML=g?"<strong>Auto-recharge is enabled.</strong> We'll automatically purchase tokens when you're running low to prevent service interruptions. Recharge tokens expire 12 months from purchase and are non-refundable.":"Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens cannot be refunded. Recharge tokens are drawn down when you have exhausted your monthly plan limit.",x.render(b),b.appendChild(k),w.appendChild(b),h.appendChild(w),d.appendChild(h);const S=document.createElement("div");S.className=`rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`,S.innerHTML=`\n            <div class="flex flex-col">\n                <div class="font-medium ${this.theme.text}">One-time recharge options</div>\n                <div class="text-sm ${this.theme.fadedText}">Purchase additional tokens that are drawn down when you are over your monthly limit.</div>\n            </div>\n        `;const T=document.createElement("div"),L=new n.$({text:"Show recharge options",size:"small",type:"secondary"});L.render(T),S.appendChild(T),d.appendChild(S),i.appendChild(d),L.onClick((()=>{const e=document.createElement("div");e.className="space-y-3 pt-2";const i=new l({title:"One-time recharge options",body:e,size:"medium",closeX:!0,confirm:!1,cancel:!1});for(const[a,l]of Object.entries(t)){const t=l.images>0,c=document.createElement("div");c.className=`rounded-lg border ${this.theme.tableCardBorder} p-4 flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 sm:gap-4`;const d=document.createElement("div");d.className="flex items-center gap-4";new r.I({pathData:o.A.name(t?"sparkles":"coin").path,viewBox:o.A.name(t?"sparkles":"coin").viewBox,sizeClasses:"w-8 h-8 flex-shrink-0",colorClass:this.theme.iconColor}).render(d);const h=document.createElement("div");h.className="flex flex-col",h.innerHTML=`\n                    <span class="font-medium ${this.theme.text}">${l.name}</span>\n                    <span class="text-sm ${this.theme.fadedText}">${t?`${l.images.toLocaleString()} tokens for images, videos, paid MCPs and more`:`${s(l.input_tokens)} input tokens + ${s(l.output_tokens)} output tokens`}</span>\n                `,d.appendChild(h);const m=document.createElement("div");m.className="flex flex-col items-end gap-2 self-end sm:self-center",m.innerHTML=`<div class="text-base ${this.theme.text}">$${l.price} USD</div>`;const u=new n.$({text:"Recharge",size:"small",type:"secondary"});u.onClick((()=>this.showWorkspaceRechargeModal(a,l,i))),u.render(m),c.appendChild(d),c.appendChild(m),e.appendChild(c)}})),this.autoRechargeSwitch.onChange((e=>{e?(f.classList.remove("hidden"),k.innerHTML="<strong>Auto-recharge is enabled.</strong> We'll automatically purchase tokens when you're running low to prevent service interruptions. Recharge tokens expire 12 months from purchase and are non-refundable."):(f.classList.add("hidden"),k.textContent="Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens cannot be refunded. Recharge tokens are drawn down when you have exhausted your monthly plan limit."),this.handleAutoRechargeUpdate()})),this.tokenSelectBox.onChange(this.handleAutoRechargeUpdate),this.premiumTokenSelectBox.onChange(this.handleAutoRechargeUpdate),e.appendChild(i)}renderInvoicesSection(e){const t=document.createElement("div");t.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6`;const s=document.createElement("div");s.classList="text-xl font-bold mb-4",s.innerText="Invoices";const i=document.createElement("div");if(i.classList="space-y-2",this.billingData.invoices&&0!==this.billingData.invoices.length)this.billingData.invoices.forEach((e=>{const t=document.createElement("div");t.classList="flex justify-between items-center py-2";const s=document.createElement("div"),n=new Date(e.created);s.innerText=n.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});const a=document.createElement("div");a.classList="flex items-center gap-4";const l=document.createElement("span");l.innerText=e.amount_paid?`$${e.amount_paid.toFixed(2)}`:"-";const c=document.createElement("span");c.classList=`${this.theme.fadedText}`,c.innerText=e.status.charAt(0).toUpperCase()+e.status.slice(1);const d=document.createElement("button");d.className=`${this.theme.linkText} flex items-center justify-center`;const h=o.A.name("cloudDownload"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-5 h-5"});m.element&&d.appendChild(m.element),e.invoice_pdf||e.hosted_invoice_url?d.onclick=()=>{window.open(e.invoice_pdf||e.hosted_invoice_url,"_blank")}:(d.disabled=!0,d.classList.add("opacity-50","cursor-not-allowed")),a.appendChild(l),a.appendChild(c),a.appendChild(d),t.appendChild(s),t.appendChild(a),i.appendChild(t)}));else{const e=document.createElement("div");e.classList=`${this.theme.fadedText}`,e.innerText="No invoices available",i.appendChild(e)}t.appendChild(s),t.appendChild(i),e.appendChild(t)}renderWorkspaceSupport(){window.history.pushState({},`${this.workspace.name} support`,"/chat/workspace/admin/support"),document.title=`${this.workspace.name} support`,this.contentContainer.innerHTML='\n        <div class="flex flex-col w-full items-center leading-7 pb-2 sm:max-w-full md:max-w-full lg:max-w-full xl:max-w-full 2xl:max-w-full gap-2 mt-0 sm:mt-4 overflow-y-auto h-[calc(var(--vh)*100-73px)] sm:h-[calc(var(--vh)*100-50px)] px-0.5">\n            <div class="w-full max-w-3xl">\n                <div class="flex justify-center mt-2 mb-6">\n                    <div id="tabs-container"></div>\n                </div>\n                <div class="flex justify-center text-3xl tracking-tight mb-4">We\'re here to help</div>\n                \n                \x3c!-- Content container --\x3e\n                <div id="tab-content" class="w-full"></div>\n            </div>\n        </div>';const e={tabs:[{title:"Support",value:"support",selected:!0},{title:"Tutorials",value:"tutorials",selected:!1}],onTabChange:e=>this.handleSupportTabChange(e)};this.tabs=new w(e),this.tabs.render(document.getElementById("tabs-container")),this.handleSupportTabChange("support")}handleSupportTabChange(e){const t=document.getElementById("tab-content");"support"===e?this.renderSupportContent(t):"tutorials"===e&&this.renderTutorialsContent(t)}renderSupportContent(e){e.innerHTML="";const t=document.createElement("div");t.className="flex flex-col gap-6";const s=document.createElement("div");s.className="flex flex-col gap-3";const i=document.createElement("p");i.className=`text-base ${this.theme.fadedText}`,i.textContent="We're here to help with billing, product and workspace support. If you have any questions or need assistance, please don't hesitate to reach out.",s.appendChild(i);const a=document.createElement("div");a.className="flex flex-col gap-4 mt-2";const l=document.createElement("div");l.className=`flex flex-col gap-2 p-4 rounded-md ring-1 ${this.theme.ringColor}`;const c=document.createElement("h3");c.className="text-lg font-medium",c.textContent="Submit a support ticket",l.appendChild(c);const d=document.createElement("p");d.className=`text-base ${this.theme.fadedText}`,d.textContent="All workspace members can submit support tickets for assistance with any issues or questions. Our support team will respond as soon as possible.",l.appendChild(d);const h=document.createElement("div");h.className="mt-2",h.id="submit-ticket-button",l.appendChild(h),a.appendChild(l);const m=document.createElement("div");m.className=`flex flex-col gap-2 p-4 rounded-md ring-1 ${this.theme.ringColor}`;const u=document.createElement("h3");u.className="text-lg font-medium",u.textContent="Coverage",m.appendChild(u);const p=document.createElement("p");p.className=`text-base ${this.theme.fadedText}`,p.textContent="If you need to send files or prefer email you can submit tickets via email too. To ensure the fastest response, please include as much detail as possible and send the email from the email address associated with your workspace.",m.appendChild(p);const g=document.createElement("div");g.className="mt-1 space-y-2";const v=document.createElement("div");v.className="flex items-center gap-2";const y=o.A.name("envelope"),w=new r.I({pathData:y.path,viewBox:y.viewBox,sizeClasses:"w-3.5 h-3.5 text-sm"});w.element&&v.appendChild(w.element);const b=document.createElement("span");b.textContent="support@simtheory.ai",v.appendChild(b),g.appendChild(v);const C=document.createElement("div");C.className="flex items-center gap-2";const x=o.A.name("clock"),k=new r.I({pathData:x.path,viewBox:x.viewBox,sizeClasses:"w-3.5 h-3.5 text-sm"});k.element&&C.appendChild(k.element);const E=document.createElement("span");E.textContent="Monday - Friday, 9:00 AM - 5:00 PM AEST",C.appendChild(E),g.appendChild(C),m.appendChild(g),a.appendChild(m),s.appendChild(a),t.appendChild(s),e.appendChild(t);const S=o.A.name("lifeRing"),T=new n.$({text:"Submit ticket",type:"primary",size:"medium",svgPathData:S.path,svgViewBox:S.viewBox,width:"auto"});T.onClick((()=>{new f(null,null,!0)})),T.render(document.getElementById("submit-ticket-button"))}}var je=s(78052);class Ue extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this.quill=null,this.initialContent="",this._readonly=!1,this._title="",this._chatId="",this._mode="",this._docid="",this._minimize=!1,this.initialLoad=!0,this.minimizedView=null,this.focusInstance=null}static get observedAttributes(){return["doc-id","doc-title","chatid","readonly","mode","minimize"]}get minimize(){return this._minimize}set minimize(e){!0===e||"true"===e||""===e?(this._minimize=!0,this.setAttribute("minimize","true"),this.minimizeEditor()):(this._minimize=!1,this.setAttribute("minimize","false"),this.maximizeEditor())}get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this.setAttribute("mode",e),this.updateQuillContainerClasses())}get title(){return this._title}set title(e){this._title=e,this.setAttribute("doc-title",e)}get chatId(){return this._chatId}set chatId(e){this._chatId=e,this.setAttribute("chatid",e)}get readonly(){return this._readonly}set readonly(e){const t=!0===e||"true"===e||""===e;this._readonly=t,t?this.setAttribute("readonly",""):this.removeAttribute("readonly"),this.updateReadonlyState()}static CustomImageResize=class{constructor(e,t={}){this.quill=e,this.options=t,this.currentImage=null,this.overlay=null,this.handles={},this.toolbar=null,this.handleKeyDown=this.handleKeyDown.bind(this),this.handleClick=this.handleClick.bind(this),this.handleScroll=this.handleScroll.bind(this),this.quill.root.addEventListener("scroll",this.handleScroll,{passive:!0}),this.quill.root.addEventListener("keydown",this.handleKeyDown),this.quill.root.addEventListener("click",this.handleClick),this.quill.on("text-change",this.handleTextChange.bind(this))}handleTextChange(e,t,s){if("user"===s&&this.currentImage){this.quill.root.querySelector(`img[data-unique-id="${this.currentImage.dataset.uniqueId}"]`)||(this.hide(),this.currentImage=null)}}isReadOnly(){return this.quill.options.readOnly}handleKeyDown(e){this.isReadOnly()||"Delete"!==e.key&&"Backspace"!==e.key||!this.currentImage||(e.preventDefault(),this.deleteImage())}deleteImage(){if(!this.isReadOnly()&&this.currentImage){const e=je.Ay.find(this.currentImage);if(e){const t=this.quill.getIndex(e);this.quill.deleteText(t,1,je.Ay.sources.USER),this.hide(),this.currentImage=null,this.quill.update(je.Ay.sources.USER),this.quill.focus()}}}handleClick(e){if(!this.isReadOnly())if(e.target&&"IMG"===e.target.tagName){if(this.currentImage&&this.currentImage.dataset.uniqueId===e.target.dataset.uniqueId)return;this.hide(),this.show(e.target)}else this.hide()}handleScroll(){this.isReadOnly()||this.currentImage&&this.updateOverlayAndHandles()}show(e){this.hide(),this.currentImage=e,e.dataset.uniqueId||(e.dataset.uniqueId=`img-${Date.now()}-${Math.random().toString(36).substring(2,11)}`),this.showHandles(),this.showToolbar()}hide(){this.overlay&&(this.overlay.remove(),this.overlay=null),Object.values(this.handles).forEach((e=>e.remove())),this.handles={},this.toolbar&&(this.toolbar.remove(),this.toolbar=null),this.currentImage=null}showHandles(){["nw","ne","sw","se"].forEach((e=>{const t=document.createElement("div");t.classList.add("custom-image-resize-handle",`custom-image-resize-handle-${e}`),this.positionHandle(t,e),t.addEventListener("mousedown",this.handleMouseDown.bind(this,e)),this.quill.root.parentNode.appendChild(t),this.handles[e]=t}))}updateOverlayPosition(){if(!this.overlay||!this.currentImage)return;const e=this.currentImage.getBoundingClientRect(),t=this.quill.root.parentNode.getBoundingClientRect(),s=this.quill.root.parentNode.scrollTop;Object.assign(this.overlay.style,{position:"absolute",top:e.top-t.top-s+"px",left:e.left-t.left+"px",width:`${e.width}px`,height:`${e.height}px`,border:"1px solid #00a0ff",boxSizing:"border-box",pointerEvents:"none",zIndex:"1"})}positionHandle(e,t){if(!this.currentImage)return;const s=this.currentImage.getBoundingClientRect(),i=this.quill.root.parentNode.getBoundingClientRect(),n=this.quill.root.parentNode.scrollTop,a=10,o={nw:{top:s.top-i.top+n,left:s.left-i.left},ne:{top:s.top-i.top+n,left:s.right-i.left-a},sw:{top:s.bottom-i.top+n-a,left:s.left-i.left},se:{top:s.bottom-i.top+n-a,left:s.right-i.left-a}};Object.assign(e.style,{position:"absolute",top:`${o[t].top}px`,left:`${o[t].left}px`,width:"10px",height:"10px",backgroundColor:"#00a0ff",cursor:`${t}-resize`})}updateOverlayAndHandles(){this.updateOverlayPosition(),Object.entries(this.handles).forEach((([e,t])=>{this.positionHandle(t,e)})),this.toolbar&&this.updateToolbarPosition()}showToolbar(){this.toolbar=document.createElement("div"),this.toolbar.classList="flex gap-x-2",this.toolbar.classList.add("custom-image-resize-toolbar"),this.updateToolbarPosition();["left","center","right"].forEach((e=>{const t=document.createElement("button");switch(t.classList="p-0.5",e){case"left":t.innerHTML='<i class="fa-solid fa-objects-align-left fa-lg"></i>';break;case"center":t.innerHTML='<i class="fa-solid fa-distribute-spacing-vertical fa-lg"></i>';break;case"right":t.innerHTML='<i class="fa-solid fa-objects-align-right fa-lg"></i>'}t.addEventListener("click",(()=>this.alignImage(e))),this.toolbar.appendChild(t)})),this.quill.container.appendChild(this.toolbar)}updateToolbarPosition(){if(!this.toolbar||!this.currentImage)return;const e=this.currentImage.getBoundingClientRect(),t=this.quill.container.getBoundingClientRect(),s=this.quill.root.parentNode.scrollTop;Object.assign(this.toolbar.style,{position:"absolute",top:e.top-t.top+s-30+"px",left:e.left-t.left+"px",backgroundColor:"#f0f0f0",padding:"5px",borderRadius:"3px",zIndex:"2"})}alignImage(e){if(!this.currentImage)return;this.currentImage.classList.remove("ql-align-left","ql-align-center","ql-align-right"),this.currentImage.style.display="",this.currentImage.style.float="",this.currentImage.style.margin="",this.currentImage.style.marginLeft="",this.currentImage.style.marginRight="";const t="16px";"center"===e?(this.currentImage.classList.add("ql-align-center"),this.currentImage.style.display="block",this.currentImage.style.marginLeft="auto",this.currentImage.style.marginRight="auto",this.currentImage.style.marginTop=t,this.currentImage.style.marginBottom=t):"left"===e?(this.currentImage.classList.add("ql-align-left"),this.currentImage.style.float="left",this.currentImage.style.marginRight=t,this.currentImage.style.marginBottom=t):"right"===e&&(this.currentImage.classList.add("ql-align-right"),this.currentImage.style.float="right",this.currentImage.style.marginLeft=t,this.currentImage.style.marginBottom=t),this.hide(),this.quill.update()}setPadding(e,t,s){const i=e.style.padding.split(" "),n=["top","right","bottom","left"].indexOf(t);if(1===i.length)i[n]=s;else if(2===i.length)i[n%2]=s;else{if(4!==i.length)return void(e.style.padding=s);i[n]=s}e.style.padding=i.join(" ")}handleMouseDown(e,t){t.preventDefault();const s=t.clientX,i=t.clientY,n=this.currentImage.width,a=this.currentImage.height,o=n/a,r=t=>{let r,l,c=t.clientX-s,d=t.clientY-i;e.includes("w")&&(c=-c),e.includes("n")&&(d=-d),e.includes("n")||e.includes("s")?(l=a+d,r=l*o):(r=n+c,l=r/o),this.currentImage.width=r,this.currentImage.height=l,this.updateOverlayAndHandles();const h=this.quill.getModule("imageMover");h&&h.resizedImages.set(this.currentImage.src,{width:r,height:l})},l=()=>{document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",l)}};static ImageMover=class{constructor(e){this.quill=e,this.container=e.root,this.draggedImageProps=null,this.isDragging=!1,this.dragStartTime=0,this.dragThreshold=200,this.resizedImages=new Map,this.mouseDownTime=0,this.container.addEventListener("mousedown",this.handleMouseDown.bind(this)),document.addEventListener("mousemove",this.handleMouseMove.bind(this)),document.addEventListener("mouseup",this.handleMouseUp.bind(this))}isReadOnly(){return this.quill.options.readOnly}handleMouseDown(e){this.isReadOnly()||"IMG"!==e.target.tagName||e.target.closest(".ql-toolbar")||(e.preventDefault(),e.stopPropagation(),this.mouseDownTime=Date.now(),this.draggedImageProps={src:e.target.src,width:e.target.width,height:e.target.height,uniqueId:e.target.dataset.uniqueId},e.target.setAttribute("data-being-dragged","true"),this.isDragging=!1,this.initialX=e.clientX,this.initialY=e.clientY,this.dragStartTime=Date.now())}handleMouseMove(e){if(!this.isReadOnly()&&this.draggedImageProps&&Date.now()-this.dragStartTime>this.dragThreshold){if(e.preventDefault(),e.stopPropagation(),!this.isDragging){this.isDragging=!0;const e=this.quill.root.querySelector('img[data-being-dragged="true"]');e&&(e.style.opacity="0.5",e.style.position="absolute",this.container.appendChild(e)),document.body.classList.add("dragging-internal-image"),this.quill.isInternalImageDrag=!0}if(this.isDragging){const t=this.quill.root.querySelector('img[data-being-dragged="true"]');if(t){const s=this.container.getBoundingClientRect(),i=Math.max(0,Math.min(e.clientX-s.left,s.width)),n=Math.max(0,Math.min(e.clientY-s.top,s.height));t.style.left=`${i}px`,t.style.top=`${n}px`}}}}handleMouseUp(e){if(this.isReadOnly())return;const t=Date.now()-this.mouseDownTime;if(this.draggedImageProps&&this.isDragging){e.preventDefault(),e.stopPropagation();try{const t=this.quill.container.getBoundingClientRect(),s=e.clientY-t.top,i=s+this.quill.root.scrollTop;let n=this.quill.getLength()-1;const a=this.quill.getLines(0,this.quill.getLength());for(let e=0;e<a.length;e++){const t=a[e],s=this.quill.getIndex(t);if(i<this.quill.getBounds(s).bottom){n=s;break}}const o=this.quill.root.querySelector('img[data-being-dragged="true"]');if(o){const e=this.quill.getIndex(je.Ay.find(o));this.quill.deleteText(e,1)}if(this.draggedImageProps&&this.draggedImageProps.src){const e={src:this.draggedImageProps.src,width:this.draggedImageProps.width,height:this.draggedImageProps.height,uniqueId:this.draggedImageProps.uniqueId};this.quill.insertEmbed(n,"image",e,"user");const t=this.quill.root.querySelector(`img[src="${this.draggedImageProps.src}"]`);t&&(t.width=this.draggedImageProps.width,t.height=this.draggedImageProps.height),this.quill.setSelection(n+1,0)}}catch(e){}}else if(t<this.dragThreshold){const e=this.quill.getModule("customImageResize");if(e){const t=this.quill.root.querySelector('img[data-being-dragged="true"]');t&&e.show(t)}}const s=this.quill.root.querySelector('img[data-being-dragged="true"]');s&&(s.removeAttribute("data-being-dragged"),s.style.opacity="1",s.style.position="",s.style.left="",s.style.top=""),this.draggedImageProps=null,this.isDragging=!1,document.body.classList.remove("dragging-internal-image"),this.quill.isInternalImageDrag=!1}};attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"doc-id":s&&(window.docEditors=window.docEditors||{},window.docEditors[s]=this);break;case"doc-title":this.title=s;break;case"chatid":this.chatId=s;break;case"readonly":this.readonly=null!==s;break;case"mode":this.mode=s;break;case"minimize":this.minimize=s}}connectedCallback(){this.initialContent=this.innerHTML,this.innerHTML="",this.createEditorStructure(),this.initializeQuill(),this.updateReadonlyState(),this.addCustomStyles(),this.createFloatingMenu()}createEditorStructure(){this.editorWrapper=document.createElement("div"),this.editorWrapper.classList="rounded-t-lg rounded-b-md mb-4 mt-2 text-black pb-1 bg-white text-black overflow-hidden max-h-full",this.appendChild(this.editorWrapper),this.createFocusWindowMenu(),this.createQuillContainer()}createFocusWindowMenu(){const e={title:this._title,mode:this._mode,simpleModeTitle:this._title||"",extension:"doc",fileMenu:[{type:"item",label:"Save",onClick:()=>{this.save(!0)}},{type:"item",label:"Save As",onClick:()=>{}},{type:"divider"},{type:"item",label:"Download as PDF",onClick:()=>this.download("pdf")},{type:"item",label:"Download as DOCX",onClick:()=>this.download("docx")}],editMenu:[{type:"item",label:"Copy",onClick:()=>{this.copyToClipboard()}},{type:"item",label:"Paste",onClick:()=>{}},{type:"item",label:"Select All",onClick:()=>{this.selectAllContent()}}],quickActions:[{type:"icon",icon:"fa-solid fa-cloud-download",hoverText:"Download",onClick:()=>{this.download("docx")}},{type:"icon",icon:"fa-solid fa-copy",hoverText:"Copy",onClick:()=>{this.copyToClipboard()}}],onTitleChange:e=>{this.title=e},onEnterFocus:()=>{this.handleFocus()},onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus()}};this.focusWindowMenu=new D(e);const t=this.focusWindowMenu.create();this.editorWrapper.appendChild(t)}createQuillContainer(){this.quillContainer=document.createElement("div"),this.updateQuillContainerClasses(),this.quillContainer.addEventListener("dragover",this.handleDragOver.bind(this)),this.editorWrapper.appendChild(this.quillContainer)}applyDelta(e){if(this.quill){const t=this.quill.getLength();e.unshift({retain:t}),this.quill.updateContents(e,"silent"),this.scrollToBottom()}}initializeQuill(){const e=["small","normal","large","huge"],t=je.Ay.import("blots/block/embed");try{class s extends t{static create(e){const t=super.create();return t.setAttribute("src",e.src),t.setAttribute("data-unique-id",e.uniqueId||`img-${Date.now()}-${Math.random().toString(36).substring(2,11)}`),e.width&&t.setAttribute("width",e.width),e.height&&t.setAttribute("height",e.height),e.float&&(t.style.float=e.float),e.margin&&(t.style.margin=e.margin),t}static value(e){return{src:e.getAttribute("src"),uniqueId:e.getAttribute("data-unique-id"),width:e.getAttribute("width"),height:e.getAttribute("height"),float:e.style.float,margin:e.style.margin}}}s.blotName="image",s.tagName="img",je.Ay.register(s),je.Ay.imports["formats/image"]||je.Ay.register(s),je.Ay.imports["modules/imageMover"]||je.Ay.register("modules/imageMover",Ue.ImageMover),je.Ay.imports["modules/customImageResize"]||je.Ay.register("modules/customImageResize",Ue.CustomImageResize),this.Delta=je.Ay.import("delta"),this.quill=new je.Ay(this.quillContainer,{theme:"snow",modules:{toolbar:[["bold","italic","underline","strike"],["link","blockquote","code-block"],[{size:e}],[{color:[]},{background:[]}],[{align:[]}],[{list:"ordered"},{list:"bullet"}],["table"]],clipboard:{matchVisual:!1},imageMover:!0,customImageResize:{},table:!0},formats:["bold","italic","underline","strike","align","list","indent","link","image","video","color","background","font","size","script","header","blockquote","code-block","table"],readOnly:this._readonly,bounds:this.editorWrapper});let i=null;this.quill.root.addEventListener("dragover",(e=>{e.preventDefault()})),this.quill.root.addEventListener("drop",(e=>{if(e.preventDefault(),e.stopPropagation(),this.quill.isInternalImageDrag)return;let t=(this.quill.getSelection()||{}).index||this.quill.getLength();const s=this.quill.container.getBoundingClientRect(),i=e.clientY-s.top+this.quill.root.scrollTop,[n,a]=this.quill.getLeaf(i);if(n&&(t=this.quill.getIndex(n)+a),e.dataTransfer.files&&e.dataTransfer.files.length>0){const s=e.dataTransfer.files[0];if(s.type.match(/^image\//)){const e=new FileReader;e.onload=e=>{const s=document.createElement("img");s.src=e.target.result,s.onload=()=>{const i=`img-${Date.now()}-${Math.random().toString(36).substring(2,11)}`,n=(new this.Delta).retain(t).insert({image:{src:e.target.result,width:s.width,height:s.height,uniqueId:i}});this.quill.updateContents(n,"user"),this.quill.setSelection(t+1,0)}},e.readAsDataURL(s)}}else{const s=e.dataTransfer.getData("text/html");if(s){const e=(new DOMParser).parseFromString(s,"text/html").querySelector("img");if(e&&e.src){if(this.quill.isInternalImageDrag){const e=this.quill.root.querySelector('img[data-being-dragged="true"]');if(e){const t=this.quill.getIndex(e);this.quill.deleteText(t,1)}}const s=(new this.Delta).retain(t).insert({image:{src:e.src,width:e.width,height:e.height}});this.quill.updateContents(s,"user"),this.quill.setSelection(t+1,0);const i=this.quill.root.querySelector(`img[src="${e.src}"]`);i&&(i.width="350",i.removeAttribute("data-being-dragged"))}else{const e=this.quill.clipboard.convert(s);this.quill.updateContents((new this.Delta).retain(t).concat(e),"user"),this.quill.setSelection(t+e.length(),0)}}}})),this.quill.on("selection-change",((e,t,s)=>{"user"===s&&(i=this.quillContainer.scrollTop,e&&this.normalizeSelection(e),this.handleSelectionChange.bind(this)(e,t,s))})),this.quill.on("text-change",((e,t,s)=>{this.handleQuillChange(e,t,s),this.makeQuillImagesDraggable(),"user"===s&&null!==i&&this.quill&&this.quill.root&&(this.quill.root.scrollTop=i,i=null)})),this.quillContainer.addEventListener("dragover",(e=>{e.preventDefault()})),this.initialContent.trim()&&this.quill.clipboard.dangerouslyPasteHTML(this.initialContent.trim())}catch(e){}}normalizeSelection(e){if(e&&e.length<0){const t={index:e.index+e.length,length:Math.abs(e.length)};return this.quill.setSelection(t,je.Ay.sources.SILENT),t}return e}makeQuillImagesDraggable(){this.quillContainer.querySelectorAll("img").forEach((e=>{e.setAttribute("draggable","true"),e.addEventListener("dragstart",(t=>{t.dataTransfer.setData("text/plain",JSON.stringify({type:"quill-image",src:e.src,alt:e.alt}))}))}))}handleDragOver(e){e.preventDefault(),e.stopPropagation()}addCustomStyles(){const e=document.createElement("style");e.textContent="\n            .ql-editor {\n                font-size: 14px;\n                line-height: 1.6;\n            }\n            .ql-editor .inserted-content > * {\n                margin-bottom: 1em;\n            }\n            .ql-editor h1 {\n                font-size: 1.8em;\n                font-weight: bold;\n                margin-top: 1em;\n                margin-bottom: 0.5em;\n            }\n            .ql-editor h2 {\n                font-size: 1.5em;\n                font-weight: bold;\n                margin-top: 1em;\n                margin-bottom: 0.5em;\n            }\n            .ql-editor h3 {\n                font-size: 1.2em;\n                font-weight: bold;\n                margin-top: 1em;\n                margin-bottom: 0.5em;\n            }\n            .ql-editor p {\n                margin-bottom: 1em;\n            }\n            .ql-editor ul, .ql-editor ol {\n                padding-left: 1.5em;\n                margin-bottom: 1em;\n            }\n            .ql-editor li {\n                margin-bottom: 0.5em;\n            }\n            .ql-editor li:last-child {\n                margin-bottom: 0;\n            }\n            .ql-editor blockquote {\n                border-left: 4px solid #ccc;\n                margin: 1em 0;\n                padding: 0.5em 1em;\n                background-color: #f0f0f0;\n                color: #333;\n                font-style: italic;\n            }\n            .ql-snow .ql-picker-label {\n                display: flex;\n                align-items: center;\n                height: 100%;\n            }\n            .ql-container.ql-snow {\n                border: none;\n            }\n\n            .ql-toolbar.ql-snow {\n                border: none;\n                background-color: #f5f5f5;\n                //padding: 8px;\n            }\n            \n            .ql-editor img {\n                cursor: move;\n                border-radius: 0px;\n            }\n        ",this.appendChild(e)}updateReadonlyState(){if(this.quill){this.quill.enable(!this._readonly),this.quill.theme.modules.toolbar.container.style.display=this._readonly?"none":"block";const e=this.quill.getModule("customImageResize");e&&this._readonly&&e.hide()}}updateQuillContainerClasses(){this.quillContainer&&("focus"===this._mode?this.quillContainer.classList="bg-white overflow-y-auto text-black max-h-[calc(var(--vh)*100-110px)] min-h-[calc(var(--vh)*100-110px)]":this.quillContainer.classList="bg-white max-h-[400px] text-black overflow-y-auto")}handleQuillChange(e,t,s){clearTimeout(this.timeoutId),this.timeoutId=setTimeout((()=>{const t=this.quill.root.innerHTML,s=this.quill.getText(),i=this.quill.getContents();e.ops.some((e=>e.attributes&&e.attributes.width)),this.dispatchEvent(new CustomEvent("editor-change",{detail:{html:t,text:s,delta:i}}))}),300)}setContent(e){this.quill}insertHTML(e){if(this.quill){const t=`<div class="inserted-content">${e}</div>`,s=this.quill.getSelection();s?this.quill.clipboard.dangerouslyPasteHTML(s.index,t,"api"):this.quill.clipboard.dangerouslyPasteHTML(this.quill.getLength(),t,"api"),this.quill.insertText(this.quill.getLength(),"\n")}}scrollToBottom(){this.quill&&this.quillContainer&&requestAnimationFrame((()=>{const e=this.quillContainer.scrollHeight-this.quillContainer.clientHeight;this.quillContainer.scrollTop=e;const t=this.quill.getLength();this.quill.setSelection(t,0)}))}maintainScrollPosition(e){const t=this.quillContainer.scrollTop;e(),this.quillContainer.scrollTop=t}handleFocus(){this.setAttribute("minimize","true"),this.focusInstance=new G(this.chatId,this,{content:this.quill.root.innerHTML,originalInstance:this})}focus(){this.focusDocumentEditor=document.createElement("document-editor"),this.focusDocumentEditor.setAttribute("doc-title",this._title),this.focusDocumentEditor.setAttribute("chatid",this._chatId),this.focusDocumentEditor.setAttribute("mode","focus"),this.focusDocumentEditor.innerHTML=this.quill.root.innerHTML,this.focusDocumentEditor.originalInstance=this;return new MutationObserver((e=>{e.forEach((e=>{if("attributes"===e.type&&"doc-title"===e.attributeName){const e=this.focusDocumentEditor.getAttribute("doc-title");this.title=e,this.updateMinimizedView()}}))})).observe(this.focusDocumentEditor,{attributes:!0,attributeFilter:["doc-title"]}),this.focusDocumentEditor}save(e=!1){this.quill&&(this.initialContent=this.quill.root.innerHTML,e&&this.showToast("Document saved successfully","success"))}selectAllContent(){if(this.quill){this.quill.getSelection(),this.quill.root.scrollTop;this.quill.setSelection(0,this.quill.getLength(),"silent")}}copyToClipboard(){const e=this.quill.getText();navigator.clipboard.writeText(e).then((()=>{this.showToast("Copied to clipboard","success")})).catch((t=>{this.fallbackCopyToClipboard(e)}))}fallbackCopyToClipboard(e){const t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.focus(),t.select();try{document.execCommand("copy"),this.showToast("Copied to clipboard","success")}catch(e){this.showToast("Failed to copy to clipboard","error")}document.body.removeChild(t)}showToast(e,t="success"){new c.y(e,t,!0,!0,3e3)}download(){const e=this.quill.root.innerHTML,t=new Blob([e],{type:"text/html"}),s=URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`${this.title||"document"}.html`,document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(s)}closeFocus(){this.focusInstance&&(this.focusDocumentEditor&&(this.initialContent=this.focusDocumentEditor.quill.root.innerHTML),this.focusInstance.close(),this.focusInstance=null),this.focusDocumentEditor&&(this.quill.root.innerHTML=this.initialContent||this.focusDocumentEditor.innerHTML,this.focusDocumentEditor.remove(),this.focusDocumentEditor=null),this.editorWrapper.style.opacity="0",this.editorWrapper.style.display="block",setTimeout((()=>{this.editorWrapper.style.transition="opacity 0.5s ease-in",this.editorWrapper.style.opacity="1"}),10),this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null),this.setAttribute("minimize","false"),this.setAttribute("readonly","true")}minimizeEditor(){this.initialContent=this.quill.root.innerHTML,this.editorWrapper.style.display="none",this.minimizedView||(this.minimizedView=this.createMinimizedView()),this.minimizedView.classList.add("pb-4"),this.appendChild(this.minimizedView)}maximizeEditor(){this.minimizedView&&this.removeChild(this.minimizedView),this.editorWrapper.style.display="block",this.initialContent&&(this.quill.root.innerHTML=this.initialContent,this.initialContent=null)}updateMinimizedView(){this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=this.createMinimizedView(),this.appendChild(this.minimizedView))}minimizeInChat(){this._minimize||(this.setAttribute("minimize","true"),this.wrapper.style.display="none",this.minimizedView||(this.minimizedView=this.createMinimizedView()),this.appendChild(this.minimizedView),this.classList.add("py-4"))}createMinimizedView(){const e={name:this.title||"Untitled Document",type:"document",extension:"doc"};return new Y([e],null).createFileItem(e,e.extension)}async updateContentStream(e,t,s){if(!this.quill)return;const i=this.quillContainer.scrollTop,n=new TextDecoder,a=s.getReader();let o="";try{for(;;){const{done:s,value:r}=await a.read();if(s)break;o+=n.decode(r,{stream:!0}),this.quill.deleteText(e,t-e),this.quill.insertText(e,o,"api"),t=e+o.length,this.quillContainer.scrollTop=i}}catch(e){}finally{a.releaseLock()}o&&(this.quill.deleteText(e,t-e),this.quill.insertText(e,o,"api")),this.quillContainer.root.scrollTop=i}createFloatingMenu(){this.floatingMenu=document.createElement("div"),this.floatingMenu.className=`absolute ${this.theme.background} shadow-md rounded-md p-2 z-30 flex gap-2 opacity-0 transition-opacity duration-200 ease-in-out`,this.rewriteButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",icon:"fa-solid fa-pen",hoverText:"Re-write"}),this.expandButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",icon:"fa-solid fa-arrows-from-line",hoverText:"Expand"}),this.changeToneButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",icon:"fa-solid fa-message-lines",hoverText:"Change tone"}),this.copyButton=new n.$({text:"",type:"secondaryTransparent",size:"small",width:"auto",icon:"fa-solid fa-copy",hoverText:"Copy to clipboard"}),this.copyButton.render(this.floatingMenu),this.rewriteButton.render(this.floatingMenu),this.expandButton.render(this.floatingMenu),this.changeToneButton.render(this.floatingMenu),this.copyButton.onClick(this.handleCopy.bind(this)),this.rewriteButton.onClick(this.handleRewrite.bind(this)),this.expandButton.onClick(this.handleExpand.bind(this)),this.changeToneButton.onClick(this.handleChangeTone.bind(this))}showFloatingMenu(e){this.floatingMenu||this.createFloatingMenu();const{left:t,right:s,top:i,bottom:n}=e;this.floatingMenu.classList.remove("hidden"),this.floatingMenu.style.opacity="0";const a=this.floatingMenu.offsetHeight,o=this.floatingMenu.offsetWidth,r=this.quill.root.parentNode,l=r.getBoundingClientRect(),c=r.scrollTop,d=r.scrollLeft,h=this.quill.container.querySelector(".ql-toolbar"),m=h?h.offsetHeight:0,u=l.height-(n-l.top),p=i-l.top-m,g=l.width-(s-l.left),f=t-l.left;let v,y;v=u>=a?n-l.top+c:p>=a?i-l.top-a+c:l.height-a+c,v=Math.max(v,m),y=f>=o?t-l.left+d:g>=o?s-l.left-o+d:Math.max(0,Math.min(t-l.left-o/2,l.width-o))+d,this.floatingMenu.style.top=`${v}px`,this.floatingMenu.style.left=`${y}px`,this.floatingMenu.style.right="auto",this.floatingMenu.style.bottom="auto",this.floatingMenu.parentNode!==r&&r.appendChild(this.floatingMenu),this.floatingMenu.style.zIndex="1000",requestAnimationFrame((()=>{this.floatingMenu.style.opacity="1"}))}hideFloatingMenu(){this.floatingMenu&&this.floatingMenu.classList.add("hidden")}preserveSelection(e){const t=this.quill.getSelection();e(),t&&setTimeout((()=>{this.quill.setSelection(t,je.Ay.sources.SILENT)}),0)}handleSelectionChange(e,t,s){this.floatingMenu||this.createFloatingMenu(),clearTimeout(this.selectionChangeTimeout),e&&e.length>0?this.selectionChangeTimeout=setTimeout((()=>{const t=this.quill.getBounds(e.index,e.length);this.showFloatingMenu(t),this.selectedText=this.quill.getText(e.index,e.length)}),500):this.hideFloatingMenu()}handleCopy(){this.selectedText&&navigator.clipboard.writeText(this.selectedText).then((()=>{this.showToast("Copied to clipboard","success")})).catch((e=>{this.fallbackCopyToClipboard(this.selectedText)})),this.hideFloatingMenu()}handleRewrite(){this.selectedText,this.hideFloatingMenu()}handleExpand(){this.selectedText,this.hideFloatingMenu()}handleChangeTone(){this.selectedText,this.hideFloatingMenu()}disconnectedCallback(){this.quill&&this.floatingMenu&&this.floatingMenu.parentNode&&this.floatingMenu.parentNode.removeChild(this.floatingMenu)}}customElements.define("document-editor",Ue);var Ve=s(27323);class We extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this.hot=null,this.initialContent="",this._readonly=!1,this._title="",this._chatId="",this._mode="",this._minimize=!1,this.streaming=!1,this.originalInstance=null,this.minimizedView=null,this.wrapper=null}static get observedAttributes(){return["spreadsheet-title","chatid","readonly"]}get title(){return this._title}set title(e){this._title=e,this.setAttribute("spreadsheet-title",e),this.spreadsheetTitle&&(this.spreadsheetTitle.innerHTML=e||"New spreadsheet")}get chatId(){return this._chatId}set chatId(e){this._chatId=e,this.setAttribute("chatid",e)}get readonly(){return this._readonly}set readonly(e){const t=!0===e||"true"===e||""===e;this._readonly=t,t?this.setAttribute("readonly",""):this.removeAttribute("readonly"),this.updateReadonlyState()}updateReadonlyState(){this.hot&&this.hot.updateSettings({readOnly:this._readonly})}minimizeInChat(){this._minimize||(this.setAttribute("minimize","true"),this.initialContent=this.getCSV(),this.spreadsheetWrapper&&(this.spreadsheetWrapper.style.display="none"),this.minimizedView||(this.minimizedView=this.createMinimizedView()),this.appendChild(this.minimizedView))}maximizeInChat(){this.setAttribute("minimize","false"),this.focusInstance=null,this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null),this.spreadsheetWrapper&&(this.spreadsheetWrapper.style.display="block")}createMinimizedView(){const e=document.createElement("div");e.classList=`flex items-center justify-between ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} rounded-md px-2 py-1 my-1 cursor-pointer`;const t=document.createElement("div");t.classList="flex items-center gap-2";const s=document.createElement("i");s.classList="fas fa-table";const i=document.createElement("span");i.textContent=this.title||"Spreadsheet",t.appendChild(s),t.appendChild(i);const n=document.createElement("div");n.classList="flex items-center gap-2";const a=document.createElement("button");return a.classList=`${this.theme.focusMenuHover} rounded px-2 py-1`,a.innerHTML='<i class="fas fa-expand"></i>',a.addEventListener("click",(e=>{e.stopPropagation(),this.maximizeInChat()})),n.appendChild(a),e.appendChild(t),e.appendChild(n),e.addEventListener("click",(()=>{this.maximizeInChat()})),e}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"spreadsheet-title":this.title=s;break;case"chatid":this.chatId=s;break;case"readonly":this.readonly=null!==s;break;case"minimize":this.minimize=s}}connectedCallback(){this.initialContent=this.textContent.trim(),this.innerHTML="",this._mode=this.getAttribute("mode")||"","focus"!==this._mode&&(this.marginWrapper=document.createElement("div"),this.marginWrapper.classList="spreadsheet-margin-wrapper my-2",this.appendChild(this.marginWrapper)),this.spreadsheetWrapper=document.createElement("div"),"focus"===this._mode?this.spreadsheetWrapper.classList="rounded-t-lg rounded-b-md pt-4 bg-white text-black":this.spreadsheetWrapper.classList="rounded-t-lg rounded-b-md mb-2 mt-1 text-white pb-1 bg-white text-black","focus"===this._mode?this.appendChild(this.spreadsheetWrapper):this.marginWrapper.appendChild(this.spreadsheetWrapper),this.createCustomToolbar(),this.createHandsontableContainer(),this.initializeHandsontable(),this.updateReadonlyState(),this.addCustomStyles(),this.initializeFocusMode()}handleFocus(e=0){this.focusInstance?this.focusInstance.updateFocusContent(this,{versionToLoad:e}):(this.save(),this.minimizeInChat(),this.focusInstance=new G(this.chatId,this,{versionToLoad:e}))}async save(){const e=this.getCSV();this.dispatchEvent(new CustomEvent("spreadsheet-save",{detail:{data:e}}))}closeFocus(){if(this.originalInstance){const e=this.hot.getData();this.originalInstance.setContent(e)}this.cleanup()}cleanup(){this.hot&&this.hot.destroy()}cleanup(){this.hot&&this.hot.destroy()}focus(e){const t=document.createElement("spreadsheet-editor");t.setAttribute("mode","focus"),t.setAttribute("spreadsheet-title",this.title),this.readonly&&t.setAttribute("readonly",""),t.originalInstance=this;const s=this.hot?this.hot.getData():null;return s&&setTimeout((()=>{t.setContent(s)}),0),t}createCustomToolbar(){const e={title:this._title,mode:this._mode,simpleModeTitle:"Spreadsheet",fileMenu:[{type:"item",label:"Save",onClick:()=>{this.save()}},{type:"divider"},{type:"item",label:"Download CSV",onClick:()=>this.downloadCSV()},{type:"item",label:"Download Excel",onClick:()=>this.downloadExcel()}],editMenu:[{type:"item",label:"Cut",onClick:()=>{this.cut()}},{type:"item",label:"Copy",onClick:()=>{this.copy()}},{type:"item",label:"Paste",onClick:()=>{this.paste()}},{type:"divider"},{type:"item",label:"Insert row above",onClick:()=>{this.insertRowAbove()}},{type:"item",label:"Insert row below",onClick:()=>{this.insertRowBelow()}},{type:"item",label:"Delete row",onClick:()=>{this.deleteRow()}},{type:"divider"},{type:"item",label:"Insert column left",onClick:()=>{this.insertColumnLeft()}},{type:"item",label:"Insert column right",onClick:()=>{this.insertColumnRight()}},{type:"item",label:"Delete column",onClick:()=>{this.deleteColumn()}}],viewMenu:[{type:"item",label:"Enter full screen",onClick:()=>this.openFullScreen()}],quickActions:[{type:"icon",icon:"fa-solid fa-copy",hoverText:"Copy",onClick:()=>{this.copyToClipboard()}}],onTitleChange:e=>{this.title=e},onEnterFocus:()=>{this.streaming||this.handleFocus()},onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus(),this.cleanup()}};this.focusWindowMenu=new D(e),this.menuElement=this.focusWindowMenu.create(),this.spreadsheetWrapper.appendChild(this.menuElement)}async downloadCSV(){const e=this.getCSV(),t=new Blob([e],{type:"text/csv"}),s=window.URL.createObjectURL(t),i=document.createElement("a");i.href=s,i.download=`${this.title||"spreadsheet"}.csv`,i.click(),window.URL.revokeObjectURL(s)}async downloadExcel(){}cut(){this.hot&&this.hot.copyPaste.cut()}copy(){this.hot&&this.hot.copyPaste.copy()}paste(){this.hot&&this.hot.copyPaste.paste()}insertRowAbove(){if(this.hot){const e=this.hot.getSelected();if(e){const[t]=e[0];this.hot.alter("insert_row",t)}}}insertRowBelow(){if(this.hot){const e=this.hot.getSelected();if(e){const[t]=e[0];this.hot.alter("insert_row",t+1)}}}deleteRow(){if(this.hot){const e=this.hot.getSelected();if(e){const[t]=e[0];this.hot.alter("remove_row",t)}}}insertColumnLeft(){if(this.hot){const e=this.hot.getSelected();if(e){const[,t]=e[0];this.hot.alter("insert_col",t)}}}insertColumnRight(){if(this.hot){const e=this.hot.getSelected();if(e){const[,t]=e[0];this.hot.alter("insert_col",t+1)}}}deleteColumn(){if(this.hot){const e=this.hot.getSelected();if(e){const[,t]=e[0];this.hot.alter("remove_col",t)}}}openFullScreen(){this.hot&&this.hot.updateSettings({height:"100vh",width:"100vw"})}copyToClipboard(){if(this.hot){const e=this.getCSV();navigator.clipboard.writeText(e).then((()=>{})).catch((e=>{}))}}createHandsontableContainer(){this.handsontableContainer=document.createElement("div"),"focus"===this._mode?this.handsontableContainer.classList.add("bg-white","text-black","pt-6"):this.handsontableContainer.classList.add("bg-white","max-h-[300px]","sm:max-h-[400px]","overflow-y-auto","min-h-[300px]","text-black"),this.spreadsheetWrapper.appendChild(this.handsontableContainer)}initializeFocusMode(){"focus"===this._mode&&(this.handsontableContainer.classList.add("h-full"),this.hot&&this.hot.updateSettings({height:"calc(var(--vh)*100 - 63px)",width:"100%"}))}initializeHandsontable(){try{const e=this.initialContent?this.parseCSV(this.initialContent):[["Header 1","Header 2","Header 3","Header 4"],["","","",""],["","","",""],["","","",""]],t=document.createElement("div");t.className=this.theme.focusBackground,document.body.appendChild(t);const s=window.getComputedStyle(t).backgroundColor;t.className=this.theme.focusMenuTextColor;const i=window.getComputedStyle(t).color;document.body.removeChild(t),this.hot=new Ve.Ay(this.handsontableContainer,{data:e,rowHeaders:!0,colHeaders:!1,height:"auto",licenseKey:"non-commercial-and-evaluation",afterChange:(e,t)=>{"loadData"!==t&&this.handleHandsontableChange(e)},afterScrollVertically:()=>{this.handleScroll()},autoColumnSize:{samplingRatio:1},autoRowSize:{syncLimit:500},stretchH:"all",manualColumnResize:!0,manualRowResize:!0,rowHeights:28,cells(e,t){const n={};return 0===e&&(n.className="header-cell",n.readOnly=!0,n.renderer=function(e,t,n,a,o,r,l){Ve.Ay.renderers.TextRenderer.apply(this,arguments),t.style.backgroundColor=s,t.style.color=i,t.style.fontWeight="bold",t.style.textAlign="center"}),n},fixedRowsTop:1})}catch(e){}}addCustomStyles(){const e=document.createElement("style");e.textContent="\n            .handsontable {\n                font-size: 14px;\n            }\n            .handsontable .htCore {\n                border: none;\n            }\n            .handsontable .wtHolder {\n                max-height: 300px;\n            }\n            @media (min-width: 640px) {\n                .handsontable .wtHolder {\n                    max-height: 600px;\n                }\n            }\n            .handsontable td,\n            .handsontable th {\n                padding: 8px;\n                border: 1px solid #e0e0e0;\n                height: 28px !important;\n                line-height: 28px !important;\n            }\n            .handsontable .htDimmed {\n                color: #999;\n            }\n            .handsontable .current {\n                border: 2px solid #4285f4;\n            }\n            .handsontable .wtSpreader {\n                border-top: 2px solid #ccc;\n            }\n            .handsontable .wtHider {\n                border-top: none;\n            }\n            /* New styles for row header alignment */\n            .handsontable th.htRowHeader {\n                vertical-align: middle;\n                text-align: center;\n                height: 28px !important;\n                line-height: 28px !important;\n                padding: 8px;\n            }\n        ",this.appendChild(e)}handleScroll(){}handleCopy(){if(this.hot){if(this.hot.getSelected()){const e=this.hot.copyPaste.copyPasteInstance.elTextarea.value;navigator.clipboard.writeText(e).then((()=>{})).catch((e=>{}))}}}handleHandsontableChange(e){const t=this.hot.getData();this.dispatchEvent(new CustomEvent("spreadsheet-change",{detail:{changes:e,data:t}}))}parseCSV(e){return e.split("\n").map((e=>e.split(",").map((e=>e.trim()))))}setContent(e){this.hot&&("string"==typeof e&&(e=this.parseCSV(e)),this.hot.loadData(e))}insertData(e){if(this.hot){let t;if("string"==typeof e)t=this.parseCSV(e);else{if(!Array.isArray(e))return;t=e}const s=[...this.hot.getData(),...t];this.hot.loadData(s),this.scrollToBottom()}}getCSV(){if(this.hot){return this.hot.getData().map((e=>e.join(","))).join("\n")}return""}scrollToBottom(){if(this.hot){const e=this.hot.countRows()-1;this.hot.scrollViewportTo(e)}}get minimize(){return this._minimize}set minimize(e){!0===e||"true"===e||""===e?(this._minimize=!0,this.setAttribute("minimize","true")):(this._minimize=!1,this.setAttribute("minimize","false"))}static get observedAttributes(){return["spreadsheet-title","chatid","readonly","minimize"]}disconnectedCallback(){this.hot&&this.hot.destroy()}}customElements.define("spreadsheet-editor",We);var Ge=s(91100);Ge.EA.workerSrc="/static/bundles/pdf.worker.js";class Ke extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._path="",this.pdfDoc=null,this.pageNum=1,this.pageRendering=!1,this.pageNumPending=null,this.scale=1.5,this.canvas=null,this.ctx=null,this._title="PDF Document",this._readonly=!1,this._chatId=""}static get observedAttributes(){return["path","document-title","chatid","readonly"]}get path(){return this._path}set path(e){this._path=e,this.setAttribute("path",e),this.loadPDF()}get title(){return this._title}set title(e){this._title=e,this.setAttribute("document-title",e),this.pdfTitle&&(this.pdfTitle.innerHTML=e||"New PDF")}get chatId(){return this._chatId}set chatId(e){this._chatId=e,this.setAttribute("chatid",e)}get readonly(){return this._readonly}set readonly(e){const t=!0===e||"true"===e||""===e;this._readonly=t,t?this.setAttribute("readonly",""):this.removeAttribute("readonly")}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"path":this.path=s;break;case"document-title":this.title=s;break;case"chatid":this.chatId=s;break;case"readonly":this.readonly=null!==s}}connectedCallback(){this.createPDFStructure(),this.addCustomStyles(),this._path&&this.loadPDF()}createPDFStructure(){this.pdfWrapper=document.createElement("div"),this.pdfWrapper.classList="rounded-t-lg rounded-b-md mb-2 mt-1 text-white pb-1 bg-white text-black",this.appendChild(this.pdfWrapper),this.createCustomToolbar(),this.createPDFContent()}createCustomToolbar(){this.customToolbar=document.createElement("div"),this.customToolbar.classList=`flex justify-between gap-2 ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} py-1 px-2 rounded-t-md`,this.lhsButtons=document.createElement("div"),this.lhsButtons.classList="flex gap-2 justify-start align-middle items-center",this.centerTitle=document.createElement("div"),this.centerTitle.classList="flex-1 text-center font-bold text-lg",this.rhsButtons=document.createElement("div"),this.rhsButtons.classList="flex gap-2 justify-end align-middle items-center",this.createPDFTitle(),this.createFileButton(),this.createFocusButton(),this.customToolbar.appendChild(this.lhsButtons),this.customToolbar.appendChild(this.centerTitle),this.customToolbar.appendChild(this.rhsButtons),this.pdfWrapper.appendChild(this.customToolbar)}createPDFTitle(){this.pdfTitle=document.createElement("span"),this.pdfTitle.classList="font-bold text-base max-w-[200px] truncate",this.pdfTitle.innerHTML=this._title||"New PDF",this.pdfTitle.contentEditable=!0,this.pdfTitle.addEventListener("click",(()=>{const e=document.createRange();e.selectNodeContents(this.pdfTitle);const t=window.getSelection();t.removeAllRanges(),t.addRange(e)})),this.centerTitle.appendChild(this.pdfTitle)}createFileButton(){this.fileButton=document.createElement("button"),this.fileButton.classList=`rounded-md px-2 py-0.5 text-base font-bold ${this.theme.focusMenuHover}`,this.fileButton.innerHTML="File",this.lhsButtons.appendChild(this.fileButton)}createFocusButton(){this.focusButton=document.createElement("button"),this.focusButton.classList=`rounded-md px-2 py-1 text-base ${this.theme.focusMenuHover}`,this.focusButton.innerHTML='<i class="fa-solid fa-expand"></i>',this.focusButton.addEventListener("click",this.handleFocus.bind(this)),this.rhsButtons.appendChild(this.focusButton)}createPDFContent(){this.pdfContent=document.createElement("div"),this.pdfContent.classList.add("bg-white","max-h-[300px]","sm:max-h-[600px]","overflow-y-auto","min-h-[300px]","text-black"),this.pdfControls=document.createElement("div"),this.pdfControls.classList.add("pdf-controls","p-2"),this.pdfControls.innerHTML='\n        <button id="prev">Previous</button>\n        <button id="next">Next</button>\n        <button id="fit-to-width">Fit to Width</button>\n        <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>\n    ',this.canvas=document.createElement("canvas"),this.canvas.id="pdf-viewer",this.pdfContent.appendChild(this.pdfControls),this.pdfContent.appendChild(this.canvas),this.pdfWrapper.appendChild(this.pdfContent),this.ctx=this.canvas.getContext("2d"),this.pdfControls.querySelector("#prev").addEventListener("click",(()=>this.onPrevPage())),this.pdfControls.querySelector("#next").addEventListener("click",(()=>this.onNextPage())),this.pdfControls.querySelector("#fit-to-width").addEventListener("click",(()=>this.fitToWidth()))}addCustomStyles(){const e=document.createElement("style");e.textContent="\n            pdf-document {\n                display: block;\n                width: 100%;\n                max-width: 800px;\n                margin: 0 auto;\n            }\n            .pdf-controls {\n                margin-bottom: 10px;\n            }\n            #pdf-viewer {\n                border: 1px solid #ccc;\n            }\n        ",this.appendChild(e)}async loadPDF(){try{this.pdfDoc=await Ge.YE(this._path).promise,this.pdfControls.querySelector("#page_count").textContent=this.pdfDoc.numPages,this.renderPage(this.pageNum)}catch(e){}}calculateScale(e){const t=e.getViewport({scale:1}).width;return(this.pdfContent.clientWidth-20)/t}async renderPage(e){this.pageRendering=!0;const t=await this.pdfDoc.getPage(e);this.userSetScale||(this.scale=this.calculateScale(t));const s=t.getViewport({scale:this.scale});this.canvas.height=s.height,this.canvas.width=s.width;const i={canvasContext:this.ctx,viewport:s};try{await t.render(i).promise,this.pageRendering=!1,null!==this.pageNumPending&&(this.renderPage(this.pageNumPending),this.pageNumPending=null)}catch(e){this.pageRendering=!1}this.pdfControls.querySelector("#page_num").textContent=e}queueRenderPage(e){this.pageRendering?this.pageNumPending=e:this.renderPage(e)}onPrevPage(){this.pageNum<=1||(this.pageNum--,this.queueRenderPage(this.pageNum))}onNextPage(){this.pageNum>=this.pdfDoc.numPages||(this.pageNum++,this.queueRenderPage(this.pageNum))}handleFocus(){}}customElements.define("pdf-document",Ke);let Ye=null;class Xe extends HTMLElement{constructor(){super(),this.modelDisplayContainer=null,this._src="",this._rightAlign=!1,this._fullWidth=!1,this._loading=!1,this.theme=i.A.theme,this.focusInstance=null,this.minimizedView=null,this._minimize=!1,this._mode="",this.originalInstance=null,this._bindMethods()}_bindMethods(){this.downloadModel=this.downloadModel.bind(this),this.handleFocus=this.handleFocus.bind(this),this.closeFocus=this.closeFocus.bind(this)}static get observedAttributes(){return["src","right-align","full-width","loading","chat-id","mode","minimize"]}attributeChangedCallback(e,t,s){if(t!==s||"src"===e||"loading"===e)switch(e){case"src":this._src=s,this._src&&(this._loading=!1,this.hasAttribute("loading")&&this.removeAttribute("loading")),this.isConnected&&this._render();break;case"right-align":this._rightAlign=this.hasAttribute("right-align"),"focus"!==this._mode&&this._updateContainerClasses();break;case"full-width":this._fullWidth=this.hasAttribute("full-width"),"focus"!==this._mode&&this._updateContainerClasses();break;case"loading":const e=this.hasAttribute("loading");this._loading!==e&&(this._loading=e,this._render());break;case"chat-id":this.chatId=s;break;case"mode":this._mode=s;break;case"minimize":this._minimize=this.hasAttribute("minimize")}}get src(){return this._src}set src(e){this._src!==e&&(this._src=e,this._src&&(this._loading=!1,this.hasAttribute("loading")&&this.removeAttribute("loading")),this.isConnected&&this._render())}async connectedCallback(){if(this.style.display="block",this._rightAlign=this.hasAttribute("right-align"),this._fullWidth=this.hasAttribute("full-width"),this._loading=this.hasAttribute("loading"),this._mode=this.getAttribute("mode")||"",this.chatId=this.getAttribute("chat-id"),this.hasAttribute("src")&&(this._src=this.getAttribute("src")),"focus"!==this._mode?this.classList.add("my-2"):this.classList.add("h-full","flex","flex-col"),"focus"===this._mode){const e=this._createFocusMenuOptions();this.focusWindowMenu=new D(e);const t=this.focusWindowMenu.create();this.appendChild(t)}this.modelDisplayContainer||this._createModelDisplayContainer(),await this._loadModelViewerLibrary(),this._render()}_loadModelViewerLibrary(){return Ye||(Ye=new Promise(((e,t)=>{if(window.customElements&&window.customElements.get("model-viewer"))return void e();const s=document.createElement("script");s.type="module",s.src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js",s.onload=()=>{const t=()=>{window.customElements.get("model-viewer")?e():setTimeout(t,50)};t()},s.onerror=()=>t(new Error("Failed to load model-viewer from CDN")),document.head.appendChild(s)}))),Ye}_createModelDisplayContainer(){const e=document.createElement("div");"focus"===this._mode&&(e.style.height="calc(var(--vh, 1vh) * 100 - 45px)",e.className="flex-grow relative bg-gray-200 dark:bg-gray-900 overflow-hidden"),this.appendChild(e),this.modelDisplayContainer=document.createElement("div"),e.appendChild(this.modelDisplayContainer)}_updateContainerClasses(){if(!this.modelDisplayContainer)return;if("focus"===this._mode)return void(this.modelDisplayContainer.className="w-full h-full");const e=this.modelDisplayContainer.parentElement;e.className="flex w-full",e.classList.add(this._rightAlign?"justify-end":"justify-start");let t=["relative","aspect-square","rounded-lg","overflow-hidden","min-h-[400px]"];t.push(this._fullWidth?"w-full":"w-full max-w-2xl"),this.modelDisplayContainer.className=t.join(" ")}_clearContent(){this.modelDisplayContainer&&(this.modelDisplayContainer.innerHTML="")}async _render(){this.modelDisplayContainer||this._createModelDisplayContainer(),this._updateContainerClasses();try{await this._loadModelViewerLibrary(),this._loading?this._renderLoading():this._src?this._renderModel():this._renderPlaceholder()}catch(e){this._renderError("Failed to load 3D viewer.")}}_renderPlaceholder(){this._clearContent(),this.modelDisplayContainer.innerHTML='<div class="w-full h-full flex flex-col items-center justify-center text-gray-500 dark:text-gray-400 p-4 text-center">\n            <p class="text-4xl mb-2"></p>\n            <p class="text-sm font-medium">3D Model Viewer</p>\n            <p class="text-xs opacity-75">Waiting for model...</p>\n        </div>'}_renderError(e){this._clearContent(),this.modelDisplayContainer.innerHTML=`<div class="w-full h-full flex flex-col items-center justify-center text-red-500 dark:text-red-400 p-4 text-center">\n            <p class="text-4xl mb-2"></p>\n            <p class="text-sm font-medium">${e}</p>\n        </div>`}_renderLoading(){this._clearContent();const e=document.createElement("div");e.className="w-full h-full flex items-center justify-center opacity-50 p-2";const t=document.createElement("div"),s=o.A.name("spinner"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-8 h-8",additionalClasses:`animate-spin ${this.theme.iconColor}`});t.appendChild(i.element),e.appendChild(t),this.modelDisplayContainer.appendChild(e)}_renderModel(){this._clearContent();const e=document.createElement("model-viewer");if(e.src=this._src,e.setAttribute("camera-controls",""),e.setAttribute("touch-action","pan-y"),e.setAttribute("auto-rotate",""),e.setAttribute("auto-rotate-delay","3000"),e.setAttribute("ar",""),e.setAttribute("ar-modes","webxr scene-viewer quick-look"),e.setAttribute("tone-mapping","neutral"),e.setAttribute("shadow-intensity","1"),e.setAttribute("camera-orbit","0deg 75deg 2.5m"),e.setAttribute("environment-image","neutral"),e.style.setProperty("--poster-color","#000000"),e.style.backgroundColor="#000000",e.style.width="100%",e.style.height="100%",e.style.display="block",e.style.setProperty("--progress-bar-color","#0065FF"),e.addEventListener("error",(e=>{this._renderError("Failed to load 3D model. Please check the file format and URL.")})),this.modelDisplayContainer.appendChild(e),"focus"!==this._mode){const e=document.createElement("div");e.className="absolute top-2 right-2 z-10 hidden";const t=document.createElement("div");t.className="flex gap-0.5",e.appendChild(t);const s=new n.$({text:"",type:"focus",size:"icon",svgPathData:o.A.name("cloudDownload").path,svgViewBox:o.A.name("cloudDownload").viewBox,width:"full",iconHeightAndWidth:"w-6 h-6"});s.onClick(this.downloadModel),s.render(t);const i=new n.$({text:"",type:"focus",size:"icon",svgPathData:o.A.name("focus").path,svgViewBox:o.A.name("focus").viewBox,width:"full",iconHeightAndWidth:"w-6 h-6"});i.onClick(this.handleFocus),i.render(t),this.modelDisplayContainer.appendChild(e),u.K.isOnTouchDevice?e.classList.remove("hidden"):(this.modelDisplayContainer.addEventListener("mouseenter",(()=>e.classList.remove("hidden"))),this.modelDisplayContainer.addEventListener("mouseleave",(()=>e.classList.add("hidden"))))}}async downloadModel(){if(this._src)try{const e=await fetch(this._src);if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.blob();let s=this._src.split("/").pop().split("?")[0]||"model.glb";/\.(glb|gltf)$/i.test(s)||(s=`${s}.glb`);const i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download=s,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout((()=>URL.revokeObjectURL(i)),100)}catch(e){alert(`Download failed: ${e.message}. Please try again.`)}}_createFocusMenuOptions(){return{title:this._src.split("/").pop().split("?")[0]||"3D Model",mode:"focus",fileMenu:[{type:"item",label:"Download",onClick:this.downloadModel}],quickActions:[{type:"icon",icon:"cloudDownload",hoverText:"Download",onClick:this.downloadModel}],onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus()}}}handleFocus(){this.focusInstance||(this.focusInstance=new G(this.chatId,this,{src:this._src}),this.minimizeInChat())}focus(e){const t=document.createElement("output-3d-model");return t.setAttribute("src",e.src),t.setAttribute("mode","focus"),t.setAttribute("chat-id",this.chatId),t.originalInstance=this,t}closeFocus(){this.focusInstance&&(this.focusInstance.close(),this.focusInstance=null),this.maximizeInChat()}maximizeInChat(){this.setAttribute("minimize","false"),this._minimize=!1,this.minimizedView&&(this.minimizedView.style.display="none");const e=this.querySelector("div:not(.minimized-view-wrapper)");e&&(e.style.display="flex")}minimizeInChat(){if(this._minimize)return;this.setAttribute("minimize","true"),this._minimize=!0;const e=this.querySelector("div:not(.minimized-view-wrapper)");e&&(e.style.display="none"),this.minimizedView?this.minimizedView.style.display="block":(this.minimizedView=this.createMinimizedView(),this.appendChild(this.minimizedView))}createMinimizedView(){const e=this._src.split("/").pop().split("?")[0]||"model.glb",t={name:e,type:"code",extension:e.split(".").pop()||"glb"},s=document.createElement("div");s.className="pb-4 cursor-pointer z-30 minimized-view-wrapper";const i=new Y([t],null).createFileItem(t,t.extension);return s.appendChild(i),i.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()})),s}}window.customElements&&!window.customElements.get("output-3d-model")&&window.customElements.define("output-3d-model",Xe);class Je extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._rawContent="",this._isStreaming=!1,this._messageId="",this._runId="",this._contentDiv=null,this._elementCounter=0,this._messageToolCalls=null,this._frozenPrefix=null,this._onSelectionChangeBound=this._onSelectionChange.bind(this)}_isIdFrozenAny(e){const t=this.getAttribute("data-hover-freeze");return this._isFrozenId(e)||!!t&&e&&(e===t||e.startsWith(t+"-"))}_syncFreezeFromSelection(){const e=document.getSelection();if(!e||e.isCollapsed||0===e.rangeCount)return;const t=this._contentDiv||this;if(!t.contains(e.anchorNode)&&!t.contains(e.focusNode))return;let s=e.anchorNode;s&&1!==s.nodeType&&(s=s.parentNode);const i=s?s.closest("[block-id]"):null,n=i?i.getAttribute("block-id"):null;n&&this._frozenPrefix!==n&&(this._frozenPrefix=n,this.setAttribute("data-selection-freeze",n))}_expandSourceTagsInline(e){if(!Array.isArray(e)||0===e.length)return e;const t=[],s=/\[so-(\d+)\]/gi;for(const i of e){if(!i||"text"!==i.type){t.push(i);continue}const e=i.text??i.raw??"";if(!e||-1===e.indexOf("[so-")){t.push(i);continue}let n,a=0,o=!1;for(;null!==(n=s.exec(e));){o=!0;const s=e.slice(a,n.index);s&&t.push({type:"text",raw:s,text:s}),t.push({type:"sourceTag",raw:n[0]}),a=n.index+n[0].length}const r=e.slice(a);o?r&&t.push({type:"text",raw:r,text:r}):t.push(i)}return t}_isFrozenId(e){const t=this._frozenPrefix;return!(!t||!e||e!==t&&!e.startsWith(t+"-"))}_onSelectionChange(){const e=document.getSelection();if(!(e&&e.rangeCount>0&&!e.isCollapsed)){const e=this._frozenPrefix;return this._frozenPrefix=null,void(e&&(this.removeAttribute("data-selection-freeze"),this.render()))}const t=this._contentDiv||this;if(!t.contains(e.anchorNode)&&!t.contains(e.focusNode))return;let s=e.anchorNode;s&&1!==s.nodeType&&(s=s.parentNode);const i=s?s.closest("[block-id]"):null,n=i?i.getAttribute("block-id"):null;n&&this._frozenPrefix!==n&&(this._frozenPrefix=n,this.setAttribute("data-selection-freeze",n))}connectedCallback(){this._contentDiv||(this._contentDiv=document.createElement("div"),this._contentDiv.id="content",this._contentDiv.classList.add("markdown-style"),this.appendChild(this._contentDiv)),document.addEventListener("selectionchange",this._onSelectionChangeBound),this.render()}disconnectedCallback(){document.removeEventListener("selectionchange",this._onSelectionChangeBound)}get isStreaming(){return this._isStreaming}set toolCalls(e){this._messageToolCalls=e}static get observedAttributes(){return["content","streaming","message-id","chat-id","run-id"]}attributeChangedCallback(e,t,s){if("content"===e&&t!==s)this._rawContent=s,this.render();else if("streaming"===e)this._isStreaming="true"===s,this.handleStreamingAttributes();else if("message-id"===e)this._messageId=s;else if("run-id"===e)this._runId=s;else if("chat-id"===e){this._chatId=s;const e=this.querySelector("code-block");e&&e.setAttribute("chat-id",s)}}set content(e){this.setAttribute("content",e)}set streaming(e){this.setAttribute("streaming",e.toString())}set messageId(e){this.setAttribute("message-id",e)}render(){if(this._contentDiv){this._syncFreezeFromSelection();const e=this._isStreaming?`${(this._rawContent||"").replace(/\s*$/,"")}\n\n`:this._rawContent||"";let t=B.xI.lexer(e);t=this._coalesceDescriptionLists(t),this.renderTokens(t)}}renderTokens(e){if(!this._contentDiv)return;const t=Array.from(this._contentDiv.children);let s=null;const i=e=>this._isIdFrozenAny(e);e.forEach(((e,n)=>{const a="mcp-tool-usage"===e.type?e.toolId:`${this._messageId}-element-${n}`;if(i(a)){const e=this._contentDiv.querySelector(`:scope > [block-id="${a}"]`);if(e){s=e;const i=t.indexOf(e);i>-1&&t.splice(i,1)}return}let o=this._contentDiv.querySelector(`:scope > [block-id="${a}"]`);if(o){this.updateElementContent(o,e),s=o;const i=t.indexOf(o);i>-1&&t.splice(i,1)}else if(o=this.createElementForToken(e,a),o){s&&s.nextSibling?this._contentDiv.insertBefore(o,s.nextSibling):this._contentDiv.appendChild(o),s=o;const e=t.indexOf(o);e>-1&&t.splice(e,1)}})),t.forEach((e=>{const t=e.getAttribute("block-id");i(t)||e.remove()}))}applyStreamingStyles(e){if(!e)return;const t=e.tagName?.toLowerCase?.()||"";["ul","ol","li"].includes(t)?this._isStreaming?e.setAttribute("data-streaming","true"):e.removeAttribute("data-streaming"):this._isStreaming?(e.setAttribute("data-streaming","true"),e.classList.add("fade-in-line")):(e.removeAttribute("data-streaming"),e.classList.remove("fade-in-line"))}createElementForToken(e,t){let s;const i=e=>{e.setAttribute("block-id",t),this.applyStreamingStyles(e)};switch(e.type){case"heading":s=document.createElement(`h${e.depth}`),i(s),this.renderInlineContent(e.tokens||[e],s);break;case"paragraph":s=document.createElement("p"),i(s),this.renderInlineContent(e.tokens||[e],s);break;case"text":s=document.createElement("span"),i(s),this.renderInlineContent(e.tokens||[e],s);break;case"space":case"sourceTag":default:break;case"list":s=document.createElement(e.ordered?"ol":"ul");const n=e.start||1,a=e.start+e.items.length-1;s.setAttribute("start",n),s.setAttribute("data-last-number",a),e.items.forEach(((e,i)=>{const n=`${t}-${i}`,a=this.createListItem(e,n);s.appendChild(a)}));break;case"descriptionList":s=document.createElement("dl"),i(s),this.updateDescriptionListContent(s,e);break;case"code":s=document.createElement("code-block"),s.setAttribute("message-id",this._messageId),s.setAttribute("chat-id",this._chatId),s.setAttribute("language",e.lang||""),s.setAttribute("readonly","true"),s.code=e.text,s.setAttribute("block-id",t);break;case"outputDocument":s=document.createElement("output-document");for(const[t,i]of Object.entries(e.attributes))s.setAttribute(t,i);s.setAttribute("chat-id",this._chatId);break;case"mcp-tool-usage":window._messageToolCalls&&window._messageToolCalls[e.toolId]?s=window._messageToolCalls[e.toolId]:(s=document.createElement("mcp-tool-usage"),s.style.display="none",s.setAttribute("mcp-id",e.toolId),s.setAttribute("uuid",e.toolId),s.setAttribute("block-id",t),window._messageToolCalls||(window._messageToolCalls={}),window._messageToolCalls[e.toolId]=s);break;case"versionTile":s=document.createElement("version-tile");for(const[t,i]of Object.entries(e.attributes))s.setAttribute(t,i);break;case"audioPlayer":if(window._transcripts&&window._transcripts[e.callId]){const t=window._transcripts[e.callId];s=document.createElement("audio-player"),s.setAttribute("audio-name",e.audioName),s.setAttribute("transcript",t.transcript),s.setAttribute("transcript-summary",t.summary||""),s.setAttribute("audio-url",t.recording_url||""),s.setAttribute("chat-id",this._chatId)}else s=document.createElement("audio-player"),s.setAttribute("audio-name",e.audioName),s.setAttribute("audio-url",e.audioURL),s.setAttribute("chat-id",this._chatId);break;case"videoPlayer":if(s=document.createElement("output-video"),e.attributes)for(const[t,i]of Object.entries(e.attributes))s.setAttribute(t,i);s.setAttribute("chat-id",this._chatId);break;case"fileOutput":s=document.createElement("file-output"),s.setAttribute("file-name",e.fileName),s.setAttribute("file-url",e.fileUrl),s.setAttribute("file-extension",e.fileExtension);break;case"allSources":if(!this._runId)break;if(!window._msgSources||!window._msgSources[this._runId])break;s=document.createElement("source-tag");try{window._msgSources||(window._msgSources={});const e=window._msgSources[this._runId]||[];let t=[];for(let s=0;s<e.length;s++)t.push({source_title:e[s].source.source_title,source_page_title:e[s].source.source_page_title,source_excerpt:e[s].source.source_excerpt||"",source_img:e[s].source.source_image||"",source_URL:e[s].source.source_URL});s.setAttribute("sources",JSON.stringify(t))}catch(e){}break;case"outputMap":s=document.createElement("output-map"),s.setAttribute("map-data",e.mapData);break;case"outputProteinStructure":s=document.createElement("output-protein-structure");for(const[t,i]of Object.entries(e.attributes))s.setAttribute(t,i);s.setAttribute("chat-id",this._chatId);break;case"groupedImage":s=document.createElement("output-image"),s.setAttribute("images",JSON.stringify(e.images)),e.fullWidth&&s.setAttribute("full-width","true"),s.setAttribute("chat-id",this._chatId);break;case"outputImage":s=document.createElement("output-image"),s.setAttribute("images",e.images),e.rightAlign&&s.setAttribute("right-align",e.rightAlign),e.fullWidth&&s.setAttribute("full-width",e.fullWidth),e.loadingCount&&s.setAttribute("loading-count",e.loadingCount);break;case"video":const o=new K(e.chat);o.init([{url:e.href,filename:e.text||"video.mp4"}]),s=o.container,s.dataset.component="output-video";break;case"3dmodel":s=document.createElement("output-3d-model"),s.setAttribute("src",e.href),s.setAttribute("chat-id",e.chat?.id);break;case"workspace-computer":s=document.createElement("workspace-computer"),s.setAttribute("message-id",this._messageId),s.setAttribute("block-id",t),s.setAttribute("chatid",e.chatid),s.setAttribute("uuid",e.uuid),s.setAttribute("readonly","true"),s.innerHTML=e.content||"";break;case"latex-inline":s=document.createElement("span"),s.className="latex-inline",s.innerHTML=this.renderLatex(e.formula,!0);break;case"latex-block":s=document.createElement("div"),s.className="latex-block",s.innerHTML=this.renderLatex(e.formula);break;case"blockquote":s=document.createElement("blockquote"),e.tokens?e.tokens.forEach(((e,i)=>{const n=`${t}-${i}`,a=this.createElementForToken(e,n);a&&s.appendChild(a)})):this.renderInlineContent([e],s);break;case"hr":s=document.createElement("hr");break;case"table":s=this.createTableElement(e);break;case"html":s=document.createElement("code-block"),s.setAttribute("chat-id",this._chatId),s.setAttribute("language","html"),s.code=e.text,s.setAttribute("block-id",t),s.setAttribute("message-id",this._messageId)}return s&&(i(s),s.setAttribute("block-id",t),this.applyStreamingStyles(s)),s}extractIconUrlFromToolName(e){return"https://res.cloudinary.com/dimqqmfx6/image/upload/v1743586718/MCP%20assets/Stripe_1_naek9v.png"}_isCorrectElementType(e,t){const s=e.tagName.toLowerCase();switch(t.type){case"paragraph":return"p"===s;case"heading":return s.startsWith("h");case"text":return"span"===s;case"versionTile":return"version-tile"===s;case"space":return"div"===s&&e.classList.contains("spacer");case"list":return"ol"===s||"ul"===s;case"code":return"code-block"===s;case"groupedImage":return"output-image"===s;case"hr":return"hr"===s;case"table":return"div"===s&&e.classList.contains("table-wrapper-fix");case"audioPlayer":return"audio-player"===s;case"videoPlayer":return"output-video"===s;case"strong":return"strong"===s;case"em":return"em"===s;case"del":return"del"===s;case"link":return"a"===s;case"image":return"img"===s;case"latex-inline":return"span"===s&&e.classList.contains("latex-inline");case"latex-block":return"div"===s&&e.classList.contains("latex-block");case"codespan":return"code-tag"===s;case"descriptionList":return"dl"===s;default:return!0}}updateElementContent(e,t){if(!this._isCorrectElementType(e,t)){const s=e.getAttribute("block-id"),i=(parseInt(s.split("-element-")[1],10),this.createElementForToken(t,s));return void(i&&e.parentNode&&e.parentNode.replaceChild(i,e))}const s=e.getAttribute("block-id");switch(t.type){case"paragraph":case"heading":case"text":case"html":this.renderInlineContent(t.tokens||[t],e);break;case"descriptionList":if("dl"!==e.tagName.toLowerCase()){const i=this.createElementForToken(t,s);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}else this.updateDescriptionListContent(e,t);break;case"audioPlayer":if(window._transcripts&&window._transcripts[t.callId]){const s=window._transcripts[t.callId];e.setAttribute("audio-name",t.audioName),e.setAttribute("transcript",s.transcript),e.setAttribute("transcript-summary",s.summary||""),e.setAttribute("audio-url",s.recording_url||""),e.setAttribute("chat-id",this._chatId),e.removeAttribute("data-pending-transcript")}else e.setAttribute("audio-name",t.audioName),e.setAttribute("chat-id",this._chatId);break;case"videoPlayer":if(t.attributes)for(const[s,i]of Object.entries(t.attributes))e.getAttribute(s)!==i&&e.setAttribute(s,i);e.getAttribute("chat-id")!==this._chatId&&e.setAttribute("chat-id",this._chatId);break;case"space":case"mcp-tool-usage":case"sourceTag":case"allSources":case"outputImage":default:break;case"list":const i=t.ordered?"ol":"ul";if(e.tagName.toLowerCase()!==i){const i=this.createElementForToken(t,s);e.parentNode.replaceChild(i,e)}else{const s=t.start||1,i=t.start+t.items.length-1;e.setAttribute("start",s),e.setAttribute("data-last-number",i),this.updateListContent(e,t)}break;case"versionTile":if("version-tile"===e.tagName.toLowerCase())for(const[s,i]of Object.entries(t.attributes))e.getAttribute(s)!==i&&e.setAttribute(s,i);else{const i=this.createElementForToken(t,s);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}break;case"outputDocument":if("output-document"===e.tagName.toLowerCase())for(const[s,i]of Object.entries(t.attributes))e.getAttribute(s)!==i&&e.setAttribute(s,i);else{const i=this.createElementForToken(t,s);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}break;case"code":"code-block"===e.tagName.toLowerCase()&&(e.code=t.text,e.scrollToBottom());break;case"codespan":const n="html"===t.type?t.text:t.raw.replace(/^`+|`+$/g,""),a=btoa(encodeURIComponent(n));e.setAttribute("code",a);break;case"latex-inline":(e=document.createElement("span")).className="latex-inline py-4",e.innerHTML=this.renderLatex(t.formula,!0);break;case"latex-block":if("div"===e.tagName.toLowerCase()&&e.classList.contains("latex-block")){const s=this.renderLatex(t.formula);e.innerHTML!==s&&(e.innerHTML=s)}else{const i=document.createElement("div");i.className="latex-block",i.setAttribute("block-id",s),this._isStreaming&&i.setAttribute("data-streaming","true"),i.innerHTML=this.renderLatex(t.formula),e.parentNode&&e.parentNode.replaceChild(i,e)}break;case"blockquote":if("blockquote"!==e.tagName.toLowerCase()){const i=this.createElementForToken(t,s);e.parentNode.replaceChild(i,e)}else if(t.tokens){const i=Array.from(e.children);t.tokens.forEach(((t,n)=>{const a=`${s}-${n}`;let o=e.querySelector(`[block-id="${a}"]`);if(o){this.updateElementContent(o,t);const e=i.indexOf(o);e>-1&&i.splice(e,1)}else o=this.createElementForToken(t,a),o&&e.appendChild(o)})),i.forEach((e=>e.remove()))}else this.renderInlineContent([t],e);break;case"hr":if("hr"!==e.tagName.toLowerCase()){const t=document.createElement("hr");t.setAttribute("block-id",s),e.parentNode.replaceChild(t,e)}break;case"table":if("table"!==e.tagName.toLowerCase()){const i=this.createTableElement(t);i.setAttribute("block-id",s),e.parentNode.replaceChild(i,e)}else this.updateTableContent(e,t);break;case"groupedImage":if("output-image"===e.tagName.toLowerCase()){const s=JSON.stringify(t.images);e.getAttribute("images")!==s&&e.setAttribute("images",s)}break;case"video":if(e.dataset.url===t.href)break;e.dataset.url&&(e.dataset.url,t.href);const o=new K(t.chat);o.init([{url:t.href,filename:t.text||"video.mp4"}]);const r=o.container;r.dataset.component="output-video",r.setAttribute("block-id",s),r.dataset.url=t.href,e.parentNode.replaceChild(r,e);break;case"3dmodel":if("output-3d-model"===e.tagName.toLowerCase())e.getAttribute("src")!==t.href&&e.setAttribute("src",t.href);else{const i=this.createElementForToken(t,s);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}break;case"fileOutput":if("file-output"===e.tagName.toLowerCase())e.setAttribute("file-name",t.fileName),e.setAttribute("file-url",t.fileUrl),e.setAttribute("file-extension",t.fileExtension);else{const i=document.createElement("file-output");i.setAttribute("file-name",t.fileName),i.setAttribute("file-url",t.fileUrl),i.setAttribute("file-extension",t.fileExtension),i.setAttribute("block-id",s),e.parentNode&&e.parentNode.replaceChild(i,e)}break;case"outputProteinStructure":if("output-protein-structure"===e.tagName.toLowerCase())for(const[s,i]of Object.entries(t.attributes))e.getAttribute(s)!==i&&e.setAttribute(s,i)}this.applyStreamingStyles(e)}renderInlineContent(e,t,s=!1){if(!t)return;const i=t.getAttribute("block-id");if(this._isIdFrozenAny(i))return;const n=Array.from(t.childNodes),a=this._expandSourceTagsInline(e);a.forEach(((e,a)=>{const o=i?`${i}-inline-${a}`:`inline-${a}`;if(this._isIdFrozenAny(o))return;let r=n.find((e=>e.nodeType===Node.ELEMENT_NODE&&e.getAttribute("block-id")===o));r?this.updateInlineElement(r,e):(r=this.createInlineElement(e,o,s),r&&t.appendChild(r))})),Array.from(t.children).forEach((e=>{if(e.nodeType!==Node.ELEMENT_NODE)return;const s=e.getAttribute("block-id");a.some(((e,t)=>s===(i?`${i}-inline-${t}`:`inline-${t}`)))||this._isIdFrozenAny(s)||t.removeChild(e)}))}createInlineElement(e,t,s=!1){let i;switch(e.type){case"html":if(s){i=document.createElement("span"),i.innerHTML=e.text;break}{const t=btoa(encodeURIComponent(e.text));i=document.createElement("code-tag"),i.setAttribute("code",t);break}case"codespan":const n=e.raw.replace(/^`+|`+$/g,""),a=btoa(encodeURIComponent(n));i=document.createElement("code-tag"),i.setAttribute("code",a);break;case"latex-inline":i=document.createElement("span"),i.className="latex-inline py-4",i.innerHTML=this.renderLatex(e.formula,!0);break;case"latex-block":i=document.createElement("div"),i.className="latex-block",i.innerHTML=this.renderLatex(e.formula);break;case"link":i=document.createElement("a"),i.href=e.href,i.target="_blank",i.rel="noopener noreferrer",i.textContent=e.text;break;case"image":i=document.createElement("img"),i.src=e.href,i.alt=e.text;break;case"strong":i=document.createElement("strong"),i.setAttribute("block-id",t),this.renderInlineContent(e.tokens,i);break;case"em":i=document.createElement("em"),i.setAttribute("block-id",t),this.renderInlineContent(e.tokens,i);break;case"del":i=document.createElement("del"),i.setAttribute("block-id",t),this.renderInlineContent(e.tokens,i);break;case"br":i=document.createElement("span"),i.classList.add("h-2","block");break;case"text":if(!e.raw)return;i=document.createElement("span"),i.setAttribute("block-id",t),i.textContent=e.text??e.raw??"";break;case"sourceTag":const o=/\[so-([0-9]+)\]/gi,r=[...e.raw.matchAll(o)],l=window._msgSources[this._runId]||[];if(0===r.length){i=document.createElement("span"),i.innerHTML="";break}i=document.createElement("span"),r.forEach((e=>{const t=parseInt(e[1]);let s=l.find((e=>e.source_number===t))?.source;if(!s&&window._msgSources){const e=window._msgSourcesOrder?[...window._msgSourcesOrder].reverse():[];for(const i of e){if(i===this._runId)continue;const e=window._msgSources[i].find((e=>e.source_number===t))?.source;if(e){s=e;break}}}if(s){const e=document.createElement("source-tag"),t=[{source_title:s.source_title,source_page_title:s.source_page_title,source_excerpt:s.source_excerpt||"",source_icon:s.source_icon||"",source_img:s.source_img||"",source_URL:s.source_URL}];e.setAttribute("sources",JSON.stringify(t)),i.appendChild(e)}else{const t=document.createElement("span");t.textContent=e[0],i.appendChild(t)}}));break;case"allSources":case"outputMap":case"audioPlayer":case"videoPlayer":break;case"video":const c=new K(e.chat);c.init([{url:e.href,filename:e.text||"video.mp4"}]),i=c.container,i.dataset.component="output-video";break;case"outputImage":i=document.createElement("output-image"),i.setAttribute("images",e.images),i.setAttribute("right-align",e.rightAlign||"false"),i.setAttribute("full-width",e.fullWidth||"false"),i.setAttribute("loading-count",e.loadingCount||0);break;default:if(!e.raw)return;i=document.createElement("span"),i.textContent=e.text??e.raw??"",this.applyStreamingStyles(i)}return i&&(i.setAttribute("block-id",t),this.applyStreamingStyles(i)),i}updateInlineElement(e,t){const s=e.getAttribute("block-id");if(this._isCorrectElementType(e,t)){switch(t.type){case"html":case"codespan":if("code-tag"!==e.tagName.toLowerCase()){const s=t.raw.replace(/^`+|`+$/g,""),i=btoa(encodeURIComponent(s)),n=document.createElement("code-tag");n.setAttribute("code",i),e.parentNode.replaceChild(n,e),e=n}else{const s="html"===t.type?t.text:t.raw.replace(/^`+|`+$/g,""),i=btoa(encodeURIComponent(s));e.setAttribute("code",i)}break;case"latex-block":e.innerHTML=this.renderLatex(t.formula);break;case"sourceTag":const s=this.createInlineElement(t,e.getAttribute("block-id"));s&&e.parentNode&&e.parentNode.replaceChild(s,e);break;case"latex-inline":e.innerHTML=this.renderLatex(t.formula,!0);break;case"link":e.href=t.href,e.target="_blank",e.rel="noopener noreferrer",e.textContent=t.text;break;case"image":e.src=t.href,e.alt=t.text;break;case"strong":case"em":case"del":{const s=e.getAttribute("block-id");this._isIdFrozenAny(s)||e.replaceChildren(),this.renderInlineContent(t.tokens,e)}break;default:e.textContent=t.text??t.raw??""}this.applyStreamingStyles(e)}else{const i=this.createInlineElement(t,s);i&&e.parentNode&&e.parentNode.replaceChild(i,e)}}renderLatex(e,t=!1){try{return e=e.replace(/\\begin\{eqnarray\*?\}/g,"\\begin{aligned}").replace(/\\end\{eqnarray\*?\}/g,"\\end{aligned}"),_.default.renderToString(e,{displayMode:!t,throwOnError:!1,trust:!0,strict:!1,output:"html"})}catch(t){return`<code>${this.escapeHtml(e)}</code>`}}escapeHtml(e){return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")}_coalesceDescriptionLists(e){const t=[];let s=0;const i=e=>e&&"paragraph"===e.type,n=e=>{return t=(e?.text??e?.raw??"").trimStart(),/^\s*:/.test(t||"");var t},a=e=>/:\s*$/.test(e||""),o=e=>{if(Array.isArray(e.tokens)&&e.tokens.length){const t=e.tokens.map((e=>e.text??e.raw??"")).join("");return a(t)}return a(e.text||e.raw||"")},r=e=>{const t=e.tokens?JSON.parse(JSON.stringify(e.tokens)):[{type:"text",raw:e.text||e.raw||"",text:e.text||e.raw||""}];if(t.length){const e=t[t.length-1];if("text"===e.type){const t=(e.text??e.raw??"").replace(/:\s*$/,"");e.text=t,e.raw=t}}return t};for(;s<e.length;){const a=e[s],l=e[s+1];if(i(a)){const e=this._paragraphToDescriptionItems(a);if(e){t.push({type:"descriptionList",items:e}),s+=1;continue}}if(i(a)&&i(l)&&!n(a)&&n(l)){const o=[],r=[];let l=s+1;for(;i(e[l])&&n(e[l]);)r.push(this._stripColonParagraphToTokens(e[l])),l++;const c=Array.isArray(a.tokens)&&a.tokens.length?a.tokens:[{type:"text",raw:a.text||a.raw||"",text:a.text||a.raw||""}];o.push({termTokens:c,defs:r}),t.push({type:"descriptionList",items:o}),s=l}else if(i(a)&&i(l)&&o(a)&&!n(l)){const e=r(a),i=[Array.isArray(l.tokens)&&l.tokens.length?l.tokens:[{type:"text",raw:l.text||l.raw||"",text:l.text||l.raw||""}]];t.push({type:"descriptionList",items:[{termTokens:e,defs:i}]}),s+=2}else t.push(a),s++}return t}_paragraphToDescriptionItems(e){const t=Array.isArray(e.tokens)?e.tokens:[];if(!t.length)return null;const s=[];let i=[];for(const e of t)"br"===e.type?(s.push(i),i=[]):i.push(e);if(i.length&&s.push(i),s.length<2)return null;const n=[];for(let e=1;e<s.length;e++){const t=s[e];if(!t.length)return null;const i=t[0],a=(i.text??i.raw??"").trimStart();if(!a.startsWith(":"))return null;const o=a.replace(/^:\s?/,"");"text"===i.type?(i.text=o,i.raw=o):t.unshift({type:"text",raw:o,text:o}),n.push(t)}return[{termTokens:s[0],defs:n}]}_stripColonParagraphToTokens(e){const t=e.tokens?JSON.parse(JSON.stringify(e.tokens)):[{type:"text",raw:e.text||e.raw||"",text:e.text||e.raw||""}];if(t.length){const s=t[0];if("text"===s.type){const e=(s.text??s.raw??"").replace(/^:\s?/,"");s.text=e,s.raw=e}else{const s=(e.text||e.raw||"").replace(/^:\s?/,"");t.unshift({type:"text",raw:s,text:s})}}return t}updateDescriptionListContent(e,t){if(this._isIdFrozenAny(e.getAttribute("block-id")))return;const s=e.getAttribute("block-id"),i=document.createDocumentFragment();t.items.forEach(((e,t)=>{const n=document.createElement("dt");n.setAttribute("block-id",`${s}-dt-${t}`),this.applyStreamingStyles(n),this.renderInlineContent(e.termTokens||[],n),i.appendChild(n),(e.defs||[]).forEach(((e,n)=>{const a=document.createElement("dd");a.setAttribute("block-id",`${s}-dd-${t}-${n}`),this.applyStreamingStyles(a),this.renderInlineContent(e,a),i.appendChild(a)}))})),e.replaceChildren(i)}createListItem(e,t){const s=document.createElement("li");s.setAttribute("block-id",t);const i=document.createElement("span"),n=`${t}-content`;return i.setAttribute("block-id",n),s.appendChild(i),this.updateListItemContent(i,e),s}updateListItemContent(e,t){const s=e.getAttribute("block-id");if(this._isIdFrozenAny(s))return;const i=t.text||t.raw||"";let n=Array.isArray(t.tokens)&&t.tokens.length?t.tokens:null;const a=!n||n.every((e=>"text"===e.type));if(a)try{if(B.xI.Lexer&&"function"==typeof B.xI.Lexer.lexInline)n=B.xI.Lexer.lexInline(i);else{const e=B.xI.lexer(i),t=e.find((e=>Array.isArray(e.tokens)&&e.tokens.length))||e[0];n=t&&t.tokens&&t.tokens.length?t.tokens:[{type:"text",raw:i,text:i}]}}catch(e){n=[{type:"text",raw:i,text:i}]}if(a)try{if(B.xI.Lexer&&"function"==typeof B.xI.Lexer.lexInline)n=B.xI.Lexer.lexInline(i);else{const e=B.xI.lexer(i),t=e.find((e=>Array.isArray(e.tokens)&&e.tokens.length))||e[0];n=t&&t.tokens&&t.tokens.length?t.tokens:[{type:"text",raw:i,text:i}]}}catch(e){n=[{type:"text",raw:i,text:i}]}n=this._expandSourceTagsInline(n);const o=new Set(["text","strong","em","del","codespan","link","image","br","html","latex-inline","latex-block","sourceTag","escape"]);if(n.every((e=>o.has(e.type))))return void this.renderInlineContent(n,e);const r=Array.from(e.children),l=new Set;n.forEach(((t,i)=>{const n=`${s}-sub-${i}`;let a=e.querySelector(`:scope > [block-id="${n}"]`);if(a)this.updateElementContent(a,t),l.add(a);else if(a=this.createElementForToken(t,n),a){const t=e.querySelector(`:scope > [block-id="${s}-sub-${i+1}"]`);t?e.insertBefore(a,t):e.appendChild(a),l.add(a)}})),r.forEach((t=>{if(!l.has(t)){const s=t.getAttribute("block-id");this._isIdFrozenAny(s)||e.removeChild(t)}}))}updateListContent(e,t){if(this._isIdFrozenAny(e.getAttribute("block-id")))return;const s=Array.from(e.children),i=[],n=e.getAttribute("block-id");t.items.forEach(((t,s)=>{const a=`${n}-${s}`;let o=e.querySelector(`:scope > [block-id="${a}"]`);if(o)this.updateListItem(o,t,a);else{o=this.createListItem(t,a);const i=e.querySelector(`:scope > [block-id="${n}-${s+1}"]`);i?e.insertBefore(o,i):e.appendChild(o)}i.push(o)})),s.forEach((t=>{if(i.includes(t))return;const s=t.getAttribute("block-id");if(this._isIdFrozenAny(s))return;let n=!1;const a=t.querySelectorAll("[block-id]");for(const e of a){const t=e.getAttribute("block-id");if(this._isIdFrozenAny(t)){n=!0;break}}n||e.removeChild(t)}))}updateListItem(e,t,s){if(this._isIdFrozenAny(s))return;let i=e.querySelector(`:scope > [block-id="${s}-content"]`);if(i||(i=document.createElement("span"),i.setAttribute("block-id",`${s}-content`),e.appendChild(i)),t.task){let s=e.querySelector('input[type="checkbox"]');s||(s=document.createElement("input"),s.type="checkbox",s.disabled=!0,e.insertBefore(s,i)),s.checked=t.checked}this.updateListItemContent(i,t)}createTableElement(e){const t=document.createElement("div");t.className=`table-wrapper-fix overflow-x-auto flex-grow mb-4 mt-1 text-sm rounded-md ${this.theme.tableCardBackground} ${this.theme.tableCardBorder} border`;const s=document.createElement("table");s.className="w-full rounded-md p-2 text-left";const i=document.createElement("thead");i.className=`${this.theme.tableHeaderText}`;const n=document.createElement("tbody"),a=document.createElement("tr");return e.header.forEach(((t,s)=>{const i=document.createElement("th");i.className=`px-3 py-1.5 font-semibold ${this.theme.tableBorder} border-b`,i.style.textAlign=t.align||e.align[s]||"left",this.renderInlineContent(t.tokens||[{type:"text",text:t.text,raw:t.raw}],i,!0),a.appendChild(i)})),i.appendChild(a),e.rows.forEach(((t,s)=>{const i=document.createElement("tr");i.className=`${this.theme.tableHoverBackground}`,t.forEach(((t,n)=>{const a=document.createElement("td");a.className=`leading-5 px-3 py-2 ${this.theme.tableBorder} ${s===e.rows.length-1?"":"border-b"}`,a.style.textAlign=t.align||e.align[n]||"left",0===n&&(a.className+=` ${this.theme.tablePrimaryColumnText}`),this.renderInlineContent(t.tokens||[{type:"text",text:t.text,raw:t.raw}],a,!0),i.appendChild(a)})),n.appendChild(i)})),s.appendChild(i),s.appendChild(n),t.appendChild(s),this.setTableColumnWidths(s),t}updateTableContent(e,t){const s=e.querySelector("table");if(!s)return;s.innerHTML="",s.className="w-full rounded-md p-2 text-left table-wrapper-fix";const i=document.createElement("thead");i.className=`${this.theme.tableHeaderText}`;const n=document.createElement("tr");t.header.forEach(((e,s)=>{const i=document.createElement("th");i.className=`px-3 py-1.5 font-semibold ${this.theme.tableBorder} border-b`,i.style.textAlign=e.align||t.align[s]||"left",this.renderInlineContent([{type:"text",text:e.text,raw:e.raw}],i),n.appendChild(i)})),i.appendChild(n),s.appendChild(i);const a=document.createElement("tbody");t.rows.forEach(((e,s)=>{const i=document.createElement("tr");i.className=`${this.theme.tableHoverBackground}`,e.forEach(((e,n)=>{const a=document.createElement("td");a.className=`px-3 py-2 ${this.theme.tableBorder} ${s===t.rows.length-1?"":"border-b"}`,a.style.textAlign=e.align||t.align[n]||"left",0===n&&(a.className+=` ${this.theme.tablePrimaryColumnText}`),this.renderInlineContent([{type:"text",text:e.text,raw:e.raw}],a),i.appendChild(a)})),a.appendChild(i)})),s.appendChild(a),e.className=`overflow-x-auto flex-grow mb-1 text-sm rounded-md ${this.theme.tableCardBackground} ${this.theme.tableCardBorder} border`,this.setTableColumnWidths(s)}setTableColumnWidths(e){const t=e.querySelectorAll("th"),s=e.querySelectorAll("tbody tr"),i=t.length,n=new Array(i).fill(0),a=new Array(i).fill(0);s.forEach((e=>{e.querySelectorAll("td").forEach(((e,t)=>{const s=e.textContent.length;s>n[t]&&(n[t]=s)}))})),t.forEach(((e,t)=>{a[t]=e.textContent.length})),t.forEach(((e,t)=>{const s=Math.max(n[t],a[t]),i=Math.min(Math.max(10*s,100),300);e.style.width=`${i}px`,e.style.minWidth=`${i}px`}))}handleStreamingAttributes(){this.querySelectorAll("[block-id]").forEach((e=>{"code-block"===e.tagName.toLowerCase()&&e.setAttribute("data-streaming",this._isStreaming.toString()),this.applyStreamingStyles(e)}))}updateBlockquoteContent(e,t){if(!this._isIdFrozenAny(e.getAttribute("block-id")))if(t.tokens){const s=Array.from(e.children),i=[];t.tokens.forEach(((t,n)=>{const a=`${e.getAttribute("block-id")}-${n}`;if(this._isIdFrozenAny(a))return;let o=e.querySelector(`:scope > [block-id="${a}"]`);if(o){this.updateElementContent(o,t),i.push(o);const e=s.indexOf(o);e>-1&&s.splice(e,1)}else o=this.createElementForToken(t,a),o&&(e.appendChild(o),i.push(o))})),s.forEach((e=>{this._isIdFrozenAny(e.getAttribute("block-id"))||e.remove()}))}else this.renderInlineContent([t],e)}}customElements.define("markdown-content",Je);class Qe extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._language="",this._code=""}static get observedAttributes(){return["language","code"]}get language(){return this._language}set language(e){this._language=e||"plaintext",this.setAttribute("language",this._language)}get code(){return this._code}set code(e){this._code=e,this.setAttribute("code",btoa(encodeURIComponent(e))),this.updateContent()}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"language":this.language=s;break;case"code":this.code=decodeURIComponent(atob(s))}}connectedCallback(){if(this.innerHTML="",this.codeElement=document.createElement("code"),this.codeElement.classList.add("text-xs","rounded-md","cursor-pointer","inline-block","whitespace-pre-wrap","z-30"),this.language)this.codeElement.classList.add(`language-${this.language}`);else{const e=X.A.highlightAuto(this._code);this.language=e.language||"plaintext"}this.codeElement.innerText=this._code,this.appendChild(this.codeElement),this.applyHighlighting(),this.addClickHandler()}updateContent(){this.codeElement&&(this.codeElement.innerText=this._code,this.applyHighlighting())}applyHighlighting(){if(this.codeElement&&void 0!==X.A){if(!this.language||"undefined"===this.language){const e=X.A.highlightAuto(this._code);this.language=e.language||"plaintext"}if(this.codeElement.dataset.highlighted)return;X.A.highlightElement(this.codeElement),this.codeElement.dataset.highlighted=!0}}addClickHandler(){this.addEventListener("click",(()=>this.copyCode()))}copyCode(){navigator.clipboard.writeText(this._code).then((()=>{new c.y("Copied to clipboard","success",!0,!0,2e3)})).catch((e=>{}))}}customElements.define("code-tag",Qe);class Ze{constructor(){this.primaryContent=document.getElementById("primary-content"),this.primaryView=null,this.scrollPanel=null,this.theme=i.A.theme}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.innerScrollView=document.createElement("div"),this.innerScrollView.classList="flex flex-col w-full leading-7 py-2 sm: max-w-[600px] md:max-w-[700px] lg:max-w-[900px]",this.scrollView.addContainer(this.innerScrollView),this.innerScrollView.innerHTML='\n       \n       <div class="">\n        \n\n        <div class="flex gap-5 w-full">\n            <div class="w-[160px] flex-shrink-0 hidden sm:block">\n                <div class="text-2xl font-bold pb-6 sm:flex">Files</div>\n                <ul class="space-y-2">\n                    <li class="font-bold">All</li>\n                    <li>Recents</li>\n                    <li>Uploaded</li>\n                    <li>Trash</li>\n                    <div class="border-t border-gray-200 mr-10"></div>\n                    <li>Folder</li>\n                </ul>\n            </div>\n            <div class="flex-grow">\n                <div class="w-full">\n                    <div class="text-2xl font-bold pb-6 sm:hidden">Files</div>\n                    <div class="flex flex-grow gap-2 pb-6 justify-between">\n                        <div>\n                            <div><input type="search" class="rounded-md h-8 border-0 ring-1 ring-gray-200 placeholder:text-sm" placeholder="Search across all files" /></div>\n                        </div>\n                        <div class="flex gap-2">\n                            <div class="flex justify-center align-middle items-center"><button class="w-8 h-8 ring-1 ring-gray-300 rounded-md"><div><i class="fa-solid fa-grid-2"></i></div></button></div>\n                            <div><button>+ Upload</button></div>\n                        </div>\n                    </div>\n                    <table class="w-full">\n                            <thead>\n                            <tr class="text-left text-sm text-gray-500">\n                                <th class="pb-2">Name</th>\n                                <th class="pb-2">Modified</th>\n                                <th class="pb-2"></th>\n                            </tr>\n                            </thead>\n                            <tbody>\n                            <tr class="border-t border-gray-200">\n                                <td class="py-2 flex items-center">\n                                    <div class="bg-purple-200 p-2 rounded mr-2 w-8 h-8 flex items-center justify-center">\n                                        <i class="fa-solid fa-image text-purple-600 text-sm"></i>\n                                    </div>\n                                    <span>AI Images</span>\n                                </td>\n                                <td class="py-2">--</td>\n                                <td class="py-2 text-right">...</td>\n                            </tr>\n\n                            <tr class="border-t border-gray-200">\n                                <td class="py-2 flex items-center">\n                                    <div class="bg-cyan-200 p-2 rounded mr-2 w-8 h-8 flex items-center justify-center">\n                                        <i class="fa-solid fa-code text-cyan-600 text-sm"></i>\n                                    </div>\n                                    <span>Code snippets</span>\n                                </td>\n                                <td class="py-2">--</td>\n                                <td class="py-2 text-right">...</td>\n                            </tr>\n\n\n                            <tr class="border-t border-gray-200">\n                                <td class="py-2 flex items-center">\n                                <div class="bg-blue-100 p-2 rounded mr-2">\n                                    <svg class="w-4 h-4 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"></path></svg>\n                                </div>\n                                Files for RAG\n                                </td>\n                                <td class="py-2">--</td>\n                                <td class="py-2 text-right">...</td>\n                            </tr>\n\n                            <tr class="border-t border-gray-200">\n                                <td class="py-2 flex items-center">\n                                <div class="bg-gray-100 p-2 rounded mr-2">\n                                    <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path></svg>\n                                </div>\n                                Some PDF for analysis.pdf\n                                </td>\n                                <td class="py-2 text-sm text-gray-500">10/18/2010 3:06 pm</td>\n                                <td class="py-2 text-right">...</td>\n                            </tr>\n                            </tbody>\n                        </table>\n                    </div>\n                </div>\n            </div>\n        </div>\n       </div>\n       ',this.addCallbacks()}addCallbacks(){}}class et{constructor(e=null){y.a.workspace.name,this.container=e,this.primaryView=null,this.scrollPanel=null,this.theme=i.A.theme,this.planConfig=O.l.getPlans(!0).individual,this.currentPlan=window.user.billing.plan,this.currentPlanID=window.user.billing.plan_id||"member",this.billingCycle=window.user.billing.billing_cycle||"quarterly",this.planState=window.user.billing.plan_state||"active",this.nextBillingDate=window.user.billing.next_billing_date,this.willCancelAtPeriodEnd=window.user.billing.will_cancel_at_period_end,this.isAnnual="annual"===this.billingCycle,this.planInfo=this.planConfig[this.currentPlanID]}async init(e=null){e&&(this.container=e),this.container&&("Personal"===y.a.workspace.name?(this.container.innerHTML="",await this.renderContent()):this.container.innerHTML=`<div class="p-4 ${this.theme.errorText}">Billing settings are only available for personal workspaces.</div>`)}async renderContent(){this.scrollPanel=document.createElement("div"),this.container.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.innerScrollView=document.createElement("div"),this.innerScrollView.classList="flex flex-col w-full leading-7 py-2 max-w-[900px]",this.scrollView.addContainer(this.innerScrollView),this.renderHeader(),this.renderBillingWrapper(),await this.renderCurrentPlanInfo()}renderHeader(){const e=document.createElement("div");e.className="flex items-center align-middle justify-start gap-2";const t=document.createElement("div");t.className=`text-xl md:text-2xl font-bold ${this.theme.text}`,t.textContent="Account",e.appendChild(t),this.innerScrollView.appendChild(e)}renderBillingWrapper(){this.billingWrapper=document.createElement("div"),this.billingWrapper.className="flex flex-col gap-2 w-full my-4 pb-4",this.innerScrollView.appendChild(this.billingWrapper)}async renderCurrentPlanInfo(){const e=document.createElement("div");e.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4`;const t=document.createElement("div");t.className="flex justify-between items-center";const s=document.createElement("div");s.className="flex flex-col gap-0.5";const i=document.createElement("div");i.className="text-lg font-bold","admin"===this.currentPlanID?i.textContent="Admin plan":i.textContent=O.l.getPlans().individual[this.currentPlanID].name,s.appendChild(i);const a=document.createElement("div");if(a.className=`text-base ${this.theme.fadedText}`,this.nextBillingDate)if("None"===this.nextBillingDate&&"admin"===this.currentPlanID)a.textContent="Admin plan";else if("trial"===this.currentPlanID)a.textContent="Trial ends soon";else if("workspace"===this.currentPlanID)a.textContent="Workspace plan";else if(this.willCancelAtPeriodEnd){const e=new Date(this.nextBillingDate).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});a.textContent=`Cancels on ${e}`}else{const e=new Date(this.nextBillingDate).toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"});a.textContent=`Renews ${e}`}else a.textContent="N/A";s.appendChild(a);const l=document.createElement("div");if(l.className="flex flex-col gap-2 items-end","trial"!==this.currentPlanID&&"workspace"!==this.currentPlanID){const e=document.createElement("a");e.href="",e.className=`${this.theme.secondaryButton} px-2 py-1 rounded-md text-sm`,e.textContent="Manage billing",l.appendChild(e),e.addEventListener("click",(e=>{e.preventDefault(),window.open("/accounts/portal","_blank")}))}t.appendChild(s),t.appendChild(l),e.appendChild(t),this.billingWrapper.appendChild(e);const c=document.createElement("div");c.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4 mt-2`;const d=document.createElement("div");d.className="flex items-center justify-center py-4";const h=o.A.name("spinner");new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-5 h-5 animate-spin",colorClass:this.theme.fadedText}).render(d),c.appendChild(d);try{const[e,t]=await Promise.all([u.K.getUsageData(),u.K.getRechargeData()]);c.innerHTML="";const s=document.createElement("div");s.className="text-lg font-bold",s.textContent="Usage this period",c.appendChild(s);const i=document.createElement("div");i.className=`text-base font-medium ${this.theme.fadedText} mb-2`,i.textContent=`Your plan limits will next reset on ${e.formatted.next_reset}`,c.appendChild(i);const a=t?.tokens?.total_input_remaining||0,l=t?.tokens?.total_output_remaining||0,d=t?.premium_images?.total_remaining||0,h=document.createElement("div");h.className="space-y-4";[{label:"Frontier input tokens",current:e.formatted.current_usage.frontier_input_tokens,max:e.formatted.limits.frontier_input_tokens,percentage:e.percentages.frontier_input_tokens,additional:a,type:"input"},{label:"Frontier output tokens",current:e.formatted.current_usage.frontier_output_tokens,max:e.formatted.limits.frontier_output_tokens,percentage:e.percentages.frontier_output_tokens,additional:l,type:"output"},{label:"Premium images",current:e.formatted.current_usage.premium_images,max:e.formatted.limits.premium_images,percentage:e.percentages.premium_images,additional:d,type:"premium"}].forEach((e=>{const t=document.createElement("div");t.className="flex flex-col gap-1";const s=document.createElement("div");s.className="flex justify-between items-center text-base";const i=e.additional>0,n=i?e.additional.toLocaleString():"0",a=document.createElement("span");a.textContent=e.label,s.appendChild(a);const l=document.createElement("div");l.className="flex items-center gap-1.5";const c=document.createElement("span");if(c.className="text-sm font-medium",c.textContent=`${e.current} / ${e.max}`,l.appendChild(c),i){const e=document.createElement("span");e.className=`${this.theme.skillTag} px-1.5 py-0.5 text-xs rounded-md font-medium flex items-center gap-1`;const t=o.A.name("plus");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-2.5 h-2.5"}).render(e),e.appendChild(document.createTextNode(n)),l.appendChild(e)}s.appendChild(l);const d=document.createElement("div");d.className=`h-3 w-full ${this.theme.sliderRailColor} rounded-full overflow-hidden`;const m=document.createElement("div");if(m.className="h-full rounded-full transition-all duration-300",e.percentage>=90?m.className+=" bg-red-500":e.percentage>=75?m.className+=" bg-yellow-500":m.className+=` ${this.theme.progressBarBackground}`,m.style.width=`${Math.min(e.percentage,100)}%`,d.appendChild(m),t.appendChild(s),t.appendChild(d),i){const s=document.createElement("div");s.className=`text-xs ${this.theme.successText} mt-1`,"premium"===e.type?s.textContent=`You have ${n} additional premium image tokens from recharges`:s.textContent=`You have ${n} additional ${e.type} tokens from recharges`,t.appendChild(s)}h.appendChild(t)})),c.appendChild(h);const m="pro"===this.currentPlanID||"max"===this.currentPlanID||"admin"===this.currentPlanID;let p;if(m){p=document.createElement("div"),p.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4 mt-2`;const e=document.createElement("div");e.className="flex justify-between items-center";const s=document.createElement("div");s.className="text-lg font-bold",s.textContent="Recharge tokens",e.appendChild(s);const i=document.createElement("div"),r=o.A.name("chevronDown"),c=o.A.name("chevronUp"),h=new n.$({text:"Show options",type:"link",size:"link-sm",colorClass:"fill-current",svgPathData:r.path,svgViewBox:r.viewBox});h.render(i),e.appendChild(i),p.appendChild(e);const m=document.createElement("div");m.className="hidden",p.appendChild(m),h.onClick((()=>{m.classList.contains("hidden")?(m.classList.remove("hidden"),h.text="Hide options",h.setSvgIcon(c.path,c.viewBox)):(m.classList.add("hidden"),h.text="Show options",h.setSvgIcon(r.path,r.viewBox))}));const u=document.createElement("div");u.className="space-y-4 mb-4";const g=document.createElement("div");g.className="flex justify-between items-center";const f=document.createElement("div");f.className="flex flex-col";const v=document.createElement("div");v.textContent="Input/output credits";const y=document.createElement("div");y.className=`text-sm ${this.theme.fadedText}`,y.textContent="Additional 5M input and 1M output tokens",f.appendChild(v),f.appendChild(y);const w=new n.$({text:"Recharge for $25 USD",size:"small",type:"primary"});g.appendChild(f),w.render(g),u.appendChild(g);const b=document.createElement("div");b.className="flex justify-between items-center";const C=document.createElement("div");C.className="flex flex-col";const x=document.createElement("div");x.textContent="Premium tokens";const k=document.createElement("div");k.className=`text-sm ${this.theme.fadedText}`,k.textContent="200 additional premium tokens for images, videos, and more",C.appendChild(x),C.appendChild(k);const E=new n.$({text:"Recharge for $20 USD",size:"small",type:"primary"});b.appendChild(C),E.render(b),u.appendChild(b),m.appendChild(u),w.onClick((async()=>{try{await this.handleRecharge("tokens")}catch(e){}})),E.onClick((async()=>{try{await this.handleRecharge("premium")}catch(e){}}));const S=document.createElement("div");if(S.className=`text-sm ${this.theme.fadedText} leading-5`,S.textContent="Recharge credits are added to your account and expire in 12 months from purchase date. This is a one-time purchase and will not renew automatically.",m.appendChild(S),t&&(a>0||l>0||d>0)){const e=document.createElement("div");e.className=`mt-3 rounded-md ${this.theme.secondaryBackground}`;const s=document.createElement("div");s.className="font-medium mb-1",s.textContent="Your purchased credits",e.appendChild(s);const i=document.createElement("ul");if(i.className="text-sm space-y-1",a>0||l>0){const e=document.createElement("li");e.className="flex justify-between",e.innerHTML=`\n                            <span>Frontier tokens:</span>\n                            <span>${a.toLocaleString()} input / ${l.toLocaleString()} output</span>\n                        `,i.appendChild(e)}if(d>0){const e=document.createElement("li");e.className="flex justify-between",e.innerHTML=`\n                            <span>Premium images:</span>\n                            <span>${d.toLocaleString()} images</span>\n                        `,i.appendChild(e)}if(t.tokens?.active_packages?.length>0||t.premium_images?.active_packages?.length>0){let e=null;if(t.tokens?.active_packages?.forEach((t=>{const s=new Date(t.expires_at);(!e||s<e)&&(e=s)})),t.premium_images?.active_packages?.forEach((t=>{const s=new Date(t.expires_at);(!e||s<e)&&(e=s)})),e){const t=document.createElement("li");t.className="text-xs mt-2 text-amber-600",t.textContent=`Earliest credit expiration: ${e.toLocaleDateString("en-GB",{day:"numeric",month:"long",year:"numeric"})}`,i.appendChild(t)}}e.appendChild(i),m.appendChild(e)}}this.renderPlansComparison(),this.billingWrapper.appendChild(c),m&&this.billingWrapper.appendChild(p),this.renderInvoicesSection(),this.renderTokenUsageLedger()}catch(e){c.innerHTML=`\n                <div class="text-sm ${this.theme.errorText} py-2">\n                    Failed to load usage data. Please try again later.\n                </div>\n            `}}async handleRecharge(e){const t=document.createElement("div");t.classList="py-3";const s="tokens"===e,i=s?"5M Input and 1M output token recharge":"Premium images",a=s?"$25":"$20",r=s?"By recharging you will be credited with an additional 5M input and 1M output tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when you are over your existing monthly limits.":"By recharging you will be credited with 200 additional premium tokens. These tokens can be used for up to 12 months from purchase date and will be drawn down only when you are over your existing monthly limits.",c=o.A.name("info");t.innerHTML=`\n            <div class="flex flex-col gap-4">\n                <div class="flex flex-row items-center gap-4">\n                    <div class="flex-1 ${this.theme.secondaryBackground} rounded-md p-4">\n                        <div class="font-bold mb-0.5">${i}</div>\n                        <div class="text-sm ${this.theme.fadedText} mb-3">${r}</div>\n                        <div class="font-bold text-lg">${a} USD</div>\n                    </div>\n                </div>\n                \n                <div class="p-3 rounded-md ${this.theme.toastInfo} text-sm">\n                    <div class="flex items-start gap-2">\n                        <div><svg viewBox="${c.viewBox}" class="w-4 h-4 fill-current"><path d="${c.path}"></path></svg></div>\n                        <div>Recharge tokens are added to your account immediately and expire 12 months from purchase date. Recharge tokens can not be refunded.</div>\n                    </div>\n                </div>\n                \n                <div id="recharge-error" class="hidden p-3 rounded-md bg-red-100 text-red-800 text-sm"></div>\n            </div>\n        `;const d=new l({size:"small",title:"Recharge now",body:t,closeX:!0,confirm:!0,cancel:!1,confirmText:`Recharge now for ${a}`,buttonWidth:"full",buttonStyle:"primary",buttonSize:"large",manualCloseOnConfirm:!0});return new Promise(((t,i)=>{let r=!1,l=!1;d.onConfirm((async()=>{try{if(l)return;l=!0,d.updateConfirmButtonText("Processing...");document.getElementById("recharge-error").classList.add("hidden");const i=await u.K.recharge(s?"tokens":"premium");if(!i.success)throw new Error(i.error||"Failed to process recharge");r=!0,d.close(),this.showRechargeSuccess(e),t(!0)}catch(e){l=!1,d.updateConfirmButtonText(`Purchase for ${a}`);let t=e.message||"An error occurred while processing your payment.",s=!1;(t.includes("card was declined")||t.includes("Request req_"))&&(s=!0,t="Your card was declined. Please update your payment method.");const i=document.getElementById("recharge-error"),r=o.A.name("error");let c=`<div class="flex flex-col gap-3">\n                        <div class="flex items-start gap-2">\n                            <div><svg viewBox="${r.viewBox}" class="w-4 h-4 fill-current text-red-500"><path d="${r.path}"></path></svg></div>\n                            <div>${t}</div>\n                        </div>`;if(s&&(c+='<div id="update-payment-button-container" class="flex justify-center mt-2"></div>'),c+="</div>",i.innerHTML=c,i.classList.remove("hidden"),s){const e=document.getElementById("update-payment-button-container"),t=o.A.name("edit"),s=new n.$({text:"Update payment method",type:"link",size:"link-sm",svgPathData:t.path,svgViewBox:t.viewBox});s.onClick((()=>{window.open("/accounts/portal","_blank")})),s.render(e)}}})),d.onClose((()=>{r||(d.wasCancelled?i(new Error("Recharge cancelled")):i(new Error("Modal closed without recharging")))}))}))}showRechargeSuccess(e){const t="tokens"===e?"Input/output credits":"Premium tokens",s=document.createElement("div");s.className="flex flex-col items-center justify-center align-middle space-y-4 h-[250px]";const i=o.A.name("success");s.innerHTML=`\n        <div class="py-4 flex flex-col items-center gap-4 px-10">\n            <div><svg viewBox="${i.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${i.path}"></path></svg></div>\n            <div>\n                <div class="font-bold text-lg text-center">${t} recharge successful!</div>\n                <div class="${this.theme.fadedText} text-base text-center">Your additional credits have been added to your account.</div>\n            </div>\n        </div>\n        `;new l({size:"medium",title:"",closeX:!0,confirmOnExit:!1,body:s}),new H.N;setTimeout((async()=>{await this.refreshPage()}),2500)}async renderTokenUsageLedger(){const e=document.createElement("div");e.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4 mt-2`;const t=document.createElement("div");t.className="flex justify-between items-center";const s=document.createElement("div");s.className="text-lg font-bold",s.textContent="Usage history";const i=document.createElement("div"),a=o.A.name("chevronDown"),l=o.A.name("chevronUp"),c=new n.$({text:"Show history",type:"link",size:"link-sm",svgPathData:a.path,svgViewBox:a.viewBox});t.appendChild(s),t.appendChild(i),e.appendChild(t);const d=document.createElement("div");d.className="hidden",e.appendChild(d);const h=document.createElement("div");h.className="flex items-center justify-center py-4";const m=o.A.name("spinner");new r.I({pathData:m.path,viewBox:m.viewBox,sizeClasses:"w-5 h-5 animate-spin",colorClass:this.theme.fadedText}).render(h),c.render(i);let p=!1;c.onClick((async()=>{if(d.classList.contains("hidden")){if(d.classList.remove("hidden"),c.text="Hide history",c.setSvgIcon(l.path,l.viewBox),!p){d.appendChild(h);try{const e=await u.K.getUsageLog();let t;if(h.parentNode===d&&d.removeChild(h),t=Array.isArray(e)?e:e.usage_entries?e.usage_entries:e.usage_data?e.usage_data:[],t&&0!==t.length){const e=document.createElement("div");e.className="overflow-x-auto -mx-4 px-4",d.appendChild(e);const s=document.createElement("table");s.className="min-w-full divide-y divide-gray-200",e.appendChild(s);const i=document.createElement("thead");i.className=`${this.theme.secondaryBackground}`,i.innerHTML=`\n                                <tr>\n                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium ${this.theme.fadedText} uppercase tracking-wider">Date</th>\n                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium ${this.theme.fadedText} uppercase tracking-wider">Model/Skill</th>\n                                    <th scope="col" class="px-3 py-2 text-left text-xs font-medium ${this.theme.fadedText} uppercase tracking-wider">Type</th>\n                                    <th scope="col" class="px-3 py-2 text-right text-xs font-medium ${this.theme.fadedText} uppercase tracking-wider">Input</th>\n                                    <th scope="col" class="px-3 py-2 text-right text-xs font-medium ${this.theme.fadedText} uppercase tracking-wider">Output</th>\n                                </tr>\n                            `,s.appendChild(i);const n=document.createElement("tbody");n.className="divide-y divide-gray-200";const a={};t.forEach((e=>{const t=new Date(e.date_used).toLocaleDateString();a[t]||(a[t]={entries:[],totals:{input_tokens:0,output_tokens:0,frontier_input_tokens:0,frontier_output_tokens:0,premium_images:0}}),a[t].entries.push(e),"token"===e.type?(a[t].totals.input_tokens+=e.input_tokens,a[t].totals.output_tokens+=e.output_tokens,e.frontier_model&&(a[t].totals.frontier_input_tokens+=e.input_tokens,a[t].totals.frontier_output_tokens+=e.output_tokens)):"image"===e.type&&e.frontier_model&&(a[t].totals.premium_images+=e.quantity||1)}));const o=Object.keys(a).sort(((e,t)=>new Date(t)-new Date(e)));let r=0;o.forEach((e=>{const t=a[e],s=document.createElement("tr");s.className=`${this.theme.secondaryBackground} bg-opacity-50`,s.innerHTML=`\n                                    <td colspan="5" class="px-3 py-2">\n                                        <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center">\n                                            <div class="text-sm font-medium">${e}</div>\n                                            <div class="text-sm ${this.theme.fadedText} mt-1 sm:mt-0">\n                                                <span class="mr-3">Total for day: ${t.totals.frontier_input_tokens.toLocaleString()} input / ${t.totals.frontier_output_tokens.toLocaleString()} output</span>\n                                                <span>Premium tokens: ${t.totals.premium_images.toLocaleString()}</span>\n                                            </div>\n                                        </div>\n                                    </td>\n                                `,n.appendChild(s),t.entries.forEach((e=>{if(r>=50)return;const t=document.createElement("tr");t.className=r%2==0?"":`${this.theme.secondaryBackground} bg-opacity-30`;const s=new Date(e.date_used).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});let i=e.model;const a="image"===e.type;a?i="dalle3"===i?"DALL-E 3":"ideogram"===i?"Ideogram":"gptimg"===i?"GPT image":"flux"===i?"Flux":"fluxultra"===i?"Flux Ultra":"ideogramimg2img"===i?"Ideogram (img2img)":"kling"===i?"Kling":"veo2"===i?"Veo 2":"music"===i?"Music Generation":i.charAt(0).toUpperCase()+i.slice(1):i.startsWith("gpt-")?i=i.replace("gpt-","GPT ").toUpperCase():i.includes("claude")&&(i=i.replace(/-/g," ").replace(/claude/i,"Claude"),i=i.split(" ").map((e=>e.charAt(0).toUpperCase()+e.slice(1))).join(" "));let o=e.usage_type;o="chat"===o?"Session":"knowledge_graph"===o?"Knowledge graph":"file_upload"===o?"File upload":"image_generation"===o?"Image generation":"update_knowledge_graph"===o?"Assistant memory update":"search"===o?"Search":"video_generation"===o?"Video generation":"name_chat"===o?"Session naming process":o.charAt(0).toUpperCase()+o.slice(1);const l=e.frontier_model?`<span class="ml-1 px-1.5 py-0.5 text-xs rounded-full ${this.theme.toastInfo}">Frontier</span>`:"";let c,d;a?(c="-",d=e.quantity?e.quantity.toLocaleString():"1"):e.frontier_model?(c=e.input_tokens.toLocaleString(),d=e.output_tokens.toLocaleString()):(c="0",d="0");const h=e.frontier_model||a?"":this.theme.fadedText;t.innerHTML=`\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm ${this.theme.fadedText}">${s}</td>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm ${e.frontier_model?"":this.theme.fadedText}">${i} ${l}</td>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm ${e.frontier_model?"":this.theme.fadedText}">${o}</td>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right ${h}">${c}</td>\n                                        <td class="px-3 py-2 whitespace-nowrap text-sm text-right ${h}">${d}</td>\n                                    `,n.appendChild(t),r++}))})),s.appendChild(n)}else{const e=document.createElement("div");e.className=`text-sm ${this.theme.fadedText} py-2`,e.textContent="No usage history available.",d.appendChild(e)}const s=document.createElement("div");s.className=`text-sm ${this.theme.fadedText} mt-2 leading-6`,s.textContent="Last 200 items shown. Only frontier models and premium tokens (for images/video etc) count against your monthly limits. To conserve tokens, consider using non-frontier models for general conversation or tasks that require less intelligence.",d.appendChild(s),p=!0}catch(e){h.parentNode===d&&d.removeChild(h);const t=document.createElement("div");t.className=`text-sm ${this.theme.errorText} py-2`,t.textContent="Failed to load usage history. Please try again later.",d.appendChild(t)}}}else d.classList.add("hidden"),c.text="Show history",c.setSvgIcon(a.path,a.viewBox)})),this.billingWrapper.appendChild(e)}renderPlansComparison(){const e=document.createElement("div");e.className="flex flex-col sm:flex-row gap-4 mt-2";let t=this.currentPlanID,s=!0,i=!1;"trial"===this.currentPlanID&&(t="member",s=!1,i=!0);const n=this.renderPlanCard(t,s,i);if(e.appendChild(n),"max"!==t){let t=this.getNextPlanID();if("trial"===this.currentPlanID&&(t="pro"),t){const s=this.renderPlanCard(t,!1,i);e.appendChild(s)}}else n.classList.remove("sm:w-1/2"),n.classList.add("sm:w-full");this.billingWrapper.appendChild(e)}getNextPlanID(){const e=["member","pro","max"];if("trial"===this.currentPlanID)return"member";if("creator"===this.currentPlanID)return"max";let t=e.indexOf(this.currentPlanID);return t<e.length-1?e[t+1]:null}getLowerPlanID(){const e=["member","pro","max"];let t=this.currentPlanID;"trial"===this.currentPlanID&&(t="member");const s=e.indexOf(t);return s>0?e[s-1]:null}renderPlanCard(e,t,s){let i=this.planConfig[e];i||(i={name:"Unknown",monthly:{price:0},quarterly:{price:0},annual:{save:0},features:["Unknown"]});const a=document.createElement("div");a.classList=`${this.theme.listTableItem} ring-1 rounded-md p-6 flex flex-col w-full sm:w-1/2`;const l=document.createElement("div");if(l.className=s?"mb-2 flex items-start":"mb-2 h-6 flex items-start",t){const e=document.createElement("div");e.classList=`${this.theme.tabSelectedBackground} rounded-full px-2 py-0.5 text-xs font-medium flex items-center`,e.textContent=this.willCancelAtPeriodEnd?"Expiring this plan":"Current plan",l.appendChild(e)}a.appendChild(l);const c=document.createElement("div");c.className="flex justify-between items-center mb-4";const d=document.createElement("div");d.className="font-bold text-lg",d.textContent=i.name||"Unknown";const h=document.createElement("div");let m;if(h.className="text-xl font-bold",m="Creator plan (legacy)"===i.name?"":t?"annual"===this.billingCycle?i.annual.price:"quarterly"===this.billingCycle?i.quarterly.price:i.monthly.price:i.annual.price,h.textContent=m?`$${m}/mo`:"",c.appendChild(d),c.appendChild(h),a.appendChild(c),t){if(this.willCancelAtPeriodEnd){const e=document.createElement("div");e.className="flex items-center gap-2 mb-4";const t=new n.$({text:"Resume plan",size:"small",type:"primary"});t.onClick((async()=>{await this.resumePlan(this.currentPlanID),a.removeChild(e)})),t.render(e),a.appendChild(e)}else if(!this.isAnnual&&"trial"!==this.currentPlanID&&"creator"!==this.currentPlanID){const e=document.createElement("div");e.className="flex items-center gap-2 mb-4";const t=new n.$({text:"Switch to annual",size:"small",type:"primary"});t.onClick((async()=>{t.toggleLoading(),this.upgradeButton=t,await this.upgradePlan(this.currentPlanID,!0)}));const s=document.createElement("span");s.className=`text-sm ${this.theme.successText}`,s.textContent=`Save $${i.annual.save}`,t.render(e),e.appendChild(s),a.appendChild(e)}}else{this.nextPlanBillingCycle="annual";const t=document.createElement("div");t.className="flex items-center gap-2 mb-2";const o=new n.$({text:s?"Subscribe":"Upgrade plan",size:"small",type:"primary"});s?o.onClick((()=>{const e=window.location.hostname.match(/localhost/);if("annual"===this.nextPlanBillingCycle){const t=e?i.annual.pid:i.annual.prpid;window.location.href=`/accounts/account/pay/annual/${t}`}else{const t=e?i.monthly.pid:i.monthly.prpid;window.location.href=`/accounts/account/pay/monthly/${t}`}})):o.onClick((async()=>{o.toggleLoading(),this.upgradeButton=o,await this.upgradePlan(e)}));const r=document.createElement("span");if(r.className=`text-sm ${this.theme.successText}`,r.textContent=`Save $${i.annual.save}/year`,o.render(t),t.appendChild(r),a.appendChild(t),!this.isAnnual){const e=document.createElement("div");e.className="flex justify-start items-center";const t=document.createElement("button");t.className=`text-xs ${this.theme.linkText}`,"monthly"!==this.billingCycle||this.nextPlanBillingCycle||(this.nextPlanBillingCycle="quarterly"),t.textContent="annual"===this.nextPlanBillingCycle?"Switch to quarterly billing":"Switch to annual billing",t.addEventListener("click",(()=>this.toggleNextPlanBilling(t,h,i,r))),e.appendChild(t),a.appendChild(e)}}const u=document.createElement("div");u.className="space-y-2 pt-6";const p=o.A.name("checkCircle");return i.features.forEach((e=>{const t=document.createElement("div");t.className="flex items-center gap-2 text-sm leading-5";const s=new r.I({pathData:p.path,viewBox:p.viewBox,sizeClasses:"w-3.5 h-3.5",colorClass:this.theme.iconColor}),i=document.createElement("span");i.textContent=e,s.render(t),t.appendChild(i),u.appendChild(t)})),a.appendChild(u),a}renderInvoicesSection(){const e=document.createElement("div");e.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4 mt-2`;const t=document.createElement("div");t.className="flex justify-between items-center";const s=document.createElement("div");s.className="text-lg font-bold",s.textContent="Invoices";const i=document.createElement("div"),a=o.A.name("chevronDown"),l=o.A.name("chevronUp"),c=new n.$({text:"Show invoices",type:"link",size:"link-sm",svgPathData:a.path,svgViewBox:a.viewBox});t.appendChild(s),t.appendChild(i),e.appendChild(t);const d=document.createElement("div");d.className="hidden",e.appendChild(d),c.render(i);let h=!1;c.onClick((async()=>{if(d.classList.contains("hidden")){if(d.classList.remove("hidden"),c.text="Hide invoices",c.setSvgIcon(l.path,l.viewBox),!h){const e=document.createElement("div");e.className="flex items-center justify-center py-4";const t=o.A.name("spinner");new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-5 h-5 animate-spin",colorClass:this.theme.fadedText}).render(e),d.appendChild(e);try{const t=await u.K.getInvoices();if(d.removeChild(e),t&&0!==t.length){const e=document.createElement("div");e.classList="space-y-2",d.appendChild(e);const s=o.A.name("circleDown");t.forEach((t=>{const i=document.createElement("div");i.classList="text-sm flex justify-between items-center py-2 border-b border-gray-200 last:border-0";const n=document.createElement("div"),a=new Date(t.created);n.innerText=a.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"});const o=document.createElement("div");o.classList="flex items-center gap-4";const l=document.createElement("span");l.classList="hidden sm:inline",l.innerText=t.description||"Invoice";const c=document.createElement("span");c.innerText=t.amount_paid?`$${t.amount_paid.toFixed(2)}`:"-";const d=document.createElement("span");d.classList=`${this.theme.fadedText} hidden sm:inline`,d.innerText=t.status.charAt(0).toUpperCase()+t.status.slice(1);const h=document.createElement("button");h.classList=`${this.theme.linkText}`;new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4"}).render(h),t.invoice_pdf||t.hosted_invoice_url?h.onclick=()=>{window.open(t.invoice_pdf||t.hosted_invoice_url,"_blank")}:(h.disabled=!0,h.classList.add("opacity-50","cursor-not-allowed")),o.appendChild(l),o.appendChild(c),o.appendChild(d),o.appendChild(h),i.appendChild(n),i.appendChild(o),e.appendChild(i)}))}else{const e=document.createElement("div");e.classList=`${this.theme.fadedText} py-2`,e.innerText="No invoices available",d.appendChild(e)}h=!0}catch(t){e.parentNode===d&&d.removeChild(e);const s=document.createElement("div");s.className=`text-sm ${this.theme.errorText} py-2`,s.textContent="Failed to load invoices. Please try again later.",d.appendChild(s)}}}else d.classList.add("hidden"),c.text="Show invoices",c.setSvgIcon(a.path,a.viewBox)})),this.billingWrapper.appendChild(e)}toggleNextPlanBilling(e,t,s,i){this.nextPlanBillingCycle="annual"===this.nextPlanBillingCycle?"quarterly":"annual",e.textContent="annual"===this.nextPlanBillingCycle?"Switch to quarterly billing":"Switch to annual billing",this.updateNextPlanPrice(t,s,i)}updateNextPlanPrice(e,t,s){let i;i="annual"===this.nextPlanBillingCycle?t.annual.price:t.quarterly.price,e.textContent=`$${i}/mo`,"annual"===this.nextPlanBillingCycle?(s.textContent=`Save $${t.annual.save}/year`,s.style.display="inline"):s.style.display="none"}async upgradePlan(e,t=!1){this.planConfig[e];try{await this.showPlanUpgradeModal(e,t),this.upgradeButton&&(this.upgradeButton.toggleLoading(!1),this.upgradeButton=null),this.showSuccessMessage(e,t?"annual":this.billingCycle,"upgrade")}catch(e){this.upgradeButton&&(this.upgradeButton.toggleLoading(!1),this.upgradeButton=null)}}async resumePlan(e){(await fetch("/accounts/account/resume",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":(0,m.R)("csrftoken")},body:JSON.stringify({billing_cycle:this.billingCycle})})).ok?this.showSuccessMessage(e,this.billingCycle,"resume"):new c.y("An error occurred. Please try again later.","error")}showSuccessMessage(e,t,s){const i=this.planConfig[e],n=document.createElement("div");n.className="flex flex-col items-center justify-center align-middle space-y-4 h-[250px]";const a=o.A.name("success");n.innerHTML="upgrade"===s?`\n            <div class="py-4 flex flex-col items-center gap-4 px-10">\n                <div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div>\n                <div>\n                    <div class="font-bold text-lg text-center">You've successfully been upgraded to the ${i.name}.</div>\n                    <div class="${this.theme.fadedText} text-base text-center">Your new plan features and limits are now available.</div>\n                </div>\n            </div>\n            `:"resume"===s?`\n            <div class="py-4 flex flex-col items-center gap-4 px-10">\n                <div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div>\n                <div>\n                    <div class="font-bold text-lg text-center">You've successfully resumed your plan.</div>\n                    <div class="${this.theme.fadedText} text-base text-center">Your plan is active and will continue to renew.</div>\n                </div>\n            </div>\n            `:`\n            <div class="py-4 flex flex-col items-center gap-4 px-10">\n                <div><svg viewBox="${a.viewBox}" class="w-20 h-20 ${this.theme.toastSuccess} fill-current"><path d="${a.path}"></path></svg></div>\n                <div>\n                    <div class="font-bold text-lg text-center">Your plan has been switched to annual billing successfully.</div>\n                </div>\n            </div>\n            `,this.modalConfig={size:"medium",title:"",closeX:!0,confirmOnExit:!1,body:n},this.modal=new l(this.modalConfig);new H.N;setTimeout((async()=>{await this.refreshPage()}),2500)}async refreshPage(){const e=await fetch("/accounts/account/refresh",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":(0,m.R)("csrftoken")},body:JSON.stringify({})}),t=await e.json();this.currentPlan=t.currentPlan,this.currentPlanID=t.currentPlanID,this.billingCycle=t.billingCycle,this.nextBillingDate=t.nextBillingDate,this.isAnnual=t.isAnnual,this.planInfo=this.planConfig[this.currentPlanID],this.innerScrollView?this.innerScrollView.innerHTML="":this.container&&(this.container.innerHTML=""),this.scrollPanel=null,await this.renderContent()}async showPlanUpgradeModal(e,t=!1){const s=this.planConfig[e];if(!s)return;const i=document.createElement("div");i.classList="py-3";const a=o.A.name("spinner");i.innerHTML=`\n            <div class="gap-2 flex flex-col justify-center py-6">\n                <div class="${this.theme.fadedText} flex justify-center">\n                    <svg viewBox="${a.viewBox}" class="w-16 h-16 animate-spin fill-current"><path d="${a.path}"></path></svg>\n                </div>\n                <div class="text-lg font-bold flex justify-center">Loading plan information...</div>\n            </div>\n        `;const r=new l({size:"medium",title:"Upgrade plan",body:i,closeX:!0,confirm:!0,cancel:!1,confirmText:"Upgrade plan",buttonWidth:"full",buttonStyle:"primary",buttonSize:"large",manualCloseOnConfirm:!0});r.disableConfirmButton();let d,h=this.billingCycle;d=t?"annual":this.nextPlanBillingCycle?this.nextPlanBillingCycle:"monthly"===h?"monthly":h;const u=window.location.hostname.match(/localhost/);let p,g=this.planConfig[this.currentPlanID],f=s;p="annual"===d?u?f.annual.pid:f.annual.prpid:u?f.quarterly.pid:f.quarterly.prpid;const v=(e,t)=>"annual"===t?e.annual.price:"quarterly"===t&&e.quarterly?e.quarterly.price:e.monthly.price,y=e=>"annual"===e?"Annual":"quarterly"===e?"Quarterly":"Monthly",b=o.A.name("chevronRight"),C=o.A.name("spinner");if(i.innerHTML=`\n            <div class="flex flex-col gap-4">\n                ${this.isAnnual||t?"":'\n                    <div class="flex flex-col gap-2 justify-center">\n                        <div class="text-base text-center font-medium">Billing cycle:</div>\n                        <div id="billing-cycle-tabs" class="flex justify-center"></div>\n                    </div>\n                '}\n                <div class="flex flex-row items-center gap-4">\n                    <div class="flex-1 ${this.theme.secondaryBackground} rounded-md p-3">\n                        <div class="font-bold mb-2">Current plan:</div>\n                        <ul class="list-inside list-disc ml-2 text-sm ${this.theme.fadedText}">\n                            <li>${g.name}</li>\n                            <li>${y(h)} billing</li>\n                            <li>$${v(g,h)}/month</li>\n                        </ul>\n                    </div>\n                    <div class="flex-none flex items-center justify-center">\n                        <svg viewBox="${b.viewBox}" class="w-5 h-5 ${this.theme.fadedText} fill-current"><path d="${b.path}"></path></svg>\n                    </div>\n                    <div class="flex-1 ${this.theme.secondaryBackground} rounded-md p-3">\n                        <div class="font-bold mb-2">New plan:</div>\n                        <ul class="list-inside list-disc ml-2 text-sm ${this.theme.fadedText}">\n                            <li>${s.name}</li>\n                            <li id="new-billing-cycle">${y(d)} billing</li>\n                            <li id="new-plan-price">$${v(s,d)}/month</li>\n                        </ul>\n                    </div>\n                </div>\n                <div id="pro-rata-loading" class="p-3 rounded-md ${this.theme.toastSuccess} flex items-center gap-2 text-sm">\n                    <svg viewBox="${C.viewBox}" class="w-4 h-4 animate-spin fill-current"><path d="${C.path}"></path></svg>\n                    <span>Calculating pro-rated amount...</span>\n                </div>\n                <div id="pro-rata-content" class="hidden"></div>\n                <div id="upgrade-error" class="hidden p-3 rounded-md bg-red-100 text-red-800 text-sm"></div>\n            </div>\n        `,!this.isAnnual&&!t){const e=document.getElementById("billing-cycle-tabs");new w({tabs:[{title:"Quarterly",value:"quarterly",selected:"quarterly"===d},{title:"Annual",value:"annual",selected:"annual"===d}],onTabChange:async e=>{d=e,document.getElementById("new-billing-cycle").textContent=`${y(d)} billing`,"annual"===d?(document.getElementById("new-plan-price").textContent=`$${s.annual.price}/month`,p=u?s.annual.pid:s.annual.prpid):(document.getElementById("new-plan-price").textContent=`$${s.quarterly.price}/month`,p=u?s.quarterly.pid:s.quarterly.prpid),document.getElementById("pro-rata-loading").classList.remove("hidden"),document.getElementById("pro-rata-content").classList.add("hidden"),document.getElementById("upgrade-error").classList.add("hidden"),r.disableConfirmButton();try{await this.calculateAndDisplayProRata(p,r)}catch(e){const t=document.getElementById("upgrade-error");t.textContent="Failed to calculate pro-rated amount. Please try again or contact support.",t.classList.remove("hidden"),document.getElementById("pro-rata-loading").classList.add("hidden")}}}).render(e)}try{await this.calculateAndDisplayProRata(p,r)}catch(e){const t=document.getElementById("upgrade-error");t.textContent="Failed to calculate pro-rated amount. Please try again or contact support.",t.classList.remove("hidden"),document.getElementById("pro-rata-loading").classList.add("hidden")}return new Promise(((e,t)=>{let s=!1,i=!1;r.onConfirm((async()=>{try{if(i)return;i=!0,r.updateConfirmButtonText("Processing..."),r.disableConfirmButton(),document.getElementById("upgrade-error").classList.add("hidden");const t=await fetch(`/accounts/account/upgrade/${p}`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":(0,m.R)("csrftoken")},body:JSON.stringify({billing_cycle:h})});let n;const a=t.headers.get("content-type");if(a&&a.includes("application/json"))n=await t.json();else{n={error:await t.text()||"Unknown error occurred"}}if(!t.ok)throw new Error(n.error||"Failed to upgrade plan");s=!0,r.close(),new c.y("Plan upgraded successfully!","success"),setTimeout((()=>window.location.reload()),1500),e(!0)}catch(e){i=!1,r.enableConfirmButton(),r.updateConfirmButtonText("Upgrade plan");let t=e.message||"An error occurred while processing your payment.",s=!1;(t.includes("card was declined")||t.includes("Request req_"))&&(s=!0,t="Your card was declined. Please update your payment method.");const a=document.getElementById("upgrade-error"),l=o.A.name("error");let c=`<div class="flex flex-col gap-3">\n                        <div class="flex items-start gap-2">\n                            <div><svg viewBox="${l.viewBox}" class="w-4 h-4 fill-current text-red-500"><path d="${l.path}"></path></svg></div>\n                            <div>${t}</div>\n                        </div>`;if(s&&(c+='<div id="update-payment-button-modal-container" class="flex justify-center mt-2"></div>'),c+="</div>",a.innerHTML=c,a.classList.remove("hidden"),s){const e=document.getElementById("update-payment-button-modal-container"),t=o.A.name("edit"),s=new n.$({text:"Update payment method",type:"link",size:"link-sm",svgPathData:t.path,svgViewBox:t.viewBox});s.onClick((()=>window.open("/accounts/portal","_blank"))),s.render(e)}}})),r.onClose((()=>{s||(r.wasCancelled?t(new Error("Upgrade cancelled")):t(new Error("Modal closed without upgrading")))}))}))}async calculateAndDisplayProRata(e,t){try{const s=await u.K.getProRataUpgradeAmount(e);if(!s.success)throw new Error("Failed to calculate pro-rata amount");const i=s.pro_rata_amount,n=e=>(e/100).toLocaleString("en-US",{style:"currency",currency:"USD"}),a=document.getElementById("pro-rata-content"),r=o.A.name("file");a.innerHTML=`\n                <div class="p-3 rounded-md ${this.theme.toastSuccess}">\n                    <div class="font-semibold mb-1 text-sm">\n                        <div class="flex items-start">\n                            <div class="mr-2"><svg viewBox="${r.viewBox}" class="w-3.5 h-3.5 fill-current"><path d="${r.path}"></path></svg></div>\n                            <div>Summary of charges:</div>\n                        </div>\n                    </div>\n                    <ul class="list-disc pl-5 space-y-1 text-sm">\n                        <li><strong>Due today:</strong> ${n(i)} (prorated amount)</li>\n                    </ul>\n                </div>\n                <div class="mt-2 text-xs ${this.theme.fadedText}">\n                    Applicable taxes will be calculated at checkout and will appear on your invoice. \n                    Your default payment method will be charged immediately upon confirmation.\n                </div>\n            `,document.getElementById("pro-rata-loading").classList.add("hidden"),a.classList.remove("hidden"),t.updateConfirmButtonText(`Upgrade now (${n(i)})`),t.enableConfirmButton()}catch(e){const t=o.A.name("error");document.getElementById("pro-rata-loading").innerHTML=`\n                <div class="text-red-500 flex items-center gap-2">\n                    <svg viewBox="${t.viewBox}" class="w-4 h-4 fill-current"><path d="${t.path}"></path></svg>\n                    Failed to calculate pro-rated amount. Please try again.\n                </div>\n            `}}}class tt{constructor(){this.planConfg=O.l.getPlans(),this.primaryContent=document.getElementById("primary-content"),this.primaryView=null,this.scrollPanel=null,this.theme=i.A.theme,this.render()}render(){this.primaryContent.innerHTML="",this.scrollPanel=document.createElement("div"),this.primaryContent.appendChild(this.scrollPanel),this.scrollView=new Z(this.scrollPanel),this.innerScrollView=document.createElement("div"),this.innerScrollView.classList="flex flex-col w-full leading-7 py-2 max-w-[700px]",this.scrollView.addContainer(this.innerScrollView),this.renderHeader(),this.renderOptions(),this.addCallbacks()}renderHeader(){const e=document.createElement("div");e.className="flex items-center align-middle justify-start gap-2";const t=document.createElement("button");t.type="button",t.className=`rounded-md ${this.theme.text} font-medium text-sm flex items-center align-middle justify-center`;const s=document.createElement("i");s.className="fa-solid fa-chevron-left fa-lg",t.appendChild(s),t.addEventListener("click",(()=>{v.view("/chat/settings")})),e.appendChild(t);const i=document.createElement("div");i.className=`text-xl md:text-2xl font-bold ${this.theme.text}`,i.textContent="Personalization",e.appendChild(i),this.innerScrollView.appendChild(e)}renderOptions(){this.optionWrapper=document.createElement("div"),this.optionWrapper.className="flex flex-col gap-3 w-full my-4 pb-10",this.innerScrollView.appendChild(this.optionWrapper),this.renderUsernameOption(),this.innerScrollView.appendChild(this.optionWrapper)}renderUsernameOption(){const e=document.createElement("div");e.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4`;const t=document.createElement("div");t.classList="flex justify-between gap-10";const s=document.createElement("div"),i=document.createElement("div");i.classList="text-lg",i.textContent="Nickname & avatar";const a=document.createElement("div");a.classList="text-sm leading-5",a.textContent="This is the name agents will call you",s.appendChild(i),s.appendChild(a);const o=document.createElement("div");o.classList="flex items-center gap-2";new n.$({text:"Edit",type:"focus",size:"medium",icon:"fa-solid fa-pen-to-square"}).render(o),t.appendChild(s),t.appendChild(o),e.appendChild(t),this.optionWrapper.appendChild(e)}renderInputOption(e){const t=document.createElement("div");t.classList=`${this.theme.listTableItem} ring-1 rounded-md py-4 px-4 w-full text-left flex flex-col gap-4`;const s=document.createElement("div");s.classList="flex justify-between gap-10";const i=document.createElement("div"),n=document.createElement("div");n.classList="text-lg font-medium",n.textContent=e.label;const a=document.createElement("div");a.classList="text-sm leading-5",a.textContent=e.description,i.appendChild(n),i.appendChild(a);const o=document.createElement("div");o.classList="flex items-center gap-2";const r=document.createElement("input");r.type="text",r.value=e.defaultValue,r.className="input-class",r.addEventListener("input",(t=>{this.saveOption(e.key,t.target.value)})),o.appendChild(r),s.appendChild(i),s.appendChild(o),t.appendChild(s),this.optionWrapper.appendChild(t)}saveOption(e,t){c.y.show(`${e} has been updated`)}addCallbacks(){}}s(57093);class st extends HTMLElement{static activePollers=new Set;constructor(){super(),this.theme=i.A.theme,this._mode="",this.previewIframe=null,this.focusInstance=null,this.iframe=null,this.uuid="",this.seenActivities={},this.errorCount=0,this.maxBackoff=1e4,this.stopped=!1}static get observedAttributes(){return["mode","minimize","block-id","chat-id","uuid"]}get minimize(){return this._minimize}set minimize(e){!0===e||"true"===e||""===e?(this._minimize=!0,this.setAttribute("minimize","true")):(this._minimize=!1,this.setAttribute("minimize","false"))}set mode(e){this._mode!==e&&(this._mode=e,this.setAttribute("mode",e))}attributeChangedCallback(e,t,s){if(t!==s)switch(e){case"mode":this.mode=s;break;case"minimize":this.minimize=s;break;case"block-id":this.blockId=s;break;case"chat-id":this.chatId=s;break;case"uuid":this.uuid=s}}connectedCallback(){this._connectDebounce&&clearTimeout(this._connectDebounce),this._connectDebounce=setTimeout((()=>{this.chatId=this.getAttribute("chatid"),this.render()}),100)}disconnectedCallback(){this.cleanup()}cleanup(){window._workspaceComputerActive=!1,this.viewIframe&&(this.viewIframe.remove(),this.viewIframe=null),this.controlIframe&&(this.controlIframe.remove(),this.controlIframe=null),this.loopTimeout&&(clearTimeout(this.loopTimeout),this.loopTimeout=null);this.chatId,this.uuid;this.loopTimeout&&clearTimeout(this.loopTimeout),this.seenActivities={},this.last_ran=null,this.errorCount=0,this._workspaceComputerActiveTimeout&&(clearTimeout(this._workspaceComputerActiveTimeout),this._workspaceComputerActiveTimeout=null),this._connectDebounce&&(clearTimeout(this._connectDebounce),this._connectDebounce=null),window._clickCheckInterval&&(clearInterval(window._clickCheckInterval),window._clickCheckInterval=null)}getBackoffTime(){if(0===this.errorCount)return 2500;return Math.min(2500*Math.pow(1.5,this.errorCount),this.maxBackoff)}render(){this.innerHTML="","focus"!==this._mode&&(this.marginWrapper=document.createElement("div"),this.marginWrapper.classList.add("code-block-margin-wrapper","my-2"),this.appendChild(this.marginWrapper)),this.wrapper=document.createElement("div"),this.wrapper.classList.add("rounded-t-lg","rounded-b-md"),"focus"===this._mode&&this.wrapper.classList.add("py-2"),"focus"===this._mode?this.appendChild(this.wrapper):this.marginWrapper.appendChild(this.wrapper),this.renderToolbar(),"focus"===this._mode?this.renderFocusContent():this.renderMinimizedContent()}renderToolbar(){const e={title:"Workspace live view",mode:this._mode,disableTitleEdit:!0,simpleModeTitle:"Workspace computer",onEnterFocus:()=>{this.streaming||this.handleFocus()},onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus(),this.cleanup()}};"focus"!==this._mode&&(e.quickActions=[{type:"icon",icon:"fa-solid fa-square",hoverText:"Stop",onClick:()=>{this.stopProcess()}}]),this.focusWindowMenu=new D(e),this.menuElement=this.focusWindowMenu.create(),this.wrapper.appendChild(this.menuElement)}logAction(e,t=null,s){this.minContainer||(this.minContainer=document.createElement("div"),this.minContainer.className=`${this.theme.secondaryBackground} z-50 rounded-b-lg p-6 flex flex-col gap-6 max-h-[300px] overflow-y-auto`);const i=this.minContainer.lastElementChild;let n;i&&"thinking"!==e&&i.querySelector(".fa-spinner")&&this.minContainer.removeChild(i),i&&"thinking"===e&&i.querySelector(".fa-spinner")&&this.minContainer.removeChild(i);let a=this.theme.cpuActionAction;switch(e){case"connected":n="fa-computer-classic",t=t??"Connected",a=this.theme.cpuActionLoad;break;case"mouse_move":case"double_click":case"right_click":case"middle_click":case"left_click":case"click":t=t??"Click",n="fa-computer-mouse",a=this.theme.cpuActionClick;break;case"key":case"input":case"type":t="Input",n="fa-input-pipe",a=this.theme.cpuActionInput;break;case"action":t=t??"Action",n="fa-gear",a=this.theme.cpuActionAction;break;case"thinking":t=t??"Thinking...",n="fa-spinner fa-spin",a=this.theme.cpuActionThinking;break;case"goal":t=t??"Goal achieved",n="fa-check",a=this.theme.cpuActionGoal;break;case"question":t="Stopped awaiting input",n="fa-square-small",a=this.theme.cpuActionStop;break;case"stop":t=t??"Stopped",n="fa-square-small",a=this.theme.cpuActionStop;break;case"error":t=t??"Error",n="fa-xmark",a=this.theme.cpuActionStop;break;default:t=t??"Info",n="fa-circle-info"}const o=document.createElement("div");o.className="flex gap-3 items-start relative w-full leading-5",o.innerHTML=`\n            <div class="rounded-lg ${a} w-8 h-8 flex flex-shrink-0 justify-center items-center z-10">\n                <i class="fa-solid ${n} text-sm text-inherit"></i>\n            </div>\n            <div class="flex-1 min-w-0 overflow-hidden">\n                <div class="text-sm font-bold">${t}</div>\n                <div class="${this.theme.fadedText} text-sm line-clamp-4">${s}</div>\n            </div>\n        `,o.style.opacity="0",o.style.transform="translateY(10px)",o.style.transition="all 0.3s ease",this.minContainer.appendChild(o),setTimeout((()=>{o.style.opacity="1",o.style.transform="translateY(0)",this.minContainer.scrollTo({top:this.minContainer.scrollHeight,behavior:"smooth"})}),50)}runActivityLoop(){this.chatId,this.uuid;this.last_ran&&Date.now()-this.last_ran<3e3?this.loopTimeout=setTimeout((()=>this.runActivityLoop()),5e3):(this.last_ran=Date.now(),y.a.getComputerActivities(this.uuid,this.chatId).then((e=>{if(!e.activities)return;let t=null;e.activities.forEach((e=>{this.seenActivities[e.id]||(this.seenActivities[e.id]=!0,this.logAction(e.type,e.title,e.description),t=e)}));t&&-1===["goal","stop","error","question","thinking"].indexOf(t.type)&&this.logAction("thinking",null,"Working on next action...");t&&["goal","stop","error","question"].indexOf(t.type)>=0?this.loopTimeout&&clearTimeout(this.loopTimeout):this.errorCount=0})).catch((e=>{this.errorCount++})).finally((()=>{if(!this.isConnected)return void(this.loopTimeout&&clearTimeout(this.loopTimeout));const e=this.getBackoffTime();this.loopTimeout&&clearTimeout(this.loopTimeout),this.loopTimeout=setTimeout((()=>this.runActivityLoop()),e)})))}renderMinimizedContent(){this.minContainer=document.createElement("div"),this.minContainer.className=`${this.theme.secondaryBackground} rounded-b-lg p-6 flex flex-col gap-6 h-[250px] overflow-y-auto relative cursor-normal select-none overflow-x-hidden`;document.createElement("div").className="absolute left-9 top-0 bottom-0 w-[1px]",this.wrapper.appendChild(this.minContainer),this.uuid&&this.runActivityLoop()}renderFocusContent(){this.contentContainer=document.createElement("div"),this.contentContainer.style.height="calc(var(--vh)*100 - 63px)",this.contentContainer.classList.add("relative","w-full","flex","flex-col");const e=document.createElement("div");e.classList.add("absolute","inset-0","flex","items-center","justify-center","z-10"),e.style.background=this.theme.secondaryBackground,e.innerHTML=`\n            <div class="flex flex-col items-center gap-3">\n                <i class="fa-solid fa-computer-classic fa-2x ${this.theme.fadedText}"></i>\n                <div class="flex items-center gap-2">\n                    <i class="fa-solid fa-spinner fa-spin ${this.theme.fadedText}"></i>\n                    <span class="${this.theme.fadedText}">Workspace computer loading...</span>\n                </div>\n            </div>\n        `,this.iframeContainer=document.createElement("div"),this.iframeContainer.classList.add("relative","flex-grow"),this.viewIframe=document.createElement("iframe"),this.viewIframe.src="/chat/polling/",this.viewIframe.classList="w-full h-full border-none object-contain object-scale-down max-w-full max-h-full",this.viewIframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-pointer-lock"),this.controlLoadingPlaceholder=document.createElement("div"),this.controlLoadingPlaceholder.classList.add("absolute","inset-0","flex","flex-col","items-center","justify-center","z-10","hidden"),this.controlLoadingPlaceholder.style.background=this.theme.secondaryBackground,this.controlLoadingPlaceholder.innerHTML=`\n            <div class="flex flex-col items-center gap-3">\n                <i class="fa-solid fa-computer-classic fa-2x ${this.theme.fadedText}"></i>\n                <div class="flex items-center gap-2">\n                    <i class="fa-solid fa-spinner fa-spin ${this.theme.fadedText}"></i>\n                    <span class="${this.theme.fadedText}">Initializing control mode...</span>\n                </div>\n            </div>\n        `,this.viewIframe.addEventListener("load",(()=>{e.style.opacity="0",setTimeout((()=>{e.remove()}),2e3)})),e.style.transition="opacity 0.3s ease",this.iframeContainer.appendChild(e),this.iframeContainer.appendChild(this.viewIframe),this.iframeContainer.appendChild(this.controlLoadingPlaceholder),this.controlIframeContainer=document.createElement("div"),this.controlIframeContainer.classList.add("hidden"),this.iframeContainer.appendChild(this.controlIframeContainer),this.contentContainer.appendChild(this.iframeContainer),this.statusBar=this.createStatusBar(),this.contentContainer.appendChild(this.statusBar),this.wrapper.appendChild(this.contentContainer)}createStatusBar(){return this.statusBarItems=document.createElement("div"),this.statusBarItems.classList=`flex justify-between items-center w-full py-1.5 ${this.theme.focusBackground} ${this.theme.focusMenuTextColor} rounded-b-md min-h-[50px] max-h-[50px] h-[50px] z-20`,this.lhsItems=document.createElement("div"),this.lhsItems.classList="flex-1 flex justify-start items-center px-2 gap-2 lg:gap-4",this.centerItems=document.createElement("div"),this.centerItems.classList="flex-1 flex justify-center",this.rhsItems=document.createElement("div"),this.rhsItems.classList="flex-1 flex justify-end items-center px-2",this.viewControlTabs=new w({tabs:[{title:"View",value:"view",selected:!0},{title:"Control",value:"control",selected:!1}],onTabChange:e=>{this.handleTabChange(e)}}),this.viewControlTabs.render(this.centerItems),this.statusBarItems.appendChild(this.lhsItems),this.statusBarItems.appendChild(this.centerItems),this.statusBarItems.appendChild(this.rhsItems),this.statusBarItems}handleTabChange(e){"view"===e?(this.hideAllLoaders(),this.viewIframe.classList.remove("hidden"),this.controlIframe&&this.controlIframe.classList.add("hidden"),this.controlLoadingPlaceholder&&this.controlLoadingPlaceholder.classList.add("hidden")):(this.hideAllLoaders(),this.viewIframe.classList.add("hidden"),this.initializeControlMode(),this.controlIframe&&setTimeout((()=>{this.controlIframe.focus(),this.controlIframe.onclick=()=>this.controlIframe.focus()}),5e3))}hideAllLoaders=()=>{this.iframeContainer.querySelectorAll('div[class*="flex items-center justify-center"]').forEach((e=>{"0"!==e.style.opacity&&(e.style.opacity="0",setTimeout((()=>{e.classList.add("hidden")}),300))}))};stopProcess(){this.stopped||y.a.stopTask(this.uuid).then((()=>{this.logAction("thinking","Stopping","Stopping the current process..."),this.stopped=!0;this.chatId,this.uuid;this.loopTimeout&&(clearTimeout(this.loopTimeout),this.loopTimeout=null)}))}handleFocus(){this.minimizeInChat(),this.focusInstance=new G(this.chatId,this)}maximizeInChat(){this.setAttribute("minimize","false"),this.focusInstance=null,this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null),this.wrapper.style.display="block"}minimizeInChat(){}closeFocus(){this.focusInstance&&(this.focusInstance.close(),this.focusInstance=null)}focus(){return this.focusCodeEditor=document.createElement("workspace-computer"),this.focusCodeEditor.mode="focus",this.focusCodeEditor.setAttribute("block-id",this.blockId),this.focusCodeEditor.setAttribute("chatid",this.chatId),this.focusCodeEditor.originalInstance=this,this.focusCodeEditor}initializeControlMode(){if(this.controlLoadingPlaceholder||this.createControlLoadingPlaceholder(),this.controlLoadingPlaceholder.classList.remove("hidden"),!this.controlIframe){function e(){const e=document.getElementById("user-input"),t=document.getElementById("workspace-iframe");e&&e!==document.activeElement&&t&&t.focus()}window._workspaceComputerActive=!0,document.querySelectorAll('iframe[id^="background-workspace-"]').forEach((e=>{e.remove()})),this.controlIframe=document.createElement("iframe"),this.controlIframe.id="workspace-iframe",this.controlIframe.classList.add("w-full","h-full","border-none","hidden"),this.controlIframe.setAttribute("allow","cross-origin-isolated; keyboard-map; clipboard-read; clipboard-write"),this.controlIframe.setAttribute("sandbox","allow-scripts allow-same-origin allow-forms allow-modals allow-popups allow-downloads allow-top-navigation"),this.controlIframe.setAttribute("autofocus","true"),this.controlIframe.style.width="100%",this.controlIframe.style.height="100%",this.controlIframe.style.border="none",this.iframeContainer.appendChild(this.controlIframe),window._clickCheckInterval||(window._clickCheckInterval=setInterval(e,600))}this.controlIframe.addEventListener("load",(()=>{this.controlLoadingPlaceholder.classList.add("hidden"),this.controlIframe.classList.remove("hidden")})),this.controlIframe.src="/chat/control-computer/",window._workspaceComputerActive=!0,this._workspaceComputerActiveTimeout&&clearTimeout(this._workspaceComputerActiveTimeout),this._workspaceComputerActiveTimeout=setTimeout((()=>{window._workspaceComputerActive=!1}),3e5)}showControlError(e){if(this.controlLoadingPlaceholder){this.controlLoadingPlaceholder.innerHTML=`\n                <div class="flex flex-col items-center gap-3">\n                    <i class="fa-solid fa-circle-exclamation fa-2x ${this.theme.fadedText}"></i>\n                    <div class="flex items-center gap-2">\n                        <span class="${this.theme.fadedText}">${e}</span>\n                    </div>\n                    <button class="mt-4 px-4 py-2 rounded-md ${this.theme.buttonPrimary}">\n                        Retry\n                    </button>\n                </div>\n            `;this.controlLoadingPlaceholder.querySelector("button").addEventListener("click",(()=>{this.initializeControlMode()}))}}}customElements.define("workspace-computer",st);class it extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._content="",this._isStreaming=!1,this._startTime=null,this._elapsedTime=0,this._timerInterval=null,this._expanded=!1,this._focusLines=3,this.attachShadow({mode:"open"})}connectedCallback(){this._startTime=this._startTime||new Date,this.render(),this._isStreaming&&this.startTimer()}disconnectedCallback(){this.stopTimer()}static get observedAttributes(){return["content","streaming","elapsed-time"]}attributeChangedCallback(e,t,s){"content"===e&&t!==s?(this._content=s,this.render()):"streaming"===e?(this._isStreaming="true"===s,this._isStreaming?this.startTimer():this.stopTimer(),this.render()):"elapsed-time"===e&&(this._elapsedTime=parseInt(s,10)||0,this.updateTimer())}set content(e){this.setAttribute("content",e)}set streaming(e){this.setAttribute("streaming",e.toString())}set elapsedTime(e){this.setAttribute("elapsed-time",e.toString())}startTimer(){this._startTime=new Date,this.stopTimer(),this._timerInterval=setInterval((()=>{const e=new Date;this._elapsedTime=Math.floor((e-this._startTime)/1e3),this.updateTimer()}),1e3)}stopTimer(){this._timerInterval&&(clearInterval(this._timerInterval),this._timerInterval=null)}updateTimer(){const e=this.shadowRoot.querySelector(".think-timer");e&&(e.textContent=`Thinking ${this._elapsedTime}s`)}toggleExpand(){this._expanded=!this._expanded,this.render()}render(){if(!this.shadowRoot)return;const e=this._content.split("\n").filter((e=>""!==e.trim()));let t=e;!this._expanded&&e.length>2*this._focusLines&&(t=e.slice(0,3*this._focusLines));const s=`\n            :host {\n                display: block;\n                width: 100%;\n                font-family: ${this.theme.fontFamily||"system-ui, sans-serif"};\n                color: ${this.theme.textColor||"#333"};\n                background: ${this.theme.backgroundColor||"#f5f5f5"};\n                border-radius: 8px;\n                margin: 10px 0;\n                overflow: hidden;\n            }\n            \n            .think-container {\n                position: relative;\n                padding: 12px 16px;\n                border: 1px solid ${this.theme.borderColor||"#e0e0e0"};\n                border-radius: 8px;\n            }\n            \n            .think-header {\n                display: flex;\n                justify-content: space-between;\n                align-items: center;\n                margin-bottom: 8px;\n                font-size: 14px;\n                color: ${this.theme.secondaryTextColor||"#666"};\n            }\n            \n            .think-toggle {\n                background: transparent;\n                border: none;\n                cursor: pointer;\n                color: ${this.theme.accentColor||"#0066cc"};\n                font-size: 16px;\n                padding: 0;\n                width: 24px;\n                height: 24px;\n            }\n            \n            .think-content {\n                font-size: 14px;\n                line-height: 1.5;\n                white-space: pre-wrap;\n                overflow: hidden;\n                max-height: ${this._expanded?"none":"12em"};\n                transition: max-height 0.3s ease;\n            }\n            \n            .think-line {\n                padding: 2px 0;\n                transition: opacity 0.3s ease, transform 0.3s ease;\n                transform-origin: 50% 50%;\n            }\n            \n            .opacity-30 { opacity: 0.3; }\n            .opacity-50 { opacity: 0.5; }\n            .opacity-70 { opacity: 0.7; }\n            .opacity-90 { opacity: 0.9; }\n            .opacity-100 { opacity: 1; }\n            \n            .transform-up-3 { transform: translateY(-3.77756px); }\n            .transform-up-2 { transform: translateY(-2.5px); }\n            .transform-up-1 { transform: translateY(-1.25px); }\n            .transform-none { transform: translateY(0); }\n            .transform-down-1 { transform: translateY(1.25px); }\n            .transform-down-2 { transform: translateY(2.5px); }\n            .transform-down-3 { transform: translateY(3.77756px); }\n            \n            .streaming-cursor::after {\n                content: '';\n                display: inline;\n                animation: blink 1s step-end infinite;\n                color: ${this.theme.accentColor||"#0066cc"};\n            }\n            \n            @keyframes blink {\n                0%, 100% { opacity: 1; }\n                50% { opacity: 0; }\n            }\n        `,i=t.map(((e,s)=>{let i="opacity-100",n="transform-none";const a=Math.floor(t.length/2),o=Math.abs(s-a);if(o>3?i="opacity-30":3===o?i="opacity-50":2===o?i="opacity-70":1===o&&(i="opacity-90"),s<a){const e=a-s;e>=3?n="transform-down-3":2===e?n="transform-down-2":1===e&&(n="transform-down-1")}else if(s>a){const e=s-a;e>=3?n="transform-up-3":2===e?n="transform-up-2":1===e&&(n="transform-up-1")}return`<div class="think-line ${i} ${n} ${s===t.length-1&&this._isStreaming?"streaming-cursor":""}">${e}</div>`})).join("");this.shadowRoot.innerHTML=`\n            <style>${s}</style>\n            <div class="think-container">\n                <div class="think-header">\n                    <div class="think-timer">Thinking ${this._elapsedTime}s</div>\n                    <button class="think-toggle" aria-label="${this._expanded?"Collapse":"Expand"}">\n                        ${this._expanded?"":""}\n                    </button>\n                </div>\n                <div class="think-content">\n                    ${i}\n                </div>\n            </div>\n        `;const n=this.shadowRoot.querySelector(".think-toggle");n&&n.addEventListener("click",(()=>this.toggleExpand()))}}customElements.define("think-component",it);class nt{constructor(){M.hide(),this.primaryContent=document.getElementById("primary-content"),this.primaryContent.innerHTML="",this.theme=i.A.theme,this.currentStep=1,this.totalSteps=3,this.agentType=null,this.agentTask="",this.selectedTemplate=null,this.wizardContainer=null,this.contentContainer=null,this.navigationContainer=null,this.nextButton=null,this.backButton=null,this.scrollContainer=null,this.scrollView=null,this.taskInput=null,this.taskInputContainer=null,this.closeButton=null,this.render()}render(){this.primaryContent.innerHTML="";const e=document.createElement("div");e.className="flex flex-col h-full w-full",this.wizardContainer=document.createElement("div"),this.wizardContainer.className=`flex flex-col h-full w-full max-w-4xl mx-auto ${this.theme.text}`;const t=document.createElement("div");t.className="flex items-center justify-center py-8 px-4 sm:px-6 lg:px-8 relative",this.closeButton=new n.$({icon:"fa-solid fa-xmark fa-xl",type:"secondaryTransparent",size:"icon-lg"}),this.closeButton.onClick((()=>this.handleClose()));const s=document.createElement("div");s.className="absolute top-8 right-4 sm:right-6 lg:right-8",this.closeButton.render(s),t.appendChild(s);const i=document.createElement("div");i.className="flex items-center";for(let e=1;e<=this.totalSteps;e++){const t=document.createElement("div");t.className="flex items-center";const s=document.createElement("div");if(s.className=`w-8 h-8 rounded-full flex items-center justify-center ${e<this.currentStep?this.theme.switchOn+" text-white":e===this.currentStep?this.theme.primaryButton:this.theme.unselectedSelector+" "+this.theme.fadedText}`,s.textContent=e,t.appendChild(s),e<this.totalSteps){const s=document.createElement("div");s.className=`w-16 h-1 mx-2 ${e<this.currentStep?this.theme.switchOn:this.theme.unselectedSelector}`,t.appendChild(s)}i.appendChild(t)}t.appendChild(i),this.scrollContainer=document.createElement("div"),this.scrollContainer.className="flex-grow overflow-y-auto",this.contentContainer=document.createElement("div"),this.contentContainer.className="w-full px-4 sm:px-6 lg:px-8 pb-24",this.navigationContainer=document.createElement("div"),this.navigationContainer.className="w-full px-4 sm:px-6 lg:px-8 py-4 absolute bottom-0 left-0 right-0";const a=document.createElement("div");a.className="flex justify-end space-x-4 max-w-4xl mx-auto",1!==this.currentStep&&(this.backButton=new n.$({text:"Back",type:"secondary",size:"large",disabled:!1}),this.backButton.onClick((()=>this.navigateStep(-1)))),this.nextButton=new n.$({text:this.currentStep===this.totalSteps?"Create":"Next",type:"primary",size:"large",disabled:!1}),this.nextButton.onClick((()=>this.navigateStep(1))),this.renderStepContent(),this.scrollContainer.appendChild(this.contentContainer),this.scrollView=new Z(this.scrollContainer),this.wizardContainer.appendChild(t),this.wizardContainer.appendChild(this.scrollContainer),this.currentStep!==this.totalSteps&&(1!==this.currentStep&&this.backButton.render(a),this.nextButton.render(a),this.navigationContainer.appendChild(a),this.wizardContainer.appendChild(this.navigationContainer)),e.appendChild(this.wizardContainer),this.primaryContent.appendChild(e)}handleClose(){new a("Cancel agent creation?","Your progress will be lost if you exit now.").onConfirm((()=>{M.show(),v.view("/agents")}))}renderStepContent(){switch(this.contentContainer.innerHTML="",this.currentStep){case 1:this.renderAgentTypeStep();break;case 2:this.renderAgentTaskStep();break;case 3:this.renderCreatingAgentStep()}}renderAgentTypeStep(){const e=document.createElement("h1");e.className=`text-3xl font-bold mb-8 text-center w-full ${this.theme.text}`,e.textContent="What type of agent do you want to create?";const t=document.createElement("div");t.className="grid grid-cols-1 md:grid-cols-2 gap-6 w-full";const s=this.createAgentTypeOption("Specialized","An agent that works directly with you and your assistant. Use it on command for specific tasks like research, analysis, or drafting content.","task-based","task-based"===this.agentType),i=this.createAgentTypeOption("Autonomous","Operates independently in the background. Once activated, it continuously works towards its assigned goals without requiring direct interaction.","autonomous","autonomous"===this.agentType,!0);t.appendChild(s),t.appendChild(i),this.contentContainer.appendChild(e),this.contentContainer.appendChild(t)}createAgentTypeOption(e,t,s,i,n=!1){const a=document.createElement("div");a.className=`border rounded-lg p-6 cursor-pointer transition-all ${i?`${this.theme.ringSelected} ring-2 shadow-md`:`${this.theme.inputRing} ring-1`} ${this.theme.inputBackground} ${this.theme.backgroundHover}`,a.dataset.value=s;const o=document.createElement("div");o.className="flex justify-between items-start mb-2";const r=document.createElement("h3");if(r.className=`text-xl font-medium ${this.theme.text}`,r.textContent=e,o.appendChild(r),n){const e=document.createElement("div");e.className="inline-block px-3 py-1 rounded-full text-xs font-medium bg-purple-100 text-purple-800",e.textContent="Experimental",o.appendChild(e)}const l=document.createElement("p");return l.className=`${this.theme.fadedText} text-base`,l.textContent=t,a.appendChild(o),a.appendChild(l),a.addEventListener("click",(()=>{this.agentType=s,document.querySelectorAll("[data-value]").forEach((e=>{e.className=`border rounded-lg p-6 cursor-pointer transition-all ${e.dataset.value===s?`${this.theme.ringSelected} ring-2 shadow-md`:`${this.theme.inputRing} ring-1`} ${this.theme.inputBackground} ${this.theme.backgroundHover}`})),this.nextButton.enableButton()})),a}renderAgentTaskStep(){const e=document.createElement("h1");e.className=`text-3xl font-bold mb-4 text-center w-full ${this.theme.text}`,e.textContent="What should this agent do?";const t=document.createElement("div");t.className="mb-12";const s=document.createElement("p");s.className=`${this.theme.text} text-left font-medium text-xl mb-1 w-full mt-8`,s.textContent="Describe the task you want your agent to accomplish:",this.taskInputContainer=document.createElement("div"),this.taskInputContainer.className="w-full relative",this.taskInput=new p({label:"",type:"text",placeholder:"e.g. analyze customer feedback from surveys for key themes and produce a detailed report which include visualizations of the data and conclusions.",rows:5,canGrow:!0,value:this.agentTask,minChar:0,maxChar:2e3,required:!1}),this.taskInput.onChange((e=>{this.selectedTemplate&&(this.selectedTemplate=null,this.updateTemplateSelectionUI()),this.agentTask=e,this.nextButton.enableButton()}));const i=document.createElement("div");i.className=`absolute inset-0 ${this.theme.secondaryBackground} bg-opacity-50 dark:bg-opacity-50 flex items-center justify-center rounded-lg hidden`,i.id="textarea-overlay";const a=document.createElement("div");a.className="text-center p-4";const o=new n.$({text:"Switch to instructions",type:"secondary",size:"small"});o.onClick((()=>{this.selectedTemplate=null,this.updateTemplateSelectionUI(),this.enableTaskInput()})),o.render(a),i.appendChild(a),this.taskInput.render(this.taskInputContainer),this.taskInputContainer.appendChild(i),t.appendChild(s),t.appendChild(this.taskInputContainer);const r=document.createElement("div");r.className="w-full";const l=document.createElement("h2");l.className=`text-xl font-medium mb-4 text-left w-full flex items-center ${this.theme.text}`,l.innerHTML='<span class="mr-2">Or select a starter template:</span>';const c=document.createElement("div");c.className="grid grid-cols-1 md:grid-cols-2 gap-4 w-full";[{title:"Investment research agent",description:"Researches investment ideas using a specific process and data sources.",value:"investment-research"},{title:"RFP responder",description:"Takes a given RFP and completes it using the company's process",value:"rfp-responder"},{title:"Document checker",description:"Checks a document against internal company guidelines e.g. protocol",value:"document-checker"},{title:"Customer support agent",description:"Handles customer inquiries and provides solutions based on company policies.",value:"customer-support"}].forEach((e=>{const t=this.createTemplateOption(e.title,e.description,e.value,this.selectedTemplate===e.value);c.appendChild(t)})),r.appendChild(l),r.appendChild(c),this.contentContainer.appendChild(e),this.contentContainer.appendChild(t),this.contentContainer.appendChild(r),this.updateTemplateSelectionUI()}enableTaskInput(){const e=this.taskInputContainer.querySelector("textarea");e&&(e.disabled=!1,e.focus());const t=document.getElementById("textarea-overlay");t&&t.classList.add("hidden")}disableTaskInput(){const e=this.taskInputContainer.querySelector("textarea");e&&(e.disabled=!0);const t=document.getElementById("textarea-overlay");t&&t.classList.remove("hidden")}updateTemplateSelectionUI(){document.querySelectorAll("[data-template-value]").forEach((e=>{e.className=`border rounded-lg p-4 cursor-pointer transition-all ${e.dataset.templateValue===this.selectedTemplate?`${this.theme.ringSelected} ring-2 shadow-md`:`${this.theme.inputRing} ring-1`} ${this.theme.inputBackground} ${this.theme.backgroundHover}`})),this.selectedTemplate?this.disableTaskInput():this.enableTaskInput()}createTemplateOption(e,t,s,i){const n=document.createElement("div");n.className=`border rounded-lg p-4 cursor-pointer transition-all ${i?`${this.theme.ringSelected} ring-2 shadow-md`:`${this.theme.inputRing} ring-1`} ${this.theme.inputBackground} ${this.theme.backgroundHover}`,n.dataset.templateValue=s;const a=document.createElement("h3");a.className=`text-base font-medium mb-2 ${this.theme.text}`,a.textContent=e;const o=document.createElement("p");return o.className=`${this.theme.fadedText} text-sm`,o.textContent=t,n.appendChild(a),n.appendChild(o),n.addEventListener("click",(()=>{this.selectedTemplate=s,this.agentTask=t,this.updateTemplateSelectionUI(),this.nextButton.enableButton()})),n}renderCreatingAgentStep(){const e=document.createElement("div");e.className="flex flex-col items-center justify-center text-center py-16";const t=document.createElement("h1");t.className=`text-3xl font-bold mb-4 ${this.theme.text}`,t.textContent="Creating your agent...";const s=document.createElement("p");s.className=`${this.theme.fadedText} mb-8`,s.textContent="Won't be a moment. You can customize and test your agent once created.";const i=document.createElement("div");i.className=`w-16 h-16 border-4 ${this.theme.inputBorder} border-t-${this.theme.primaryButton.split(" ")[1]} rounded-full animate-spin mb-8`,e.appendChild(t),e.appendChild(s),e.appendChild(i),this.contentContainer.appendChild(e),setTimeout((()=>{this.createAgent()}),2e3)}navigateStep(e){const t=this.currentStep+e;if(!(t<1||t>this.totalSteps)){if(e>0){if(1===this.currentStep&&!this.agentType)return void new c.y("Please select an agent type","warning",!0,!0);if(2===this.currentStep&&!this.agentTask&&!this.selectedTemplate)return void new c.y("Please describe what your agent should do or select a template","warning",!0,!0)}this.currentStep=t,this.render(),this.scrollContainer&&(this.scrollContainer.scrollTop=0)}}async createAgent(){try{const e={type:this.agentType,task:this.agentTask,template:this.selectedTemplate},t=await g.G.postData("/agents/create/",e);if(!t||!t.success)throw new Error(t?.message||"Failed to create agent");new c.y("Agent created successfully!","success",!0,!0),M.show(),v.view(`/agents/${t.agentId}`)}catch(e){new c.y(e.message||"There was an error creating your agent","error",!0,!0),this.currentStep=2,this.render()}}}var at=s(55778),ot=s.n(at);class rt{constructor(e,t,s,n=null){this.imageElement=e,this.originalSrc=t,this.onSave=s,this.stage=null,this.layer=null,this.bgImage=null,this.annotationData=n,this.theme=i.A.theme,this.annotations=[],this.activeObject=null,this.currentColor="#FF0000",this.currentMode="select",this.isDrawing=!1,this.currentShape=null,this.transformer=null,this.startPos=null,this.editingTextNode=null,this.toolbar=null,this.isDraggingToolbar=!1,this.toolbarDragStart={x:0,y:0},this.initializeCanvas=this.initializeCanvas.bind(this),this.deleteSelected=this.deleteSelected.bind(this),this.saveAnnotations=this.saveAnnotations.bind(this),this.setMode=this.setMode.bind(this),this.startInlineEdit=this.startInlineEdit.bind(this),this.finishInlineEdit=this.finishInlineEdit.bind(this),this.loadAnnotations=this.loadAnnotations.bind(this),this.handleMouseDown=this.handleMouseDown.bind(this),this.handleMouseMove=this.handleMouseMove.bind(this),this.handleMouseUp=this.handleMouseUp.bind(this),this.handleClickTap=this.handleClickTap.bind(this),this.handleDblClick=this.handleDblClick.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.handleResize=this.handleResize.bind(this),this.handleToolbarDragStart=this.handleToolbarDragStart.bind(this),this.handleToolbarDragMove=this.handleToolbarDragMove.bind(this),this.handleToolbarDragEnd=this.handleToolbarDragEnd.bind(this),this.updateTheme=this.updateTheme.bind(this),document.addEventListener("theme-changed",this.updateTheme),this.addAnnotationStyles()}updateTheme(){if(this.theme=i.A.theme,this.addAnnotationStyles(),this.transformer){const e=this.theme.cursorHEX||"#0066ff";this.transformer.borderStroke(e),this.transformer.anchorStroke(e),this.layer?.batchDraw()}const e=document.getElementById("konva-container");e&&(e.className=`canvas-container relative border ${this.theme.inputBorder||"border-gray-300"} rounded-md overflow-hidden ${this.theme.secondaryBackground||"bg-gray-50"} w-full`)}addAnnotationStyles(){const e=document.getElementById("image-annotator-styles");e&&e.remove();const t=document.createElement("style");t.id="image-annotator-styles";this.theme,this.theme,this.theme,this.theme?.menuIconHoverColor?.replace("hover:",""),this.theme,this.theme;t.textContent='\n            .annotation-toolbar {\n                position: absolute;\n                bottom: 10px;\n                left: 50%;\n                transform: translateX(-50%);\n                z-index: 10;\n                border-radius: 0.375rem;\n                box-shadow: 0 2px 5px rgba(0,0,0,0.2);\n                padding: 0.5rem;\n                display: flex;\n                gap: 0.5rem;\n                align-items: center;\n                backdrop-filter: blur(4px);\n                border: 1px solid rgba(209, 213, 219, 0.8);\n                width: fit-content;\n                cursor: move; /* Indicate toolbar is draggable */\n                user-select: none; /* Prevent text selection during drag */\n                touch-action: none; /* Prevent scrolling on touch devices */\n            }\n            .annotation-toolbar::before {\n                content: "";\n                display: flex;\n                align-items: center;\n                margin-right: 4px;\n                color: #6b7280;\n                font-size: 14px;\n                cursor: move;\n            }\n            .annotation-toolbar .tool-btn.active-tool {\n                background-color: #9ca3af; /* bg-gray-400 - Darker for active state */\n                box-shadow: inset 0 2px 4px rgba(0,0,0,0.15); /* Slightly stronger inset shadow */\n                color: #1f2937; /* Darker text for contrast - bg-gray-800 */\n            }\n            .annotation-toolbar .tool-btn.active-tool:hover {\n                 background-color: #9ca3af; /* Keep active background on hover */\n                 box-shadow: inset 0 2px 4px rgba(0,0,0,0.15); /* Keep inset shadow on hover */\n            }\n            .annotation-toolbar .tool-btn {\n                cursor: pointer; /* Ensure buttons have pointer cursor */\n            }\n            .content-editable [tabindex="0"] img {\n                cursor: pointer;\n            }\n            .content-editable [tabindex="0"]:hover::before {\n                content: \'Double-click to annotate\';\n                position: absolute; bottom: 0; left: 0; right: 0;\n                background-color: rgba(0,0,0,0.7); color: white;\n                padding: 2px 6px; text-align: center; font-size: 12px;\n                pointer-events: none; z-index: 1; opacity: 0;\n                transition: opacity 0.2s ease-in-out;\n            }\n             .content-editable [tabindex="0"]:hover:not(:focus-within)::before {\n                 opacity: 1;\n             }\n            .konvajs-content { margin: 0 auto; cursor: default; }\n            .konvajs-content.crosshair-cursor { cursor: crosshair; }\n            .inline-text-editor {\n                position: absolute; display: block; box-sizing: border-box;\n                margin: 0; border: none; padding: 0; background: none;\n                outline: none; resize: none; overflow: hidden;\n                white-space: pre-wrap; user-select: text; z-index: 10;\n                pointer-events: auto; transform-origin: 0 0;\n            }\n            .canvas-container {\n                position: relative;\n            }\n        ',document.head.appendChild(t)}show(){const e=document.createElement("div");e.className="annotation-editor flex flex-col items-center";const t=document.createElement("div");t.className=`canvas-container relative border ${this.theme.inputBorder||"border-gray-300"} rounded-md overflow-hidden ${this.theme.secondaryBackground||"bg-gray-50"} w-full`,t.style.height="500px",t.id="konva-container",this.toolbar=document.createElement("div"),this.toolbar.className=`annotation-toolbar ${this.theme.modalBackground}`;const s=document.createElement("button");s.className=`tool-btn p-2 rounded ${this.theme.menuIconHoverColor||"hover:bg-gray-200"} active-tool w-8 h-8 flex items-center justify-center`,s.innerHTML='<i class="fas fa-mouse-pointer"></i>',s.title="Select / Move (V)",s.dataset.tool="select",s.addEventListener("click",(()=>this.setMode("select")));const i=document.createElement("button");i.className=`tool-btn p-2 rounded ${this.theme.menuIconHoverColor||"hover:bg-gray-200"} w-8 h-8 flex items-center justify-center`,i.innerHTML='<i class="fas fa-vector-square"></i>',i.title="Draw Rectangle (R)",i.dataset.tool="rectangle",i.addEventListener("click",(()=>this.setMode("rectangle")));const n=document.createElement("button");n.className=`tool-btn p-2 rounded ${this.theme.menuIconHoverColor||"hover:bg-gray-200"} w-8 h-8 flex items-center justify-center`,n.innerHTML='<i class="fas fa-font"></i>',n.title="Add Text (T)",n.dataset.tool="text",n.addEventListener("click",(()=>this.setMode("text")));const a=document.createElement("button");a.className=`tool-btn p-2 rounded ${this.theme.menuIconHoverColor||"hover:bg-gray-200"} w-8 h-8 flex items-center justify-center`,a.innerHTML='<i class="fas fa-arrow-right"></i>',a.title="Draw Arrow (A)",a.dataset.tool="arrow",a.addEventListener("click",(()=>this.setMode("arrow")));const o=document.createElement("input");o.type="color",o.value=this.currentColor,o.className="w-8 h-8 rounded cursor-pointer",o.title="Select color",o.addEventListener("input",(e=>{if(this.currentColor=e.target.value,this.activeObject){const e=this.activeObject.getClassName();if("Rect"===e?this.activeObject.stroke(this.currentColor):"Text"===e?this.activeObject.fill(this.currentColor):"Arrow"===e&&(this.activeObject.stroke(this.currentColor),this.activeObject.fill(this.currentColor)),this.editingTextNode&&this.editingTextNode===this.activeObject){this.editingTextNode.fill(this.currentColor);const e=document.getElementById("inline-editor-textarea");e&&(e.style.color=this.currentColor)}this.layer.batchDraw()}})),this.toolbar.appendChild(s),this.toolbar.appendChild(i),this.toolbar.appendChild(n),this.toolbar.appendChild(a),this.toolbar.appendChild(o),this.toolbar.addEventListener("mousedown",this.handleToolbarDragStart),this.toolbar.addEventListener("touchstart",this.handleToolbarDragStart,{passive:!1}),e.appendChild(t),this.modal=new l({title:"",body:e,size:"extraLarge",closeX:!1,confirm:!0,cancel:!0,confirmText:"Save",cancelText:"Cancel",buttonWidth:"full",buttonSize:"large",buttonStyle:"primary"}),this.modal.onConfirm(this.saveAnnotations),this.modal.onClose((()=>{this.finishInlineEdit(!1),document.removeEventListener("keydown",this.handleKeyDown),window.removeEventListener("resize",this.handleResize),document.removeEventListener("mousemove",this.handleToolbarDragMove),document.removeEventListener("mouseup",this.handleToolbarDragEnd),document.removeEventListener("touchmove",this.handleToolbarDragMove),document.removeEventListener("touchend",this.handleToolbarDragEnd),document.removeEventListener("theme-changed",this.updateTheme),this.stage&&(this.stage.destroy(),this.stage=null)})),document.addEventListener("keydown",this.handleKeyDown),window.addEventListener("resize",this.handleResize),setTimeout((()=>{this.initializeCanvas("konva-container")}),50)}handleToolbarDragStart(e){e.preventDefault();const t=e.target;if(t.classList.contains("tool-btn")||"INPUT"===t.tagName||"I"===t.tagName)return;this.isDraggingToolbar=!0,"touchstart"===e.type?this.toolbarDragStart={x:e.touches[0].clientX,y:e.touches[0].clientY}:this.toolbarDragStart={x:e.clientX,y:e.clientY};const s=this.toolbar.getBoundingClientRect(),i=this.toolbar.parentElement.getBoundingClientRect();this.toolbarPosition={left:s.left-i.left,top:s.top-i.top},document.addEventListener("mousemove",this.handleToolbarDragMove),document.addEventListener("mouseup",this.handleToolbarDragEnd),document.addEventListener("touchmove",this.handleToolbarDragMove,{passive:!1}),document.addEventListener("touchend",this.handleToolbarDragEnd)}handleToolbarDragMove(e){if(!this.isDraggingToolbar)return;let t,s;e.preventDefault(),"touchmove"===e.type?(t=e.touches[0].clientX,s=e.touches[0].clientY):(t=e.clientX,s=e.clientY);const i=t-this.toolbarDragStart.x,n=s-this.toolbarDragStart.y,a=this.toolbarPosition.left+i,o=this.toolbarPosition.top+n;this.toolbar.style.left=`${a}px`,this.toolbar.style.top=`${o}px`,this.toolbar.style.transform="none",this.toolbar.style.bottom="auto"}handleToolbarDragEnd(){if(!this.isDraggingToolbar)return;this.isDraggingToolbar=!1;const e=this.toolbar.parentElement.getBoundingClientRect(),t=this.toolbar.getBoundingClientRect();e.left,e.right,t.width,e.top,e.bottom,t.height;let s=parseInt(this.toolbar.style.left,10),i=parseInt(this.toolbar.style.top,10),n=!1;t.left<e.left?(s=10,n=!0):t.right>e.right&&(s=e.width-t.width-10,n=!0),t.top<e.top?(i=10,n=!0):t.bottom>e.bottom&&(i=e.height-t.height-10,n=!0),n&&(this.toolbar.style.left=`${s}px`,this.toolbar.style.top=`${i}px`),document.removeEventListener("mousemove",this.handleToolbarDragMove),document.removeEventListener("mouseup",this.handleToolbarDragEnd),document.removeEventListener("touchmove",this.handleToolbarDragMove),document.removeEventListener("touchend",this.handleToolbarDragEnd)}initializeCanvas(e){const t=document.getElementById(e);if(!t||!t.clientWidth||!t.clientHeight)return void setTimeout((()=>this.initializeCanvas(e)),200);this.stage=new(ot().Stage)({container:e,width:t.clientWidth,height:t.clientHeight}),this.layer=new(ot().Layer),this.stage.add(this.layer);const s=this.theme.cursorHEX||"#0066ff";this.transformer=new(ot().Transformer)({borderStroke:s,borderStrokeWidth:1.5,anchorStroke:s,anchorFill:"#ffffff",anchorSize:8,rotateEnabled:!0,rotationSnaps:[0,45,90,135,180,225,270,315],keepRatio:!1,boundBoxFunc:(e,t)=>{const s=this.transformer.nodes()[0];return s&&"Text"===s.getClassName()&&(t.width<=0||t.height<=0)?e:t}}),this.layer.add(this.transformer),this.transformer.on("transformend",(e=>{const t=e.target;if("Text"===t.getClassName()){const e=t.scaleX(),s=t.scaleY(),i=Math.max(5,t.fontSize()*s);t.scaleX(1),t.scaleY(1),t.fontSize(i),t.width(t.width()*e),t.height(t.height()*s)}else if("Rect"===t.getClassName()){const e=Math.max(5,t.width()*t.scaleX()),s=Math.max(5,t.height()*t.scaleY());t.width(e),t.height(s),t.scaleX(1),t.scaleY(1)}this.layer.batchDraw()})),this.transformer.on("transform",(()=>{const e=this.transformer.nodes()[0];if(e)if(this.editingTextNode&&e===this.editingTextNode){const t=document.getElementById("inline-editor-textarea");t&&(t.style.width=e.width()*e.scaleX()+"px",t.style.height=e.height()*e.scaleY()+"px",this.updateTextareaPosition(e))}else e.getClassName()}));const i=new Image;i.crossOrigin="anonymous",i.onload=()=>{this.bgImage=new(ot().Image)({image:i,x:0,y:0,width:i.width,height:i.height,draggable:!1,listening:!1}),this.layer.add(this.bgImage),this.bgImage.moveToBottom(),this.handleResize(),this.annotationData&&this.loadAnnotations(this.annotationData),this.setupEventHandlers(),this.layer.draw(),t.appendChild(this.toolbar)},i.onerror=e=>{new c.y("Failed to load image for annotation","error",!0,!1),this.modal.close()},i.src=this.originalSrc}handleResize(){if(!this.stage||!this.bgImage)return;const e=this.stage.container();if(!e)return;const t=this.storeAnnotationRelativePositions(),s=e.clientWidth,i=e.clientHeight;this.stage.width(s),this.stage.height(i);const n=this.bgImage.image();if(!n)return;const a=s-40,o=i-40,r=Math.min(a/n.width,o/n.height),l=n.width*r,c=n.height*r;this.bgImage.setAttrs({scaleX:r,scaleY:r,x:(s-l)/2,y:(i-c)/2}),this.repositionAnnotationsAfterResize(t),this.editingTextNode&&this.updateTextareaPosition(this.editingTextNode),this.layer.batchDraw()}storeAnnotationRelativePositions(){if(!this.bgImage||!this.annotations.length)return[];const e=this.bgImage.scaleX(),t=this.bgImage.scaleY(),s=this.bgImage.x(),i=this.bgImage.y(),n=this.bgImage.image().width*e,a=this.bgImage.image().height*t;return this.annotations.map((e=>{const t=e.getAttrs(),o=e.getClassName();let r;if("Text"===o||"Rect"===o)r={type:o,id:e.id(),x:(t.x-s)/n,y:(t.y-i)/a,width:t.width?t.width*e.scaleX()/n:null,height:t.height?t.height*e.scaleY()/a:null,rotation:t.rotation||0};else if("Arrow"===o){const l=t.points,c=[];for(let e=0;e<l.length;e+=2)c.push((l[e]-s)/n,(l[e+1]-i)/a);r={type:o,id:e.id(),points:c}}return r}))}repositionAnnotationsAfterResize(e){if(!this.bgImage||!e||!e.length)return;const t=this.bgImage.scaleX(),s=this.bgImage.scaleY(),i=this.bgImage.x(),n=this.bgImage.y(),a=this.bgImage.image().width*t,o=this.bgImage.image().height*s;e.forEach((e=>{if(!e)return;const t=this.annotations.find((t=>t.id()===e.id));if(t)if("Text"===e.type||"Rect"===e.type){const s=i+e.x*a,r=n+e.y*o;if(t.x(s),t.y(r),null!==e.width&&null!==e.height){const s=e.width*a,i=e.height*o;if("Text"===e.type){const e=s/(t.width()*t.scaleX());1!==e&&t.fontSize(t.fontSize()*e)}t.width(s),t.height(i),t.scaleX(1),t.scaleY(1)}e.rotation&&t.rotation(e.rotation)}else if("Arrow"===e.type){const s=[];for(let t=0;t<e.points.length;t+=2)s.push(i+e.points[t]*a,n+e.points[t+1]*o);t.points(s)}}))}setupEventHandlers(){this.stage.off("mousedown touchstart mousemove touchmove mouseup touchend click tap dblclick dbltap"),this.stage.on("mousedown touchstart",this.handleMouseDown),this.stage.on("mousemove touchmove",this.handleMouseMove),this.stage.on("mouseup touchend",this.handleMouseUp),this.stage.on("click tap",this.handleClickTap),this.stage.on("dblclick dbltap",this.handleDblClick),this.transformer.on("mousedown touchstart",(e=>{e.cancelBubble=!0}))}handleMouseDown(e){if(this.editingTextNode&&e.target!==this.editingTextNode&&!e.target.getParent()?.hasName("transformer")){const t=document.getElementById("inline-editor-textarea");t&&e.evt.target!==t&&this.finishInlineEdit(!0)}if(e.target!==this.stage&&e.target!==this.bgImage&&e.target.hasName("annotation")&&"select"===this.currentMode&&!this.editingTextNode)return this.activeObject=e.target,this.transformer.nodes([e.target]),void this.layer.draw();if(e.target===this.stage||e.target===this.bgImage){if("select"===this.currentMode)return this.transformer.nodes([]),this.activeObject=null,void this.layer.draw();if("rectangle"===this.currentMode||"arrow"===this.currentMode){this.isDrawing=!0,this.startPos=this.stage.getPointerPosition(),this.transformer.nodes([]);const e={stroke:this.currentColor,strokeWidth:2,draggable:!0,name:"annotation"};"rectangle"===this.currentMode?this.currentShape=new(ot().Rect)({...e,x:this.startPos.x,y:this.startPos.y,width:0,height:0}):this.currentShape=new(ot().Arrow)({...e,points:[this.startPos.x,this.startPos.y,this.startPos.x,this.startPos.y],pointerLength:10,pointerWidth:10,fill:this.currentColor}),this.layer.add(this.currentShape)}}}handleMouseMove(e){if(!this.isDrawing||!this.currentShape)return;const t=this.stage.getPointerPosition();"rectangle"===this.currentMode?(this.currentShape.width(t.x-this.startPos.x),this.currentShape.height(t.y-this.startPos.y)):"arrow"===this.currentMode&&this.currentShape.points([this.startPos.x,this.startPos.y,t.x,t.y]),this.layer.batchDraw()}handleMouseUp(e){if("text"===this.currentMode&&!this.isDrawing&&(e.target===this.stage||e.target===this.bgImage)){const e=this.stage.getPointerPosition();return this.editingTextNode&&this.finishInlineEdit(!0),void this.createText(e)}if(!this.isDrawing||!this.currentShape)return void(this.isDrawing=!1);this.isDrawing=!1;let t=this.currentShape;if(this.currentShape=null,"Rect"===t.getClassName())t.width()<0&&(t.x(t.x()+t.width()),t.width(-t.width())),t.height()<0&&(t.y(t.y()+t.height()),t.height(-t.height())),(t.width()<5||t.height()<5)&&(t.destroy(),t=null);else if("Arrow"===t.getClassName()){const e=t.points(),s=e[2]-e[0],i=e[3]-e[1];Math.sqrt(s*s+i*i)<10&&(t.destroy(),t=null)}t&&(this.annotations.push(t),this.activeObject=t,this.transformer.nodes([t])),this.layer.draw()}handleClickTap(e){this.editingTextNode||("select"===this.currentMode&&e.target!==this.stage&&e.target!==this.bgImage&&e.target.hasName("annotation")?1===this.transformer.nodes().length&&this.transformer.nodes()[0]===e.target||(this.activeObject=e.target,this.transformer.nodes([e.target]),this.layer.draw()):"select"!==this.currentMode||e.target!==this.stage&&e.target!==this.bgImage||this.transformer.nodes().length>0&&(this.transformer.nodes([]),this.activeObject=null,this.layer.draw()))}handleDblClick(e){!this.editingTextNode&&"Text"===e.target.getClassName()&&e.target.hasName("annotation")&&this.startInlineEdit(e.target),e.target!==this.stage&&e.target!==this.bgImage&&e.evt.preventDefault()}createText(e){this.editingTextNode&&this.finishInlineEdit(!0);const t=this.theme.text&&this.theme.text.startsWith("text-")?getComputedStyle(document.documentElement).getPropertyValue(`--${this.theme.text.substring(5)}`):this.currentColor,s=new(ot().Text)({x:e.x,y:e.y,text:"Type here...",fontSize:16,fontFamily:"Arial",fill:t||this.currentColor,draggable:!0,name:"annotation",padding:5,wrap:"char",width:150,lineHeight:1.2});this.layer.add(s),this.annotations.push(s),this.activeObject=s,this.startInlineEdit(s,!0)}setMode(e){this.editingTextNode&&"select"!==e&&"text"!==e&&this.finishInlineEdit(!0),this.currentMode=e;const t=this.stage?.container()?.querySelector(".konvajs-content");if(t&&t.classList.toggle("crosshair-cursor",["rectangle","arrow","text"].includes(e)),!this.toolbar)return;this.toolbar.querySelectorAll(".tool-btn").forEach((e=>e.classList.remove("active-tool")));const s=this.toolbar.querySelector(`.tool-btn[data-tool="${e}"]`);s&&s.classList.add("active-tool"),"select"!==e&&this.transformer?(this.transformer.nodes([]),this.activeObject=null,this.layer.draw()):"select"===e&&this.activeObject&&(this.transformer.nodes([this.activeObject]),this.layer.draw())}deleteSelected(){if(!this.activeObject)return;this.editingTextNode&&this.activeObject===this.editingTextNode&&this.finishInlineEdit(!1);const e=this.activeObject;this.annotations=this.annotations.filter((t=>t!==e)),this.transformer.nodes([]),e.destroy(),this.activeObject=null,this.layer.draw()}handleKeyDown(e){const t=document.getElementById("inline-editor-textarea");if(t&&document.activeElement===t)"Escape"===e.key?(e.preventDefault(),this.finishInlineEdit(!1)):"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.finishInlineEdit(!0));else if(this.editingTextNode)"Escape"===e.key&&(e.preventDefault(),this.finishInlineEdit(!1));else{if(("Delete"===e.key||"Backspace"===e.key)&&this.activeObject){const t=document.activeElement;t&&(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)||t.isContentEditable)||(e.preventDefault(),this.deleteSelected())}const t=document.activeElement;if(!(t&&(["INPUT","TEXTAREA","SELECT"].includes(t.tagName)||t.isContentEditable)))switch(e.key.toLowerCase()){case"v":this.setMode("select");break;case"r":this.setMode("rectangle");break;case"t":this.setMode("text");break;case"a":this.setMode("arrow");break;case"escape":this.activeObject?(this.transformer.nodes([]),this.activeObject=null,this.layer.draw()):"select"!==this.currentMode&&this.setMode("select")}}}startInlineEdit(e,t=!1){if(this.editingTextNode){if(this.editingTextNode===e)return;this.finishInlineEdit(!0)}this.editingTextNode=e,e.hide(),this.transformer.nodes([e]),this.transformer.setAttrs({enabledAnchors:["middle-left","middle-right"],rotateEnabled:!1,borderEnabled:!0,keepRatio:!1}),this.transformer.forceUpdate();const s=document.createElement("textarea");s.id="inline-editor-textarea",s.value="Type here..."===e.text()?"":e.text(),s.className="inline-text-editor",s.style.fontSize=e.fontSize()+"px",s.style.fontFamily=e.fontFamily(),s.style.color=e.fill(),s.style.lineHeight=e.lineHeight(),s.style.textAlign=e.align(),s.style.padding=e.padding()+"px",this.stage.container().appendChild(s),this.updateTextareaPosition(e),s.focus(),(t||"Type here..."===e.text())&&s.select(),s.addEventListener("input",(()=>{e.text(s.value),s.style.height="auto",s.style.height=s.scrollHeight+"px",e.height(s.scrollHeight),this.updateTextareaPosition(e)})),s.addEventListener("mousedown",(e=>e.stopPropagation())),s.addEventListener("touchstart",(e=>e.stopPropagation())),this.layer.draw()}updateTextareaPosition(e){const t=document.getElementById("inline-editor-textarea");if(!t||!e)return;const s=e.absolutePosition(),i=e.rotation(),n=e.scaleX(),a=e.scaleY(),o=e.width()*n,r=e.height()*a;t.style.position="absolute",t.style.top=s.y+"px",t.style.left=s.x+"px",t.style.width=o+"px",t.style.height=r+"px",t.style.transform=`rotate(${i}deg)`,t.style.transformOrigin="0 0",t.style.fontSize=e.fontSize()*a+"px"}finishInlineEdit(e){const t=document.getElementById("inline-editor-textarea"),s=this.editingTextNode;if(t&&s){if(t.parentNode.removeChild(t),e){let e=t.value.trim();""===e&&(e="Text"),s.text(e)}else""!==s.text().trim()&&"Type here..."!==s.text()||s.text("Text");s.show(),this.editingTextNode=null,this.transformer.setAttrs({enabledAnchors:null,rotateEnabled:!0,borderEnabled:!0,keepRatio:!1}),this.transformer.forceUpdate(),this.activeObject=s,this.transformer.nodes([s]),this.setMode("select"),this.layer.draw()}else this.editingTextNode=null}saveAnnotations(){if(this.editingTextNode&&this.finishInlineEdit(!0),!this.stage||!this.layer||!this.bgImage)return;this.transformer.nodes([]),this.layer.draw();const e=this.bgImage.getClientRect({relativeTo:this.stage}),t=this.stage.toDataURL({x:e.x,y:e.y,width:e.width,height:e.height,pixelRatio:2,mimeType:"image/png"}),s=this.bgImage.scaleX(),i=this.bgImage.scaleY(),n=this.bgImage.x(),a=this.bgImage.y(),o=(e,t)=>({x:(e-n)/s,y:(t-a)/i}),r=(e,t)=>({w:e/s,h:t/i}),l=e=>{const t=[];for(let s=0;s<e.length;s+=2){const i=o(e[s],e[s+1]);t.push(i.x,i.y)}return t},c={objects:this.annotations.map((e=>{const t=e.getClassName();1===e.scaleX()&&1===e.scaleY()||("Text"===t?(e.fontSize(e.fontSize()*e.scaleY()),e.width(e.width()*e.scaleX()),e.height(e.height()*e.scaleY())):"Rect"===t&&(e.width(e.width()*e.scaleX()),e.height(e.height()*e.scaleY())),e.scaleX(1),e.scaleY(1));const s=e.getAttrs(),i=s.width||0,n=s.height||0;let a={type:t,rotation:s.rotation||0};if("Text"===t){const e=o(s.x,s.y),t=r(i,n);a={...a,x:e.x,y:e.y,text:s.text,fontSize:s.fontSize,fontFamily:s.fontFamily,fill:s.fill,width:t.w,height:t.h,padding:s.padding,wrap:s.wrap,align:s.align,lineHeight:s.lineHeight}}else if("Rect"===t){const e=o(s.x,s.y),t=r(i,n);a={...a,x:e.x,y:e.y,width:t.w,height:t.h,stroke:s.stroke,strokeWidth:s.strokeWidth}}else{if("Arrow"!==t)return null;a={...a,points:l(s.points),pointerLength:s.pointerLength,pointerWidth:s.pointerWidth,fill:s.fill,stroke:s.stroke,strokeWidth:s.strokeWidth}}return a})).filter(Boolean)};"function"==typeof this.onSave&&this.onSave(t,c),this.modal.close()}loadAnnotations(e){if(!(this.stage&&this.layer&&this.bgImage&&e&&e.objects))return;if(!this.bgImage.scaleX())return void setTimeout((()=>this.loadAnnotations(e)),100);this.annotations.length>0&&(this.transformer?.nodes([]),this.activeObject=null,this.annotations.forEach((e=>{e&&e.destroy&&e.destroy()})),this.annotations=[]),this.layer.draw();const t=this.bgImage.scaleX(),s=this.bgImage.scaleY(),i=this.bgImage.x(),n=this.bgImage.y(),a=(e,a)=>({x:e*t+i,y:a*s+n}),o=(e,i)=>({w:e*t,h:i*s}),r=e=>{const t=[];for(let s=0;s<e.length;s+=2){const i=a(e[s],e[s+1]);t.push(i.x,i.y)}return t},l=Date.now().toString();e.objects.forEach(((e,t)=>{if(!e||!e.type)return;let s,i={draggable:!0,name:"annotation",rotation:e.rotation||0,id:`anno_${l}_${t}`};if("Text"===e.type){const t=a(e.x,e.y),n=o(e.width||100,e.height||18),r=e.fill||(this.theme.text&&this.theme.text.startsWith("text-")?getComputedStyle(document.documentElement).getPropertyValue(`--${this.theme.text.substring(5)}`):"#000000");s=new(ot().Text)({...i,x:t.x,y:t.y,text:e.text,fontSize:e.fontSize||16,fontFamily:e.fontFamily||"Arial",fill:r,padding:e.padding??5,wrap:e.wrap??"word",width:n.w,height:n.h,align:e.align??"left",lineHeight:e.lineHeight??1.2}),s.on("dblclick dbltap",(()=>this.startInlineEdit(s)))}else if("Rect"===e.type){const t=a(e.x,e.y),n=o(e.width,e.height);s=new(ot().Rect)({...i,x:t.x,y:t.y,width:n.w,height:n.h,stroke:e.stroke,strokeWidth:e.strokeWidth})}else"Arrow"===e.type&&(s=new(ot().Arrow)({...i,points:r(e.points),pointerLength:e.pointerLength,pointerWidth:e.pointerWidth,fill:e.fill,stroke:e.stroke,strokeWidth:e.strokeWidth}));s&&(this.layer.add(s),this.annotations.push(s))})),this.layer.draw()}}class lt{constructor(e){this.config=e||{},this.container=null,this.editableWrapper=null,this.editableDiv=null,this.label=null,this.tooltipElement=null,this.userEnteredText=this.config.value||"",this.currentSuggestion=null,this.suggestionSpan=null,this.debounceTimer=null,this.imageUploadInProgress=!1,this.onChangeCallback=null,this.onImageUploadCallback=null,this.validate=this.validate.bind(this),this.handleInput=this.handleInput.bind(this),this.removeSuggestion=this.removeSuggestion.bind(this),this.applySuggestion=this.applySuggestion.bind(this),this.placeCaretAtEnd=this.placeCaretAtEnd.bind(this),this.handleKeyDown=this.handleKeyDown.bind(this),this.init()}init(){this.container=document.createElement("div"),this.container.classList.add("space-y-2"),this.config.label&&(this.label=document.createElement("label"),this.label.classList=`${i.A.theme.text} font-medium`,this.label.textContent=this.config.label,this.container.appendChild(this.label)),this.editableWrapper=document.createElement("div"),this.editableWrapper.className=`content-editable-wrapper rounded-md ring-1 ring-inset ${i.A.theme.inputRing} ${i.A.theme.inputBackground} ${this.config.height||"min-h-[100px]"} w-full`,this.editableDiv=document.createElement("div"),this.editableDiv.className=`content-editable ${i.A.theme.inputText} outline-none p-3 w-full h-full`,this.editableDiv.contentEditable=!this.config.disabled,this.editableDiv.dataset.placeholder=this.config.placeholder||"",this.editableDiv.innerHTML=this.userEnteredText,this.userEnteredText||this.editableDiv.classList.add("empty"),this.setupEventListeners(),this.addStyles(),this.editableWrapper.appendChild(this.editableDiv),this.container.appendChild(this.editableWrapper)}setupEventListeners(){this.editableDiv.addEventListener("focus",(()=>{""===this.userEnteredText&&this.editableDiv.classList.add("empty"),this.editableWrapper.classList.add("focused")})),this.editableDiv.addEventListener("blur",(()=>{""===this.userEnteredText?this.editableDiv.classList.add("empty"):this.editableDiv.classList.remove("empty"),this.editableWrapper.classList.remove("focused"),this.removeSuggestion(),this.userEnteredText=this.config.enableImageUpload?this.editableDiv.innerHTML:this.editableDiv.textContent,this.config.required&&this.validate()})),this.editableDiv.addEventListener("input",(()=>{this.removeSuggestion(),this.userEnteredText=this.config.enableImageUpload?this.editableDiv.innerHTML:this.editableDiv.textContent,""===this.editableDiv.textContent.trim()?this.editableDiv.classList.add("empty"):this.editableDiv.classList.remove("empty"),this.onChangeCallback&&this.onChangeCallback(this.userEnteredText),!1!==this.config.enableSuggestions&&(clearTimeout(this.debounceTimer),this.debounceTimer=setTimeout((()=>this.handleInput()),500))})),this.editableDiv.addEventListener("keydown",this.handleKeyDown),!1!==this.config.enableImageUpload&&this.setupImageDragDrop()}setupImageDragDrop(){let e=!1;this.editableDiv.addEventListener("dragover",(t=>{t.preventDefault(),t.stopPropagation();const s=t.dataTransfer.types;if(s&&(s.includes("Files")||s.includes("application/x-moz-file"))){const s=t.dataTransfer.items||t.dataTransfer.files;if(s&&s.length>0){let t=!1;for(let e=0;e<s.length;e++){const i=s[e];if(i.type&&i.type.match("image.*")||"file"===i.kind&&i.type.match("image.*")){t=!0;break}}if(t){e=!0,this.editableDiv.classList.add("drag-over");let t=this.editableDiv.closest(".process-step-item");t&&(t.dataset.imageDragActive="true")}}}})),this.editableDiv.addEventListener("dragleave",(t=>{if(!this.editableDiv.contains(t.relatedTarget)){this.editableDiv.classList.remove("drag-over"),e=!1;let t=this.editableDiv.closest(".process-step-item");t&&delete t.dataset.imageDragActive}})),this.editableDiv.addEventListener("drop",(async t=>{t.preventDefault(),t.stopPropagation(),this.editableDiv.classList.remove("drag-over"),e=!1;let s=this.editableDiv.closest(".process-step-item");s&&delete s.dataset.imageDragActive;const i=t.dataTransfer.files;if(!i.length)return;const n=i[0];if(n.type.match("image.*"))try{const e=`img-${Date.now()}`,t=URL.createObjectURL(n),s=document.createElement("span");s.className="relative inline-block my-2",s.id=`wrapper-${e}`,s.contentEditable="false",s.tabIndex=0;const i=document.createElement("img");i.src=t,i.className="editor-image",i.id=e,i.setAttribute("data-selectable","true");const a=document.createElement("div");a.className="absolute inset-0 flex items-center justify-center bg-black bg-opacity-30 rounded pointer-events-auto",a.id=`spinner-${e}`,a.contentEditable="false";const o=document.createElement("div");o.className="w-8 h-8 border-4 border-white border-t-transparent rounded-full animate-spin pointer-events-none",o.contentEditable="false",a.appendChild(o);const r=window.getSelection();if(r.rangeCount){r.getRangeAt(0).insertNode(s)}else this.editableDiv.appendChild(s);s.appendChild(i),s.appendChild(a),this.setupImageSelection(s),this.userEnteredText=this.editableDiv.innerHTML,this.editableDiv.classList.remove("empty"),this.onChangeCallback&&this.onChangeCallback(this.userEnteredText),setTimeout((()=>{const t=document.getElementById(`spinner-${e}`);t&&t.remove(),this.userEnteredText=this.editableDiv.innerHTML,this.onChangeCallback&&this.onChangeCallback(this.userEnteredText)}),800)}catch(e){new c.y("Failed to process image","error",!0,!1)}else new c.y("Only images can be dropped","error",!0,!1)}))}setupImageSelection(e){e.addEventListener("click",(t=>{t.stopPropagation();this.editableDiv.querySelectorAll(".image-selected").forEach((e=>{e.classList.remove("image-selected"),e.classList.remove("ring-2","ring-primary-500","ring-offset-2")})),e.classList.add("image-selected"),e.classList.add("ring-2","ring-primary-500","ring-offset-2","transition-all"),e.focus()})),e.addEventListener("dblclick",(t=>{t.stopPropagation();const s=e.querySelector("img");if(!s)return;const i=s.src,n=s.dataset.annotationData?JSON.parse(s.dataset.annotationData):null,a=new rt(s,i,((e,t)=>{s.src=e,s.dataset.annotationData=JSON.stringify(t),this.userEnteredText=this.editableDiv.innerHTML,this.onChangeCallback&&this.onChangeCallback(this.userEnteredText)}));n&&(a.annotationData=n),a.show()})),e.addEventListener("keydown",(t=>{"Delete"!==t.key&&"Backspace"!==t.key||(t.preventDefault(),t.stopPropagation(),e.remove(),this.userEnteredText=this.editableDiv.innerHTML,""!==this.editableDiv.textContent.trim()||this.editableDiv.querySelector("img")||this.editableDiv.classList.add("empty"),this.onChangeCallback&&this.onChangeCallback(this.userEnteredText))})),document.addEventListener("click",(t=>{e.contains(t.target)||(e.classList.remove("image-selected"),e.classList.remove("ring-2","ring-primary-500","ring-offset-2"))}))}async defaultImageUploadHandler(e){return new Promise(((t,s)=>{const i=new FileReader;i.onload=e=>{setTimeout((()=>{t(e.target.result)}),800+800*Math.random())},i.onerror=()=>s(new Error("Failed to read image file")),i.readAsDataURL(e)}))}handleKeyDown(e){return"Tab"===e.key&&this.currentSuggestion?(e.preventDefault(),this.applySuggestion(),!1):"Escape"===e.key&&this.currentSuggestion?(e.preventDefault(),this.removeSuggestion(),!1):void(["ArrowLeft","ArrowRight","ArrowUp","ArrowDown","Backspace","Delete"].includes(e.key)&&this.removeSuggestion())}async handleInput(){const e=this.editableDiv.textContent.trim();if(e.length>3&&!1!==this.config.enableSuggestions)try{const t=await this.fetchSuggestions(e);if(t&&t.length>0){const s=t[0];s.startsWith(e)&&(this.currentSuggestion=s.substring(e.length),this.suggestionSpan=document.createElement("span"),this.suggestionSpan.className="suggestion-text",this.suggestionSpan.textContent=this.currentSuggestion,this.editableDiv.appendChild(this.suggestionSpan),this.showTooltip())}}catch(e){}}async fetchSuggestions(e){await new Promise((e=>setTimeout(e,200+200*Math.random())));const t=[{match:"analyze",complete:e+" the input data to identify key patterns and extract valuable insights"},{match:"review",complete:e+" all inputs for completeness and accuracy before proceeding to the next step"},{match:"generate",complete:e+" a comprehensive report with actionable recommendations based on the analysis"},{match:"collect",complete:e+" all necessary information from available sources, ensuring data is complete and valid"},{match:"implement",complete:e+" the solution based on the requirements and constraints identified earlier"},{match:"validate",complete:e+" that all inputs meet the required specifications and business rules"},{match:"calculate",complete:e+" the key metrics using the standard formulas defined in the documentation"},{match:"classify",complete:e+" the input into appropriate categories based on the predefined taxonomy"},{match:"synthesize",complete:e+" information from multiple sources to create a coherent view of the situation"}],s=e.split(". ").pop().split(" ").slice(-3).join(" ");for(const e of t)if(s.toLowerCase().includes(e.match))return[e.complete];return e.toLowerCase().includes("the agent will")?[e+" process the request and provide a response based on the available information"]:e.toLowerCase().includes("in this step")?[e+" we'll ensure all the necessary data is properly validated and prepared for analysis"]:[e+" to ensure the highest quality of results while maintaining efficient processing",e+" and provide clear, actionable insights based on the analysis"]}showTooltip(){if(this.tooltipElement)return;this.tooltipElement=document.createElement("div"),this.tooltipElement.className="suggestion-tooltip",this.tooltipElement.innerHTML="<kbd>Tab</kbd> to accept  <kbd>Esc</kbd> to dismiss";const e=this.editableDiv.getBoundingClientRect();this.tooltipElement.style.top=e.top-30+"px",this.tooltipElement.style.left=`${e.left}px`,document.body.appendChild(this.tooltipElement)}removeTooltip(){this.tooltipElement&&(document.body.removeChild(this.tooltipElement),this.tooltipElement=null)}removeSuggestion(){this.suggestionSpan&&(this.suggestionSpan.remove(),this.suggestionSpan=null,this.currentSuggestion=null,this.removeTooltip())}applySuggestion(){this.currentSuggestion&&(this.userEnteredText+=this.currentSuggestion,this.editableDiv.textContent="",this.editableDiv.textContent=this.userEnteredText,this.removeSuggestion(),this.placeCaretAtEnd(),this.editableDiv.classList.remove("empty"),this.onChangeCallback&&this.onChangeCallback(this.userEnteredText))}placeCaretAtEnd(){const e=document.createRange(),t=window.getSelection();e.selectNodeContents(this.editableDiv),e.collapse(!1),t.removeAllRanges(),t.addRange(e)}addStyles(){if(document.getElementById("rich-text-editor-styles"))return;const e=document.createElement("style");e.id="rich-text-editor-styles",e.textContent=`\n            .content-editable-wrapper {\n                position: relative;\n                transition: all 0.2s;\n            }\n            \n            .content-editable-wrapper.focused {\n                ring-color: ${i.A.theme.inputFocus.replace("focus:ring-","")};\n                box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);\n            }\n            \n            .content-editable.empty::before {\n                content: attr(data-placeholder);\n                color: #9ca3af; /* gray-400 */\n                position: absolute;\n                pointer-events: none;\n            }\n            \n            .suggestion-text {\n                color: #9ca3af; /* gray-400 */\n                font-style: italic;\n            }\n            \n            .suggestion-tooltip {\n                position: fixed;\n                background-color: #1f2937; /* gray-800 */\n                color: white;\n                padding: 4px 8px;\n                border-radius: 4px;\n                font-size: 12px;\n                z-index: 50;\n                pointer-events: none;\n                box-shadow: 0 2px 4px rgba(0,0,0,0.1);\n            }\n            \n            .suggestion-tooltip kbd {\n                background-color: #374151; /* gray-700 */\n                border-radius: 3px;\n                border: 1px solid #4b5563; /* gray-600 */\n                padding: 1px 4px;\n                font-family: monospace;\n            }\n            \n            .content-editable.drag-over {\n                background-color: #eff6ff; /* blue-50 */\n                border-color: #3b82f6; /* blue-500 */\n                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3);\n            }\n            \n            .editor-image {\n                display: inline-block;\n                max-width: 100%;\n                max-height: 200px;\n                border-radius: 0.375rem;\n            }\n            \n           \n        `,document.head.appendChild(e)}render(e){if(!e)return null;e.appendChild(this.container)}validate(){const e=(this.config.enableImageUpload?this.editableDiv.textContent.trim():this.userEnteredText.trim()).length;if(this.config.required&&0===e)return new c.y(this.config.error||"This field is required","error",!0,!1),!1;if(this.config.minChar&&e<this.config.minChar){let e="this field";return this.config&&this.config.label&&(e=this.config.label),new c.y(`Please enter at least ${this.config.minChar} characters for ${e}`,"error",!0,!1),!1}if(this.config.maxChar&&e>this.config.maxChar){let e="this field";return this.config&&this.config.label&&(e=this.config.label),new c.y(`Please enter no more than ${this.config.maxChar} characters for ${e}`,"error",!0,!1),!1}return!0}onChange(e){"function"==typeof e&&(this.onChangeCallback=e)}onImageUpload(e){"function"==typeof e&&(this.onImageUploadCallback=e)}disable(){this.editableDiv.contentEditable=!1,this.editableDiv.classList.add("opacity-50")}enable(){this.editableDiv.contentEditable=!0,this.editableDiv.classList.remove("opacity-50")}focus(){this.editableDiv.focus(),this.placeCaretAtEnd()}get value(){return this.userEnteredText}set value(e){this.userEnteredText=e||"",this.editableDiv.innerHTML=this.userEnteredText,this.userEnteredText?this.editableDiv.classList.remove("empty"):this.editableDiv.classList.add("empty")}get textContent(){return this.editableDiv.textContent}get html(){return this.editableDiv.innerHTML}}class ct{constructor(e,t){this.agentId=e,this.container=t,this.container&&(this.theme=i.A.theme,this.agent=null,this.isLoading=!0,this.activeTab="training",this.processSteps=[],this.inputFields=[],this.outputFields=[],this.skills=[],this.knowledgeSources=[],this.history=[],this.historyIndex=-1,this.contentContainer=null,this.scrollContainer=null,this.scrollView=null,this.sortableInstance=null)}async init(){this.container&&(this.container.innerHTML="",await this.fetchAgentData())}async fetchAgentData(){try{this.isLoading=!0,this.render(),await new Promise((e=>setTimeout(e,1e3)));const e={success:!0,agent:{id:this.agentId,name:"PHD Researcher",description:"An AI agent that analyzes investment opportunities and provides personalized recommendations based on client preferences and market conditions.",type:"task-based",avatar:null,color:"blue",responseStyle:"professional",maxTokens:4e3,monthlyTokenBudget:1e6,maxTimeToComplete:30,expectedTimeToComplete:15,timeoutBehavior:"extend",restrictKnowledge:!1,processSteps:[{id:"step1",title:"Gather and validate client information",description:"Collect all required client information including investment type, risk tolerance, and timeframe. Validate that all inputs are complete and within expected ranges. Ask clarification questions if any information is missing or unclear.",requiredSkills:["data_validation","client_communication"],duration:2,attachments:[]},{id:"step2",title:"Analyze market conditions",description:"Access current market data and analyze trends relevant to the client's investment interests. Consider economic indicators, sector performance, and market volatility in relation to the client's risk tolerance.",requiredSkills:["market_analysis","data_interpretation","trend_forecasting"],duration:5,attachments:[{id:"attachment1",type:"image",name:"Market analysis diagram",description:"Visual representation of market analysis process",url:"https://res.cloudinary.com/dimqqmfx6/image/upload/v1743373754/u0330222902_Screenshot2025-03-31at9.28.54am_stxunw.png"}]},{id:"step3",title:"Generate investment recommendations",description:"Based on client information and market analysis, generate tailored investment recommendations. Include specific asset allocations, expected returns, and risk assessments. Ensure recommendations align with client's timeframe and risk tolerance.",requiredSkills:["portfolio_construction","risk_assessment","return_forecasting"],duration:8,attachments:[]}],inputFields:[{id:"input1",name:"Investment type",required:!0,askClarification:!0},{id:"input2",name:"Risk tolerance (1-10)",required:!0,askClarification:!0},{id:"input3",name:"Investment timeframe",required:!0,askClarification:!0},{id:"input4",name:"Investment amount",required:!1,askClarification:!1}],outputFields:[{id:"output1",name:"Investment recommendations"},{id:"output2",name:"Risk assessment"},{id:"output3",name:"Expected returns"}],skills:[{id:"skill1",name:"Market Analysis",icon:"chart-line",description:"Ability to analyze current market conditions, trends, and economic indicators.",tags:["Financial Data","Trend Analysis","Economic Indicators"]},{id:"skill2",name:"Risk Assessment",icon:"balance-scale",description:"Evaluate investment risks based on market volatility, asset class, and client risk tolerance.",tags:["Risk Modeling","Volatility Analysis","Scenario Testing"]},{id:"skill3",name:"Portfolio Construction",icon:"briefcase",description:"Create balanced investment portfolios with optimal asset allocation based on client goals.",tags:["Asset Allocation","Diversification","Portfolio Optimization"]},{id:"skill4",name:"Client Communication",icon:"comments-dollar",description:"Effectively communicate investment concepts and recommendations to clients.",tags:["Financial Literacy","Clear Explanations","Clarification Questions"]}],knowledgeSources:[{id:"source1",type:"file",name:"Investment Strategy Guide.pdf",description:"Comprehensive guide to investment strategies and best practices",size:"3.2 MB",dateAdded:"2025-03-15T10:30:00Z"},{id:"source2",type:"website",name:"https://marketdata.example.com",description:"Real-time market data and financial indicators",dateAdded:"2025-03-20T14:45:00Z"},{id:"source3",type:"text",name:"Risk Assessment Framework",description:"Internal framework for evaluating investment risks",dateAdded:"2025-03-25T09:15:00Z"}]}};if(!e||!e.success)throw new Error(e?.message||"Failed to fetch agent data");this.agent=e.agent,this.processSteps=this.agent.processSteps||[],this.inputFields=this.agent.inputFields||[],this.outputFields=this.agent.outputFields||[],this.skills=this.agent.skills||[],this.knowledgeSources=this.agent.knowledgeSources||[],this.saveToHistory(),this.isLoading=!1,this.render()}catch(e){new c.y(e.message||"There was an error loading the agent","error",!0,!0),this.isLoading=!1,this.render()}}render(){if(!this.container)return;this.container.innerHTML="";const e=document.createElement("div");e.className="flex flex-col h-full w-full ";const t=this.createHeader();if(this.scrollContainer=document.createElement("div"),this.scrollContainer.className="flex-grow overflow-y-auto",this.contentContainer=document.createElement("div"),this.contentContainer.className="w-full px-4 sm:px-6 lg:px-20 pb-8 max-w-5xl mx-auto",this.isLoading)this.renderLoadingState();else if(this.agent)this.renderActiveTabContent();else{const e=document.createElement("p");e.textContent="Failed to load agent data.",e.className=`${this.theme.text} text-center py-10`,this.contentContainer.appendChild(e)}this.scrollContainer.appendChild(this.contentContainer),e.appendChild(t),e.appendChild(this.scrollContainer),this.container.appendChild(e),"training"===this.activeTab&&!this.isLoading&&this.agent&&this.initSortable()}createHeader(){const e=document.createElement("div");e.className=`border-b ${this.theme.inputBorder} ${this.theme.modalBackground} sticky top-0 z-10 w-full pt-4`;const t=document.createElement("div");t.className="max-w-5xl mx-auto px-4 sm:px-6 lg:px-20";const s=document.createElement("div");s.className="py-4 flex items-center justify-between";const i=document.createElement("div");i.className="flex items-center";const n=document.createElement("div");n.className=`w-12 h-12 mr-3 ${this.theme.inputBackground} ring-1 ${this.theme.inputRing} rounded-full flex items-center justify-center`;const a=document.createElement("div"),o=document.createElement("div");o.className="group relative inline-flex items-center cursor-pointer",o.title="Click to edit";const r=document.createElement("h1");r.className=`text-xl font-bold ${this.theme.text}`,r.textContent=this.agent?.name||"Agent",r.dataset.originalName=this.agent?.name||"Agent";const l=document.createElement("i");l.className="fas fa-pencil-alt ml-2 opacity-0 group-hover:opacity-100 transition-opacity",l.style.fontSize="0.75em",o.addEventListener("click",(e=>{this.agent&&this.makeAgentNameEditable(r)})),o.appendChild(r),o.appendChild(l);const c=document.createElement("div");c.className=`text-sm ${this.theme.fadedText}`,a.appendChild(o),a.appendChild(c),i.appendChild(n),i.appendChild(a);const d=document.createElement("div");d.className="flex items-center";const h=document.createElement("nav");h.className="flex";return[{id:"training",label:"Training",icon:"fa-solid fa-graduation-cap"},{id:"settings",label:"Settings",icon:"fa-solid fa-cog"}].forEach((e=>{const t=document.createElement("button");t.className=`tab-btn ${this.activeTab===e.id?`border-b-2 ${this.theme.inputSelectedBorder} ${this.theme.link}`:`border-b-2 border-transparent hover:border-gray-300 ${this.theme.text}`} px-4 py-2 font-medium text-base flex items-center`,t.dataset.tab=e.id;const s=document.createElement("i");s.className=`${e.icon} mr-2`;const i=document.createElement("span");i.textContent=e.label,t.appendChild(s),t.appendChild(i),t.addEventListener("click",(()=>{this.isLoading||(this.activeTab=e.id,this.render())})),h.appendChild(t)})),d.appendChild(h),s.appendChild(i),s.appendChild(d),t.appendChild(s),e.appendChild(t),e}makeAgentNameEditable(e){const t=document.createElement("input");t.type="text",t.value=e.textContent,t.className=`text-xl font-bold ${this.theme.text} ${this.theme.inputBackground} border ${this.theme.inputBorder} rounded px-2 py-1 w-full`,t.style.minWidth="200px";const s=e.parentNode,i=()=>{const i=t.value.trim();i?(this.agent.name=i,e.textContent=i,e.dataset.originalName=i,this.saveToHistory()):(e.textContent=e.dataset.originalName,new c.y("Agent name cannot be empty","warning",!0,!1)),s.style.display="",t.parentNode&&t.parentNode.removeChild(t)};t.addEventListener("keydown",(e=>{"Enter"===e.key?(e.preventDefault(),i()):"Escape"===e.key&&(s.style.display="",t.parentNode&&t.parentNode.removeChild(t))})),t.addEventListener("blur",i),s.style.display="none",s.parentNode.insertBefore(t,s.nextSibling),t.focus(),t.select()}renderActiveTabContent(){const e=document.createElement("div");switch(e.className="pb-6 pt-3",this.activeTab){case"training":this.renderTrainingTab(e);break;case"analytics":this.renderAnalyticsTab(e);break;case"tasks":this.renderTasksTab(e);break;case"settings":this.renderSettingsTab(e)}this.contentContainer.appendChild(e)}renderLoadingState(){const e=document.createElement("div");e.className="flex flex-col items-center justify-center h-64";const t=document.createElement("div");t.className=`w-12 h-12 border-4 ${this.theme.inputBorder} border-t-indigo-600 rounded-full animate-spin mb-4`;const s=document.createElement("p");s.className=this.theme.fadedText,s.textContent="Loading agent data...",e.appendChild(t),e.appendChild(s),this.contentContainer&&(this.contentContainer.innerHTML="",this.contentContainer.appendChild(e))}renderTrainingTab(e){const t=document.createElement("div");t.className="mb-6 mt-4 flex items-center justify-between";const s=document.createElement("div"),i=document.createElement("h2");i.className=`text-xl font-semibold ${this.theme.text}`,i.textContent="Training",s.appendChild(i);const a=document.createElement("div");a.className="flex items-center space-x-1";const o=new n.$({type:"secondary",size:"small",icon:"fas fa-rotate-left",disabled:this.historyIndex<=0});o.onClick((()=>this.handleUndo()));const r=new n.$({type:"secondary",size:"small",icon:"fas fa-rotate-right",disabled:this.historyIndex>=this.history.length-1});r.onClick((()=>this.handleRedo()));const l=new n.$({type:"secondary",size:"small",icon:"fas fa-history",text:"Versions"});l.onClick((()=>this.handleShowVersionHistory())),o.render(a),r.render(a);const c=document.createElement("div");c.className=`h-6 w-px ${this.theme.inputBorder} mx-2`,a.appendChild(c),l.render(a),t.appendChild(s),t.appendChild(a);const d=this.createCard(),h=document.createElement("div");h.id="process-steps",h.className="space-y-4",0===this.processSteps.length&&(this.processSteps=[{id:this.generateId(),title:"Gather and validate input",description:"Collect all required information and validate that inputs are complete and within expected ranges. Ask clarification questions if any information is missing or unclear.",requiredSkills:["data_validation","communication"],duration:2,attachments:[]},{id:this.generateId(),title:"Process information",description:"Analyze the provided information according to the agent's expertise and objectives.",requiredSkills:["analysis","critical_thinking"],duration:5,attachments:[]},{id:this.generateId(),title:"Generate response",description:"Create a comprehensive response based on the analysis, ensuring it addresses the original request completely.",requiredSkills:["content_creation","communication"],duration:3,attachments:[]}],this.saveToHistory()),this.processSteps.forEach(((e,t)=>{const s=this.createProcessStepElement(e,t);h.appendChild(s)}));const m=document.createElement("div");m.className="flex items-center justify-center mt-4";const u=new n.$({type:"link",size:"large",icon:"fas fa-plus",text:"Add step"});u.render(m),u.onClick((()=>this.handleAddProcessStep())),d.appendChild(h),d.appendChild(m),e.appendChild(t),e.appendChild(d)}renderTasksTab(e){const t=document.createElement("div");t.className="mb-6";const s=document.createElement("h2");s.className=`text-xl font-semibold ${this.theme.text}`,s.textContent="Agent Tasks";const i=document.createElement("p");i.className=this.theme.fadedText,i.textContent="View and manage tasks assigned to this agent.",t.appendChild(s),t.appendChild(i),e.appendChild(t);const n=document.createElement("div");n.className=`${this.theme.modalBackground} opacity-90 rounded-lg shadow-md p-6 flex items-center justify-center h-64`,n.textContent="Tasks content will be displayed here",e.appendChild(n)}renderSettingsTab(e){const t=document.createElement("div");t.className="mb-6";const s=document.createElement("h2");s.className=`text-xl font-semibold ${this.theme.text}`,s.textContent="Agent Settings";const i=document.createElement("p");i.className=this.theme.fadedText,i.textContent="Configure general settings for your agent.",t.appendChild(s),t.appendChild(i),e.appendChild(t);const n=document.createElement("div");n.className=`${this.theme.modalBackground} opacity-90 rounded-lg shadow-md p-6 flex items-center justify-center h-64`,n.textContent="Settings content will be displayed here",e.appendChild(n)}renderAnalyticsTab(e){const t=document.createElement("div");t.className="mb-6";const s=document.createElement("h2");s.className=`text-xl font-semibold ${this.theme.text}`,s.textContent="Agent Analytics";const i=document.createElement("p");i.className=this.theme.fadedText,i.textContent="View performance metrics and usage statistics for this agent.",t.appendChild(s),t.appendChild(i),e.appendChild(t);const n=document.createElement("div");n.className=`${this.theme.modalBackground} opacity-90 rounded-lg shadow-md p-6 flex items-center justify-center h-64`,n.textContent="Analytics content will be displayed here",e.appendChild(n)}initSortable(){this.sortableInstance&&this.sortableInstance.destroy();const e=document.getElementById("process-steps");if(!e)return;this.sortableInstance=new re.Ay(e,{animation:150,handle:".drag-handle",ghostClass:`${this.theme.selectedItemBG}`,chosenClass:"sortable-chosen",dragClass:"sortable-drag",forceFallback:!0,fallbackClass:"sortable-fallback",fallbackOnBody:!0,scrollSpeed:40,filter:'.non-draggable, [data-image-drag-active="true"]',onMove:function(e){let t=e.related;for(;t;){if(t.dataset&&"true"===t.dataset.imageDragActive)return!1;t=t.parentNode}return!0},onEnd:e=>{e.item.dataset.stepId;const t=e.oldIndex,s=e.newIndex;if(t!==s){const e=this.processSteps.splice(t,1)[0];this.processSteps.splice(s,0,e),this.saveToHistory()}}});const t=document.createElement("style");t.textContent="\n            .sortable-chosen { opacity: 0.8; }\n            .sortable-fallback { opacity: 0.95; transform: rotate(1deg); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }\n            .sortable-drag { opacity: 0; }\n            .drag-handle { cursor: grab; touch-action: none; -webkit-touch-callout: none; -webkit-user-select: none; -khtml-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; }\n            .drag-handle:active { cursor: grabbing; }\n            .non-draggable { cursor: default !important; }\n            .content-editable.drag-over { background-color: #eff6ff; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.3); position: relative; }\n            .content-editable.drag-over::after { content: 'Drop image here'; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(59, 130, 246, 0.8); color: white; padding: 0.5rem 1rem; border-radius: 0.25rem; font-size: 0.875rem; pointer-events: none; }\n        ",document.head.appendChild(t)}createCard(e,t=""){const s=document.createElement("div");if(s.className=`${this.theme.modalBackground} opacity-90 rounded-lg shadow-md p-6 mb-6`,e){const t=document.createElement("div");t.className=`text-lg font-medium ${this.theme.text}`,t.textContent=e,s.appendChild(t)}if(t){const e=document.createElement("div");e.className=`${this.theme.fadedText} mb-4`,e.textContent=t,s.appendChild(e)}return s}createProcessStepElement(e,t){const s=document.createElement("div");s.className=`process-step process-step-item ${this.theme.secondaryBackground} border ${this.theme.inputBorder} rounded-lg p-4`,s.dataset.stepId=e.id;const i=document.createElement("div");i.className="flex items-start mb-2";const a=document.createElement("div");a.className=`drag-handle ${this.theme.iconColor} cursor-grab mr-4 pt-1`,a.innerHTML='<i class="fas fa-grip-vertical"></i>',i.appendChild(a);const o=document.createElement("div");o.className="flex-grow";const r=new lt({placeholder:"Describe what happens in this step...",value:e.description||"",enableSuggestions:!0,enableImageUpload:!0,height:"min-h-[100px]",imageUploadHandler:async e=>this.simulateImageUpload(e)});r.onChange((t=>{const s=this.processSteps.find((t=>t.id===e.id));s&&(s.description=t)})),r.onImageUpload(((t,s)=>{const i=this.processSteps.find((t=>t.id===e.id));i&&(i.description=r.value,this.saveToHistory())})),r.render(o),i.appendChild(o);const l=document.createElement("div");l.className="flex items-center justify-between pl-7";const c=document.createElement("div");c.className="flex items-center gap-x-1";const d=new n.$({text:"Add screenshots",type:"focus",size:"small",icon:"fa-solid fa-image",truncateMobile:!0});d.onClick((()=>{r.focus()})),d.render(c);const h=new n.$({text:"Add context",type:"focus",size:"small",icon:"fa-solid fa-plus",truncateMobile:!0});h.onClick((()=>{}));const m=new n.$({text:"Add skills",type:"focus",icon:"fa-solid fa-cube",size:"small",truncateMobile:!0});m.onClick((()=>{})),h.render(c),m.render(c);const u=document.createElement("div");u.className="flex items-center space-x-1";const p=new n.$({size:"small",icon:"fas fa-clone",type:"focus",hoverText:"Duplicate step",theme:this.theme});p.onClick((()=>{const t={id:this.generateId(),description:e.description,requiredSkills:[...e.requiredSkills||[]]},s=this.processSteps.findIndex((t=>t.id===e.id));-1!==s&&(this.processSteps.splice(s+1,0,t),this.saveToHistory(),this.render())}));const g=new n.$({size:"small",icon:"fas fa-trash",type:"focus",hoverText:"Delete step"});g.onClick((()=>this.handleDeleteProcessStep(e.id))),p.render(u),g.render(u),l.appendChild(c),l.appendChild(u);const f=document.createElement("div");return f.className=`step-details hidden mt-4 pt-4 border-t ${this.theme.inputBorder} pl-8`,s.appendChild(i),s.appendChild(l),s.appendChild(f),s}async simulateImageUpload(e){await new Promise((e=>setTimeout(e,1500)));return"https://via.placeholder.com/300x200.png?text=Uploaded+"+encodeURIComponent(e.name)}saveToHistory(){const e={processSteps:JSON.parse(JSON.stringify(this.processSteps)),inputFields:JSON.parse(JSON.stringify(this.inputFields)),outputFields:JSON.parse(JSON.stringify(this.outputFields))};this.historyIndex<this.history.length-1&&(this.history=this.history.slice(0,this.historyIndex+1)),this.history.push(e),this.historyIndex=this.history.length-1;this.history.length>50&&(this.history=this.history.slice(this.history.length-50),this.historyIndex=this.history.length-1)}handleUndo(){if(this.historyIndex>0){this.historyIndex--;const e=this.history[this.historyIndex];this.processSteps=JSON.parse(JSON.stringify(e.processSteps)),this.inputFields=JSON.parse(JSON.stringify(e.inputFields)),this.outputFields=JSON.parse(JSON.stringify(e.outputFields)),this.render(),new c.y("Undone successfully","info",!0,!1)}}handleRedo(){if(this.historyIndex<this.history.length-1){this.historyIndex++;const e=this.history[this.historyIndex];this.processSteps=JSON.parse(JSON.stringify(e.processSteps)),this.inputFields=JSON.parse(JSON.stringify(e.inputFields)),this.outputFields=JSON.parse(JSON.stringify(e.outputFields)),this.render(),new c.y("Redone successfully","info",!0,!1)}}handleShowVersionHistory(){const e=new l({title:"Version History",size:"lg",showClose:!0}),t=document.createElement("div");if(t.className="p-4",this.history.length<=1){const e=document.createElement("p");e.className=this.theme.fadedText,e.textContent="No version history available yet.",t.appendChild(e)}else{const s=document.createElement("div");s.className="space-y-3 max-h-96 overflow-y-auto";const i=new Date;this.history.forEach(((t,n)=>{const a=new Date(i.getTime()-5*(this.history.length-n)*6e4).toLocaleTimeString(),o=document.createElement("div");o.className=`p-3 rounded-lg border ${this.theme.inputBorder} ${n===this.historyIndex?`${this.theme.selectedItemBG} ring-2 ${this.theme.inputSelectedRing}`:""}`;const r=document.createElement("div");r.className="flex items-center justify-between";const l=document.createElement("div");l.className=`font-medium ${this.theme.text}`,l.textContent=`Version ${n+1}`;const d=document.createElement("div");d.className=this.theme.fadedText,d.textContent=a,r.appendChild(l),r.appendChild(d);const h=document.createElement("div");h.className=`mt-1 text-sm ${this.theme.fadedText}`,h.textContent=`${t.processSteps.length} steps, ${t.inputFields.length} inputs, ${t.outputFields.length} outputs`;const m=document.createElement("button");m.className=`mt-2 text-sm ${this.theme.link}`,m.textContent="Restore this version",m.addEventListener("click",(()=>{this.historyIndex=n;const t=this.history[n];this.processSteps=JSON.parse(JSON.stringify(t.processSteps)),this.inputFields=JSON.parse(JSON.stringify(t.inputFields)),this.outputFields=JSON.parse(JSON.stringify(t.outputFields)),e.close(),this.render(),new c.y("Version restored successfully","success",!0,!0)})),o.appendChild(r),o.appendChild(h),o.appendChild(m),s.appendChild(o)})),t.appendChild(s)}e.setContent(t),e.open()}handleAddProcessStep(){const e={id:this.generateId(),title:"",description:"",requiredSkills:[],duration:5,attachments:[]};this.processSteps.push(e),this.saveToHistory(),this.activeTab="training",this.render(),setTimeout((()=>{const t=document.querySelector(`[data-step-id="${e.id}"]`);if(t){const e=t.querySelector(".ProseMirror");e&&e.focus()}}),100)}handleDeleteProcessStep(e){new a("Delete step?","This action cannot be undone.").onConfirm((()=>{this.processSteps=this.processSteps.filter((t=>t.id!==e)),this.saveToHistory(),this.activeTab="training",this.render()}))}handleAddInputField(){const e={id:this.generateId(),name:"",required:!1,askClarification:!1};this.inputFields.push(e),this.saveToHistory(),this.activeTab="training",this.render(),setTimeout((()=>{const t=document.querySelector(`[data-field-id="${e.id}"]`);if(t){const e=t.querySelector(".input-field");e&&e.focus()}}),100)}handleDeleteInputField(e){this.inputFields=this.inputFields.filter((t=>t.id!==e)),this.saveToHistory(),this.activeTab="training",this.render()}handleAddOutputField(){const e={id:this.generateId(),name:""};this.outputFields.push(e),this.saveToHistory(),this.activeTab="training",this.render(),setTimeout((()=>{const t=document.querySelector(`[data-field-id="${e.id}"]`);if(t){const e=t.querySelector(".output-field");e&&e.focus()}}),100)}handleDeleteOutputField(e){this.outputFields=this.outputFields.filter((t=>t.id!==e)),this.saveToHistory(),this.activeTab="training",this.render()}async handleSaveChanges(){try{const e={id:this.agentId,name:this.agent.name,description:this.agent.description,type:this.agent.type,responseStyle:this.agent.responseStyle,maxTokens:this.agent.maxTokens,monthlyTokenBudget:this.agent.monthlyTokenBudget,maxTimeToComplete:this.agent.maxTimeToComplete,expectedTimeToComplete:this.agent.expectedTimeToComplete,timeoutBehavior:this.agent.timeoutBehavior,restrictKnowledge:this.agent.restrictKnowledge,processSteps:this.processSteps,inputFields:this.inputFields,outputFields:this.outputFields,skills:this.skills,knowledgeSources:this.knowledgeSources},t=await g.G.putData(`/agents/${this.agentId}/`,e);if(!t||!t.success)throw new Error(t?.message||"Failed to update agent");new c.y("Agent updated successfully!","success",!0,!0)}catch(e){new c.y(e.message||"There was an error updating the agent","error",!0,!0)}}generateId(){return"id_"+Math.random().toString(36).substr(2,9)}}class dt{constructor(){this.primaryContent=document.getElementById("primary-content"),this.theme=i.A.theme,this.taskData=null,this.init()}async init(){try{this.showLoadingState(),await this.getTaskData(),this.render()}catch(e){this.showErrorMessage("Failed to load tasks. Please try again later.")}}showLoadingState(){this.primaryContent.innerHTML=`\n            <div class="flex justify-center items-center h-64">\n                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 ${this.theme.borderColor}"></div>\n            </div>\n        `}async getTaskData(){return this.taskData={inProgress:[{id:1,name:"Research market trends",description:"Analyzing competitor strategies and identifying market opportunities",status:"In Progress",statusColor:"yellow",assignees:[{id:1,color:"blue"},{id:2,color:"green"},{id:3,color:"purple"}]},{id:2,name:"Generate content outline",description:"Creating a structured outline for the quarterly report",status:"In Progress",statusColor:"purple",assignees:[{id:4,color:"red"},{id:5,color:"yellow"},{id:6,color:"indigo"}]}],queued:[{id:3,name:"Data visualization",description:"Creating charts and graphs for the sales data",status:"Queued",statusColor:"gray",assignees:[{id:7,color:"teal"},{id:8,color:"orange"},{id:9,color:"blue"}]},{id:4,name:"Code review",description:"Analyzing and optimizing the JavaScript implementation",status:"Queued",statusColor:"gray",assignees:[{id:10,color:"pink"},{id:11,color:"cyan"},{id:12,color:"amber"}]}],needsFollowUp:[{id:5,name:"Verifying details",description:"Waiting for reply to my email",status:"Needs Follow-up",statusColor:"amber",assignees:[{id:13,color:"blue"},{id:14,color:"purple"}]},{id:6,name:"API integration clarification",description:"Need technical specifications from the backend team",status:"Needs Follow-up",statusColor:"amber",assignees:[{id:15,color:"green"},{id:16,color:"red"},{id:17,color:"yellow"}]}],completed:[{id:7,name:"Draft email campaign",description:"Created email templates for the product launch",status:"Completed",statusColor:"green",assignees:[{id:18,color:"violet"},{id:19,color:"emerald"},{id:20,color:"rose"}]}]},this.taskData}render(){this.primaryContent.innerHTML="";const e=document.createElement("div");e.className="flex flex-col w-full leading-7 py-2 justify-center items-center px-2 sm:px-4 lg:pl-0 lg:mt-6 mt-16 lg:ml-[120px] h-full overflow-hidden";const t=document.createElement("div");t.className="w-full h-full overflow-hidden";const s=document.createElement("div");s.className="flex flex-col overflow-hidden w-full h-full";const i=document.createElement("div");i.className="flex justify-between items-center mx-2 gap-2 pr-[180px]";const n=document.createElement("div");n.className="flex gap-2 max-w-[250px] lg:max-w-full";const a=document.createElement("h1");a.className="text-2xl font-bold",a.textContent="Tasks",n.appendChild(a);const o=document.createElement("div");o.className="flex gap-2 table-action-buttons",i.appendChild(n),i.appendChild(o),s.appendChild(i);const r=document.createElement("div");r.className="w-full h-[calc(var(--vh)*100-120px)] overflow-hidden";const l=document.createElement("div");l.className="overflow-y-auto h-full w-full";const c=document.createElement("div");c.className="pr-[180px] h-full";const d=document.createElement("div");d.className="mt-6 max-w-4xl mx-auto w-full";const h=document.createElement("div");h.className="space-y-8 pb-8",h.appendChild(this.createTaskSection("IN PROGRESS",this.taskData.inProgress,"yellow")),h.appendChild(this.createTaskSection("QUEUED",this.taskData.queued,"gray")),h.appendChild(this.createTaskSection("NEEDS FOLLOW-UP",this.taskData.needsFollowUp,"amber")),h.appendChild(this.createTaskSection("COMPLETED",this.taskData.completed,"green")),d.appendChild(h),c.appendChild(d),l.appendChild(c),r.appendChild(l),s.appendChild(r),t.appendChild(s),e.appendChild(t),this.primaryContent.appendChild(e)}createTaskSection(e,t,s){const i=document.createElement("div");i.className="mb-6";const n=document.createElement("h3");n.className=`text-sm font-medium ${this.theme.fadedText} mb-3`,n.textContent=e,i.appendChild(n);const a=document.createElement("div");return a.className="space-y-3",t.forEach((e=>{const t=this.createTaskCard(e,s);a.appendChild(t)})),i.appendChild(a),i}createTaskCard(e,t){const s="Completed"===e.status,i=document.createElement("div");i.className=`${this.theme.modalBackground} rounded-lg shadow-sm border ${this.theme.inputBorder} p-4 ${this.theme.backgroundHover} transition-shadow`,s&&i.classList.add("opacity-75");const n=document.createElement("div");n.className="flex justify-between items-start";const a=document.createElement("div");a.className="flex items-center";const o=document.createElement("div");o.className=`h-4 w-4 rounded-full bg-${e.statusColor}-400 mr-3`;const r=document.createElement("h4");r.className="font-medium",s&&r.classList.add("line-through",this.theme.fadedText),r.textContent=e.name,a.appendChild(o),a.appendChild(r);const l=document.createElement("div");l.className="relative flex items-center",l.innerHTML=`\n            <button class="p-1 rounded-full ${this.theme.menuIconHoverColor} mr-1">\n                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />\n                </svg>\n            </button>\n            <button class="p-1 rounded-full ${this.theme.menuIconHoverColor}">\n                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${this.theme.iconColor}" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z" />\n                </svg>\n            </button>\n        `,n.appendChild(a),n.appendChild(l);const c=document.createElement("p");c.className=`text-sm ${this.theme.fadedText} mt-2`,c.textContent=e.description;const d=document.createElement("div");d.className="mt-4 flex justify-between items-center";const h=document.createElement("div");h.className="flex items-center";const m=document.createElement("div");m.className="flex -space-x-2",e.assignees.forEach(((e,t)=>{const s=document.createElement("div");s.className=`h-6 w-6 rounded-full bg-${e.color}-500 border-2 border-white dark:border-gray-800 z-${30-10*t}`,m.appendChild(s)})),h.appendChild(m);const u=document.createElement("div");return"In Progress"===e.status?(u.className=`${this.theme.primaryButtonTransparent} text-xs px-2 py-1 rounded flex items-center`,u.innerHTML='\n                <i class="fa-solid fa-spinner fa-spin mr-1"></i>\n                Working...\n            '):"Queued"===e.status?(u.className=`${this.theme.secondaryButtonTransparent} text-xs px-2 py-1 rounded`,u.textContent="Queued"):"Needs Follow-up"===e.status?(u.className="bg-amber-100 dark:bg-amber-900 text-amber-800 dark:text-amber-200 text-xs px-2 py-1 rounded flex items-center",u.innerHTML='\n                <i class="fa-solid fa-question-circle mr-1"></i>\n                Needs Input\n            '):"Completed"===e.status&&(u.className="bg-green-100 dark:bg-green-900 text-green-800 dark:text-green-200 text-xs px-2 py-1 rounded",u.textContent="Complete"),d.appendChild(h),d.appendChild(u),i.appendChild(n),i.appendChild(c),i.appendChild(d),i.addEventListener("click",(()=>{this.onTaskClick(e)})),i}onTaskClick(e){new c.y(`Viewing task: ${e.name}`,"info")}showErrorMessage(e){new c.y(e,"error")}}class ht extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this.isGroupMode=!1,this.toolGroupData=[],this.groupSummaryMessage="",this.individualToolElements=new Map,this.typewriterTimeouts=new Map,this.loadingMessageElements=new Map,this.state="approval",this.mcpName="",this.blockId="",this.chatId="",this.uuid="",this.currentMessage="",this.refImage="",this.mcpIconUrl="",this.errorMessage="",this.mcpId="",this.toolCalled="",this.connectionName="",this.successSummary="",this.progress=-1,this.timelineEvents=[],this.isExpanded=!1,this.typewriterTimeout=null,this.loadingMessageElement=null,this.groupSummaryTypewriterTimeout=null,this._groupSummaryMessageJustChanged=!1}static get observedAttributes(){return["state","ref-image","mcp-icon-url","mcp-id","mcp-name","error-message","block-id","chat-id","uuid","tool-called","connection-name","success-summary","timeline-events","progress","current-message","status-message","tool-group","group-summary-message"]}attributeChangedCallback(e,t,s){if("group-summary-message"===e){const e=this.groupSummaryMessage;return this.groupSummaryMessage=s,this._groupSummaryMessageJustChanged=e!==s,void(this.isGroupMode&&this._updateGroupUI(!1))}if(t===s&&"tool-group"!==e&&"state"!==e)return;const i=this.state;if("tool-group"===e){const e=this.isGroupMode;let t;try{t=JSON.parse(s||"[]")}catch(e){return void(this.isGroupMode&&(this.isGroupMode=!1,this.toolGroupData=[],this.updateUI(!1)))}const i=t.length>0;if(e!==i)return this.isGroupMode=i,this.toolGroupData=i?t.map((e=>({isExpanded:!1,timelineEvents:[],progress:-1,state:e.state||"pending",...e}))):[],this._groupSummaryMessageJustChanged=!1,void this.updateUI(!1);if(!this.isGroupMode)return;const n=new Set(this.toolGroupData.map((e=>e.toolUuid))),a=new Set(t.map((e=>e.toolUuid)));let o=!1;if(n.size!==a.size)o=!0;else for(const e of n)if(!a.has(e)){o=!0;break}if(o)return this.toolGroupData=t.map((e=>({isExpanded:this.toolGroupData.find((t=>t.toolUuid===e.toolUuid))?.isExpanded||!1,...e}))),this._groupSummaryMessageJustChanged=!1,void this._updateGroupUI(!1);let r=!1;return t.forEach(((e,t)=>{const s=this.toolGroupData.find((t=>t.toolUuid===e.toolUuid)),i=this.individualToolElements.get(e.toolUuid);if(!s||!i)return;const n=e.state!==s.state,a=e.successSummary!==s.successSummary||e.errorMessage!==s.errorMessage,o=e.mcpIconUrl!==s.mcpIconUrl,l=e.progress!==s.progress,c=e.currentMessage!==s.currentMessage;Object.assign(s,e),n||a||o?(this._renderIndividualToolState(s,i,!1),t<4&&(r=!0)):"loading"===s.state&&(l&&this._updateToolProgress(e.toolUuid,e.progress),c&&this._updateToolMessage(e.toolUuid,e.currentMessage))})),void(r&&this._updateGroupSummaryIcons())}let n=!1,a=!1;if("state"===e)this.state=s,this.isGroupMode?(this._groupSummaryMessageJustChanged=!1,a=!0):n=!0;else if(!this.isGroupMode){switch(e){case"ref-image":this.refImage=s;break;case"mcp-icon-url":this.mcpIconUrl=s;break;case"mcp-id":this.mcpId=s,!this.mcpName&&this.mcpId&&(this.mcpName=this.mcpId.charAt(0).toUpperCase()+this.mcpId.slice(1));break;case"mcp-name":this.mcpName=s;break;case"error-message":this.errorMessage=s;break;case"block-id":this.blockId=s;break;case"chat-id":this.chatId=s;break;case"uuid":this.uuid=s;break;case"tool-called":this.toolCalled=s;break;case"connection-name":this.connectionName=s;break;case"success-summary":this.successSummary=s;break;case"timeline-events":try{this.timelineEvents=JSON.parse(s||"[]")}catch(e){this.timelineEvents=[]}return void(this.isExpanded&&this.updateExpandedDetails());case"progress":const e=parseFloat(s);this.progress=!isNaN(e)&&e>=0&&e<=100?e:-1;break;case"current-message":this.currentMessage=s}if("loading"===i&&"loading"===this.state&&("progress"===e||"current-message"===e))return void this._updateLoadingInternals(e);const t=["approval","loading","complete","failed","error","denied"];!(["state","mcp-icon-url","mcp-id","mcp-name"].includes(e)||"ref-image"===e&&!this.mcpIconUrl||"error-message"===e&&("failed"===this.state||"error"===this.state)||"success-summary"===e&&"complete"===this.state||["tool-called","connection-name"].includes(e)&&t.includes(this.state))&&("progress"!==e&&"current-message"!==e||"loading"!==this.state||"loading"===i&&this.loadingMessageElement)||(n=!0)}a?this._updateGroupUI(!1):n&&this.updateUI(!1)}_updateGroupSummaryIcons(){if(!this.groupSummaryIconsContainer)return;this.groupSummaryIconsContainer.innerHTML="";const e=this.toolGroupData.slice(0,4);e.forEach(((t,s)=>{if(t.mcpIconUrl){const i=document.createElement("img");i.src=t.mcpIconUrl,i.alt=t.mcpName||t.mcpId||"Tool Icon",i.className="w-6 h-6 rounded-full object-contain",i.style.zIndex=e.length-s,this.groupSummaryIconsContainer.appendChild(i)}}))}_updateLoadingInternals(e){"loading"===this.state&&("progress"===e&&this._updateLoadingProgressState(),"current-message"===e&&this.loadingMessageElement&&this.typewriterEffect(this.loadingMessageElement,this.currentMessage))}_updateLoadingProgressState(){if("loading"!==this.state||!this.mainBar)return;let e=this.mainBar.querySelector(".mcp-progress-bar-inner");if(e&&e.remove(),this.mainBar.classList.remove("loading-pulse-bg"),this.mainBar.style.backgroundColor="",this.detailsContainer&&this.detailsContainer.classList.remove("loading-pulse-bg"),this.progress>=0&&this.progress<=100)e=document.createElement("div"),e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.bottom="0",e.style.height="100%",e.style.transition="width 0.3s ease-out",0===this.progress?(e.className="mcp-progress-bar-inner rounded-md loading-pulse-bg",e.style.width="100%",e.style.opacity="0.3"):(e.className="mcp-progress-bar-inner rounded-md loading-pulse-bg",e.style.width=`${this.progress}%`),this.mainBar.insertBefore(e,this.mainBar.firstChild);else{(this.theme.secondaryBackground||"bg-gray-50").split(" ").forEach((e=>e&&this.mainBar.classList.add(e))),this.mainBar.classList.add("loading-pulse-bg")}}connectedCallback(){const e=this.getAttribute("tool-group");this.isGroupMode=!!e;const t=this.getAttribute("uuid")||this.getAttribute("id");if(this.isGroupMode){try{const t=JSON.parse(e||"[]");this.toolGroupData=t.map((e=>{const t=window.toolCallInitialData&&window.toolCallInitialData[e.toolUuid];return{isExpanded:!1,timelineEvents:[],progress:-1,state:e.state||"pending",...e,...t||{}}}))}catch(e){this.isGroupMode=!1,this.toolGroupData=[]}this.hasAttribute("state")?this.state=this.getAttribute("state"):this.state="approval"}else if(t&&window.toolCallInitialData&&window.toolCallInitialData[t]){const e=window.toolCallInitialData[t];Object.keys(e).forEach((t=>{const s=t.replace(/([A-Z])/g,"-$1").toLowerCase();ht.observedAttributes.includes(s)?this.setAttribute(s,e[t]):this[t]=e[t]})),this.state=e.state||this.getAttribute("state")||"approval"}else this.hasAttribute("state")?this.state=this.getAttribute("state"):this.state="approval";this.render(),requestAnimationFrame((()=>{this.updateUI(!0)}))}render(){if(this.innerHTML="",this.wrapper=document.createElement("div"),this.wrapper.className=`mcp-wrapper rounded-lg overflow-hidden ${this.theme.secondaryBackground} fade-out`,this.individualToolElements.clear(),this.typewriterTimeouts.forEach((e=>clearTimeout(e))),this.typewriterTimeouts.clear(),this.loadingMessageElements.clear(),this.isGroupMode){this.groupSummaryContainer=document.createElement("div"),this.groupSummaryContainer.className=`mcp-group-summary flex items-center justify-between p-2 text-sm ${this.theme.text||"text-gray-800"} font-medium`,this.wrapper.appendChild(this.groupSummaryContainer);const e=document.createElement("div");e.className="flex items-center flex-grow min-w-0 mr-2",this.groupSummaryContainer.appendChild(e),this.groupSummaryIconsContainer=document.createElement("div"),this.groupSummaryIconsContainer.className="flex -space-x-2 mr-2 flex-shrink-0",e.appendChild(this.groupSummaryIconsContainer),this.groupSummaryTextElement=document.createElement("div"),this.groupSummaryTextElement.className="truncate flex-grow",e.appendChild(this.groupSummaryTextElement),this.groupSummaryActionsElement=document.createElement("div"),this.groupSummaryActionsElement.className="ml-auto flex-shrink-0 flex items-center gap-x-1.5 pr-1",this.groupSummaryContainer.appendChild(this.groupSummaryActionsElement),this.groupStatusContainer=document.createElement("div"),this.groupStatusContainer.className="mcp-group-status-bar",this.wrapper.appendChild(this.groupStatusContainer),this.toolsListContainer=document.createElement("div"),this.toolsListContainer.className="mcp-tools-list",this.wrapper.appendChild(this.toolsListContainer)}else this.mainBar=document.createElement("div"),this.mainBar.className="mcp-main-bar flex items-center justify-between gap-x-2",this.mainBarIconContainer=document.createElement("div"),this.mainBarIconContainer.className="mcp-icon-container flex-shrink-0",this.mainBarTextAndMessageContainer=document.createElement("div"),this.mainBarTextAndMessageContainer.className="mcp-text-message-container flex-1 min-w-0 py-1",this.mainBarActionsContainer=document.createElement("div"),this.mainBarActionsContainer.className="mcp-actions-container flex-shrink-0",this.mainBar.appendChild(this.mainBarIconContainer),this.mainBar.appendChild(this.mainBarTextAndMessageContainer),this.mainBar.appendChild(this.mainBarActionsContainer),this.wrapper.appendChild(this.mainBar),this.detailsContainer=document.createElement("div"),this.detailsContainer.className="mcp-details",this.wrapper.appendChild(this.detailsContainer);this.appendChild(this.wrapper)}updateUI(e=!1){this.wrapper||this.render(),this.wrapper&&(this.isGroupMode?this._updateGroupUI(e):this._updateSingleToolUI(e),requestAnimationFrame((()=>{this.wrapper.offsetWidth,this.wrapper.classList.remove("fade-out"),this.wrapper.classList.add("fade-in")})))}_updateSingleToolUI(e=!1){if(!(this.wrapper&&this.mainBar&&this.mainBarIconContainer&&this.mainBarTextAndMessageContainer&&this.mainBarActionsContainer&&this.detailsContainer||(this.render(),this.mainBar)))return;this.mainBarIconContainer.innerHTML="",this.mainBarTextAndMessageContainer.innerHTML="",this.mainBarActionsContainer.innerHTML="",this.mainBar.className="mcp-main-bar flex items-center justify-between gap-x-2",this.mainBar.classList.remove("loading-pulse-bg"),this.detailsContainer.classList.remove("loading-pulse-bg","p-3"),this.mainBar.style.background="";const t=this.mainBar.querySelector(".mcp-progress-bar-inner");switch(t&&t.remove(),this.state){case"approval":this.renderApprovalState();break;case"loading":this.renderLoadingState();break;case"complete":this.renderCompleteState();break;case"failed":case"error":this.renderFailedState();break;case"denied":this.renderDeniedState();break;default:this.state="approval",this.renderApprovalState()}this.isExpanded&&"approval"!==this.state?(this.detailsContainer.classList.add("expanded","p-3"),"loading"===this.state&&this.progress>=0&&this.progress<=100&&this.detailsContainer.classList.remove("loading-pulse-bg"),this.updateExpandedDetails()):(this.detailsContainer.classList.remove("expanded","p-3"),this.detailsContainer.innerHTML="")}_updateGroupUI(e=!1){if(!(this.groupSummaryContainer&&this.toolsListContainer&&this.groupSummaryTextElement&&this.groupSummaryIconsContainer&&this.groupSummaryActionsElement||(this.render(),this.groupSummaryContainer)))return;this.toolGroupData.some((e=>"loading"===e.state||"processing"===e.state))&&"approval"===this.state&&(this.state="processing"),this.groupSummaryIconsContainer.innerHTML="",this.groupSummaryActionsElement.innerHTML="";const t=this.toolGroupData.slice(0,4);if(t.forEach(((e,s)=>{if(e.mcpIconUrl){const i=document.createElement("img");i.src=e.mcpIconUrl,i.alt=e.mcpName||e.mcpId||"Tool Icon",i.className="w-6 h-6 rounded-full object-contain",i.style.zIndex=t.length-s,this.groupSummaryIconsContainer.appendChild(i)}})),"approval"===this.state){this.groupStatusContainer&&(this.groupStatusContainer.innerHTML=""),this.groupStatusContainer&&this.groupStatusContainer.classList.remove("p-2");const e=this.toolGroupData.length;let t=`Approve ${e} tool${e>1?"s":""}?`;if(e>0&&this.toolGroupData[0]){const s=this.toolGroupData[0].mcpName||this.toolGroupData[0].mcpId||"Tool";1===e?(t=`Approve ${s}`,this.toolGroupData[0].toolCalled&&(t+=` to ${this.toolGroupData[0].toolCalled}`),t+="?"):t=`Approve ${s} & ${e-1} other tool${e-1>1?"s":""}?`}this.groupSummaryTextElement&&(this.groupSummaryTextElement.textContent=t,this.groupSummaryTextElement.title=t),this.groupSummaryTypewriterTimeout&&(clearTimeout(this.groupSummaryTypewriterTimeout),this.groupSummaryTypewriterTimeout=null);const s=new n.$({text:"Approve all",type:"primary",size:"extraSmall"}),i=new n.$({text:"Deny all",type:"secondary",size:"extraSmall"}),a={blockId:this.blockId,chatId:this.chatId,uuid:this.uuid,groupSummary:this.groupSummaryMessage,tools:this.toolGroupData.map((e=>({mcpId:e.mcpId,mcpName:e.mcpName,toolCalled:e.toolCalled,connectionName:e.connectionName,toolUuid:e.toolUuid})))};s.onClick((()=>{this.dispatchEvent(new CustomEvent("mcp-group-approved",{detail:a,bubbles:!0,composed:!0})),this.setAttribute("state","processing")})),i.onClick((()=>{this.dispatchEvent(new CustomEvent("mcp-group-denied",{detail:a,bubbles:!0,composed:!0})),this.setAttribute("state","denied")})),this.groupSummaryActionsElement.appendChild(i.element),this.groupSummaryActionsElement.appendChild(s.element)}else{if(this.groupSummaryTextElement){const t=this.groupSummaryMessage||"";e?(this.groupSummaryTypewriterTimeout&&(clearTimeout(this.groupSummaryTypewriterTimeout),this.groupSummaryTypewriterTimeout=null),this.groupSummaryTextElement.textContent=t,this.groupSummaryTextElement.title=t):this._groupSummaryMessageJustChanged&&t?this._typewriterEffectForGroupSummary(this.groupSummaryTextElement,t):(this.groupSummaryTypewriterTimeout&&(clearTimeout(this.groupSummaryTypewriterTimeout),this.groupSummaryTypewriterTimeout=null),this.groupSummaryTextElement.textContent=t,this.groupSummaryTextElement.title=t)}this._groupSummaryMessageJustChanged&&(this._groupSummaryMessageJustChanged=!1);let t=null,s=this.theme.text,i="";const n=this.toolGroupData.some((e=>"loading"===e.state));if("processing"===this.state||n?(t=o.A.name("spinner"),i="animate-spin"):"complete"===this.state?(t=o.A.name("checkCircle"),s=this.theme.cpuActionGoal&&this.theme.cpuActionGoal.includes("bg-")?this.theme.cpuActionGoal.replace("bg-","text-"):this.theme.success||"text-green-500"):"failed"!==this.state&&"error"!==this.state&&"denied"!==this.state||(t=o.A.name("error"),s=this.theme.cpuActionStop&&this.theme.cpuActionStop.includes("bg-")?this.theme.cpuActionStop.replace("bg-","text-"):this.theme.error||"text-red-500"),t){const e=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-5 h-5",colorClass:s,additionalClasses:`${i} mr-1`});this.groupSummaryActionsElement.appendChild(e.element)}this.groupStatusContainer&&this._renderGroupStatus()}if(this.groupSummaryContainer){"approval"===this.state||this.groupSummaryMessage}const s=new Set;Array.from(this.toolsListContainer.children).forEach((e=>{e.dataset.toolUuid&&s.add(e.dataset.toolUuid)}));const i=new Set(this.toolGroupData.map((e=>e.toolUuid)));this.toolGroupData.forEach((t=>{let s=this.individualToolElements.get(t.toolUuid);s&&s.isConnected?this._renderIndividualToolState(t,s,e):(s=this._createIndividualToolElement(t),this.toolsListContainer.appendChild(s),this.individualToolElements.set(t.toolUuid,s),this._renderIndividualToolState(t,s,!0))})),s.forEach((e=>{if(!i.has(e)){const t=this.individualToolElements.get(e);t&&t.remove(),this.individualToolElements.delete(e),this.typewriterTimeouts.has(e)&&(clearTimeout(this.typewriterTimeouts.get(e)),this.typewriterTimeouts.delete(e)),this.loadingMessageElements.delete(e)}})),this.toolsListContainer.style.display=this.toolGroupData.length>0?"block":"none"}_createIndividualToolElement(e){const t=document.createElement("div");t.className="mcp-individual-tool-wrapper py-0.5",t.dataset.toolUuid=e.toolUuid;const s=document.createElement("div");s.className="mcp-main-bar flex items-center justify-between gap-x-2 p-2 relative overflow-hidden";const i=document.createElement("div");i.className="mcp-icon-container flex-shrink-0 pl-1 relative",s.appendChild(i);const n=document.createElement("div");n.className="mcp-text-message-container flex-1 min-w-0 relative py-1",s.appendChild(n);const a=document.createElement("div");a.className="mcp-actions-container flex-shrink-0 relative pr-1 flex items-center",s.appendChild(a),t.appendChild(s);const o=document.createElement("div");return o.className="mcp-details",t.appendChild(o),t}_renderGroupStatus(){if(this.groupStatusContainer.innerHTML="",this.groupStatusContainer.classList.remove("p-2"),"denied"===this.state&&this.isGroupMode){this.groupStatusContainer.classList.add("p-2");const e=document.createElement("div");e.className=`text-sm ${this.theme.text||"text-gray-800"} truncate`,e.textContent="Tool group access denied.",this.groupStatusContainer.appendChild(e)}else"processing"===this.state&&this.isGroupMode}_getToolImageSource(e,t="w-6 h-6"){const s=e.mcpName||e.mcpId||"MCP";let i=this.theme.workspaceDefaultIcon||"bg-gray-400 text-white",n="";const a=e.state||"pending";"loading"===a?n=`${this.theme.cpuActionThinking||"bg-zinc-400"} text-white`:"complete"===a?n=`${this.theme.cpuActionGoal||"bg-green-400"} text-white`:"failed"===a||"error"===a||"denied"===a?n=`${this.theme.cpuActionStop||"bg-red-400"} text-white`:"approval"!==a&&"pending"!==a||(n=`${this.theme.workspaceDefaultIcon||"bg-gray-400"} text-white`);const l=document.createElement("div");if(l.className=`${t} rounded-md flex items-center justify-center overflow-hidden flex-shrink-0`,e.mcpIconUrl&&"null"!==e.mcpIconUrl&&"undefined"!==e.mcpIconUrl)l.innerHTML=`<img src="${e.mcpIconUrl}" alt="${s}" class="w-full h-full object-contain">`;else if(e.refImage&&"null"!==e.refImage&&"undefined"!==e.refImage)l.innerHTML=`<img src="${e.refImage}" alt="${s}" class="w-full h-full object-contain">`;else{const e=o.A.name("plug"),s="w-10 h-10"===t?"w-6 h-6":"w-4 h-4",a=new r.I({pathData:e.path,viewBox:e.viewBox,sizeClasses:s});l.className+=` ${n||i}`,l.appendChild(a.element)}return l.outerHTML}_typewriterEffectForTool(e,t,s,i=null){this.typewriterTimeouts.has(e)&&clearTimeout(this.typewriterTimeouts.get(e)),t.innerHTML="",t.title=s;let n=0;const a=()=>{n<s.length?(t.textContent+=s.charAt(n),n++,this.typewriterTimeouts.set(e,setTimeout(a,30))):(this.typewriterTimeouts.delete(e),i&&i())};a()}_renderIndividualToolState(e,t,s){const i=t.querySelector(".mcp-main-bar"),n=i.querySelector(".mcp-icon-container"),a=i.querySelector(".mcp-text-message-container"),o=i.querySelector(".mcp-actions-container"),r=t.querySelector(".mcp-details");n.innerHTML=this._getToolImageSource(e),a.innerHTML="",o.innerHTML="",i.classList.remove("loading-pulse-bg"),i.style.backgroundColor="",r.classList.remove("loading-pulse-bg");const l=i.querySelector(".mcp-progress-bar-inner");l&&l.remove();const c=e.mcpName||e.mcpId||"Tool";switch(e.state||"pending"){case"approval":a.innerHTML=`<div class="text-sm font-medium ${this.theme.text||"text-gray-800"} truncate" title="Waiting for group approval for ${c}">Waiting for group approval...</div>`;break;case"loading":const t=document.createElement("div");t.className=`text-sm ${this.theme.text||"text-gray-800"} truncate leading-5 mcp-message flex items-center`,s&&t.classList.add("loading-shimmer"),a.appendChild(t),this.loadingMessageElements.set(e.toolUuid,t);const n=parseFloat(e.progress);if(n>=0&&n<=100){const e=document.createElement("div");e.className="mcp-progress-bar-inner rounded-md loading-pulse-bg",e.style.position="absolute",e.style.left="0",e.style.top="0",e.style.bottom="0",e.style.height="100%",e.style.transition="width 0.3s ease-out",e.style.width=`${n}%`,i.insertBefore(e,i.firstChild)}else i.classList.add("loading-pulse-bg");const r=e.currentMessage||`Processing ${c}...`;s&&!this.loadingMessageElements.has(e.toolUuid)?this.applyShimmerText(t,r):this._typewriterEffectForTool(e.toolUuid,t,r),this._renderIndividualToolChevron(e,o);break;case"complete":const l=e.successSummary||`Successfully used ${c}${e.toolCalled?" to "+e.toolCalled:""}`;a.innerHTML=`<div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${l}">${l}</div>`,this._renderIndividualToolChevron(e,o),this.dispatchEvent(new CustomEvent("mcp-tool-complete-in-group",{detail:{...e,groupUuid:this.uuid},bubbles:!0,composed:!0}));break;case"failed":case"error":const d=`${c} failed${e.toolCalled?" to "+e.toolCalled:""}`,h=e.errorMessage?`Error: ${e.errorMessage.substring(0,40)}${e.errorMessage.length>40?"...":""}`:"";a.innerHTML=`\n                    <div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${d}. ${e.errorMessage||""}">${d}</div>\n                    ${h?`<div class="text-xs ${this.theme.fadedText||"text-gray-600"} truncate leading-tight" title="${e.errorMessage}">${h}</div>`:""}\n                `,this._renderIndividualToolChevron(e,o),this.dispatchEvent(new CustomEvent("mcp-tool-failed-in-group",{detail:{...e,groupUuid:this.uuid},bubbles:!0,composed:!0}));break;case"denied":const m=`Access to ${c}${e.toolCalled?" ("+e.toolCalled+")":""} denied.`;a.innerHTML=`<div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${m}">${m}</div>`,this._renderIndividualToolChevron(e,o);break;default:a.innerHTML=`<div class="text-sm ${this.theme.fadedText||"text-gray-600"} truncate leading-5"> ${c} is pending...</div>`,this._renderIndividualToolChevron(e,o)}e.isExpanded?(r.classList.add("expanded","p-3"),"loading"===e.state&&e.progress>=0&&e.progress<=100&&r.classList.remove("loading-pulse-bg"),this._updateIndividualToolExpandedDetails(e,r)):(r.classList.remove("expanded","p-3"),r.innerHTML="")}_renderIndividualToolChevron(e,t){if(!e||"approval"===e.state||"pending"===e.state){const e=t.querySelector('button[aria-label*="details"]');return void(e&&e.remove())}let s=t.querySelector('button[aria-label*="details"]');s||(s=document.createElement("button"),s.className="p-1 focus:outline-none ml-1",s.addEventListener("click",(t=>{t.stopPropagation(),this._toggleIndividualToolExpand(e.toolUuid)})),t.hasChildNodes()&&"BUTTON"===t.firstChild.tagName&&!t.firstChild.getAttribute("aria-label")?.includes("details")?t.insertBefore(s,t.firstChild.nextSibling):t.appendChild(s));const i=e.isExpanded?"chevronUp":"chevronDown",n=o.A.name(i),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fadedText||"text-gray-600"});s.innerHTML="",s.appendChild(a.element),s.setAttribute("aria-label",e.isExpanded?`Collapse details for ${e.mcpName}`:`Expand details for ${e.mcpName}`)}_toggleIndividualToolExpand(e){const t=this.toolGroupData.findIndex((t=>t.toolUuid===e));if(-1===t)return;this.toolGroupData[t].isExpanded=!this.toolGroupData[t].isExpanded;const s=this.toolGroupData[t],i=this.individualToolElements.get(e);if(i){const e=i.querySelector(".mcp-details"),t=i.querySelector(".mcp-main-bar .mcp-actions-container");e.classList.remove("loading-pulse-bg"),s.isExpanded?(e.classList.add("expanded","p-3"),"loading"===s.state&&(s.progress<0||s.progress),this._updateIndividualToolExpandedDetails(s,e)):(e.classList.remove("expanded","p-3"),e.innerHTML=""),this._renderIndividualToolChevron(s,t)}}_updateIndividualToolExpandedDetails(e,t){t.innerHTML="";let s=!1;if(e.connectionName){const i=document.createElement("div");i.className=`text-xs ${this.theme.fadedText||"text-gray-600"} py-1.5`,i.textContent=`Using ${e.connectionName}`,t.appendChild(i),s=!0}if(e.timelineEvents&&e.timelineEvents.length>0){const i=document.createElement("ul");i.className="list-none pl-2",e.timelineEvents.forEach(((t,s)=>{const n=document.createElement("li");n.className="timeline-item flex items-center py-px";const a=document.createElement("div");a.className="flex flex-col items-center mr-2.5 flex-shrink-0 self-stretch";const o=document.createElement("div");o.className="timeline-stem w-px flex-grow "+(0===s?"bg-transparent":"bg-black");const r=document.createElement("div");r.className=`timeline-dot w-1.5 h-1.5 rounded-full ${this.theme.primaryButton} flex-shrink-0`;const l=document.createElement("div");l.className="timeline-stem w-px flex-grow "+(s===e.timelineEvents.length-1?"bg-transparent":"bg-black"),a.appendChild(o),a.appendChild(r),a.appendChild(l);const c=document.createElement("div");c.className=`text-xs ${this.theme.text||"text-gray-800"}`,c.textContent="string"==typeof t?t:t.text,n.appendChild(a),n.appendChild(c),i.appendChild(n)})),t.appendChild(i),s=!0}if(("failed"===e.state||"error"===e.state)&&e.errorMessage){const i=document.createElement("div"),n=this.theme.toastError&&this.theme.toastError.split(" ").find((e=>e.startsWith("text-")))||this.theme.cpuActionStop&&this.theme.cpuActionStop.replace("bg-","text-")||"text-red-700";i.className=`text-xs font-semibold ${n} mb-1 mt-3`,i.textContent="Error details:",t.appendChild(i);const a=document.createElement("div");a.className=`text-xs ${this.theme.fadedText||"text-gray-600"} whitespace-pre-wrap break-all`,a.textContent=e.errorMessage,t.appendChild(a),s=!0}if(!s){const e=document.createElement("div");e.className=`text-xs ${this.theme.fadedText||"text-gray-600"} italic`,e.textContent="No additional details available for this tool.",t.appendChild(e)}}getImageSource(e="w-6 h-6"){const t=this.mcpName||this.mcpId||"MCP";let s=this.theme.workspaceDefaultIcon||"bg-gray-400 text-white",i="";"loading"===this.state?i=`${this.theme.cpuActionThinking||"bg-zinc-400"} text-white`:"complete"===this.state?i=`${this.theme.cpuActionGoal||"bg-green-400"} text-white`:"failed"===this.state||"error"===this.state||"denied"===this.state?i=`${this.theme.cpuActionStop||"bg-red-400"} text-white`:"approval"===this.state&&(i=`${this.theme.workspaceDefaultIcon||"bg-gray-400"} text-white`);const n=document.createElement("div");if(n.className=`${e} rounded-md flex items-center justify-center overflow-hidden flex-shrink-0`,this.mcpIconUrl&&"null"!==this.mcpIconUrl&&"undefined"!==this.mcpIconUrl)n.innerHTML=`<img src="${this.mcpIconUrl}" alt="${t}" class="w-full h-full object-contain">`;else if(this.refImage&&"null"!==this.refImage&&"undefined"!==this.refImage)n.innerHTML=`<img src="${this.refImage}" alt="${t}" class="w-full h-full object-contain">`;else{const t=o.A.name("plug"),a="w-10 h-10"===e?"w-6 h-6":"w-4 h-4",l=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:a});n.className+=` ${i||s}`,n.appendChild(l.element)}return n.outerHTML}applyShimmerText(e,t){e.innerHTML="",e.title=t,e.textContent=t,e.classList.contains("loading-shimmer")||e.classList.add("loading-shimmer")}typewriterEffect(e,t,s=null){this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),e.innerHTML="",e.title=t;let i=0;const n=()=>{i<t.length?(e.textContent+=t.charAt(i),i++,this.typewriterTimeout=setTimeout(n,30)):(this.typewriterTimeout=null,s&&s())};n()}updateMessage(e){"loading"===this.state&&this.loadingMessageElement&&(this.currentMessage=e,this.typewriterEffect(this.loadingMessageElement,e))}addTimelineEvent(e){const t="string"==typeof e?{text:e,timestamp:(new Date).toISOString()}:{timestamp:(new Date).toISOString(),...e};if(this.isGroupMode){const s=e.toolUuid;if(s){const e=this.toolGroupData.findIndex((e=>e.toolUuid===s));if(-1!==e&&(this.toolGroupData[e].timelineEvents||(this.toolGroupData[e].timelineEvents=[]),this.toolGroupData[e].timelineEvents.push(t),this.toolGroupData[e].isExpanded)){const t=this.individualToolElements.get(s);if(t){const s=t.querySelector(".mcp-details");this._updateIndividualToolExpandedDetails(this.toolGroupData[e],s)}}}}else this.timelineEvents.push(t),this.isExpanded&&this.updateExpandedDetails()}toggleExpand(){this.isExpanded=!this.isExpanded,this.detailsContainer&&this.detailsContainer.classList.remove("loading-pulse-bg");const e=this.mainBarActionsContainer.querySelector('button[aria-label*="details"]');if(e){const t=this.isExpanded?"chevronUp":"chevronDown",s=o.A.name(t),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fadedText});e.innerHTML="",e.appendChild(i.element),e.setAttribute("aria-label",this.isExpanded?"Collapse details":"Expand details")}this.isExpanded&&"approval"!==this.state?(this.updateExpandedDetails(),this.detailsContainer&&(this.detailsContainer.classList.add("expanded","p-3"),"loading"===this.state&&(this.progress>=0&&this.progress,this.detailsContainer.classList.remove("loading-pulse-bg")))):this.detailsContainer&&(this.detailsContainer.classList.remove("expanded","p-3"),this.detailsContainer.innerHTML="")}updateExpandedDetails(){if(!this.detailsContainer)return;this.detailsContainer.innerHTML="";let e=!1;if("approval"!==this.state){if(this.connectionName){const t=document.createElement("div");t.className=`text-xs ${this.theme.fadedText||"text-gray-600"} py-1.5`,t.textContent=`Using ${this.connectionName}`,this.detailsContainer.appendChild(t),e=!0}if(this.timelineEvents&&this.timelineEvents.length>0){const t=document.createElement("ul");t.className="list-none pl-2",this.timelineEvents.forEach(((e,s)=>{const i=document.createElement("li");i.className="timeline-item flex items-center py-px";const n=document.createElement("div");n.className="flex flex-col items-center mr-2.5 flex-shrink-0 self-stretch";const a=document.createElement("div");a.className="timeline-stem w-px flex-grow "+(0===s?"bg-transparent":"bg-black");const o=document.createElement("div");o.className=`timeline-dot w-1.5 h-1.5 rounded-full ${this.theme.primaryButton} flex-shrink-0`;const r=document.createElement("div");r.className="timeline-stem w-px flex-grow "+(s===this.timelineEvents.length-1?"bg-transparent":"bg-black"),n.appendChild(a),n.appendChild(o),n.appendChild(r);const l=document.createElement("div");l.className=`text-xs ${this.theme.text||"text-gray-800"}`,l.textContent="string"==typeof e?e:e.text,i.appendChild(n),i.appendChild(l),t.appendChild(i)})),this.detailsContainer.appendChild(t),e=!0}if(("failed"===this.state||"error"===this.state)&&this.errorMessage){const t=document.createElement("div"),s=this.theme.toastError&&this.theme.toastError.split(" ").find((e=>e.startsWith("text-")))||this.theme.cpuActionStop&&this.theme.cpuActionStop.replace("bg-","text-")||"text-red-700";t.className=`text-xs font-semibold ${s} mb-1 mt-3`,t.textContent="Error details:",this.detailsContainer.appendChild(t);const i=document.createElement("div");i.className=`text-xs ${this.theme.fadedText||"text-gray-600"} whitespace-pre-wrap break-all`,i.textContent=this.errorMessage,this.detailsContainer.appendChild(i),e=!0}if(!e&&"approval"!==this.state){const e=document.createElement("div");e.className=`text-xs ${this.theme.fadedText||"text-gray-600"} italic`,e.textContent="No additional details available.",this.detailsContainer.appendChild(e)}}else this.detailsContainer.classList.remove("expanded","p-3")}renderApprovalState(){this.mainBar.classList.add("p-2"),this.mainBarIconContainer.innerHTML=this.getImageSource("w-6 h-6"),this.mainBarIconContainer.classList.add("pl-1");const e=this.mcpName||this.mcpId||"MCP";let t=`Approve ${e}?`;this.toolCalled&&(t=`Approve ${e} to ${this.toolCalled}?`);const s=this.connectionName?`via ${this.connectionName}`:"";this.mainBarTextAndMessageContainer.innerHTML=`\n            <div class="text-sm font-medium ${this.theme.text||"text-gray-800"} truncate leading-5" title="${t}">${t}</div>\n            ${s?`<div class="text-xs ${this.theme.fadedText||"text-gray-600"} truncate leading-tight" title="${s}">${s}</div>`:""}\n        `;const i=document.createElement("div");i.className="flex items-center gap-x-1.5";const a=new n.$({text:"Approve",type:"primary",size:"extraSmall"}),o=new n.$({text:"Deny",type:"secondary",size:"extraSmall"}),r={blockId:this.blockId,chatId:this.chatId,uuid:this.uuid,mcpId:this.mcpId,toolCalled:this.toolCalled,connectionName:this.connectionName};a.onClick((()=>{this.dispatchEvent(new CustomEvent("mcp-approved",{detail:r,bubbles:!0,composed:!0})),this.setAttribute("state","loading")})),o.onClick((()=>{this.dispatchEvent(new CustomEvent("mcp-denied",{detail:r,bubbles:!0,composed:!0})),this.setAttribute("state","denied")})),i.appendChild(o.element),i.appendChild(a.element),this.mainBarActionsContainer.appendChild(i),this.mainBarActionsContainer.classList.add("pr-1"),this.detailsContainer&&(this.detailsContainer.classList.remove("expanded","p-3"),this.detailsContainer.innerHTML="")}renderLoadingState(){this.mainBar.classList.add("p-2","relative","overflow-hidden"),this.mainBarIconContainer.innerHTML=this.getImageSource("w-6 h-6"),this.mainBarIconContainer.className="mcp-icon-container flex-shrink-0 pl-1 relative",this.mainBarTextAndMessageContainer.innerHTML="",this.loadingMessageElement=document.createElement("div"),this.loadingMessageElement.className=`text-sm ${this.theme.text||"text-gray-800"} truncate leading-5 mcp-message flex items-center loading-shimmer`,this.mainBarTextAndMessageContainer.appendChild(this.loadingMessageElement),this.mainBarTextAndMessageContainer.className="mcp-text-message-container flex-1 min-w-0 relative py-1",this._updateLoadingProgressState();const e=this.currentMessage||"Processing...";this.applyShimmerText(this.loadingMessageElement,e),this.mainBarActionsContainer.innerHTML="",this.mainBarActionsContainer.className="mcp-actions-container flex-shrink-0 relative pr-1 flex items-center",this.renderChevron(this.mainBarActionsContainer)}renderCompleteState(){this.mainBar.classList.add("p-2"),this.mainBarIconContainer.innerHTML=this.getImageSource("w-6 h-6"),this.mainBarIconContainer.classList.add("pl-1");const e=this.mcpName||this.mcpId||"MCP",t=this.successSummary||`Successfully used ${e}${this.toolCalled?" to "+this.toolCalled:""}`;this.mainBarTextAndMessageContainer.innerHTML=`\n            <div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${t}">${t}</div>\n        `,this.mainBarActionsContainer.className="mcp-actions-container flex-shrink-0 relative pr-1 flex items-center",this.renderChevron();const s={blockId:this.blockId,chatId:this.chatId,uuid:this.uuid,mcpId:this.mcpId,toolCalled:this.toolCalled,connectionName:this.connectionName};this.dispatchEvent(new CustomEvent("mcp-complete",{detail:s,bubbles:!0,composed:!0}))}renderFailedState(){this.mainBar.classList.add("p-2"),this.mainBarIconContainer.innerHTML=this.getImageSource("w-6 h-6"),this.mainBarIconContainer.classList.add("pl-1");const e=`${this.mcpName||this.mcpId||"MCP"} failed${this.toolCalled?" to "+this.toolCalled:""}`,t=this.errorMessage?`Error: ${this.errorMessage.substring(0,40)}${this.errorMessage.length>40?"...":""}`:"";this.mainBarTextAndMessageContainer.innerHTML=`\n            <div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${e}. ${this.errorMessage||""}">${e}</div>\n            ${t?`<div class="text-xs ${this.theme.fadedText||"text-gray-600"} truncate leading-tight" title="${this.errorMessage}">${t}</div>`:""}\n        `;const s=document.createElement("div");s.className="flex items-center gap-x-1",this.mainBarActionsContainer.className="mcp-actions-container flex-shrink-0 relative pr-1 flex items-center",this.mainBarActionsContainer.appendChild(s),this.renderChevron(s);this.dispatchEvent(new CustomEvent("mcp-failed",{detail:{error:this.errorMessage},bubbles:!0,composed:!0}))}renderDeniedState(){this.mainBar.classList.add("p-2"),this.mainBarIconContainer.innerHTML=this.getImageSource("w-6 h-6"),this.mainBarIconContainer.classList.add("pl-1");const e=`Access to ${this.mcpName||this.mcpId||"MCP"}${this.toolCalled?" ("+this.toolCalled+")":""} denied.`;this.mainBarTextAndMessageContainer.innerHTML=`\n            <div class="text-sm ${this.theme.text||"text-gray-800"} truncate leading-5" title="${e}">${e}</div>\n        `,this.mainBarActionsContainer.className="mcp-actions-container flex-shrink-0 relative pr-1 flex items-center",this.renderChevron()}renderChevron(e=this.mainBarActionsContainer){if("approval"===this.state){const t=e.querySelector('button[aria-label*="details"]');return void(t&&t.remove())}let t=e.querySelector('button[aria-label*="details"]');t||(t=document.createElement("button"),t.className="p-1 focus:outline-none ml-1",t.addEventListener("click",(e=>{e.stopPropagation(),this.toggleExpand()})),e!==this.mainBarActionsContainer||e.querySelector('button:not([aria-label*="details"])')||(e.innerHTML=""),e.hasChildNodes()&&"BUTTON"===e.firstChild.tagName&&!e.firstChild.getAttribute("aria-label")?.includes("details")?e.insertBefore(t,e.firstChild.nextSibling):e.appendChild(t));const s=this.isExpanded?"chevronUp":"chevronDown",i=o.A.name(s),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.fadedText||"text-gray-600"});t.innerHTML="",t.appendChild(n.element),t.setAttribute("aria-label",this.isExpanded?"Collapse details":"Expand details"),e===this.mainBarActionsContainer&&e.classList.add("pr-1")}_typewriterEffectForGroupSummary(e,t,s=null){this.groupSummaryTypewriterTimeout&&clearTimeout(this.groupSummaryTypewriterTimeout),e.innerHTML="",e.title=t;let i=0;const n=()=>{i<t.length?(e.textContent+=t.charAt(i),i++,this.groupSummaryTypewriterTimeout=setTimeout(n,30)):(this.groupSummaryTypewriterTimeout=null,s&&s())};n()}disconnectedCallback(){this.typewriterTimeout&&clearTimeout(this.typewriterTimeout),this.typewriterTimeouts.forEach((e=>clearTimeout(e))),this.typewriterTimeouts.clear(),this.loadingMessageElements.clear(),this.individualToolElements.clear(),this.groupSummaryTypewriterTimeout&&clearTimeout(this.groupSummaryTypewriterTimeout)}_updateToolProgress(e,t){const s=this.individualToolElements.get(e);if(!s)return;const i=s.querySelector(".mcp-main-bar");if(!i)return;let n=i.querySelector(".mcp-progress-bar-inner");const a=parseFloat(t);a>=0&&a<=100?(n||(n=document.createElement("div"),n.className="mcp-progress-bar-inner rounded-md loading-pulse-bg",n.style.position="absolute",n.style.left="0",n.style.top="0",n.style.bottom="0",n.style.height="100%",n.style.transition="width 0.3s ease-out",i.insertBefore(n,i.firstChild)),n.style.width=`${a}%`,i.classList.remove("loading-pulse-bg")):(n&&n.remove(),i.classList.add("loading-pulse-bg"))}_updateToolMessage(e,t){const s=this.loadingMessageElements.get(e);s&&s.textContent!==t&&this._typewriterEffectForTool(e,s,t)}}function mt(...e){return e.filter(Boolean).join(" ")}customElements.get("mcp-tool-usage")||customElements.define("mcp-tool-usage",ht);class ut extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._sources=[],this._currentIndex=0,this._popupVisible=!1,this.pillContainer=null,this.popupElement=null,this.hideTimeout=null,this.showPopup=this.showPopup.bind(this),this.hidePopup=this.hidePopup.bind(this),this.handlePillClick=this.handlePillClick.bind(this),this.navigateToNext=this.navigateToNext.bind(this),this.navigateToPrev=this.navigateToPrev.bind(this),this.keepPopupOpen=this.keepPopupOpen.bind(this),this._handlePopupContentClick=this._handlePopupContentClick.bind(this)}static get observedAttributes(){return["sources"]}get sources(){return this._sources}set sources(e){if("string"==typeof e)try{this._sources=JSON.parse(e)}catch(e){let t="Unknown parsing error";e instanceof Error?t=e.message||e.toString():e&&"function"==typeof e.toString&&(t=e.toString()),this._sources=[]}else Array.isArray(e)?this._sources=e:this._sources=[];this._currentIndex=0,this.isConnected&&this.render()}_getFreezeContext(){const e=this.closest("markdown-content"),t=this.closest("[block-id]");return{mc:e,blockId:t?t.getAttribute("block-id"):null}}attributeChangedCallback(e,t,s){"sources"===e&&t!==s&&(this.sources=s)}connectedCallback(){if(this.style.fontFamily='var(--font-family, -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif)',this.classList.add("inline-block","relative","mx-0.5"),!this.hasAttribute("sources")&&this.innerHTML.trim().startsWith("["))try{const e=this.innerHTML.trim();this.sources=JSON.parse(e),this.innerHTML=""}catch(e){this.innerHTML=""}!this.pillContainer&&this._sources.length>0?this.render():0===this._sources.length&&(this.style.display="none")}disconnectedCallback(){if(this.hideTimeout&&clearTimeout(this.hideTimeout),this.pillContainer&&(this.pillContainer.removeEventListener("mouseenter",this.showPopup),this.pillContainer.removeEventListener("mouseleave",this.hidePopup),this.pillContainer.removeEventListener("click",this.handlePillClick)),this.popupElement){this.popupElement.removeEventListener("mouseenter",this.keepPopupOpen),this.popupElement.removeEventListener("mouseleave",this.hidePopup);const e=this.popupElement.querySelector(".source-popup-header");e&&e.removeEventListener("click",this._handlePopupContentClick);const t=this.popupElement.querySelector(".source-popup-content-area");t&&t.removeEventListener("click",this._handlePopupContentClick),this.popupElement.remove(),this.popupElement=null}const{mc:e,blockId:t}=this._getFreezeContext();e&&t&&e.getAttribute("data-hover-freeze")===t&&e.removeAttribute("data-hover-freeze")}keepPopupOpen(){if(this.hideTimeout&&clearTimeout(this.hideTimeout),this.popupElement){this._popupVisible=!0;const{mc:e,blockId:t}=this._getFreezeContext();e&&t&&e.setAttribute("data-hover-freeze",t),this.popupElement.classList.remove("invisible","opacity-0"),this.popupElement.classList.add("opacity-100"),this.popupElement.style.transform="translateY(-50%) scale(1)"}}_handlePopupContentClick(e){const t=this._sources[this._currentIndex];t&&t.source_URL&&window.open(t.source_URL,"_blank","noopener noreferrer")}render(){if(this.innerHTML="",!this._sources||0===this._sources.length)return void(this.style.display="none");this.style.display="inline-block";const e=document.createElement("div");if(e.className="inline-flex items-center",this._sources.length>1&&e.classList.add("pb-3"),this._sources.length>1){const t=document.createElement("span");t.textContent="Sources:",t.className=mt("mr-1 text-xs font-medium",this.theme.sourceTileFadedText),e.appendChild(t)}this.pillContainer=document.createElement("div"),this.pillContainer.className=mt("source-pill-container","inline-flex","items-center","px-2.5","py-1","rounded-full","cursor-pointer","text-xs","font-medium","transition-colors","duration-150",this.theme.sourceTileBackground,this.theme.sourceTileText,this.theme.sourceTileBackgroundHover,"max-w-[150px]");const t=this._sources[0];if(t.source_icon){const e=this._createIconElement(t.source_icon,"w-4 h-4 mr-1.5");this.pillContainer.appendChild(e)}else if(t.source_img){const e=document.createElement("img");e.src=t.source_img,e.alt="",e.className="w-4 h-4 mr-1.5 rounded-full object-contain flex-shrink-0",this.pillContainer.appendChild(e)}const s=document.createElement("span");if(s.textContent=t.source_title||"Source",s.className="truncate flex-grow min-w-0",this.pillContainer.appendChild(s),this._sources.length>1){const e=document.createElement("span");e.textContent=" +"+(this._sources.length-1),e.className=mt("ml-1 flex-shrink-0",this.theme.sourceTileFadedText),this.pillContainer.appendChild(e)}e.appendChild(this.pillContainer),this.appendChild(e),this.createPopup(),this.pillContainer.addEventListener("mouseenter",this.showPopup),this.pillContainer.addEventListener("mouseleave",this.hidePopup),this.pillContainer.addEventListener("click",this.handlePillClick)}createPopup(){this.popupElement&&this.popupElement.remove(),this.popupElement=document.createElement("div"),this.popupElement.style.fontFamily='var(--font-family, -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif)',this.popupElement.className=mt("source-popup","w-72","z-[2147483647]","rounded-lg","shadow-xl",this.theme.modalBackground,this.theme.sourceTileText,"opacity-0","invisible","transition-all","duration-200","ease-out","transform","flex","flex-col","pt-4","pl-4","pr-4"),this.popupElement.style.position="fixed",this.popupElement.style.transform="translateY(-50%) scale(0.95)",this.popupElement.classList.add("ring-1",this.theme.ringColor),this.updatePopupContent(),document.body.appendChild(this.popupElement),this.popupElement.addEventListener("mouseenter",this.keepPopupOpen),this.popupElement.addEventListener("mouseleave",this.hidePopup)}showPopup(){if(this.hideTimeout&&clearTimeout(this.hideTimeout),!this.popupElement||this._popupVisible)return;this._popupVisible=!0;const{mc:e,blockId:t}=this._getFreezeContext();e&&t&&e.setAttribute("data-hover-freeze",t),this.updatePopupContent();const s=this.pillContainer.getBoundingClientRect();this.popupElement.style.visibility="hidden",this.popupElement.style.display="flex";const i=this.popupElement.getBoundingClientRect();this.popupElement.style.display="",this.popupElement.style.visibility="";let n=s.top+s.height/2,a=s.right+8;this.popupElement.style.transformOrigin="left center",a+i.width>window.innerWidth-8&&(a=s.left-i.width-8,this.popupElement.style.transformOrigin="right center"),a=Math.max(8,Math.min(a,window.innerWidth-i.width-8));const o=i.height/2;n=Math.max(8+o,Math.min(n,window.innerHeight-8-o));const r=a+window.scrollX,l=n+window.scrollY;this.popupElement.style.left=`${r}px`,this.popupElement.style.top=`${l}px`,this.popupElement.classList.remove("invisible","opacity-0"),this.popupElement.classList.add("opacity-100"),this.popupElement.style.transform="translateY(-50%) scale(1)"}updatePopupContent(){if(!this.popupElement||!this._sources||0===this._sources.length)return;const e=this._sources[this._currentIndex];if(!e)return;this.popupElement.innerHTML="";const t=1===this._sources.length;t?this.popupElement.classList.remove("pb-4"):this.popupElement.classList.add("pb-4");const s=document.createElement("div");if(s.className=mt("source-popup-header","flex items-center mb-2.5 flex-shrink-0 min-h-[28px]",e.source_URL?"cursor-pointer":""),e.source_icon){const t=this._createIconElement(e.source_icon,"w-5 h-5 mr-2");s.appendChild(t)}else if(e.source_img){const t=document.createElement("img");t.src=e.source_img,t.alt="",t.className="w-5 h-5 mr-2 rounded-full object-contain flex-shrink-0",s.appendChild(t)}const i=document.createElement("span");i.textContent=e.source_title||"Untitled Source",i.className="font-semibold text-sm leading-tight break-all",s.appendChild(i),e.source_URL&&s.addEventListener("click",this._handlePopupContentClick),this.popupElement.appendChild(s);const n=document.createElement("div");n.className=mt("source-popup-content-area","flex-grow h-28 overflow-y-auto",e.source_URL?"cursor-pointer":"",t?"":"mb-3");let a=!1;if(e.source_page_title){const t=document.createElement("div");t.textContent=e.source_page_title,t.className=mt("text-sm font-medium leading-tight",this.theme.sourceTileText,"mb-1","break-all"),n.appendChild(t),a=!0}if(e.source_excerpt){const t=document.createElement("div");t.textContent=e.source_excerpt,t.className=mt("text-xs leading-snug",this.theme.sourceTileFadedText,a?"mt-1":"","break-all"),n.appendChild(t)}if(e.source_URL&&n.addEventListener("click",this._handlePopupContentClick),this.popupElement.appendChild(n),!t){const e=document.createElement("div");e.className=mt("flex items-center justify-between pt-3 flex-shrink-0","border-t",this.theme.modalSeperationBorderColor);const t=document.createElement("button");t.innerHTML="&#x276E;",t.className=mt("px-2.5 py-1 rounded text-xs",this.theme.secondaryButton,"hover:opacity-80 disabled:opacity-50 transition-opacity"),t.disabled=0===this._currentIndex,t.addEventListener("click",(e=>{e.stopPropagation(),this.navigateToPrev()}));const s=document.createElement("span");s.textContent=`${this._currentIndex+1} of ${this._sources.length}`,s.className=mt("text-xs",this.theme.sourceTileFadedText);const i=document.createElement("button");i.innerHTML="&#x276F;",i.className=mt("px-2.5 py-1 rounded text-xs",this.theme.secondaryButton,"hover:opacity-80 disabled:opacity-50 transition-opacity"),i.disabled=this._currentIndex===this._sources.length-1,i.addEventListener("click",(e=>{e.stopPropagation(),this.navigateToNext()})),e.appendChild(t),e.appendChild(s),e.appendChild(i),this.popupElement.appendChild(e)}}hidePopup(){this.hideTimeout=setTimeout((()=>{this.popupElement&&(this._popupVisible=!1,this.popupElement.classList.remove("opacity-100"),this.popupElement.classList.add("opacity-0"),this.popupElement.style.transform="translateY(-50%) scale(0.95)",setTimeout((()=>{if(!this._popupVisible){this.popupElement.classList.add("invisible");const{mc:e,blockId:t}=this._getFreezeContext();e&&t&&e.getAttribute("data-hover-freeze")===t&&e.removeAttribute("data-hover-freeze")}}),200))}),200)}handlePillClick(e){e.stopPropagation();const t=this._sources[this._currentIndex];t&&t.source_URL&&window.open(t.source_URL,"_blank","noopener noreferrer")}navigateToNext(){this._currentIndex<this._sources.length-1&&(this._currentIndex++,this.updatePopupContent())}navigateToPrev(){this._currentIndex>0&&(this._currentIndex--,this.updatePopupContent())}_createIconElement(e,t){const s={pdf:"filePDF",document:"fileWord",spreadsheet:"tableList",image:"image",file:"folder"}[e]||"folder",i=o.A.name(s),n=document.createElement("div");n.className=mt("flex-shrink-0 rounded-full flex items-center justify-center",this.theme.secondaryButton,t);const a=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-2/3 h-2/3",colorClass:this.theme.sourceTileText});return a.element&&n.appendChild(a.element),n}}window.customElements&&!window.customElements.get("source-tag")&&window.customElements.define("source-tag",ut);var pt=s(75698);function gt(e,...t){true}class ft extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._code="",this._title="Mermaid Diagram",this._readonly=!1,this._chatId="",this._mode="",this._minimize=!1,this.diagramId=`mermaid-elem-${Date.now()}-${Math.floor(1e5*Math.random())}`,this.focusInstance=null,this.minimizedView=null,gt(this.diagramId),this.initializeMermaid()}initializeMermaid(){const e="#121212"===this.theme.backgroundHEX||this.theme.background&&(this.theme.background.includes("bg-zinc-900")||this.theme.background.includes("bg-gray-900")||this.theme.background.includes("bg-slate-900"));try{pt.A.initialize({startOnLoad:!1,theme:e?"dark":"default",securityLevel:"loose",fontFamily:"Arial, sans-serif"}),gt(0,pt.A.mermaidAPI.getConfig())}catch(e){}}static get observedAttributes(){return["code","diagram-title","chatid","readonly","mode","minimize"]}get code(){return this._code}set code(e){const t=e||"";this._code!==t&&(this._code=t,this.setAttribute("code",btoa(encodeURIComponent(this._code))),this.isConnected&&Promise.resolve().then((()=>{this.isConnected&&this.renderDiagram()})))}get title(){return this._title}set title(e){this._title=e||"Mermaid Diagram",this.setAttribute("diagram-title",this._title),this.focusWindowMenu&&this.focusWindowMenu.menuTitleElement&&(this.focusWindowMenu.menuTitleElement.textContent=this._title)}get chatId(){return this._chatId}set chatId(e){this._chatId=e,this.setAttribute("chatid",e)}get readonly(){return this._readonly}set readonly(e){this._readonly=!0===e||"true"===e||""===e,this._readonly?this.setAttribute("readonly",""):this.removeAttribute("readonly")}get mode(){return this._mode}set mode(e){this._mode!==e&&(this._mode=e,this.setAttribute("mode",e))}get minimize(){return this._minimize}set minimize(e){const t=!0===e||"true"===e||""===e||null===e;this._minimize!==t&&(this._minimize=t,this._minimize?(this.setAttribute("minimize","true"),this.isConnected&&"focus"!==this._mode&&this.minimizeInChat()):(this.removeAttribute("minimize"),this.isConnected&&"focus"!==this._mode&&this.maximizeInChat()))}attributeChangedCallback(e,t,s){if(gt((t&&t.substring(0,20),s&&s.substring(0,20))),t!==s)switch(e){case"code":const e=s?decodeURIComponent(atob(s)):"";this._code!==e&&(this._code=e,this.isConnected&&Promise.resolve().then((()=>{this.isConnected&&this.renderDiagram()})));break;case"diagram-title":this.title=s;break;case"chatid":this.chatId=s;break;case"readonly":this.readonly=null!==s;break;case"mode":this.mode=s;break;case"minimize":this.minimize=null!==s}}connectedCallback(){gt((this.diagramId,this._code&&this._code.substring(0,30))),this.innerHTML="","focus"!==this._mode&&(this.marginWrapper=document.createElement("div"),this.marginWrapper.classList.add("mermaid-diagram-margin-wrapper","my-2"),this.appendChild(this.marginWrapper)),this.wrapper=document.createElement("div"),this.wrapper.classList.add("rounded-t-lg","rounded-b-md");("focus"===this._mode?this:this.marginWrapper).appendChild(this.wrapper),this.renderToolbar(),this.renderDiagramContainer(),this._minimize&&"focus"!==this._mode?this.minimizeInChat():Promise.resolve().then((()=>{this.isConnected&&this.renderDiagram()}))}disconnectedCallback(){gt(this.diagramId),this.diagramElement&&this.diagramElement.dataset.focusListenerAttached&&(this.diagramElement.removeEventListener("click",this.handleFocus.bind(this)),delete this.diagramElement.dataset.focusListenerAttached)}renderToolbar(){const e={title:this._title,mode:this._mode,simpleModeTitle:"Mermaid",extension:"mmd",fileMenu:[{type:"item",label:"Download SVG",onClick:()=>{this.downloadSVG()}},{type:"item",label:"Download PNG",onClick:()=>{this.downloadPNG()}},{type:"divider"},{type:"item",label:"Copy diagram code",onClick:()=>{this.copyToClipboard()}}],editMenu:[{type:"item",label:"Edit diagram",onClick:()=>{this.editDiagram()}}],viewMenu:[{type:"item",label:"Enter full screen",onClick:()=>this.openFullScreen()}],quickActions:[{type:"icon",icon:"copy",hoverText:"Copy",onClick:()=>{this.copyToClipboard()}}],onTitleChange:e=>{this.title=e},onEnterFocus:()=>{this.handleFocus()},onExitFocus:()=>{this.originalInstance&&this.originalInstance.closeFocus&&this.originalInstance.closeFocus(),this.cleanup()}};this.focusWindowMenu=new D(e),this.menuElement=this.focusWindowMenu.create(),this.wrapper.appendChild(this.menuElement)}renderDiagramContainer(){gt(),this.diagramContainer=document.createElement("div"),this.diagramContainer.classList.add("p-4","rounded-b-md","overflow-auto"),this.diagramContainer.classList.add(...this.theme.secondaryBackground.split(" ")),this.diagramContainer.style.display="block","focus"===this._mode?this.diagramContainer.style.height="calc(var(--vh)*100 - 86px)":this.diagramContainer.classList.add("min-h-[150px]","max-h-[500px]"),this.diagramElement=document.createElement("div"),this.diagramElement.id=this.diagramId,this.diagramElement.style.width="100%",this.diagramElement.style.minHeight="150px",this.diagramElement.style.border="2px dashed hotpink",this.diagramElement.setAttribute("data-mermaid-id",this.diagramId),this.diagramContainer.appendChild(this.diagramElement),this.wrapper.appendChild(this.diagramContainer);const e=document.createElement("style"),t="#121212"===this.theme.backgroundHEX?"#E0E0E0":"#212121";e.textContent=`\n            mermaid-diagram { display: block; width: 100%; max-width: 800px; margin: 0 auto; }\n            #${this.diagramId} {\n                display: flex; \n                justify-content: center;\n                align-items: center;\n                width: 100%; \n                height: 100%; /* Allow it to take full height of diagramContainer if possible */\n                min-height: 150px;\n                padding: 0px; \n                box-sizing: border-box;\n                position: relative; \n            }\n            #${this.diagramId} > svg { \n                display: block !important; \n                border: 1px solid limegreen; \n            }\n            #${this.diagramId} .label { font-family: Arial, sans-serif !important; fill: ${t} !important; }\n            #${this.diagramId} .node rect, #${this.diagramId} .node circle, #${this.diagramId} .node ellipse, #${this.diagramId} .node polygon, #${this.diagramId} .node path { stroke-width: 2px; }\n        `,this.appendChild(e),gt(0,this.diagramElement.id)}async renderDiagram(){if(gt((this.diagramId,this.diagramElement,this._code&&this._code.substring(0,50))),!this.diagramElement)return void gt();const e=document.getElementById(this.diagramId);if(!e)return gt(this.diagramId),this.diagramElement&&(this.diagramElement.innerHTML=`<div style="color:red; font-weight:bold;">Error: Target element (ID: ${this.diagramId}) not found in DOM.</div>`),void this.removeLoadingOverlay();if(gt(this.diagramId),e.style.borderColor="cyan",e.style.backgroundColor="rgba(0, 255, 255, 0.05)",!this._code||""===this._code.trim())return e.innerHTML=`<div class="${this.theme.fadedText.split(" ").join(" ")} p-4 text-center">No diagram code.</div>`,void this.removeLoadingOverlay();this.showLoadingOverlay();try{if(gt(this.diagramId),e.innerHTML="",void 0===pt.A||"function"!=typeof pt.A.render)throw new Error("Mermaid library or mermaid.render function is not available.");const{svg:t,bindFunctions:s}=await pt.A.render(this.diagramId,this._code);if(gt((this.diagramId,t&&t.length)),!t||""===t.trim())throw new Error("Mermaid.render produced an empty SVG string.");const i=new DOMParser,n=i.parseFromString(t,"image/svg+xml").documentElement;if(!n||"svg"!==n.nodeName.toLowerCase()||n.querySelector("parsererror")){const e=n&&n.querySelector("parsererror")?n.querySelector("parsererror").textContent:"Unknown parsing error";throw gt(0),new Error("Invalid SVG string: "+e)}e.appendChild(n),gt(e.id),s&&s(e);const a=e.querySelector("svg");if(a){gt();const t=a.getAttribute("viewBox");let s=0,i=0;if(t){const e=t.split(" ");4===e.length&&(s=parseFloat(e[2]),i=parseFloat(e[3]),gt())}a.removeAttribute("width"),a.removeAttribute("height"),s>0&&i>0?(gt(),a.style.width=`${s}px`,a.style.height=`${i}px`,a.style.maxWidth="none",a.style.maxHeight="none"):(a.style.width="300px",a.style.height="200px",gt()),a.style.display="block";a.offsetHeight;const n=a.getBoundingClientRect();gt((n.width,n.height)),(n.width<10||n.height<10)&&(gt(),gt(a.outerHTML.substring(0,500)),gt((e.getBoundingClientRect().width,e.getBoundingClientRect().height)),gt((this.diagramContainer.getBoundingClientRect().width,this.diagramContainer.getBoundingClientRect().height)))}else gt()}catch(t){e&&(e.innerHTML=`\n                    <div class="${this.theme.toastError.split(" ").join(" ")} p-4 rounded" style="border:2px solid darkred; background-color: rgba(255,100,100,0.2);">\n                        <strong class="font-bold d-block mb-2">Diagram Rendering Error (ID: ${this.diagramId}):</strong>\n                        <pre class="text-xs whitespace-pre-wrap font-mono" style="max-height:200px; overflow-y:auto; background-color:rgba(0,0,0,0.05); padding:5px;">${t.message||"Unknown error"}\n\nInput Code:\n${this._code}</pre>\n                    </div>`)}finally{this.removeLoadingOverlay()}"focus"!==this._mode&&e&&!e.dataset.focusListenerAttached&&(e.addEventListener("click",this.handleFocus.bind(this)),e.style.cursor="pointer",e.dataset.focusListenerAttached="true")}showLoadingOverlay(){if(!this.diagramContainer)return void gt();if(this.diagramContainer.querySelector("#mermaid-loading-overlay"))return void gt();gt();const e=document.createElement("div");e.id="mermaid-loading-overlay",e.classList.add("absolute","inset-0","flex","items-center","justify-center","z-10"),e.classList.add(...this.theme.overlayFadeBackground.split(" "));const t=document.createElement("div");t.classList.add("flex","flex-col","items-center","gap-2");const s=document.createElement("div");s.innerHTML='<i class="fa-solid fa-spinner-third fa-spin text-3xl"></i>',s.classList.add(...this.theme.text.split(" "));const i=document.createElement("div");i.textContent="Rendering diagram...",i.classList.add(...this.theme.text.split(" "),"text-sm"),t.appendChild(s),t.appendChild(i),e.appendChild(t),this.diagramContainer.style.position="relative",this.diagramContainer.appendChild(e)}removeLoadingOverlay(){if(!this.diagramContainer)return void gt();const e=this.diagramContainer.querySelector("#mermaid-loading-overlay");e?(e.remove(),gt()):gt()}handleFocus(){gt(),this.focusInstance||(this.focusInstance=new G(this.chatId,this),"focus"!==this._mode&&this.minimizeInChat())}minimizeInChat(){if(gt(),this.wrapper&&(this.wrapper.style.display="none"),this.minimizedView)this.minimizedView.style.display="block";else{this.minimizedView=this.createMinimizedView();(this.marginWrapper||this).appendChild(this.minimizedView)}}createMinimizedView(){gt();const e=document.createElement("div");e.classList.add("pb-4","cursor-pointer","z-30");const t=document.createElement("div");t.classList.add("flex","items-center","gap-2","p-2","rounded-md",...this.theme.fileItemBackground.split(" "),...this.theme.fileItemRing.split(" "),...this.theme.ringHover.split(" "),"ring-1");const s=document.createElement("div");s.classList.add("flex","items-center","justify-center","w-8","h-8","rounded-md","bg-indigo-600",...this.theme.fileIconColor.split(" "));const i=o.A.name("diagram"),n=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4"});s.appendChild(n.element);const a=document.createElement("div");a.classList.add("flex-1");const l=document.createElement("div");l.classList.add("truncate",...this.theme.fileNameText.split(" ")),l.textContent=this.title||"Mermaid Diagram";const c=document.createElement("div");c.classList.add("text-xs","truncate",...this.theme.fileSubText.split(" ")),c.textContent="Mermaid diagram",a.appendChild(l),a.appendChild(c);const d=document.createElement("div"),h=o.A.name("expand"),m=new r.I({pathData:h.path,viewBox:h.viewBox,sizeClasses:"w-4 h-4"});return d.classList.add(...this.theme.iconColor.split(" ")),d.appendChild(m.element),t.appendChild(s),t.appendChild(a),t.appendChild(d),e.appendChild(t),t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()})),e}maximizeInChat(){gt(),this.minimizedView&&(this.minimizedView.style.display="none"),this.wrapper&&(this.wrapper.style.display="block")}closeFocus(){gt(),this.focusInstance&&(this.focusInstance.close(),this.focusInstance=null),this.setAttribute("minimize","false")}focus(e){gt(0);const t=document.createElement("mermaid-diagram");return t.setAttribute("diagram-title",this._title),t.setAttribute("code",btoa(encodeURIComponent(this._code))),t.setAttribute("mode","focus"),t.setAttribute("readonly",this._readonly?"true":"false"),t.setAttribute("chatid",this.chatId),t.originalInstance=this,t}cleanup(){gt()}copyToClipboard(){gt(),navigator.clipboard.writeText(this._code).then((()=>{this.showToast("Diagram code copied to clipboard","success")})).catch((e=>{this.showToast("Failed to copy to clipboard","error")}))}showToast(e,t="success"){gt(),new c.y(e,t,!0,!0,3e3)}async downloadSVG(){if(gt(),this.diagramElement)try{const e=this.diagramElement.querySelector("svg");if(!e)throw this.showToast("No SVG content to download.","error"),new Error("No SVG element found");const t=(new XMLSerializer).serializeToString(e.cloneNode(!0)),s=new Blob(['<?xml version="1.0" encoding="UTF-8" standalone="no"?>\n',t],{type:"image/svg+xml;charset=utf-8"}),i=URL.createObjectURL(s),n=document.createElement("a");n.href=i,n.download=`${this.title||"mermaid-diagram"}.svg`,document.body.appendChild(n),n.click(),document.body.removeChild(n),setTimeout((()=>URL.revokeObjectURL(i)),100),this.showToast("SVG downloaded successfully","success")}catch(e){this.showToast("Failed to download SVG","error")}else this.showToast("Diagram element not found.","error")}async downloadPNG(){if(gt(),this.diagramElement)try{const e=this.diagramElement.querySelector("svg");if(!e)throw this.showToast("No SVG content for PNG.","error"),new Error("No SVG element found");this.showToast("Preparing PNG download...","info");const t=e.cloneNode(!0),s=e.getBBox();let i=s.width,n=s.height;if(0===i||0===n){const t=e.getBoundingClientRect();i=t.width,n=t.height}i=Math.max(i,150),n=Math.max(n,100),t.setAttribute("width",String(i)),t.setAttribute("height",String(n));const a=document.createElement("canvas");a.width=2*i,a.height=2*n;const o=a.getContext("2d");o.fillStyle=this.theme.backgroundHEX||"#FFFFFF",o.fillRect(0,0,a.width,a.height);const r=(new XMLSerializer).serializeToString(t),l=new Image;l.onload=()=>{gt(),o.drawImage(l,0,0,a.width,a.height),a.toBlob((e=>{if(!e)return void this.showToast("Failed to create PNG blob.","error");const t=URL.createObjectURL(e),s=document.createElement("a");s.href=t,s.download=`${this.title||"mermaid-diagram"}.png`,document.body.appendChild(s),s.click(),document.body.removeChild(s),setTimeout((()=>URL.revokeObjectURL(t)),100),this.showToast("PNG downloaded successfully","success")}),"image/png")},l.onerror=e=>{this.showToast("Failed to load SVG for PNG conversion.","error")};const c="data:image/svg+xml;base64,"+btoa(unescape(encodeURIComponent(r)));l.src=c}catch(e){this.showToast("Failed to download PNG","error")}else this.showToast("Diagram element not found.","error")}editDiagram(){this.showToast("Diagram editing not implemented yet","info")}openFullScreen(){const e=document.createElement("div");e.classList.add("fixed","inset-0","w-full","h-full","z-50",...this.theme.background.split(" ")),e.style.height="100vh";const t=document.createElement("div");t.classList.add("flex","justify-between","items-center","px-4","py-2",...this.theme.focusBackground.split(" "),...this.theme.focusMenuTextColor.split(" "),"rounded-t-md");const s=document.createElement("div");s.classList.add("flex","items-center","gap-2");const i=document.createElement("div"),n=o.A.name("diagram"),a=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4"});i.appendChild(a.element);const l=document.createElement("span");l.textContent=this.title||"Mermaid Diagram",l.classList.add("font-medium"),s.appendChild(i),s.appendChild(l);const c=document.createElement("div");c.classList.add("flex","items-center","gap-4");const d=document.createElement("button");d.classList.add(...this.theme.focusMenuHover.split(" "),"p-2","rounded","flex","items-center","gap-1");const h=document.createElement("div"),m=o.A.name("download"),u=new r.I({pathData:m.path,viewBox:m.viewBox,sizeClasses:"w-4 h-4"});h.appendChild(u.element);const p=document.createElement("span");p.textContent="SVG",p.classList.add("hidden","sm:inline"),d.appendChild(h),d.appendChild(p),d.title="Download SVG",d.addEventListener("click",(()=>this.downloadSVG()));const g=document.createElement("button");g.classList.add(...this.theme.focusMenuHover.split(" "),"p-2","rounded","flex","items-center","gap-1");const f=document.createElement("div"),v=o.A.name("download"),y=new r.I({pathData:v.path,viewBox:v.viewBox,sizeClasses:"w-4 h-4"});f.appendChild(y.element);const w=document.createElement("span");w.textContent="PNG",w.classList.add("hidden","sm:inline"),g.appendChild(f),g.appendChild(w),g.title="Download PNG",g.addEventListener("click",(()=>this.downloadPNG()));const b=document.createElement("button");b.classList.add(...this.theme.focusMenuHover.split(" "),"p-2","rounded");const C=document.createElement("div"),x=o.A.name("close"),k=new r.I({pathData:x.path,viewBox:x.viewBox,sizeClasses:"w-4 h-4"});C.appendChild(k.element),b.appendChild(C),b.title="Exit full screen";const E=t=>{"Escape"===t.key&&(e.parentNode&&e.parentNode.removeChild(e),document.removeEventListener("keydown",E))};b.addEventListener("click",(()=>{e.parentNode&&e.parentNode.removeChild(e),document.removeEventListener("keydown",E)})),c.appendChild(d),c.appendChild(g),c.appendChild(b),t.appendChild(s),t.appendChild(c);const S=document.createElement("div");if(S.classList.add("w-full","h-full","overflow-auto","flex","items-center","justify-center",...this.theme.secondaryBackground.split(" ")),S.style.height="calc(100vh - 50px)",this.diagramElement){const e=this.diagramElement.cloneNode(!0),t=e.querySelector("svg");t&&(t.style.maxWidth="95%",t.style.maxHeight="95%"),S.appendChild(e)}e.appendChild(t),e.appendChild(S),document.body.appendChild(e),document.addEventListener("keydown",E)}}customElements.define("mermaid-diagram",ft);var vt=s(42845),yt=s(1575),wt=s(57644),bt=s(58903),Ct=s(3772),xt=s(86059),kt=s(25246),Et=s(46762),St=s(89781),Tt=s(38262),Lt=s(93855);const _t=new vt.hs("actionButton");class It{constructor(e,t={}){const s=e,i=_t;return new vt.k_({key:i,state:{init:()=>({panelOpen:!1,highlight:null}),apply(e,t){let s=t.highlight;s&&e.docChanged&&(s={from:e.mapping.map(s.from),to:e.mapping.map(s.to)});const n=e.getMeta(i);if(!n)return{panelOpen:t.panelOpen,highlight:s};if("open"===n.action){return{panelOpen:!0,highlight:Object.prototype.hasOwnProperty.call(n,"range")?n.range:s}}return"close"===n.action?{panelOpen:!1,highlight:s}:"clearHighlight"===n.action?{panelOpen:t.panelOpen,highlight:null}:{panelOpen:t.panelOpen,highlight:s}}},props:{decorations(e){const t=i.getState(e);if(!t||!t.highlight)return null;const{from:s,to:n}=t.highlight;if(s>=n)return null;const a=yt.NZ.inline(s,n,{class:"pm-abp-selection"});return yt.zF.create(e.doc,[a])}},view:e=>{const n="abp-styles";if(!document.getElementById(n)){const e=document.createElement("style");e.id=n,e.textContent="\n                        .pm-abp-selection { background-color: rgba(147,197,253,0.45); border-radius: 2px; }\n                        textarea.pm-abp-ta { outline: none !important; box-shadow: none !important; border: 0 !important; }\n                        textarea.pm-abp-ta:focus { outline: none !important; box-shadow: none !important; border: 0 !important; outline-offset: 0 !important; }\n                        textarea.pm-abp-ta:focus-visible { outline: none !important; box-shadow: none !important; border: 0 !important; outline-offset: 0 !important; }\n                        textarea.pm-abp-ta:active { outline: none !important; box-shadow: none !important; border: 0 !important; }\n                        .pm-abp-ta:focus-within { outline: none !important; box-shadow: none !important; }\n                    ",document.head.appendChild(e)}const a=e.dom.closest(".prosemirror-editor-wrapper")||e.dom.parentElement,l=document.createElement("div");l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.transform="translateY(-50%)",l.style.zIndex="40",l.style.display="none",l.style.opacity="0",l.style.transition="opacity 200ms ease",l.style.pointerEvents="none",l.setAttribute("contenteditable","false");const c=document.createElement("button");c.type="button",c.className="h-6 w-6 flex items-center justify-center rounded-lg bg-gray-100 hover:bg-gray-200 ring-1 ring-gray-200 transition-colors",c.setAttribute("aria-label","Edit block"),c.style.transition="opacity 150ms ease";const d=e=>{c.innerHTML="";const t="add"===e?"plus":"pen",s=o.A.name(t);if(s){const e=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-4 h-4",colorClass:"text-gray-700"});c.appendChild(e.element)}c.setAttribute("aria-label","add"===e?"Add content":"Edit block")},h=e=>{if(c.innerHTML="",e){const e=document.createElement("div");e.className="h-4 w-4 rounded-full border-2 border-gray-300 border-t-gray-700 animate-spin",c.appendChild(e),c.disabled=!0,c.classList.add("cursor-wait","opacity-90")}else c.disabled=!1,c.classList.remove("cursor-wait","opacity-90"),d("add"===k?"add":"edit")};l.appendChild(c),a&&a.appendChild(l);const m=document.createElement("div");m.style.position="absolute",m.style.top="0",m.style.left="0",m.style.transform="translateY(-50%) scaleX(0.01)",m.style.transformOrigin="left center",m.style.opacity="0",m.style.zIndex="50",m.style.display="none",m.style.pointerEvents="none",m.style.transition="opacity 180ms ease, transform 220ms cubic-bezier(0.22, 1, 0.36, 1)",m.style.willChange="transform, opacity";const u=document.createElement("div");u.className="flex items-end gap-2 p-2 rounded-lg ring-1 ring-gray-200 bg-white shadow-lg",u.style.maxWidth="520px",u.style.width="min(520px, calc(100vw - 120px))";const p=document.createElement("textarea");p.className="pm-abp-ta flex-1 text-base bg-transparent resize-none px-2 py-1",p.rows=1,p.placeholder="What do you want to add or edit?",p.style.maxHeight="160px",p.style.minHeight="32px";const g=document.createElement("button");g.type="button",g.className=`ml-1 w-[30px] h-[30px] rounded-lg flex items-center justify-center ${s.chatButtonDisabled} opacity-50 cursor-default`,g.disabled=!0;const f=o.A.name("chatSendMessage");if(f){const e=new r.I({pathData:f.path,viewBox:f.viewBox,sizeClasses:"w-4 h-4"});g.appendChild(e.element)}u.appendChild(p),u.appendChild(g),m.appendChild(u),a&&a.appendChild(m);let v=null,y=!1,w=-1,b=-1,C="hidden",x=!1,k="hidden",E=!1,S=!1,T=null,L=null,_=0,I=null,A=null;const M=()=>{E||(v&&(clearTimeout(v),v=null),l.style.opacity="0",l.style.pointerEvents="none",l.style.display="none",y=!1)},B=()=>{E||y||v||x||"hidden"===k||(v=setTimeout((()=>{l.style.display="flex",l.style.opacity="0",l.style.pointerEvents="none",requestAnimationFrame((()=>{requestAnimationFrame((()=>{l.style.opacity="1",l.style.pointerEvents="auto",y=!0}))})),v=null}),300))},D=e=>{g.innerHTML="";const t=new r.I({pathData:o.A.name("chatSendMessage").path,viewBox:o.A.name("chatSendMessage").viewBox,sizeClasses:"w-4 h-4"});g.appendChild(t.element),e?(g.className=`ml-1 w-[30px] h-[30px] rounded-lg flex items-center justify-center ${s.chatButtonEnabled} cursor-pointer`,g.disabled=!1):(g.className=`ml-1 w-[30px] h-[30px] rounded-lg flex items-center justify-center ${s.chatButtonDisabled} opacity-50 cursor-default`,g.disabled=!0)},$=()=>{if(!x)return;m.style.opacity="0",m.style.pointerEvents="none";const t=()=>{m.style.display="none",m.style.transform="translateY(-50%) scaleX(0.01)",c.style.opacity="1",m.removeEventListener("transitionend",t)};m.addEventListener("transitionend",t),x=!1;const s=e.state.tr.setMeta(i,{action:"close"});e.dispatch(s)},P=()=>{const t=e.state.selection;if(!t||!a)return E||M(),x&&$(),k="hidden",void(C="hidden");if(!(t instanceof vt.U3))return E||M(),x&&$(),k="hidden",void(C="hidden");let s,i=t.from;E&&S&&null!=T&&(i=T);try{s=e.coordsAtPos(i)}catch{return E||M(),x&&$(),k="hidden",void(C="hidden")}if(k=(e=>{if(!(e instanceof vt.U3))return"hidden";if(e.empty){const t=e.$from.parent;return t&&t.isTextblock&&0===(t.textContent||"").trim().length?"add":"hidden"}{let t="";try{t=e.content().content.textBetween(0,e.content().size).trim()}catch{}return t.length>0?"edit":"hidden"}})(t),I=i,!E&&"hidden"===k)return M(),x&&$(),w=t.from,b=t.to,void(C=k);E||d(k);const n=a.getBoundingClientRect();let o;if(E&&S&&null!=L){const e=(a.scrollTop||0)-(_||0);o=L+e}else{o=(s.top+s.bottom)/2-n.top+(a.scrollTop||0)}const r=parseFloat(getComputedStyle(a).paddingLeft||"0"),c=Math.max(4,r-36);l.style.top=`${o}px`,l.style.left=`${c}px`;const h=parseFloat(l.style.left)||c;m.style.top=`${o}px`,m.style.left=`${h}px`;const u=t.from!==w||t.to!==b||C!==k;w=t.from,b=t.to,x||(E?(l.style.display="flex",l.style.opacity="1",l.style.pointerEvents="auto",y=!0):y||v?u&&!y&&B():B()),C=k},N=()=>P(),z=()=>P(),F=e=>{x&&(m.contains(e.target)||l.contains(e.target)||$())},R=()=>{const s=p.value.trim();if(!s)return;p.value="",D(!1),(()=>{if(!x)return;m.style.transform="translateY(-50%) scaleX(0.01)",m.style.opacity="0",m.style.pointerEvents="none";const t=()=>{m.style.display="none",c.style.opacity="1",m.removeEventListener("transitionend",t)};m.addEventListener("transitionend",t),x=!1;const s=e.state.tr.setMeta(i,{action:"close"});e.dispatch(s)})(),E=!0;const n=e.state,o=i.getState(n),r=n.selection,l="edit"===k&&o&&o.highlight?o.highlight:r?{from:r.from,to:r.to}:null;S=!0;const d=null!=A?A:"edit"===k&&l?l.from:r?r.from:0;T=d;try{const t=e.coordsAtPos(d),s=a.getBoundingClientRect(),i=(t.top+t.bottom)/2;L=i-s.top+(a.scrollTop||0),_=a.scrollTop||0}catch{L=null,_=0}h(!0);let u=null;if(l&&l.from!==l.to)try{const t=e.state.doc.slice(l.from,l.to);u=e.state.schema.topNodeType.create(null,t.content).toJSON()}catch(e){}const g={message:s,range:l,mode:"edit"===k?"replace":"append",anchorPos:d,view:e,selectedText:l?e.state.doc.textBetween(l.from,l.to):null,selectionProsemirror:u},f=()=>{E=!1,S=!1,T=null,A=null,L=null,_=0,h(!1);const t=e.state.tr.setMeta(i,{action:"clearHighlight"});e.dispatch(t),P()};try{const e="function"==typeof t.onSubmit?t.onSubmit(g):Promise.resolve();e&&"function"==typeof e.then?e.then(f).catch(f):setTimeout(f,200)}catch(e){setTimeout(f,200)}};return c.addEventListener("mousedown",(t=>{t.preventDefault(),A=I,E||(x?$():(p.value="",D(!1),(()=>{if(x)return;m.style.display="block",m.style.pointerEvents="none",c.style.opacity="0";const t=e.state;let s=null;"edit"===k&&t.selection&&!t.selection.empty&&(s={from:t.selection.from,to:t.selection.to});const n=t.tr.setMeta(i,{action:"open",range:s});e.dispatch(n),m.style.opacity="0",m.style.transform="translateY(-50%) scaleX(0.01)",requestAnimationFrame((()=>{requestAnimationFrame((()=>{p.placeholder="add"===k?"What do you want to add?":"What do you want to add or edit?",m.style.transform="translateY(-50%) scaleX(1)",m.style.opacity="1",m.style.pointerEvents="auto",x=!0,p.focus()}))}))})()))})),p.addEventListener("input",(()=>{const e=p.value.trim().length>0;D(e),p.style.height="auto",p.style.height=Math.min(160,Math.max(32,p.scrollHeight))+"px"})),p.addEventListener("keydown",(e=>{"Escape"===e.key?(e.preventDefault(),$()):"Enter"!==e.key||e.shiftKey||(e.preventDefault(),g.disabled||R())})),g.addEventListener("click",(()=>{g.disabled||R()})),a&&a.addEventListener("scroll",N),window.addEventListener("resize",z),document.addEventListener("mousedown",F,!0),P(),{update(){P()},destroy(){a&&a.removeEventListener("scroll",N),window.removeEventListener("resize",z),document.removeEventListener("mousedown",F,!0),v&&clearTimeout(v),m.remove(),l.remove()}}}})}}class At{constructor(e,t,s,i){this.node=e,this.view=t,this.getPos=s,this.theme=i,this.aspectRatio=0,this.resizing=!1,this.instanceId=Math.random().toString(36).slice(2,9),this.dom=document.createElement("span"),this.dom.className="image-view-wrapper group",this.dom.style.cssText="position: relative; display: inline-block; line-height: 0; max-width: 100%;",e.attrs.width&&(this.dom.setAttribute("data-width",e.attrs.width),this.dom.style.width=`${e.attrs.width}px`),e.attrs.height&&(this.dom.setAttribute("data-height",e.attrs.height),this.dom.style.height=`${e.attrs.height}px`),e.attrs.id&&this.dom.setAttribute("data-block-id",e.attrs.id),this.imageContainer=document.createElement("span"),this.imageContainer.style.cssText="position: relative; width: 100%; height: 100%; display:inline-block;",this.img=document.createElement("img"),this.img.className="prosemirror-image",this.syncAttrsToDOM(e.attrs),this.imageContainer.appendChild(this.img),this.dom.appendChild(this.imageContainer),this.controls=document.createElement("span"),this.controls.className="image-controls",this.controls.setAttribute("contenteditable","false"),this.controls.style.cssText="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;",this.dom.appendChild(this.controls),this.handle=document.createElement("span"),this.handle.className="image-resize-handle",this.handle.style.cssText="\n            position: absolute;\n            bottom: 0;\n            left: 0;\n            width: 100%;\n            height: 10px;\n            cursor: ns-resize;\n            display: none;\n            pointer-events: auto;\n            z-index: 10;\n            display:flex;\n            align-items:center;\n            justify-content:center;\n        ";const n=document.createElement("span");n.className="opacity-0 group-hover:opacity-50 transition-opacity",n.style.cssText=`\n            width: 40px;\n            height: 4px;\n            border-radius: 2px;\n            background-color: ${this.theme.textInputBorder||"#cccccc"};\n            margin: 3px auto 0;\n            display:inline-block;\n        `,this.handle.appendChild(n),this.controls.appendChild(this.handle),this.img.onload=()=>{if(this.img.naturalWidth&&this.img.naturalHeight){if(this.aspectRatio=this.img.naturalWidth/this.img.naturalHeight,!this.node.attrs.width&&!this.node.attrs.height){const e=600;let t=this.img.naturalWidth,s=this.img.naturalHeight;t>e&&(t=e,s=t/this.aspectRatio),this.dom.style.width=`${t}px`,this.dom.style.height=`${s}px`,this.dom.setAttribute("data-width",t),this.dom.setAttribute("data-height",s)}this.syncAttrsToDOM(this.node.attrs)}},this.img.complete&&this.img.naturalWidth&&this.img.naturalHeight&&this.img.onload();(()=>{if(this.node.attrs.id)return;const e=this.getPos&&"function"==typeof this.getPos?this.getPos():null,t="img_"+Math.random().toString(36).slice(2,11),s={...this.node.attrs,id:t};if(null!=e){const{state:i}=this.view,n=i.tr.setNodeMarkup(e,null,s);this.view.dispatch(n),this.dom.setAttribute("data-block-id",t)}})(),this.handle.addEventListener("mousedown",this._startResize.bind(this)),this._resizing=this._resizing.bind(this),this._stopResize=this._stopResize.bind(this)}syncAttrsToDOM(e){this.img.setAttribute("src",e.src),this.img.style.display="block",this.img.style.objectFit="contain",e.id&&this.dom.setAttribute("data-block-id",e.id),e.title?this.img.setAttribute("title",e.title):this.img.removeAttribute("title"),e.alt?this.img.setAttribute("alt",e.alt):this.img.removeAttribute("alt");let t=e.width?parseInt(e.width,10):null,s=e.height?parseInt(e.height,10):null;this.aspectRatio>0&&(t&&!s?s=Math.round(t/this.aspectRatio):s&&!t&&(t=Math.round(s*this.aspectRatio))),t?(this.dom.style.width=`${t}px`,this.dom.setAttribute("data-width",t),this.img.style.width="100%"):(this.dom.style.removeProperty("width"),this.dom.removeAttribute("data-width"),this.img.style.removeProperty("width")),s?(this.dom.style.height=`${s}px`,this.dom.setAttribute("data-height",s),this.img.style.height="100%"):(this.dom.style.removeProperty("height"),this.dom.removeAttribute("data-height"),this.img.style.height="auto"),t||s||(this.img.style.width="100%",this.img.style.height="auto")}ignoreMutation(){return!0}stopEvent(e){return this.handle.contains(e.target)}selectNode(){this.dom.classList.add("ProseMirror-selectednode"),this.view.props.editable&&this.view.props.editable()&&(this.handle.style.display="flex")}deselectNode(){this.dom.classList.remove("ProseMirror-selectednode"),this.handle.style.display="none"}_startResize(e){e.preventDefault(),e.stopPropagation(),this.resizing=!0,this.startY=e.pageY,this.startHeight=this.dom.offsetHeight,this.startWidth=this.dom.offsetWidth,!this.aspectRatio&&this.startWidth&&this.startHeight&&(this.aspectRatio=this.startWidth/this.startHeight),document.addEventListener("mousemove",this._resizing),document.addEventListener("mouseup",this._stopResize),this.resizeOverlay=document.createElement("div"),this.resizeOverlay.style.cssText="position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 9999; cursor: ns-resize;",document.body.appendChild(this.resizeOverlay)}_resizing(e){if(!this.resizing)return;const t=e.pageY-this.startY;let s=this.startHeight+t,i=this.startWidth;if(this.aspectRatio&&(i=s*this.aspectRatio),s=Math.max(50,s),i=Math.max(50,i),this.img.naturalWidth&&this.img.naturalHeight){const e=this.img.naturalHeight,t=this.img.naturalWidth;s>e&&(s=e,i=this.aspectRatio?s*this.aspectRatio:t),i>t&&(i=t,s=this.aspectRatio?i/this.aspectRatio:e)}const n=.8*window.innerHeight,a=.9*window.innerWidth;s>n&&(s=n,i=this.aspectRatio?s*this.aspectRatio:i),i>a&&(i=a,s=this.aspectRatio?i/this.aspectRatio:s),this.dom.style.width=`${i}px`,this.dom.style.height=`${s}px`}_stopResize(){if(!this.resizing)return;this.resizing=!1,document.removeEventListener("mousemove",this._resizing),document.removeEventListener("mouseup",this._stopResize),this.resizeOverlay&&this.resizeOverlay.parentNode&&this.resizeOverlay.remove();const e=parseInt(this.dom.style.width,10),t=parseInt(this.dom.style.height,10),s="function"==typeof this.getPos?this.getPos():null;if(null==s)return;const i={...this.node.attrs,width:e,height:t},{state:n}=this.view,a=n.tr.setNodeMarkup(s,null,i);this.view.dispatch(a)}update(e){if("image"!==e.type.name)return!1;const t=e.sameMarkup(this.node);return this.node=e,t||this.syncAttrsToDOM(e.attrs),!0}destroy(){document.removeEventListener("mousemove",this._resizing),document.removeEventListener("mouseup",this._stopResize),this.resizeOverlay&&this.resizeOverlay.parentNode&&this.resizeOverlay.remove()}}const Mt=new vt.hs("trackChanges");class Bt{constructor(e={}){this.userId=e.userId||"user-"+Math.random().toString(36).slice(2,9),this.userName=e.userName||"User"}create(){const e=this;return new vt.k_({key:Mt,state:{init:(t,s)=>({enabled:!0,showingChanges:!1,baselineDoc:s.doc,trackedSteps:[],trackedMaps:[],decorations:yt.zF.empty,currentAuthor:{id:e.userId,name:e.userName},versions:[],historyLoaded:!1,authorDone:[],authorUndone:[],pendingUndo:!1,pendingRedo:!1}),apply:(t,s,i,n)=>{const a={...s},o=t.getMeta(Mt)||{};if(o.loadHistory){let e=[];try{e=o.loadHistory.steps.map((e=>{const t=e.step?Tt.pn.fromJSON(n.schema,e.step):null,s=e.inverted?Tt.pn.fromJSON(n.schema,e.inverted):null;return t&&s?{step:t,inverted:s,authorId:e.authorId,authorName:e.authorName,timestamp:e.timestamp}:null})).filter(Boolean)}catch(e){}a.trackedSteps=e,a.versions=o.loadHistory.versions||[],a.historyLoaded=!0}if(void 0!==o.toggleTracking&&(a.showingChanges=!a.showingChanges,a.decorations=a.showingChanges&&a.baselineDoc?e.createChangeDecorations(n,a.baselineDoc,a.trackedSteps):yt.zF.empty),o.acceptAllChanges&&(a.baselineDoc=n.doc,a.trackedSteps=[],a.trackedMaps=[],a.decorations=yt.zF.empty),o.setAuthor&&o.setAuthor.id&&(a.currentAuthor={id:o.setAuthor.id,name:o.setAuthor.name||o.setAuthor.id}),o.setBaselineVersion&&"string"==typeof o.setBaselineVersion){const t=a.versions.find((e=>e.id===o.setBaselineVersion));if(t){const s=n.schema.nodeFromJSON(t.doc);a.baselineDoc=s,a.showingChanges&&(a.decorations=e.createChangeDecorations(n,a.baselineDoc,a.trackedSteps))}}if(o.setBaselineCurrent&&(a.baselineDoc=n.doc,a.showingChanges&&(a.decorations=e.createChangeDecorations(n,a.baselineDoc,a.trackedSteps))),o.createVersion){const e=o.createVersion.id||"v_"+Math.random().toString(36).slice(2,9),t=o.createVersion.label||null;a.versions=a.versions.concat([{id:e,label:t,authorId:a.currentAuthor.id,authorName:a.currentAuthor.name,timestamp:Date.now(),doc:n.doc.toJSON(),stepIndex:a.trackedSteps.length}])}if(o.prepareUndo){const e=a.authorDone.length?a.authorDone[a.authorDone.length-1]:a.currentAuthor;a.currentAuthor={id:e.id,name:e.name},a.pendingUndo=!0}if(o.prepareRedo){const e=a.authorUndone.length?a.authorUndone[a.authorUndone.length-1]:a.currentAuthor;a.currentAuthor={id:e.id,name:e.name},a.pendingRedo=!0}const r=!0===o.suppressTracking;if(a.enabled&&t.docChanged&&!r){const s=o.author&&o.author.id?{id:o.author.id,name:o.author.name}:a.currentAuthor;t.steps.forEach(((e,i)=>{a.trackedSteps.push({step:e,inverted:e.invert(t.docs[i]),authorId:s.id,authorName:s.name,timestamp:Date.now()})})),a.trackedMaps=a.trackedMaps.concat(t.mapping.maps),a.pendingUndo?(a.authorDone.length&&(a.authorUndone=a.authorUndone.concat(a.authorDone.pop())),a.pendingUndo=!1):a.pendingRedo?(a.authorUndone.length&&(a.authorDone=a.authorDone.concat(a.authorUndone.pop())),a.pendingRedo=!1):(a.authorDone=a.authorDone.concat(s),a.authorUndone=[]),a.showingChanges&&a.baselineDoc&&(a.decorations=e.createChangeDecorations(n,a.baselineDoc,a.trackedSteps))}return a.showingChanges&&t.docChanged||(a.decorations=a.decorations.map(t.mapping,t.doc)),a}},props:{decorations(e){return this.getState(e).decorations},editable(e){return!this.getState(e).showingChanges}}})}createChangeDecorations(e,t,s){if(!s||0===s.length)return yt.zF.empty;const i={user:{insBg:"#c8f7c5",insUnderline:"#27ae60",delBg:"#ffcccc",delColor:"#e74c3c"},assistant:{insBg:"#dbeafe",insUnderline:"#2563eb",delBg:"#f3e8ff",delColor:"#7c3aed"}},n=e.doc,a=(e,t,i=1)=>{let a=t;for(let t=e+1;t<s.length;t++){const e=s[t].step.getMap&&s[t].step.getMap();e&&"function"==typeof e.map&&(a=e.map(a,i))}return o=a,Math.max(0,Math.min(o,n.content.size));var o},o=[];for(let e=0;e<s.length;e++){const t=s[e],n=t.step.getMap&&t.step.getMap();if(!n||"function"!=typeof n.forEach)continue;const l=(r=t.authorId,/assistant|ai/i.test(String(r))?i.assistant:i.user),c=t.authorName||(/assistant|ai/i.test(String(t.authorId))?"Assistant":"User");n.forEach(((s,i,n,r)=>{if(r>n){const t=a(e,n,1),s=a(e,r,-1);s>t&&o.push(yt.NZ.inline(t,s,{class:"track-changes-insertion",style:`background-color: ${l.insBg}; text-decoration: underline; text-decoration-color: ${l.insUnderline};`,title:`Added by ${c}`}))}if(i>s&&r<=n){const s=a(e,n,1);let i="";try{t.inverted&&t.inverted.slice&&t.inverted.slice.content&&(i=t.inverted.slice.content.textBetween(0,t.inverted.slice.content.size," "))}catch(e){}o.push(yt.NZ.widget(s,(()=>{const e=document.createElement("span");return e.style.cssText=`background-color: ${l.delBg}; text-decoration: line-through; color: ${l.delColor}; margin: 0 2px;`,e.textContent=i||"",e.title=`Deleted by ${c}`,e}),{side:-1}))}}))}var r;try{return yt.zF.create(n,o)}catch{return yt.zF.empty}}static async loadHistory(e,t){if(Mt.getState(e.state).historyLoaded)return!0;try{const s=await fetch(`/api/document/${t}/history/`);if(!s.ok)throw new Error("Failed to fetch history");const i=await s.json(),n=e.state.tr.setMeta(Mt,{loadHistory:i});return e.dispatch(n),!0}catch(e){return!1}}static async loadHistoryAndToggle(e,t){await Bt.loadHistory(e,t);const s=e.state.tr.setMeta(Mt,{toggleTracking:!0});e.dispatch(s)}static smartUndo(e){let t=null;return(s,i,n)=>{if((0,St.tN)(s,i))return!0;return!Mt.getState(s).historyLoaded&&(t||(t=Bt.loadHistory(n,e).then((e=>{t=null,e&&n&&!n.isDestroyed&&(0,St.tN)(n.state,n.dispatch)}))),!0)}}static getChangesSinceVersion(e,t,s={}){const i=Mt.getState(e.state);if(!i)return[];const n=i.versions.find((e=>e.id===t)),a=n?n.stepIndex:0,o=s.authorId||null,r=i.trackedSteps.slice(a);return(o?r.filter((e=>e.authorId===o)):r).map((e=>({authorId:e.authorId,authorName:e.authorName,timestamp:e.timestamp,step:e.step&&"function"==typeof e.step.toJSON?e.step.toJSON():null,inverted:e.inverted&&"function"==typeof e.inverted.toJSON?e.inverted.toJSON():null})))}static toggle(e){const t=e.state.tr.setMeta(Mt,{toggleTracking:!0});e.dispatch(t)}static acceptAll(e){const t=e.state.tr.setMeta(Mt,{acceptAllChanges:!0});e.dispatch(t)}static setAuthor(e,t){const s=e.state.tr.setMeta(Mt,{setAuthor:{id:t.id,name:t.name}});e.dispatch(s)}static getAuthor(e){const t=Mt.getState(e.state);return t?t.currentAuthor:null}static createVersion(e,t=null,s=null){const i=e.state.tr.setMeta(Mt,{createVersion:{id:s,label:t}});e.dispatch(i)}static getVersions(e){const t=Mt.getState(e.state);return t?t.versions.slice():[]}static revertToVersion(e,t,s=null){const i=Mt.getState(e.state);if(!i)return!1;const n=i.versions.find((e=>e.id===t));if(!n)return!1;s&&s.id&&Bt.setAuthor(e,s);const a=e.state.schema.nodeFromJSON(n.doc),o=e.state.tr.replaceWith(0,e.state.doc.content.size,a);return e.dispatch(o),!0}static setBaselineToVersion(e,t){const s=e.state.tr.setMeta(Mt,{setBaselineVersion:t});e.dispatch(s)}static setBaselineToCurrent(e){const t=e.state.tr.setMeta(Mt,{setBaselineCurrent:!0});e.dispatch(t)}static isEnabled(e){const t=Mt.getState(e);return!!t&&t.enabled}static isShowingChanges(e){const t=Mt.getState(e);return!!t&&t.showingChanges}static prepareUndo(e){const t=e.state.tr.setMeta(Mt,{prepareUndo:!0});e.dispatch(t)}static prepareRedo(e){const t=e.state.tr.setMeta(Mt,{prepareRedo:!0});e.dispatch(t)}}const Dt=new vt.hs("autoSave");class $t{constructor(e={}){const t="function"==typeof e.onSave?e.onSave:null,s="number"==typeof e.minDelay?e.minDelay:800,i="number"==typeof e.maxDelay?e.maxDelay:4e3,n="number"==typeof e.idleDelay?e.idleDelay:1200;return new vt.k_({key:Dt,view(e){let a=null,o=0,r=!1,l=!1;const c=()=>{a&&(clearTimeout(a),a=null)},d=()=>{c(),r&&!l&&(r=!1,t&&t(e))},h=t=>{l||e.state.doc.eq(t.doc)||(r=!0,o=Date.now(),(()=>{if(c(),!r||l)return;const e=Date.now()-o>=i?0:Math.max(s,n);a=setTimeout(d,e)})())},m=()=>{r&&(r=!1,c(),t&&t(e))},u=()=>{r&&t&&(r=!1,c(),t(e))};return window.addEventListener("blur",m),window.addEventListener("beforeunload",u),{update(e,t){h(t)},destroy(){l=!0,c(),window.removeEventListener("blur",m),window.removeEventListener("beforeunload",u)}}}})}}var Pt=s(73557);const Nt={inline:!0,attrs:{id:{default:null},src:{default:null},alt:{default:null},title:{default:null},width:{default:null},height:{default:null}},group:"inline",draggable:!0,atom:!0,selectable:!0,parseDOM:[{tag:"span.image-view-wrapper",getAttrs(e){const t=e.querySelector("img"),s=parseInt(e.getAttribute("data-width")||e.style.width,10)||null,i=parseInt(e.getAttribute("data-height")||e.style.height,10)||null;return!!t&&{id:e.getAttribute("data-block-id")||null,src:t.getAttribute("src"),title:t.getAttribute("title"),alt:t.getAttribute("alt"),width:s,height:i}}},{tag:"img[src]",getAttrs(e){const t=parseInt(e.style.width,10)||parseInt(e.getAttribute("width"),10)||null,s=parseInt(e.style.height,10)||parseInt(e.getAttribute("height"),10)||null;return{id:e.getAttribute("data-block-id")||null,src:e.getAttribute("src"),title:e.getAttribute("title"),alt:e.getAttribute("alt"),width:t,height:s}}}],toDOM(e){const{id:t,src:s,alt:i,title:n,width:a,height:o}=e.attrs,r={class:"image-view-wrapper",style:"display: inline-block; line-height: 0;"};t&&(r["data-block-id"]=t),a&&(r["data-width"]=a,r.style+=` width: ${a}px;`),o&&(r["data-height"]=o,r.style+=` height: ${o}px;`);const l={src:s};return i&&(l.alt=i),n&&(l.title=n),l.style="width: 100%; height: 100%; object-fit: contain;",["span",r,["img",l]]}},zt={content:"inline*",group:"block",attrs:{align:{default:null}},parseDOM:[{tag:"p",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{align:s}}}],toDOM(e){const t={};return e.attrs.align&&(t.style=`text-align: ${e.attrs.align};`),["p",t,0]}},Ft={attrs:{level:{default:1},align:{default:null}},content:"inline*",group:"block",defining:!0,parseDOM:[{tag:"h1",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:1,align:s}}},{tag:"h2",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:2,align:s}}},{tag:"h3",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:3,align:s}}},{tag:"h4",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:4,align:s}}},{tag:"h5",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:5,align:s}}},{tag:"h6",getAttrs(e){const t=e.getAttribute("style")||"";let s=e.style&&e.style.textAlign||null;if(!s&&t){const e=t.match(/text-align:\s*(left|center|right|justify)/i);e&&(s=e[1].toLowerCase())}return s=e.getAttribute("data-align")||s||null,{level:6,align:s}}}],toDOM(e){const t="h"+e.attrs.level,s={};return e.attrs.align&&(s.style=`text-align: ${e.attrs.align};`),[t,s,0]}},Rt=wt.wQ.spec.nodes.update("image",Nt).update("paragraph",zt).update("heading",Ft),Ht=(0,Ct.ZW)(Rt,"block+","block").append((0,xt.of)({tableGroup:"block",cellContent:"block+",cellAttributes:{background:{default:null,getFromDOM:e=>e.style.backgroundColor||null,setDOMAttr(e,t){e&&(t.style=(t.style||"")+`background-color: ${e};`)}}}})),Ot=new bt.Sj({nodes:Ht,marks:wt.wQ.spec.marks}),qt=(0,Pt.A)("default",{html:!0,linkify:!0,typographer:!0}),jt={parse(e){const t=qt.render(e),s=document.createElement("div");s.innerHTML=t;return s.querySelectorAll("table").forEach((e=>{let t=e.querySelector("tbody"),s=e.querySelector("thead");if(!t&&!s){const t=Array.from(e.querySelectorAll("tr"));if(t.length>0){const s=t[0];if(s.querySelectorAll("th").length>0&&t.length>1){const i=document.createElement("thead");i.appendChild(s),e.insertBefore(i,e.firstChild);const n=document.createElement("tbody");for(let e=1;e<t.length;e++)n.appendChild(t[e]);e.appendChild(n)}else{const s=document.createElement("tbody");t.forEach((e=>s.appendChild(e))),e.appendChild(s)}}}})),s.querySelectorAll("li").forEach((e=>{const t=Array.from(e.children);for(let e=0;e<t.length-1;e++){const s=t[e],i=t[e+1];if(s&&i&&("P"===s.tagName&&"P"===i.tagName)){const t=i.textContent||"";if(/^\s*:/.test(t)){for(i.firstChild&&i.firstChild.nodeType===Node.TEXT_NODE&&(i.firstChild.nodeValue=i.firstChild.nodeValue.replace(/^\s*:\s?/,"")),s.appendChild(document.createTextNode(": "));i.firstChild;)s.appendChild(i.firstChild);i.remove(),e--}}}})),bt.S4.fromSchema(Ot).parse(s)}},Ut=Object.assign({},Lt.lR.nodes,{table(e,t){e.ensureNewLine();let s=!1;if(t.firstChild&&t.firstChild.firstChild){const e=t.firstChild.firstChild;s=e.firstChild&&"table_header"===e.firstChild.type.name}e.renderContent(t),e.ensureNewLine()},table_row(e,t,s,i){if(e.write("|"),t.forEach(((t,s,i)=>{i&&e.write("|"),e.write(" ");const n=[];t.forEach((e=>{e.isText?n.push(e.text):"paragraph"===e.type.name&&e.forEach((e=>{e.isText&&n.push(e.text)}))})),e.write(n.join(" ").trim()),e.write(" ")})),e.write("|"),e.ensureNewLine(),0===i){let s=!1;if(t.forEach((e=>{"table_header"===e.type.name&&(s=!0)})),s){e.write("|");for(let s=0;s<t.childCount;s++)s&&e.write("|"),e.write(" --- ");e.write("|"),e.ensureNewLine()}}},table_cell(e,t){t.forEach((t=>{"paragraph"===t.type.name?e.renderInline(t):e.renderContent(t)}))},table_header(e,t){t.forEach((t=>{"paragraph"===t.type.name?e.renderInline(t):e.renderContent(t)}))}}),Vt=new Lt.K6(Ut,Lt.lR.marks);class Wt extends HTMLElement{constructor(){super(),this._constructed=!1,this.chat=void 0!==ke&&ke&&(ke.activeChat||null)||null,this.initialContent="",this.contentType="html",this.theme=i.A.theme,this.isReadOnly=!0,this.currentDoc=null,this.editorView=null,this.focusEditorView=null,this.outerContainer=null,this.editorContainer=null,this.proseMirrorWrapper=null,this.menuBar=null,this.minimizedView=null,this._minimize=!1,this.focusInstance=null,this.currentFocusWindowMenuMode="simple",this.trackChangesPlugin=new Bt({userId:"user-"+Math.random().toString(36).slice(2,9),userName:"User"})}static get observedAttributes(){return["document-id","doc-id","title","revision","readonly"]}async connectedCallback(){this._constructed||(this.style.display="block",this.id||(this.id="richtextdocument-"+Math.random().toString(36).slice(2,9)),this._constructed=!0);const e=this.getAttribute("document-id")||this.getAttribute("doc-id");if(!e)return;N.instance.register("document",e,this),this.isReadOnly=!0;const t=await this._fetchDoc(e),s=this.getAttribute("title");this.title=s||t?.title||"Document";const i=t?.content_prosemirror;if(i&&"object"==typeof i)this.currentDoc=bt.bP.fromJSON(Ot,i),this.contentType="prosemirror";else{const e=document.createElement("div");e.innerHTML="<p></p>",this.currentDoc=bt.S4.fromSchema(Ot).parse(e),this.contentType="prosemirror"}"number"==typeof t?.revision&&this.setAttribute("revision",String(t.revision)),this.editorView&&!this.editorView.isDestroyed&&this.editorView.destroy(),this.innerHTML="",this._buildBaseHtml(),this.appendChild(this.outerContainer),this._initializeNormalEditor(),await this._primeServerHistoryBookmark(),this._minimize&&(this.editorContainer&&(this.editorContainer.style.display="none"),this.minimizedView?(this.minimizedView.parentNode!==this.outerContainer&&this.outerContainer.appendChild(this.minimizedView),this.minimizedView.style.display="block"):(this.minimizedView=this._createMinimizedView(),this.outerContainer.appendChild(this.minimizedView)),this.updateMinimizedViewTitle())}attributeChangedCallback(e,t,s){t!==s&&this.isConnected&&("title"!==e?"revision"===e&&(this.focusInstance||this._minimize)||this.focusInstance&&"document-id"!==e&&"doc-id"!==e||this.connectedCallback():this.setTitle(s||"Document"))}_createUndoRedoAuthorPlugin(e){const t=this.trackChangesPlugin.constructor.smartUndo(e);return new vt.k_({key:new vt.hs("undoRedoAuthor"),props:{handleKeyDown:(e,s)=>{const i=String(s.key||"").toLowerCase();if(!(s.metaKey||s.ctrlKey))return!1;if("z"===i&&!s.shiftKey){Bt.prepareUndo(e);return!!t(e.state,e.dispatch,e)&&(s.preventDefault(),!0)}if("z"===i&&s.shiftKey||"y"===i){Bt.prepareRedo(e);return!!(0,St.ZS)(e.state,e.dispatch)&&(s.preventDefault(),!0)}return!1}}})}_buildBaseHtml(){this.outerContainer=document.createElement("div"),this.outerContainer.classList.add("richtextdocument-outer-container","my-2","py-2"),this.outerContainer.dataset.documentId=this.id,this.editorContainer=document.createElement("div"),this.editorContainer.classList.add("richtextdocument-editor-container","flex","flex-col","relative","rounded-md","overflow-hidden"),this.menuBar=this._createMenuBar("simple"),this.proseMirrorWrapper=document.createElement("div"),this.proseMirrorWrapper.classList.add("prosemirror-editor-wrapper","px-6","pt-3","overflow-auto","flex-grow","relative"),this.proseMirrorWrapper.style.minHeight="400px",this.proseMirrorWrapper.classList.add("max-h-[400px]","sm:max-h-[600px]");const e=this.theme.inputBackground||this.theme.secondaryBackground,t=this.theme.inputText||this.theme.text;this.proseMirrorWrapper.classList.add(...e.split(" ").filter(Boolean)),this.proseMirrorWrapper.classList.add(...t.split(" ").filter(Boolean)),this.editorContainer.appendChild(this._createMinimizedWindowMenu()),this.editorContainer.appendChild(this.proseMirrorWrapper),this.outerContainer.appendChild(this.editorContainer)}_createMinimizedWindowMenu(){const e=document.createElement("div");e.className=`relative flex items-center w-full pt-2 pb-2 ${this.theme.inputBackground||this.theme.secondaryBackground}`;const t=document.createElement("div");t.className="flex items-center gap-2 truncate w-full";const s=document.createElement("span");s.className=`richtextdocument-header-title pl-6 pt-1 text-sm truncate ${this.theme.text||""}`,s.textContent=this.title||"Untitled Document",t.appendChild(s);const i=document.createElement("div");i.className="absolute top-3 right-2 flex items-center";const n=o.A.name("expand"),a=document.createElement("button");a.type="button",a.className="p-1 rounded";const l=new r.I({pathData:n.path,viewBox:n.viewBox,sizeClasses:"w-4 h-4",colorClass:this.theme.iconColor});return a.appendChild(l.element),a.addEventListener("click",(e=>{e.stopPropagation(),this.handleFocus()})),i.appendChild(a),e.appendChild(t),e.appendChild(i),e}_createMinimizedView(){const e={name:this.title||"Untitled document",file_type:"doc",extension:"doc"},t=document.createElement("div");t.className="pb-4 cursor-pointer z-30 minimized-view-wrapper";const s=new Y([e],null).createFileItem(e,e.extension);return t.appendChild(s),s.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()})),t}_createMenuBar(e="simple"){this.currentFocusWindowMenuMode=e;const t={title:this.title,mode:e,simpleModeTitle:"Document",extension:"doc",fileMenu:[{type:"item",label:"Export as PDF",onClick:()=>this._handleDownloadHtmlAction()},{type:"item",label:"Export as Word Document",onClick:()=>this._handleDownloadHtmlAction()},{type:"item",label:"Copy as Markdown",onClick:()=>this._handleDownloadMarkdownAction()},{type:"divider"},{type:"item",label:"Share",onClick:()=>this._handleDownloadMarkdownAction()}],editMenu:[{type:"item",label:"Undo",onClick:()=>this._handleUndoAction()},{type:"item",label:"Redo",onClick:()=>this._handleRedoAction()},{type:"divider"},{type:"item",label:"Select all",onClick:()=>this._handleSelectAllAction()}],viewMenu:[],onTitleChange:e=>{this.setTitle(e),this.focusInstance&&"function"==typeof this.focusInstance.updateTitle&&this.focusInstance.updateTitle(e)},onEnterFocus:()=>this.handleFocus(),onExitFocus:()=>this.closeFocus(),showRichTextControls:!0,onBold:()=>this._toggleProseMirrorMark(Ot.marks.strong,this.focusEditorView||this.editorView),onItalic:()=>this._toggleProseMirrorMark(Ot.marks.em,this.focusEditorView||this.editorView)};return new D(t)}_toggleProseMirrorMark(e,t){const s=t||this.focusEditorView||this.editorView;s&&((0,Et.wh)(e)(s.state,s.dispatch),s.focus())}_handleSaveAction(){const e=this.focusEditorView||this.editorView;e&&(this.currentDoc=e.state.doc,this.initialContent=this._proseMirrorDocToHtml(this.currentDoc),this.contentType="html",new c.y("Document content saved.","success",!0,!0,2500))}_getCurrentBlockType(e){const{$from:t}=e.selection,s=t.parent;if(s.type===Ot.nodes.paragraph)return"Paragraph";if(s.type===Ot.nodes.heading){return`Heading ${s.attrs.level}`}if(s.type===Ot.nodes.code_block)return"Code Block";if(s.type===Ot.nodes.blockquote)for(let e=t.depth;e>0;e--)if(t.node(e).type===Ot.nodes.blockquote)return"Blockquote";return"Normal text"}_updateFormatButton(e){if(!this.formatButtonText)return;const t=this._getCurrentBlockType(e);this.formatButtonText.textContent=t}_handleDownloadHtmlAction(){const e=this.getContentHtml(),t=new Blob([e],{type:"text/html"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`${(this.title||"document").replace(/[^a-z0-9]/gi,"_").toLowerCase()}.html`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(s.href),new c.y("Downloading HTML.","info",!0,!0,2e3)}_handleDownloadMarkdownAction(){const e=this.getContentMarkdown(),t=new Blob([e],{type:"text/markdown"}),s=document.createElement("a");s.href=URL.createObjectURL(t),s.download=`${(this.title||"document").replace(/[^a-z0-9]/gi,"_").toLowerCase()}.md`,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(s.href),new c.y("Downloading Markdown.","info",!0,!0,2e3)}_handleUndoAction(){const e=this.focusEditorView||this.editorView;if(!e)return;Bt.prepareUndo(e);const t=this.getAttribute("document-id")||this.getAttribute("doc-id");if(!t)return void(0,St.tN)(e.state,e.dispatch);this.trackChangesPlugin.constructor.smartUndo(t)(e.state,e.dispatch,e)||(0,St.tN)(e.state,e.dispatch)}_handleRedoAction(){const e=this.focusEditorView||this.editorView;e&&(Bt.prepareRedo(e),(0,St.ZS)(e.state,e.dispatch))}_handleSelectAllAction(){const e=this.focusEditorView||this.editorView;if(e){const{tr:t}=e.state;e.dispatch(t.setSelection(vt.U3.create(e.state.doc,0,e.state.doc.content.size))),e.focus()}}_initializeNormalEditor(){for(this.editorView&&(this.editorView.destroy(),this.editorView=null);this.proseMirrorWrapper.firstChild;)this.proseMirrorWrapper.removeChild(this.proseMirrorWrapper.firstChild);let e=this.currentDoc;if(!e){const t=document.createElement("div");t.innerHTML="<p></p>",e=bt.S4.fromSchema(Ot).parse(t),this.currentDoc=e}const t=this.getAttribute("document-id")||this.getAttribute("doc-id"),s=[this._createUndoRedoAuthorPlugin(t),this._createImageUXPlugin(),...(0,kt.WX)({schema:Ot,menuBar:!1}),(0,xt.AL)(),(0,xt.LF)(),this.trackChangesPlugin.create()],n=vt.$t.create({doc:e,plugins:s});this.editorView=new yt.Lz(this.proseMirrorWrapper,{state:n,editable:()=>!1,dispatchTransaction:e=>{if(!this.editorView)return;const t=this.editorView.state.apply(e);this.editorView.updateState(t)},attributes:{class:"prose-no-menu prose-styles"},nodeViews:{image:(e,t,s)=>new At(e,t,s,i.A.theme)}});const a=this.editorContainer.querySelector(".focus-window-menu");a&&(a.style.display="none")}_htmlToProseMirrorDoc(e){const t=document.createElement("div");t.innerHTML=e||"<p></p>";return t.querySelectorAll("table").forEach((e=>{const t=Array.from(e.querySelectorAll(":scope > tr"));if(t.length>0){const s=document.createElement("tbody"),i=t[0];if(i.querySelectorAll("th").length>0){const n=document.createElement("thead");n.appendChild(i),e.insertBefore(n,e.firstChild);for(let e=1;e<t.length;e++)s.appendChild(t[e])}else t.forEach((e=>s.appendChild(e)));s.children.length>0&&e.appendChild(s)}if(!e.querySelector("tbody")&&!e.querySelector("thead")){const t=Array.from(e.querySelectorAll("tr"));if(t.length>0){const s=document.createElement("tbody");t.forEach((e=>s.appendChild(e))),e.appendChild(s)}}})),bt.S4.fromSchema(Ot).parse(t)}_markdownToProseMirrorDoc(e){return jt.parse(e||"")||this._htmlToProseMirrorDoc("<p></p>")}_proseMirrorDocToHtml(e){const t=bt.ZF.fromSchema(Ot).serializeFragment(e.content),s=document.createElement("div");return s.appendChild(t),s.innerHTML}_proseMirrorDocToMarkdown(e){return Vt.serialize(e)}_createImageUXPlugin(){const e=Ot.nodes.image,t=(t,s)=>{const{state:i}=t;if(!i.selection.empty)return!1;const{$from:n}=i.selection;if(!n.parent.isTextblock)return!1;const a=0===n.parentOffset,o=n.parentOffset===n.parent.content.size;if("backward"===s&&!a||"forward"===s&&!o)return!1;const r=((e,t)=>{const s=e.resolve((i=t,Math.max(1,Math.min(i,e.content.size-1))));var i;for(let e=s.depth;e>0;e--){const t=s.node(e);if(t&&t.isTextblock)return{from:s.before(e),to:s.after(e),node:t}}return null})(i.doc,n.pos);if(!r||(!(l=r.node)||!l.isTextblock||0!==l.childCount&&0!==(l.textContent||"").replace(/\u200B/g,"").trim().length))return!1;var l;if("backward"===s){const s=n.nodeBefore;if(s&&s.type===e)return t.dispatch(i.tr.deleteRange(r.from,r.to).scrollIntoView()),!0}else{const s=i.doc.resolve(r.to),n=s.nodeAfter&&s.nodeAfter.firstChild;if(s.nodeAfter&&s.nodeAfter.isTextblock&&n&&n.type===e)return t.dispatch(i.tr.deleteRange(r.from,r.to).scrollIntoView()),!0}return!1};return new vt.k_({key:new vt.hs("imageUX"),props:{handleClickOn:(t,s,i,n,a,o)=>{if(!o)return!1;if(i.type===e){const e=t.state.tr.setSelection(vt.nh.create(t.state.doc,n));return t.dispatch(e),!0}return!1},handleKeyDown:(e,s)=>("Backspace"===s.key&&t(e,"backward")||!("Delete"!==s.key||!t(e,"forward")))&&(s.preventDefault(),!0),handleDOMEvents:{beforeinput:(e,s)=>{const i=s.inputType;return("deleteContentBackward"===i&&t(e,"backward")||!("deleteContentForward"!==i||!t(e,"forward")))&&(s.preventDefault(),!0)}}}})}render(){return this.outerContainer}handleFocus(){if(this.focusInstance)return;this.editorView&&!this.editorView.isDestroyed&&(this.currentDoc=this.editorView.state.doc);let e=null;if(this.chat&&(this.chat.id||this.chat.chat_id)&&(e=this.chat.id||this.chat.chat_id),!e&&this.outerContainer){const t=this.outerContainer.closest("[data-chat-id],[data-chat-container]");t&&(e=t.getAttribute("data-chat-id")||t.getAttribute("data-chat-container"))}if(!e&&ke&&ke.activeChat&&(e=ke.activeChat.chat_id||ke.activeChat.id),!e&&ke&&ke.chatInstances){const t=Object.keys(ke.chatInstances)[0];t&&(e=t)}e&&ke&&ke.chatInstances&&ke.chatInstances[e]?(this.focusInstance=new G(e,this,{doc:this.currentDoc,title:this.title}),this.minimizeInChat()):new c.y("Cannot enter focus: no chat context.","error")}minimizeInChat(){this._minimize||(this._minimize=!0,this.editorContainer&&(this.editorContainer.style.display="none"),this.minimizedView?(this.minimizedView.parentNode!==this.outerContainer&&this.outerContainer.appendChild(this.minimizedView),this.minimizedView.style.display="block"):(this.minimizedView=this._createMinimizedView(),this.outerContainer.appendChild(this.minimizedView)),this.updateMinimizedViewTitle())}updateMinimizedViewTitle(){if(this.minimizedView){const e=this.minimizedView.querySelector(".file-name");e&&(e.textContent=this.title||"Untitled Document")}}maximizeInChat(){this._minimize&&(this._minimize=!1,this.minimizedView&&(this.minimizedView.style.display="none"),this.editorContainer&&(this.editorContainer.style.display="flex"),this._initializeNormalEditor())}focus(e={}){let t;if(e.doc)t=e.doc;else{let s=void 0!==e.content?e.content:this.initialContent;t="markdown"===(e.contentType||this.contentType)?this._markdownToProseMirrorDoc(s):this._htmlToProseMirrorDoc(s)}e.title&&(this.title=e.title);const s=document.createElement("div");s.classList.add("flex","flex-col","h-[calc(100dvh-45px)]","rounded-lg"),s.classList.add("richtextdocument-editor-container");const n=this._createMenuBar("focus");s.appendChild(n.create());const a=this._createFocusToolbar();this.focusToolbarEl=a,s.appendChild(a);const o=document.createElement("div");o.classList.add("prosemirror-editor-wrapper","pl-12","pr-12","sm:pr-16","sm:pr-8","sm:pl-20","pt-10","pb-6","overflow-auto","flex-grow","relative","bg-white","text-black"),o.classList.add("prose-styles","prose-no-menu"),s.appendChild(o),this.focusEditorView&&this.focusEditorView.destroy(),this._lastSavedStepCount=0;const r=this.getAttribute("document-id")||this.getAttribute("doc-id"),l=[this._createUndoRedoAuthorPlugin(r),this._createImageUXPlugin(),...(0,kt.WX)({schema:Ot,menuBar:!1}),(0,xt.AL)(),(0,xt.LF)(),this.trackChangesPlugin.create(),new vt.k_({key:new vt.hs("formatButtonSync"),view:()=>({update:e=>{this._updateFormatButton(e.state)}})}),new It(i.A.theme,{onSubmit:e=>new Promise(((t,s)=>{const i=void 0!==ke&&ke&&ke.activeChat||null;if(!i)return new c.y("Please select a chat session to continue.","error"),s(new Error("No active chat instance."));this.setEditable(!1),this.disableFocusToolbar();try{const s=this.getAttribute("document-id")||this.getAttribute("doc-id"),n=this.focusEditorView||this.editorView,a=n?.state,o=e&&e.range&&"number"==typeof e.range.from?e.range.from:a?a.selection.from:0,r=e&&e.range&&"number"==typeof e.range.to?e.range.to:a?a.selection.to:0,l=a?this._serializeSelectionToMarkdown(a,o,r):"",c=a?this._markdownLengthToPos(a,o):null,d=a?this._markdownLengthToPos(a,r):null,h=a?this._computeHeadingPathFromPM(a,o):[];let m=null,u=null;const p=this.getContentMarkdown()||"";if("number"==typeof c&&"number"==typeof d&&c>=0&&d>=0){const e=p.slice(0,c),t=p.slice(0,d);m=(e.match(/\n/g)||[]).length,u=(t.match(/\n/g)||[]).length}const g=this.getAttribute("revision"),f=g?parseInt(g,10):null;let v=null;if(o!==r&&a)try{const e=a.doc.slice(o,r);v=Ot.topNodeType.create(null,e.content).toJSON()}catch(e){}const y={prompt:e.message,objectType:"document",objectTitle:this.title,objectId:s,range:{pm_from:o,pm_to:r,from_char_markdown:"number"==typeof c?c:null,to_char_markdown:"number"==typeof d?d:null,from_line_markdown:m,to_line_markdown:u},selection:{markdown:l,prosemirror:v,pm_from:o,pm_to:r,from_char_markdown:"number"==typeof c?c:null,to_char_markdown:"number"==typeof d?d:null,from_line_markdown:m,to_line_markdown:u},heading_path:h,doc:{revision:f,markdown_length:p.length},expected_revision:f};i.sendObjectActionMessage(y),t()}catch(e){this.setEditable(!0),this.enableFocusToolbar(),new c.y("Could not send action to chat.","error"),s(e)}}))}),new vt.k_({key:new vt.hs("alignmentMenuSync"),view:()=>({update:e=>{this._refreshAlignmentButton(e.state)}})}),new $t({onSave:()=>this._performAutoSave("auto")})],d=vt.$t.create({doc:t,plugins:l});return this.isReadOnly=!1,this.focusEditorView=new yt.Lz(o,{state:d,editable:()=>!this._isActionUpdating,dispatchTransaction:e=>{if(!this.focusEditorView)return;const t=this.focusEditorView.state.apply(e);this.focusEditorView.updateState(t)},attributes:{class:"prose-no-menu prose-styles"},nodeViews:{image:(e,t,s)=>new At(e,t,s,i.A.theme)}}),this.focusEditorView&&this.focusEditorView.dom&&this.focusEditorView.dom.classList.add("prose-no-menu","prose-styles"),setTimeout((()=>{this.focusEditorView&&!this.focusEditorView.isDestroyed&&(this.focusEditorView.focus(),this._refreshAlignmentButton(this.focusEditorView.state),this._updateFormatButton(this.focusEditorView.state))}),50),s}_isExplicitlyReadOnlyAttribute(){const e=this.getAttribute("readonly");if(null===e)return!1;const t=String(e).trim().toLowerCase();return""===t||"true"===t||"1"===t||"yes"===t||"false"!==t&&"0"!==t&&"no"!==t}_buildSavingIndicator(e,t){this._savingIndicatorEl&&("saving"===e?(this._savingIndicatorEl.textContent=t||"Saving",this._savingIndicatorEl.className="ml-auto text-xs text-gray-500"):"saved"===e?(this._savingIndicatorEl.textContent="Saved",this._savingIndicatorEl.className="ml-auto text-xs text-gray-500"):"error"===e&&(this._savingIndicatorEl.textContent=t||"Error",this._savingIndicatorEl.className="ml-auto text-xs text-red-600"))}async _performAutoSave(e="auto"){try{const t=this.focusEditorView||this.editorView;if(!t||t.isDestroyed)return;if(this._saveInFlight)return void(this._autoSavePending=!0);this._saveInFlight=!0,this._autoSavePending=!1,this._buildSavingIndicator("saving");const s=this.getAttribute("document-id")||this.getAttribute("doc-id");if(!s)return this._saveInFlight=!1,void this._buildSavingIndicator("error","No document ID");const i=(this.focusEditorView||this.editorView).state.doc.toJSON(),n=Mt.getState(t.state),a=this._lastSavedStepCount||0,o=n&&n.trackedSteps&&n.trackedSteps.length>a?n.trackedSteps.slice(a).map((e=>({step:e.step&&"function"==typeof e.step.toJSON?e.step.toJSON():null,inverted:e.inverted&&"function"==typeof e.inverted.toJSON?e.inverted.toJSON():null,authorId:e.authorId,authorName:e.authorName,timestamp:e.timestamp}))):[];if(0===o.length&&"auto"===e)return this._saveInFlight=!1,void this._buildSavingIndicator("saved");const r={snapshot_prosemirror:i,changeset:o,assets:this.extractAssetsFromDoc(t.state.doc),expected_revision:parseInt(this.getAttribute("revision")||"0",10)||null,trigger:e},l=await g.G.postData(`/api/document/${s}/autosave/`,r);if(!l||"object"!=typeof l||l.error)return this._buildSavingIndicator("error",l&&l.error?l.error:"Save failed"),void(this._saveInFlight=!1);if("number"==typeof l.revision&&this.setAttribute("revision",String(l.revision)),this._lastSavedStepCount=n&&n.trackedSteps?n.trackedSteps.length:0,this._buildSavingIndicator("saved"),this._autoSavePending)return this._autoSavePending=!1,this._saveInFlight=!1,void setTimeout((()=>this._performAutoSave("coalesce")),100);this._saveInFlight=!1}catch(e){this._saveInFlight=!1,this._buildSavingIndicator("error","Save error")}}extractAssetsFromDoc(e){const t=[],s=Ot.nodes.image;return e.descendants(((e,i)=>{if(e.type===s){const s=e.attrs.id||"img_"+(e.attrs.src||"")+"_"+i;t.push({block_id:s,src:e.attrs.src||null,alt:e.attrs.alt||null,title:e.attrs.title||null,width:e.attrs.width||null,height:e.attrs.height||null})}})),t}closeFocus(){this.focusEditorView&&!this.focusEditorView.isDestroyed&&(this.currentDoc=this.focusEditorView.state.doc,this.focusEditorView.destroy(),this.focusEditorView=null);const e=this.focusInstance;e&&"function"==typeof e.close&&e.close();const t=this.editorContainer.querySelector(".focus-window-menu");t&&(t.style.display=this.isReadOnly?"none":"flex"),this.maximizeInChat(),this.focusInstance=null,this.updateMinimizedViewTitle(),this.menuBar&&this.menuBar.element&&"function"==typeof this.menuBar.updateMode&&this.menuBar.updateMode("simple")}_createFocusToolbar(){const e=document.createElement("div");e.className="flex items-center gap-2 p-2 bg-gray-100";const t="h-7 flex items-center justify-center rounded-md bg-gray-100 hover:bg-gray-200 transition-colors",s=`${t} w-7`,i=`${t} px-3 gap-2 text-sm text-gray-800`,n="text-gray-700",a="w-4 h-4",l=o.A.name("undo");if(l){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Undo");const i=new r.I({pathData:l.path,viewBox:l.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{e.preventDefault(),this._handleUndoAction();const t=this.focusEditorView;t&&t.focus()})),e.appendChild(t)}const c=o.A.name("redo");if(c){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Redo");const i=new r.I({pathData:c.path,viewBox:c.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{e.preventDefault(),this._handleRedoAction();const t=this.focusEditorView;t&&t.focus()})),e.appendChild(t)}const d=o.A.name("history");if(d){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Show/Hide changes"),t.id="track-changes-toggle";const i=new r.I({pathData:d.path,viewBox:d.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{if(e.preventDefault(),this.focusEditorView){const e=this.getAttribute("document-id")||this.getAttribute("doc-id");this.trackChangesPlugin.constructor.loadHistoryAndToggle(this.focusEditorView,e),setTimeout((()=>{if(!this.focusEditorView||this.focusEditorView.isDestroyed)return;Bt.isShowingChanges(this.focusEditorView.state)?(t.classList.remove("bg-gray-100","hover:bg-gray-200"),t.classList.add("bg-blue-200","hover:bg-blue-300"),i.element.classList.remove("text-gray-700"),i.element.classList.add("text-blue-700")):(t.classList.remove("bg-blue-200","hover:bg-blue-300"),t.classList.add("bg-gray-100","hover:bg-gray-200"),i.element.classList.remove("text-blue-700"),i.element.classList.add("text-gray-700")),this.focusEditorView.focus()}),100)}})),e.appendChild(t)}const h=document.createElement("div");h.className="w-px h-7 bg-gray-300",e.appendChild(h);const m=o.A.name("bold");if(m){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Bold");const i=new r.I({pathData:m.path,viewBox:m.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{e.preventDefault(),this.focusEditorView&&((0,Et.wh)(Ot.marks.strong)(this.focusEditorView.state,this.focusEditorView.dispatch),this.focusEditorView.focus())})),e.appendChild(t)}const u=o.A.name("italic");if(u){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Italic");const i=new r.I({pathData:u.path,viewBox:u.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{e.preventDefault(),this.focusEditorView&&((0,Et.wh)(Ot.marks.em)(this.focusEditorView.state,this.focusEditorView.dispatch),this.focusEditorView.focus())})),e.appendChild(t)}const p=document.createElement("div");p.className="relative";const g=document.createElement("button");g.type="button",g.className=i,g.setAttribute("aria-label","Alignment");const f=document.createElement("span");f.className="flex items-center";const v=o.A.name("chevronDown");if(v){const e=new r.I({pathData:v.path,viewBox:v.viewBox,sizeClasses:"w-3 h-3",colorClass:n}),t=document.createElement("span");t.className="flex items-center",t.appendChild(e.element),g.appendChild(f),g.appendChild(t)}else g.appendChild(f);const y=document.createElement("div");y.className="absolute z-40 mt-1 w-40 rounded-md shadow-lg bg-white text-gray-900 ring-1 ring-black ring-opacity-5 focus:outline-none py-1",y.style.display="none",y.style.top="100%",y.style.left="0";const w=(e,t,s)=>{const i=o.A.name(s),n=document.createElement("button");if(n.type="button",n.className="flex items-center gap-2 w-full text-left px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-100 cursor-pointer",i){const e=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4",colorClass:"text-gray-700"});n.appendChild(e.element)}const a=document.createElement("span");a.textContent=e,n.appendChild(a),n.addEventListener("mousedown",(e=>{e.preventDefault(),e.stopPropagation(),this._setTextAlign(t),y.style.display="none"})),y.appendChild(n)};w("Left","left","justifyLeft"),w("Center","center","justifyCenter"),w("Right","right","justifyRight"),w("Justify","justify","justifyAlign"),g.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),y.style.display="block"===y.style.display?"none":"block";document.addEventListener("click",(e=>{y.contains(e.target)||g.contains(e.target)||(y.style.display="none")}),{once:!0})})),p.appendChild(g),p.appendChild(y),e.appendChild(p),this.alignmentIconSlot=f,this._setAlignmentButtonIcon("left");const b=document.createElement("div");b.className="w-px h-7 bg-gray-300",e.appendChild(b);const C=o.A.name("list");if(C){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Bullet List");const i=new r.I({pathData:C.path,viewBox:C.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{if(e.preventDefault(),e.stopPropagation(),!this.focusEditorView)return;const{state:t,dispatch:s}=this.focusEditorView,i=(0,Ct.T2)(Ot.nodes.list_item);if(i(t))i(t,s);else{const e=(0,Ct.Sd)(Ot.nodes.bullet_list);e(t)&&e(t,s)}this.focusEditorView.focus()})),e.appendChild(t)}const x=o.A.name("numberedList");if(x){const t=document.createElement("button");t.type="button",t.className=s,t.setAttribute("aria-label","Numbered List");const i=new r.I({pathData:x.path,viewBox:x.viewBox,sizeClasses:a,colorClass:n});t.appendChild(i.element),t.addEventListener("mousedown",(e=>{if(e.preventDefault(),e.stopPropagation(),!this.focusEditorView)return;const{state:t,dispatch:s}=this.focusEditorView,i=(0,Ct.T2)(Ot.nodes.list_item);if(i(t))i(t,s);else{const e=(0,Ct.Sd)(Ot.nodes.ordered_list);e(t)&&e(t,s)}this.focusEditorView.focus()})),e.appendChild(t)}const k=document.createElement("div");k.className="w-px h-7 bg-gray-300",e.appendChild(k);const E=document.createElement("div");E.className="relative";const S=o.A.name("chevronDown");if(S){const t=document.createElement("button");t.type="button",t.className=i;const s=document.createElement("span");s.textContent="Normal text",s.className="format-button-text",this.formatButtonText=s,t.appendChild(s);const a=new r.I({pathData:S.path,viewBox:S.viewBox,sizeClasses:"w-3 h-3",colorClass:n});t.appendChild(a.element);const o=this._createTextFormatDropdownForFocus(s);t.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),o.style.display="block"===o.style.display?"none":"block"})),E.appendChild(t),E.appendChild(o),e.appendChild(E)}const T=document.createElement("span");return T.className="ml-auto text-xs text-gray-500 mr-2",T.textContent="Saved",e.appendChild(T),this._savingIndicatorEl=T,e}async handleDocumentUpdate(e){const t=this.getAttribute("document-id")||this.getAttribute("doc-id");if(e.document_id===t){void 0!==e.revision&&this.setAttribute("revision",String(e.revision));try{await this.applyServerChanges(e)}catch(e){await this.loadDocument()}this._isActionUpdating=!1,this.setEditable(!0),this.enableFocusToolbar()}}async _primeServerHistoryBookmark(){const e=this.getAttribute("document-id")||this.getAttribute("doc-id");if(e)try{const t=await fetch(`/api/document/${e}/history/`);if(!t.ok)return;const s=await t.json();this._serverAppliedStepCount=Array.isArray(s.steps)?s.steps.length:0}catch(e){}}async applyServerChanges(e={}){const t=this.focusEditorView||this.editorView,s=this.getAttribute("document-id")||this.getAttribute("doc-id");if(!t||!s)return void await this.loadDocument();let i;try{const e=await fetch(`/api/document/${s}/history/`);if(!e.ok)throw new Error("history fetch failed");i=await e.json()}catch(e){return void await this.loadDocument()}const n=Array.isArray(i.steps)?i.steps:[],a="number"==typeof this._serverAppliedStepCount?this._serverAppliedStepCount:n.length;if(n.length<=a)return await this.loadDocument(),void(this._serverAppliedStepCount=n.length);for(let e=a;e<n.length;e++){const s=n[e];try{const e=Tt.pn.fromJSON(Ot,s.step),i=t.state.tr.step(e).setMeta(Mt,{author:{id:s.authorId||"assistant",name:s.authorName||"Assistant"}});t.dispatch(i)}catch(e){return await this.loadDocument(),void(this._serverAppliedStepCount=n.length)}}this._serverAppliedStepCount=n.length;const o=Mt.getState(t.state);o&&Array.isArray(o.trackedSteps)&&(this._lastSavedStepCount=o.trackedSteps.length),void 0!==e.revision&&this.setAttribute("revision",String(e.revision))}async loadDocument(){const e=this.getAttribute("document-id")||this.getAttribute("doc-id");if(!e)return;const t=await this._fetchDoc(e),s=t&&t.content_prosemirror?t.content_prosemirror:null,i=t&&t.title?t.title:null;if(s&&"object"==typeof s)this.currentDoc=bt.bP.fromJSON(Ot,s),this.contentType="prosemirror";else{const e=document.createElement("div");e.innerHTML="<p></p>",this.currentDoc=bt.S4.fromSchema(Ot).parse(e),this.contentType="prosemirror"}null!==i&&this.setTitle(i),"number"==typeof t?.revision&&this.setAttribute("revision",String(t.revision));const n=this.focusEditorView||this.editorView;if(n&&!n.isDestroyed){const e=n.state.plugins,t=vt.$t.create({doc:this.currentDoc,plugins:e});n.updateState(t)}else this._initializeNormalEditor();this._minimize&&(this.editorContainer&&(this.editorContainer.style.display="none"),this.minimizedView?this.minimizedView.style.display="block":(this.minimizedView=this._createMinimizedView(),this.outerContainer.appendChild(this.minimizedView)),this.updateMinimizedViewTitle())}_createTextFormatDropdownForFocus(e){const t=document.createElement("div");t.className="absolute z-40 mt-1 w-36 rounded-md shadow-lg bg-white text-gray-900 ring-1 ring-black ring-opacity-5 focus:outline-none py-1",t.style.display="none",t.style.top="100%",t.style.left="0";const s=(t,s,i)=>(n,a)=>{const o=Object.assign({},s||{});if(t&&t.spec&&t.spec.attrs&&Object.prototype.hasOwnProperty.call(t.spec.attrs,"align")){const e=(()=>{const e=n.selection.$from;for(let t=e.depth;t>0;t--){const s=e.node(t);if(s.isTextblock)return s.attrs&&s.attrs.align?s.attrs.align:null}return null})();e&&(o.align=e)}const r=(0,Et.y_)(t,o);return!!r(n)&&(r(n,a),e&&(e.textContent=i),!0)};[{label:"Paragraph",action:s(Ot.nodes.paragraph,{},"Paragraph")},{label:"Heading 1",action:s(Ot.nodes.heading,{level:1},"Heading 1")},{label:"Heading 2",action:s(Ot.nodes.heading,{level:2},"Heading 2")},{label:"Heading 3",action:s(Ot.nodes.heading,{level:3},"Heading 3")},{label:"Code Block",action:(t,s)=>{const i=Ot.nodes.code_block,n=(0,Et.y_)(i);return!!n(t)&&(n(t,s),e&&(e.textContent="Code Block"),!0)}},{label:"Blockquote",action:(t,s)=>{const i=Ot.nodes.blockquote,n=(0,Et.Im)(i);return!!n(t)&&(n(t,s),e&&(e.textContent="Blockquote"),!0)}}].forEach((e=>{const s=document.createElement("button");s.type="button",s.className="block w-full text-left px-3 py-1.5 text-sm text-gray-900 hover:bg-gray-100 cursor-pointer",s.textContent=e.label,s.addEventListener("mousedown",(s=>{if(s.preventDefault(),s.stopPropagation(),!this.focusEditorView)return;const{state:i,dispatch:n}=this.focusEditorView;e.action(i,n),t.style.display="none",this.focusEditorView.focus()})),t.appendChild(s)}));const i=e=>{t.contains(e.target)||t.parentElement?.contains(e.target)||(t.style.display="none")},n=new MutationObserver((()=>{document.body.contains(t)||(document.removeEventListener("click",i),n.disconnect())}));return n.observe(document.body,{childList:!0,subtree:!0}),document.addEventListener("click",i,{once:!0}),t}setChangeAuthor(e,t){const s=this.focusEditorView||this.editorView;s&&!s.isDestroyed&&Bt.setAuthor(s,{id:e,name:t})}createVersion(e=null,t=null){const s=this.focusEditorView||this.editorView;if(!s||s.isDestroyed)return null;Bt.createVersion(s,e,t);const i=Bt.getVersions(s);return i[i.length-1]||null}listVersions(e={}){const t=this.focusEditorView||this.editorView;if(!t||t.isDestroyed)return[];const s=Bt.getVersions(t);return e.authorId?s.filter((t=>t.authorId===e.authorId)):s}revertToVersion(e,t={}){const s=this.focusEditorView||this.editorView;if(!s||s.isDestroyed)return!1;const i=t.authorId||"assistant",n=t.authorName||"Assistant";return Bt.revertToVersion(s,e,{id:i,name:n})}getChangesSinceVersion(e,t={}){const s=this.focusEditorView||this.editorView;return!s||s.isDestroyed?[]:Bt.getChangesSinceVersion(s,e,t)}setBaselineToVersion(e){const t=this.focusEditorView||this.editorView;t&&!t.isDestroyed&&Bt.setBaselineToVersion(t,e)}setBaselineToCurrent(){const e=this.focusEditorView||this.editorView;e&&!e.isDestroyed&&Bt.setBaselineToCurrent(e)}get menuItems(){return[{text:"Save Document",action:()=>this._handleSaveAction()},{text:"Download HTML",action:()=>this._handleDownloadHtmlAction()},{text:"Download Markdown",action:()=>this._handleDownloadMarkdownAction()}]}focusStatusBarItems(){const e=document.createElement("div"),t=this.theme.focusMenuTextColor||this.theme.text;e.classList.add("flex","justify-between","items-center","w-full","px-2",...t.split(" ").filter(Boolean));const s=document.createElement("span");return s.textContent=this.title||"Document",s.classList.add("font-semibold","truncate"),s.style.maxWidth="200px",e.appendChild(s),e}setContent(e,t="prosemirror",s=null){let i;if(this.initialContent=e,this.contentType=t,null!==s&&this.setTitle(s),"prosemirror"===t&&e&&"object"==typeof e)i=bt.bP.fromJSON(Ot,e);else if("markdown"===t)i=this._markdownToProseMirrorDoc(String(e||""));else if("html"===t)i=this._htmlToProseMirrorDoc(String(e||"<p></p>"));else{const e=document.createElement("div");e.innerHTML="<p></p>",i=bt.S4.fromSchema(Ot).parse(e)}this.currentDoc=i;const n=this.focusEditorView||this.editorView;if(n&&!n.isDestroyed){const e=n.state.plugins,t=vt.$t.create({doc:i,plugins:e});n.updateState(t)}else this._initializeNormalEditor()}getContentHtml(){const e=this.focusEditorView||this.editorView;if(e&&!e.isDestroyed)return this._proseMirrorDocToHtml(e.state.doc);if(this.currentDoc)return this._proseMirrorDocToHtml(this.currentDoc);if("markdown"===this.contentType){const e=this._markdownToProseMirrorDoc(this.initialContent);return this._proseMirrorDocToHtml(e)}return"html"!==this.contentType&&this.contentType?"<p></p>":this.initialContent||"<p></p>"}getContentMarkdown(){const e=this.focusEditorView||this.editorView;if(e&&!e.isDestroyed)return this._proseMirrorDocToMarkdown(e.state.doc);if(this.currentDoc)return this._proseMirrorDocToMarkdown(this.currentDoc);if("markdown"===this.contentType)return this.initialContent||"";if("html"===this.contentType||!this.contentType){const e=this._htmlToProseMirrorDoc(this.initialContent||"<p></p>");return this._proseMirrorDocToMarkdown(e)}return""}_payloadToInlineText(e,t){if("markdown"===t){const t="string"==typeof e?e:e&&e.markdown||"",s=jt.parse(t||"");return s?s.textBetween(0,s.content.size," "):""}if("html"===t){const t="string"==typeof e?e:e&&e.html||"",s=this._htmlToProseMirrorDoc(t||"<p></p>");return s?s.textBetween(0,s.content.size," "):""}return"text"===t?"string"==typeof e?e:e&&e.text||"":""}_serializeSelectionToMarkdown(e,t,s){const i=e.doc.slice(t,s).content;let n=null;if(i&&i.childCount&&i.child(0).type.isBlock)n=Ot.topNodeType.create(null,i);else{const e=Ot.nodes.paragraph.create(null,i);n=Ot.topNodeType.create(null,e?[e]:null)}try{return Vt.serialize(n)||""}catch(i){return e.doc.textBetween(t,s," ")}}_markdownLengthToPos(e,t){const s=e.doc.slice(0,t).content;let i=null;if(s&&s.childCount&&s.child(0).type.isBlock)i=Ot.topNodeType.create(null,s);else{const e=Ot.nodes.paragraph.create(null,s);i=Ot.topNodeType.create(null,e?[e]:null)}try{return(Vt.serialize(i)||"").length}catch(s){return e.doc.textBetween(0,t,"\n").length}}_computeHeadingPathFromPM(e,t){const s={};return e.doc.descendants(((e,i)=>{if(i>=t)return!1;if(e.type&&"heading"===e.type.name){const t=e.attrs&&e.attrs.level?e.attrs.level:1,i=e.textContent||"";s[t]=i;for(let e=t+1;e<=6;e++)s[e]&&delete s[e]}return!0})),Object.keys(s).map((e=>parseInt(e,10))).sort(((e,t)=>e-t)).map((e=>s[e])).filter(Boolean)}_blockDeletionRange(e,t,s){const i=this._textblockBoundsAtPos(e,t),n=this._textblockBoundsAtPos(e,s);return i&&n?{from:i.from,to:n.to}:i?{from:i.from,to:i.to}:n?{from:t,to:n.to}:{from:t,to:s}}_textblockBoundsAtPos(e,t){const s=t=>{const s=e.doc.resolve((t=>Math.max(1,Math.min(t,e.doc.content.size-1)))(t));for(let e=s.depth;e>0;e--){const t=s.node(e);if(t&&t.isTextblock){return{from:s.before(e),to:s.after(e),depth:e,node:t,isBlank:this._isTextblockBlank(t)}}}return null};return s(t)||s(t+1)||s(t-1)}_isTextblockBlank(e){if(!e||!e.isTextblock)return!1;if(0===e.childCount)return!0;return 0===(e.textContent||"").replace(/\u200B/g,"").trim().length}_textblockDepth(e){for(let t=e.depth;t>0;t--){if(e.node(t).type.isTextblock)return t}return 0}_coercePayloadToNodes(e,t){const s=Ot,i=e=>{const t=[];for(let s=0;s<e.content.childCount;s++)t.push(e.content.child(s));return t};if("html"===t){const t="string"==typeof e?e:e&&e.html||"";if(!t)return[];const n=document.createElement("div");n.innerHTML=t;return i(bt.S4.fromSchema(s).parse(n))}if("markdown"===t){const t="string"==typeof e?e:e&&e.markdown||"";if(!t)return[];return i(jt.parse(t))}if("text"===t){const t="string"==typeof e?e:e&&e.text||"";return[s.nodes.paragraph.create(null,s.text(t||""))]}return[]}_getSelectionAlignment(e){const t=e.selection.$from;for(let e=t.depth;e>0;e--){const s=t.node(e);if(s.isTextblock)return s.attrs&&s.attrs.align?s.attrs.align:"left"}return"left"}_setAlignmentButtonIcon(e){if(!this.alignmentIconSlot)return;const t={left:"justifyLeft",center:"justifyCenter",right:"justifyRight",justify:"justifyAlign"},s=t[e]||t.left,i=o.A.name(s);if(this.alignmentIconSlot.innerHTML="",i){const e=new r.I({pathData:i.path,viewBox:i.viewBox,sizeClasses:"w-4 h-4",colorClass:"text-gray-700"});this.alignmentIconSlot.appendChild(e.element)}}_refreshAlignmentButton(e){const t=this._getSelectionAlignment(e);this._setAlignmentButtonIcon(t)}_setTextAlign(e){const t=this.focusEditorView||this.editorView;if(!t)return;const{state:s,dispatch:i}=t;let n=s.tr;const{from:a,to:o}=s.selection,r=Ot.nodes.paragraph,l=Ot.nodes.heading;s.doc.nodesBetween(a,o,((t,s)=>{if(t.type===r||t.type===l){const i=Object.assign({},t.attrs,{align:e});return n=n.setNodeMarkup(s,t.type,i,t.marks),!1}})),n.docChanged&&(i(n),this._refreshAlignmentButton(t.state),t.focus())}disableFocusToolbar(){const e=this.focusToolbarEl||this.focusEditorView&&this.focusEditorView.dom.closest(".richtextdocument-editor-container")?.querySelector(".flex.items-center.gap-2.p-2.bg-gray-100");if(!e)return;e.querySelectorAll('button, [role="button"], input, select, textarea').forEach((e=>{"disabled"in e&&(e.disabled=!0),e.setAttribute("aria-disabled","true")}))}enableFocusToolbar(){const e=this.focusToolbarEl||this.focusEditorView&&this.focusEditorView.dom.closest(".richtextdocument-editor-container")?.querySelector(".flex.items-center.gap-2.p-2.bg-gray-100");if(!e)return;e.classList.remove("opacity-60","pointer-events-none");e.querySelectorAll('button, [role="button"], input, select, textarea').forEach((e=>{"disabled"in e&&(e.disabled=!1),e.removeAttribute("aria-disabled")}))}beginActionUpdate(){this._isActionUpdating=!0,this.focusEditorView&&!this.focusEditorView.isDestroyed&&this.focusEditorView.setProps({editable:()=>!1}),this.disableFocusToolbar()}endActionUpdate(){this._isActionUpdating=!1,this.focusEditorView&&!this.focusEditorView.isDestroyed&&(this.focusEditorView.setProps({editable:()=>!0}),this.focusEditorView.focus()),this.enableFocusToolbar()}_delay(e){return new Promise((t=>setTimeout(t,e)))}async replaceSection(e,t,s={}){const i=this.focusEditorView||this.editorView;if(!i||i.isDestroyed)return;const n=s.contentType||"text",a=s.typeMode||"node",o="number"==typeof s.stepDelay?s.stepDelay:50,r=s.mode||"replace",l=!1!==s.manageReadOnly,c="number"==typeof s.anchorPos?s.anchorPos:null,d=this._coercePayloadToNodes(t,n);if(d&&0!==d.length){l&&this.beginActionUpdate();try{let s=i.state,l=null!=c?c:e&&"number"==typeof e.from?e.from:s.selection.from,h=null!=c?l:e&&"number"==typeof e.to?e.to:s.selection.to,m=l;const u=d.some((e=>e.type&&e.type.isBlock));if("insert"===r){const e=this._textblockBoundsAtPos(s,m);if(e&&e.isBlank&&u){const t=d[0];i.dispatch(s.tr.replaceRangeWith(e.from,e.to,t).scrollIntoView()),s=i.state,m=e.from+t.nodeSize;for(let e=1;e<d.length;e++){const t=s.tr.insert(m,d[e]).scrollIntoView();i.dispatch(t),s=i.state,m+=d[e].nodeSize,await this._delay(o)}return}if(e&&!e.isBlank&&1===d.length&&d[0].type===Ot.nodes.paragraph){const e=d[0];for(let t=0;t<e.childCount;t++){const n=e.child(t),a=s.tr.insert(m,n);i.dispatch(a),s=i.state,m+=n.nodeSize,await this._delay(o)}return}}if("replace"===r)if(u){const e=this._blockDeletionRange(s,l,h);if(e&&e.to>e.from){const t=d[0];i.dispatch(s.tr.replaceRangeWith(e.from,e.to,t).scrollIntoView()),s=i.state,m=e.from+t.nodeSize;for(let e=1;e<d.length;e++){const t=s.tr.insert(m,d[e]).scrollIntoView();i.dispatch(t),s=i.state,m+=d[e].nodeSize,await this._delay(o)}return}}else if(h>l){const e=this._payloadToInlineText(t,n);return void(e&&e.length?i.dispatch(s.tr.replaceRangeWith(l,h,s.schema.text(e)).scrollIntoView()):i.dispatch(s.tr.deleteRange(l,h).scrollIntoView()))}if("char"===a&&"text"===n&&1===d.length){const e=d[0].isTextblock?d[0].textContent:d[0].text||d[0].textContent||"",t=Array.from(e||"");for(let e=0;e<t.length;e++){const s=i.state.tr.insertText(t[e],m);i.dispatch(s),m+=t[e].length,await this._delay(o)}return}for(let e=0;e<d.length;e++){const t=s.tr.insert(m,d[e]).scrollIntoView();i.dispatch(t),s=i.state,m+=d[e].nodeSize,await this._delay(o)}}finally{l&&this.endActionUpdate()}}}replaceSectionHTML(e,t,s={}){return this.replaceSection(e,{html:t},{...s,contentType:"html",typeMode:"node"})}replaceSectionMarkdown(e,t,s={}){return this.replaceSection(e,{markdown:t},{...s,contentType:"markdown",typeMode:"node"})}async rewriteDocument(e,t={}){const s=this.focusEditorView||this.editorView;if(!s||s.isDestroyed)return;const i=t.contentType||("string"==typeof e?"markdown":e&&e.html?"html":e&&e.markdown?"markdown":"text"),n="number"==typeof t.stepDelay?t.stepDelay:20,a=!1!==t.manageReadOnly,o=!1!==t.anchorTop,r=this._coercePayloadToNodes(e,i);if(!r||!r.length)return;a&&this.beginActionUpdate();let l=s.state;if(o){try{const e=l.tr.setSelection(vt.U3.create(l.doc,0,0));s.dispatch(e),l=s.state}catch(e){}const e=s.dom&&s.dom.closest&&s.dom.closest(".prosemirror-editor-wrapper");e&&(e.scrollTop=0)}const c=(e,t)=>{if(t<=0)return 0;if(t>=e.childCount)return e.content.size;let s=0;for(let i=0;i<t;i++)s+=e.child(i).nodeSize;return s},d=l.doc.childCount,h=Math.min(d,r.length);for(let e=0;e<h;e++){const t=c(l.doc,e),i=l.doc.child(e),a=r[e];if(!("function"==typeof i.eq&&i.eq(a))){const e=l.tr.replaceRangeWith(t,t+i.nodeSize,a);s.dispatch(e),l=s.state,n>0&&await this._delay(n)}}if(r.length>d)for(let e=d;e<r.length;e++){const t=c(l.doc,e),i=l.tr.insert(t,r[e]);s.dispatch(i),l=s.state,n>0&&await this._delay(n)}else if(d>r.length){const e=r.length;for(;l.doc.childCount>e;){const t=c(l.doc,e),i=l.doc.child(e),a=l.tr.deleteRange(t,t+i.nodeSize);s.dispatch(a),l=s.state,n>0&&await this._delay(n)}}a&&this.endActionUpdate()}rewriteDocumentHTML(e,t={}){return this.rewriteDocument({html:e},{...t,contentType:"html"})}rewriteDocumentMarkdown(e,t={}){return this.rewriteDocument({markdown:e},{...t,contentType:"markdown"})}rewriteDocumentText(e,t={}){return this.rewriteDocument({text:e},{...t,contentType:"text"})}setReadOnly(e){const t=!!e;if(this.isReadOnly!==t&&(this.isReadOnly=t,this.focusEditorView&&!this.focusEditorView.isDestroyed)){this.focusEditorView.setProps({editable:()=>!this.isReadOnly});const e=this.focusEditorView.dom.closest(".richtextdocument-editor-container");if(e){const t=e.querySelector(".flex.items-center.gap-2.p-2.bg-gray-100");t&&(t.style.display=this.isReadOnly?"none":"flex")}}}setEditable(e){const t=this.focusEditorView||this.editorView;if(t&&!t.isDestroyed){t.setProps({editable:()=>e});const s=t.dom.closest(".prosemirror-editor-wrapper");s&&s.classList.remove("editor-is-pending")}}setTitle(e){const t=e||"Document";this.title=t;const s=this.editorContainer?.querySelector(".richtextdocument-header-title");s&&(s.textContent=t),this.updateMinimizedViewTitle(),this.menuBar&&"function"==typeof this.menuBar.updateTitle&&this.menuBar.updateTitle(t),this.focusInstance&&"function"==typeof this.focusInstance.updateTitle&&this.focusInstance.updateTitle(t)}testAIResponseMarkdown(e,t,s,i){const n=["## 'Proposed Update'\n\nThis is a test paragraph with **bold**, _italic_, and a [link](https://simtheory.ai). It helps verify markdown to ProseMirror parsing and progressive node insertion.","### 'List Example'\n\n- First item\n- Second item with **emphasis**\n- Third item with _style_","#### 'Code Block'\n\nHere is some code:\n\n```js\nfunction greet(name){\n  return 'Hello ' + name;\n}\n```","'Quote Test'\n\n> A small quote block to ensure blockquotes render as expected.\n\nA follow-up paragraph after the quote.","## 'Mixed Blocks'\n\n1. Numbered list item\n2. Another item with a [reference](https://example.com)\n\nRegular paragraph after list with **strong** and _em_."],a=n[Math.floor(Math.random()*n.length)],o="edit"===s;this.beginActionUpdate();const r=this.replaceSectionMarkdown(e,a,{mode:o?"replace":"insert",stepDelay:120,manageReadOnly:!1,anchorPos:i});return Promise.resolve(r).finally((()=>this.endActionUpdate()))}disconnectedCallback(){N.instance.unregister(this),this.editorView&&!this.editorView.isDestroyed&&(this.editorView.destroy(),this.editorView=null),this.focusEditorView&&!this.focusEditorView.isDestroyed&&(this.focusEditorView.destroy(),this.focusEditorView=null)}async _fetchDoc(e){try{const t=await fetch(`/api/document/${e}/`);if(t.ok)return await t.json()}catch(e){}try{const t=await fetch(`/api/document/${e}/`);if(t.ok)return await t.json()}catch(e){}return{}}}customElements.get("output-document")||customElements.define("output-document",Wt);class Gt extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this.audioData=null,this.loadingContainers=[],this.rightAlign=!1,this.focusInstance=null,this.originalInstance=this,this._minimize=!1,this.waveformObserver=null,this.mode="inline",this.audioElement=null,this.playButton=null,this.audioContext=null,this.sourceNode=null,this.analyser=null,this.animationId=null,this.audioElementPlayListener=null,this.audioElementPauseListener=null,this.lastPlayTime=0,this.playbackRate=1,this.internalContainer=null,this.focusResizeHandler=null,this.focusTranscriptOverlay=null,this.focusSummaryOverlay=null,this.downloadAudioHandler=this.downloadAudioHandler.bind(this),this.handleFocus=this.handleFocus.bind(this),this.closeFocus=this.closeFocus.bind(this)}decodeHtmlEntities(e){if(!e)return e;const t=document.createElement("textarea");return t.innerHTML=e,t.value}disconnectedCallback(){this.clearAudioEventListeners(),this.waveformObserver&&this.waveformObserver.disconnect(),this.focusResizeHandler&&window.removeEventListener("resize",this.focusResizeHandler),this.inlineAudioContext&&"closed"!==this.inlineAudioContext.state&&this.inlineAudioContext.close().catch((e=>{})),this.focusAudioContext&&"closed"!==this.focusAudioContext.state&&this.focusAudioContext.close().catch((e=>{})),this.inlineAnimationId&&cancelAnimationFrame(this.inlineAnimationId),this.focusAnimationId&&cancelAnimationFrame(this.focusAnimationId),this.focusInstance&&this.focusInstance.close(),this.innerHTML=""}connectedCallback(){this.chatId=this.getAttribute("chat-id"),this.processAttributes(),this.style.display="flex"}static get observedAttributes(){return["audio-url","audio-name","transcript","transcript-summary","right-align","minimize","chat-id"]}attributeChangedCallback(e,t,s){if(t!==s||"minimize"===e)switch(e){case"audio-url":case"audio-name":case"transcript":case"transcript-summary":this.processAttributes();break;case"right-align":this.rightAlign=null!==s,this.internalContainer&&this.internalContainer.classList.toggle("justify-end",this.rightAlign);break;case"minimize":const e=null!==s&&"false"!==s;e!==this._minimize&&(this._minimize=e,this._minimize?this.minimizeInChat():this.maximizeInChat(0));break;case"chat-id":this.chatId=s;break;case"mode":s!==this.mode&&(this.mode=s,this.renderPlayer())}}processAttributes(){if(this.audioData={url:this.getAttribute("audio-url"),name:this.getAttribute("audio-name")||"Audio File",alt:this.getAttribute("audio-name")||"Audio File",config:{},transcript:this.getAttribute("transcript"),transcriptSummary:this.getAttribute("transcript-summary")},this.isConnected&&this.audioData.url)this.renderPlayer();else{this.isConnected}}createInternalContainer(){this.internalContainer||(this.internalContainer=document.createElement("div"),this.internalContainer.classList.add("flex","flex-col","gap-2"),this.appendChild(this.internalContainer)),this.internalContainer.innerHTML="",this.internalContainer.classList.toggle("justify-end",this.hasAttribute("right-align")),this.internalContainer.classList.toggle("py-4",!0)}renderPlayer(){if(this.innerHTML="",this.waveformObserver&&this.waveformObserver.disconnect(),this.mode=this.getAttribute("mode")||"inline",this.audioData)if("focus"===this.mode)this.className="w-full h-full flex",this.appendChild(this._renderFocusView(this.audioData));else{this.className="w-full",this.internalContainer=document.createElement("div"),this.internalContainer.className="w-full flex flex-col gap-2 py-4",this.internalContainer.classList.toggle("justify-end",this.hasAttribute("right-align"));const e=this._renderInlineView(this.audioData);this.internalContainer.appendChild(e),this.appendChild(this.internalContainer)}}_renderFocusView(e){this.stopAllPlayingAudio();const t=document.createElement("div");t.className="rounded-lg relative bg-black flex flex-col text-white";const s=this.createMenuOptionsForFocus(e),i=new D(s);t.appendChild(i.create());const a=document.createElement("div");a.className="flex-1 flex flex-col overflow-y-auto min-h-0 relative";const l=document.createElement("div");l.className="flex-1 w-full relative flex items-center justify-center px-4 min-h-0";const c=document.createElement("canvas");c.className="w-full h-full",l.appendChild(c),a.appendChild(l);const d=document.createElement("div");d.className=`absolute top-0 left-0 right-0 bottom-0 bg-black/80 ${this.theme.text} rounded-md overflow-y-auto p-2 hidden z-10`,l.appendChild(d);const h=document.createElement("div");h.className=`absolute top-0 left-0 right-0 bottom-0 bg-black/80 ${this.theme.text} rounded-md overflow-y-auto p-2 hidden z-10`,l.appendChild(h);const m=document.createElement("div");m.className="w-full bg-black border-t border-gray-800 p-4 flex flex-col items-center gap-3 min-h-[170px]";const u=document.createElement("div");u.className="w-full max-w-3xl flex flex-col gap-3";const p=document.createElement("div");p.className="flex justify-center items-center gap-4",this.focusPlayButton=document.createElement("button"),this.focusPlayButton.className="text-white hover:text-gray-300 focus:outline-none",this.focusPlayButton.appendChild(new r.I({pathData:o.A.name("play").path,viewBox:o.A.name("play").viewBox,sizeClasses:"w-8 h-8"}).element),this.focusPlayButton.addEventListener("click",(()=>{this.focusAudioElement?.paused?this.focusAudioElement.play():this.focusAudioElement&&this.focusAudioElement.pause()}));const g=document.createElement("button");g.className="text-gray-400 hover:text-white text-sm font-semibold w-12 flex items-center justify-center rounded-md",g.textContent="1.0x";const f=[1,1.2,1.5,2];g.addEventListener("click",(()=>{let e=f.indexOf(this.focusAudioElement.playbackRate);-1===e&&(e=0);const t=(e+1)%f.length,s=f[t];this.focusAudioElement.playbackRate=s,g.textContent=`${s.toFixed(1)}x`,this.originalInstance&&(this.originalInstance.playbackRate=s,this.originalInstance.audioElement&&(this.originalInstance.audioElement.playbackRate=s))}));const v=document.createElement("div");v.className="w-12";const y=document.createElement("div");y.className="w-full flex items-center gap-2 text-xs text-gray-400";const w=document.createElement("span");w.textContent="0:00";const b=document.createElement("div");b.className="flex-1 h-2 bg-gray-700 rounded-full relative cursor-pointer";const C=document.createElement("div");C.className="absolute left-0 top-0 h-full bg-white rounded-full",C.style.width="0%";const x=document.createElement("span");x.textContent="0:00",b.appendChild(C),y.appendChild(w),y.appendChild(b),y.appendChild(x);const k=document.createElement("div");k.className="flex justify-center items-center gap-3 mt-2";const E=new n.$({svgPathData:o.A.name("rectangleList").path,svgViewBox:o.A.name("rectangleList").viewBox,type:"secondaryTransparent",size:"smallMobile",hoverText:"Toggle Transcript"});E.onClick((()=>this.toggleOverlay(d,e.transcript,"No transcript available.",h))),E.render(k);const S=new n.$({svgPathData:o.A.name("commentLines").path,svgViewBox:o.A.name("commentLines").viewBox,type:"secondaryTransparent",size:"smallMobile",hoverText:"Toggle Summary"});if(S.onClick((()=>this.toggleOverlay(h,e.transcriptSummary,"No summary available.",d))),S.render(k),this.focusAudioElement=document.createElement("audio"),this.focusAudioElement.src=e.url,this.focusAudioElement.crossOrigin="anonymous",this.focusAudioElement.className="hidden",this.originalInstance){this.focusAudioElement.currentTime=this.originalInstance.lastPlayTime;const e=this.originalInstance.playbackRate||1;this.focusAudioElement.playbackRate=e,g.textContent=`${e.toFixed(1)}x`}return this.focusAudioElement.addEventListener("timeupdate",(()=>{this.focusAudioElement?.duration&&isFinite(this.focusAudioElement.duration)&&(C.style.width=this.focusAudioElement.currentTime/this.focusAudioElement.duration*100+"%",w.textContent=this.formatTimeForPlayer(this.focusAudioElement.currentTime))})),this.focusAudioElement.addEventListener("loadedmetadata",(()=>{x.textContent=isFinite(this.focusAudioElement.duration)?this.formatTimeForPlayer(this.focusAudioElement.duration):"--:--",c&&l&&(c.width=l.clientWidth,c.height=l.clientHeight,this.setupWaveformVisualization(this.focusAudioElement,c,"focus"))})),b.addEventListener("click",(e=>{const t=b.getBoundingClientRect(),s=(e.clientX-t.left)/t.width;this.focusAudioElement?.duration&&isFinite(this.focusAudioElement.duration)&&(this.focusAudioElement.currentTime=s*this.focusAudioElement.duration)})),p.appendChild(v),p.appendChild(this.focusPlayButton),p.appendChild(g),u.appendChild(p),u.appendChild(y),u.appendChild(k),m.appendChild(u),m.appendChild(this.focusAudioElement),a.appendChild(m),t.appendChild(a),this.addAudioEventListeners(),this.focusResizeHandler=()=>{c&&l.clientWidth>0&&(c.width=l.clientWidth,c.height=l.clientHeight,this.focusAudioElement?.readyState>=2&&this.setupWaveformVisualization(this.focusAudioElement,c,"focus"))},window.addEventListener("resize",this.focusResizeHandler),t}showLoadingIndicator(e=1){this.createInternalContainer();for(let t=0;t<e;t++){const e=document.createElement("div");e.className=`relative ${this.theme.secondaryBackground} rounded-md flex items-center justify-center opacity-50 w-full sm:w-[320px] md:w-[480px]`;const t=document.createElement("div");t.className="p-4 flex flex-col items-center justify-center gap-2";const s=new r.I(o.A.name("spinner"));s.element.className=`fa-2x ${this.theme.iconColor} icon-spin`;const i=document.createElement("div");i.className=`text-base ${this.theme.textColor}`,i.textContent="0:00.00";const n=document.createElement("div");n.className=`text-sm ${this.theme.textColor} text-center`,n.textContent="Audio generation in progress...",t.appendChild(s.element),t.appendChild(i),t.appendChild(n),e.appendChild(t),this.internalContainer.appendChild(e),this.loadingContainers.push(e);const a=Date.now(),l=()=>{const t=Date.now()-a,s=Math.floor(t/6e4),n=Math.floor(t%6e4/1e3),o=Math.floor(t%1e3/10);i.textContent=`${s}:${n.toString().padStart(2,"0")}.${o.toString().padStart(2,"0")}`,this.loadingContainers.includes(e)&&requestAnimationFrame(l)};requestAnimationFrame(l)}}_renderInlineView(e){const t=document.createElement("div");t.className="relative w-full";const s=e.url?.match(/\.([0-9a-z]+)(?:[\?#]|$)/i);t.dataset.filename=e.name,t.dataset.url=e.url,t.dataset.extension=s?s[1]:"audio";const i=document.createElement("div");i.className=`${this.theme.secondaryBackground} rounded-md px-4 py-2 w-full max-w-[800px]`;const a=document.createElement("div");a.className="flex items-center gap-2 mb-4 pt-2 text-sm";const l=document.createElement("div");l.className=`w-8 h-8 rounded-md flex flex-shrink-0 justify-center items-center ${this.theme.fileAudioColor} ${this.theme.fileTextColor}`,l.innerHTML=Y.getFileIcon({name:e.name,file_type:"audio"},s?.[1]||"audio");const c=document.createElement("span");c.className=`${this.theme.text} flex-1 overflow-hidden text-ellipsis whitespace-nowrap`,c.textContent=this.decodeHtmlEntities(e.name),a.appendChild(l),a.appendChild(c);const d=document.createElement("div");d.className="w-full h-[120px] relative mb-4 bg-black/30 rounded-md overflow-hidden";const h=document.createElement("canvas");h.className="w-full h-full",d.appendChild(h);const m=()=>d.clientWidth>0&&d.clientHeight>0&&(h.width=d.clientWidth,h.height=d.clientHeight,this.setupWaveformVisualization(this.audioElement,h,"inline"),!0);this.waveformObserver=new ResizeObserver(m),this.waveformObserver.observe(d);const p=document.createElement("div");p.className="flex items-center gap-3",this.inlinePlayButton=document.createElement("button"),this.inlinePlayButton.className=`${this.theme.primaryButton} rounded-full w-8 h-8 flex items-center justify-center focus:outline-none`;const g=o.A.name("play");this.inlinePlayButton.appendChild(new r.I({pathData:g.path,viewBox:g.viewBox,sizeClasses:"w-4 h-4"}).element);const f=document.createElement("span");f.className=`text-xs ${this.theme.fadedText} min-w-[70px]`,f.textContent="0:00 / 0:00";const v=document.createElement("div");v.className=`flex-1 h-2 ${this.theme.unselectedSelector} rounded-full relative cursor-pointer`;const y=document.createElement("div");y.className=`absolute left-0 top-0 h-full ${this.theme.progressBarBackground} rounded-full`,y.style.width="0%",v.appendChild(y);const w=document.createElement("button");w.className=`text-xs ${this.theme.fadedText} font-semibold w-10 h-6 flex items-center justify-center rounded-md hover:${this.theme.secondaryBackgroundHover} inline-playback-speed-button`,w.textContent=`${(this.playbackRate||1).toFixed(1)}x`;const b=[1,1.2,1.5,2];w.addEventListener("click",(e=>{e.stopPropagation();let t=b.indexOf(this.audioElement.playbackRate);-1===t&&(t=0);const s=(t+1)%b.length,i=b[s];this.audioElement.playbackRate=i,this.playbackRate=i,w.textContent=`${i.toFixed(1)}x`})),this.audioElement=document.createElement("audio"),this.audioElement.src=e.url,this.audioElement.crossOrigin="anonymous",this.audioElement.className="hidden",this.inlinePlayButton.addEventListener("click",(e=>{e.stopPropagation(),this.audioElement.paused?(this.stopAllPlayingAudio(),this.audioElement.play().catch((e=>{}))):this.audioElement.pause()})),v.addEventListener("click",(e=>{const t=v.getBoundingClientRect(),s=(e.clientX-t.left)/t.width;isFinite(this.audioElement.duration)&&(this.audioElement.currentTime=s*this.audioElement.duration)})),this.audioElement.addEventListener("timeupdate",(()=>{if(isFinite(this.audioElement.duration)&&this.audioElement.duration>0){const e=this.audioElement.currentTime/this.audioElement.duration*100;y.style.width=`${e}%`,f.textContent=`${this.formatTimeForPlayer(this.audioElement.currentTime)} / ${this.formatTimeForPlayer(this.audioElement.duration)}`}})),this.audioElement.addEventListener("loadedmetadata",(()=>{f.textContent=`0:00 / ${isFinite(this.audioElement.duration)?this.formatTimeForPlayer(this.audioElement.duration):"--:--"}`,m()}));const C=document.createElement("div");C.className="absolute top-2 right-2 z-30 hidden";const x=document.createElement("div");x.className="flex gap-0.5";const k=new n.$({svgPathData:o.A.name("cloudDownload").path,svgViewBox:o.A.name("cloudDownload").viewBox,type:"secondaryTransparent",size:"xSmallMobile"}),E=new n.$({svgPathData:o.A.name("focus").path,svgViewBox:o.A.name("focus").viewBox,type:"secondaryTransparent",size:"xSmallMobile"});return k.onClick((()=>this.downloadAudioHandler(e))),E.onClick((()=>this.handleFocus())),k.render(x),E.render(x),C.appendChild(x),t.appendChild(C),u.K.isOnTouchDevice?C.classList.remove("hidden"):(t.addEventListener("mouseover",(()=>C.classList.remove("hidden"))),t.addEventListener("mouseleave",(()=>C.classList.add("hidden")))),p.appendChild(this.inlinePlayButton),p.appendChild(v),p.appendChild(f),p.appendChild(w),i.appendChild(a),i.appendChild(d),i.appendChild(p),i.appendChild(this.audioElement),t.appendChild(i),t}setupWaveformVisualization(e,t,s="inline"){if(!e||!t||0===t.width||0===t.height){if(t&&(0===t.width||0===t.height)){const e=t.getContext("2d");if(e){e.clearRect(0,0,t.width,t.height);const s=e.createLinearGradient(0,0,t.width||100,0);s.addColorStop(0,"rgba(147, 51, 234, 0.9)"),s.addColorStop(.5,"rgba(168, 85, 247, 0.9)"),s.addColorStop(1,"rgba(147, 51, 234, 0.9)"),e.beginPath(),e.moveTo(0,(t.height||120)/2),e.lineTo(t.width||100,(t.height||120)/2),e.strokeStyle=s,e.lineWidth=2,e.stroke()}}return}let i,n,a,l,c,d;if("inline"===s){if(this.inlineAnimationId&&cancelAnimationFrame(this.inlineAnimationId),this.inlineAnimationId=null,this.audioElement&&this.inlineAudioElementPlayListener&&(this.audioElement.removeEventListener("play",this.inlineAudioElementPlayListener),this.inlineAudioElementPlayListener=null),this.audioElement&&this.inlineAudioElementPauseListener&&(this.audioElement.removeEventListener("pause",this.inlineAudioElementPauseListener),this.inlineAudioElementPauseListener=null),this.inlineAudioContext&&"closed"!==this.inlineAudioContext.state||(this.inlineAudioContext&&"closed"!==this.inlineAudioContext.state&&this.inlineAudioContext.close().catch((e=>{})),this.inlineAudioContext=new(window.AudioContext||window.webkitAudioContext),this.inlineSourceNode=null),i=this.inlineAudioContext,!this.inlineSourceNode)try{this.inlineSourceNode=i.createMediaElementSource(e)}catch(e){return void("closed"===i.state||this.inlineAudioContext!==i||this.inlineSourceNode||(i.close().catch((e=>{})),this.inlineAudioContext=null))}n=this.inlineSourceNode,this.inlineAnalyser&&this.inlineAnalyser.disconnect(),this.inlineAnalyser=i.createAnalyser(),a=this.inlineAnalyser}else{if(this.focusAnimationId&&cancelAnimationFrame(this.focusAnimationId),this.focusAnimationId=null,this.focusAudioElement&&this.focusAudioElementPlayListener&&(this.focusAudioElement.removeEventListener("play",this.focusAudioElementPlayListener),this.focusAudioElementPlayListener=null),this.focusAudioElement&&this.focusAudioElementPauseListener&&(this.focusAudioElement.removeEventListener("pause",this.focusAudioElementPauseListener),this.focusAudioElementPauseListener=null),this.focusAudioContext&&"closed"!==this.focusAudioContext.state||(this.focusAudioContext&&"closed"!==this.focusAudioContext.state&&this.focusAudioContext.close().catch((e=>{})),this.focusAudioContext=new(window.AudioContext||window.webkitAudioContext),this.focusSourceNode=null),i=this.focusAudioContext,!this.focusSourceNode)try{this.focusSourceNode=i.createMediaElementSource(e)}catch(e){return void("closed"===i.state||this.focusAudioContext!==i||this.focusSourceNode||(i.close().catch((e=>{})),this.focusAudioContext=null))}n=this.focusSourceNode,this.focusAnalyser&&this.focusAnalyser.disconnect(),this.focusAnalyser=i.createAnalyser(),a=this.focusAnalyser}n.disconnect(),n.connect(a),a.connect(i.destination),a.fftSize=256;const h=a.frequencyBinCount,m=new Uint8Array(h),u=t.getContext("2d"),p=()=>{const e=t.width,s=t.height;if(0===e||0===s)return;u.clearRect(0,0,e,s);const i=u.createLinearGradient(0,0,e,0);i.addColorStop(0,"rgba(147, 51, 234, 0.9)"),i.addColorStop(.5,"rgba(168, 85, 247, 0.9)"),i.addColorStop(1,"rgba(147, 51, 234, 0.9)"),u.beginPath(),u.moveTo(0,s/2),u.lineTo(e,s/2),u.strokeStyle=i,u.lineWidth=2,u.shadowBlur=8,u.shadowColor="rgba(147, 51, 234, 0.4)",u.stroke(),u.shadowBlur=0},g=()=>{if(e.paused)return p(),void("inline"===s?(this.inlineAnimationId&&cancelAnimationFrame(this.inlineAnimationId),this.inlineAnimationId=null):(this.focusAnimationId&&cancelAnimationFrame(this.focusAnimationId),this.focusAnimationId=null));d=requestAnimationFrame(g),"inline"===s?this.inlineAnimationId=d:this.focusAnimationId=d,a.getByteFrequencyData(m);const i=t.width,n=t.height;if(0===i||0===n)return;u.clearRect(0,0,i,n);const o="focus"===s?3:2,r="focus"===s?6:4,l=Math.floor(i/r),c=n/2,f=Math.min(n/3,("focus"===s?100:n)/3),v=u.createLinearGradient(0,0,i,0);v.addColorStop(0,"rgba(147, 51, 234, 0.9)"),v.addColorStop(.5,"rgba(168, 85, 247, 0.9)"),v.addColorStop(1,"rgba(147, 51, 234, 0.9)");const y=Math.floor(h/l);for(let e=0;e<l;e++){const t=e*r,s=Math.min(e*y,h-1),n=m[s]/255*f*.65,a=Date.now()/1e3,l=1.2,d=c+Math.sin(l*(t/i)*Math.PI*2+2*a)*n*(1+m[s]/400)+Math.sin(1.5*l*(t/i)*Math.PI*2-1.5*a)*n*.6*(1+m[s]/400)+Math.sin(.5*l*(t/i)*Math.PI*2+.8*a)*n*.3;u.beginPath(),u.arc(t,d,o,0,2*Math.PI),u.fillStyle=v,u.fill();for(let e=1;e<=2;e++){const r=c+Math.sin(l*(t/i)*Math.PI*2+1.8*a-.2*e)*n*(1+m[s]/600);u.beginPath(),u.arc(t,r,o*(1-.15*e),0,2*Math.PI),u.fillStyle=`rgba(147, 51, 234, ${.25/e})`,u.fill()}}u.shadowBlur="focus"===s?12:8,u.shadowColor="rgba(147, 51, 234, 0.4)"};l=()=>{"suspended"===i.state&&i.resume().catch((e=>{})),g();const e="inline"===s?this.inlinePlayButton:this.focusPlayButton;if(e){e.innerHTML="";const t="focus"===s?{sizeClasses:"w-8 h-8"}:{sizeClasses:"w-4 h-4"},i=o.A.name("pause"),n=new r.I({pathData:i.path,viewBox:i.viewBox,...t});n.element&&e.appendChild(n.element)}},c=()=>{"inline"===s?(this.inlineAnimationId&&cancelAnimationFrame(this.inlineAnimationId),this.inlineAnimationId=null):(this.focusAnimationId&&cancelAnimationFrame(this.focusAnimationId),this.focusAnimationId=null),p();const e="inline"===s?this.inlinePlayButton:this.focusPlayButton;if(e){e.innerHTML="";const t="focus"===s?{sizeClasses:"w-8 h-8"}:{sizeClasses:"w-4 h-4"},i=o.A.name("play"),n=new r.I({pathData:i.path,viewBox:i.viewBox,...t});n.element&&e.appendChild(n.element)}},e.addEventListener("play",l),e.addEventListener("pause",c),"inline"===s?(this.inlineAudioElementPlayListener=l,this.inlineAudioElementPauseListener=c):(this.focusAudioElementPlayListener=l,this.focusAudioElementPauseListener=c),p(),e.paused||l()}handleTouchStart(e){this.touchStartX=e.touches[0].clientX}handleTouchEnd(e){this.touchEndX=e.changedTouches[0].clientX,this.handleSwipe()}handleSwipe(){this.touchStartX-this.touchEndX>50?this.navigateAudios("next"):this.touchEndX-this.touchStartX>50&&this.navigateAudios("previous")}minimizeInChat(){this._minimize=!0,this.internalContainer&&this.internalContainer.classList.add("hidden"),this.minimizedView||(this.minimizedView=this.createMinimizedViewDOM()),this.contains(this.minimizedView)||this.appendChild(this.minimizedView)}maximizeInChat(e=0){this._minimize=!1,this.audioElement&&(this.audioElement.currentTime=e),this.internalContainer&&this.internalContainer.classList.remove("hidden"),this.minimizedView&&(this.minimizedView.remove(),this.minimizedView=null)}createMinimizedViewDOM(){const e=this.audioData;if(!e)return document.createElement("div");const t={name:e.name||"Audio file",type:"audio",file_type:"audio",extension:this.getAudioExtension(e.name)},s=document.createElement("div");s.classList.add("pb-4","version-master","cursor-pointer","z-30");const i=new Y([t],null,!1,!1,!0).createFileItem(t,t.extension);return s.appendChild(i),i.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation(),this.handleFocus()})),i.style.pointerEvents="auto",s}getAudioExtension(e){if(!e)return"mp3";const t=e.split(".").pop().toLowerCase();return["mp3","wav","ogg","flac","m4a","amr","aiff","wma","aac","opus"].includes(t)?t:"mp3"}handleFocus(){this.saveState(),this.focusInstance=new G(this.chatId,this,this.audioData),this.focusInstance.closeCallback=()=>{this.maximizeInChat(this.lastPlayTime)},this.minimizeInChat()}closeFocus(){const e=this.originalInstance.lastPlayTime;this.focusInstance=null,this.maximizeInChat(e)}focus(e){const t=document.createElement("audio-player");return t.setAttribute("audio-url",e.url),t.setAttribute("audio-name",e.name),e.transcript&&t.setAttribute("transcript",e.transcript),e.transcriptSummary&&t.setAttribute("transcript-summary",e.transcriptSummary),t.setAttribute("mode","focus"),t.setAttribute("chat-id",this.chatId),t.originalInstance=this,t}toggleOverlay(e,t,s,...i){if(!e)return;const n=e.classList.contains("hidden");i.forEach((e=>e?.classList.add("hidden"))),n?(e.innerHTML=`<div class="p-4 text-sm whitespace-pre-wrap">${t||s}</div>`,e.classList.remove("hidden")):e.classList.add("hidden")}saveState(){this.audioElement&&(this.lastPlayTime=this.audioElement.currentTime,this.playbackRate=this.audioElement.playbackRate)}createFocusHandler(e){e&&(this.focusInstance&&this.focusInstance.close(),this.focusInstance=new G(this.chatId,this,e))}toggleTranscriptOverlay(e){if(!this.focusTranscriptOverlay||!this.audioData)return;const t=this.focusTranscriptOverlay.classList.contains("hidden");(void 0!==e?e:t)?(this.focusTranscriptOverlay.innerHTML=`<div class="p-4 text-sm whitespace-pre-wrap">${this.audioData.transcript||"No transcript available."}</div>`,this.focusTranscriptOverlay.classList.remove("hidden"),this.focusSummaryOverlay&&this.focusSummaryOverlay.classList.add("hidden")):this.focusTranscriptOverlay.classList.add("hidden")}toggleSummaryOverlay(e){if(!this.focusSummaryOverlay||!this.audioData)return;const t=this.focusSummaryOverlay.classList.contains("hidden");(void 0!==e?e:t)?(this.focusSummaryOverlay.innerHTML=`<div class="p-4 text-sm whitespace-pre-wrap">${this.audioData.transcriptSummary||"No summary available."}</div>`,this.focusSummaryOverlay.classList.remove("hidden"),this.focusTranscriptOverlay&&this.focusTranscriptOverlay.classList.add("hidden")):this.focusSummaryOverlay.classList.add("hidden")}formatTimeForPlayer(e){return`${Math.floor(e/60)}:${Math.floor(e%60).toString().padStart(2,"0")}`}createMenuOptionsForFocus(e){return{title:this.decodeHtmlEntities(e.name)||"Audio",disableTitleEdit:!0,mode:"focus",fileMenu:[{type:"item",label:"Download",onClick:()=>this.downloadAudioHandler(e)}],quickActions:[{type:"icon",iconProvider:r.I,icon:"cloudDownload",hoverText:"Download",onClick:()=>this.downloadAudioHandler(e)}],onEnterFocus:()=>{this.handleFocus()},onExitFocus:()=>{if(this.originalInstance){if(this.originalInstance.lastPlayTime=this.focusAudioElement?this.focusAudioElement.currentTime:0,this.focusAudioElement){const e=this.focusAudioElement.playbackRate;this.originalInstance.playbackRate=e,this.originalInstance.audioElement&&(this.originalInstance.audioElement.playbackRate=e);const t=this.originalInstance.querySelector(".inline-playback-speed-button");t&&(t.textContent=`${e.toFixed(1)}x`)}this.originalInstance.focusInstance&&this.originalInstance.focusInstance.close()}}}}clearAudioEventListeners(){this.focusAudioContentContainer&&(this.focusAudioContentContainer.removeEventListener("touchstart",this.handleTouchStart),this.focusAudioContentContainer.removeEventListener("touchend",this.handleTouchEnd)),this.inlineAudioElementPlayListener&&this.audioElement&&this.audioElement.removeEventListener("play",this.inlineAudioElementPlayListener),this.inlineAudioElementPauseListener&&this.audioElement&&this.audioElement.removeEventListener("pause",this.inlineAudioElementPauseListener),this.focusAudioElementPlayListener&&this.focusAudioElement&&this.focusAudioElement.removeEventListener("play",this.focusAudioElementPlayListener),this.focusAudioElementPauseListener&&this.focusAudioElement&&this.focusAudioElement.removeEventListener("pause",this.focusAudioElementPauseListener)}addAudioEventListeners(e){this.focusAudioContentContainer&&(this.focusAudioContentContainer.addEventListener("touchstart",this.handleTouchStart,{passive:!0}),this.focusAudioContentContainer.addEventListener("touchend",this.handleTouchEnd))}stopAllPlayingAudio(){document.querySelectorAll("audio-player audio, audio").forEach((e=>{e.paused||(e.pause(),e.currentTime=0)}))}async downloadAudioHandler(e){try{const t=await fetch(e.url),s=await t.blob();let i=e.name||"audio.mp3";if(i.match(/\.(mp3|wav|ogg|m4a)$/i)||(i+=".mp3"),u.K.isOnIOS){const e=new FileReader;e.onload=function(){const t=document.createElement("a");t.href=e.result,t.download=i,document.body.appendChild(t),t.click(),document.body.removeChild(t)},e.readAsDataURL(s)}else{const e=URL.createObjectURL(s),t=document.createElement("a");t.href=e,t.download=i,document.body.appendChild(t),t.click(),document.body.removeChild(t),URL.revokeObjectURL(e)}new c.y("Download started.","success")}catch(e){new c.y("Download failed. Please try again.","error")}}}customElements.define("audio-player",Gt);class Kt extends HTMLElement{constructor(){super(),this.imageDisplayContainer=null,this._imagesData=[],this.loadingContainers=[],this.theme=i.A.theme,this._rightAlign=!1,this._fullWidth=!1,this.isDragging=!1,this.startX=0,this.startY=0,this.scale=1,this.translateX=0,this.translateY=0,this.zoomAnimationFrame=null,this.isZooming=!1,this.focusModal=null,this.currentFocusedImageObject=null,this.currentIndexInFocus=0,this.displayedImageElements=[],this._bindMethods()}_bindMethods(){this.handleKeyDown=this.handleKeyDown.bind(this),this.startDrag=this.startDrag.bind(this),this.drag=this.drag.bind(this),this.endDrag=this.endDrag.bind(this),this.handleWheel=this.handleWheel.bind(this),this.updateCursor=this.updateCursor.bind(this),this.closeFocus=this.closeFocus.bind(this),this._handleFocusTouchStart=this._handleFocusTouchStart.bind(this),this._handleFocusTouchEnd=this._handleFocusTouchEnd.bind(this),this._handleFocusDoubleTap=this._handleFocusDoubleTap.bind(this),this._handleFocusPinchStart=this._handleFocusPinchStart.bind(this),this._handleFocusPinchMove=this._handleFocusPinchMove.bind(this),this._handleDesktopDoubleClick=this._handleDesktopDoubleClick.bind(this),this._preventDefaultImageDrag=e=>e.preventDefault()}static get observedAttributes(){return["images","right-align","full-width","focus-id","loading-count","chat-id"]}attributeChangedCallback(e,t,s){if(t!==s||"images"===e||"loading-count"===e)switch(e){case"images":this.imagesData=s;break;case"right-align":this._rightAlign=this.hasAttribute("right-align"),this._updateContainerClasses();break;case"full-width":this._fullWidth=this.hasAttribute("full-width"),this.isConnected&&this._imagesData.length>0&&this._renderAllImages();break;case"focus-id":this._focusId=s||`focus-${crypto.randomUUID()}`;break;case"loading-count":const e=parseInt(s,10);if(!isNaN(e)&&e>0)this._showLoadersFromAttribute(e);else{const e=parseInt(t,10);this._imagesData&&0!==this._imagesData.length||isNaN(e)||!(e>0)||this._clearAllContent()}}}_clearAllContent(){this.imageDisplayContainer&&(this.imageDisplayContainer.innerHTML="",this.imageDisplayContainer.className="",this._updateContainerClasses()),this.loadingContainers=[],this.displayedImageElements=[]}_showLoadersFromAttribute(e){this._clearAllContent(),this.imageDisplayContainer||this._createImageDisplayContainer(),this._updateContainerClasses();for(let t=0;t<e;t++){const e=document.createElement("div");e.className=`relative ${this.theme.secondaryBackground} rounded-md flex flex-col items-center justify-center opacity-50 w-[135px] h-[135px] sm:w-[175px] sm:h-[175px] md:w-[320px] md:h-[320px] p-2`;const t=document.createElement("div"),s=o.A.name("spinner"),i=new r.I({pathData:s.path,viewBox:s.viewBox,sizeClasses:"w-8 h-8",additionalClasses:`animate-spin ${this.theme.iconColor}`});t.appendChild(i.element);const n=document.createElement("div");n.className=`text-xs ${this.theme.textColor} mt-2`,n.textContent="0:00.00",e.appendChild(t),e.appendChild(n),this.imageDisplayContainer.appendChild(e),this.loadingContainers.push(e);const a=Date.now(),l=()=>{if(!this.loadingContainers.includes(e))return;const t=Date.now()-a,s=Math.floor(t/6e4),i=Math.floor(t%6e4/1e3),o=Math.floor(t%1e3/10);n.textContent=`${s}:${i.toString().padStart(2,"0")}.${o.toString().padStart(2,"0")}`,this.loadingContainers.includes(e)&&this.isConnected&&requestAnimationFrame(l)};requestAnimationFrame(l)}}get imagesData(){return this._imagesData}set imagesData(e){let t=[];if("string"==typeof e)try{const s=JSON.parse(e);Array.isArray(s)?t=s:"object"==typeof s&&null!==s&&(t=[s])}catch(e){}else Array.isArray(e)?t=e:"object"==typeof e&&null!==e&&(t=[e]);this._imagesData=t,this.isConnected&&this._renderAllImages()}setChatId(e){this.chatId=e}connectedCallback(){if(this.style.display="block",this.classList.add("my-2"),this.hasAttribute("chat-id")&&(this.chatId=this.getAttribute("chat-id")),this.imageDisplayContainer||this._createImageDisplayContainer(),this._rightAlign=this.getAttribute("right-align")||!1,this._fullWidth=this.hasAttribute("full-width"),this.hasAttribute("focus-id")&&(this._focusId=this.getAttribute("focus-id")),this._updateContainerClasses(),this.hasAttribute("images"))this.imagesData=this.getAttribute("images");else if(this.hasAttribute("loading-count")){const e=parseInt(this.getAttribute("loading-count"),10);!isNaN(e)&&e>0&&this._showLoadersFromAttribute(e)}}disconnectedCallback(){this.focusModal&&this.closeFocus()}_createImageDisplayContainer(){this.imageDisplayContainer=document.createElement("div"),this.appendChild(this.imageDisplayContainer)}_updateContainerClasses(){if(!this.imageDisplayContainer)return;const e=["flex","flex-wrap","gap-2","py-2","flex-col","h-full","grid","grid-cols-1","sm:grid-cols-2","items-start","justify-start","justify-end","items-end","justify-items-start"],t=this.imageDisplayContainer.className.split(" ").filter((t=>!e.includes(t)));let s=[],i=!1;this._imagesData&&this._imagesData.length>1&&!this._fullWidth?s=["grid","grid-cols-1","sm:grid-cols-2","gap-2","items-start","justify-items-start"]:(s=["flex","flex-wrap","gap-2"],this._fullWidth&&(s.push("flex-col"),i=!0)),this._rightAlign?i?s.push("items-end"):s.includes("flex")&&s.push("justify-end"):i?s.push("items-start"):s.includes("flex")&&s.push("justify-start"),this.imageDisplayContainer.className=[...t,...s].join(" ")}showLoading(e){this._showLoadersFromAttribute(e)}showLoadingSearch(e){this._clearAllContent(),this.imageDisplayContainer||this._createImageDisplayContainer(),this._updateContainerClasses(),this.imageDisplayContainer.classList.add("flex-col","h-full");for(let t=0;t<e;t++){const e=document.createElement("div");e.className=`relative ${this.theme.secondaryBackground} rounded-md flex items-center justify-center opacity-50 w-full h-full flex-grow`;const t=o.A.name("spinner"),s=new r.I({pathData:t.path,viewBox:t.viewBox,sizeClasses:"w-8 h-8",colorClass:this.theme.iconColor,additionalClasses:"animate-spin"});e.appendChild(s.element),this.imageDisplayContainer.appendChild(e),this.loadingContainers.push(e)}}_renderAllImages(){if(this._clearAllContent(),this.imageDisplayContainer||this._createImageDisplayContainer(),this._updateContainerClasses(),!this._imagesData||0===this._imagesData.length)return;const e=1===this._imagesData.length;this._imagesData.forEach((t=>{this._renderSingleImageThumbnail(t,e)}))}_renderSingleImageThumbnail(e,t=!1){const s=document.createElement("div");s.className="relative cursor-pointer group inline-block w-fit justify-self-start";const i=document.createElement("img");i.src=e.url,i.alt=e.alt||e.filename||"Image",i.className="rounded-md internal-image",this._fullWidth?i.classList.add("max-w-full","h-auto","max-h-[80vh]","block"):t?i.classList.add("max-w-full","h-auto","max-h-96","block"):i.classList.add("max-w-full","h-auto","max-h-[200px]","sm:max-h-[250px]","md:max-h-[300px]","block"),s.appendChild(i),this.displayedImageElements.push(i);const a=document.createElement("div");a.className="absolute top-2 right-2 z-30 hidden";const r=document.createElement("div");r.className="flex gap-0.5",a.appendChild(r),s.appendChild(a);const l=new n.$({text:"",type:"focus",size:"icon",svgPathData:o.A.name("circleDown").path,svgViewBox:o.A.name("circleDown").viewBox,width:"full",iconHeightAndWidth:"w-6 h-6"});l.render(r),u.K.isOnTouchDevice?a.classList.remove("hidden"):(s.addEventListener("mouseover",(()=>a.classList.remove("hidden"))),s.addEventListener("mouseleave",(()=>a.classList.add("hidden")))),i.setAttribute("draggable","true"),i.addEventListener("dragstart",(t=>{document.body.classList.add("dragging-internal-image");try{const s=JSON.stringify(e);t.dataTransfer.setData("application/json",s),t.dataTransfer.effectAllowed="copy";const i=t.target.cloneNode(!0);i.style.position="absolute",i.style.top="-9999px",i.style.left="-9999px",i.style.maxHeight="150px",i.style.maxWidth="250px",i.style.width="auto",i.style.height="auto",i.style.boxShadow="0 8px 24px rgba(0, 0, 0, 0.3)",i.style.borderRadius="8px",document.body.appendChild(i);const n=i.offsetWidth/2,a=i.offsetHeight/2;t.dataTransfer.setDragImage(i,n,a),setTimeout((()=>{document.body.removeChild(i)}),0)}catch(e){}})),i.addEventListener("dragend",(()=>{document.body.classList.remove("dragging-internal-image")})),l.onClick((()=>{this.downloadImage(e)})),s.addEventListener("click",(t=>{a.contains(t.target)||(t.stopPropagation(),this._createFocusView(e))})),this.imageDisplayContainer.appendChild(s)}_createFocusView(e){if(!e)return;this.currentFocusedImageObject=e;let t=null;if(this.chatId&&(t=this.chatId),!t){const e=this.closest("[data-chat-id]");e&&(t=e.getAttribute("data-chat-id"))}if(!t&&ke.activeChat&&(t=ke.activeChat.id),!t){const e=Object.keys(ke.chatInstances);if(e.length>0){for(const s of e){const e=ke.chatInstances[s];if(e&&e.primaryContent&&e.primaryContent.contains(this)){t=s;break}}t||(t=e[0])}}t&&ke.chatInstances[t]&&(this.focusModal=new G(t,this,e))}focus(e){this.currentFocusedImageObject=e,this._clearFocusEventListeners(),this.updateIndexTimeout&&clearTimeout(this.updateIndexTimeout),this.wrapper=document.createElement("div"),this.wrapper.className="rounded-tr-md relative z-40",this.menuOptions=this._createFocusMenuOptions(e),this.menu=new D(this.menuOptions),this.menuElement=this.menu.create(),this.menuElement.classList.add("absolute","top-0","left-0","right-0","z-40"),this.wrapper.appendChild(this.menuElement),this.imageContentContainer=document.createElement("div"),this.imageContentContainer.className="relative rounded-tr-lg overflow-hidden",this.imageContentContainer.style.height="calc(var(--vh, 1vh) * 100 - 45px)",this.imageContentContainer.style.overflow="hidden",this.outerContainer=document.createElement("div"),this.outerContainer.style.backgroundImage=`url(${e.url})`,this.outerContainer.className="absolute inset-0 bg-cover bg-center z-10 rounded-tr-lg",this.imageBlurInset=document.createElement("div"),this.imageBlurInset.className=`absolute inset-0 bg-opacity-40 ${this.theme.lightboxBackground} z-20 rounded-t-md`,this.imageBlurInset.style.webkitBackdropFilter="blur(20px)",this.imageBlurInset.style.backdropFilter="blur(20px)",this.outerContainer.appendChild(this.imageBlurInset),this.imageContainer=document.createElement("div"),this.imageContainer.className="absolute inset-0 pt-[40px] z-30 overflow-hidden",this.img=document.createElement("img"),this.img.draggable=!1,this.img.src=e.url,this.img.alt=e.alt||e.filename||"Focused Image",this.img.className="absolute rounded-md origin-top-left",this.img.style.transformOrigin="0 0",this.img.style.willChange="transform",this.imageContainer.appendChild(this.img),this.imageContentContainer.appendChild(this.outerContainer),this.imageContentContainer.appendChild(this.imageContainer),this.wrapper.appendChild(this.imageContentContainer),this.scale=1,this.translateX=0,this.translateY=0;const t=()=>{this._initializeImageFit(),this._updateFocusIndex(e),this._addFocusEventListeners()};return this.img.addEventListener("load",t,{once:!0}),this.img.complete&&this.img.naturalWidth&&t(),this._resizeObserver&&this._resizeObserver.disconnect(),this._resizeObserver=new ResizeObserver((()=>this._recomputeFitOnResize())),this._resizeObserver.observe(this.imageContainer),setTimeout((()=>{this.outerContainer&&(this.outerContainer.style.opacity="1")}),50),this.wrapper}_updateFocusIndex(e){const t=this.displayedImageElements.find((t=>t.src===e.url));if(t)this.currentIndexInFocus=this.displayedImageElements.indexOf(t);else{const t=this._imagesData.findIndex((t=>t.url===e.url));this.currentIndexInFocus=-1!==t?t:0}}_recomputeFitOnResize(){if(!this.img||!this.imageContainer)return;const e=this.scale,t=this.translateX,s=this.translateY;this._initializeImageFit(),e>1&&(this.scale=e,this.translateX=t,this.translateY=s,this._updateImageTransform())}_initializeImageFit(){if(!this.img||!this.imageContainer)return;const e=this.imageContainer.clientWidth||1,t=this.imageContainer.clientHeight||1,s=this.img.naturalWidth||e,i=this.img.naturalHeight||t,n=Math.min(e/s,t/i),a=s*n,o=i*n,r=(e-a)/2,l=(t-o)/2;this.baseWidth=a,this.baseHeight=o,this.baseLeft=r,this.baseTop=l,this.img.style.width=`${a}px`,this.img.style.height=`${o}px`,this.img.style.left=`${r}px`,this.img.style.top=`${l}px`,this.scale=1,this.translateX=0,this.translateY=0,this.img.classList.remove("zoomed"),this._updateImageTransform()}closeFocus(){this.focusModal&&this.focusModal.close(),this._clearFocusEventListeners(),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null),this.isDragging=!1,this.startX=0,this.startY=0,this.translateX=0,this.translateY=0,this.scale=1,this.img&&(this.img.classList.remove("zoomed"),this.img.style.transform="",this.img.style.cursor=""),this.wrapper=null,this.menuElement=null,this.imageContentContainer=null,this.outerContainer=null,this.imageBlurInset=null,this.imageContainer=null,this.img=null,this.focusModal=null,this.currentFocusedImageObject=null}_addFocusEventListeners(){this.imageContentContainer&&this.imageContainer&&this.img&&(this.imageContentContainer.addEventListener("touchstart",this._handleFocusTouchStart,{passive:!0}),this.imageContentContainer.addEventListener("touchend",this._handleFocusTouchEnd,{passive:!0}),document.addEventListener("keydown",this.handleKeyDown),this.imageContainer.addEventListener("touchstart",this._handleFocusPinchStart,{passive:!0}),this.imageContainer.addEventListener("touchmove",this._handleFocusPinchMove,{passive:!1}),this.imageContainer.addEventListener("touchend",this._handleFocusPinchEnd,{passive:!0}),this.imageContainer.addEventListener("touchend",this._handleFocusDoubleTap,{passive:!0}),this.imageContainer.addEventListener("wheel",this.handleWheel,{passive:!1}),this.imageContainer.addEventListener("dblclick",this._handleDesktopDoubleClick,{passive:!0}),this.img.addEventListener("mousedown",this.startDrag),this.img.addEventListener("touchstart",this.startDrag,{passive:!1}),this.img.addEventListener("mouseenter",this.updateCursor),this.img.addEventListener("mouseleave",this.updateCursor),this.img.addEventListener("touchmove",this._preventDefaultImageDrag,{passive:!1}),document.addEventListener("mousemove",this.drag),document.addEventListener("mouseup",this.endDrag),document.addEventListener("mouseleave",this.endDrag),document.addEventListener("touchmove",this.drag,{passive:!1}),document.addEventListener("touchend",this.endDrag,{passive:!0}),document.addEventListener("touchcancel",this.endDrag,{passive:!0}))}_clearFocusEventListeners(){this.imageContentContainer&&(this.imageContentContainer.removeEventListener("touchstart",this._handleFocusTouchStart),this.imageContentContainer.removeEventListener("touchend",this._handleFocusTouchEnd)),document.removeEventListener("keydown",this.handleKeyDown),this.imageContainer&&(this.imageContainer.removeEventListener("touchstart",this._handleFocusPinchStart),this.imageContainer.removeEventListener("touchmove",this._handleFocusPinchMove),this.imageContainer.removeEventListener("touchend",this._handleFocusPinchEnd),this.imageContainer.removeEventListener("touchend",this._handleFocusDoubleTap),this.imageContainer.removeEventListener("wheel",this.handleWheel),this.imageContainer.removeEventListener("dblclick",this._handleDesktopDoubleClick)),this.img&&(this.img.removeEventListener("mousedown",this.startDrag),this.img.removeEventListener("touchstart",this.startDrag),this.img.removeEventListener("mouseenter",this.updateCursor),this.img.removeEventListener("mouseleave",this.updateCursor),this.img.removeEventListener("touchmove",this._preventDefaultImageDrag)),document.removeEventListener("mousemove",this.drag),document.removeEventListener("mouseup",this.endDrag),document.removeEventListener("mouseleave",this.endDrag),document.removeEventListener("touchmove",this.drag),document.removeEventListener("touchend",this.endDrag),document.removeEventListener("touchcancel",this.endDrag)}_handleDesktopDoubleClick(e){this.toggleZoom(e)}_handleFocusTouchStart(e){this._touchStartX=e.touches[0].clientX,this._startedWithSingleTouch=1===e.touches.length,this._touchStartTime=performance.now()}_handleFocusTouchEnd(e){this._touchEndX=e.changedTouches[0].clientX;const t=performance.now();if(this._gestureLockUntil&&t<this._gestureLockUntil)return this.isZooming=!1,void(this._startedWithSingleTouch=!1);if(this._startedWithSingleTouch&&!this.isZooming&&!this._pinchActive){const e=50;this._touchStartX-this._touchEndX>e?this.navigateImages("next"):this._touchEndX-this._touchStartX>e&&this.navigateImages("previous")}this.isZooming=!1,this._startedWithSingleTouch=!1}_lastTap=0;_handleFocusDoubleTap(e){if(e.changedTouches&&1!==e.changedTouches.length)return;const t=performance.now();if(this._gestureLockUntil&&t<this._gestureLockUntil)return;const s=e.changedTouches?e.changedTouches[0]:null,i=s?s.clientX:0,n=s?s.clientY:0,a=t-(this._lastTapTime||0),o=Math.abs(i-(this._lastTapX||0)),r=Math.abs(n-(this._lastTapY||0));a<400&&o<20&&r<20&&this.toggleZoom(e),this._lastTapTime=t,this._lastTapX=i,this._lastTapY=n}_initialPinchDistance=0;_initialPinchScale=1;_handleFocusPinchStart(e){2===e.touches.length&&(this.isZooming=!0,this._pinchActive=!0,this._initialPinchDistance=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY),this._initialPinchScale=this.scale)}_handleFocusPinchMove(e){if(2===e.touches.length){e.preventDefault();const t=Math.hypot(e.touches[0].pageX-e.touches[1].pageX,e.touches[0].pageY-e.touches[1].pageY)/this._initialPinchDistance,s=Math.max(1,Math.min(5,this._initialPinchScale*t)),i=this.imageContainer.getBoundingClientRect(),n=(e.touches[0].clientX+e.touches[1].clientX)/2-i.left,a=(e.touches[0].clientY+e.touches[1].clientY)/2-i.top;this._applyDirectZoom(s,n,a)}}_handleFocusPinchEnd(){this.isZooming=!1,this._pinchActive=!1,this._gestureLockUntil=performance.now()+250}navigateImages(e){if(!ke.activeChat||!ke.activeChat.primaryContent)return;const t=Array.from(ke.activeChat.primaryContent.querySelectorAll(".internal-image")),s=[],i=new Set;if(t.forEach((e=>{i.has(e.src)||(i.add(e.src),s.push(e))})),s.length<=1)return;const n=this.currentFocusedImageObject?this.currentFocusedImageObject.url:"null",a=s.findIndex((e=>e.src===n));if(-1===a)return;const o="next"===e?(a+1)%s.length:(a-1+s.length)%s.length,r=s[o];if(!r)return;const l=r.closest("output-image");if(!l)return;const c=l._imagesData.find((e=>e.url===r.src));c&&(l!==this&&(l.focusModal=this.focusModal,l.currentFocusedImageObject=c),this.currentFocusedImageObject=c,this.focusModal&&"function"==typeof this.focusModal.updateFocusContent&&this.focusModal.updateFocusContent(l,c))}handleKeyDown(e){if(this.focusModal&&this.currentFocusedImageObject)switch(e.key){case"ArrowLeft":this.navigateImages("previous");break;case"ArrowRight":this.navigateImages("next");break;case"Escape":this.closeFocus()}}startDrag(e){if(this.img&&this.img.classList.contains("zoomed")){e.preventDefault(),this.isDragging=!0;const t=e.touches?e.touches[0]:e;this.startX=t.clientX-this.translateX,this.startY=t.clientY-this.translateY,this.updateCursor()}}drag(e){if(this.isDragging&&this.img&&this.img.classList.contains("zoomed")){e.preventDefault();const t=e.touches?e.touches[0]:e;this.translateX=t.clientX-this.startX,this.translateY=t.clientY-this.startY,this._updateImageTransform()}}endDrag(){this.isDragging&&(this.isDragging=!1,this.updateCursor())}_updateImageTransform(){if(!(this.img&&this.imageContainer&&this.baseWidth&&this.baseHeight))return;const e=this.imageContainer.clientWidth,t=this.imageContainer.clientHeight,s=this.baseWidth*this.scale,i=this.baseHeight*this.scale;if(this.scale<=1)this.translateX=0,this.translateY=0;else{const n=e-s-this.baseLeft,a=-this.baseLeft,o=t-i-this.baseTop,r=-this.baseTop;this.translateX=Math.max(n,Math.min(a,this.translateX)),this.translateY=Math.max(o,Math.min(r,this.translateY))}this.img.style.transform=`translate(${this.translateX}px, ${this.translateY}px) scale(${this.scale})`}toggleZoom(e){if(!this.img||!this.imageContainer)return;if(this.zoomAnimationFrame)return;const t=this.img.classList.contains("zoomed")?1:2.5;this._animateZoomToPoint(t,e)}_animateZoomToPoint(e,t){if(!this.imageContainer)return;const s=this.imageContainer.getBoundingClientRect();let i,n;if(t){const e=t.touches?t.touches[0]:t;i=e.clientX-s.left,n=e.clientY-s.top}else i=s.width/2,n=s.height/2;e=Math.max(1,Math.min(5,e));const a=this.scale,o=i-this.baseLeft,r=n-this.baseTop;let l=o-(o-this.translateX)*(e/a),c=r-(r-this.translateY)*(e/a);e<=1&&(l=0,c=0),this._animateZoom(e,l,c)}_applyDirectZoom(e,t,s){if(!this.img||!this.imageContainer)return;if((e=Math.max(1,Math.min(5,e)))===this.scale)return;const i=this.scale;this.scale=e;const n=t-this.baseLeft,a=s-this.baseTop;this.translateX=n-(n-this.translateX)*(e/i),this.translateY=a-(a-this.translateY)*(e/i),this.scale<=1?(this.scale=1,this.translateX=0,this.translateY=0,this.img.classList.remove("zoomed")):this.img.classList.add("zoomed"),this._updateImageTransform()}updateCursor(){this.img&&(this.img.style.cursor="")}_animateZoom(e,t,s){if(!this.img)return;this.zoomAnimationFrame&&cancelAnimationFrame(this.zoomAnimationFrame);const i=this.scale,n=this.translateX,a=this.translateY,o=performance.now(),r=l=>{const c=l-o,d=Math.min(c/250,1),h=.5*(1-Math.cos(Math.PI*d));this.scale=i+(e-i)*h,this.translateX=n+(t-n)*h,this.translateY=a+(s-a)*h,this._updateImageTransform(),d<1?this.zoomAnimationFrame=requestAnimationFrame(r):(this.zoomAnimationFrame=null,this.scale=e,this.translateX=t,this.translateY=s,this.scale>1?this.img.classList.add("zoomed"):this.img.classList.remove("zoomed"),this._updateImageTransform(),this.updateCursor())};this.zoomAnimationFrame=requestAnimationFrame(r)}handleWheel(e){if(!this.img||!this.imageContainer)return;e.preventDefault();const t=e.deltaY>0?-1:1,s=this.scale*(1+.1*t),i=this.imageContainer.getBoundingClientRect(),n=e.clientX-i.left,a=e.clientY-i.top;this._applyDirectZoom(s,n,a)}_createFocusMenuOptions(e){return{title:e.filename||e.alt||"Image",mode:"focus",fileMenu:[{type:"item",label:"Download",onClick:()=>this.downloadImage(e)}],quickActions:[{type:"icon",icon:"cloudDownload",hoverText:"Download",onClick:()=>this.downloadImage(e)}],onTitleChange:t=>{e.filename=t},onExitFocus:this.closeFocus}}async downloadImage(e){try{const t=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream;if(t||/Android|webOS|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return void(window.open(e.url,"_blank")||alert("Could not open image. Check popup blocker."))}const s=await fetch(e.url);if(!s.ok)throw new Error(`HTTP error! status: ${s.status}`);const i=await s.blob();let n=Math.floor(1e6*Math.random()),a=e.filename||`image-${n}`,o=i.type.split("/")[1]||"png";const r=a.split(".");if(1!==r.length&&r[r.length-1].toLowerCase()===o.toLowerCase()||(a=`${a}.${o}`),"showSaveFilePicker"in window)try{const e=await window.showSaveFilePicker({suggestedName:a,types:[{description:"Image file",accept:{[i.type]:[`.${o}`]}}]}),t=await e.createWritable();return await t.write(i),void await t.close()}catch(e){if("AbortError"===e.name)return}const l=URL.createObjectURL(i),c=document.createElement("a");c.href=l,c.download=a,document.body.appendChild(c),c.click(),document.body.removeChild(c),setTimeout((()=>URL.revokeObjectURL(l)),100)}catch(e){alert(`Download failed: ${e.message}. Please try again.`)}}get menuItems(){return[{text:"Download",action:e=>this.downloadImage(e)}]}}window.customElements&&!window.customElements.get("output-image")&&window.customElements.define("output-image",Kt);var Yt=s(60842),Xt=s.n(Yt),Jt=s(80278),Qt=s(34275),Zt=s(71944),es=s(79729),ts=s(87284);Xt().accessToken="pk.eyJ1IjoibWljaGFlbHNoYXJrZXkiLCJhIjoiY21jOGxrZnIzMXFyNjJsb2xpYm80eXhtMiJ9.-nwXIffme00xXlLnghe9Fg";class ss extends HTMLElement{constructor(){super(),this.mapContainer=null,this.map=null,this._mapData=null,this.theme=i.A.theme,this._heatmapSwitch=null,this._controlsContainer=null,this._topLeftControlsContainer=null,this._topRightControlsContainer=null,this._projectionButton=null,this._compassIcon=null,this._mapStyleButtons={},this._layerIds=[],this._sourceIds=[],this._markers=[],this._isMapLoaded=!1,this._resizeObserver=null,this._popup=new(Xt().Popup)({closeButton:!1,closeOnClick:!1,anchor:"bottom",offset:[0,-35]})}static get observedAttributes(){return["map-data"]}attributeChangedCallback(e,t,s){t!==s&&"map-data"===e&&(this.mapData=s)}_injectGlobalStyles(){const e="simtheory-mapbox-styles";if(document.getElementById(e))return;const t=document.createElement("style");t.id=e,t.textContent="\n            /* Hide the default popup tip since we are using a fully custom popup */\n            .mapboxgl-popup-tip {\n                display: none;\n            }\n            /* Remove default styling from the mapbox popup container so we can use our own. */\n            .mapboxgl-popup-content {\n                background: transparent;\n                padding: 0;\n                box-shadow: none;\n            }\n        ",document.head.appendChild(t)}connectedCallback(){this._injectGlobalStyles(),this.style.display="block",this.style.height="400px",this.style.width="100%",this.style.position="relative",this.classList.add(this.theme.secondaryBackground,"rounded-md","my-4");const e=this.theme.secondaryButton.split(" ").find((e=>e.startsWith("bg-")))||"bg-gray-800";this._controlsContainer=document.createElement("div"),this._controlsContainer.className=`absolute bottom-2.5 right-2.5 z-10 ${e} rounded-md shadow-lg pt-1.5 pb-1 px-2 text-xs`,this._controlsContainer.style.display="none",this.appendChild(this._controlsContainer),this._topLeftControlsContainer=document.createElement("div"),this._topLeftControlsContainer.className="absolute top-2.5 left-2.5 z-10",this.appendChild(this._topLeftControlsContainer),this._topRightControlsContainer=document.createElement("div"),this._topRightControlsContainer.className="absolute top-2.5 right-2.5 z-10 flex flex-col items-end space-y-2",this.appendChild(this._topRightControlsContainer),this.mapContainer=document.createElement("div"),this.mapContainer.style.height="100%",this.mapContainer.style.width="100%",this.mapContainer.classList.add("rounded-md"),this.appendChild(this.mapContainer),this._initializeMap(),this._resizeObserver=new ResizeObserver((()=>{this.map&&this.map.resize()})),this._resizeObserver.observe(this),this.hasAttribute("map-data")&&(this.mapData=this.getAttribute("map-data"))}disconnectedCallback(){this.map&&(this.map.remove(),this.map=null),this._resizeObserver&&(this._resizeObserver.disconnect(),this._resizeObserver=null)}get mapData(){return this._mapData}set mapData(e){try{this._mapData=JSON.parse(e)}catch(e){this._mapData=null}this.map&&this.map.isStyleLoaded()&&this._renderMapData()}_initializeMap(){if(this.map||!this.mapContainer)return;const e=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"mapbox://styles/mapbox/dark-v11":"mapbox://styles/mapbox/standard";this.map=new(Xt().Map)({container:this.mapContainer,style:e,center:[0,20],zoom:1,attributionControl:!1,show3dObjects:!0,showRoadsAndTransit:!0,dragRotate:!0,touchZoomRotate:!0}),this._createCustomControls();const t=()=>{this._isMapLoaded=!0,setTimeout((()=>{this.map.resize()}),0),this._add3DBuildingsLayer(),this._mapData&&this._renderMapData()};this.map.on("load",t),this.map.on("style.load",t),this.map.on("click",(e=>{if(e.originalEvent.target.closest(".mapboxgl-marker"))return;const t=["map-data-fills","map-data-lines","map-data-points"].filter((e=>this.map.getLayer(e)));if(0===t.length)return;const s=this.map.queryRenderedFeatures(e.point,{layers:t});if(s.length>0){const t=s[0],i=this._createPopupContent(t.properties);if(i){const s="Point"===t.geometry.type?t.geometry.coordinates.slice():e.lngLat,n=i.querySelector(".popup-close-button");n&&(n.onclick=()=>this._popup.remove()),this._popup.setLngLat(s).setDOMContent(i).addTo(this.map)}}}))}_createCustomControls(){const e=this._createStyleControls();this._topLeftControlsContainer.appendChild(e);const t=this._createZoomControls(),s=this._createCompassControl(),i=this._createProjectionControls();this._topRightControlsContainer.appendChild(t),this._topRightControlsContainer.appendChild(s),this._topRightControlsContainer.appendChild(i)}_createControlButton(e,t,s,i=""){const n=document.createElement("button");return n.type="button",n.title=t,n.className=`${this.theme.secondaryButton} ${this.theme.menuIconHoverColor} p-1.5 ${i}`,n.innerHTML=e,n.onclick=s,n}_createZoomControls(){const e=document.createElement("div");e.className="flex flex-col rounded-md shadow-lg overflow-hidden";const t=this._createControlButton('<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>',"Zoom In",(()=>this.map.zoomIn())),s=this._createControlButton('<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5 10a1 1 0 011-1h8a1 1 0 110 2H6a1 1 0 01-1-1z" clip-rule="evenodd" /></svg>',"Zoom Out",(()=>this.map.zoomOut()),`border-t ${this.theme.modalSeperationBorderColor}`);return e.appendChild(t),e.appendChild(s),e}_createCompassControl(){const e=this.theme.text.match(/\[(.*?)\]/),t=`<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 24 24">\n            <g class="compass-arrow" style="transform-origin: center;">\n                <path d="M12 2L4.5 20.29l.71.71L12 18l6.79 3 .71-.71L12 2z" fill="${e?e[1]:"currentColor"}"/>\n            </g>\n        </svg>`,s=this._createControlButton(t,"Reset Bearing (click) or Rotate (drag)",(()=>{}));s.classList.add("rounded-md","shadow-lg","w-8","h-8","flex","items-center","justify-center"),this._compassIcon=s.querySelector(".compass-arrow");let i=!1,n=!1,a=0,o=0,r={x:0,y:0};const l=e=>{if(!i)return;n=!0;const t=Math.atan2(e.clientY-r.y,e.clientX-r.x),s=a-180*(t-o)/Math.PI;this.map.setBearing(s)},c=()=>{i=!1,window.removeEventListener("mousemove",l),window.removeEventListener("mouseup",c)};return s.onmousedown=e=>{e.preventDefault(),i=!0,n=!1;const t=s.getBoundingClientRect();r={x:t.left+t.width/2,y:t.top+t.height/2},a=this.map.getBearing(),o=Math.atan2(e.clientY-r.y,e.clientX-r.x),window.addEventListener("mousemove",l),window.addEventListener("mouseup",c)},s.onclick=()=>{n||this.map.easeTo({bearing:0,pitch:0})},this._compassIcon&&this.map.on("rotate",(()=>{const e=this.map.getBearing();this._compassIcon.style.transform=`rotate(${-e}deg)`})),s}_createStyleControls(){const e=document.createElement("div");e.className=`flex rounded-md shadow-lg overflow-hidden border ${this.theme.modalSeperationBorderColor}`;const t=document.createElement("button");t.type="button",t.textContent="Map";const s=document.createElement("button");s.type="button",s.textContent="Satellite",this._mapStyleButtons={map:t,satellite:s};const i=e=>{e.includes("satellite")?(s.className=`${this.theme.primaryButton} px-3 py-1 text-xs`,t.className=`${this.theme.secondaryButton} ${this.theme.menuIconHoverColor} px-3 py-1 text-xs`):(t.className=`${this.theme.primaryButton} px-3 py-1 text-xs`,s.className=`${this.theme.secondaryButton} ${this.theme.menuIconHoverColor} px-3 py-1 text-xs`)},n=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"mapbox://styles/mapbox/dark-v11":"mapbox://styles/mapbox/standard";i(n);const a=e=>{const t=this.map.getStyle().sprite;if((t&&t.includes("satellite"))===e.includes("satellite"))return;const s=this.map.getCenter(),n=this.map.getZoom(),a=this.map.getBearing(),o=this.map.getPitch();this.map.once("style.load",(()=>{this.map.jumpTo({center:s,zoom:n,bearing:a,pitch:o}),i(e)})),this.map.setStyle(e)};return t.onclick=()=>a(n),s.onclick=()=>a("mapbox://styles/mapbox/satellite-streets-v12"),this.map.on("style.load",(()=>{const e=this.map.getStyle(),t=e.name?e.name.toLowerCase():"",s=e.sprite||"",n=t.includes("satellite")||s.includes("satellite")?"satellite":"standard";i(n)})),e.appendChild(t),e.appendChild(s),e}_createProjectionControls(){this._projectionButton=document.createElement("button"),this._projectionButton.type="button",this._projectionButton.className=`${this.theme.secondaryButton} ${this.theme.menuIconHoverColor} w-8 h-8 flex items-center justify-center text-xs rounded-md shadow-lg transition-opacity`,this._projectionButton.style.transition="opacity 0.2s ease-in-out";let e=!1;const t=e=>{e?(this._projectionButton.textContent="3D",this._projectionButton.title="Switch to 2D Map View"):(this._projectionButton.textContent="2D",this._projectionButton.title="Switch to 3D Globe View"),this._projectionButton.disabled=!1,this._projectionButton.style.opacity="1"};return this._projectionButton.onclick=()=>{if(!this.map||!this.map.setProjection)return;this._projectionButton.disabled=!0,this._projectionButton.style.opacity="0.5";const s=e?"mercator":"globe";this.map.setProjection(s),"globe"===s?(this.map.easeTo({pitch:60,duration:1200}),e=!0):(this.map.easeTo({pitch:0,duration:1200}),e=!1),t(e)},t(!1),this._projectionButton}_clearMapData(){this._markers.forEach((e=>e.remove())),this._popup.isOpen()&&this._popup.remove(),this._layerIds.forEach((e=>{this.map.getLayer(e)&&this.map.removeLayer(e)})),this._sourceIds.forEach((e=>{this.map.getSource(e)&&this.map.removeSource(e)})),this._layerIds=[],this._sourceIds=[],this._markers=[],this._controlsContainer.innerHTML="",this._controlsContainer.style.display="none",this._heatmapSwitch=null}_renderMapData(){if(!this._isMapLoaded||!this._mapData||!Array.isArray(this._mapData.layers))return;this._clearMapData();const e=[];let t=[],s=!1;const i=new(Xt().LngLatBounds);if(this._mapData.layers.forEach((i=>{switch(i.type){case"geojson":i.data.features.forEach((t=>e.push(t)));break;case"heatmap":s=!0,t=i.points.map((e=>Jt.zx([e[0],e[1]],{weight:e[2]||1})));break;case"features":i.items?.forEach((t=>{const s=this._convertToGeoJSON(t);s&&e.push(s)})),i.features?.forEach((t=>{const s=this._convertToGeoJSON(t);s&&e.push(s)}))}})),e.length>0){const t=Jt.Lr(e),s=Qt.B(t);try{const e=Zt.Q(s);i.extend(e)}catch(e){}this._addFeaturesSource(s)}s&&(this._addHeatmapSource(t),this._createHeatmapToggle()),i.isEmpty()||this.map.fitBounds(i,{padding:50,maxZoom:15,duration:0,animate:!1})}_findFirstSymbolLayerId(){const e=this.map.getStyle().layers;for(let t=0;t<e.length;t++)if("symbol"===e[t].type)return e[t].id}_addFeaturesSource(e){const t=[],s=this._findFirstSymbolLayerId();if(e.features.forEach((e=>{if("Point"===e.geometry.type&&e.properties.isIcon){const t=new(Xt().Marker)({color:this.theme.cursorHEX}).setLngLat(e.geometry.coordinates).addTo(this.map),s=t.getElement();s.style.cursor="pointer",s.addEventListener("click",(t=>{t.stopPropagation();const s=this._createPopupContent(e.properties);if(s){const t=s.querySelector(".popup-close-button");t&&(t.onclick=()=>this._popup.remove()),this._popup.setLngLat(e.geometry.coordinates).setDOMContent(s).addTo(this.map)}})),this._markers.push(t)}else t.push(e)})),0===t.length)return;const i="features-source";this.map.addSource(i,{type:"geojson",data:Jt.Lr(t)}),this._sourceIds.push(i);[{id:"map-data-fills",type:"fill",source:i,filter:["==","$type","Polygon"],paint:{"fill-color":["coalesce",["get","fillColor"],this.theme.cursorHEX],"fill-opacity":["coalesce",["get","fillOpacity"],.2]}},{id:"map-data-lines",type:"line",source:i,filter:["==","$type","LineString"],paint:{"line-color":["coalesce",["get","color"],this.theme.cursorHEX],"line-width":["coalesce",["get","weight"],5],"line-opacity":["coalesce",["get","opacity"],.5]}},{id:"map-data-points",type:"circle",source:i,filter:["==","$type","Point"],paint:{"circle-radius":8,"circle-color":this.theme.cursorHEX,"circle-stroke-width":2,"circle-stroke-color":"#ffffff"}}].forEach((e=>{this.map.addLayer(e,s),this._layerIds.push(e.id),this.map.on("mouseenter",e.id,(e=>{const t=e.features[0];this._createPopupContent(t.properties)&&(this.map.getCanvas().style.cursor="pointer")})),this.map.on("mouseleave",e.id,(()=>{this.map.getCanvas().style.cursor=""}))}))}_addHeatmapSource(e){const t="heatmap-source",s=this._findFirstSymbolLayerId();this.map.addSource(t,{type:"geojson",data:Jt.Lr(e)}),this._sourceIds.push(t);const i="map-data-heatmap";this.map.addLayer({id:i,type:"heatmap",source:t,paint:{"heatmap-intensity":["interpolate",["linear"],["zoom"],0,.1,4,.2,8,.4,12,.8],"heatmap-color":["interpolate",["linear"],["heatmap-density"],0,"rgba(33,102,172,0)",.2,"rgb(103,169,207)",.4,"rgb(209,229,240)",.6,"rgb(253,219,199)",.8,"rgb(239,138,98)",1,"rgb(178,24,43)"],"heatmap-radius":["interpolate",["linear"],["zoom"],0,1,6,10,12,25],"heatmap-opacity":["interpolate",["linear"],["zoom"],0,.1,4,.3,8,.5,12,.7]}},s),this._layerIds.push(i)}_add3DBuildingsLayer(){const e=this._findFirstSymbolLayerId();if(!e)return;if(this.map.getLayer("3d-buildings"))return;const t=this.theme.secondaryButton.match(/bg-\[(.*?)\]/)[1];this.map.addLayer({id:"3d-buildings",source:"composite","source-layer":"building",filter:["==","extrude","true"],type:"fill-extrusion",minzoom:15,paint:{"fill-extrusion-color":t,"fill-extrusion-height":["get","height"],"fill-extrusion-base":["get","min_height"],"fill-extrusion-opacity":.7}},e)}_createHeatmapToggle(){this._heatmapSwitch=new C({size:"small",label:"Heatmap",labelPosition:"left",value:!0}),this._heatmapSwitch.onSwitchTrue((()=>this.map.setLayoutProperty("map-data-heatmap","visibility","visible"))),this._heatmapSwitch.onSwitchFalse((()=>this.map.setLayoutProperty("map-data-heatmap","visibility","none"))),this._heatmapSwitch.render(this._controlsContainer),this._heatmapSwitch.label&&(this._heatmapSwitch.label.className=`text-xs ${this.theme.switchText} font-medium flex items-center`),this._controlsContainer.style.display="block"}_convertToGeoJSON(e){const t={title:e.title,subtitle:e.subtitle,link:e.link,isIcon:!!e.icon,...e.style};switch(e.type?.toLowerCase()){case"geometry":return Jt.zx(e.coordinates,t);case"point":return Jt.zx(e.coords,t);case"area":case"freehand":return Jt.n1([e.coords],t);case"route":return Jt.wi(e.coords,t);case"radius":return es.n(e.coords,e.radius,{units:"meters",properties:t});case"buffer":const s="point"===e.baseType?Jt.zx(e.coords):Jt.wi(e.coords);return ts.r(s,e.distance,{units:e.units||"meters",...t});case"corridor":const i=Jt.wi(e.coords);return ts.r(i,e.width/2,{units:"meters",...t});case"multipolygon":return Jt.g5(e.coords,t);case"bezier":const n=this._createBezierCurve(e.coords,e.resolution||100);return Jt.wi(n,t);case"arc":const a=e.center,o=e.radius,r=e.startAngle||0,l=e.endAngle||90;return this._createArc(a,o,r,l,t);case"sector":const c=e.center,d=e.radius,h=e.startAngle||0,m=e.endAngle||90;return this._createSector(c,d,h,m,t);case"ellipse":return this._createEllipse(e.center,e.xRadius,e.yRadius,e.rotation||0,t)}return null}_createPopupContent(e){if(!e||!e.title)return null;const t=document.createElement("div");t.className=`${this.theme.modalBackground} ${this.theme.text} rounded-md shadow-lg p-4 max-w-xs relative select-none border ${this.theme.modalSeperationBorderColor} `;const s=document.createElement("button");s.className=`popup-close-button absolute top-0.5 right-2 ${this.theme.fadedText} hover:${this.theme.text} select-none`,s.innerHTML="&times;",s.style.fontSize="1rem",t.appendChild(s);let i=`<strong class="text-sm">${e.title}</strong>`;e.subtitle&&(i+=`<br><span class="text-xs ${this.theme.fadedText}">${e.subtitle}</span>`),e.link&&(i+=`<br><a href="${e.link}" target="_blank" rel="noopener noreferrer" class="${this.theme.link} hover:underline mt-2 inline-block">View details</a>`);const n=document.createElement("div");return n.innerHTML=i,t.appendChild(n),t}_createBezierCurve(e,t=100){const s=[];for(let i=0;i<=1;i+=1/t){const t=this._bezierPoint(e,i);s.push(t)}return s}_bezierPoint(e,t){if(1===e.length)return e[0];const s=[];for(let i=0;i<e.length-1;i++){const n=(1-t)*e[i][0]+t*e[i+1][0],a=(1-t)*e[i][1]+t*e[i+1][1];s.push([n,a])}return this._bezierPoint(s,t)}_createArc(e,t,s,i,n){const a=[],o=(i-s)/64;for(let i=0;i<=64;i++){const n=(s+i*o)*Math.PI/180,r=e[0]+t*Math.cos(n)/111320,l=e[1]+t*Math.sin(n)/110540;a.push([r,l])}return Jt.wi(a,n)}_createSector(e,t,s,i,n){const a=[[e[0],e[1]]],o=(i-s)/64;for(let i=0;i<=64;i++){const n=(s+i*o)*Math.PI/180,r=e[0]+t*Math.cos(n)/111320,l=e[1]+t*Math.sin(n)/110540;a.push([r,l])}return a.push([e[0],e[1]]),Jt.n1([a],n)}_createEllipse(e,t,s,i,n){const a=[],o=i*Math.PI/180;for(let i=0;i<=64;i++){const n=360*i/64*Math.PI/180;let r=t*Math.cos(n)/111320,l=s*Math.sin(n)/110540;const c=r*Math.cos(o)-l*Math.sin(o),d=r*Math.sin(o)+l*Math.cos(o);a.push([e[0]+c,e[1]+d])}return Jt.n1([a],n)}}window.customElements&&!window.customElements.get("output-map")&&window.customElements.define("output-map",ss);class is extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._handleDownload=this._handleDownload.bind(this)}static get observedAttributes(){return["file-name","file-url","file-extension","file-type-desc","full-width"]}connectedCallback(){this.render()}attributeChangedCallback(e,t,s){t!==s&&this.render()}disconnectedCallback(){this.innerHTML=""}render(){this.innerHTML="";const e=this.getAttribute("file-name")||"Unnamed File",t=this.getAttribute("file-url"),s=this.getAttribute("file-extension")||"",i=this.getAttribute("file-type-desc")||this._getFileTypeDescription(s),a=this.hasAttribute("full-width"),r=document.createElement("div");r.className="relative p-0.5 select-none file-output-wrapper my-2";const l=document.createElement("div");l.className=`rounded-md ring-1 ${this.theme.fileItemRing} ${this.theme.fileItemBackground} p-2 flex items-center gap-2 file-item-detail transition-all`,t?(l.classList.add("cursor-pointer"),l.addEventListener("click",(e=>{e.target.closest("button")||window.open(t,"_blank","noopener noreferrer")}))):l.classList.add("cursor-default"),a?l.classList.add("w-full"):l.classList.add("w-[255px]","sm:w-[280px]");const c=this._createIconContainer(s),d=this._createFileInformation(e,i);if(l.appendChild(c),l.appendChild(d),t){const e=this._createButtonContainer(),t=new n.$({svgPathData:o.A.name("cloudDownload").path,svgViewBox:o.A.name("cloudDownload").viewBox,type:"secondaryTransparent",size:"xSmallMobile",hoverText:"Download File"});t.onClick(this._handleDownload),t.render(e),l.appendChild(e),u.K.isOnTouchDevice?e.classList.remove("hidden"):(l.addEventListener("mouseenter",(()=>e.classList.remove("hidden"))),l.addEventListener("mouseleave",(()=>e.classList.add("hidden"))))}r.appendChild(l),this.appendChild(r)}_createIconContainer(e){const t=this._getFileColor(e),s=document.createElement("div");return s.className=`w-10 h-10 rounded-md ${t} ${this.theme.fileIconColor} flex justify-center items-center flex-shrink-0`,s.innerHTML=this._getFileIcon(e),s}_createFileInformation(e,t){const s=document.createElement("div");s.className="flex flex-col text-left overflow-hidden flex-grow min-h-0 max-w-[calc(100%-5rem)]",s.style.cssText="gap: 0.125rem;";const i=document.createElement("div");i.className="text-left text-sm truncate w-full",i.style.cssText="line-height: 1.2;",i.textContent=e;const n=document.createElement("div");return n.className=`text-sm ${this.theme.fadedText}`,n.style.cssText="line-height: 1.2;",n.textContent=t,s.appendChild(i),s.appendChild(n),s}_createButtonContainer(){const e=document.createElement("div");return e.className="ml-auto hidden",e.addEventListener("click",(e=>{e.preventDefault(),e.stopPropagation()})),e}async _handleDownload(){const e=this.getAttribute("file-url"),t=this.getAttribute("file-name")||"download";if(e)try{new c.y("Starting download...","info");const s=await fetch(e);if(!s.ok)throw new Error(`Network response was not ok: ${s.statusText}`);const i=await s.blob(),n=document.createElement("a");n.href=URL.createObjectURL(i),n.download=t,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(n.href),new c.y("Download started successfully.","success")}catch(e){new c.y(`Download failed: ${e.message}`,"error")}else new c.y("No file URL provided.","error")}_getFileTypeDescription(e){return{pdf:"PDF Document",jpg:"Image",jpeg:"Image",png:"Image",svg:"Image",gif:"Image",webp:"Image",doc:"Word Document",docx:"Word Document",csv:"CSV File",xls:"Spreadsheet",xlsx:"Spreadsheet",ppt:"Presentation",pptx:"Presentation",txt:"Text File",rtf:"Rich Text File",mp3:"Audio File",wav:"Audio File",ogg:"Audio File",flac:"Audio File",m4a:"Audio File",aac:"Audio File",opus:"Audio File",mp4:"Video File",mov:"Video File",avi:"Video File",mkv:"Video File",webm:"Video File",zip:"ZIP Archive",rar:"RAR Archive","7z":"7-Zip Archive",tar:"TAR Archive",gz:"GZip Archive",html:"HTML Code",css:"CSS Code",js:"JavaScript Code",py:"Python Script",java:"Java Code",json:"JSON Data",xml:"XML Data"}[e?.toLowerCase()]||"File"}_getFileIcon(e){const t={pdf:"filePDF",doc:"fileWord",docx:"fileWord",csv:"fileSpreadsheet",xls:"fileSpreadsheet",xlsx:"fileSpreadsheet",ppt:"file",pptx:"file",txt:"fileLines",rtf:"fileLines",jpg:"fileImage",jpeg:"fileImage",png:"fileImage",gif:"fileImage",svg:"fileImage",webp:"fileImage",mp3:"fileAudio",wav:"fileAudio",ogg:"fileAudio",flac:"fileAudio",m4a:"fileAudio",aac:"fileAudio",opus:"fileAudio",mp4:"fileVideo",mov:"fileVideo",avi:"fileVideo",mkv:"fileVideo",webm:"fileVideo",html:"fileLines",css:"fileLines",js:"fileLines",py:"fileLines",java:"fileLines",json:"fileLines",xml:"fileLines",zip:"fileZIP",rar:"fileZIP","7z":"fileZIP",tar:"fileZIP",gz:"fileZIP"}[e?.toLowerCase()]||"file",s=o.A.name(t);return`<svg viewBox="${s.viewBox}" aria-hidden="true" focusable="false" class="w-5 h-5 fill-current pointer-events-none"><path d="${s.path}"></path></svg>`}_getFileColor(e){return{pdf:this.theme.filePDFColor,jpg:this.theme.fileImageColor,jpeg:this.theme.fileImageColor,png:this.theme.fileImageColor,gif:this.theme.fileImageColor,webp:this.theme.fileImageColor,doc:this.theme.fileDocColor,docx:this.theme.fileDocColor,xls:this.theme.fileSpreadsheetColor,xlsx:this.theme.fileSpreadsheetColor,ppt:this.theme.fileSpreadsheetColor,pptx:this.theme.fileSpreadsheetColor,mp3:this.theme.fileAudioColor,wav:this.theme.fileAudioColor,ogg:this.theme.fileAudioColor,flac:this.theme.fileAudioColor,m4a:this.theme.fileAudioColor,aac:this.theme.fileAudioColor,opus:this.theme.fileAudioColor,mp4:this.theme.fileVideoColor,mov:this.theme.fileVideoColor,avi:this.theme.fileVideoColor,mkv:this.theme.fileVideoColor,webm:this.theme.fileVideoColor,zip:this.theme.fileOtherColor,rar:this.theme.fileOtherColor,"7z":this.theme.fileOtherColor,tar:this.theme.fileOtherColor,gz:this.theme.fileOtherColor}[e?.toLowerCase()]||this.theme.fileOtherColor}}customElements.get("file-output")||customElements.define("file-output",is);class ns extends HTMLElement{constructor(){super(),this.theme=i.A.theme,this._handleTileClick=this._handleTileClick.bind(this),this._handleKeyDown=this._handleKeyDown.bind(this)}static get observedAttributes(){return["title","type","document-id","revision","version-id","timestamp"]}connectedCallback(){this.render()}attributeChangedCallback(){this.render()}disconnectedCallback(){this.innerHTML=""}render(){this.innerHTML="";const e=this.getAttribute("title")||"Version update",t=this.getAttribute("type")||"document",s=this.getAttribute("timestamp"),i=document.createElement("div");i.className="my-2";const n=document.createElement("div");n.className=`rounded-md ring-1 ${this.theme.fileItemRing} ${this.theme.fileItemBackground} p-3 flex items-center gap-3 transition-all cursor-pointer hover:ring-2`,n.setAttribute("role","button"),n.setAttribute("tabindex","0"),n.addEventListener("click",this._handleTileClick),n.addEventListener("keydown",this._handleKeyDown);const a=document.createElement("div");a.className=`w-10 h-10 rounded-md flex justify-center items-center flex-shrink-0 ${this._getTypeWrapperColor(t)} ${this.theme.fileIconColor}`,a.innerHTML=this._getTypeIcon(t);const o=document.createElement("div");o.className="flex flex-col flex-grow min-w-0 gap-1";const r=document.createElement("div");if(r.className="text-sm font-medium truncate",r.textContent=e,o.appendChild(r),s){const e=document.createElement("div");e.className=`text-xs ${this.theme.subtleText}`;const t=document.createElement("time");t.dateTime=s,t.textContent=this._formatRelativeTime(s),e.appendChild(t),o.appendChild(e)}n.appendChild(a),n.appendChild(o),i.appendChild(n),this.appendChild(i)}_handleTileClick(e){e.defaultPrevented||this._focusDocument()}_handleKeyDown(e){"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),this._focusDocument())}_focusDocument(){const e=this.getAttribute("document-id");if(!e)return;const t={documentId:e,revision:this.getAttribute("revision")||null,versionId:this.getAttribute("version-id")||null},s=N.instance,i=s?.get?.("document",e);i&&"function"==typeof i.handleFocus?i.handleFocus():this.dispatchEvent(new CustomEvent("version-tile:open",{detail:t,bubbles:!0,composed:!0}))}_getTypeIcon(e){const t=o.A.name({document:"fileWord",code:"brackets",slides:"presentation",sheets:"fileSpreadsheet"}[e]||"history");return`<svg viewBox="${t.viewBox}" aria-hidden="true" focusable="false" class="w-5 h-5 fill-current pointer-events-none"><path d="${t.path}"></path></svg>`}_getTypeWrapperColor(e){return{document:this.theme.fileDocColor,code:this.theme.fileOtherColor,slides:this.theme.fileSpreadsheetColor,sheets:this.theme.fileSpreadsheetColor}[e]||this.theme.fileOtherColor}_formatRelativeTime(e){const t=Date.now()-Date.parse(e);if(Number.isNaN(t))return"";const s=new Intl.RelativeTimeFormat(void 0,{numeric:"auto"}),i=Math.round(t/6e4);if(Math.abs(i)<60)return s.format(-i,"minute");const n=Math.round(i/60);if(Math.abs(n)<24)return s.format(-n,"hour");const a=Math.round(n/24);return s.format(-a,"day")}}customElements.get("version-tile")||customElements.define("version-tile",ns);const as=async()=>{window.appController||(window.appController=new os,await window.appController.initializeApp())};class os{constructor(){this.theme=i.A.theme,this.currentViewInstance=null,this.viewsContainer=document.createElement("div"),this.viewsContainer.id="views-container",this.viewsContainer.className="w-full h-full flex flex-col";const e=document.getElementById("primary-content");e&&e.parentNode&&(e.parentNode.replaceChild(this.viewsContainer,e),this.primaryContent=document.createElement("div"),this.primaryContent.id="primary-content",this.primaryContent.className="flex flex-col h-full w-full",this.viewsContainer.appendChild(this.primaryContent),this.viewContainers={chat:this.primaryContent,history:this.createViewContainer("history-view"),assistants:this.createViewContainer("assistants-view"),tasks:this.createViewContainer("tasks-view"),settings:this.createViewContainer("settings-view"),fileManager:this.createViewContainer("file-manager-view"),newAssistant:this.createViewContainer("new-assistant-view"),editAssistant:this.createViewContainer("edit-assistant-view"),newSkill:this.createViewContainer("new-skill-view"),editSkill:this.createViewContainer("edit-skill-view"),apps:this.createViewContainer("apps-view"),workspaces:this.createViewContainer("workspaces-view"),workspaceAdmin:this.createViewContainer("workspace-admin-view"),workspaceWizard:this.createViewContainer("workspace-wizard-view"),changelog:this.createViewContainer("changelog-view"),billing:this.createViewContainer("billing-view"),personalization:this.createViewContainer("personalization-view")}),this.handlePopState=this.handlePopState.bind(this)}async initializeApp(){const{active_chat_id:e,active_special_tab_id:t}=ke.initSessionTabs();this.setListeners(),this.enableHotKeys(),window.addEventListener("popstate",this.handlePopState),await this.handleInitialRoute(e,t)}createViewContainer(e){const t=document.createElement("div");return t.id=e,t.className="flex flex-col h-[calc(100%-48px)] w-full hidden",t.setAttribute("data-view-container","true"),this.viewsContainer.appendChild(t),t}switchToView(e){Object.values(this.viewContainers).forEach((e=>{e.classList.add("hidden")})),this.viewContainers[e]&&(this.viewContainers[e].classList.remove("hidden"),ke.sessionTabs&&"chat"!==e&&"function"==typeof ke.sessionTabs.setActiveSpecialTab&&ke.sessionTabs.setActiveSpecialTab(e))}handlePopState(e){if(e.state&&e.state.noRoute)return;const t=window.location.pathname;this.routeTo(t)}async handleInitialRoute(e,t){const s=window.location.pathname.replace(/\/$/,""),i=new URLSearchParams(window.location.search).get("success"),n=["/","","/chat"],a="/chat/new"===s||s.startsWith("/chat/new/");try{if(a)await ke.createNewChat();else if(n.includes(s))if(e){const t=new ke(e,null,!1,!0);await t.initializationPromise,await ke.switchToChat(e)}else if(t){const e=ke.sessionTabs?.specialTabs.find((e=>e.id===t));e&&e.route?await this.routeTo(e.route):await ke.createNewChat()}else await ke.createNewChat();else await this.routeTo(s)}catch(e){new c.y("Error loading initial session. Please refresh.","error");try{await ke.createNewChat()}catch(e){}}if("true"===i){const e=new URL(window.location);"/chat/workspace/new"===s&&e.searchParams.has("status")||this.showSuccessMessage()}}enableHotKeys(){document.addEventListener("keydown",(e=>{if(window.user.preferences.enableKeyboardShortcuts)return!e.altKey||e.ctrlKey||e.metaKey||e.shiftKey||"KeyN"!==e.code?void(e.altKey&&e.shiftKey&&!e.ctrlKey&&!e.metaKey&&("ArrowLeft"===e.key?(e.preventDefault(),this.navigateTab(-1)):"ArrowRight"===e.key&&(e.preventDefault(),this.navigateTab(1)))):(e.preventDefault(),void(ke.sessionTabs&&"function"==typeof ke.sessionTabs.onNewTab&&ke.sessionTabs.onNewTab()))}))}navigateTab(e){ke.sessionTabs,ke.sessionTabs?.tabs.map((e=>({id:e.id,title:e.title,active:e.active})));if(!ke.sessionTabs||!ke.sessionTabs.tabs||ke.sessionTabs.tabs.length<=1)return;const t=ke.sessionTabs.tabs,s=ke.sessionTabs.activeTabId;let i=-1;s&&(i=t.findIndex((e=>e.id===s))),-1===i&&(i=1===e?-1:t.length);let n=i+e;n>=t.length?n=0:n<0&&(n=t.length-1);const a=t[n]?.id;a&&a!==s&&this.routeTo(`/chat/${a}`)}async routeTo(e){this.currentViewInstance&&"function"==typeof this.currentViewInstance.destroy&&(this.currentViewInstance.destroy(),this.currentViewInstance=null);const t=e.replace(/\/$/,""),s=/^\/chat\/[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}$/.test(t);let i,n="chat";if("/chat/history"===t?n="history":"/chat/assistants"===t?n="assistants":"/chat/assistants/new"===t?n="newAssistant":/^\/chat\/assistants\/[0-9]+\/edit/.test(t)?n="editAssistant":"/chat/tasks"===t?n="tasks":"/chat/file-manager"===t?n="fileManager":"/chat/skills/new"===t?n="newSkill":t.startsWith("/chat/skills/edit")?n="editSkill":"/chat/apps"===t?n="apps":"/chat/workspaces"===t?n="workspaces":t.startsWith("/chat/workspace/admin")?n="workspaceAdmin":"/chat/workspace/new"===t?n="workspaceWizard":"/chat/settings"===t?n="settings":"/chat/settings/billing"===t?n="billing":"/chat/settings/personalize"===t?n="personalization":"/chat/changelog"===t?n="changelog":s||"/chat"===t||"/chat/new"===t||t.startsWith("/chat/new/")||(n="chat"),this.switchToView(n),ke.sessionTabs)if("chat"===n){if(s){t.split("/").pop()}}else{const e={history:"history",assistants:"assistants",fileManager:"files",tasks:"tasks"}[n];e?ke.sessionTabs.setActiveSpecialTab(e):ke.sessionTabs.setActiveTab(null)}if(s){const s=t.split("/").pop();window.history.pushState({},"Chat",e),this.renderChat(s)}else if(/^\/chat\/new\/[0-9]+$/.test(t))i=t.split("/").pop(),window.history.pushState({},"Chat",e),this.renderNewChatWithAssistant(i);else if(/^\/chat\/assistants\/[0-9]+\/edit/.test(t)){const s=t.split("/")[3];window.history.pushState({},"Edit Assistant",e),this.renderEditAssistant(s)}else if(t.startsWith("/chat/workspace/admin")){const s=t.split("/admin/")[1]||null;window.history.pushState({},"Workspace Admin",e),await this.renderWorkspaceAdmin(s)}else switch(t){case"/chat":case"/chat/new":default:ke.createNewChat();break;case"/chat/history":window.history.pushState({},"Session history",e),this.renderChatHistory();break;case"/chat/assistants":window.history.pushState({},"Assistants",e),this.renderAssistants();break;case"/chat/assistants/new":window.history.pushState({},"New assistant",e),this.renderNewAssistant();break;case"/chat/tasks":window.history.pushState({},"Tasks",e),this.renderTasks();break;case"/chat/file-manager":window.history.pushState({},"File manager",e),this.renderFileManager();break;case"/chat/skills/new":window.history.pushState({},"New skill",e),this.renderNewSkill();break;case"/chat/apps":window.history.pushState({},"Apps",e),this.renderApps();break;case"/chat/workspaces":window.history.pushState({},"Select workspace",e),this.renderWorkspaceSelector();break;case"/chat/settings":window.history.pushState({},"User settings",e),this.renderUserSettings();break;case"/chat/changelog":window.history.pushState({},"Changelog",e),this.renderChangelog();break;case"/chat/settings/billing":window.history.pushState({},"Billing",e),this.renderBilling();break;case"/chat/settings/personalize":window.history.pushState({},"Personalization",e),this.renderUserPersonalization();break;case"/chat/skills/edit":window.history.pushState({},"Edit skill",e),this.renderEditSkill()}}getViewTypeFromPath(e){const t=e.replace(/\/$/,"");return"/chat/history"===t?"history":"/chat/assistants"===t?"assistants":"/chat/assistants/new"===t?"newAssistant":/^\/chat\/assistants\/[0-9]+\/edit/.test(t)?"editAssistant":"/chat/tasks"===t?"tasks":"/chat/file-manager"===t?"fileManager":"/chat/skills/new"===t?"newSkill":t.startsWith("/chat/skills/edit")?"editSkill":"/chat/apps"===t?"apps":"/chat/workspaces"===t?"workspaces":t.startsWith("/chat/workspace/admin")?"workspaceAdmin":"/chat/workspace/new"===t?"workspaceWizard":"/chat/settings"===t?"settings":"/chat/settings/billing"===t?"billing":"/chat/settings/personalize"===t?"personalization":"/chat/changelog"===t?"changelog":("/chat"===t||"/chat/new"===t||/^\/chat\/[a-zA-Z0-9]{8}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{4}-[a-zA-Z0-9]{12}$/.test(t)||t.startsWith("/chat/new/"),"chat")}renderFileManager(){this.clearContainers(this.viewContainers.fileManager),this.fileManager=new Ze,this.fileManager.render(this.viewContainers.fileManager),window.history.pushState({},"File Manager","/chat/file-manager"),this.updateTitle("File Manager")}renderNewChatWithAssistant(e){this.chat&&this.chat.destroy(),e&&(window.current_assistant_id=e),this.renderChat(null,!0)}renderNewChatWithNoAssistant(e){this.chat&&this.chat.destroy(),window.current_assistant_id=e,this.renderChat(null,!0)}async renderChat(e=null,t=!1){if(t)return await ke.createNewChat(),this.chat=ke.activeChat,void(this.chat&&this.awaitSessionName());if(!e)return await ke.createNewChat(),this.chat=ke.activeChat,void(this.chat&&this.awaitSessionName());let s=ke.chatInstances[e];try{s||(s=new ke(e,null,!1,!1),await ke.switchToChat(e,s,!0)),await s.initializationPromise,await ke.switchToChat(e,s,!1),this.chat=ke.activeChat,this.chat&&this.awaitSessionName()}catch(e){new c.y(`Failed to load chat session: ${e.message||e}`,"error")}}closeChat(e){ke.closeChat(e)}async awaitSessionName(){let e=this.chat.getConversationName();null!==e?this.updateTitle(e):e="New Session"}renderChatHistory(){this.clearContainers(this.viewContainers.history),this.chatHistory?this.chatHistory.quickRender(this.viewContainers.history):(this.chatHistory=new Te(this.viewContainers.history),this.chatHistory.init(this.viewContainers.history)),this.updateTitle("Sessions")}renderNewSkill(){this.clearContainers(this.viewContainers.newSkill),this.newAgent=new nt(null,this.viewContainers.newSkill),window.history.pushState({},"New Skill","/chat/skills/new"),this.updateTitle("Train a new skill")}async renderEditSkill(e){this.clearContainers(this.viewContainers.editSkill),this.editSkillInstance=new ct(e,this.viewContainers.editSkill),await this.editSkillInstance.init(),window.history.pushState({},"Edit skill",`/chat/skills/${e}/edit`),this.updateTitle("Edit Skill")}renderTasks(){this.clearContainers(),this.tasks=new dt,window.history.pushState({},"Tasks","/chat/tasks"),this.updateTitle("Tasks")}renderApps(){this.clearContainers(this.viewContainers.apps),this.apps=new $e(this.viewContainers.apps),window.history.pushState({},"Apps","/chat/apps"),this.updateTitle("Apps")}renderAssistants(){this.clearContainers(this.viewContainers.assistants),this.assistants?(this.currentViewInstance=this.assistants,this.assistants.quickRender(this.viewContainers.assistants)):(this.assistants=new _e,this.currentViewInstance=this.assistants,this.assistants.init(this.viewContainers.assistants)),this.updateTitle("Assistants")}renderChangelog(){this.clearContainers(this.viewContainers.changelog),this.changelog=new Ne(this.viewContainers.changelog),window.history.pushState({},"Changelog","/chat/changelog"),this.updateTitle("Changelog")}renderNewAssistant(){const e=this.viewContainers.newAssistant;this.clearContainers(e),this.newAssistantInstance||(this.newAssistantInstance=new Ae),this.newAssistantInstance.init(e,null),window.history.pushState({},"New assistant","/chat/assistants/new"),this.updateTitle("New assistant")}async renderEditAssistant(e){const t=this.viewContainers.editAssistant;this.clearContainers(t);try{const s=await u.K.getAssistant(e);if(!s)return new c.y("Assistant not found.","error"),void DispatchTo.view("/chat/assistants");this.editAssistantInstance||(this.editAssistantInstance=new Ae),this.editAssistantInstance.init(t,s),window.history.pushState({},`Edit assistant - ${s.name}`,`/chat/assistants/${e}/edit`),this.updateTitle(`Edit assistant - ${s.name}`)}catch(e){new c.y("Failed to load assistant for editing.","error"),DispatchTo.view("/chat/assistants")}}renderUserSettings(){this.clearContainers(this.viewContainers.settings),this.userSettings=new De(this.viewContainers.settings),window.history.pushState({},"User settings","/chat/settings"),this.updateTitle("Settings")}renderWorkspaceSelector(){this.clearContainers(this.viewContainers.workspaces),this.workspaceSelectorInstance||(this.workspaceSelectorInstance=new Be),this.workspaceSelectorInstance.init(this.viewContainers.workspaces),window.history.pushState({},"Select workspace","/chat/workspaces"),this.updateTitle("Workspaces")}async renderWorkspaceAdmin(e=null){const t=y.a.config?.slug||window.workspace?.slug;if(!t)return new c.y("You must select a workspace first.","error"),void DispatchTo.view("/chat/workspaces");const s=this.viewContainers.workspaceAdmin;this.workspaceAdminInstance?this.workspaceAdminInstance.quickRender(s,t,e):(this.workspaceAdminInstance=new qe,await this.workspaceAdminInstance.init(s,t,e))}renderWorkspaceWaitlist(){this.clearContainers(this.viewContainers.workspaces),this.workspace=new ze(this.viewContainers.workspaces),window.history.pushState({},"Workspace","/chat/workspace"),this.updateTitle("Workspace Waitlist")}renderWorkspaceMembers(){this.clearContainers(this.viewContainers.workspaces),this.workspaceMembers=new WorkspaceMembers(this.viewContainers.workspaces),window.history.pushState({},"Workspace Members","/chat/workspace/members"),this.updateTitle("Workspace Members")}renderWorkspaceApps(){this.clearContainers(this.viewContainers.workspaces),this.workspaceApps=new Pe(this.viewContainers.workspaces),window.history.pushState({},"Workspace Apps","/chat/workspace/apps"),this.updateTitle("Workspace Apps")}renderBilling(){this.clearContainers(this.viewContainers.billing),this.userBilling=new et,this.userBilling.init(this.viewContainers.billing),window.history.pushState({},"Billing","/chat/settings/billing"),this.updateTitle("Billing")}renderUserPersonalization(){this.clearContainers(this.viewContainers.personalization),this.userPersonalization=new tt(this.viewContainers.personalization),window.history.pushState({},"Personalization","/chat/settings/personalize"),this.updateTitle("Personalization")}handleMenuSelection(e){const{selection:t}=e.detail,s={"new-conversation":"/chat",history:"/chat/history",assistants:"/chat/assistants",workspace:"/chat/workspace","workspace-members":"/chat/workspace/members","workspace-apps":"/chat/workspace/apps",user:"/chat/settings","user-personalize":"/chat/settings/personalize",billing:"/chat/settings/billing",apps:"/chat/apps",changelog:"/chat/changelog","settings-theme":"/chat/settings/theme","file-manager":"/chat/file-manager",tasks:"/chat/tasks"};s[t]&&this.routeTo(s[t])}clearContainers(e=null){if(e)e.innerHTML="";else{const e=document.getElementById("primary-content");e&&(e.innerHTML="")}}setListeners(){document.addEventListener("routeChange",(e=>this.routeTo(e.detail.path)));const e=()=>{let e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)};window.addEventListener("load",e),window.addEventListener("resize",e)}static setViewHeight(){let e=.01*window.innerHeight;document.documentElement.style.setProperty("--vh",`${e}px`)}registerServiceWorker(){"serviceWorker"in navigator&&navigator.serviceWorker.register("/static/js/chat/services/service-worker.js").then((e=>{})).catch((e=>{}))}updateTitle(e){document.title=e+" - "+("Personal"===y.a._workspace.name?"Simtheory":y.a._workspace.name)}showSuccessMessage(){const e=document.createElement("div");e.className="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 backdrop-blur-sm";const t=document.createElement("div");t.className="relative max-w-6xl mx-4 bg-white rounded-3xl shadow-2xl overflow-hidden";const s=document.createElement("div");s.innerHTML=`\n            <div class="relative">\n                \x3c!-- Background decoration --\x3e\n                <div class="absolute -z-10 w-[800px] h-[800px] opacity-20 -top-20 -right-20">\n                    <img src="/static/img/sim-bg.png" alt="" class="w-full h-full object-contain">                \n                </div>\n                \n                \x3c!-- Main content grid --\x3e\n                <div class="grid grid-cols-1 lg:grid-cols-2 gap-12 p-8 lg:p-12 max-w-[1000px]">\n                    \x3c!-- Left side - Text content --\x3e\n                    <div class="space-y-8 flex flex-col justify-center">\n                        <div class="space-y-4">\n                            <div class="inline-flex items-center">\n                                <div class="bg-gradient-to-r from-blue-100 to-purple-100 text-blue-800 text-sm font-medium px-4 py-2 rounded-full">\n                                    <span class="bg-green-300 text-green-800 px-2 py-1 font-medium rounded-full mr-2"></span>\n                                    <span class="font-medium tracking-tight">Workspace ready</span>\n                                </div>\n                            </div>\n                            \n                            <h1 class="text-4xl lg:text-5xl font-medium tracking-tighter leading-tight text-black max-w-[400px]">\n                                ${"Personal"!==y.a.workspace.name?`Welcome to ${y.a.workspace.name}'s AI workspace`:"Welcome to your AI workspace"}\n                            </h1>\n                            \n                            <p class="text-xl lg:text-2xl text-gray-700 tracking-tight leading-relaxed">\n                                A private and secure place to do real work, learn, and collaborate with AI.\n                            </p>\n                        </div>\n                        \n                        \n                        \n                        \x3c!-- CTA Button --\x3e\n                        <div class="pt-1 flex flex-col">\n                            <button id="welcomeStartBtn" class="w-full sm:w-auto px-12 py-4 bg-black hover:bg-[#3650E8] text-white rounded-full text-lg font-medium transition-all duration-300 transform hover:scale-105 shadow-xl hover:shadow-2xl">\n                                Let's go!\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Right side - Feature image --\x3e\n                    <div class="flex items-center justify-center lg:justify-end">\n                        <div class="relative">\n                            <div class="absolute inset-0 bg-gradient-to-br from-blue-400 to-purple-600 rounded-2xl transform rotate-3 opacity-20"></div>\n                            <img src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1752468861/website/new%20home/agentic-task-clean_oqfiwn.png" \n                                 alt="Simtheory Features" \n                                 class="relative rounded-2xl shadow-2xl w-full max-w-lg transform hover:scale-105 transition-transform duration-300">\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- Close button --\x3e\n                <button id="welcomeCloseBtn" class="absolute top-6 right-6 w-10 h-10 bg-gray-100 hover:bg-gray-200 rounded-full flex items-center justify-center transition-colors">\n                    <svg class="w-5 h-5 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </button>\n            </div>\n        `,t.appendChild(s),e.appendChild(t),document.body.appendChild(e);const i=document.getElementById("welcomeStartBtn"),n=document.getElementById("welcomeCloseBtn"),a=()=>{e.style.opacity="0",e.style.transform="scale(0.95)",setTimeout((()=>{document.body.removeChild(e)}),300)};i.addEventListener("click",a),n.addEventListener("click",a),e.addEventListener("click",(t=>{t.target===e&&a()})),e.style.opacity="0",e.style.transform="scale(0.95)",e.style.transition="all 0.3s ease-out",setTimeout((()=>{e.style.opacity="1",e.style.transform="scale(1)"}),50);new H.N}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",as):setTimeout((()=>{window._sttime1=(new Date).getTime(),as()}),0),window.addEventListener("load",(()=>{const e=document.getElementById("loading-screen");e&&(e.classList.add("loaded"),e.classList.remove("loading"))})),document.addEventListener("copy",(e=>{e.preventDefault();const t=window.getSelection(),s=t.toString(),i=t.getRangeAt(0),n=document.createElement("div");n.appendChild(i.cloneContents());const a=`\n      <div>\n        ${n.innerHTML}\n      </div>\n    `;e.clipboardData.setData("text/plain",s),e.clipboardData.setData("text/html",a)})),document.addEventListener("keydown",(function(e){if("PageUp"===e.key){const t=document.activeElement;if("INPUT"===t.tagName||"TEXTAREA"===t.tagName){if(!(0===t.scrollTop)){e.preventDefault();const s=t.scrollTop;t.scrollTop=Math.max(0,s-t.clientHeight)}}}}))},85113:(e,t,s)=>{"use strict";s.d(t,{R:()=>i});const i=e=>{let t=null;if(document.cookie&&""!==document.cookie){let s=document.cookie.split(";");for(let i=0;i<s.length;i++){let n=s[i].trim();if(n.substring(0,e.length+1)===e+"="){t=decodeURIComponent(n.substring(e.length+1));break}}}return t}},2430:(e,t,s)=>{"use strict";s.d(t,{A:()=>i});class i{static icon={plus:{path:"M256 80c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 144L48 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0 0 144c0 17.7 14.3 32 32 32s32-14.3 32-32l0-144 144 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-144 0 0-144z",viewBox:"0 0 448 512",fontAwesomeRef:"fa-plus"},bell:{path:"M320 64C302.3 64 288 78.3 288 96L288 99.2C215 114 160 178.6 160 256L160 277.7C160 325.8 143.6 372.5 113.6 410.1L103.8 422.3C98.7 428.6 96 436.4 96 444.5C96 464.1 111.9 480 131.5 480L508.4 480C528 480 543.9 464.1 543.9 444.5C543.9 436.4 541.2 428.6 536.1 422.3L526.3 410.1C496.4 372.5 480 325.8 480 277.7L480 256C480 178.6 425 114 352 99.2L352 96C352 78.3 337.7 64 320 64zM258 528C265.1 555.6 290.2 576 320 576C349.8 576 374.9 555.6 382 528L258 528z",viewBox:"0 0 640 640"},bellSlash:{path:"M73 39.1C63.6 29.7 48.4 29.7 39.1 39.1C29.8 48.5 29.7 63.7 39 73.1L567 601.1C576.4 610.5 591.6 610.5 600.9 601.1C610.2 591.7 610.3 576.5 600.9 567.2L513.4 479.7C530.6 477.3 543.9 462.4 543.9 444.5C543.9 436.4 541.2 428.6 536.1 422.3L526.3 410.1C496.4 372.5 480 325.8 480 277.7L480 256C480 178.6 425 114 352 99.2L352 96C352 78.3 337.7 64 320 64C302.3 64 288 78.3 288 96L288 99.2C249.4 107 215.8 128.8 192.8 158.9L73 39.1zM160 277.6C160 325.7 143.6 372.4 113.6 410L103.8 422.2C98.8 428.5 96 436.3 96 444.4C96 464 111.9 479.9 131.5 479.9L366.8 479.9L159.9 273L159.9 277.5zM320 576C349.8 576 374.9 555.6 382 528L258 528C265.1 555.6 290.2 576 320 576z",viewBox:"0 0 640 640"},boxClosed:{path:"M50.7 58.5L0 160l160 0L192 32 93.7 32C75.5 32 58.9 42.3 50.7 58.5zM288 160l160 0L397.3 58.5C389.1 42.3 372.5 32 354.3 32L256 32l32 128zM160 192L0 192 0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-224-160 0 0 64c0 17.7-14.3 32-32 32l-64 0c-17.7 0-32-14.3-32-32l0-64z",viewBox:"0 0 448 512"},bookOpen:{path:"M320 205.3L320 514.6L320.5 514.4C375.1 491.7 433.7 480 492.8 480L512 480L512 160L492.8 160C450.6 160 408.7 168.4 369.7 184.6C352.9 191.6 336.3 198.5 320 205.3zM294.9 125.5L320 136L345.1 125.5C391.9 106 442.1 96 492.8 96L528 96C554.5 96 576 117.5 576 144L576 496C576 522.5 554.5 544 528 544L492.8 544C442.1 544 391.9 554 345.1 573.5L332.3 578.8C324.4 582.1 315.6 582.1 307.7 578.8L294.9 573.5C248.1 554 197.9 544 147.2 544L112 544C85.5 544 64 522.5 64 496L64 144C64 117.5 85.5 96 112 96L147.2 96C197.9 96 248.1 106 294.9 125.5z",viewBox:"0 0 640 640"},bolt:{path:"M434.8 54.1C446.7 62.7 451.1 78.3 445.7 91.9L367.3 288L512 288C525.5 288 537.5 296.4 542.1 309.1C546.7 321.8 542.8 336 532.5 344.6L244.5 584.6C233.2 594 217.1 594.5 205.2 585.9C193.3 577.3 188.9 561.7 194.3 548.1L272.7 352L128 352C114.5 352 102.5 343.6 97.9 330.9C93.3 318.2 97.2 304 107.5 295.4L395.5 55.4C406.8 46 422.9 45.5 434.8 54.1z",viewBox:"0 0 640 640"},boxOpen:{path:"M508.9 64.9l-27.5 73.4L320 158.5l-7.2-.9c4.6-8.8 7.2-18.9 7.2-29.6c0-35.3-28.7-64-64-64s-64 28.7-64 64c0 5.1 .6 10 1.7 14.7l-65.5-8.2c-.1-2.2-.2-4.3-.2-6.5C128 57.3 185.3 0 256 0c69.6 0 126.2 55.6 128 124.7l35.1-93.6c9.3-24.8 37-37.4 61.8-28.1s37.4 37 28.1 61.8zM576 338.3l0 83.4c0 14.7-10 27.5-24.2 31L335.5 506.8c-10.2 2.5-20.9 2.5-31 0L88.2 452.8C74 449.2 64 436.4 64 421.7l0-83.4 127.6 36.5c27.8 8 57.6-3.8 72.5-28.6L320 252.9l55.9 93.2c14.9 24.8 44.6 36.6 72.5 28.6L576 338.3zM58.9 168.8c3-6.1 9.6-9.6 16.3-8.7L320 190.7l244.8-30.6c6.7-.8 13.3 2.7 16.3 8.7l41.7 83.4c9 17.9-.6 39.6-19.8 45.1L439.6 344c-13.9 4-28.8-1.9-36.2-14.3L320 190.7l-83.4 139c-7.4 12.4-22.3 18.3-36.2 14.3L37.1 297.3c-19.3-5.5-28.8-27.2-19.8-45.1l41.7-83.4z",viewBox:"0 0 640 512"},chevronUp:{path:"M233.4 105.4c12.5-12.5 32.8-12.5 45.3 0l192 192c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L256 173.3 86.6 342.6c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3l192-192z",viewBox:"0 0 512 512",fontAwesomeRef:"fa-chevron-up"},chevronDown:{path:"M233.4 406.6c12.5 12.5 32.8 12.5 45.3 0l192-192c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L256 338.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l192 192z",viewBox:"0 0 512 512",fontAwesomeRef:"fa-chevron-down"},chevronLeft:{path:"M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z",viewBox:"0 0 320 512"},chevronRight:{path:"M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z",viewBox:"0 0 320 512"},bars:{path:"M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z",viewBox:"0 0 448 512"},copy:{path:"M208 0L332.1 0c12.7 0 24.9 5.1 33.9 14.1l67.9 67.9c9 9 14.1 21.2 14.1 33.9L448 336c0 26.5-21.5 48-48 48l-192 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48zM48 128l80 0 0 64-64 0 0 256 192 0 0-32 64 0 0 48c0 26.5-21.5 48-48 48L48 512c-26.5 0-48-21.5-48-48L0 176c0-26.5 21.5-48 48-48z",viewBox:"0 0 448 512",fontAwesomeRef:"fa-copy"},focus:{path:"M32 32C14.3 32 0 46.3 0 64l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 32zM64 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7 14.3 32 32 32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-64 0 0-64zM320 32c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96c0-17.7-14.3-32-32-32l-96 0zM448 352c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64-64 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l96 0c17.7 0 32-14.3 32-32l0-96z",viewBox:"0 0 448 512"},tabClose:{path:"M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z",viewBox:"0 0 384 512"},ellipsis:{path:"M8 256a56 56 0 1 1 112 0A56 56 0 1 1 8 256zm160 0a56 56 0 1 1 112 0 56 56 0 1 1 -112 0zm216-56a56 56 0 1 1 0 112 56 56 0 1 1 0-112z",viewBox:"0 0 448 512"},chatSendMessage:{path:"M169.4 41.4c12.5-12.5 32.8-12.5 45.3 0l160 160c9.2 9.2 11.9 22.9 6.9 34.9s-16.6 19.8-29.6 19.8l-96 0 0 184c0 22.1-17.9 40-40 40l-48 0c-22.1 0-40-17.9-40-40l0-184-96 0c-12.9 0-24.6-7.8-29.6-19.8s-2.2-25.7 6.9-34.9l160-160z",viewBox:"0 0 384 512"},waveform:{path:"M352 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 448c0 17.7 14.3 32 32 32s32-14.3 32-32l0-448zM544 96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 320c0 17.7 14.3 32 32 32s32-14.3 32-32l0-320zM256 128c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32s32-14.3 32-32l0-256zm192 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 192c0 17.7 14.3 32 32 32s32-14.3 32-32l0-192zM160 224c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 64c0 17.7 14.3 32 32 32s32-14.3 32-32l0-64zM0 256a32 32 0 1 0 64 0A32 32 0 1 0 0 256zm576 0a32 32 0 1 0 64 0 32 32 0 1 0 -64 0z",viewBox:"0 0 640 512",fontAwesomeRef:"fa-waveform"},chatScreenShare:{path:"M64 0C28.7 0 0 28.7 0 64L0 352c0 35.3 28.7 64 64 64l176 0-10.7 32L160 448c-17.7 0-32 14.3-32 32s14.3 32 32 32l256 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-69.3 0L336 416l176 0c35.3 0 64-28.7 64-64l0-288c0-35.3-28.7-64-64-64L64 0zM512 64l0 288L64 352 64 64l448 0z",viewBox:"0 0 576 512"},chatScreenShareOff:{path:"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7l-70.5-55.2c27.4-7.2 47.6-32.2 47.6-61.9l0-288c0-35.3-28.7-64-64-64L96 0C79.6 0 64.6 6.2 53.2 16.4L38.8 5.1zM113.9 64L544 64l0 288-62.6 0L113.9 64zM32 352c0 35.3 28.7 64 64 64l176 0-10.7 32L192 448c-17.7 0-32 14.3-32 32s14.3 32 32 32l256 0c17.7 0 32-14.3 32-32c0-2.1-.2-4.1-.6-6.1L446.6 448l-67.9 0L368 416l38 0-81.2-64L96 352l0-180.2L32 121.4 32 352z",viewBox:"0 0 576 512"},menuHistory:{path:"M121 32C91.6 32 66 52 58.9 80.5L1.9 308.4C.6 313.5 0 318.7 0 323.9L0 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-92.1c0-5.2-.6-10.4-1.9-15.5l-57-227.9C446 52 420.4 32 391 32L121 32zm0 64l270 0 48 192-51.2 0c-12.1 0-23.2 6.8-28.6 17.7l-14.3 28.6c-5.4 10.8-16.5 17.7-28.6 17.7l-120.4 0c-12.1 0-23.2-6.8-28.6-17.7l-14.3-28.6c-5.4-10.8-16.5-17.7-28.6-17.7L73 288 121 96z",viewBox:"0 0 576 512"},history:{path:"M320 128C426 128 512 214 512 320C512 426 426 512 320 512C254.8 512 197.1 479.5 162.4 429.7C152.3 415.2 132.3 411.7 117.8 421.8C103.3 431.9 99.8 451.9 109.9 466.4C156.1 532.6 233 576 320 576C461.4 576 576 461.4 576 320C576 178.6 461.4 64 320 64C234.3 64 158.5 106.1 112 170.7L112 144C112 126.3 97.7 112 80 112C62.3 112 48 126.3 48 144L48 256C48 273.7 62.3 288 80 288L104.6 288C105.1 288 105.6 288 106.1 288L192.1 288C209.8 288 224.1 273.7 224.1 256C224.1 238.3 209.8 224 192.1 224L153.8 224C186.9 166.6 249 128 320 128zM344 216C344 202.7 333.3 192 320 192C306.7 192 296 202.7 296 216L296 320C296 326.4 298.5 332.5 303 337L375 409C384.4 418.4 399.6 418.4 408.9 409C418.2 399.6 418.3 384.4 408.9 375.1L343.9 310.1L343.9 216z",viewBox:"0 0 640 640"},menuAssistants:{path:"M128 32a96 96 0 1 0 0 192 96 96 0 1 0 0-192zm0 256a96 96 0 1 0 0 192 96 96 0 1 0 0-192zM288 128a96 96 0 1 0 192 0 96 96 0 1 0 -192 0zm96 160a96 96 0 1 0 0 192 96 96 0 1 0 0-192z",viewBox:"0 0 576 512"},menuFiles:{path:"M64 480H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H288c-10.1 0-19.6-4.7-25.6-12.8L243.2 57.6C231.1 41.5 212.1 32 192 32H64C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64z",viewBox:"0 0 512 512"},spinner:{path:"M224 32c0-17.7 14.3-32 32-32C397.4 0 512 114.6 512 256c0 46.6-12.5 90.4-34.3 128c-8.8 15.3-28.4 20.5-43.7 11.7s-20.5-28.4-11.7-43.7c16.3-28.2 25.7-61 25.7-96c0-106-86-192-192-192c-17.7 0-32-14.3-32-32z",viewBox:"0 0 512 512"},trash:{path:"M135.2 17.7L128 32 32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l384 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-96 0-7.2-14.3C307.4 6.8 296.3 0 284.2 0L163.8 0c-12.1 0-23.2 6.8-28.6 17.7zM416 128L32 128 53.2 467c1.6 25.3 22.6 45 47.9 45l245.8 0c25.3 0 46.3-19.7 47.9-45L416 128z",viewBox:"0 0 448 512",fontAwesomeRef:"fa-trash"},help:{path:"M367.2 412.5C335.9 434.9 297.5 448 256 448s-79.9-13.1-111.2-35.5l58-58c15.8 8.6 34 13.5 53.3 13.5s37.4-4.9 53.3-13.5l58 58zm90.7 .8c33.8-43.4 54-98 54-157.3s-20.2-113.9-54-157.3c9-12.5 7.9-30.1-3.4-41.3S425.8 45 413.3 54C369.9 20.2 315.3 0 256 0S142.1 20.2 98.7 54c-12.5-9-30.1-7.9-41.3 3.4S45 86.2 54 98.7C20.2 142.1 0 196.7 0 256s20.2 113.9 54 157.3c-9 12.5-7.9 30.1 3.4 41.3S86.2 467 98.7 458c43.4 33.8 98 54 157.3 54s113.9-20.2 157.3-54c12.5 9 30.1 7.9 41.3-3.4s12.4-28.8 3.4-41.3zm-45.5-46.1l-58-58c8.6-15.8 13.5-34 13.5-53.3s-4.9-37.4-13.5-53.3l58-58C434.9 176.1 448 214.5 448 256s-13.1 79.9-35.5 111.2zM367.2 99.5l-58 58c-15.8-8.6-34-13.5-53.3-13.5s-37.4 4.9-53.3 13.5l-58-58C176.1 77.1 214.5 64 256 64s79.9 13.1 111.2 35.5zM157.5 309.3l-58 58C77.1 335.9 64 297.5 64 256s13.1-79.9 35.5-111.2l58 58c-8.6 15.8-13.5 34-13.5 53.3s4.9 37.4 13.5 53.3zM208 256a48 48 0 1 1 96 0 48 48 0 1 1 -96 0z",viewBox:"0 0 512 512"},powerOff:{path:"M288 32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 224c0 17.7 14.3 32 32 32s32-14.3 32-32l0-224zM143.5 120.6c13.6-11.3 15.4-31.5 4.1-45.1s-31.5-15.4-45.1-4.1C49.7 115.4 16 181.8 16 256c0 132.5 107.5 240 240 240s240-107.5 240-240c0-74.2-33.8-140.6-86.6-184.6c-13.6-11.3-33.8-9.4-45.1 4.1s-9.4 33.8 4.1 45.1c38.9 32.3 63.5 81 63.5 135.4c0 97.2-78.8 176-176 176s-176-78.8-176-176c0-54.4 24.7-103.1 63.5-135.4z",viewBox:"0 0 512 512"},undo:{path:"M71.7 427.8C61.4 440.4 62.2 458.9 73.9 470.6L185.9 582.6C198.4 595.1 218.7 595.1 231.1 582.6C243.5 570.1 243.6 549.8 231.1 537.4L173.7 480L384.5 480C487.2 480 571.1 399.3 576.3 297.9L576.5 288C576.5 182 490.5 96 384.5 96L160.5 96L157.2 96.2C141.1 97.8 128.5 111.4 128.5 128C128.5 144.6 141.1 158.2 157.2 159.8L160.5 160L384.5 160C455.2 160 512.5 217.3 512.5 288L512.3 294.6C508.9 362.2 453 416 384.5 416L173.7 416L231.1 358.6L233.3 356.2C243.5 343.6 242.8 325.1 231.1 313.4C219.4 301.7 200.9 301 188.3 311.2L185.9 313.4L73.9 425.4L71.7 427.8z",viewBox:"0 0 640 640"},justifyCenter:{path:"M448 128C448 110.3 433.7 96 416 96L224 96C206.3 96 192 110.3 192 128C192 145.7 206.3 160 224 160L416 160C433.7 160 448 145.7 448 128zM544 256C544 238.3 529.7 224 512 224L128 224C110.3 224 96 238.3 96 256C96 273.7 110.3 288 128 288L512 288C529.7 288 544 273.7 544 256zM96 512C96 529.7 110.3 544 128 544L512 544C529.7 544 544 529.7 544 512C544 494.3 529.7 480 512 480L128 480C110.3 480 96 494.3 96 512zM448 384C448 366.3 433.7 352 416 352L224 352C206.3 352 192 366.3 192 384C192 401.7 206.3 416 224 416L416 416C433.7 416 448 401.7 448 384z",viewBox:"0 0 640 640"},justifyLeft:{path:"M384 128C384 145.7 369.7 160 352 160L128 160C110.3 160 96 145.7 96 128C96 110.3 110.3 96 128 96L352 96C369.7 96 384 110.3 384 128zM384 384C384 401.7 369.7 416 352 416L128 416C110.3 416 96 401.7 96 384C96 366.3 110.3 352 128 352L352 352C369.7 352 384 366.3 384 384zM96 256C96 238.3 110.3 224 128 224L512 224C529.7 224 544 238.3 544 256C544 273.7 529.7 288 512 288L128 288C110.3 288 96 273.7 96 256zM544 512C544 529.7 529.7 544 512 544L128 544C110.3 544 96 529.7 96 512C96 494.3 110.3 480 128 480L512 480C529.7 480 544 494.3 544 512z",viewBox:"0 0 640 640"},justifyRight:{path:"M544 128C544 145.7 529.7 160 512 160L288 160C270.3 160 256 145.7 256 128C256 110.3 270.3 96 288 96L512 96C529.7 96 544 110.3 544 128zM544 384C544 401.7 529.7 416 512 416L288 416C270.3 416 256 401.7 256 384C256 366.3 270.3 352 288 352L512 352C529.7 352 544 366.3 544 384zM96 256C96 238.3 110.3 224 128 224L512 224C529.7 224 544 238.3 544 256C544 273.7 529.7 288 512 288L128 288C110.3 288 96 273.7 96 256zM544 512C544 529.7 529.7 544 512 544L128 544C110.3 544 96 529.7 96 512C96 494.3 110.3 480 128 480L512 480C529.7 480 544 494.3 544 512z",viewBox:"0 0 640 640"},justifyAlign:{viewBox:"0 0 640 640",path:"M544 128C544 110.3 529.7 96 512 96L128 96C110.3 96 96 110.3 96 128C96 145.7 110.3 160 128 160L512 160C529.7 160 544 145.7 544 128zM544 384C544 366.3 529.7 352 512 352L128 352C110.3 352 96 366.3 96 384C96 401.7 110.3 416 128 416L512 416C529.7 416 544 401.7 544 384zM96 256C96 273.7 110.3 288 128 288L512 288C529.7 288 544 273.7 544 256C544 238.3 529.7 224 512 224L128 224C110.3 224 96 238.3 96 256zM544 512C544 494.3 529.7 480 512 480L128 480C110.3 480 96 494.3 96 512C96 529.7 110.3 544 128 544L512 544C529.7 544 544 529.7 544 512z"},redo:{path:"M569.3 427.8C579.6 440.4 578.8 458.9 567.1 470.6L455.1 582.6C442.6 595.1 422.3 595.1 409.9 582.6C397.5 570.1 397.4 549.8 409.9 537.4L467.3 480L256.6 480C153.8 480 69.9 399.3 64.8 297.9L64.5 288C64.5 182 150.5 96 256.5 96L480.5 96L483.8 96.2C499.9 97.8 512.5 111.5 512.5 128C512.5 144.5 499.9 158.2 483.8 159.8L480.5 160L256.5 160C185.8 160 128.5 217.3 128.5 288L128.7 294.6C132.1 362.2 188 416 256.5 416L467.2 416L409.8 358.6L407.6 356.2C397.4 343.6 398.1 325.1 409.8 313.4C421.5 301.7 440 301 452.6 311.2L455 313.4L567 425.4L569.2 427.8z",viewBox:"0 0 640 640"},cube:{path:"M234.5 5.7c13.9-5 29.1-5 43.1 0l192 68.6C495 83.4 512 107.5 512 134.6l0 242.9c0 27-17 51.2-42.5 60.3l-192 68.6c-13.9 5-29.1 5-43.1 0l-192-68.6C17 428.6 0 404.5 0 377.4L0 134.6c0-27 17-51.2 42.5-60.3l192-68.6zM256 66L82.3 128 256 190l173.7-62L256 66zm32 368.6l160-57.1 0-188L288 246.6l0 188z",viewBox:"0 0 512 512"},rotate:{path:"M142.9 142.9c-17.5 17.5-30.1 38-37.8 59.8c-5.9 16.7-24.2 25.4-40.8 19.5s-25.4-24.2-19.5-40.8C55.6 150.7 73.2 122 97.6 97.6c87.2-87.2 228.3-87.5 315.8-1L455 55c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2l0 128c0 13.3-10.7 24-24 24l-8.4 0c0 0 0 0 0 0L344 224c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l41.1-41.1c-62.6-61.5-163.1-61.2-225.3 1zM16 312c0-13.3 10.7-24 24-24l7.6 0 .7 0L168 288c9.7 0 18.5 5.8 22.2 14.8s1.7 19.3-5.2 26.2l-41.1 41.1c62.6 61.5 163.1 61.2 225.3-1c17.5-17.5 30.1-38 37.8-59.8c5.9-16.7 24.2-25.4 40.8-19.5s25.4 24.2 19.5 40.8c-10.8 30.6-28.4 59.3-52.9 83.8c-87.2 87.2-228.3 87.5-315.8 1L57 457c-6.9 6.9-17.2 8.9-26.2 5.2S16 449.7 16 440l0-119.6 0-.7 0-7.6z",viewBox:"0 0 512 512",fontAwesomeRef:"fa-rotate"},reply:{path:"M205 34.8c11.5 5.1 19 16.6 19 29.2l0 64 112 0c97.2 0 176 78.8 176 176c0 113.3-81.5 163.9-100.2 174.1c-2.5 1.4-5.3 1.9-8.1 1.9c-10.9 0-19.7-8.9-19.7-19.7c0-7.5 4.3-14.4 9.8-19.5c9.4-8.8 22.2-26.4 22.2-56.7c0-53-43-96-96-96l-96 0 0 64c0 12.6-7.4 24.1-19 29.2s-25 3-34.4-5.4l-160-144C3.9 225.7 0 217.1 0 208s3.9-17.7 10.6-23.8l160-144c9.4-8.5 22.9-10.6 34.4-5.4z",viewBox:"0 0 512 512",fontAwesomeRef:"fa-reply"},edit:{path:"M471.6 21.7c-21.9-21.9-57.3-21.9-79.2 0L362.3 51.7l97.9 97.9 30.1-30.1c21.9-21.9 21.9-57.3 0-79.2L471.6 21.7zm-299.2 220c-6.1 6.1-10.8 13.6-13.5 21.9l-29.6 88.8c-2.9 8.6-.6 18.1 5.8 24.6s15.9 8.7 24.6 5.8l88.8-29.6c8.2-2.7 15.7-7.4 21.9-13.5L437.7 172.3 339.7 74.3 172.4 241.7zM96 64C43 64 0 107 0 160L0 416c0 53 43 96 96 96l256 0c53 0 96-43 96-96l0-96c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 96c0 17.7-14.3 32-32 32L96 448c-17.7 0-32-14.3-32-32l0-256c0-17.7 14.3-32 32-32l96 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L96 64z",viewBox:"0 0 512 512"},circleDown:{path:"M256 0a256 256 0 1 0 0 512A256 256 0 1 0 256 0zM244.7 395.3l-112-112c-4.6-4.6-5.9-11.5-3.5-17.4s8.3-9.9 14.8-9.9l64 0 0-96c0-17.7 14.3-32 32-32l32 0c17.7 0 32 14.3 32 32l0 96 64 0c6.5 0 12.3 3.9 14.8 9.9s1.1 12.9-3.5 17.4l-112 112c-6.2 6.2-16.4 6.2-22.6 0z",viewBox:"0 0 512 512"},brain:{path:"M184 0c30.9 0 56 25.1 56 56l0 400c0 30.9-25.1 56-56 56c-28.9 0-52.7-21.9-55.7-50.1c-5.2 1.4-10.7 2.1-16.3 2.1c-35.3 0-64-28.7-64-64c0-7.4 1.3-14.6 3.6-21.2C21.4 367.4 0 338.2 0 304c0-31.9 18.7-59.5 45.8-72.3C37.1 220.8 32 207 32 192c0-30.7 21.6-56.3 50.4-62.6C80.8 123.9 80 118 80 112c0-29.9 20.6-55.1 48.3-62.1C131.3 21.9 155.1 0 184 0zM328 0c28.9 0 52.6 21.9 55.7 49.9c27.8 7 48.3 32.1 48.3 62.1c0 6-.8 11.9-2.4 17.4c28.8 6.2 50.4 31.9 50.4 62.6c0 15-5.1 28.8-13.8 39.7C493.3 244.5 512 272.1 512 304c0 34.2-21.4 63.4-51.6 74.8c2.3 6.6 3.6 13.8 3.6 21.2c0 35.3-28.7 64-64 64c-5.6 0-11.1-.7-16.3-2.1c-3 28.2-26.8 50.1-55.7 50.1c-30.9 0-56-25.1-56-56l0-400c0-30.9 25.1-56 56-56z",viewBox:"0 0 512 512"},brainEmpty:{path:"M153.5 76.9c-1.9 6.8-6.8 12.4-13.2 15.3c-16.6 7.5-28.2 24.1-28.3 43.5c-.1 9.1-5.2 17.3-13.3 21.3C82.8 164.9 72 181.2 72 200c0 7.1 1.5 13.7 4.2 19.7c4.4 9.7 1.9 21-6.1 28C56.5 259.4 48 276.7 48 296c0 20.2 9.3 38.1 23.9 49.9c6.7 5.4 10 14 8.7 22.5c-.4 2.5-.6 5-.6 7.6c0 26.1 20.8 47.3 46.7 48c9.2 .3 17.4 5.7 21.2 14.1c6.9 15.3 22.3 25.9 40.1 25.9c24.3 0 44-19.7 44-44l0-332c0-22.1-17.9-40-40-40c-18.2 0-33.7 12.2-38.5 28.9zM256 482c-16.8 18.5-41.1 30-68 30c-32.2 0-60.5-16.5-76.9-41.5c-45-8-79.1-47.3-79.1-94.5c0-.5 0-1.1 0-1.6C12.2 354.2 0 326.5 0 296c0-27.8 10.1-53.2 26.8-72.7C25 215.8 24 208 24 200c0-32.6 16.3-61.5 41.1-78.8c4.5-28.9 21.8-53.5 45.9-67.8C124.5 22 155.7 0 192 0c25.2 0 48 10.6 64 27.6C272 10.6 294.8 0 320 0c36.3 0 67.5 22 80.9 53.4c24.1 14.3 41.5 38.9 45.9 67.8C471.7 138.5 488 167.4 488 200c0 8-1 15.8-2.8 23.3c16.7 19.6 26.8 45 26.8 72.7c0 30.5-12.2 58.2-32 78.4c0 .5 0 1.1 0 1.6c0 47.3-34.1 86.5-79.1 94.5c-16.4 25-44.7 41.5-76.9 41.5c-26.9 0-51.2-11.6-68-30zm24-62c0 24.3 19.7 44 44 44c17.8 0 33.2-10.6 40.1-25.9c3.8-8.4 12-13.9 21.2-14.1c25.9-.7 46.7-21.9 46.7-48c0-2.6-.2-5.2-.6-7.6c-1.4-8.5 2-17.1 8.7-22.5C454.7 334.1 464 316.2 464 296c0-19.3-8.5-36.6-22.1-48.3c-8-6.9-10.5-18.3-6.1-28c2.7-6 4.2-12.6 4.2-19.7c0-18.8-10.8-35.1-26.7-43c-8.1-4-13.3-12.3-13.3-21.3c-.1-19.3-11.7-36-28.3-43.5c-6.4-2.9-11.3-8.5-13.2-15.3C353.7 60.2 338.2 48 320 48c-22.1 0-40 17.9-40 40l0 332z",viewBox:"0 0 512 512"},collapse:{path:"M439 7c9.4-9.4 24.6-9.4 33.9 0l32 32c9.4 9.4 9.4 24.6 0 33.9l-87 87 39 39c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8l-144 0c-13.3 0-24-10.7-24-24l0-144c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2l39 39L439 7zM72 272l144 0c13.3 0 24 10.7 24 24l0 144c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-39-39L73 505c-9.4 9.4-24.6 9.4-33.9 0L7 473c-9.4-9.4-9.4-24.6 0-33.9l87-87L55 313c-6.9-6.9-8.9-17.2-5.2-26.2s12.5-14.8 22.2-14.8z",viewBox:"0 0 512 512"},expand:{path:"M408 64L552 64C565.3 64 576 74.7 576 88L576 232C576 241.7 570.2 250.5 561.2 254.2C552.2 257.9 541.9 255.9 535 249L496 210L409 297C399.6 306.4 384.4 306.4 375.1 297L343.1 265C333.7 255.6 333.7 240.4 343.1 231.1L430.1 144.1L391.1 105.1C384.2 98.2 382.2 87.9 385.9 78.9C389.6 69.9 398.3 64 408 64zM232 576L88 576C74.7 576 64 565.3 64 552L64 408C64 398.3 69.8 389.5 78.8 385.8C87.8 382.1 98.1 384.2 105 391L144 430L231 343C240.4 333.6 255.6 333.6 264.9 343L296.9 375C306.3 384.4 306.3 399.6 296.9 408.9L209.9 495.9L248.9 534.9C255.8 541.8 257.8 552.1 254.1 561.1C250.4 570.1 241.7 576 232 576z",viewBox:"0 0 640 640"},chevronLeft:{path:"M9.4 233.4c-12.5 12.5-12.5 32.8 0 45.3l192 192c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256 246.6 86.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0l-192 192z",viewBox:"0 0 320 512"},chevronRight:{path:"M310.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-192 192c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L242.7 256 73.4 86.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l192 192z",viewBox:"0 0 320 512"},squarePlus:{path:"M64 32C28.7 32 0 60.7 0 96L0 416c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64L64 32zM200 344l0-64-64 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l64 0 0-64c0-13.3 10.7-24 24-24s24 10.7 24 24l0 64 64 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-64 0 0 64c0 13.3-10.7 24-24 24s-24-10.7-24-24z",viewBox:"0 0 448 512"},image:{path:"M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM323.8 202.5c-4.5-6.6-11.9-10.5-19.8-10.5s-15.4 3.9-19.8 10.5l-87 127.6L170.7 297c-4.6-5.7-11.5-9-18.7-9s-14.2 3.3-18.7 9l-64 80c-5.8 7.2-6.9 17.1-2.9 25.4s12.4 13.6 21.6 13.6l96 0 32 0 208 0c8.9 0 17.1-4.9 21.2-12.8s3.6-17.4-1.4-24.7l-120-176zM112 192a48 48 0 1 0 0-96 48 48 0 1 0 0 96z",viewBox:"0 0 512 512"},globe:{path:"M352 256c0 22.2-1.2 43.6-3.3 64l-185.3 0c-2.2-20.4-3.3-41.8-3.3-64s1.2-43.6 3.3-64l185.3 0c2.2 20.4 3.3 41.8 3.3 64zm28.8-64l123.1 0c5.3 20.5 8.1 41.9 8.1 64s-2.8 43.5-8.1 64l-123.1 0c2.1-20.6 3.2-42 3.2-64s-1.1-43.4-3.2-64zm112.6-32l-116.7 0c-10-63.9-29.8-117.4-55.3-151.6c78.3 20.7 142 77.5 171.9 151.6zm-149.1 0l-176.6 0c6.1-36.4 15.5-68.6 27-94.7c10.5-23.6 22.2-40.7 33.5-51.5C239.4 3.2 248.7 0 256 0s16.6 3.2 27.8 13.8c11.3 10.8 23 27.9 33.5 51.5c11.6 26 20.9 58.2 27 94.7zm-209 0L18.6 160C48.6 85.9 112.2 29.1 190.6 8.4C165.1 42.6 145.3 96.1 135.3 160zM8.1 192l123.1 0c-2.1 20.6-3.2 42-3.2 64s1.1 43.4 3.2 64L8.1 320C2.8 299.5 0 278.1 0 256s2.8-43.5 8.1-64zM194.7 446.6c-11.6-26-20.9-58.2-27-94.6l176.6 0c-6.1 36.4-15.5 68.6-27 94.6c-10.5 23.6-22.2 40.7-33.5 51.5C272.6 508.8 263.3 512 256 512s-16.6-3.2-27.8-13.8c-11.3-10.8-23-27.9-33.5-51.5zM135.3 352c10 63.9 29.8 117.4 55.3 151.6C112.2 482.9 48.6 426.1 18.6 352l116.7 0zm358.1 0c-30 74.1-93.6 130.9-171.9 151.6c25.5-34.2 45.2-87.7 55.3-151.6l116.7 0z",viewBox:"0 0 512 512"},youtube:{path:"M549.7 124.1c-6.3-23.7-24.8-42.3-48.3-48.6C458.8 64 288 64 288 64S117.2 64 74.6 75.5c-23.5 6.3-42 24.9-48.3 48.6-11.4 42.9-11.4 132.3-11.4 132.3s0 89.4 11.4 132.3c6.3 23.7 24.8 41.5 48.3 47.8C117.2 448 288 448 288 448s170.8 0 213.4-11.5c23.5-6.3 42-24.2 48.3-47.8 11.4-42.9 11.4-132.3 11.4-132.3s0-89.4-11.4-132.3zm-317.5 213.5V175.2l142.7 81.2-142.7 81.2z",viewBox:"0 0 576 512"},video:{path:"M0 128C0 92.7 28.7 64 64 64l256 0c35.3 0 64 28.7 64 64l0 256c0 35.3-28.7 64-64 64L64 448c-35.3 0-64-28.7-64-64L0 128zM559.1 99.8c10.4 5.6 16.9 16.4 16.9 28.2l0 256c0 11.8-6.5 22.6-16.9 28.2s-23 5-32.9-1.6l-96-64L416 337.1l0-17.1 0-128 0-17.1 14.2-9.5 96-64c9.8-6.5 22.4-7.2 32.9-1.6z",viewBox:"0 0 576 512"},file:{path:"M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 288c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128z",viewBox:"0 0 384 512"},fileSpreadsheet:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM88 224l208 0c17.7 0 32 14.3 32 32l0 16 0 80 0 64c0 17.7-14.3 32-32 32l-64 0-80 0-64 0c-17.7 0-32-14.3-32-32l0-64 0-80 0-16c0-17.7 14.3-32 32-32zm0 112l48 0 0-48-48 0 0 48zm80 0l48 0 0-48-48 0 0 48zm80 0l48 0 0-48-48 0 0 48zm0 32l0 48 48 0 0-48-48 0zm-32 0l-48 0 0 48 48 0 0-48zm-80 0l-48 0 0 48 48 0 0-48z",viewBox:"0 0 384 512"},cursor:{path:"M320 0c35.3 0 64 28.7 64 64l0 384c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64L0 64C0 28.7 28.7 0 64 0L320 0z",viewBox:"0 0 384 512"},molecule:{path:"M480 64C497.7 64 512 78.3 512 96C512 153.8 487.6 200.8 454.6 240.5C430.5 269.4 400.8 295.6 371 320C400.8 344.5 430.5 370.6 454.6 399.5C487.6 439.1 512 486.2 512 544C512 561.7 497.7 576 480 576C462.3 576 448 561.7 448 544L192 544C192 561.7 177.7 576 160 576C142.3 576 128 561.7 128 544C128 486.2 152.4 439.2 185.4 399.5C209.5 370.6 239.2 344.5 269 320C239.2 295.5 209.5 269.4 185.4 240.5C152.4 200.8 128 153.8 128 96C128 78.3 142.3 64 160 64C177.7 64 192 78.3 192 96L448 96C448 78.3 462.3 64 480 64zM411.5 448L228.6 448C220.4 458.5 213.5 469.1 208 480L432.2 480C426.6 469.1 419.7 458.5 411.6 448zM366 400C351.7 387 336.2 374.2 320 361C303.8 374.1 288.3 387 274 400L366 400zM228.5 192L411.4 192C419.6 181.5 426.5 170.9 432 160L207.9 160C213.5 170.9 220.4 181.5 228.5 192zM274 240C288.3 253 303.8 265.8 320 279C336.2 265.9 351.7 253 366 240L274 240z",viewBox:"0 0 640 640"},minus:{path:"M432 256c0 17.7-14.3 32-32 32L48 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l352 0c17.7 0 32 14.3 32 32z",viewBox:"0 0 448 512"},terminal:{path:"M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zm102.3 55.8c-9 9.8-8.3 25 1.5 33.9L180.5 256l-76.7 70.3c-9.8 9-10.4 24.1-1.5 33.9s24.1 10.4 33.9 1.5l96-88c5-4.5 7.8-11 7.8-17.7s-2.8-13.1-7.8-17.7l-96-88c-9.8-9-25-8.3-33.9 1.5zM248 336c-13.3 0-24 10.7-24 24s10.7 24 24 24l144 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-144 0z",viewBox:"0 0 512 512"},search:{path:"M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352a144 144 0 1 0 0-288 144 144 0 1 0 0 288z",viewBox:"0 0 512 512"},chart:{path:"M160 80c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 352c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-352zM0 272c0-26.5 21.5-48 48-48l32 0c26.5 0 48 21.5 48 48l0 160c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48L0 272zM368 96l32 0c26.5 0 48 21.5 48 48l0 288c0 26.5-21.5 48-48 48l-32 0c-26.5 0-48-21.5-48-48l0-288c0-26.5 21.5-48 48-48z",viewBox:"0 0 448 512"},code:{path:"M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z",viewBox:"0 0 640 512"},pen:{path:"M416.9 85.2L372 130.1L509.9 268L554.8 223.1C568.4 209.6 576 191.2 576 172C576 152.8 568.4 134.4 554.8 120.9L519.1 85.2C505.6 71.6 487.2 64 468 64C448.8 64 430.4 71.6 416.9 85.2zM338.1 164L122.9 379.1C112.2 389.8 104.4 403.2 100.3 417.8L64.9 545.6C62.6 553.9 64.9 562.9 71.1 569C77.3 575.1 86.2 577.5 94.5 575.2L222.3 539.7C236.9 535.6 250.2 527.9 261 517.1L476 301.9L338.1 164z",viewBox:"0 0 640 640"},openWindow:{path:"M352 0c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9L370.7 96 201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L416 141.3l41.4 41.4c9.2 9.2 22.9 11.9 34.9 6.9s19.8-16.6 19.8-29.6l0-128c0-17.7-14.3-32-32-32L352 0zM80 32C35.8 32 0 67.8 0 112L0 432c0 44.2 35.8 80 80 80l320 0c44.2 0 80-35.8 80-80l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 112c0 8.8-7.2 16-16 16L80 448c-8.8 0-16-7.2-16-16l0-320c0-8.8 7.2-16 16-16l112 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 32z",viewBox:"0 0 512 512"},upload:{path:"M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128l-368 0zm79-217c-9.4 9.4-9.4 24.6 0 33.9s24.6 9.4 33.9 0l39-39L296 392c0 13.3 10.7 24 24 24s24-10.7 24-24l0-134.1 39 39c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-80-80c-9.4-9.4-24.6-9.4-33.9 0l-80 80z",viewBox:"0 0 640 512"},filePDF:{path:"M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 144-208 0c-35.3 0-64 28.7-64 64l0 144-48 0c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128zM176 352l32 0c30.9 0 56 25.1 56 56s-25.1 56-56 56l-16 0 0 32c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-48 0-80c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24l-16 0 0 48 16 0zm96-80l32 0c26.5 0 48 21.5 48 48l0 64c0 26.5-21.5 48-48 48l-32 0c-8.8 0-16-7.2-16-16l0-128c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16l0-64c0-8.8-7.2-16-16-16l-16 0 0 96 16 0zm80-112c0-8.8 7.2-16 16-16l48 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 32 32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 48c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-64 0-64z",viewBox:"0 0 512 512"},fileWord:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM111 257.1l26.8 89.2 31.6-90.3c3.4-9.6 12.5-16.1 22.7-16.1s19.3 6.4 22.7 16.1l31.6 90.3L273 257.1c3.8-12.7 17.2-19.9 29.9-16.1s19.9 17.2 16.1 29.9l-48 160c-3 10-12 16.9-22.4 17.1s-19.8-6.2-23.2-16.1L192 336.6l-33.3 95.3c-3.4 9.8-12.8 16.3-23.2 16.1s-19.5-7.1-22.4-17.1l-48-160c-3.8-12.7 3.4-26.1 16.1-29.9s26.1 3.4 29.9 16.1z",viewBox:"0 0 384 512"},success:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z",viewBox:"0 0 512 512"},error:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24l0 112c0 13.3-10.7 24-24 24s-24-10.7-24-24l0-112c0-13.3 10.7-24 24-24zM224 352a32 32 0 1 1 64 0 32 32 0 1 1 -64 0z",viewBox:"0 0 512 512"},warning:{path:"M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480L40 480c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24l0 112c0 13.3 10.7 24 24 24s24-10.7 24-24l0-112c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z",viewBox:"0 0 512 512"},info:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM216 336l24 0 0-64-24 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l48 0c13.3 0 24 10.7 24 24l0 88 8 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-80 0c-13.3 0-24-10.7-24-24s10.7-24 24-24zm40-208a32 32 0 1 1 0 64 32 32 0 1 1 0-64z",viewBox:"0 0 512 512"},userCircle:{path:"M399 384.2C376.9 345.8 335.4 320 288 320l-64 0c-47.4 0-88.9 25.8-111 64.2c35.2 39.2 86.2 63.8 143 63.8s107.8-24.7 143-63.8zM0 256a256 256 0 1 1 512 0A256 256 0 1 1 0 256zm256 16a72 72 0 1 0 0-144 72 72 0 1 0 0 144z",viewBox:"0 0 512 512"},users:{path:"M144 0a80 80 0 1 1 0 160A80 80 0 1 1 144 0zM512 0a80 80 0 1 1 0 160A80 80 0 1 1 512 0zM0 298.7C0 239.8 47.8 192 106.7 192l42.7 0c15.9 0 31 3.5 44.6 9.7c-1.3 7.2-1.9 14.7-1.9 22.3c0 38.2 16.8 72.5 43.3 96c-.2 0-.4 0-.7 0L21.3 320C9.6 320 0 310.4 0 298.7zM405.3 320c-.2 0-.4 0-.7 0c26.6-23.5 43.3-57.8 43.3-96c0-7.6-.7-15-1.9-22.3c13.6-6.3 28.7-9.7 44.6-9.7l42.7 0C592.2 192 640 239.8 640 298.7c0 11.8-9.6 21.3-21.3 21.3l-213.3 0zM224 224a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zM128 485.3C128 411.7 187.7 352 261.3 352l117.3 0C452.3 352 512 411.7 512 485.3c0 14.7-11.9 26.7-26.7 26.7l-330.7 0c-14.7 0-26.7-11.9-26.7-26.7z",viewBox:"0 0 640 512"},user:{path:"M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512l388.6 0c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304l-91.4 0z",viewBox:"0 0 448 512"},check:{path:"M438.6 105.4c12.5 12.5 12.5 32.8 0 45.3l-256 256c-12.5 12.5-32.8 12.5-45.3 0l-128-128c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0L160 338.7 393.4 105.4c12.5-12.5 32.8-12.5 45.3 0z",viewBox:"0 0 448 512"},buildings:{path:"M256 0c-35.3 0-64 28.7-64 64l0 64L64 128c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l192 0 192 0c35.3 0 64-28.7 64-64l0-256 0-128c0-35.3-28.7-64-64-64L256 0zM64 304c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32zm208 16c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0zm112-16l0-32c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16zM80 192l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16zM256 80c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32zM400 64l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16zM256 208l0-32c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16zm144 16c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-32 0z",viewBox:"0 0 512 512"},receipt:{path:"M14 2.2C22.5-1.7 32.5-.3 39.6 5.8L80 40.4 120.4 5.8c9-7.7 22.3-7.7 31.2 0L192 40.4 232.4 5.8c9-7.7 22.3-7.7 31.2 0L304 40.4 344.4 5.8c7.1-6.1 17.1-7.5 25.6-3.6s14 12.4 14 21.8l0 464c0 9.4-5.5 17.9-14 21.8s-18.5 2.5-25.6-3.6L304 471.6l-40.4 34.6c-9 7.7-22.3 7.7-31.2 0L192 471.6l-40.4 34.6c-9 7.7-22.3 7.7-31.2 0L80 471.6 39.6 506.2c-7.1 6.1-17.1 7.5-25.6 3.6S0 497.4 0 488L0 24C0 14.6 5.5 6.1 14 2.2zM96 144c-8.8 0-16 7.2-16 16s7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 144zM80 352c0 8.8 7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 336c-8.8 0-16 7.2-16 16zM96 240c-8.8 0-16 7.2-16 16s7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 240z",viewBox:"0 0 384 512"},chatSkillMenu:{path:"M8 256a56 56 0 1 1 112 0A56 56 0 1 1 8 256zm160 0a56 56 0 1 1 112 0 56 56 0 1 1 -112 0zm216-56a56 56 0 1 1 0 112 56 56 0 1 1 0-112z",viewBox:"0 0 448 512"},coin:{path:"M256 352C114.6 352 0 287.5 0 208S114.6 64 256 64s256 64.5 256 144s-114.6 144-256 144zM86.6 248.2c12 11.4 27.7 20.1 44.4 26.8c33.6 13.4 77.8 21 125 21s91.4-7.6 125-21c16.7-6.7 32.4-15.4 44.4-26.8C437.5 236.7 448 220.5 448 200s-10.5-36.7-22.6-48.2c-12-11.4-27.7-20.1-44.4-26.8c-33.6-13.4-77.8-21-125-21s-91.4 7.6-125 21c-16.7 6.7-32.4 15.4-44.4 26.8C74.5 163.3 64 179.5 64 200s10.5 36.7 22.6 48.2zM96 200c0-35.3 71.6-64 160-64s160 28.7 160 64s-71.6 64-160 64s-160-28.7-160-64zM0 290.1c13.2 15.6 29.7 29.3 48 40.9l0 63.7C17.8 373.6 0 347.9 0 320l0-29.9zM80 413l0-64.7c28.4 13.2 60.9 23 96 29l0 64.3c-36.2-6-68.9-15.9-96-28.7zm128 32.8l0-64.1c15.7 1.6 31.7 2.4 48 2.4s32.3-.8 48-2.4l0 64.1c-15.5 1.5-31.6 2.2-48 2.2s-32.5-.8-48-2.2zm128-4.1l0-64.3c35.1-6 67.6-15.9 96-29l0 64.7c-27.1 12.8-59.8 22.7-96 28.7zm128-47l0-63.7c18.3-11.5 34.8-25.2 48-40.9l0 29.9c0 27.9-17.8 53.6-48 74.6z",viewBox:"0 0 512 512"},cog:{path:"M495.9 166.6c3.2 8.7 .5 18.4-6.4 24.6l-43.3 39.4c1.1 8.3 1.7 16.8 1.7 25.4s-.6 17.1-1.7 25.4l43.3 39.4c6.9 6.2 9.6 15.9 6.4 24.6c-4.4 11.9-9.7 23.3-15.8 34.3l-4.7 8.1c-6.6 11-14 21.4-22.1 31.2c-5.9 7.2-15.7 9.6-24.5 6.8l-55.7-17.7c-13.4 10.3-28.2 18.9-44 25.4l-12.5 57.1c-2 9.1-9 16.3-18.2 17.8c-13.8 2.3-28 3.5-42.5 3.5s-28.7-1.2-42.5-3.5c-9.2-1.5-16.2-8.7-18.2-17.8l-12.5-57.1c-15.8-6.5-30.6-15.1-44-25.4L83.1 425.9c-8.8 2.8-18.6 .3-24.5-6.8c-8.1-9.8-15.5-20.2-22.1-31.2l-4.7-8.1c-6.1-11-11.4-22.4-15.8-34.3c-3.2-8.7-.5-18.4 6.4-24.6l43.3-39.4C64.6 273.1 64 264.6 64 256s.6-17.1 1.7-25.4L22.4 191.2c-6.9-6.2-9.6-15.9-6.4-24.6c4.4-11.9 9.7-23.3 15.8-34.3l4.7-8.1c6.6-11 14-21.4 22.1-31.2c5.9-7.2 15.7-9.6 24.5-6.8l55.7 17.7c13.4-10.3 28.2-18.9 44-25.4l12.5-57.1c2-9.1 9-16.3 18.2-17.8C227.3 1.2 241.5 0 256 0s28.7 1.2 42.5 3.5c9.2 1.5 16.2 8.7 18.2 17.8l12.5 57.1c15.8 6.5 30.6 15.1 44 25.4l55.7-17.7c8.8-2.8 18.6-.3 24.5 6.8c8.1 9.8 15.5 20.2 22.1 31.2l4.7 8.1c6.1 11 11.4 22.4 15.8 34.3zM256 336a80 80 0 1 0 0-160 80 80 0 1 0 0 160z",viewBox:"0 0 512 512"},sliders:{path:"M0 416c0 17.7 14.3 32 32 32l54.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 448c17.7 0 32-14.3 32-32s-14.3-32-32-32l-246.7 0c-12.3-28.3-40.5-48-73.3-48s-61 19.7-73.3 48L32 384c-17.7 0-32 14.3-32 32zm128 0a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zM320 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm32-80c-32.8 0-61 19.7-73.3 48L32 224c-17.7 0-32 14.3-32 32s14.3 32 32 32l246.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48l54.7 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-54.7 0c-12.3-28.3-40.5-48-73.3-48zM192 128a32 32 0 1 1 0-64 32 32 0 1 1 0 64zm73.3-64C253 35.7 224.8 16 192 16s-61 19.7-73.3 48L32 64C14.3 64 0 78.3 0 96s14.3 32 32 32l86.7 0c12.3 28.3 40.5 48 73.3 48s61-19.7 73.3-48L480 128c17.7 0 32-14.3 32-32s-14.3-32-32-32L265.3 64z",viewBox:"0 0 512 512"},crown:{path:"M309 106c11.4-7 19-19.7 19-34c0-22.1-17.9-40-40-40s-40 17.9-40 40c0 14.4 7.6 27 19 34L209.7 220.6c-9.1 18.2-32.7 23.4-48.6 10.7L72 160c5-6.7 8-15 8-24c0-22.1-17.9-40-40-40S0 113.9 0 136s17.9 40 40 40c.2 0 .5 0 .7 0L86.4 427.4c5.5 30.4 32 52.6 63 52.6l277.2 0c30.9 0 57.4-22.1 63-52.6L535.3 176c.2 0 .5 0 .7 0c22.1 0 40-17.9 40-40s-17.9-40-40-40s-40 17.9-40 40c0 9 3 17.3 8 24l-89.1 71.3c-15.9 12.7-39.5 7.5-48.6-10.7L309 106z",viewBox:"0 0 576 512"},paintbrushPencil:{path:"M559.6 95.6c21.9-21.9 21.9-57.3 0-79.2s-57.3-21.9-79.2 0L227.7 269.1l79.2 79.2L559.6 95.6zM205 291.8c-9.3-2.5-19-3.8-29-3.8c-61.9 0-112 50.1-112 112c0 3.9 .2 7.8 .6 11.6C66.4 429.1 54.4 448 36.8 448L32 448c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0c61.9 0 112-50.1 112-112c0-10-1.3-19.8-3.8-29l.1-.1-79.2-79.2-.1 .1zm93.4-138.7L164.7 19.3c-25-25-65.5-25-90.5 0L50.7 42.7c-25 25-25 65.5 0 90.5L173.5 256c.8 0 1.7 0 2.5 0c6.2 0 12.4 .4 18.4 1.2L298.5 153.1zM320 402.5l64.6 64.6c6.7 6.7 15.1 11.6 24.2 14.2l104 29.7c8.4 2.4 17.4 .1 23.6-6.1s8.5-15.2 6.1-23.6l-29.7-104c-2.6-9.2-7.5-17.5-14.2-24.2l-75.6-75.6L318.8 381.6c.8 6 1.2 12.2 1.2 18.4c0 .8 0 1.7 0 2.5z",viewBox:"0 0 576 512"},star:{path:"M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z",viewBox:"0 0 576 512"},starOutline:{path:"M287.9 0c9.2 0 17.6 5.2 21.6 13.5l68.6 141.3 153.2 22.6c9 1.3 16.5 7.6 19.3 16.3s.5 18.1-5.9 24.5L433.6 328.4l26.2 155.6c1.5 9-2.2 18.1-9.7 23.5s-17.3 6-25.3 1.7l-137-73.2L151 509.1c-8.1 4.3-17.9 3.7-25.3-1.7s-11.2-14.5-9.7-23.5l26.2-155.6L31.1 218.2c-6.5-6.4-8.7-15.9-5.9-24.5s10.3-14.9 19.3-16.3l153.2-22.6L266.3 13.5C270.4 5.2 278.7 0 287.9 0zm0 79L235.4 187.2c-3.5 7.1-10.2 12.1-18.1 13.3L99 217.9 184.9 303c5.5 5.5 8.1 13.3 6.8 21L171.4 443.7l105.2-56.2c7.1-3.8 15.6-3.8 22.6 0l105.2 56.2L384.2 324.1c-1.3-7.7 1.2-15.5 6.8-21l85.9-85.1L358.6 200.5c-7.8-1.2-14.6-6.1-18.1-13.3L287.9 79z",viewBox:"0 0 576 512"},rightFromBracket:{path:"M377.9 105.9L500.7 228.7c7.2 7.2 11.3 17.1 11.3 27.3s-4.1 20.1-11.3 27.3L377.9 406.1c-6.4 6.4-15 9.9-24 9.9c-18.7 0-33.9-15.2-33.9-33.9l0-62.1-128 0c-17.7 0-32-14.3-32-32l0-64c0-17.7 14.3-32 32-32l128 0 0-62.1c0-18.7 15.2-33.9 33.9-33.9c9 0 17.6 3.6 24 9.9zM160 96L96 96c-17.7 0-32 14.3-32 32l0 256c0 17.7 14.3 32 32 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-64 0c-53 0-96-43-96-96L0 128C0 75 43 32 96 32l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32z",viewBox:"0 0 512 512"},store:{path:"M547.6 103.8L490.3 13.1C485.2 5 476.1 0 466.4 0L109.6 0C99.9 0 90.8 5 85.7 13.1L28.3 103.8c-29.6 46.8-3.4 111.9 51.9 119.4c4 .5 8.1 .8 12.1 .8c26.1 0 49.3-11.4 65.2-29c15.9 17.6 39.1 29 65.2 29c26.1 0 49.3-11.4 65.2-29c15.9 17.6 39.1 29 65.2 29c26.2 0 49.3-11.4 65.2-29c16 17.6 39.1 29 65.2 29c4.1 0 8.1-.3 12.1-.8c55.5-7.4 81.8-72.5 52.1-119.4zM499.7 254.9c0 0 0 0-.1 0c-5.3 .7-10.7 1.1-16.2 1.1c-12.4 0-24.3-1.9-35.4-5.3L448 384l-320 0 0-133.4c-11.2 3.5-23.2 5.4-35.6 5.4c-5.5 0-11-.4-16.3-1.1l-.1 0c-4.1-.6-8.1-1.3-12-2.3L64 384l0 64c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-64 0-131.4c-4 1-8 1.8-12.3 2.3z",viewBox:"0 0 576 512"},squareSmall:{path:"M0 160c0-35.3 28.7-64 64-64H256c35.3 0 64 28.7 64 64V352c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V160z",viewBox:"0 0 320 512"},commentQuestion:{path:"M0 64C0 28.7 28.7 0 64 0L448 0c35.3 0 64 28.7 64 64l0 288c0 35.3-28.7 64-64 64l-138.7 0L185.6 508.8c-4.8 3.6-11.3 4.2-16.8 1.5s-8.8-8.2-8.8-14.3l0-80-96 0c-35.3 0-64-28.7-64-64L0 64zm169.8 53.3l-.4 1.2c-4.4 12.5 2.1 26.2 14.6 30.6s26.2-2.1 30.6-14.6l.4-1.2c1.1-3.2 4.2-5.3 7.5-5.3l58.3 0c8.4 0 15.1 6.8 15.1 15.1c0 5.4-2.9 10.4-7.6 13.1l-44.3 25.4c-7.5 4.3-12.1 12.2-12.1 20.8l0 13.5c0 13.3 10.7 24 24 24c13.1 0 23.8-10.5 24-23.6l32.3-18.5c19.6-11.3 31.7-32.2 31.7-54.8c0-34.9-28.3-63.1-63.1-63.1l-58.3 0c-23.7 0-44.8 14.9-52.8 37.3zM288 304a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z",viewBox:"0 0 512 512"},filter:{path:"M3.9 54.9C10.5 40.9 24.5 32 40 32l432 0c15.5 0 29.5 8.9 36.1 22.9s4.6 30.5-5.2 42.5L320 320.9 320 448c0 12.1-6.8 23.2-17.7 28.6s-23.8 4.3-33.5-3l-64-48c-8.1-6-12.8-15.5-12.8-25.6l0-79.1L9 97.3C-.7 85.4-2.8 68.8 3.9 54.9z",viewBox:"0 0 512 512"},folder:{path:"M64 480H448c35.3 0 64-28.7 64-64V160c0-35.3-28.7-64-64-64H288c-10.1 0-19.6-4.7-25.6-12.8L243.2 57.6C231.1 41.5 212.1 32 192 32H64C28.7 32 0 60.7 0 96V416c0 35.3 28.7 64 64 64z",viewBox:"0 0 512 512"},tableList:{path:"M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zm64 0l0 64 64 0 0-64L64 96zm384 0L192 96l0 64 256 0 0-64zM64 224l0 64 64 0 0-64-64 0zm384 0l-256 0 0 64 256 0 0-64zM64 352l0 64 64 0 0-64-64 0zm384 0l-256 0 0 64 256 0 0-64z",viewBox:"0 0 512 512"},grid2:{path:"M224 80c0-26.5-21.5-48-48-48L80 32C53.5 32 32 53.5 32 80l0 96c0 26.5 21.5 48 48 48l96 0c26.5 0 48-21.5 48-48l0-96zm0 256c0-26.5-21.5-48-48-48l-96 0c-26.5 0-48 21.5-48 48l0 96c0 26.5 21.5 48 48 48l96 0c26.5 0 48-21.5 48-48l0-96zM288 80l0 96c0 26.5 21.5 48 48 48l96 0c26.5 0 48-21.5 48-48l0-96c0-26.5-21.5-48-48-48l-96 0c-26.5 0-48 21.5-48 48zM480 336c0-26.5-21.5-48-48-48l-96 0c-26.5 0-48 21.5-48 48l0 96c0 26.5 21.5 48 48 48l96 0c26.5 0 48-21.5 48-48l0-96z",viewBox:"0 0 512 512"},carotUp:{path:"M182.6 137.4c-12.5-12.5-32.8-12.5-45.3 0l-128 128c-9.2 9.2-11.9 22.9-6.9 34.9s16.6 19.8 29.6 19.8l256 0c12.9 0 24.6-7.8 29.6-19.8s2.2-25.7-6.9-34.9l-128-128z",viewBox:"0 0 320 512"},carotDown:{path:"M137.4 374.6c12.5 12.5 32.8 12.5 45.3 0l128-128c9.2-9.2 11.9-22.9 6.9-34.9s-16.6-19.8-29.6-19.8L32 192c-12.9 0-24.6 7.8-29.6 19.8s-2.2 25.7 6.9 34.9l128 128z",viewBox:"0 0 320 512"},comment:{path:"M512 240c0 114.9-114.6 208-256 208c-37.1 0-72.3-6.4-104.1-17.9c-11.9 8.7-31.3 20.6-54.3 30.6C73.6 471.1 44.7 480 16 480c-6.5 0-12.3-3.9-14.8-9.9c-2.5-6-1.1-12.8 3.4-17.4c0 0 0 0 0 0s0 0 0 0s0 0 0 0c0 0 0 0 0 0l.3-.3c.3-.3 .7-.7 1.3-1.4c1.1-1.2 2.8-3.1 4.9-5.7c4.1-5 9.6-12.4 15.2-21.6c10-16.6 19.5-38.4 21.4-62.9C17.7 326.8 0 285.1 0 240C0 125.1 114.6 32 256 32s256 93.1 256 208z",viewBox:"0 0 512 512"},layerGroup:{path:"M264.5 5.2c14.9-6.9 32.1-6.9 47 0l218.6 101c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 149.8C37.4 145.8 32 137.3 32 128s5.4-17.9 13.9-21.8L264.5 5.2zM476.9 209.6l53.2 24.6c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 277.8C37.4 273.8 32 265.3 32 256s5.4-17.9 13.9-21.8l53.2-24.6 152 70.2c23.4 10.8 50.4 10.8 73.8 0l152-70.2zm-152 198.2l152-70.2 53.2 24.6c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 405.8C37.4 401.8 32 393.3 32 384s5.4-17.9 13.9-21.8l53.2-24.6 152 70.2c23.4 10.8 50.4 10.8 73.8 0z",viewBox:"0 0 576 512"},ellipsisVertical:{path:"M64 360a56 56 0 1 0 0 112 56 56 0 1 0 0-112zm0-160a56 56 0 1 0 0 112 56 56 0 1 0 0-112zM120 96A56 56 0 1 0 8 96a56 56 0 1 0 112 0z",viewBox:"0 0 128 512"},folderOpen:{path:"M88.7 223.8L0 375.8 0 96C0 60.7 28.7 32 64 32l117.5 0c17 0 33.3 6.7 45.3 18.7l26.5 26.5c12 12 28.3 18.7 45.3 18.7L416 96c35.3 0 64 28.7 64 64l0 32-336 0c-22.8 0-43.8 12.1-55.3 31.8zm27.6 16.1C122.1 230 132.6 224 144 224l400 0c11.5 0 22 6.1 27.7 16.1s5.7 22.2-.1 32.1l-112 192C453.9 474 443.4 480 432 480L32 480c-11.5 0-22-6.1-27.7-16.1s-5.7-22.2 .1-32.1l112-192z",viewBox:"0 0 576 512"},creditCard:{path:"M64 32C28.7 32 0 60.7 0 96l0 32 576 0 0-32c0-35.3-28.7-64-64-64L64 32zM576 224L0 224 0 416c0 35.3 28.7 64 64 64l448 0c35.3 0 64-28.7 64-64l0-192zM112 352l64 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-64 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zm112 16c0-8.8 7.2-16 16-16l128 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-128 0c-8.8 0-16-7.2-16-16z",viewBox:"0 0 576 512"},sparkles:{path:"M327.5 85.2c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L384 128l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L448 128l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L448 64 426.8 7.5C425.1 3 420.8 0 416 0s-9.1 3-10.8 7.5L384 64 327.5 85.2zM205.1 73.3c-2.6-5.7-8.3-9.3-14.5-9.3s-11.9 3.6-14.5 9.3L123.3 187.3 9.3 240C3.6 242.6 0 248.3 0 254.6s3.6 11.9 9.3 14.5l114.1 52.7L176 435.8c2.6 5.7 8.3 9.3 14.5 9.3s11.9-3.6 14.5-9.3l52.7-114.1 114.1-52.7c5.7-2.6 9.3-8.3 9.3-14.5s-3.6-11.9-9.3-14.5L257.8 187.4 205.1 73.3zM384 384l-56.5 21.2c-4.5 1.7-7.5 6-7.5 10.8s3 9.1 7.5 10.8L384 448l21.2 56.5c1.7 4.5 6 7.5 10.8 7.5s9.1-3 10.8-7.5L448 448l56.5-21.2c4.5-1.7 7.5-6 7.5-10.8s-3-9.1-7.5-10.8L448 384l-21.2-56.5c-1.7-4.5-6-7.5-10.8-7.5s-9.1 3-10.8 7.5L384 384z",viewBox:"0 0 512 512"},lightbulbOn:{path:"M69.3 4l48 32c11 7.4 14 22.3 6.7 33.3s-22.3 14-33.3 6.7l-48-32c-11-7.4-14-22.3-6.7-33.3S58.3-3.3 69.3 4zM597.3 44l-48 32c-11 7.4-25.9 4.4-33.3-6.7s-4.4-25.9 6.7-33.3l48-32c11-7.4 25.9-4.4 33.3 6.7s4.4 25.9-6.7 33.3zM24 160l64 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-64 0c-13.3 0-24-10.7-24-24s10.7-24 24-24zm528 0l64 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-64 0c-13.3 0-24-10.7-24-24s10.7-24 24-24zM117.3 332l-48 32c-11 7.4-25.9 4.4-33.3-6.7s-4.4-25.9 6.7-33.3l48-32c11-7.4 25.9-4.4 33.3 6.7s4.4 25.9-6.7 33.3zm432-39.9l48 32c11 7.4 14 22.3 6.7 33.3s-22.3 14-33.3 6.7l-48-32c-11-7.4-14-22.3-6.7-33.3s22.3-14 33.3-6.7zm-100.1 5.7c-19.8 27.1-39.7 54.4-49.2 86.2l-160 0c-9.6-31.9-29.5-59.1-49.2-86.2c0 0 0 0 0 0s0 0 0 0c-5.2-7.1-10.4-14.2-15.4-21.4C155.6 247.9 144 213.3 144 176C144 78.8 222.8 0 320 0s176 78.8 176 176c0 37.3-11.6 71.9-31.4 100.3c-5 7.2-10.2 14.3-15.4 21.4c0 0 0 0 0 0s0 0 0 0zM400 432c0 44.2-35.8 80-80 80s-80-35.8-80-80l0-16 160 0 0 16zM320 96c8.8 0 16-7.2 16-16s-7.2-16-16-16c-61.9 0-112 50.1-112 112c0 8.8 7.2 16 16 16s16-7.2 16-16c0-44.2 35.8-80 80-80z",viewBox:"0 0 640 512"},paintbrush:{path:"M339.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L568.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S517.7-4.4 499.1 9.6L262.4 187.2c-24 18-38.2 46.1-38.4 76.1L339.3 367.1zm-19.6 25.4l-116-104.4C143.9 290.3 96 339.6 96 400c0 3.9 .2 7.8 .6 11.6C98.4 429.1 86.4 448 68.8 448L64 448c-17.7 0-32 14.3-32 32s14.3 32 32 32l144 0c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z",viewBox:"0 0 576 512"},shareAlt:{path:"M352 224c53 0 96-43 96-96s-43-96-96-96s-96 43-96 96c0 4 .2 8 .7 11.9l-94.1 47C145.4 170.2 121.9 160 96 160c-53 0-96 43-96 96s43 96 96 96c25.9 0 49.4-10.2 66.6-26.9l94.1 47c-.5 3.9-.7 7.8-.7 11.9c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-25.9 0-49.4 10.2-66.6 26.9l-94.1-47c.5-3.9 .7-7.8 .7-11.9s-.2-8-.7-11.9l94.1-47C302.6 213.8 326.1 224 352 224z",viewBox:"0 0 448 512"},diploma:{path:"M302 59.7l18 20.6 18-20.6C353.4 42.1 375.6 32 399 32l1 0c44.2 0 80 35.8 80 80c0 11.4-2.4 22.2-6.7 32l70.7 0 0 32c0-32 0-32 0-32s0 0 0 0l.1 0 .2 0 .5 0c.4 0 .8 0 1.4 .1c1 .1 2.3 .1 3.8 .3c3 .3 7 .9 11.6 2.1c9.2 2.3 21.3 6.9 33.4 15.9C620.9 181.7 640 216.2 640 272c0 47.5-13.7 81.1-32 104.1c-18 22.6-38.5 32.6-49 36.6c-7.3 2.8-14 3.3-19 3.3l-.5 0c-4.7 0-9.3-.5-13.9-1.5L384 383l0 81c0 6.2-3.6 11.9-9.2 14.5s-12.3 1.8-17-2.2L320 444.8l-37.8 31.5c-4.8 4-11.4 4.8-17 2.2s-9.2-8.3-9.2-14.5l0-81L114.4 414.5c-4.6 1-9.2 1.5-13.9 1.5l-.5 0c-4.9 0-11.7-.5-19-3.3c-10.5-4-31-14-49-36.6C13.7 353.1 0 319.5 0 272c0-55.8 19.1-90.3 44.8-109.6c12.1-9.1 24.3-13.6 33.4-15.9c4.6-1.2 8.6-1.8 11.6-2.1c1.5-.2 2.8-.3 3.8-.3c.5 0 1 0 1.4-.1l.5 0 .2 0 .1 0c0 0 0 0 0 0l0 32 0-32 70.7 0c-4.3-9.8-6.7-20.6-6.7-32c0-44.2 35.8-80 80-80l1 0c23.4 0 45.6 10.1 61 27.7zM240 144l54.4 0c6.9 0 10.5-8.1 6-13.3L265.9 91.3C259.6 84.1 250.5 80 241 80l-1 0c-17.7 0-32 14.3-32 32s14.3 32 32 32zm105.6 0l46.4 0 8 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-1 0c-1.2 0-2.3 .1-3.5 .2c-8.2 .9-15.8 4.8-21.3 11.1l-34.5 39.5c-4.5 5.2-.9 13.3 6 13.3zM256 208L96.7 208c0 0 0 0-.1 0c-.5 .1-1.5 .2-2.9 .5c-2.8 .7-6.7 2.1-10.6 5.1C76.9 218.3 64 231.8 64 272c0 34.5 9.6 53.7 18.1 64.3c7.2 9 14.9 13.5 19.2 15.6L256 317.4 256 208zM384 317.4l154.8 34.4c4.3-2 12-6.6 19.2-15.6c8.4-10.6 18.1-29.8 18.1-64.3c0-40.2-12.9-53.7-19.2-58.4c-3.9-2.9-7.7-4.4-10.6-5.1c-1.4-.3-2.4-.5-2.9-.5c0 0 0 0-.1 0L384 208l0 109.4zM540.1 352c0 0 0 0 0 0s0 0 0 0s0 0 0 0zM99.9 352l0 0s0 0 0 0z",viewBox:"0 0 640 512"},star:{path:"M316.9 18C311.6 7 300.4 0 288.1 0s-23.4 7-28.8 18L195 150.3 51.4 171.5c-12 1.8-22 10.2-25.7 21.7s-.7 24.2 7.9 32.7L137.8 329 113.2 474.7c-2 12 3 24.2 12.9 31.3s23 8 33.8 2.3l128.3-68.5 128.3 68.5c10.8 5.7 23.9 4.9 33.8-2.3s14.9-19.3 12.9-31.3L438.5 329 542.7 225.9c8.6-8.5 11.7-21.2 7.9-32.7s-13.7-19.9-25.7-21.7L381.2 150.3 316.9 18z",viewBox:"0 0 576 512"},comments:{path:"M208 352c114.9 0 208-78.8 208-176S322.9 0 208 0S0 78.8 0 176c0 38.6 14.7 74.3 39.6 103.4c-3.5 9.4-8.7 17.7-14.2 24.7c-4.8 6.2-9.7 11-13.3 14.3c-1.8 1.6-3.3 2.9-4.3 3.7c-.5 .4-.9 .7-1.1 .8l-.2 .2s0 0 0 0s0 0 0 0C1 327.2-1.4 334.4 .8 340.9S9.1 352 16 352c21.8 0 43.8-5.6 62.1-12.5c9.2-3.5 17.8-7.4 25.2-11.4C134.1 343.3 169.8 352 208 352zM448 176c0 112.3-99.1 196.9-216.5 207C255.8 457.4 336.4 512 432 512c38.2 0 73.9-8.7 104.7-23.9c7.5 4 16 7.9 25.2 11.4c18.3 6.9 40.3 12.5 62.1 12.5c6.9 0 13.1-4.5 15.2-11.1c2.1-6.6-.2-13.8-5.8-17.9c0 0 0 0 0 0s0 0 0 0l-.2-.2c-.2-.2-.6-.4-1.1-.8c-1-.8-2.5-2-4.3-3.7c-3.6-3.3-8.5-8.1-13.3-14.3c-5.5-7-10.7-15.4-14.2-24.7c24.9-29 39.6-64.7 39.6-103.4c0-92.8-84.9-168.9-192.6-175.5c.4 5.1 .6 10.3 .6 15.5z",viewBox:"0 0 640 512"},database:{path:"M448 80l0 48c0 44.2-100.3 80-224 80S0 172.2 0 128L0 80C0 35.8 100.3 0 224 0S448 35.8 448 80zM393.2 214.7c20.8-7.4 39.9-16.9 54.8-28.6L448 288c0 44.2-100.3 80-224 80S0 332.2 0 288L0 186.1c14.9 11.8 34 21.2 54.8 28.6C99.7 230.7 159.5 240 224 240s124.3-9.3 169.2-25.3zM0 346.1c14.9 11.8 34 21.2 54.8 28.6C99.7 390.7 159.5 400 224 400s124.3-9.3 169.2-25.3c20.8-7.4 39.9-16.9 54.8-28.6l0 85.9c0 44.2-100.3 80-224 80S0 476.2 0 432l0-85.9z",viewBox:"0 0 448 512"},puzzle:{path:"M192 104.8c0-9.2-5.8-17.3-13.2-22.8C167.2 73.3 160 61.3 160 48c0-26.5 28.7-48 64-48s64 21.5 64 48c0 13.3-7.2 25.3-18.8 34c-7.4 5.5-13.2 13.6-13.2 22.8c0 12.8 10.4 23.2 23.2 23.2l56.8 0c26.5 0 48 21.5 48 48l0 56.8c0 12.8 10.4 23.2 23.2 23.2c9.2 0 17.3-5.8 22.8-13.2c8.7-11.6 20.7-18.8 34-18.8c26.5 0 48 28.7 48 64s-21.5 64-48 64c-13.3 0-25.3-7.2-34-18.8c-5.5-7.4-13.6-13.2-22.8-13.2c-12.8 0-23.2 10.4-23.2 23.2L384 464c0 26.5-21.5 48-48 48l-56.8 0c-12.8 0-23.2-10.4-23.2-23.2c0-9.2 5.8-17.3 13.2-22.8c11.6-8.7 18.8-20.7 18.8-34c0-26.5-28.7-48-64-48s-64 21.5-64 48c0 13.3 7.2 25.3 18.8 34c7.4 5.5 13.2 13.6 13.2 22.8c0 12.8-10.4 23.2-23.2 23.2L48 512c-26.5 0-48-21.5-48-48L0 343.2C0 330.4 10.4 320 23.2 320c9.2 0 17.3 5.8 22.8 13.2C54.7 344.8 66.7 352 80 352c26.5 0 48-28.7 48-64s-21.5-64-48-64c-13.3 0-25.3 7.2-34 18.8C40.5 250.2 32.4 256 23.2 256C10.4 256 0 245.6 0 232.8L0 176c0-26.5 21.5-48 48-48l120.8 0c12.8 0 23.2-10.4 23.2-23.2z",viewBox:"0 0 512 512"},badgeCheck:{path:"M320 64C356.8 64 388.8 84.7 404.9 115.1C437.8 105 475 113 501 139C527 165 535 202.3 524.9 235.1C555.3 251.2 576 283.2 576 320C576 356.8 555.3 388.8 524.9 404.9C535 437.8 527 475 501 501C475 527 437.7 535 404.9 524.9C388.8 555.3 356.8 576 320 576C283.2 576 251.2 555.3 235.1 524.9C202.2 535 165 527 139 501C113 475 105 437.7 115.1 404.9C84.7 388.8 64 356.8 64 320C64 283.2 84.7 251.2 115.1 235.1C105 202.2 113 165 139 139C165 113 202.3 105 235.1 115.1C251.2 84.7 283.2 64 320 64zM404.4 260.7C411.4 249.5 408 234.7 396.8 227.6C385.6 220.5 370.8 224 363.7 235.2L302.3 333.5L275.3 297.5C267.3 286.9 252.3 284.7 241.7 292.7C231.1 300.7 228.9 315.7 236.9 326.3L284.9 390.3C289.6 396.6 297.2 400.2 305.1 399.9C313 399.6 320.2 395.4 324.4 388.6L404.4 260.6z",viewBox:"0 0 640 512"},lock:{path:"M144 144l0 48 160 0 0-48c0-44.2-35.8-80-80-80s-80 35.8-80 80zM80 192l0-48C80 64.5 144.5 0 224 0s144 64.5 144 144l0 48 16 0c35.3 0 64 28.7 64 64l0 192c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 256c0-35.3 28.7-64 64-64l16 0z",viewBox:"0 0 448 512"},unlock:{path:"M144 144c0-44.2 35.8-80 80-80c31.9 0 59.4 18.6 72.3 45.7c7.6 16 26.7 22.8 42.6 15.2s22.8-26.7 15.2-42.6C331 33.7 281.5 0 224 0C144.5 0 80 64.5 80 144l0 48-16 0c-35.3 0-64 28.7-64 64L0 448c0 35.3 28.7 64 64 64l320 0c35.3 0 64-28.7 64-64l0-192c0-35.3-28.7-64-64-64l-240 0 0-48z",viewBox:"0 0 448 512"},clock:{path:"M256 0a256 256 0 1 1 0 512A256 256 0 1 1 256 0zM232 120l0 136c0 8 4 15.5 10.7 20l96 64c11 7.4 25.9 4.4 33.3-6.7s4.4-25.9-6.7-33.3L280 243.2 280 120c0-13.3-10.7-24-24-24s-24 10.7-24 24z",viewBox:"0 0 512 512"},checkCircle:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM369 209L241 337c-9.4 9.4-24.6 9.4-33.9 0l-64-64c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l47 47L335 175c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9z",viewBox:"0 0 512 512"},alien:{path:"M96 48c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 16 48 0c8.8 0 16 7.2 16 16l0 48 128 0 0-48c0-8.8 7.2-16 16-16l48 0 0-16c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-48 0 0 32 0 32 48 0c8.8 0 16 7.2 16 16l0 48 32 0 0-80c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 128c0 8.8-7.2 16-16 16l-48 0 0 80c0 8.8-7.2 16-16 16l-48 0 0 80c0 8.8-7.2 16-16 16l-48 0-48 0c-8.8 0-16-7.2-16-16l0-32c0-8.8 7.2-16 16-16l48 0 0-32-192 0 0 32 48 0c8.8 0 16 7.2 16 16l0 32c0 8.8-7.2 16-16 16l-48 0-48 0c-8.8 0-16-7.2-16-16l0-80-48 0c-8.8 0-16-7.2-16-16l0-80-48 0c-8.8 0-16-7.2-16-16L0 144c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16l0 80 32 0 0-48c0-8.8 7.2-16 16-16l48 0 0-32 0-32-48 0c-8.8 0-16-7.2-16-16l0-32zm64 192l0 64c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-64c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16zm192 0l0 64c0 8.8 7.2 16 16 16l32 0c8.8 0 16-7.2 16-16l0-64c0-8.8-7.2-16-16-16l-32 0c-8.8 0-16 7.2-16 16z",viewBox:"0 0 576 512"},clipboardListCheck:{path:"M192 0c-41.8 0-77.4 26.7-90.5 64L64 64C28.7 64 0 92.7 0 128L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-320c0-35.3-28.7-64-64-64l-37.5 0C269.4 26.7 233.8 0 192 0zm0 64a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm-4.7 132.7c6.2 6.2 6.2 16.4 0 22.6l-64 64c-6.2 6.2-16.4 6.2-22.6 0l-32-32c-6.2-6.2-6.2-16.4 0-22.6s16.4-6.2 22.6 0L112 249.4l52.7-52.7c6.2-6.2 16.4-6.2 22.6 0zM192 272c0-8.8 7.2-16 16-16l96 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-96 0c-8.8 0-16-7.2-16-16zm-16 80l128 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-128 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zM72 368a24 24 0 1 1 48 0 24 24 0 1 1 -48 0z",viewBox:"0 0 384 512"},listCheck:{path:"M152.1 38.2c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 113C-2.3 103.6-2.3 88.4 7 79s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zm0 160c9.9 8.9 10.7 24 1.8 33.9l-72 80c-4.4 4.9-10.6 7.8-17.2 7.9s-12.9-2.4-17.6-7L7 273c-9.4-9.4-9.4-24.6 0-33.9s24.6-9.4 33.9 0l22.1 22.1 55.1-61.2c8.9-9.9 24-10.7 33.9-1.8zM224 96c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zm0 160c0-17.7 14.3-32 32-32l224 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-224 0c-17.7 0-32-14.3-32-32zM160 416c0-17.7 14.3-32 32-32l288 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-288 0c-17.7 0-32-14.3-32-32zM48 368a48 48 0 1 1 0 96 48 48 0 1 1 0-96z",viewBox:"0 0 512 512"},spiderWeb:{path:"M133.8 22.2c4.8-12.7 18-20.2 31.4-17.7l69 12.9c35.6 6.7 72.1 6.7 107.6 0l69-12.9c13.4-2.5 26.6 5 31.4 17.7l28.9 77.2c11.5 30.7 28.1 59.2 49.1 84.4l45.3 54.3c8.7 10.4 8.7 25.5 0 35.9l-45.3 54.3c-21 25.2-37.6 53.7-49.1 84.4l-28.9 77.2c-4.8 12.7-18 20.2-31.4 17.7l-69-12.9c-35.6-6.7-72.1-6.7-107.6 0l-69 12.9c-13.4 2.5-26.6-5-31.4-17.7l-28.9-77.2C93.3 382 76.7 353.4 55.7 328.2L10.5 273.9c-8.7-10.4-8.7-25.5 0-35.9l45.3-54.3c21-25.2 37.6-53.7 49.1-84.4l28.9-77.2zm33.3 70.6L157.3 119c-13.7 36.6-33.5 70.6-58.5 100.6L88.4 232l44.6 0c23.5-27.6 41.7-59.2 53.7-93.4l2.5-7L167.1 92.8zm42.1-23.1l21.4 37.4c37.7 9.5 77.2 9.5 114.9 0l21.4-37.4-14.7 2.8c-42.4 7.9-85.9 7.9-128.3 0l-14.7-2.8zM408.9 92.8l-22.2 38.8 2.5 7c12.1 34.2 30.3 65.8 53.8 93.4l44.6 0-10.3-12.4c-25-30-44.8-64-58.5-100.6l-9.8-26.2zM487.6 280L443 280c-23.6 28.1-41.8 60.4-53.6 95.3l-2.1 6.1 21.6 37.9 9.8-26.2c13.7-36.6 33.5-70.6 58.5-100.6L487.6 280zM366.8 442.3l-19.5-34.2c-37.9-11.7-78.3-12.8-116.7-3.2l-21.3 37.4 14.7-2.7c42.4-7.9 85.9-7.9 128.3 0l14.7 2.7zM167.1 419.2l22.2-38.8-2.5-7c-12.1-34.2-30.3-65.8-53.7-93.4l-44.6 0 10.3 12.4c25 30 44.8 64 58.5 100.6l9.8 26.2zM193.2 280c10.1 15 18.9 30.7 26.5 47.1L246.6 280l-53.4 0zm67.9 71.4c18.1-1.5 36.3-1.2 54.3 1L288 304.4l-26.9 47zm95.5-23.7c7.6-16.6 16.4-32.5 26.5-47.7l-53.8 0 27.3 47.7zM382.8 232c-10.1-15-18.9-30.7-26.5-47.1L329.4 232l53.4 0zm-68.1-71c-17.7 1.7-35.6 1.7-53.3 0L288 207.6 314.7 161zm-94.9 23.9c-7.6 16.4-16.5 32.1-26.5 47.1l53.4 0-26.9-47.1z",viewBox:"0 0 576 512"},computerClassic:{path:"M0 48C0 21.5 21.5 0 48 0L400 0c26.5 0 48 21.5 48 48l0 320c0 26.5-21.5 48-48 48L48 416c-26.5 0-48-21.5-48-48L0 48zM32 480l0-32 384 0 0 32c0 17.7-14.3 32-32 32L64 512c-17.7 0-32-14.3-32-32zM96 64C78.3 64 64 78.3 64 96l0 128c0 17.7 14.3 32 32 32l256 0c17.7 0 32-14.3 32-32l0-128c0-17.7-14.3-32-32-32L96 64zM80 360a24 24 0 1 0 0-48 24 24 0 1 0 0 48zm144-24c0 8.8 7.2 16 16 16l128 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-128 0c-8.8 0-16 7.2-16 16z",viewBox:"0 0 448 512"},browser:{path:"M0 96C0 60.7 28.7 32 64 32l384 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zm64 32a32 32 0 1 0 64 0 32 32 0 1 0 -64 0zm384 0c0-13.3-10.7-24-24-24l-240 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l240 0c13.3 0 24-10.7 24-24z",viewBox:"0 0 512 512"},rocket:{path:"M156.6 384.9L125.7 354c-8.5-8.5-11.5-20.8-7.7-32.2c3-8.9 7-20.5 11.8-33.8L24 288c-8.6 0-16.6-4.6-20.9-12.1s-4.2-16.7 .2-24.1l52.5-88.5c13-21.9 36.5-35.3 61.9-35.3l82.3 0c2.4-4 4.8-7.7 7.2-11.3C289.1-4.1 411.1-8.1 483.9 5.3c11.6 2.1 20.6 11.2 22.8 22.8c13.4 72.9 9.3 194.8-111.4 276.7c-3.5 2.4-7.3 4.8-11.3 7.2l0 82.3c0 25.4-13.4 49-35.3 61.9l-88.5 52.5c-7.4 4.4-16.6 4.5-24.1 .2s-12.1-12.2-12.1-20.9l0-107.2c-14.1 4.9-26.4 8.9-35.7 11.9c-11.2 3.6-23.4 .5-31.8-7.8zM384 168a40 40 0 1 0 0-80 40 40 0 1 0 0 80z",viewBox:"0 0 512 512"},presentation:{path:"M32 0C14.3 0 0 14.3 0 32S14.3 64 32 64l0 224c0 35.3 28.7 64 64 64l160 0 0 34.7-70.6 70.6c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L288 445.3l57.4 57.4c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L320 386.7l0-34.7 160 0c35.3 0 64-28.7 64-64l0-224c17.7 0 32-14.3 32-32s-14.3-32-32-32L512 0 64 0 32 0zM96 64l384 0 0 224-192 0L96 288 96 64z",viewBox:"0 0 576 512"},envelope:{path:"M48 64C21.5 64 0 85.5 0 112c0 15.1 7.1 29.3 19.2 38.4L236.8 313.6c11.4 8.5 27 8.5 38.4 0L492.8 150.4c12.1-9.1 19.2-23.3 19.2-38.4c0-26.5-21.5-48-48-48L48 64zM0 176L0 384c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-208L294.4 339.2c-22.8 17.1-54 17.1-76.8 0L0 176z",viewBox:"0 0 512 512"},eye:{path:"M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM144 256a144 144 0 1 1 288 0 144 144 0 1 1 -288 0zm144-64c0 35.3-28.7 64-64 64c-7.1 0-13.9-1.2-20.3-3.3c-5.5-1.8-11.9 1.6-11.7 7.4c.3 6.9 1.3 13.8 3.2 20.7c13.7 51.2 66.4 81.6 117.6 67.9s81.6-66.4 67.9-117.6c-11.1-41.5-47.8-69.4-88.6-71.1c-5.8-.2-9.2 6.1-7.4 11.7c2.1 6.4 3.3 13.2 3.3 20.3z",viewBox:"0 0 576 512"},fire:{path:"M159.3 5.4c7.8-7.3 19.9-7.2 27.7 .1c27.6 25.9 53.5 53.8 77.7 84c11-14.4 23.5-30.1 37-42.9c7.9-7.4 20.1-7.4 28 .1c34.6 33 63.9 76.6 84.5 118c20.3 40.8 33.8 82.5 33.8 111.9C448 404.2 348.2 512 224 512C98.4 512 0 404.1 0 276.5c0-38.4 17.8-85.3 45.4-131.7C73.3 97.7 112.7 48.6 159.3 5.4zM225.7 416c25.3 0 47.7-7 68.8-21c42.1-29.4 53.4-88.2 28.1-134.4c-4.5-9-16-9.6-22.5-2l-25.2 29.3c-6.6 7.6-18.5 7.4-24.7-.5c-16.5-21-46-58.5-62.8-79.8c-6.3-8-18.3-8.1-24.7-.1c-33.8 42.5-50.8 69.3-50.8 99.4C112 375.4 162.6 416 225.7 416z",viewBox:"0 0 448 512"},stack:{path:"M264.5 5.2c14.9-6.9 32.1-6.9 47 0l218.6 101c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 149.8C37.4 145.8 32 137.3 32 128s5.4-17.9 13.9-21.8L264.5 5.2zM476.9 209.6l53.2 24.6c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 277.8C37.4 273.8 32 265.3 32 256s5.4-17.9 13.9-21.8l53.2-24.6 152 70.2c23.4 10.8 50.4 10.8 73.8 0l152-70.2zm-152 198.2l152-70.2 53.2 24.6c8.5 3.9 13.9 12.4 13.9 21.8s-5.4 17.9-13.9 21.8l-218.6 101c-14.9 6.9-32.1 6.9-47 0L45.9 405.8C37.4 401.8 32 393.3 32 384s5.4-17.9 13.9-21.8l53.2-24.6 152 70.2c23.4 10.8 50.4 10.8 73.8 0z",viewBox:"0 0 576 512"},tag:{path:"M0 80L0 229.5c0 17 6.7 33.3 18.7 45.3l176 176c25 25 65.5 25 90.5 0L418.7 317.3c25-25 25-65.5 0-90.5l-176-176c-12-12-28.3-18.7-45.3-18.7L48 32C21.5 32 0 53.5 0 80zm112 32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z",viewBox:"0 0 448 512"},file:{path:"M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 288c0 35.3-28.7 64-64 64L64 512c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128z",viewBox:"0 0 384 512"},fileWord:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM111 257.1l26.8 89.2 31.6-90.3c3.4-9.6 12.5-16.1 22.7-16.1s19.3 6.4 22.7 16.1l31.6 90.3L273 257.1c3.8-12.7 17.2-19.9 29.9-16.1s19.9 17.2 16.1 29.9l-48 160c-3 10-12 16.9-22.4 17.1s-19.8-6.2-23.2-16.1L192 336.6l-33.3 95.3c-3.4 9.8-12.8 16.3-23.2 16.1s-19.5-7.1-22.4-17.1l-48-160c-3.8-12.7 3.4-26.1 16.1-29.9s26.1 3.4 29.9 16.1z",viewBox:"0 0 384 512"},fileSpreadsheet:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM88 224l208 0c17.7 0 32 14.3 32 32l0 16 0 80 0 64c0 17.7-14.3 32-32 32l-64 0-80 0-64 0c-17.7 0-32-14.3-32-32l0-64 0-80 0-16c0-17.7 14.3-32 32-32zm0 112l48 0 0-48-48 0 0 48zm80 0l48 0 0-48-48 0 0 48zm80 0l48 0 0-48-48 0 0 48zm0 32l0 48 48 0 0-48-48 0zm-32 0l-48 0 0 48 48 0 0-48zm-80 0l-48 0 0 48 48 0 0-48z",viewBox:"0 0 384 512"},filePDF:{path:"M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 144-208 0c-35.3 0-64 28.7-64 64l0 144-48 0c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128zM176 352l32 0c30.9 0 56 25.1 56 56s-25.1 56-56 56l-16 0 0 32c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-48 0-80c0-8.8 7.2-16 16-16zm32 80c13.3 0 24-10.7 24-24s-10.7-24-24-24l-16 0 0 48 16 0zm96-80l32 0c26.5 0 48 21.5 48 48l0 64c0 26.5-21.5 48-48 48l-32 0c-8.8 0-16-7.2-16-16l0-128c0-8.8 7.2-16 16-16zm32 128c8.8 0 16-7.2 16-16l0-64c0-8.8-7.2-16-16-16l-16 0 0 96 16 0zm80-112c0-8.8 7.2-16 16-16l48 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 32 32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0 0 48c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-64 0-64z",viewBox:"0 0 512 512"},fileZIP:{path:"M0 64C0 28.7 28.7 0 64 0L224 0l0 128c0 17.7 14.3 32 32 32l128 0 0 144-144 0c-35.3 0-64 28.7-64 64l0 144L64 512c-35.3 0-64-28.7-64-64L0 64zm384 64l-128 0L256 0 384 128zM240 352l64 0c5.5 0 10.7 2.9 13.6 7.6s3.2 10.6 .7 15.6L265.9 480l38.1 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-64 0c-5.5 0-10.7-2.9-13.6-7.6s-3.2-10.6-.7-15.6L278.1 384 240 384c-8.8 0-16-7.2-16-16s7.2-16 16-16zm144 16l0 128c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-128c0-8.8 7.2-16 16-16s16 7.2 16 16zm32 0c0-8.8 7.2-16 16-16l24 0c30.9 0 56 25.1 56 56s-25.1 56-56 56l-8 0 0 32c0 8.8-7.2 16-16 16s-16-7.2-16-16l0-48 0-80zm32 64l8 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-8 0 0 48z",viewBox:"0 0 512 512"},fileImage:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM64 256a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm152 32c5.3 0 10.2 2.6 13.2 6.9l88 128c3.4 4.9 3.7 11.3 1 16.5s-8.2 8.6-14.2 8.6l-88 0-40 0-48 0-48 0c-5.8 0-11.1-3.1-13.9-8.1s-2.8-11.2 .2-16.1l48-80c2.9-4.8 8.1-7.8 13.7-7.8s10.8 2.9 13.7 7.8l12.8 21.4 48.3-70.2c3-4.3 7.9-6.9 13.2-6.9z",viewBox:"0 0 384 512"},fileAudio:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zm2 226.3c37.1 22.4 62 63.1 62 109.7s-24.9 87.3-62 109.7c-7.6 4.6-17.4 2.1-22-5.4s-2.1-17.4 5.4-22C269.4 401.5 288 370.9 288 336s-18.6-65.5-46.5-82.3c-7.6-4.6-10-14.4-5.4-22s14.4-10 22-5.4zm-91.9 30.9c6 2.5 9.9 8.3 9.9 14.8l0 128c0 6.5-3.9 12.3-9.9 14.8s-12.9 1.1-17.4-3.5L113.4 376 80 376c-8.8 0-16-7.2-16-16l0-48c0-8.8 7.2-16 16-16l33.4 0 35.3-35.3c4.6-4.6 11.5-5.9 17.4-3.5zm51 34.9c6.6-5.9 16.7-5.3 22.6 1.3C249.8 304.6 256 319.6 256 336s-6.2 31.4-16.3 42.7c-5.9 6.6-16 7.1-22.6 1.3s-7.1-16-1.3-22.6c5.1-5.7 8.1-13.1 8.1-21.3s-3.1-15.7-8.1-21.3c-5.9-6.6-5.3-16.7 1.3-22.6z",viewBox:"0 0 384 512"},fileVideo:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM64 288c0-17.7 14.3-32 32-32l96 0c17.7 0 32 14.3 32 32l0 96c0 17.7-14.3 32-32 32l-96 0c-17.7 0-32-14.3-32-32l0-96zM300.9 397.9L256 368l0-64 44.9-29.9c2-1.3 4.4-2.1 6.8-2.1c6.8 0 12.3 5.5 12.3 12.3l0 103.4c0 6.8-5.5 12.3-12.3 12.3c-2.4 0-4.8-.7-6.8-2.1z",viewBox:"0 0 384 512"},fileZipper:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM96 48c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16zm0 64c0-8.8 7.2-16 16-16l32 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-32 0c-8.8 0-16-7.2-16-16zm-6.3 71.8c3.7-14 16.4-23.8 30.9-23.8l14.8 0c14.5 0 27.2 9.7 30.9 23.8l23.5 88.2c1.4 5.4 2.1 10.9 2.1 16.4c0 35.2-28.8 63.7-64 63.7s-64-28.5-64-63.7c0-5.5 .7-11.1 2.1-16.4l23.5-88.2zM112 336c-8.8 0-16 7.2-16 16s7.2 16 16 16l32 0c8.8 0 16-7.2 16-16s-7.2-16-16-16l-32 0z",viewBox:"0 0 384 512"},fileLines:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-288-128 0c-17.7 0-32-14.3-32-32L224 0 64 0zM256 0l0 128 128 0L256 0zM112 256l160 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-160 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64l160 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-160 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zm0 64l160 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-160 0c-8.8 0-16-7.2-16-16s7.2-16 16-16z",viewBox:"0 0 384 512"},plug:{path:"M96 0C78.3 0 64 14.3 64 32l0 96 64 0 0-96c0-17.7-14.3-32-32-32zM288 0c-17.7 0-32 14.3-32 32l0 96 64 0 0-96c0-17.7-14.3-32-32-32zM32 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l0 32c0 77.4 55 142 128 156.8l0 67.2c0 17.7 14.3 32 32 32s32-14.3 32-32l0-67.2C297 398 352 333.4 352 256l0-32c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 160z",viewBox:"0 0 384 512"},cloudDownload:{path:"M144 480C64.5 480 0 415.5 0 336c0-62.8 40.2-116.2 96.2-135.9c-.1-2.7-.2-5.4-.2-8.1c0-88.4 71.6-160 160-160c59.3 0 111 32.2 138.7 80.2C409.9 102 428.3 96 448 96c53 0 96 43 96 96c0 12.2-2.3 23.8-6.4 34.6C596 238.4 640 290.1 640 352c0 70.7-57.3 128-128 128l-368 0zm79-167l80 80c9.4 9.4 24.6 9.4 33.9 0l80-80c9.4-9.4 9.4-24.6 0-33.9s-24.6-9.4-33.9 0l-39 39L344 184c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 134.1-39-39c-9.4-9.4-24.6-9.4-33.9 0s-9.4 24.6 0 33.9z",viewBox:"0 0 640 512"},bold:{path:"M0 64C0 46.3 14.3 32 32 32l48 0 16 0 128 0c70.7 0 128 57.3 128 128c0 31.3-11.3 60.1-30 82.3c37.1 22.4 62 63.1 62 109.7c0 70.7-57.3 128-128 128L96 480l-16 0-48 0c-17.7 0-32-14.3-32-32s14.3-32 32-32l16 0 0-160L48 96 32 96C14.3 96 0 81.7 0 64zM224 224c35.3 0 64-28.7 64-64s-28.7-64-64-64L112 96l0 128 112 0zM112 288l0 128 144 0c35.3 0 64-28.7 64-64s-28.7-64-64-64l-32 0-112 0z",viewBox:"0 0 384 512"},italic:{path:"M128 64c0-17.7 14.3-32 32-32l192 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-58.7 0L160 416l64 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 480c-17.7 0-32-14.3-32-32s14.3-32 32-32l58.7 0L224 96l-64 0c-17.7 0-32-14.3-32-32z",viewBox:"0 0 384 512"},thumbtack:{path:"M32 32C32 14.3 46.3 0 64 0L320 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-29.5 0 11.4 148.2c36.7 19.9 65.7 53.2 79.5 94.7l1 3c3.3 9.8 1.6 20.5-4.4 28.8s-15.7 13.3-26 13.3L32 352c-10.3 0-19.9-4.9-26-13.3s-7.7-19.1-4.4-28.8l1-3c13.8-41.5 42.8-74.8 79.5-94.7L93.5 64 64 64C46.3 64 32 49.7 32 32zM160 384l64 0 0 96c0 17.7-14.3 32-32 32s-32-14.3-32-32l0-96z",viewBox:"0 0 384 512"},thumbtackSlash:{path:"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L481.4 352c9.8-.4 18.9-5.3 24.6-13.3c6-8.3 7.7-19.1 4.4-28.8l-1-3c-13.8-41.5-42.8-74.8-79.5-94.7L418.5 64 448 64c17.7 0 32-14.3 32-32s-14.3-32-32-32L192 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l29.5 0-6.1 79.5L38.8 5.1zM324.9 352L177.1 235.6c-20.9 18.9-37.2 43.3-46.5 71.3l-1 3c-3.3 9.8-1.6 20.5 4.4 28.8s15.7 13.3 26 13.3l164.9 0zM288 384l0 96c0 17.7 14.3 32 32 32s32-14.3 32-32l0-96-64 0z",viewBox:"0 0 640 512"},share:{path:"M307 34.8c-11.5 5.1-19 16.6-19 29.2l0 64-112 0C78.8 128 0 206.8 0 304C0 417.3 81.5 467.9 100.2 478.1c2.5 1.4 5.3 1.9 8.1 1.9c10.9 0 19.7-8.9 19.7-19.7c0-7.5-4.3-14.4-9.8-19.5C108.8 431.9 96 414.4 96 384c0-53 43-96 96-96l96 0 0 64c0 12.6 7.4 24.1 19 29.2s25 3 34.4-5.4l160-144c6.7-6.1 10.6-14.7 10.6-23.8s-3.8-17.7-10.6-23.8l-160-144c-9.4-8.5-22.9-10.6-34.4-5.4z",viewBox:"0 0 512 512"},lightSwitch:{path:"M64 0C28.7 0 0 28.7 0 64L0 448c0 35.3 28.7 64 64 64l256 0c35.3 0 64-28.7 64-64l0-384c0-35.3-28.7-64-64-64L64 0zm96 96l64 0c35.3 0 64 28.7 64 64l0 80L96 240l0-80c0-35.3 28.7-64 64-64zM288 272l0 80c0 35.3-28.7 64-64 64l-64 0c-35.3 0-64-28.7-64-64l0-80 192 0zM192 32a16 16 0 1 1 0 32 16 16 0 1 1 0-32zm0 416a16 16 0 1 1 0 32 16 16 0 1 1 0-32z",viewBox:"0 0 384 512"},moon:{path:"M223.5 32C100 32 0 132.3 0 256S100 480 223.5 480c60.6 0 115.5-24.2 155.8-63.4c5-4.9 6.3-12.5 3.1-18.7s-10.1-9.7-17-8.5c-9.8 1.7-19.8 2.6-30.1 2.6c-96.9 0-175.5-78.8-175.5-176c0-65.8 36-123.1 89.3-153.3c6.1-3.5 9.2-10.5 7.7-17.3s-7.3-11.9-14.3-12.5c-6.3-.5-12.6-.8-19-.8z",viewBox:"0 0 384 512"},sun:{path:"M361.5 1.2c5 2.1 8.6 6.6 9.6 11.9L391 121l107.9 19.8c5.3 1 9.8 4.6 11.9 9.6s1.5 10.7-1.6 15.2L446.9 256l62.3 90.3c3.1 4.5 3.7 10.2 1.6 15.2s-6.6 8.6-11.9 9.6L391 391 371.1 498.9c-1 5.3-4.6 9.8-9.6 11.9s-10.7 1.5-15.2-1.6L256 446.9l-90.3 62.3c-4.5 3.1-10.2 3.7-15.2 1.6s-8.6-6.6-9.6-11.9L121 391 13.1 371.1c-5.3-1-9.8-4.6-11.9-9.6s-1.5-10.7 1.6-15.2L65.1 256 2.8 165.7c-3.1-4.5-3.7-10.2-1.6-15.2s6.6-8.6 11.9-9.6L121 121 140.9 13.1c1-5.3 4.6-9.8 9.6-11.9s10.7-1.5 15.2 1.6L256 65.1 346.3 2.8c4.5-3.1 10.2-3.7 15.2-1.6zM160 256a96 96 0 1 1 192 0 96 96 0 1 1 -192 0zm224 0a128 128 0 1 0 -256 0 128 128 0 1 0 256 0z",viewBox:"0 0 512 512"},clearStack:{path:"M288 0c-8.5 0-17 1.7-24.8 5.1L53.9 94.8C40.6 100.5 32 113.5 32 128s8.6 27.5 21.9 33.2l209.3 89.7c7.8 3.4 16.3 5.1 24.8 5.1s17-1.7 24.8-5.1l209.3-89.7c13.3-5.7 21.9-18.8 21.9-33.2s-8.6-27.5-21.9-33.2L312.8 5.1C305 1.7 296.5 0 288 0zm-5.9 49.2C284 48.4 286 48 288 48s4 .4 5.9 1.2L477.7 128 293.9 206.8c-1.9 .8-3.9 1.2-5.9 1.2s-4-.4-5.9-1.2L98.3 128 282.1 49.2zM53.9 222.8C40.6 228.5 32 241.5 32 256s8.6 27.5 21.9 33.2l209.3 89.7c7.8 3.4 16.3 5.1 24.8 5.1s17-1.7 24.8-5.1l209.3-89.7c13.3-5.7 21.9-18.8 21.9-33.2s-8.6-27.5-21.9-33.2l-31.2-13.4L430 235.5 477.7 256 293.9 334.8c-1.9 .8-3.9 1.2-5.9 1.2s-4-.4-5.9-1.2L98.3 256 146 235.5 85.1 209.4 53.9 222.8zm0 128C40.6 356.5 32 369.5 32 384s8.6 27.5 21.9 33.2l209.3 89.7c7.8 3.4 16.3 5.1 24.8 5.1s17-1.7 24.8-5.1l209.3-89.7c13.3-5.7 21.9-18.8 21.9-33.2s-8.6-27.5-21.9-33.2l-31.2-13.4L430 363.5 477.7 384 293.9 462.8c-1.9 .8-3.9 1.2-5.9 1.2s-4-.4-5.9-1.2L98.3 384 146 363.5 85.1 337.4 53.9 350.8z",viewBox:"0 0 576 512"},play:{path:"M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80L0 432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z",viewBox:"0 0 384 512"},toolbox:{path:"M176 88l0 40 160 0 0-40c0-4.4-3.6-8-8-8L184 80c-4.4 0-8 3.6-8 8zm-48 40l0-40c0-30.9 25.1-56 56-56l144 0c30.9 0 56 25.1 56 56l0 40 28.1 0c12.7 0 24.9 5.1 33.9 14.1l51.9 51.9c9 9 14.1 21.2 14.1 33.9l0 92.1-128 0 0-32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 32-128 0 0-32c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 32L0 320l0-92.1c0-12.7 5.1-24.9 14.1-33.9l51.9-51.9c9-9 21.2-14.1 33.9-14.1l28.1 0zM0 416l0-64 128 0c0 17.7 14.3 32 32 32s32-14.3 32-32l128 0c0 17.7 14.3 32 32 32s32-14.3 32-32l128 0 0 64c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64z",viewBox:"0 0 512 512"},pause:{path:"M48 64C21.5 64 0 85.5 0 112L0 400c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48L48 64zm192 0c-26.5 0-48 21.5-48 48l0 288c0 26.5 21.5 48 48 48l32 0c26.5 0 48-21.5 48-48l0-288c0-26.5-21.5-48-48-48l-32 0z",viewBox:"0 0 320 512"},fork:{path:"M80 104a24 24 0 1 0 0-48 24 24 0 1 0 0 48zm80-24c0 32.8-19.7 61-48 73.3l0 38.7c0 17.7 14.3 32 32 32l160 0c17.7 0 32-14.3 32-32l0-38.7C307.7 141 288 112.8 288 80c0-44.2 35.8-80 80-80s80 35.8 80 80c0 32.8-19.7 61-48 73.3l0 38.7c0 53-43 96-96 96l-48 0 0 70.7c28.3 12.3 48 40.5 48 73.3c0 44.2-35.8 80-80 80s-80-35.8-80-80c0-32.8 19.7-61 48-73.3l0-70.7-48 0c-53 0-96-43-96-96l0-38.7C19.7 141 0 112.8 0 80C0 35.8 35.8 0 80 0s80 35.8 80 80zm208 24a24 24 0 1 0 0-48 24 24 0 1 0 0 48zM248 432a24 24 0 1 0 -48 0 24 24 0 1 0 48 0z",viewBox:"0 0 448 512"},split:{path:"M403.8 34.4c12-5 25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64c-9.2 9.2-22.9 11.9-34.9 6.9s-19.8-16.6-19.8-29.6l0-32-37.5 0c-8.5 0-16.6 3.4-22.6 9.4L237.3 256l86.6 86.6c6 6 14.1 9.4 22.6 9.4l37.5 0 0-32c0-12.9 7.8-24.6 19.8-29.6s25.7-2.2 34.9 6.9l64 64c6 6 9.4 14.1 9.4 22.6s-3.4 16.6-9.4 22.6l-64 64c-9.2 9.2-22.9 11.9-34.9 6.9s-19.8-16.6-19.8-29.6l0-32-37.5 0c-25.5 0-49.9-10.1-67.9-28.1L178.7 288 32 288c-17.7 0-32-14.3-32-32s14.3-32 32-32l146.7 0 99.9-99.9c18-18 42.4-28.1 67.9-28.1L384 96l0-32c0-12.9 7.8-24.6 19.8-29.6z",viewBox:"0 0 512 512"},arrowUpRightFromSquare:{path:"M320 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l82.7 0L201.4 265.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L448 109.3l0 82.7c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160c0-17.7-14.3-32-32-32L320 0zM80 32C35.8 32 0 67.8 0 112L0 432c0 44.2 35.8 80 80 80l320 0c44.2 0 80-35.8 80-80l0-112c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 112c0 8.8-7.2 16-16 16L80 448c-8.8 0-16-7.2-16-16l0-320c0-8.8 7.2-16 16-16l112 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L80 32z",viewBox:"0 0 512 512"},rectangleList:{path:"M0 96C0 60.7 28.7 32 64 32l448 0c35.3 0 64 28.7 64 64l0 320c0 35.3-28.7 64-64 64L64 480c-35.3 0-64-28.7-64-64L0 96zM128 288a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm32-128a32 32 0 1 0 -64 0 32 32 0 1 0 64 0zM128 384a32 32 0 1 0 0-64 32 32 0 1 0 0 64zm96-248c-13.3 0-24 10.7-24 24s10.7 24 24 24l224 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-224 0zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24l224 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-224 0zm0 96c-13.3 0-24 10.7-24 24s10.7 24 24 24l224 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-224 0z",viewBox:"0 0 576 512"},lineColumns:{path:"M224 64c0-17.7-14.3-32-32-32L32 32C14.3 32 0 46.3 0 64S14.3 96 32 96l160 0c17.7 0 32-14.3 32-32zm0 128c0-17.7-14.3-32-32-32L32 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0c17.7 0 32-14.3 32-32zM0 320c0 17.7 14.3 32 32 32l160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L32 288c-17.7 0-32 14.3-32 32zM224 448c0-17.7-14.3-32-32-32L32 416c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0c17.7 0 32-14.3 32-32zM288 64c0 17.7 14.3 32 32 32l160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L320 32c-17.7 0-32 14.3-32 32zM512 192c0-17.7-14.3-32-32-32l-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0c17.7 0 32-14.3 32-32zM288 320c0 17.7 14.3 32 32 32l160 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-160 0c-17.7 0-32 14.3-32 32zM512 448c0-17.7-14.3-32-32-32l-160 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l160 0c17.7 0 32-14.3 32-32z",viewBox:"0 0 512 512"},commentLines:{path:"M256 448c141.4 0 256-93.1 256-208S397.4 32 256 32S0 125.1 0 240c0 45.1 17.7 86.8 47.7 120.9c-1.9 24.5-11.4 46.3-21.4 62.9c-5.5 9.2-11.1 16.6-15.2 21.6c-2.1 2.5-3.7 4.4-4.9 5.7c-.6 .6-1 1.1-1.3 1.4l-.3 .3c0 0 0 0 0 0c0 0 0 0 0 0s0 0 0 0s0 0 0 0c-4.6 4.6-5.9 11.4-3.4 17.4c2.5 6 8.3 9.9 14.8 9.9c28.7 0 57.6-8.9 81.6-19.3c22.9-10 42.4-21.9 54.3-30.6c31.8 11.5 67 17.9 104.1 17.9zM152 176l208 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-208 0c-13.3 0-24-10.7-24-24s10.7-24 24-24zm0 96l112 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-112 0c-13.3 0-24-10.7-24-24s10.7-24 24-24z",viewBox:"0 0 512 512"},h1:{path:"M64 96c0-17.7-14.3-32-32-32S0 78.3 0 96L0 256 0 416c0 17.7 14.3 32 32 32s32-14.3 32-32l0-128 192 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 0-160c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 128L64 224 64 96zm448 0c0-11.1-5.7-21.4-15.2-27.2s-21.2-6.4-31.1-1.4l-64 32c-15.8 7.9-22.2 27.1-14.3 42.9s27.1 22.2 42.9 14.3l17.7-8.8L448 384l-32 0c-17.7 0-32 14.3-32 32s14.3 32 32 32l64 0 64 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-32 0 0-288z",viewBox:"0 0 576 512"},h2:{path:"M64 96c0-17.7-14.3-32-32-32S0 78.3 0 96L0 256 0 416c0 17.7 14.3 32 32 32s32-14.3 32-32l0-128 192 0 0 128c0 17.7 14.3 32 32 32s32-14.3 32-32l0-160 0-160c0-17.7-14.3-32-32-32s-32 14.3-32 32l0 128L64 224 64 96zm385.9 47.4c11.6-9.9 26.4-15.4 41.7-15.4l4.5 0c35.3 0 64 28.7 64 64l0 5.8c0 17.9-7.5 35.1-20.8 47.2L378.4 392.4c-9.7 8.9-13 22.9-8.2 35.2S386.8 448 400 448l208 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-125.7 0 100.2-91.9c26.4-24.2 41.5-58.5 41.5-94.4l0-5.8c0-70.7-57.3-128-128-128l-4.5 0c-30.6 0-60.1 10.9-83.3 30.8l-29 24.9c-13.4 11.5-15 31.7-3.5 45.1s31.7 15 45.1 3.5l29-24.9z",viewBox:"0 0 640 512"},list:{path:"M40 48C26.7 48 16 58.7 16 72l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24L40 48zM192 64c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32L192 64zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0zm0 160c-17.7 0-32 14.3-32 32s14.3 32 32 32l288 0c17.7 0 32-14.3 32-32s-14.3-32-32-32l-288 0zM16 232l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0c-13.3 0-24 10.7-24 24zM40 368c-13.3 0-24 10.7-24 24l0 48c0 13.3 10.7 24 24 24l48 0c13.3 0 24-10.7 24-24l0-48c0-13.3-10.7-24-24-24l-48 0z",viewBox:"0 0 512 512"},fontCase:{path:"M206 52.8C201.3 40.3 189.3 32 176 32s-25.3 8.3-30 20.8L2 436.8c-6.2 16.5 2.2 35 18.7 41.2s35-2.2 41.2-18.7L96.2 368l159.6 0L290 459.2c6.2 16.5 24.7 24.9 41.2 18.7s24.9-24.6 18.7-41.2L206 52.8zM231.8 304l-111.6 0L176 155.1 231.8 304zM608 160c-13 0-24.1 7.7-29.2 18.8C559.4 166.9 536.5 160 512 160c-70.7 0-128 57.3-128 128l0 64c0 70.7 57.3 128 128 128c24.5 0 47.4-6.9 66.8-18.8c5 11.1 16.2 18.8 29.2 18.8c17.7 0 32-14.3 32-32l0-96 0-64 0-96c0-17.7-14.3-32-32-32zM576 288l0 64c0 35.3-28.7 64-64 64s-64-28.7-64-64l0-64c0-35.3 28.7-64 64-64s64 28.7 64 64z",viewBox:"0 0 640 512"},numberedList:{path:"M24 56c0-13.3 10.7-24 24-24l32 0c13.3 0 24 10.7 24 24l0 120 16 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-80 0c-13.3 0-24-10.7-24-24s10.7-24 24-24l16 0 0-96-8 0C34.7 80 24 69.3 24 56zM86.7 341.2c-6.5-7.4-18.3-6.9-24 1.2L51.5 357.9c-7.7 10.8-22.7 13.3-33.5 5.6s-13.3-22.7-5.6-33.5l11.1-15.6c23.7-33.2 72.3-35.6 99.2-4.9c21.3 24.4 20.8 60.9-1.1 84.7L86.8 432l33.2 0c13.3 0 24 10.7 24 24s-10.7 24-24 24l-88 0c-9.5 0-18.2-5.6-22-14.4s-2.1-18.9 4.3-25.9l72-78c5.3-5.8 5.4-14.6 .3-20.5zM224 64l256 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-256 0c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 160l256 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-256 0c-17.7 0-32-14.3-32-32s14.3-32 32-32zm0 160l256 0c17.7 0 32 14.3 32 32s-14.3 32-32 32l-256 0c-17.7 0-32-14.3-32-32s14.3-32 32-32z",viewBox:"0 0 512 512"},creditCard:{path:"M64 32C28.7 32 0 60.7 0 96l0 32 576 0 0-32c0-35.3-28.7-64-64-64L64 32zM576 224L0 224 0 416c0 35.3 28.7 64 64 64l448 0c35.3 0 64-28.7 64-64l0-192zM112 352l64 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-64 0c-8.8 0-16-7.2-16-16s7.2-16 16-16zm112 16c0-8.8 7.2-16 16-16l128 0c8.8 0 16 7.2 16 16s-7.2 16-16 16l-128 0c-8.8 0-16-7.2-16-16z",viewBox:"0 0 576 512"},receipt:{path:"M14 2.2C22.5-1.7 32.5-.3 39.6 5.8L80 40.4 120.4 5.8c9-7.7 22.3-7.7 31.2 0L192 40.4 232.4 5.8c9-7.7 22.3-7.7 31.2 0L304 40.4 344.4 5.8c7.1-6.1 17.1-7.5 25.6-3.6s14 12.4 14 21.8l0 464c0 9.4-5.5 17.9-14 21.8s-18.5 2.5-25.6-3.6L304 471.6l-40.4 34.6c-9 7.7-22.3 7.7-31.2 0L192 471.6l-40.4 34.6c-9 7.7-22.3 7.7-31.2 0L80 471.6 39.6 506.2c-7.1 6.1-17.1 7.5-25.6 3.6S0 497.4 0 488L0 24C0 14.6 5.5 6.1 14 2.2zM96 144c-8.8 0-16 7.2-16 16s7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 144zM80 352c0 8.8 7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 336c-8.8 0-16 7.2-16 16zM96 240c-8.8 0-16 7.2-16 16s7.2 16 16 16l192 0c8.8 0 16-7.2 16-16s-7.2-16-16-16L96 240z",viewBox:"0 0 384 512"},camera:{path:"M149.1 64.8L138.7 96 64 96C28.7 96 0 124.7 0 160L0 416c0 35.3 28.7 64 64 64l384 0c35.3 0 64-28.7 64-64l0-256c0-35.3-28.7-64-64-64l-74.7 0L362.9 64.8C356.4 45.2 338.1 32 317.4 32L194.6 32c-20.7 0-39 13.2-45.5 32.8zM256 192a96 96 0 1 1 0 192 96 96 0 1 1 0-192z",viewBox:"0 0 512 512"},minimize:{path:"M456 224l-144 0c-13.3 0-24-10.7-24-24l0-144c0-9.7 5.8-18.5 14.8-22.2s19.3-1.7 26.2 5.2l40 40L442.3 5.7C446 2 450.9 0 456 0s10 2 13.7 5.7l36.7 36.7C510 46 512 50.9 512 56s-2 10-5.7 13.7L433 143l40 40c6.9 6.9 8.9 17.2 5.2 26.2s-12.5 14.8-22.2 14.8zm0 64c9.7 0 18.5 5.8 22.2 14.8s1.7 19.3-5.2 26.2l-40 40 73.4 73.4c3.6 3.6 5.7 8.5 5.7 13.7s-2 10-5.7 13.7l-36.7 36.7C466 510 461.1 512 456 512s-10-2-13.7-5.7L369 433l-40 40c-6.9 6.9-17.2 8.9-26.2 5.2s-14.8-12.5-14.8-22.2l0-144c0-13.3 10.7-24 24-24l144 0zm-256 0c13.3 0 24 10.7 24 24l0 144c0 9.7-5.8 18.5-14.8 22.2s-19.3 1.7-26.2-5.2l-40-40L69.7 506.3C66 510 61.1 512 56 512s-10-2-13.7-5.7L5.7 469.7C2 466 0 461.1 0 456s2-10 5.7-13.7L79 369 39 329c-6.9-6.9-8.9-17.2-5.2-26.2s12.5-14.8 22.2-14.8l144 0zM56 224c-9.7 0-18.5-5.8-22.2-14.8s-1.7-19.3 5.2-26.2l40-40L5.7 69.7C2 66 0 61.1 0 56s2-10 5.7-13.7L42.3 5.7C46 2 50.9 0 56 0s10 2 13.7 5.7L143 79l40-40c6.9-6.9 17.2-8.9 26.2-5.2s14.8 12.5 14.8 22.2l0 144c0 13.3-10.7 24-24 24L56 224z",viewBox:"0 0 512 512"},microphone:{path:"M192 0C139 0 96 43 96 96l0 160c0 53 43 96 96 96s96-43 96-96l0-160c0-53-43-96-96-96zM64 216c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 89.1 66.2 162.7 152 174.4l0 33.6-48 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l72 0 72 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-48 0 0-33.6c85.8-11.7 152-85.3 152-174.4l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 70.7-57.3 128-128 128s-128-57.3-128-128l0-40z",viewBox:"0 0 384 512"},microphoneSlash:{path:"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L472.1 344.7c15.2-26 23.9-56.3 23.9-88.7l0-40c0-13.3-10.7-24-24-24s-24 10.7-24 24l0 40c0 21.2-5.1 41.1-14.2 58.7L416 300.8 416 96c0-53-43-96-96-96s-96 43-96 96l0 54.3L38.8 5.1zM344 430.4c20.4-2.8 39.7-9.1 57.3-18.2l-43.1-33.9C346.1 382 333.3 384 320 384c-70.7 0-128-57.3-128-128l0-8.7L144.7 210c-.5 1.9-.7 3.9-.7 6l0 40c0 89.1 66.2 162.7 152 174.4l0 33.6-48 0c-13.3 0-24 10.7-24 24s10.7 24 24 24l72 0 72 0c13.3 0 24-10.7 24-24s-10.7-24-24-24l-48 0 0-33.6z",viewBox:"0 0 640 512"},circlePhoneHangup:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM391.4 310c-5.3 8.6-16.8 12.3-26.7 8.5l-46.2-17.6c-8.7-3.3-14.1-11.6-13.1-20.3l2.9-26.7c-33.8-10.8-70.8-10.8-104.6 0l2.9 26.7c.9 8.7-4.4 16.9-13.1 20.3l-46.2 17.6c-9.9 3.8-21.4 .2-26.7-8.5L98.8 274.8c-4.8-7.8-3.4-17.5 3.4-23.8c84.9-78.6 222.6-78.6 307.5 0c6.8 6.3 8.2 16.1 3.4 23.8L391.4 310z",viewBox:"0 0 512 512"},circleEllipsis:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zM160 224a32 32 0 1 1 0 64 32 32 0 1 1 0-64zm64 32a32 32 0 1 1 64 0 32 32 0 1 1 -64 0zm128-32a32 32 0 1 1 0 64 32 32 0 1 1 0-64z",viewBox:"0 0 512 512"},circleCheveronLeft:{path:"M512 256A256 256 0 1 0 0 256a256 256 0 1 0 512 0zM271 135c9.4-9.4 24.6-9.4 33.9 0s9.4 24.6 0 33.9l-87 87 87 87c9.4 9.4 9.4 24.6 0 33.9s-24.6 9.4-33.9 0L167 273c-9.4-9.4-9.4-24.6 0-33.9L271 135z",viewBox:"0 0 512 512"},usersSlash:{path:"M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L440.6 320l178.1 0c11.8 0 21.3-9.6 21.3-21.3C640 239.8 592.2 192 533.3 192l-42.7 0c-15.9 0-31 3.5-44.6 9.7c1.3 7.2 1.9 14.7 1.9 22.3c0 30.2-10.5 58-28 79.9l-25.2-19.7C408.1 267.7 416 246.8 416 224c0-53-43-96-96-96c-31.1 0-58.7 14.8-76.3 37.7l-40.6-31.8c13-14.2 20.9-33.1 20.9-53.9c0-44.2-35.8-80-80-80C116.3 0 91.9 14.1 77.5 35.5L38.8 5.1zM106.7 192C47.8 192 0 239.8 0 298.7C0 310.4 9.6 320 21.3 320l213.3 0c.2 0 .4 0 .7 0c-20.6-18.2-35.2-42.8-40.8-70.8L121.8 192l-15.2 0zM261.3 352C187.7 352 128 411.7 128 485.3c0 14.7 11.9 26.7 26.7 26.7l330.7 0c10.5 0 19.5-6 23.9-14.8L324.9 352l-63.6 0zM512 160A80 80 0 1 0 512 0a80 80 0 1 0 0 160z",viewBox:"0 0 640 512"},triangleExclamation:{path:"M256 32c14.2 0 27.3 7.5 34.5 19.8l216 368c7.3 12.4 7.3 27.7 .2 40.1S486.3 480 472 480L40 480c-14.3 0-27.6-7.7-34.7-20.1s-7-27.8 .2-40.1l216-368C228.7 39.5 241.8 32 256 32zm0 128c-13.3 0-24 10.7-24 24l0 112c0 13.3 10.7 24 24 24s24-10.7 24-24l0-112c0-13.3-10.7-24-24-24zm32 224a32 32 0 1 0 -64 0 32 32 0 1 0 64 0z",viewBox:"0 0 512 512"},xmark:{path:"M342.6 150.6c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L192 210.7 86.6 105.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3L146.7 256 41.4 361.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0L192 301.3 297.4 406.6c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L237.3 256 342.6 150.6z",viewBox:"0 0 384 512"},lifeRing:{path:"M367.2 412.5C335.9 434.9 297.5 448 256 448s-79.9-13.1-111.2-35.5l58-58c15.8 8.6 34 13.5 53.3 13.5s37.4-4.9 53.3-13.5l58 58zm90.7 .8c33.8-43.4 54-98 54-157.3s-20.2-113.9-54-157.3c9-12.5 7.9-30.1-3.4-41.3S425.8 45 413.3 54C369.9 20.2 315.3 0 256 0S142.1 20.2 98.7 54c-12.5-9-30.1-7.9-41.3 3.4S45 86.2 54 98.7C20.2 142.1 0 196.7 0 256s20.2 113.9 54 157.3c-9 12.5-7.9 30.1 3.4 41.3S86.2 467 98.7 458c43.4 33.8 98 54 157.3 54s113.9-20.2 157.3-54c12.5 9 30.1 7.9 41.3-3.4s12.4-28.8 3.4-41.3zm-45.5-46.1l-58-58c8.6-15.8 13.5-34 13.5-53.3s-4.9-37.4-13.5-53.3l58-58C434.9 176.1 448 214.5 448 256s-13.1 79.9-35.5 111.2zM367.2 99.5l-58 58c-15.8-8.6-34-13.5-53.3-13.5s-37.4 4.9-53.3 13.5l-58-58C176.1 77.1 214.5 64 256 64s79.9 13.1 111.2 35.5zM157.5 309.3l-58 58C77.1 335.9 64 297.5 64 256s13.1-79.9 35.5-111.2l58 58c-8.6 15.8-13.5 34-13.5 53.3s4.9 37.4 13.5 53.3zM208 256a48 48 0 1 1 96 0 48 48 0 1 1 -96 0z",viewBox:"0 0 512 512"}};static name(e){const t=this.icon[e];return t&&"object"==typeof t&&t.path&&t.viewBox?t:{path:"M256 512A256 256 0 1 0 256 0a256 256 0 1 0 0 512zm0-384c13.3 0 24 10.7 24 24V264c0 13.3-10.7 24-24 24s-24-10.7-24-24V152c0-13.3 10.7-24 24-24zm32 224c0 17.7-14.3 32-32 32s-32-14.3-32-32s14.3-32 32-32s32 14.3 32 32z",viewBox:"0 0 512 512"}}}},53005:(e,t,s)=>{"use strict";s.d(t,{l:()=>o});var i=s(51308),n=s(14574),a=s(57093);class o{static AVAILABLE_CYCLES={QUARTERLY:"quarterly",ANNUAL:"annual",MONTHLY:"monthly"};static DEFAULT_CYCLE=o.AVAILABLE_CYCLES.ANNUAL;static CYCLE_DISPLAY_NAMES={[o.AVAILABLE_CYCLES.QUARTERLY]:"Quarterly",[o.AVAILABLE_CYCLES.ANNUAL]:"Annual",[o.AVAILABLE_CYCLES.MONTHLY]:"Monthly"};static CYCLE_SAVINGS={[o.AVAILABLE_CYCLES.QUARTERLY]:"",[o.AVAILABLE_CYCLES.ANNUAL]:"Save up to 20%",[o.AVAILABLE_CYCLES.MONTHLY]:""};static getPlans(e=!1){const t={individual:{member:{name:"Member plan",monthly:{price:15,save:0,pid:"price_1PfHSsA0O8oHJy6vStw1nYSa",prpid:"price_1PfHORA0O8oHJy6vlotTCcjd"},quarterly:{price:15,total:45,pid:"price_1Qz5tNA0O8oHJy6v37tHukGF",prpid:"price_1R0wg7A0O8oHJy6vkD3a20tR"},annual:{price:9,save:72,total:108,pid:"price_1PfHTwA0O8oHJy6vWvfV8j41",prpid:"price_1PfHPgA0O8oHJy6vvKk8Elum"},features:["All features","Access to all frontier AI models","Install MCPs from the App Store","Create agentic asssistants","Analyze documents & PDFs","Create with code","Visualize data with charts & graphs","Create images and videos","Assistant memory"]},pro:{name:"Pro plan",monthly:{price:29,save:0,pid:"price_1PsOVJA0O8oHJy6vchGHuzVT",prpid:"price_1PsOZBA0O8oHJy6vvmmdEjdI"},quarterly:{price:29,total:87,pid:"price_1Qz5u5A0O8oHJy6vnTncIFbI",prpid:"price_1R0wg3A0O8oHJy6v94QHlkT7"},annual:{price:20,save:108,total:240,pid:"price_1PsOTvA0O8oHJy6vAxbIz08M",prpid:"price_1PsOaJA0O8oHJy6vpX9icMbX"},features:["Everything in Member, plus:","Higher frontier model monthly token limit","Higher premium tokens monthly limit","Install custom and private MCPs","Recharge tokens"]},max:{name:"Max plan",monthly:{price:49,save:0,pid:"price_1PsOVyA0O8oHJy6v6cacq14T",prpid:"price_1PsOb1A0O8oHJy6va95jbTaz"},quarterly:{price:49,total:147,pid:"price_1Qz5uyA0O8oHJy6vq9x85f1l",prpid:"price_1R0wfyA0O8oHJy6vQPzo7Fqj"},annual:{price:40,save:108,total:480,pid:"price_1PsOWxA0O8oHJy6vCY41zR0x",prpid:"price_1PsObfA0O8oHJy6vXjCcBNRk"},features:["Everything in Pro, plus:","Our highest frontier model monthly token limit","Our highest premium token monthly limit"]}},family:{standard:{name:"Family plan",annual:{price:29,total:348,pid:"price_1QrQONA0O8oHJy6vVNS0S0GX",prpid:"price_1QrQR2A0O8oHJy6vgMkGO2AO"},features:["Everything in Pro, plus:","Up to 6 family members","Individual workspace for each member","Shared limits","Custom themes","Shared billing & analytics"]},max:{name:"Family Max plan",annual:{price:49,total:588,pid:"price_1R0wgDA0O8oHJy6vrfMrKWlk",prpid:"price_1QrQR2A0O8oHJy6vgMkGO2AO"},features:["Everything in Family plan, plus","Max plan features"]}},workspace:{ember:{name:"Ember",seats:10,monthly:{price:119,pid:"price_1Rl2VpA0O8oHJy6vBb4JIiKg",prpid:"price_1RlGmJA0O8oHJy6vUryUZvcG"},annual:{price:99,total:1188,pid:"price_1Rl2VNA0O8oHJy6vPV2msMYk",prpid:"price_1RlGmLA0O8oHJy6vVzzpLwbH"},features:["Up to 10 seats","20M input & 3M output tokens","500 premium use tokens","Allocate token limits by role","Workspace support (admins can log tickets)","Auto-recharge tokens","Payment by credit card"]},spark:{name:"Spark",seats:20,monthly:{price:239,pid:"price_1Rl2axA0O8oHJy6vutIEMwS6",prpid:"price_1RlGmEA0O8oHJy6vNB4nZ7q3"},annual:{price:199,total:2388,pid:"price_1Rl2WlA0O8oHJy6v6TUjl8o7",prpid:"price_1RlGmGA0O8oHJy6ve5HrI9Xc"},features:["Up to 20 seats","40M input & 6M output tokens","500 premium use tokens","Allocate token limits by role","Workspace support (admins can log tickets)","Auto-recharge tokens","Payment by credit card"]},ignite:{name:"Ignite",seats:50,monthly:{price:599,pid:"price_1Rl2e0A0O8oHJy6vAbEl6YeI",prpid:"price_1RlGmAA0O8oHJy6vqqpEAFPG"},annual:{price:499,total:5988,pid:"price_1Rl2bUA0O8oHJy6vYJywpn69",prpid:"price_1RlGmCA0O8oHJy6vqIUJQgSn"},features:["Up to 50 seats","100M input & 15M output tokens","500 premium use tokens","Allocate token limits by role","Workspace support (admins can log tickets)","Auto-recharge tokens","Payment by credit card"]},blaze:{name:"Blaze",seats:100,monthly:{price:1199,pid:"price_1Rl2fCA0O8oHJy6vMIu682R7",prpid:"price_1RlGm4A0O8oHJy6vkBwIGATB"},annual:{price:999,total:11988,pid:"price_1Rl2esA0O8oHJy6vgyYB67Ow",prpid:"price_1RlGm7A0O8oHJy6vDDRtvcZT"},features:["Up to 100 seats","200M input & 30M output tokens","1,000 premium use tokens","Allocate token limits by role","Workspace support (admins can log tickets)","Auto-recharge tokens","Pay by credit card or invoice"]},enterprise:{name:"Enterprise Plan",description:"No matter how large your organization, we can work with you on a custom workspace solution at scale.",features_title:"What's available:",features:["Single tenant regional deployments including on premise.","White labeled workspace","Advanced SSO integration","Custom MCP development","Custom implementation & training","Prompt engineer assistants","Agentic workflow automation assistants","Support for up to 100,000 seats"]}},workspace_old:{business:{name:"Business",description:"Great for small teams. Includes all Pro plan features plus advanced customization, permissions and analytics.",annual:{price:19,minSeats:5,yearlyTotal:1500,pid:"price_workspace_business_annual"},features:["Customizable AI workspace","Complete control over models & skills","Custom branded workspace theme","Workspace usage analytics","Access to all frontier AI models","Create teams and assign permissions","Share agents with your team","Share sessions with your team (coming soon)","Plus all features of Pro plan"]},enterprise:{name:"Enterprise",description:"Designed for custom deployments in education, government and enterprise. Secure, customizable and scalable.",annual:{price:null,priceLabel:"Custom",minSpend:25e3,pid:"price_workspace_enterprise_annual"},features:["Everything from business, plus:","Pay per use pricing options","Custom deployment options","Implementation and training","Branded theming","Managed setup and agent creation"]}}};return e||delete t.individual.creator,t}constructor(e="signup",t=null){if(this.container=document.getElementById("primary-content"),!this.container)return;this.mode=e||"signup",this.workspaceContext=t||null,this.plans=o.getPlans(),this.wizardState={},this.currentPlan=null,this.currentCycle=null;const s=new URLSearchParams(window.location.search),i=s.get("status"),n=s.get("invoice"),a=s.get("workspace_slug");i&&a?this.handleWorkspaceStatus(i,a,n):this.renderInitialView()}renderInitialView(){if(this.container){switch(this.container.innerHTML='\n            <main id="wizard-main" class="flex flex-col items-center">\n                \x3c!-- Wizard content will be injected here --\x3e\n            </main>\n            <div id="faq-container-wrapper" class="flex flex-col justify-center items-center mx-auto max-w-[800px] pt-2 hidden">\n                <div id="faq-section" class="w-full hidden">\n                    <h2 class="text-4xl font-medium tracking-tighter my-8 text-center">Frequently asked questions</h2>\n                    <div class="space-y-4 w-full" id="faq-container"></div>\n                </div>\n                <button id="faq-toggle" class="text-base text-gray-500 hover:text-gray-800 transition-colors my-4">Questions? Show FAQs</button>\n            </div>',this.wizardContainer=document.getElementById("wizard-main"),this.mode){case"add_workspace":this.renderWorkspaceTypeSelection();break;case"change_plan":this.renderChangePlanView();break;case"cancel_plan":this.renderCancelPlanView();break;case"reactivate_plan":this.renderReactivatePlanView();break;default:this.renderSignupPlans()}this.renderFAQsHTML()}}async handleWorkspaceStatus(e,t,s){if("success"===e)try{const e=await n.G.postData("/accounts/verify-workspace/",{workspace_slug:t,invoice:!!s});if(e.success&&e.workspace){const{name:t,slug:i}=e.workspace;s?this.renderInvoicePendingState(t,i):this.renderCheckoutSuccess(t,i),sessionStorage.removeItem("pending_workspace_data")}else this.renderFailState()}catch(e){this.renderFailState()}else"failed"===e?this.renderFailState():this.renderSignupPlans()}renderSignupPlans(){this.renderWorkspaceTypeSelection()}renderWorkspaceTypeSelection(){this.wizardState={};const e="add_workspace"===this.mode,t=e?"Create a new workspace":"What kind of workspace do you want to create?";this.wizardContainer.innerHTML=`\n        <div class="pt-10 flex flex-col items-center">\n            <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-4 text-center text-gray-900 pt-6 sm:pt-20 max-w-[800px]">${t}</h1>\n            <div class="flex flex-col lg:flex-row items-center lg:items-stretch justify-center space-y-3 lg:space-y-0 gap-3 w-full max-w-[900px] mt-12 px-6 pb-6">\n                ${e?"":this.createWorkspaceTypeCard("personal","Personal","A workspace for productivity, learning, exploring and fun.","fa-user")}\n                ${this.createWorkspaceTypeCard("family","Family","A single subscription for up to 6 family members.","fa-users")}\n                ${this.createWorkspaceTypeCard("team","Team","A secure team workspace for collaboration and projects.","fa-buildings")}\n            </div>\n\n            <div class="mt-4 text-center">\n                <a href="#" id="show-custom-code-form" class="text-sm text-gray-600 hover:text-gray-900">Have a custom plan code?</a>\n            </div>\n            <div id="custom-code-form-container" class="mt-4 w-full max-w-sm hidden">\n                <label for="initial-custom-plan-code-input" class="block text-sm font-medium text-gray-700">Enter your code</label>\n                <div class="mt-1 flex rounded-md shadow-sm">\n                    <input type="text" id="initial-custom-plan-code-input" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="SIM-XXXXXX">\n                    <button id="initial-apply-custom-code-btn" type="button" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">Apply</button>\n                </div>\n                <p id="initial-custom-code-message" class="text-sm mt-2"></p>\n            </div>\n        </div>`,this.wizardContainer.querySelectorAll(".workspace-type-card").forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget.dataset.segment,s="personal"===t?"individual":"team"===t?"workspace":"family";this.renderPlanSelection(s)}))})),document.getElementById("show-custom-code-form").addEventListener("click",(e=>{e.preventDefault(),document.getElementById("custom-code-form-container").classList.toggle("hidden")})),document.getElementById("initial-apply-custom-code-btn").addEventListener("click",(()=>{this.handleCustomCodeSubmission("initial-custom-plan-code-input","initial-custom-code-message","initial-apply-custom-code-btn")}))}createWorkspaceTypeCard(e,t,s,i){return`\n            <div data-segment="${e}" class="workspace-type-card w-full lg:flex-1 rounded-xl p-6 ring-2 ring-gray-200 bg-white flex flex-col cursor-pointer hover:ring-blue-500 hover:ring-4 hover:shadow-xl transition-all duration-200 min-h-[200px]">\n                <div class="text-gray-900 mb-4"><i class="fa-solid ${i} fa-xl"></i></div>\n                <h2 class="text-2xl font-medium tracking-tight text-gray-900 pb-2">${t}</h2>\n                <p class="text-gray-600">${s}</p>\n            </div>`}renderPlanSelection(e){const t="change_plan"===this.mode;let s="Select a plan";t?s="Change your plan":"family"===e?s="Select your family plan":"workspace"===e&&(s="Select a team plan");let i="All plans include all features, frontier models and MCPs.";"family"===e&&(i="Family plans include 6 individual accounts, all features, models and MCPs"),this.wizardContainer.className="";const n=t&&this.currentCycle?this.currentCycle:o.DEFAULT_CYCLE;let a="";if("individual"===e||"workspace"===e){a=`\n                <div class="flex justify-center items-center mt-4">\n                    <div id="billing-container" class="bg-gray-200 inline-flex rounded-lg p-1">${[o.AVAILABLE_CYCLES.ANNUAL,o.AVAILABLE_CYCLES.MONTHLY].map((e=>{const t=e===n,s="annual"===e&&o.CYCLE_SAVINGS[e]?`<span class="text-xs rounded-full bg-blue-100 text-blue-800 px-2 py-0.5 font-medium">${o.CYCLE_SAVINGS[e]}</span>`:"";return`<button id="billing-${e}" class="billing-toggle px-3 py-1 rounded-md text-sm font-medium transition-colors flex items-center gap-2 ${t?"active bg-white text-gray-900 shadow-sm":"text-gray-600"}">\n                            ${o.CYCLE_DISPLAY_NAMES[e]} ${s}\n                        </button>`})).join("")}</div>\n                </div>\n            `}this.wizardContainer.innerHTML=`\n            <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                <div class="flex justify-center">\n                    <button id="back-to-wizard-start" class="absolute left-6 top-6 text-black hover:text-gray-700 transition-colors z-10 text-sm font-medium">\n                        &larr; Go back\n                    </button>\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">${s}</h1>\n                        <p class="text-xl text-gray-500">${i}</p>\n                    </div>\n                </div>\n                ${a}\n            </div>\n            <div id="plans-content-container" class="w-full mt-8"></div>`,document.getElementById("faq-container-wrapper").classList.remove("hidden"),document.getElementById("back-to-wizard-start").addEventListener("click",(()=>{t?window.location.href="/chat":(this.renderWorkspaceTypeSelection(),this.updateFAQs("individual"),document.getElementById("faq-container-wrapper").classList.add("hidden"))}));const r=document.getElementById("plans-content-container");if(this.renderSegmentPlansUI(e,r,n),"individual"===e||"workspace"===e){const t=document.getElementById("billing-container");t.querySelectorAll(".billing-toggle").forEach((s=>{s.addEventListener("click",(i=>{i.preventDefault();let n=s.id.split("-")[1];t.querySelectorAll(".billing-toggle").forEach((e=>{e.classList.remove("active","bg-white","text-gray-900","shadow-sm"),e.classList.add("text-gray-600")})),s.classList.add("active","bg-white","text-gray-900","shadow-sm"),s.classList.remove("text-gray-600"),this.renderPlansForSegment(e,r.querySelector(".plans-grid"),n)}))}))}}renderSegmentPlansUI(e,t,s){let i;if(t.innerHTML="","workspace"===e){const e=document.createElement("div");e.className="w-full overflow-x-auto pb-4",i=document.createElement("div"),i.className="plans-grid flex flex-nowrap items-stretch justify-start gap-3 w-max px-6 sm:px-16 py-1",e.appendChild(i),t.appendChild(e)}else{const e=document.createElement("div");e.className="mx-auto max-w-[1440px] px-6 sm:px-16",i=document.createElement("div"),i.className="plans-grid flex flex-col lg:flex-row items-center lg:items-stretch justify-center space-y-3 lg:space-y-0 gap-3 w-full",e.appendChild(i),t.appendChild(e)}this.renderPlansForSegment(e,i,s)}getFAQs(e="individual"){const t=[{question:"Is there a free trial?",answer:"No, we do not offer a free trial. However, you can subscribe for a single month and cancel at any time. We do not offer refunds for unused time due to associated costs in providing the service."},{question:"Which models are available?",answer:"We offer a wide range of both frontier and open source models from leading providers including Gemini 2.5 Pro, Anthropic's Claude Sonnet 4, Grok 4, OpenAI's GPT-4o, GPT-4.5, o3, o3-pro & o4-mini, Meta's Llama, Mistral, DeepSeek R1, Kimi and more. All models are hosted in the USA unless otherwise specified. We also offer a range of modalities including text, image, video, audio, code and more."},{question:"Is my data secure?",answer:"Yes, your data is secure. We use the latest encryption technology to protect your data and privacy. We do not share your data with third parties or train AI models on your data."},{question:"Can I get a receipt or invoice?",answer:"After you subscribe, you will receive an email with a receipt and invoice. You can also download your invoice from your account settings."},{question:"Is my Simtheory subscription a tax deduction?",answer:"Yes, your Simtheory subscription may be tax deductible. Please consult with your tax advisor for more information."}];return{individual:t,family:[{question:"How many family members can I add?",answer:"You can add up to 6 family members to your family workspace. Each member gets their own individual workspace while sharing the overall plan limits."},{question:"How do shared limits work?",answer:"All family members share from the same pool of resources. For example, if your plan has a monthly token limit, this is shared between all members. If one family member uses less, others can use more, making it flexible for different usage patterns."},{question:"Can family members see each other's workspaces?",answer:"No, each family member gets their own private workspace. While resources are shared, conversations and workspace content remain private to each individual member."}],workspace:[{question:"What's the difference between the workspace plans?",answer:"The main differences are the number of seats and the monthly token limits. Higher-tier plans like Ignite and Blaze offer significantly more resources and support more users, making them suitable for larger teams with higher demands."},{question:"How does billing work for workspace plans?",answer:"Workspace plans can be billed monthly or annually. Choosing an annual plan provides a significant discount over the monthly rate. All seats are included in the single plan price."},{question:"Can we add more seats than the plan includes?",answer:"The seat limits for each plan are fixed. If you need more seats than your current plan allows, you will need to upgrade to a higher-tier plan. For needs beyond the Blaze plan, please contact us for enterprise solutions."},{question:"What payment options are available?",answer:"We accept all major credit cards for all workspace plans. For the Blaze plan, we also offer the option of payment by invoice for annual subscriptions."}]}[e]||t}renderFAQsHTML(){this.updateFAQs("individual");const e=document.getElementById("faq-toggle"),t=document.getElementById("faq-section");e&&t&&e.addEventListener("click",(()=>{t.classList.toggle("hidden");const s=t.classList.contains("hidden");e.textContent=s?"Questions? Show FAQs":"Hide FAQs"})),document.addEventListener("click",(e=>{const t=e.target.closest(".faq-question");if(t){const e=t.nextElementSibling,s=t.querySelector(".faq-icon i");e.classList.toggle("hidden"),s.classList.toggle("fa-plus",e.classList.contains("hidden")),s.classList.toggle("fa-minus",!e.classList.contains("hidden"))}}))}updateFAQs(e){const t=document.getElementById("faq-container");if(!t)return;const s=this.getFAQs(e);t.innerHTML=s.map((e=>`\n            <div class="faq-item border-b border-gray-300 pb-4">\n                <button class="faq-question flex justify-between items-center w-full text-left py-2">\n                    <span class="text-lg font-medium text-gray-800">${e.question}</span>\n                    <span class="faq-icon text-xl text-gray-500"><i class="fa-solid fa-plus w-4 h-4"></i></span>\n                </button>\n                <div class="faq-answer mt-2 hidden">\n                    <p class="text-gray-600">${e.answer}</p>\n                </div>\n            </div>`)).join("")}renderPlansForSegment(e,t,s="annual"){const i=this.plans[e];t.innerHTML="",Object.entries(i).forEach((([i,n])=>{const o=document.createElement("div"),r=`${e}-${i}`;if("workspace"===e&&"enterprise"===i)return o.className="w-[340px] flex-shrink-0 rounded-xl p-6 ring-1 ring-gray-300 bg-white flex flex-col",o.innerHTML=`\n                    <h2 class="text-2xl font-medium tracking-tight text-gray-900 pb-1 pt-2">${n.name}</h2>\n                    <div class="flex gap-2 items-end min-h-[3.5rem]">\n                        <div class="text-4xl font-medium tracking-tighter text-gray-900">Custom</div>\n                        <div class="text-xs text-gray-500 flex flex-col justify-end pb-1"><div class="h-4"></div><div class="font-medium text-gray-900">pricing</div></div>\n                    </div>\n                    <p class="text-gray-600 text-sm mt-4">${n.description}</p>\n                    \n                    <div class="pt-6">\n                        <button id="contact-sales-button" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full w-full font-medium transition-colors">Contact sales</button>\n                    </div>\n\n                    <div class="border-t border-gray-200 my-6"></div>\n\n                    <div>\n                        <label for="custom-plan-code-input" class="block text-sm font-medium text-gray-700">Have a custom plan code?</label>\n                        <div class="mt-1 flex rounded-md shadow-sm">\n                            <input type="text" id="custom-plan-code-input" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Enter code">\n                            <button id="apply-custom-code-btn" type="button" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">Apply</button>\n                        </div>\n                        <p id="custom-code-message" class="text-sm mt-2"></p>\n                    </div>\n\n                    <div class="font-medium text-sm pt-6 pb-2 text-gray-900">${n.features_title}</div>\n                    <div class="flex-grow">${n.features.map((e=>`<div class="flex gap-3 items-center pt-3 text-sm text-gray-600"><div><i class="fa-solid fa-check text-blue-600"></i></div><div>${e}</div></div>`)).join("")}</div>`,t.appendChild(o),o.querySelector("#contact-sales-button").addEventListener("click",(()=>new a.g)),void o.querySelector("#apply-custom-code-btn").addEventListener("click",(()=>this.handleCustomCodeSubmission("custom-plan-code-input","custom-code-message","apply-custom-code-btn")));let l=s,c=n[l];if(!c){const e=n.annual?"annual":n.monthly?"monthly":n.quarterly?"quarterly":null;e&&(l=e,c=n[l])}if(!c)return;const d="change_plan"===this.mode&&this.currentPlan===i,h=this.currentCycle===l,m=d&&h;let u=m?"ring-2 ring-blue-500":"ring-1 ring-gray-300";o.className=`w-[340px] flex-shrink-0 rounded-xl p-6 ${u} bg-white flex flex-col`;let p=`$${c.price.toLocaleString()}`,g=null;if("annual"===l&&n.monthly){const e=12*n.monthly.price,t=c.total||12*c.price;e>t&&(g=e-t)}let f="Subscribe ",v=!1;"change_plan"===this.mode?m?(f="Current Plan",v=!0):f="Switch to plan":"workspace"===e&&(f="Start 7 day trial "),o.innerHTML=`\n                <h2 class="text-2xl font-medium tracking-tight text-gray-900 pb-1 pt-2">${n.name}</h2>\n                <div class="flex gap-2 items-end min-h-[3.5rem]">\n                    <div class="text-5xl font-medium tracking-tighter text-gray-900">${p}</div>\n                    <div class="text-xs text-gray-500 flex flex-col justify-end pb-1">\n                        <div class="h-4">${g?`<span class="text-green-600">Save $${g.toLocaleString()}</span>`:""}</div>\n                        <div class="font-medium text-gray-900">per month</div>\n                    </div>\n                </div>\n                <div class="pt-6">\n                    <button id="${r}-subscribe-button" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full w-full font-medium transition-colors disabled:bg-gray-400" ${v?"disabled":""}>\n                        ${f}\n                    </button>\n                </div>\n                <div class="font-medium text-sm pt-6 pb-2 text-gray-900">What's included:</div>\n                <div class="flex-grow">${n.features.map((e=>`<div class="flex gap-3 items-center pt-3 text-sm text-gray-600"><div><i class="fa-solid fa-check text-blue-600"></i></div><div>${e}</div></div>`)).join("")}</div>`,t.appendChild(o),o.querySelector(`#${r}-subscribe-button`).addEventListener("click",(()=>this.handleSubscription(e,i,n,l)))}))}handleSubscription(e,t,s,i){if("workspace"===e&&"enterprise"===t)return void new a.g;document.getElementById("faq-container-wrapper").classList.add("hidden");const n={name:"Personal Workspace",plan:t,type:e,billing_cycle:i,billing:{method:"card"},plan_details:"family"===e?s.annual:s[i]};"change_plan"!==this.mode?"individual"===e?this._renderConfirmationStep(n):this.startWorkspaceCreationFlow(e,t,s,i||"annual"):this._renderConfirmationStep(n)}async _renderConfirmationStep(e){const t="change_plan"===this.mode,s=t?"Confirm change":"workspace"===e.type?"Start 7-day trial":"Subscribe",i=t?"Confirm new plan":"Confirm your plan",a=t?"Back to plans":"Go back";this.wizardContainer.innerHTML=`\n            <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                <div class="flex justify-center">\n                    <button id="wizard-back-btn" class="absolute left-6 top-6 text-black hover:text-gray-700 transition-colors z-10 text-sm font-medium">\n                        &larr; ${a}\n                    </button>\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">${i}</h1>\n                    </div>\n                </div>\n                <div class="flex justify-center mt-8">\n                    <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                        <div class="space-y-4">\n                            <div id="confirmation-summary-container" class="bg-gray-50 rounded-lg p-4 border border-gray-200"></div>\n                            <div id="pro-rata-container" class="text-sm text-gray-600 bg-blue-50 rounded-lg p-4 border border-blue-200" style="display: none;"></div>\n                            <div class="pt-2">\n                                <label for="coupon-code" class="block text-sm font-medium text-gray-700">Have a coupon?</label>\n                                <div class="mt-1 flex rounded-md shadow-sm">\n                                    <input type="text" id="coupon-code" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="Enter code">\n                                    <button id="apply-coupon-btn" type="button" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">Apply</button>\n                                </div>\n                                <p id="coupon-message" class="text-sm mt-2"></p>\n                            </div>\n                            <div class="flex items-start mt-4">\n                                <input id="terms-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-0.5">\n                                <label for="terms-checkbox" class="ml-2 block text-sm text-gray-600">I agree to the <a href="/terms" target="_blank" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="/privacy" target="_blank" class="text-blue-600 hover:underline">Privacy Policy</a>.</label>\n                            </div>\n                        </div>\n                        <div class="mt-6">\n                            <button id="confirm-btn" class="w-full px-4 py-2 bg-gray-800 text-white rounded-full font-medium transition-colors disabled:bg-gray-400" disabled>${s}</button>\n                            <div class="text-gray-500 text-xs text-center pt-2">Currency is USD unless otherwise stated.</div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,this._renderConfirmationSummary(e),t&&this._updateProrataDisplay(e);const o=document.getElementById("confirm-btn"),r=document.getElementById("terms-checkbox"),l=document.getElementById("apply-coupon-btn"),c=document.getElementById("coupon-code"),d=document.getElementById("coupon-message");l.addEventListener("click",(async()=>{const s=c.value.trim().toUpperCase();if(!s)return d.textContent="Please enter a coupon code.",void(d.className="text-sm mt-2 text-red-500");l.disabled=!0,l.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',d.textContent="";try{const i=window.location.hostname.match(/localhost/),a={code:s,price_id:i?e.plan_details.pid:e.plan_details.prpid},o=await n.G.postData("/accounts/validate-coupon/",a);o.success?(this.wizardState.coupon=o,d.textContent=o.message||"Coupon applied successfully!",d.className="text-sm mt-2 text-green-600",t&&await this._updateProrataDisplay(e,s)):(delete this.wizardState.coupon,d.textContent=o.error||"Invalid coupon code.",d.className="text-sm mt-2 text-red-500",t&&await this._updateProrataDisplay(e)),this._renderConfirmationSummary(e,this.wizardState.coupon)}catch(t){delete this.wizardState.coupon,this._renderConfirmationSummary(e),d.textContent="Could not validate coupon. Please try again.",d.className="text-sm mt-2 text-red-500"}finally{l.disabled=!1,l.innerHTML="Apply"}})),r.addEventListener("change",(()=>{o.disabled=!r.checked})),document.getElementById("wizard-back-btn").addEventListener("click",(()=>{delete this.wizardState.coupon,t?this.renderChangePlanView():this.renderPlanSelection(e.type)})),o.addEventListener("click",(async()=>{if(r.checked){o.disabled=!0,o.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Processing...';const t=window.location.hostname.match(/localhost/)?e.plan_details.pid:e.plan_details.prpid,s=this.wizardState.coupon?.code;if("change_plan"===this.mode){let i;i=this.workspaceContext?await n.G.postData("/accounts/workspace/change-plan/",{plan_key:e.plan,billing_cycle:e.billing_cycle,coupon_code:s}):await n.G.postData(`/accounts/account/upgrade/${t}`,{coupon_code:s}),i.success||"success"===i.status?this.renderSuccessState("Your plan has been changed","Your subscription has been successfully updated."):this.renderFailState("Change failed",i.error||"Could not change your plan.")}else if("add_workspace"===this.mode)e.coupon_code=s,this._submitWorkspaceCreation(e);else if("workspace"===e.type||"family"===e.type)e.coupon_code=s,this._submitWorkspaceCreation(e);else{let i=`/accounts/account/pay/${e.billing_cycle}/${t}`;s&&(i+=`?coupon=${s}`),window.location.href=i}}}))}async _updateProrataDisplay(e,t=null){const s=document.getElementById("pro-rata-container");let i;if(s.style.display="block",s.innerHTML='<div class="flex items-center gap-2"><i class="fa-solid fa-spinner fa-spin"></i> Calculating cost...</div>',this.workspaceContext){const s={plan_key:e.plan,billing_cycle:e.billing_cycle,coupon_code:t};i=await n.G.postData("/accounts/workspace/pro-rata/",s)}else{const s={price_id:window.location.hostname.match(/localhost/)?e.plan_details.pid:e.plan_details.prpid};t&&(s.coupon_code=t),i=await n.G.postData("/accounts/pro-rata/",s)}if(i.success){const t=i.pro_rata_amount,n=i.next_renewal_amount,a="annual"===e.billing_cycle?e.plan_details.total||12*e.plan_details.price:e.plan_details.price;let o=0;this.wizardState.coupon&&this.wizardState.coupon.success&&(o=this.wizardState.coupon.discount_amount||0);let r="",l=0;if(t>0)l=Math.max(0,t-o),r=`\n                    <div>Upgrade charge: <strong>$${t.toFixed(2)}</strong></div>\n                    ${o>0?`<div>Coupon discount: <strong>-$${o.toFixed(2)}</strong></div>`:""}\n                    <div class="border-t border-gray-300 pt-2 mt-2">Total due today: <strong>$${l.toFixed(2)}</strong></div>\n                `;else if(t<0){const e=Math.abs(t);l=Math.max(0,a-e-o),r=`\n                    <div>New plan price: <strong>$${a.toFixed(2)}</strong></div>\n                    <div>Credit applied: <strong>-$${e.toFixed(2)}</strong></div>\n                    ${o>0?`<div>Coupon discount: <strong>-$${o.toFixed(2)}</strong></div>`:""}\n                    <div class="border-t border-gray-300 pt-2 mt-2">Total due today: <strong>$${l.toFixed(2)}</strong></div>\n                `}else l=Math.max(0,a-o),r=`\n                    <div>New plan price: <strong>$${a.toFixed(2)}</strong></div>\n                    ${o>0?`<div>Coupon discount: <strong>-$${o.toFixed(2)}</strong></div>`:""}\n                    <div class="border-t border-gray-300 pt-2 mt-2">Total due today: <strong>$${l.toFixed(2)}</strong></div>\n                `;const c=`Due next renewal: <strong>$${n.toFixed(2)}</strong>`;s.innerHTML=`<div class="font-medium">${r}</div><div class="mt-3 pt-3 border-t border-gray-200">${c}</div>`}else s.innerHTML=`<span class="text-red-500">${i.error||"Could not calculate plan change cost."}</span>`}_renderConfirmationSummary(e,t=null){const s=this.plans[e.type][e.plan],i=e.billing_cycle,n="family"===e.type?this.plans[e.type][e.plan].annual:e.plan_details,a="workspace"===e.type,o="change_plan"===this.mode;let r,l,c;"annual"===i||"family"===e.type?(l=n.total,r="/year"):(l=n.price,r="/month");let d="";if(t&&t.success){c=t.new_total;d=`\n                <li class="flex justify-between text-green-600">\n                    <span class="font-medium">Discount ${t.message?t.message.replace("Success! A ","").replace(" has been applied.","").replace(" has been applied",""):`${t.code}${t.duration_summary?` ${t.duration_summary}`:""}`}</span>\n                    <span class="font-medium">-$${t.discount_amount.toLocaleString()}</span>\n                </li>\n            `}else c=l;const h="family"===e.type?"Annual":i.charAt(0).toUpperCase()+i.slice(1),m="invoice"===e.billing.method?'<li class="flex justify-between"><span class="text-gray-600">Payment Method:</span> <span class="font-medium text-gray-900">Invoice</span></li>':"";let u="";u=o?`\n                <li class="flex justify-between">\n                    <span class="text-gray-600">New Plan Price:</span>\n                    <span class="font-medium text-gray-900">$${l.toLocaleString()} ${r}</span>\n                </li>\n                ${d}\n            `:a?`\n                <li class="flex justify-between">\n                    <span class="text-gray-600">Free trial:</span>\n                    <span class="font-medium text-gray-900">7 days</span>\n                </li>\n                <li class="flex justify-between">\n                    <span class="text-gray-600">Subtotal:</span>\n                    <span class="font-medium text-gray-900">$${l.toLocaleString()}</span>\n                </li>\n                ${d}\n                <li class="flex justify-between">\n                    <span class="text-gray-600">Total after trial:</span>\n                    <span class="font-medium text-gray-900">$${c.toLocaleString()} ${r}</span>\n                </li>\n                <li class="flex justify-between border-t border-gray-200 pt-2 mt-2">\n                    <span class="text-base font-semibold text-gray-800">Due today:</span> \n                    <span class="text-base font-semibold text-gray-800">$0</span>\n                </li>\n            `:`\n                <li class="flex justify-between">\n                    <span class="text-gray-600">Subtotal:</span>\n                    <span class="font-medium text-gray-900">$${l.toLocaleString()}</span>\n                </li>\n                ${d}\n                <li class="flex justify-between border-t border-gray-200 pt-2 mt-2">\n                    <span class="text-base font-semibold text-gray-800">Due today:</span> \n                    <span class="text-base font-semibold text-gray-800">$${c.toLocaleString()}</span>\n                </li>\n            `;const p=`\n            <ul class="space-y-2 text-sm">\n                <li class="flex justify-between"><span class="text-gray-600">Plan:</span> <span class="font-medium text-gray-900">${s.name}</span></li>\n                ${u}\n                <li class="flex justify-between"><span class="text-gray-600">Billing Cycle:</span> <span class="font-medium text-gray-900">${h}</span></li>\n                ${m}\n            </ul>\n        `,g=document.getElementById("confirmation-summary-container");g&&(g.innerHTML=p)}_renderNameStep(e,t,s,i,n=""){document.getElementById("faq-container-wrapper").classList.add("hidden"),this.wizardContainer.innerHTML=`\n            <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                <div class="flex justify-center">\n                    <button id="wizard-back-btn" class="absolute left-6 top-6 text-black hover:text-gray-700 transition-colors z-10 text-sm font-medium">\n                        &larr; Back to plans\n                    </button>\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Name your workspace</h1>\n                    </div>\n                </div>\n                <div class="flex justify-center mt-8">\n                    <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                        <label for="workspace-name-input" class="block text-base font-medium text-gray-700">${"family"===e?"Family Name":"Workspace Name"}</label>\n                        <input type="text" id="workspace-name-input" value="${n}" placeholder="${"family"===e?"e.g. The Sharkey Family":"e.g. Acme Corporation"}" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm placeholder-gray-400 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">\n                        <p id="name-error" class="text-red-500 text-xs mt-1 hidden">Please enter a name.</p>\n                        <div class="mt-6">\n                            <button id="next-btn" class="w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Next</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,document.getElementById("wizard-back-btn").addEventListener("click",(()=>this.renderPlanSelection(e)));const a=this.wizardContainer.querySelector("#next-btn"),o=this.wizardContainer.querySelector("#workspace-name-input"),r=this.wizardContainer.querySelector("#name-error");o.focus(),a.addEventListener("click",(()=>{const n=o.value.trim();if(n){this.wizardState.name=n;const a={name:n,plan:t,type:e,billing_cycle:i,billing:{method:"card"},plan_details:"family"===e?s.annual:s[i]};"workspace"===e&&"blaze"===t?this._renderBillingStep(a,s):this._renderConfirmationStep(a)}else r.classList.remove("hidden"),o.classList.add("border-red-500")}))}_renderBillingStep(e,t){const{name:s}=e,{first_name:i="",last_name:n="",email:a=""}=window.user||{};this.wizardContainer.innerHTML=`\n            <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                <div class="flex justify-center">\n                    <button id="wizard-back-btn" class="absolute left-6 top-6 text-black hover:text-gray-700 transition-colors z-10 text-sm font-medium">\n                        &larr; Go back\n                    </button>\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Select a payment option</h1>\n                    </div>\n                </div>\n                <div class="flex justify-center mt-8">\n                    <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                        <div class="space-y-3">\n                            <label for="billing-card" class="flex items-center p-4 border border-gray-300 rounded-md cursor-pointer has-[:checked]:ring-2 has-[:checked]:ring-blue-500 has-[:checked]:border-blue-500">\n                                <input type="radio" id="billing-card" name="billing-method" value="card" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500" checked>\n                                <span class="ml-3 block text-sm font-medium text-gray-900">Pay with Credit Card</span>\n                            </label>\n                            <label for="billing-invoice" class="flex items-center p-4 border border-gray-300 rounded-md cursor-pointer has-[:checked]:ring-2 has-[:checked]:ring-blue-500 has-[:checked]:border-blue-500">\n                                <input type="radio" id="billing-invoice" name="billing-method" value="invoice" class="h-4 w-4 text-blue-600 border-gray-300 focus:ring-blue-500">\n                                <span class="ml-3 block text-sm font-medium text-gray-900">Pay by Invoice</span>\n                            </label>\n                        </div>\n\n                        <div id="invoice-details-form" class="hidden mt-6 space-y-4 border-t border-gray-200 pt-6">\n                            <h3 class="text-lg font-medium text-gray-900">Billing Information</h3>\n                            <p class="text-sm text-gray-500">Your workspace will be activated after payment is received.</p>\n                            \n                            <div>\n                                <label for="billing-contact" class="block text-sm font-medium text-gray-700">Billing Contact Name</label>\n                                <input type="text" id="billing-contact" value="${i} ${n}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                            </div>\n                            <div>\n                                <label for="company-name" class="block text-sm font-medium text-gray-700">Company Name</label>\n                                <input type="text" id="company-name" value="${s}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                            </div>\n                            <div>\n                                <label for="billing-email" class="block text-sm font-medium text-gray-700">Billing Email</label>\n                                <input type="email" id="billing-email" value="${a}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                            </div>\n                             <div>\n                                <label for="billing-phone" class="block text-sm font-medium text-gray-700">Phone Number</label>\n                                <input type="tel" id="billing-phone" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">\n                            </div>\n                            <div>\n                                <label for="company-address" class="block text-sm font-medium text-gray-700">Address</label>\n                                <input type="text" id="company-address" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                            </div>\n                            <div class="grid grid-cols-1 gap-4 sm:grid-cols-2">\n                                <div>\n                                    <label for="company-city" class="block text-sm font-medium text-gray-700">City</label>\n                                    <input type="text" id="company-city" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                                </div>\n                                <div>\n                                    <label for="company-zip" class="block text-sm font-medium text-gray-700">ZIP / Postal Code</label>\n                                    <input type="text" id="company-zip" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                                </div>\n                            </div>\n                             <div>\n                                <label for="company-country" class="block text-sm font-medium text-gray-700">Country</label>\n                                <input type="text" id="company-country" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm" required>\n                            </div>\n                            <div>\n                                <label for="tax-id" class="block text-sm font-medium text-gray-700">Tax ID (Optional)</label>\n                                <input type="text" id="tax-id" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">\n                            </div>\n                            <div>\n                                <label for="purchase-order" class="block text-sm font-medium text-gray-700">Purchase Order (Optional)</label>\n                                <input type="text" id="purchase-order" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-sm">\n                            </div>\n                        </div>\n\n                        <div class="mt-6">\n                            <button id="next-btn" class="w-full px-4 py-2 bg-gray-800 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Next</button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `;const o=document.getElementById("billing-card"),r=document.getElementById("billing-invoice"),l=document.getElementById("invoice-details-form");o.addEventListener("change",(()=>l.classList.add("hidden"))),r.addEventListener("change",(()=>l.classList.remove("hidden"))),document.getElementById("wizard-back-btn").addEventListener("click",(()=>{this._renderNameStep(e.type,e.plan,t,e.billing_cycle,e.name)})),this.wizardContainer.querySelector("#next-btn").addEventListener("click",(()=>{if("invoice"===(r.checked?"invoice":"card")){let t=!0;if(["billing-contact","company-name","billing-email","company-address","company-city","company-zip","company-country"].forEach((e=>{const s=document.getElementById(e);s.value.trim()?s.classList.remove("border-red-500"):(s.classList.add("border-red-500"),t=!1)})),!t)return void alert("Please fill out all required billing information.");e.billing={method:"invoice",contact:document.getElementById("billing-contact").value,company:document.getElementById("company-name").value,email:document.getElementById("billing-email").value,phone:document.getElementById("billing-phone").value,address:document.getElementById("company-address").value,city:document.getElementById("company-city").value,country:document.getElementById("company-country").value,taxId:document.getElementById("tax-id").value,purchaseOrder:document.getElementById("purchase-order").value,zip:document.getElementById("company-zip").value}}else e.billing={method:"card"};this._renderConfirmationStep(e)}))}async _submitWorkspaceCreation(e){try{const t=await n.G.postData("/accounts/create-workspace/",e);if(!t.success)throw new Error(t.error||"Failed to create workspace.");t.checkout_url?window.location.href=t.checkout_url:t.invoice?this.renderInvoicePendingState(t.name,t.slug):this.renderCheckoutSuccess(t.name,t.slug)}catch(e){this.renderFailState()}}startWorkspaceCreationFlow(e,t,s,i){const n=this.wizardState.name||"";this._renderNameStep(e,t,s,i,n)}renderCheckoutSuccess(e,t){this.container.innerHTML=`\n            <div class="flex flex-col items-center justify-center min-h-screen py-12">\n                <div class="max-w-md w-full text-center">\n                    <i class="fa-solid fa-check-circle text-green-500 text-7xl"></i>\n                    <h2 class="mt-4 mb-2 text-4xl font-medium tracking-tighter text-gray-900">Congratulations!</h2>\n                    <p class="text-xl text-gray-500 mb-8">Your workspace '${e}' is ready for your team.</p>\n                    <button id="setup-button" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Setup workspace</button>\n                </div>\n            </div>`,document.getElementById("setup-button").addEventListener("click",(()=>{window.location.href=`/accounts/workspace/${t}/admin/`})),new i.N}renderFailState(){this.container.innerHTML='\n            <div class="flex flex-col items-center justify-center min-h-screen py-12">\n                <div class="max-w-md w-full text-center">\n                    <i class="fa-solid fa-circle-exclamation text-red-500 text-7xl"></i>\n                    <h2 class="mt-4 mb-2 text-4xl font-medium tracking-tighter text-gray-900">Something went wrong</h2>\n                    <p class="text-xl text-gray-500 mb-8">We couldn\'t process your request. Please try again.</p>\n                    <button id="retry-button" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Try Again</button>\n                </div>\n            </div>',document.getElementById("retry-button").addEventListener("click",(()=>window.location.href="/subscribe/"))}renderInvoicePendingState(e,t){this.container.innerHTML='\n            <div class="flex flex-col items-center justify-center min-h-screen py-12">\n                <div class="max-w-md w-full text-center">\n                    <i class="fa-solid fa-check-circle text-green-500 text-7xl"></i>\n                    <h2 class="mt-4 mb-2 text-4xl font-medium tracking-tighter text-gray-900">Your workspace is ready!</h2>\n                    <p class="text-lg text-gray-500 mb-8">You can start setting your workspace up and invite your team. You won\'t be able to use the models until we approve your trial.</p>\n                    <button id="view-workspace-button" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Setup workspace</button>\n                </div>\n            </div>',document.getElementById("view-workspace-button").addEventListener("click",(()=>{window.location.href=`/accounts/workspace/${t}/admin`})),new i.N}async renderChangePlanView(){this.wizardContainer.innerHTML='<div class="pt-20 text-center text-gray-500">Loading your plan details...</div>';try{const e=e=>({year:"annual",month:"monthly"}[e]||e);if(this.workspaceContext){const t=await n.G.fetchData("/accounts/workspace/billing-details/"),s=t.plan_type,i=["family","family_max"].includes(s)?"family":"workspace";"family"===i?"family"===s?this.currentPlan="standard":"family_max"===s&&(this.currentPlan="max"):this.currentPlan=s,this.currentCycle=e(t.billing_cycle),this.renderPlanSelection(i)}else{const t=await n.G.fetchData("/accounts/subscription-details/");this.currentPlan=t.plan_id,this.currentCycle=e(t.billing_cycle),this.renderPlanSelection("individual")}}catch(e){this.renderFailState("Error","Could not load your subscription details. Please try again later.")}}async renderReactivatePlanView(){this.wizardContainer.innerHTML='<div class="pt-20 text-center text-gray-500">Loading...</div>';try{let e,t;if(this.workspaceContext){const s=await n.G.fetchData("/accounts/workspace/billing-details/");e=s.plan_name||"your current plan",t=new Date(s.paid_until).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}else{const s=await n.G.fetchData("/accounts/subscription-details/");e=this.plans.individual[s.plan_id]?.name||"your current plan",t=new Date(s.next_billing_date).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}this.wizardContainer.innerHTML=`\n                <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Reactivate your plan</h1>\n                        <p class="text-xl text-gray-500">Welcome back! Let's get your ${e} subscription running again.</p>\n                    </div>\n                    <div class="flex justify-center mt-8">\n                        <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                            <p class="text-gray-600 text-center">Your plan is currently set to expire on <strong>${t}</strong>. Reactivating will ensure your service continues without interruption.</p>\n                            <div class="mt-6 flex flex-col sm:flex-row gap-3">\n                                <button id="go-back-btn" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full font-medium transition-colors">Go back</button>\n                                <button id="confirm-reactivate-btn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium transition-colors">Reactivate my plan</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `,document.getElementById("go-back-btn").addEventListener("click",(()=>window.location.href="/chat")),document.getElementById("confirm-reactivate-btn").addEventListener("click",(async e=>{const t=e.currentTarget;t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Reactivating...';const s=this.workspaceContext?"/accounts/workspace/reactivate-plan/":"/accounts/reactivate-subscription/",i=(this.workspaceContext,{}),a=await n.G.postData(s,i);a.success?this.renderSuccessState("Welcome back!","Your subscription is now active and will auto-renew."):this.renderFailState("Reactivation failed",a.error||"Could not reactivate your plan. Please try again.")}))}catch(e){this.renderFailState("Error","Could not load your subscription details.")}}async renderCancelPlanView(){this.wizardContainer.innerHTML='<div class="pt-20 text-center text-gray-500">Loading...</div>';try{let e,t;if(this.workspaceContext){const s=await n.G.fetchData("/accounts/workspace/billing-details/");e=s.plan_name||"your current plan",t=new Date(s.paid_until).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}else{const s=await n.G.fetchData("/accounts/subscription-details/");e=this.plans.individual[s.plan_id]?.name||"your current plan",t=new Date(s.next_billing_date).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}this.wizardContainer.innerHTML=`\n                <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Cancel your plan</h1>\n                        <p class="text-xl text-gray-500">We're sorry to see you go. Your plan will remain active until <strong>${t}</strong>.</p>\n                    </div>\n                    <div class="flex justify-center mt-8">\n                        <div class="w-full max-w-xl bg-white p-8 rounded-xl ring-1 ring-gray-200 space-y-6">\n                            \n                            <div class="space-y-1">\n                                <label for="cancellation-reason" class="block text-base font-medium text-gray-700">Why are you cancelling?</label>\n                                <select id="cancellation-reason" name="cancellation-reason" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-base">\n                                    <option value="">Please select a reason...</option>\n                                    <option value="too_expensive">It's too expensive</option>\n                                    <option value="missing_features">It's missing features I need</option>\n                                    <option value="technical_issues">I experienced technical issues or bugs</option>\n                                    <option value="not_using_enough">I'm not using it enough</option>\n                                    <option value="switched_service">I've switched to another service</option>\n                                    <option value="temporary_break">I'm just taking a temporary break</option>\n                                    <option value="other">Other</option>\n                                </select>\n                            </div>\n    \n                            <div class="space-y-1">\n                                <label for="cancellation-feedback" class="block text-base font-medium text-gray-700">Any other feedback for us? (Optional)</label>\n                                <textarea id="cancellation-feedback" name="cancellation-feedback" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-base" placeholder="Your feedback is valuable and helps us improve."></textarea>\n                            </div>\n    \n                            <div class="flex flex-col sm:flex-row gap-3">\n                                <button id="keep-plan-btn" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full font-medium transition-colors">No, keep my plan</button>\n                                <button id="confirm-cancel-btn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-full font-medium transition-colors">Yes, cancel my plan</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `,document.getElementById("keep-plan-btn").addEventListener("click",(()=>window.location.href="/chat")),document.getElementById("confirm-cancel-btn").addEventListener("click",(()=>{const s=document.getElementById("cancellation-reason"),i=document.getElementById("cancellation-feedback"),n=s.value;if(!n)return alert("Please select a reason for cancellation."),void s.focus();const a=i.value;this.showCancellationConfirmation(n,a,e,t)}))}catch(e){this.renderFailState("Error","Could not load your subscription details.")}}async renderReactivatePlanView(){this.wizardContainer.innerHTML='<div class="pt-20 text-center text-gray-500">Loading...</div>';try{let e,t;if(this.workspaceContext){const s=await n.G.fetchData("/accounts/workspace/billing-details/");e=s.plan_name||"your current plan",t=new Date(s.paid_until).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}else{const s=await n.G.fetchData("/accounts/subscription-details/");e=this.plans.individual[s.plan_id]?.name||"your current plan",t=new Date(s.next_billing_date).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}this.wizardContainer.innerHTML=`\n                <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Reactivate your plan</h1>\n                        <p class="text-xl text-gray-500">Welcome back! Let's get your ${e} subscription running again.</p>\n                    </div>\n                    <div class="flex justify-center mt-8">\n                        <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                            <p class="text-gray-600 text-center">Your plan is currently set to expire on <strong>${t}</strong>. Reactivating will ensure your service continues without interruption.</p>\n                            <div class="mt-6 flex flex-col sm:flex-row gap-3">\n                                <button id="go-back-btn" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full font-medium transition-colors">Go back</button>\n                                <button id="confirm-reactivate-btn" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-full font-medium transition-colors">Reactivate my plan</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `,document.getElementById("go-back-btn").addEventListener("click",(()=>window.location.href="/chat")),document.getElementById("confirm-reactivate-btn").addEventListener("click",(async e=>{const t=e.currentTarget;t.disabled=!0,t.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Reactivating...';const s=this.workspaceContext?"/accounts/workspace/reactivate-plan/":"/accounts/reactivate-subscription/",i=await n.G.postData(s,{});i.success?this.renderSuccessState("Welcome back!","Your subscription is now active and will auto-renew."):this.renderFailState("Reactivation failed",i.error||"Could not reactivate your plan. Please try again.")}))}catch(e){this.renderFailState("Error","Could not load your subscription details.")}}renderSuccessState(e,t,s=!1){this.container.innerHTML=`\n            <div class="flex flex-col items-center justify-center min-h-screen py-12">\n                <div class="max-w-2xl w-full text-center">\n                    <i class="fa-solid fa-check-circle text-green-500 text-7xl"></i>\n                    <h2 class="mt-4 mb-2 text-4xl font-medium tracking-tighter text-gray-900">${e}</h2>\n                    <p class="text-xl text-gray-500 mb-8">${t}</p>\n                    <a href="/chat" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">\n                        Back\n                    </a>\n                </div>\n            </div>`,s||new i.N}renderFailState(e="Something went wrong",t="We couldn't process your request. Please try again."){this.container.innerHTML=`\n            <div class="flex flex-col items-center justify-center min-h-screen py-12">\n                <div class="max-w-md w-full text-center">\n                    <i class="fa-solid fa-circle-exclamation text-red-500 text-7xl"></i>\n                    <h2 class="mt-4 mb-2 text-4xl font-medium tracking-tighter text-gray-900">${e}</h2>\n                    <p class="text-xl text-gray-500 mb-8">${t}</p>\n                    <a href="/chat" class="px-8 py-2 bg-gray-900 hover:bg-gray-700 text-white rounded-full font-medium transition-colors">Back</a>\n                </div>\n            </div>`}async renderCancelPlanView(){this.wizardContainer.innerHTML='<div class="pt-20 text-center text-gray-500">Loading...</div>';try{let e,t;if(this.workspaceContext){const s=await n.G.fetchData("/accounts/workspace/billing-details/");e=s.plan_name||"your current plan",t=new Date(s.paid_until).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}else{const s=await n.G.fetchData("/accounts/subscription-details/");e=this.plans.individual[s.plan_id]?.name||"your current plan",t=new Date(s.next_billing_date).toLocaleDateString("en-US",{month:"long",day:"numeric",year:"numeric"})}this.wizardContainer.innerHTML=`\n                <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Cancel your plan</h1>\n                        <p class="text-xl text-gray-500">We're sorry to see you go. Your plan will remain active until <strong>${t}</strong>.</p>\n                    </div>\n                    <div class="flex justify-center mt-8">\n                        <div class="w-full max-w-xl bg-white p-8 rounded-xl ring-1 ring-gray-200 space-y-6">\n                            \n                            <div class="space-y-1">\n                                <label for="cancellation-reason" class="block text-base font-medium text-gray-700">Why are you cancelling?</label>\n                                <select id="cancellation-reason" name="cancellation-reason" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-base">\n                                    <option value="">Please select a reason...</option>\n                                    <option value="too_expensive">It's too expensive</option>\n                                    <option value="missing_features">It's missing features I need</option>\n                                    <option value="technical_issues">I experienced technical issues or bugs</option>\n                                    <option value="not_using_enough">I'm not using it enough</option>\n                                    <option value="switched_service">I've switched to another service</option>\n                                    <option value="temporary_break">I'm just taking a temporary break</option>\n                                    <option value="other">Other</option>\n                                </select>\n                            </div>\n    \n                            <div class="space-y-1">\n                                <label for="cancellation-feedback" class="block text-base font-medium text-gray-700">Any other feedback for us? (Optional)</label>\n                                <textarea id="cancellation-feedback" name="cancellation-feedback" rows="4" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 sm:text-base" placeholder="Your feedback is valuable and helps us improve."></textarea>\n                            </div>\n    \n                            <div class="flex flex-col sm:flex-row gap-3">\n                                <button id="keep-plan-btn" class="w-full px-4 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-full font-medium transition-colors">No, keep my plan</button>\n                                <button id="confirm-cancel-btn" class="w-full px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-full font-medium transition-colors">Yes, cancel my plan</button>\n                            </div>\n                        </div>\n                    </div>\n                </div>\n            `,document.getElementById("keep-plan-btn").addEventListener("click",(()=>window.location.href="/chat")),document.getElementById("confirm-cancel-btn").addEventListener("click",(()=>{const s=document.getElementById("cancellation-reason"),i=document.getElementById("cancellation-feedback"),n=s.value;if(!n)return alert("Please select a reason for cancellation."),void s.focus();const a=i.value;this.showCancellationConfirmation(n,a,e,t)}))}catch(e){this.renderFailState("Error","Could not load your subscription details.")}}showCancellationConfirmation(e,t,s,i){const a="final-cancel-confirmation-modal",o=document.getElementById(a);o&&o.remove();const r=`\n            <div id="${a}" class="fixed inset-0 z-50 flex items-center justify-center p-4">\n                <div id="modal-backdrop" class="absolute inset-0 bg-black bg-opacity-60 backdrop-blur-sm"></div>\n                <div class="relative w-full max-w-md bg-white rounded-lg shadow-xl p-6 space-y-4">\n                    <h3 class="text-xl font-semibold text-gray-900">Are you absolutely sure?</h3>\n                    <p class="text-gray-600">\n                        This is your final confirmation. Your subscription will end on <strong>${i}</strong>.\n                        ${this.workspaceContext?"You will lose access to this workspace.":"Your account and all associated data (including sessions, memories, assistants, and files) will be permanently deleted."}\n                        <strong>This action is irreversible.</strong>\n                    </p>\n                    <div class="flex justify-end gap-3 pt-2">\n                        <button id="cancel-final-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300 transition-colors">Nevermind</button>\n                        <button id="confirm-final-delete" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Yes, Cancel Subscription</button>\n                    </div>\n                </div>\n            </div>\n        `;document.body.insertAdjacentHTML("beforeend",r);const l=document.getElementById(a),c=document.getElementById("confirm-final-delete"),d=document.getElementById("cancel-final-delete"),h=document.getElementById("modal-backdrop"),m=()=>{l.remove()};d.addEventListener("click",m),h.addEventListener("click",m),c.addEventListener("click",(async()=>{c.disabled=!0,c.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Processing...';const a=this.workspaceContext?"/accounts/workspace/cancel-plan/":"/accounts/cancel-subscription/",o=(this.workspaceContext,{reason:e,feedback:t}),r=await n.G.postData(a,o);if(m(),r.success){const e=this.workspaceContext?`Your subscription for ${s} has been cancelled. You will lose access on ${i}.`:`Your subscription for ${s} has been cancelled. Your account will be deleted on ${i}.`;this.renderSuccessState("Your plan has been cancelled",e,!0)}else this.renderFailState("Cancellation Failed",r.error||"Could not cancel your plan. Please try again.")}))}async handleCustomCodeSubmission(e,t,s){const i=document.getElementById(e),a=document.getElementById(t),o=document.getElementById(s),r=i.value.trim().toUpperCase();if(!r)return a.textContent="Please enter a code.",void(a.className="text-sm mt-2 text-red-500");o.disabled=!0,o.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i>',a.textContent="";try{const e=await n.G.postData("/accounts/validate-plan-code/",{plan_code:r});e.success&&e.plan?this._renderCustomPlanConfirmation(e.plan):(a.textContent=e.error||"Invalid or expired code.",a.className="text-sm mt-2 text-red-500")}catch(e){a.textContent="An error occurred. Please try again.",a.className="text-sm mt-2 text-red-500"}finally{o.disabled=!1,o.innerHTML="Apply"}}_renderCustomPlanConfirmation(e){document.getElementById("faq-container-wrapper").classList.add("hidden");const t="month"===e.billing_cycle?"/month":"/year";this.wizardState.customPlanData=e;let s="";s=e.purchase_order?`<li class="flex justify-between"><span class="text-gray-600">Purchase Order:</span> <span class="font-medium text-gray-900">${e.purchase_order}</span></li>`:'\n                <li id="po-link-container"><a href="#" id="show-po-input" class="text-sm text-blue-600 hover:underline">Enter a purchase order</a></li>\n                <li id="po-input-container" class="hidden pt-2">\n                    <div class="flex rounded-md shadow-sm">\n                        <input type="text" id="po-number-input" class="flex-1 block w-full min-w-0 rounded-none rounded-l-md border-gray-300 px-3 py-2 focus:border-blue-500 focus:ring-blue-500 sm:text-sm" placeholder="PO Number">\n                        <button id="save-po-btn" type="button" class="inline-flex items-center rounded-r-md border border-l-0 border-gray-300 bg-gray-50 px-4 py-2 text-sm font-medium text-gray-700 hover:bg-gray-100">Save</button>\n                    </div>\n                </li>\n            ';const i=e.requires_tos_acceptance?'\n            <div id="terms-container" class="flex items-start mt-4">\n                <input id="terms-checkbox" type="checkbox" class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500 mt-0.5">\n                <label for="terms-checkbox" class="ml-2 block text-sm text-gray-600">I agree to the <a href="/terms" target="_blank" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="/privacy" target="_blank" class="text-blue-600 hover:underline">Privacy Policy</a>.</label>\n            </div>':"";this.wizardContainer.innerHTML=`\n            <div class="mx-auto max-w-[1440px] px-6 sm:px-16 pt-20 sm:pt-20">\n                <div class="flex justify-center">\n                    <button id="wizard-back-btn" class="absolute left-6 top-6 text-black hover:text-gray-700 transition-colors z-10 text-sm font-medium">\n                        &larr; Back to plans\n                    </button>\n                    <div class="text-center">\n                        <h1 class="text-5xl sm:text-6xl font-bold tracking-tighter mb-2">Confirm your custom plan</h1>\n                    </div>\n                </div>\n                <div class="flex justify-center mt-8">\n                    <div class="w-full max-w-md bg-white p-8 rounded-xl ring-1 ring-gray-200">\n                        <div class="space-y-4">\n                            <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">\n                                <h3 class="text-lg font-semibold text-gray-900 mb-3">${e.name}</h3>\n                                <ul id="plan-summary-list" class="space-y-2 text-sm">\n                                    <li class="flex justify-between border-t border-gray-200 pt-2">\n                                        <span class="text-base font-semibold text-gray-800">Total:</span> \n                                        <span class="text-base font-semibold text-gray-800">$${Number(e.price).toLocaleString()} ${t}</span>\n                                    </li>\n                                    <li class="flex justify-between"><span class="text-gray-600">Max seats:</span> <span class="font-medium text-gray-900">${e.total_seats.toLocaleString()}</span></li>\n                                    <li class="flex justify-between"><span class="text-gray-600">Monthly Input Tokens:</span> <span class="font-medium text-gray-900">${e.max_input_tokens.toLocaleString()}</span></li>\n                                    <li class="flex justify-between"><span class="text-gray-600">Monthly Output Tokens:</span> <span class="font-medium text-gray-900">${e.max_output_tokens.toLocaleString()}</span></li>\n                                    <li class="flex justify-between"><span class="text-gray-600">Monthly Premium Tokens:</span> <span class="font-medium text-gray-900">${e.max_premium_generations.toLocaleString()}</span></li>\n                                    ${e.trial_days>0?`<li class="flex justify-between"><span class="text-gray-600">Trial period:</span> <span class="font-medium text-gray-900">${e.trial_days} days</span></li>`:""}\n                                    ${s}\n                                </ul>\n                            </div>\n                            ${i}\n                        </div>\n                        <div class="mt-6">\n                            <button id="confirm-custom-plan-btn" class="w-full px-4 py-2 bg-gray-800 text-white rounded-full font-medium transition-colors disabled:bg-gray-400" ${e.requires_tos_acceptance?"disabled":""}>Proceed to checkout</button>\n                            <div class="text-gray-500 text-xs text-center pt-2">Currency is USD.</div>\n                        </div>\n                    </div>\n                </div>\n            </div>\n        `,e.purchase_order||(document.getElementById("show-po-input").addEventListener("click",(e=>{e.preventDefault(),document.getElementById("po-input-container").classList.remove("hidden"),document.getElementById("po-link-container").classList.add("hidden")})),document.getElementById("save-po-btn").addEventListener("click",(()=>{const e=document.getElementById("po-number-input").value.trim();if(e){this.wizardState.customPurchaseOrder=e;document.getElementById("po-input-container").innerHTML=`<span class="text-gray-600">Purchase Order:</span> <span class="font-medium text-gray-900">${e}</span>`}})));const a=document.getElementById("confirm-custom-plan-btn");if(e.requires_tos_acceptance){const e=document.getElementById("terms-checkbox");e.addEventListener("change",(()=>{a.disabled=!e.checked}))}document.getElementById("wizard-back-btn").addEventListener("click",(()=>{delete this.wizardState.customPlanData,delete this.wizardState.customPurchaseOrder,this.renderPlanSelection("workspace")})),a.addEventListener("click",(async()=>{const t=document.getElementById("terms-checkbox");if(!e.requires_tos_acceptance||t&&t.checked){a.disabled=!0,a.innerHTML='<i class="fa-solid fa-spinner fa-spin"></i> Processing...';const t={plan_code:e.plan_code,purchase_order:this.wizardState.customPurchaseOrder||e.purchase_order||null};try{const e=await n.G.postData("/accounts/create-custom-checkout/",t);e.success&&e.checkout_url?window.location.href=e.checkout_url:e.success&&e.invoice?this.renderInvoicePendingState(e.name,e.slug):this.renderFailState("Checkout failed",e.error||"Could not create a checkout session.")}catch(e){this.renderFailState()}}}))}}},37363:(e,t,s)=>{"use strict";s.d(t,{K:()=>a});var i=s(14574),n=s(37131);class a{static themes=[{id:"light",themeName:"System Light",codeTheme:"atom-one-dark",font:"Inter",themeDescription:"A light theme with improved contrast for enhanced daytime productivity.",text:"text-zinc-800",link:"text-indigo-800",fadedText:"text-gray-700",background:"bg-gray-50",backgroundHEX:"#F9FAFB",cursorHEX:"#2563eb",ringColor:"ring-zinc-300",secondaryBackground:"bg-gray-100",modalFadeBackground:"bg-gray-700/70",overlayFadeBackground:"bg-gray-800/90",chatMenuBackground:"bg-gray-100",modalBackground:"bg-white",modalSeperationBorderColor:"border-gray-300",memoryItemRing:"ring-gray-400",lightboxBackground:"bg-white bg-opacity-90",primaryButton:"text-white bg-indigo-700 hover:bg-indigo-800",primaryButtonTransparent:"bg-indigo-100 text-indigo-800",secondaryButton:"bg-gray-200 text-gray-800 hover:bg-gray-300",secondaryButtonTransparent:"bg-gray-200 text-gray-800",linkButton:"text-indigo-700 hover:text-indigo-900",ringButton:"ring-indigo-600 text-indigo-800",ringSecondaryButton:"ring-gray-400 text-gray-800",focusButton:"bg-gray-200",codeBlockButton:"bg-gray-200 text-gray-800",secondaryRingColor:"ring-indigo-600",errorRingColor:"ring-red-600",backgroundSelected:"bg-indigo-100",ringSelected:"ring-indigo-400",unselectedSelector:"bg-gray-200",menuSelectedItem:"bg-indigo-100 text-indigo-800",menuIconColor:"text-gray-600",menuIconHoverColor:"hover:bg-gray-200",chatInputBackground:"bg-zinc-50",chatButtonEnabled:"text-indigo-900 bg-indigo-400 hover:bg-indigo-500",chatButtonDisabled:"bg-gray-300 text-gray-500",placeholderText:"placeholder:text-gray-500",switchText:"text-gray-800",listTableItem:"bg-gray-100 ring-gray-300",listTableHover:"hover:bg-gray-200",listStatusTag:"bg-gray-300 text-gray-800",inputRing:"ring-gray-300",inputBackground:"bg-white",inputText:"text-gray-800",inputFocus:"focus:ring-indigo-600",inputBorder:"border-gray-300",inputSelectedBorder:"border-indigo-600",progressBarBackground:"bg-indigo-600",sliderThumbColor:"#4338ca",sliderRailColor:"bg-gray-300",fileNameText:"text-gray-800",fileSubText:"text-gray-600",fileItemBackground:"bg-zinc-100",fileItemRing:"ring-gray-300",fileIconColor:"text-white",filePDFColor:"bg-red-600",fileImageColor:"bg-green-600",fileAudioColor:"bg-blue-600",fileVideoColor:"bg-yellow-600",fileDocColor:"bg-blue-600",fileFolderColor:"bg-blue-500",fileFolderIconColor:"text-blue-500",fileSpreadsheetColor:"bg-green-600",fileTextColor:"text-gray-100",fileOtherColor:"bg-blue-600",fileProgressBG:"bg-indigo-200",fileSessionColor:"bg-gray-100 text-gray-600",memoryPlaceholderText:"text-gray-500",memoryCrawlIconColor:"bg-blue-700",memoryVideoIconColor:"bg-red-700",conversationsSuggestion:"text-gray-700 ring-gray-400 hover:bg-gray-100",ringHover:"hover:ring-indigo-600",backgroundHover:"hover:bg-gray-50",helperHoverState:"bg-gray-200 text-black",iconColor:"text-gray-600",switchRing:"ring-gray-400",switchOn:"bg-indigo-600",switchOff:"bg-gray-400",switchIndicator:"bg-white",switchContainer:"bg-gray-200",switchFormContainer:"bg-gray-100",skillTag:"bg-indigo-100 text-indigo-800",skillContainerBG:"bg-zinc-100",toastSuccess:"bg-green-100 text-green-800 border border-green-200",toastError:"bg-red-100 text-red-800 border border-red-200",toastWarning:"bg-yellow-100 text-yellow-800 border border-yellow-200",toastInfo:"bg-blue-100 text-blue-800 border border-blue-200",focusBackground:"bg-gradient-to-t from-gray-200 to-gray-200",focusMenuHover:"hover:bg-gray-200",focusMenuItem:"bg-gray-100",focusMenuTextColor:"text-gray-800",screenCaptureBackground:"bg-white/90 ring-gray-300",markedBlockquoteBorderColor:"#3b82f6",markedBlockquoteBackgroundColor:"rgba(59, 130, 246, 0.1)",markedBlockquoteColor:"#1e3a8a",markedBlockquoteBorderRadius:"0.25rem",markedBlockquotePadding:"1em",markedBlockquoteBorderWidth:"0 0 0 4px",markedLinkColor:"#2563eb",markedLinkHoverColor:"#1d4ed8",sourceTileBackground:"bg-gray-100",sourceTileText:"text-gray-800",sourceTileFadedText:"text-gray-600",sourceTileBackgroundHover:"hover:bg-gray-200",sourceNumberBgHex:"#f3f4f6",sourceNumberBg:"bg-gray-100",sourceNumberColor:"#4b5563",sourceNumberBgHover:"hover:bg-gray-200 hover:text-gray-900",tabBackground:"bg-zinc-400/60",tabOuterRing:"ring-gray-300",tabSelectedBackground:"bg-zinc-200",tabSelectedRing:"ring-zinc-100",tabSelectedTextColor:"text-gray-800",chatTitleMenuBackground:"bg-gray-100/90",thumbtackTitleMenuSelectedColor:"text-red-700",tableBorder:"border-gray-200",tableButton:"ring-gray-300 bg-gray-100",tableButtonSelectedBackground:"bg-gray-200",tableHeaderText:"text-gray-500",tableDividerLine:"border-gray-200",tableHoverBackground:"hover:bg-gray-50",tablePrimaryColumnText:"text-gray-900",tableMenuBackground:"bg-white",tableMenuButtonHover:"sm:hover:bg-gray-100",tableCardBackground:"bg-white",tableCardBorder:"border-gray-200",tableResizeHandle:"bg-gray-900",tableShadowColumn:"bg-gradient-to-r from-gray-200 to-transparent",tableDragBackground:"bg-gray-100",loadBackground:"bg-gray-300",widgetBackground:"bg-gray-100",workspaceDefaultIcon:"bg-blue-400 text-white",cpuActionLoad:"bg-indigo-400",cpuActionClick:"bg-purple-400",cpuActionInput:"bg-blue-400",cpuActionAction:"bg-lime-500",cpuActionThinking:"bg-zinc-400",cpuActionGoal:"bg-green-400",cpuActionStop:"bg-red-400",selectMenuBackground:"bg-white",selectIconBackground:"bg-gray-300 text-black",selectItemBackground:"bg-gray-200",selectMenuRing:"ring-gray-100",selectSelectedItemBackground:"bg-gray-50",selectTagBackground:"bg-gray-100",selectBackgroundHoverColor:"hover:bg-gray-200",selectRemoveButtonHover:"hover:text-gray-700",selectRemoveButton:"text-gray-500",selectFocusedItemBackground:"bg-gray-100",selectCheckColor:"text-green-800",navTabBackgroundColor:"bg-gray-100",navTabTextColor:"text-gray-800",navTabActiveTextColor:"text-indigo-700",navTabActiveBackgroundColor:"bg-indigo-100",navTabIndicatorLight:"bg-indigo-200",mcpProgressBarBackground:"#A5B4FC",mcpProgressBarBackgroundLight:"#C7D2FE"},{id:"dark",themeName:"System dark",codeTheme:"night-owl",font:"Inter",themeDescription:"A theme for the dark, mysterious coder, with deep blues and purples.",text:"text-[#D4D4D4]",link:"text-[#569CD6]",fadedText:"text-[#999999]",background:"bg-[#1E1E1E]",backgroundHEX:"#1E1E1E",cursorHEX:"#569CD6",ringColor:"ring-[#3F3F3F]",secondaryBackground:"bg-[#2A2A2A]",modalFadeBackground:"bg-[#1E1E1E]/60",overlayFadeBackground:"bg-[#1E1E1E]/90",chatMenuBackground:"bg-[#2D2D2D]/50",modalBackground:"bg-[#2D2D2D]",modalSeperationBorderColor:"border-[#3F3F3F]",memoryItemRing:"ring-[#3F3F3F]",lightboxBackground:"bg-[#000000]/50",primaryButton:"text-[#1E1E1E] bg-[#569CD6]",primaryButtonTransparent:"text-[#569CD6] bg-[#569CD6]/30",secondaryButton:"text-[#D4D4D4] bg-[#3F3F3F]",secondaryButtonTransparent:"text-[#D4D4D4] bg-[#3F3F3F]/50",linkButton:"text-[#569CD6]",ringButton:"ring-[#569CD6] text-[#D4D4D4]",ringSecondaryButton:"ring-[#3F3F3F] text-[#D4D4D4]",focusButton:"bg-[#2D2D2D]",codeBlockButton:"bg-[#2D2D2D] text-[#D4D4D4]",secondaryRingColor:"ring-[#569CD6]",errorRingColor:"ring-[#FF3333]",backgroundSelected:"bg-[#569CD6]/10",ringSelected:"ring-[#569CD6]",unselectedSelector:"bg-[#252526]",menuSelectedItem:"bg-[#569CD6]/20 text-[#569CD6]",menuIconColor:"text-[#7A7A7A]",menuIconHoverColor:"hover:bg-[#3F3F3F] hover:text-[#D4D4D4]",chatInputBackground:"bg-[#2D2D2D]/70 ring-[#3F3F3F]",chatButtonEnabled:"bg-[#569CD6] text-white",chatButtonDisabled:"bg-[#6D6D6D] opacity-50",placeholderText:"placeholder:text-[#999999]",switchText:"text-[#D4D4D4]",listTableItem:"bg-[#2D2D2D] ring-[#3F3F3F]",listTableHover:"hover:bg-[#3A3A3A]",listStatusTag:"bg-[#484848]",inputRing:"ring-[#3F3F3F]",inputBackground:"bg-[#2D2D2D]",inputText:"text-[#D4D4D4]",inputFocus:"focus:ring-[#569CD6]",inputBorder:"border-[#4D4D4D]",inputSelectedBorder:"border-[#569CD6]",progressBarBackground:"bg-[#569CD6]",sliderThumbColor:"#FFFFFF",sliderRailColor:"bg-[#3A3A3A]",fileNameText:"text-[#D4D4D4]",fileSubText:"text-[#999999]",fileItemBackground:"bg-[#2D2D2D]",fileItemRing:"ring-[#3F3F3F]",fileIconColor:"text-white",filePDFColor:"bg-[#D14343]",fileImageColor:"bg-[#5A9E5D]",fileAudioColor:"bg-[#4A8ADF]",fileVideoColor:"bg-[#E54848]",fileDocColor:"bg-[#A36FD1]",fileFolderColor:"bg-[#4A8ADF]",fileFolderIconColor:"text-[#569CD6]",fileSpreadsheetColor:"bg-[#5A9E5D]",fileTextColor:"text-[#D4D4D4]",fileOtherColor:"bg-[#7A7A7A]",fileProgressBG:"bg-[#569CD6]",fileSessionColor:"bg-[#3A3A3A]/50 text-[#D4D4D4]",memoryPlaceholderText:"text-[#666666]",memoryCrawlIconColor:"bg-[#3399FF]",memoryVideoIconColor:"bg-[#FF3333]",conversationsSuggestion:"text-[#999999] ring-[#3F3F3F] hover:bg-[#3F3F3F]/80",ringHover:"hover:ring-[#569CD6]",backgroundHover:"hover:bg-[#2A2A2A]",helperHoverState:"bg-[#1E1E1E] text-[#569CD6]",iconColor:"text-[#C4C4C4]",switchRing:"ring-[#3F3F3F]",switchOn:"bg-[#569CD6]",switchOff:"bg-[#6D6D6D]",switchIndicator:"bg-[#2D2D2D]",switchContainer:"bg-[#3A3A3A]",switchFormContainer:"bg-[#3A3A3A]/80",skillTag:"bg-[#569CD6] text-[#1E1E1E]",skillContainerBG:"bg-[#2D2D2D]/80",toastSuccess:"bg-[#66FF66] text-[#003300]",toastError:"bg-[#FF3333] text-[#330000]",toastWarning:"bg-[#FFFF33] text-[#333300]",toastInfo:"bg-[#3399FF] text-[#003366]",focusBackground:"bg-gradient-to-t from-[#2D2D2D] to-[#1E1E1E]",focusMenuHover:"hover:bg-[#3F3F3F]/60",focusMenuItem:"bg-[#2D2D2D]",focusMenuTextColor:"text-[#D4D4D4]",screenCaptureBackground:"bg-[#1E1E1E]/70 ring-[#3F3F3F]",markedBlockquoteBorderColor:"#666666",markedBlockquoteBackgroundColor:"rgba(46, 46, 62, 0.8)",markedBlockquoteColor:"#D4D4D4",markedBlockquoteBorderRadius:"0.25rem",markedBlockquotePadding:"1em",markedBlockquoteBorderWidth:"0 0 0 4px",markedLinkColor:"#569CD6",markedLinkHoverColor:"#69A8EA",sourceTileBackground:"bg-[#2D2D2D]",sourceTileText:"text-[#D4D4D4]",sourceTileFadedText:"text-[#999999]",sourceTileBackgroundHover:"hover:bg-[#3F3F3F]",sourceNumberBgHex:"#2D2D2D",sourceNumberBg:"bg-[#2D2D2D]",sourceNumberColor:"#D4D4D4",sourceNumberBgHover:"hover:bg-[#3F3F3F] hover:text-[#D4D4D4]",tabBackground:"bg-[#2D2D2D]",tabOuterRing:"ring-[#3F3F3F]",tabSelectedBackground:"bg-[#569CD6]",tabSelectedRing:"ring-[#4FA1D0]",tabSelectedTextColor:"text-[#1E1E1E]",tabTextColor:"text-[#999999]",chatTitleMenuBackground:"bg-[#2D2D2D]/90",thumbtackTitleMenuSelectedColor:"text-[#FF3333]",tableBorder:"border-[#3F3F3F]",tableButton:"ring-[#3F3F3F] bg-[#2D2D2D]",tableButtonSelectedBackground:"bg-[#3F3F3F]",tableHeaderText:"text-[#999999]",tableDividerLine:"border-[#3F3F3F]",tableHoverBackground:"hover:bg-[#3A3A3A]",tablePrimaryColumnText:"text-[#D4D4D4] font-medium",tableMenuBackground:"bg-[#2D2D2D]",tableMenuButtonHover:"sm:hover:bg-[#3F3F3F]",tableCardBackground:"bg-[#2D2D2D]",tableCardBorder:"border-[#3F3F3F]",tableResizeHandle:"bg-[#2D2D2D]",tableShadowColumn:"bg-gradient-to-r from-[#2D2D2D] to-transparent",tableDragBackground:"bg-[#2D2D2D]",loadBackground:"bg-[#6D6D6D]",widgetBackground:"bg-[#2D2D2D]",workspaceDefaultIcon:"bg-[#3399FF] text-[#FFFFFF]",cpuActionLoad:"bg-[#569CD6]",cpuActionClick:"bg-[#B180D7]",cpuActionInput:"bg-[#3399FF]",cpuActionAction:"bg-[#66FF66]",cpuActionThinking:"bg-[#252526]",cpuActionGoal:"bg-[#569CD6]",cpuActionStop:"bg-[#FF3333]",selectMenuBackground:"bg-[#1E1E1E]",selectIconBackground:"bg-[#3A3A3A] text-[#D4D4D4]",selectItemBackground:"bg-[#3A3A3A]",selectMenuRing:"ring-[#3F3F3F]",selectSelectedItemBackground:"bg-[#3F3F3F]",selectTagBackground:"bg-[#353535]",selectBackgroundHoverColor:"hover:bg-[#3F3F3F]",selectRemoveButtonHover:"hover:text-[#D4D4D4]",selectRemoveButton:"text-[#999999]",selectFocusedItemBackground:"bg-[#3F3A3A]",selectCheckColor:"text-[#569CD6]",navTabBackgroundColor:"bg-[#2D2D2D]",navTabTextColor:"text-[#D4D4D4]",navTabActiveTextColor:"text-[#1E1E1E]",navTabActiveBackgroundColor:"bg-[#569CD6]",navTabIndicatorLight:"bg-[#6F9EF2]",mcpProgressBarBackground:"#2e23a6",mcpProgressBarBackgroundLight:"#4338CA"}];static codeThemes=[{value:"newyork",name:"New York",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789709/highlight/styles/newyork_hw15ux.css"},{value:"console",name:"Console",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789701/highlight/styles/console_hmd3ep.css"},{value:"merica",name:"Merica",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789565/highlight/styles/merica_a0yh3a.css"},{value:"a11y-dark",name:"A11y Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789706/highlight/styles/a11y-dark.min_psdme7.css"},{value:"a11y-light",name:"A11y Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789570/highlight/styles/a11y-light.min_d5q6la.css"},{value:"agate",name:"Agate",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789704/highlight/styles/agate.min_ol3khn.css"},{value:"an-old-hope",name:"An Old Hope",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789707/highlight/styles/an-old-hope.min_chposy.css"},{value:"androidstudio",name:"Android Studio",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789699/highlight/styles/androidstudio.min_zle2va.css"},{value:"arduino-light",name:"Arduino Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789584/highlight/styles/arduino-light.min_tv6sbg.css"},{value:"arta",name:"Arta",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789586/highlight/styles/arta.min_vduw8h.css"},{value:"ascetic",name:"Ascetic",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789696/highlight/styles/ascetic_xd2rga.css"},{value:"atom-one-dark-reasonable",name:"Atom One Dark Reasonable",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789707/highlight/styles/atom-one-dark-reasonable_slzdxh.css"},{value:"atom-one-dark",name:"Atom One Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789689/highlight/styles/atom-one-dark_asuyx3.css"},{value:"atom-one-light",name:"Atom One Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789685/highlight/styles/atom-one-light_tkghug.css"},{value:"brown-paper",name:"Brown Paper",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789709/highlight/styles/brown-paper_igm2zm.css"},{value:"codepen-embed",name:"CodePen Embed",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789706/highlight/styles/codepen-embed.min_dmtavh.css"},{value:"color-brewer",name:"Color Brewer",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789580/highlight/styles/color-brewer.min_gkrk78.css"},{value:"dark",name:"Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789694/highlight/styles/dark.min_ub6syj.css"},{value:"default",name:"Default",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789697/highlight/styles/default.min_vzudpq.css"},{value:"devibeans",name:"Devibeans",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789697/highlight/styles/devibeans_jgisg2.css"},{value:"docco",name:"Docco",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789695/highlight/styles/docco.min_nwtukh.css"},{value:"far",name:"Far",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789586/highlight/styles/far_r6e0xu.css"},{value:"felipec",name:"Felipec",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789700/highlight/styles/felipec_mlf3ov.css"},{value:"foundation",name:"Foundation",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789707/highlight/styles/foundation_qrdfkr.css"},{value:"github-dark-dimmed",name:"GitHub Dark Dimmed",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789569/highlight/styles/github-dark-dimmed_lcktmr.css"},{value:"github-dark",name:"GitHub Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789573/highlight/styles/github-dark.min_beevek.css"},{value:"github",name:"GitHub",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789694/highlight/styles/github.min_ad6nby.css"},{value:"gml",name:"GML",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789582/highlight/styles/gml.min_tqixfo.css"},{value:"googlecode",name:"Google Code",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789703/highlight/styles/googlecode.min_dckppq.css"},{value:"grayscale",name:"Grayscale",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789703/highlight/styles/grayscale.min_oeosbf.css"},{value:"gradient-dark",name:"Gradient Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789712/highlight/styles/gradient-dark_ztezth.css"},{value:"gradient-light",name:"Gradient Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789712/highlight/styles/gradient-light.min_nn2hlb.css"},{value:"hybrid",name:"Hybrid",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789712/highlight/styles/hybrid_ttmilc.css"},{value:"idea",name:"IDEA",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789583/highlight/styles/idea.min_hbtydg.css"},{value:"ir-black",name:"IR Black",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789705/highlight/styles/ir-black.min_hnpm7k.css"},{value:"isbl-editor-dark",name:"ISBL Editor Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789709/highlight/styles/isbl-editor-dark_lb00xl.css"},{value:"isbl-editor-light",name:"ISBL Editor Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789694/highlight/styles/isbl-editor-light.min_yotqfy.css"},{value:"kimbie-dark",name:"Kimbie Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789575/highlight/styles/kimbie-dark.min_oquxr7.css"},{value:"kimbie-light",name:"Kimbie Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789582/highlight/styles/kimbie-light.min_vvaafu.css"},{value:"lightfair",name:"Lightfair",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789705/highlight/styles/lightfair_pnbg1x.css"},{value:"magula",name:"Magula",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789699/highlight/styles/magula_tvhbjf.css"},{value:"mono-blue",name:"Mono Blue",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789577/highlight/styles/mono-blue.min_bnhwpg.css"},{value:"monokai",name:"Monokai",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789688/highlight/styles/monokai.min_cdzskd.css"},{value:"monokai-sublime",name:"Monokai Sublime",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789707/highlight/styles/monokai-sublime.min_boi8hi.css"},{value:"night-owl",name:"Night Owl",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789709/highlight/styles/night-owl_vrarhi.css"},{value:"nord",name:"Nord",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789687/highlight/styles/nord.min_a91iv2.css"},{value:"obsidian",name:"Obsidian",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789582/highlight/styles/obsidian.min_ysrnvg.css"},{value:"ocean",name:"Ocean",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789622/highlight/styles/base16/ocean.min_akevrw.css"},{value:"panda-syntax-dark",name:"Panda Syntax Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789699/highlight/styles/panda-syntax-dark_jqv8fb.css"},{value:"panda-syntax-light",name:"Panda Syntax Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789584/highlight/styles/panda-syntax-light_arehp2.css"},{value:"paraiso-dark",name:"Paraiso Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789706/highlight/styles/paraiso-dark.min_xpcfcl.css"},{value:"paraiso-light",name:"Paraiso Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789697/highlight/styles/paraiso-light_gty7pr.css"},{value:"pojoaque",name:"Pojoaque",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789581/highlight/styles/pojoaque.min_ruzd3g.css"},{value:"purebasic",name:"PureBasic",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789587/highlight/styles/purebasic.min_gnf48g.css"},{value:"qtcreator-dark",name:"Qt Creator Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789694/highlight/styles/qtcreator-dark.min_lupsga.css"},{value:"qtcreator-light",name:"Qt Creator Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789565/highlight/styles/qtcreator-light.min_ukemfl.css"},{value:"rainbow",name:"Rainbow",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789697/highlight/styles/rainbow_f7smof.css"},{value:"routeros",name:"RouterOS",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789581/highlight/styles/routeros.min_tq1atq.css"},{value:"school-book",name:"School Book",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789708/highlight/styles/school-book_pmtwot.css"},{value:"shades-of-purple",name:"Shades of Purple",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789574/highlight/styles/shades-of-purple.min_g4zsct.css"},{value:"srcery",name:"Srcery",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789565/highlight/styles/srcery.min_mysabn.css"},{value:"stackoverflow-dark",name:"Stack Overflow Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789571/highlight/styles/stackoverflow-dark.min_lujfwu.css"},{value:"stackoverflow-light",name:"Stack Overflow Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789576/highlight/styles/stackoverflow-light.min_arcdcg.css"},{value:"sunburst",name:"Sunburst",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789706/highlight/styles/sunburst.min_qcmjkg.css"},{value:"tokyo-night-dark",name:"Tokyo Night Dark",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789576/highlight/styles/tokyo-night-dark_jy4a6f.css"},{value:"tokyo-night-light",name:"Tokyo Night Light",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789580/highlight/styles/tokyo-night-light_m1zun6.css"},{value:"tomorrow-night-blue",name:"Tomorrow Night Blue",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789568/highlight/styles/tomorrow-night-blue.min_hn4xdm.css"},{value:"tomorrow-night-bright",name:"Tomorrow Night Bright",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789700/highlight/styles/tomorrow-night-bright.min_wgwfms.css"},{value:"vs",name:"Visual Studio",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789586/highlight/styles/vs_pcjsah.css"},{value:"vs2015",name:"Visual Studio 2015",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789569/highlight/styles/vs2015.min_peboys.css"},{value:"xcode",name:"Xcode",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789567/highlight/styles/xcode.min_azl7uj.css"},{value:"xt256",name:"xt256",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789584/highlight/styles/xt256_skisuc.css"},{value:"rabbit",name:"Rabbit r1",css:"https://res.cloudinary.com/dimqqmfx6/raw/upload/v1738789576/highlight/styles/rabbit_ss4rw7.css"}];static _user=window.user;static signOut(){window.location.href="/accounts/logout/"}static get theme(){switch(window.theme_pref){case"custom":return window.theme||(a.themes&&a.themes.length>0?a.themes[0]:{});case"dark":default:return a.themes[1];case"light":return a.themes[0];case"auto":return window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?a.themes[1]:a.themes[0]}}static displayName(){return a._user?a._user.first_name&&a._user.last_name?`${a._user.first_name} ${a._user.last_name}`:a._user.email?a._user.email:"Unknown":"Unknown"}static async getSelectedWorkspace(){let e;return n.a.config?e=n.a.config:a._user&&a._user.billing.plan&&"None"!==a._user.billing.plan&&(e={name:"Personal"}),e}static async fetchModels(e=!1){if(!e)return window.initial_models;try{const e=await i.G.fetchData("/chat/models/");return this.models=e.models,window.initial_models=e.models,e.models}catch(e){throw e}}static async getUsageLog(){try{return await i.G.postData("/accounts/usage-log/",{})}catch(e){throw e}}static async getRechargeData(){try{return await i.G.fetchData("/accounts/recharge-summary/")}catch(e){return null}}static async updateAutomaticRecharge(e){try{return await i.G.postData("/accounts/update-automatic-recharge/",{state:e})}catch(e){throw e}}static async getInvoices(){try{return(await i.G.fetchData("/accounts/invoices/")).invoices||[]}catch(e){throw e}}static async recharge(e){try{return await i.G.postData("/accounts/recharge/",{type:e})}catch(e){throw e}}static async getUsageData(){try{const e=await i.G.postData("/accounts/usage-stats/");if(!e.success)throw new Error(e.error||"Failed to fetch usage data");const t=e.data;return t.plan_details.reset_date=new Date(t.plan_details.reset_date),t.plan_details.next_reset=new Date(t.plan_details.next_reset),t.formatted={reset_date:t.plan_details.reset_date.toLocaleDateString("en-US",{day:"numeric",month:"short",year:"numeric"}),next_reset:t.plan_details.next_reset.toLocaleDateString("en-US",{day:"numeric",month:"short",year:"numeric"}),current_usage:{frontier_input_tokens:t.current_usage.frontier_input_tokens.toLocaleString(),frontier_output_tokens:t.current_usage.frontier_output_tokens.toLocaleString(),premium_images:t.current_usage.premium_images.toLocaleString()},limits:{frontier_input_tokens:t.limits.frontier_input_tokens.toLocaleString(),frontier_output_tokens:t.limits.frontier_output_tokens.toLocaleString(),premium_images:t.limits.premium_images.toLocaleString()}},t}catch(e){throw e}}static async fetchAssistants(e){if(!e)return window.initial_assistants;try{const e=await i.G.fetchData("/chat/assistants/");return this.assistants=e.assistants,window.initial_assistants=e.assistants,e.assistants}catch(e){throw e}}static async updateAssistantSelector(){try{const e=await i.G.fetchData("/chat/assistants/update-selector/");return this.assistants=e.assistants,window.initial_assistants=e.assistants,document.dispatchEvent(new CustomEvent("assistant-list-updated")),e.assistants}catch(e){throw e}}static async fetchConversations(e=1){try{const t="/chat/chats/",s={page:e};return await i.G.postData(t,s)}catch(e){throw e}}static async getObjectPermissions(e,t){try{const s={object_type:e,object_id:t};return await i.G.postData("/chat/get_object_permissions/",s)}catch(e){throw e}}static async getSkillManifest(e){try{return(await i.G.fetchData(`/chat/skills/${e}/manifest/`)).manifest}catch(e){throw e}}static async getProRataUpgradeAmount(e){try{return await i.G.postData("/accounts/pro-rata/",{price_id:e})}catch(e){throw e}}static async updateObjectPermissions(e){try{return await i.G.postData("/chat/update_object_permissions/",e)}catch(e){throw e}}static available_skills=window.skills_manifest;static skills_menu=window.skills_menu;static isMobile(){const e=window.innerWidth<768,t=navigator.userAgent||"",s=/android|webos|iphone|ipod|blackberry|iemobile|opera mini/i.test(t.toLowerCase());return e&&s||this.isIPad()}static isIPad(){const e=navigator.userAgent||"",t=!!navigator.userAgentData?.mobile&&"iPad"===navigator.userAgentData.platform,s=e.includes("Macintosh")&&navigator.maxTouchPoints>1,i=/iPad/i.test(e);return t||s||i}static isStandAlone(){return window.matchMedia("(display-mode: standalone)").matches||!0===window.navigator.standalone}static set user(e){a._user=e}static get user(){return a._user}static get profileImage(){return a._user.profileImage}static get role(){return a._user.role}static get name(){return a._user.name}static get isOnTouchDevice(){return"ontouchstart"in window||navigator.maxTouchPoints}static get isOnIOS(){const e=window.navigator.userAgent.toLowerCase(),t=/ipad|iphone|ipod/.test(e),s=/mac os/.test(e);return t||s&&navigator.maxTouchPoints>1}static get email(){return a._user.email}static get defaultAssistant(){if(this.assistants)return this.assistants.find((e=>e.selected));{this.assistants=window.initial_assistants;const e=this.assistants.find((e=>e.selected));return e||null}}static async getAssistant(e){try{return(await i.G.fetchData(`/chat/assistants/${e}/get/`)).assistant}catch(e){throw e}}static async getKnowledgeGraph(){const e=a.defaultAssistant.id;try{return(await i.G.fetchData(`/chat/assistants/${e}/knowledge-graph/`)).knowledge_graph_items}catch(e){throw e}}static async clearKnowledgeGraph(){const e=a.defaultAssistant.id;try{return await i.G.fetchData(`/chat/assistants/${e}/knowledge-graph/clear-knowledge-graph/`)}catch(e){throw e}}static async toggleKnowledgeGraphOn(){const e=a.defaultAssistant.id;try{return await i.G.fetchData(`/chat/assistants/${e}/knowledge-graph/on/`)}catch(e){throw e}}static async toggleKnowledgeGraphOff(){const e=a.defaultAssistant.id;try{return await i.G.fetchData(`/chat/assistants/${e}/knowledge-graph/off/`)}catch(e){throw e}}static async deleteKnowledgeGraphItem(e){const t=a.defaultAssistant.id;try{return await i.G.fetchData(`/chat/assistants/${t}/knowledge-graph/${e}/delete/`)}catch(e){throw e}}static async getPersonalizationData(){try{return await i.G.fetchData("/accounts/get-personalization-data/")}catch(e){throw e}}static async savePersonalizationData(e){try{return await i.G.postData("/accounts/save-personalization-data/",e)}catch(e){throw e}}static async updateSessionState(e){try{const t=await i.G.postData("/accounts/save-session-tab-state/",{session_tab_state:e});return window.session_tab_state=e,t}catch(e){throw e}}static hasPermission(e){return!window.workspace||a._user.permissions.includes(e)}static async getAvailableThemes(){try{const e=await i.G.fetchData("/accounts/available_themes/");if("success"===e.status&&e.themes)return e.themes;throw new Error(e.message||"No themes returned from server")}catch(e){return[]}}static async getThemeMode(){try{const e=await i.G.fetchData("/accounts/theme_mode/");if("success"===e.status&&e.mode)return e.mode;throw new Error(e.message||"No theme mode returned from server")}catch(e){return"auto"}}static async toggleModelFavorite(e,t){try{const s={model_id:e,is_favorite:t};return await i.G.postData("/accounts/toggle_model_favorite/",s)}catch(e){throw e}}static async getPaymentMethods(){try{return(await i.G.fetchData("/accounts/payment-methods/")).payment_methods||[]}catch(e){throw e}}static async setDefaultPaymentMethod(e){try{return await i.G.postData("/accounts/payment-methods/set-default/",{payment_method_id:e})}catch(e){throw e}}static async deletePaymentMethod(e){try{return await i.G.postData("/accounts/payment-methods/delete/",{payment_method_id:e})}catch(e){throw e}}}},37131:(e,t,s)=>{"use strict";s.d(t,{a:()=>n});var i=s(14574);class n{static setWorkspace=null;static get workspaceContext(){return window.workspace_context}static get config(){return window.workspace?window.workspace:null}static get theme(){return window.workspace?window.workspace.theme:null}static get featuredSkills(){return window.workspace?window.workspace.featured_skills:[]}static async stopTask(e){try{const t={task_uuid:e};return await i.G.postData("/chat/stop-task/",t)}catch(e){return{}}}static async getComputerActivities(e,t){try{const s={task_uuid:e,chat_id:t};return await i.G.postData("/chat/get-computer-activities/",s)}catch(e){return{}}}static async getWorkspaces(){try{return this.workspaces=await i.G.fetchData("/accounts/get-workspaces/"),this.workspaces}catch(e){return[]}}static async getSeatData(){try{return await i.G.fetchData("/accounts/get-seat-data/")}catch(e){return{}}}static async setGettingStarted(e){try{const t={state:e};return await i.G.postData("/accounts/set-getting-started/",t)}catch(e){return{}}}static async getWorkspace(e){try{const t={slug:e};return await i.G.postData("/accounts/get-workspace/",t)}catch(e){return{}}}static async exportLogs(e){try{const t=await i.G.postDataWithBlob("/accounts/export-logs/",e);return{success:!0,url:window.URL.createObjectURL(t)}}catch(e){throw e}}static async getAvailableSeats(e){try{const t={slug:e};return await i.G.postData("/accounts/get-available-seats/",t)}catch(e){return{}}}static async getWorkspaceBillingPortal(){try{return await i.G.fetchData("/accounts/workspace-billing-portal/")}catch(e){return{}}}static async updateCustomSupport(e){try{return await i.G.postData("/accounts/update-custom-support/",e)}catch(e){throw e}}static async updateSeatCount(e){try{const t={seatsToAddOrRemove:e};return await i.G.postData("/accounts/modify-seats/",t)}catch(e){return{}}}static async getProRataAmount(e){try{const t={seatsToAdd:e};return await i.G.postData("/accounts/get-pro-rata-amount/",t)}catch(e){return{}}}static async revokeMemberAccess(e,t){try{const s={slug:e,memberId:t};return await i.G.postData("/accounts/revoke-member-access/",s)}catch(e){return{}}}static async addMembers(e,t){try{const s={emails:e,slug:t};return await i.G.postData("/accounts/invite-members/",s)}catch(e){return{}}}static async reactivateMember(e,t){try{const s={slug:e,memberId:t};return await i.G.postData("/accounts/reactivate-member/",s)}catch(e){return{}}}static async resendInvite(e,t){try{const s={slug:e,email:t};return await i.G.postData("/accounts/resend-invite/",s)}catch(e){return{}}}static async cancelInvite(e,t){try{const s={slug:e,email:t};return await i.G.postData("/accounts/cancel-invite/",s)}catch(e){return{}}}static async getMembers(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-members/",s)}catch(e){return{}}}static async getMemberList(e,t=null){try{const s={slug:e,existingTeamId:t};return await i.G.postData("/accounts/get-member-list/",s)}catch(e){return{}}}static async getMemberUsage(e,t){try{const s={slug:e,member_id:t};return await i.G.postData("/accounts/workspace/members/usage/",s)}catch(e){return{success:!1,error:"Failed to fetch usage data."}}}static async updateMemberLimits(e,t,s){try{const n={slug:e,member_id:t,limits:s};return await i.G.postData("/accounts/workspace/members/limits/",n)}catch(e){return{success:!1,error:"Failed to update limits."}}}static async getMemberList(e,t=null){try{const s={slug:e,existingTeamId:t};return await i.G.postData("/accounts/get-member-list/",s)}catch(e){return{}}}static async getMemberRole(e,t){try{const s={slug:e,memberId:t};return await i.G.postData("/accounts/get-member-role/",s)}catch(e){return{}}}static async changeMemberRole(e,t,s){try{const n={slug:e,memberId:t,roleId:s};return await i.G.postData("/accounts/change-member-role/",n)}catch(e){return{}}}static async getPaymentMethods(){return i.G.fetchData("/accounts/workspace/payment-methods/")}static async setupPaymentMethod(){return i.G.postData("/accounts/workspace/payment-methods/setup/",{})}static async confirmPaymentMethod(e){return i.G.postData("/accounts/workspace/payment-methods/confirm/",{setup_intent_id:e})}static async setDefaultPaymentMethod(e){return i.G.postData("/accounts/workspace/payment-methods/set-default/",{payment_method_id:e})}static async deletePaymentMethod(e){return i.G.postData("/accounts/workspace/payment-methods/delete/",{payment_method_id:e})}static async transferOwnership(e){try{const t={memberId:e};return await i.G.postData("/accounts/transfer-ownership/",t)}catch(e){return{}}}static async getMemberTeams(e,t){try{const s={slug:e,memberId:t};return await i.G.postData("/accounts/get-member-teams/",s)}catch(e){return{}}}static async getWorkspaceTeams(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-teams/",s)}catch(e){return{}}}static async getWorkspaceRoles(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-roles/",s)}catch(e){return{}}}static async getWorkspacePermissionsManifest(e){try{const t={slug:e};return await i.G.postData("/accounts/get-permissions-manifest/",t)}catch(e){return{}}}static async createRole(e,t){try{const s={slug:e,payload:t};return await i.G.postData("/accounts/create-role/",s)}catch(e){return{}}}static async updateRole(e,t){try{const s={slug:e,payload:t};return await i.G.postData("/accounts/update-role/",s)}catch(e){return{}}}static async deleteRole(e,t){try{const s={slug:e,roleId:t};return await i.G.postData("/accounts/delete-role/",s)}catch(e){return{}}}static async getRoleModalData(e){try{const t={role_id:e};return await i.G.postData("/accounts/get-role-modal-data/",t)}catch(e){return{}}}static async createOrEditTeam(e){try{return await i.G.postData("/accounts/create-team/",e)}catch(e){return{}}}static async deleteTeam(e,t){try{const s={slug:e,teamId:t};return await i.G.postData("/accounts/delete-team/",s)}catch(e){return{}}}static async updateMemberTeams(e){try{return await i.G.postData("/accounts/update-member-teams/",e)}catch(e){return{}}}static async getWorkspaceModels(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-workspace-models/",s)}catch(e){return{}}}static async getWorkspaceSkills(e,t){try{const s={slug:e,params:{page:t.page||1,itemsPerPage:t.itemsPerPage||50,sortColumn:t.sortColumn||"name",sortOrder:t.sortOrder||"asc",search:t.search||"",filter:t.filter||"all"}};return await i.G.postData("/accounts/get-workspace-skills/",s)}catch(e){throw e}}static async updateSkillStatus(e,t,s){try{const n={slug:e,skill_id:t,action:s?"enable":"disable"},a=await i.G.postData("/accounts/update-skill-status/",n);return{success:a.success,skill:a.skill}}catch(e){throw e}}static async updateSkillFeatured(e,t,s){try{const n={slug:e,skill_id:t,featured:s},a=await i.G.postData("/accounts/update-skill-featured/",n);return{success:a.success,skill:a.skill}}catch(e){throw e}}static async getAllSkillIds(e,t){try{const s={slug:e,params:{sortColumn:t.sortColumn,sortOrder:t.sortOrder,search:t.search,filter:t.filter}},n=await i.G.postData("/accounts/get-all-skill-ids/",s);return{success:n.success,ids:n.ids}}catch(e){throw e}}static async getWorkspaceMCPs(e,t){try{const s={slug:e,params:{page:t.page||1,itemsPerPage:t.itemsPerPage||50,sortColumn:t.sortColumn||"name",sortOrder:t.sortOrder||"asc",search:t.search||"",filter:t.filter||"all"}};return await i.G.postData("/accounts/get-workspace-mcps/",s)}catch(e){throw e}}static async getAllMCPIds(e,t){try{const s={slug:e,params:{sortColumn:t.sortColumn,sortOrder:t.sortOrder,search:t.search,filter:t.filter}},n=await i.G.postData("/accounts/get-all-mcp-skill-ids/",s);return{success:n.success,ids:n.ids}}catch(e){throw e}}static async getWorkspaceThemes(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-workspace-themes/",s)}catch(e){return{}}}static async createTheme(e){try{return await i.G.postData("/accounts/create-workspace-theme/",e)}catch(e){return{}}}static async updateTheme(e){try{return await i.G.postData("/accounts/update-theme/",e)}catch(e){throw e}}static async updateThemeStatus(e){try{return await i.G.postData("/accounts/update-theme-status/",e)}catch(e){throw e}}static async deleteTheme(e){try{return await i.G.postData("/accounts/delete-theme/",e)}catch(e){throw e}}static async getWorkspaceTheme(e,t){try{const s={slug:e,themeId:t};return await i.G.postData("/accounts/get-workspace-theme/",s)}catch(e){throw e}}static async updateWorkspaceImage(e){try{return await i.G.postData("/accounts/update-workspace-image/",e)}catch(e){throw e}}static async updateWorkspaceFavicon(e){try{return await i.G.postData("/accounts/update-workspace-favicon/",e)}catch(e){throw e}}static async updateWorkspaceName(e){try{return await i.G.postData("/accounts/update-workspace-name/",e)}catch(e){throw e}}static async getAvailableThemes(e){try{return await i.G.postData("/accounts/get-available-themes/",{workspace:e})}catch(e){throw e}}static async updateDefaultTheme(e){try{return await i.G.postData("/accounts/update-default-theme/",e)}catch(e){throw e}}static async updateWorkspaceSlug(e){try{return await i.G.postData("/accounts/update-workspace-slug/",e)}catch(e){throw e}}static async verifyCustomDomain(e){try{return await i.G.postData("/accounts/verify-custom-domain/",e)}catch(e){throw e}}static async updateCustomDomain(e){try{return await i.G.postData("/accounts/update-custom-domain/",e)}catch(e){throw e}}static async removeCustomDomain(e){try{return await i.G.postData("/accounts/remove-custom-domain/",e)}catch(e){throw e}}static async verifyCustomDomain(e){try{return await i.G.postData("/accounts/verify-custom-domain/",e)}catch(e){throw e}}static async addAllowedDomain(e){try{return await i.G.postData("/accounts/add-allowed-domain/",e)}catch(e){throw e}}static async removeAllowedDomain(e){try{return await i.G.postData("/accounts/remove-allowed-domain/",e)}catch(e){throw e}}static async updateDomainJoin(e){try{return await i.G.postData("/accounts/update-domain-join/",e)}catch(e){throw e}}static async updateModelStatus(e,t,s){try{const n={slug:e,model_id:t,action:s?"enable":"disable"};return{success:(await i.G.postData("/accounts/update-model-status/",n)).success}}catch(e){throw e}}static async forkModel(e,t){try{const s=await i.G.postData("/accounts/fork-model/",{slug:e,payload:t});return{success:s.success,message:s.message,model:s.model}}catch(e){throw e}}static async updateModel(e,t,s){try{const n=await i.G.postData("/accounts/update-workspace-model/",{slug:e,modelId:t,payload:s});return{success:n.success,message:n.message,model:n.model}}catch(e){throw e}}static async deleteModel(e,t){try{const s=await i.G.postData("/accounts/delete-workspace-model/",{slug:e,id:t});return{success:s.success,message:s.message}}catch(e){throw e}}static async deleteWorkspace(e,t){try{const t=await i.G.postData("/accounts/delete-workspace/",{slug:e});return{success:t.success,message:t.message}}catch(e){throw e}}static async getShareableUsersAndTeams(e,t){try{const s={object_type:e,object_id:t},n=await i.G.postData("/accounts/get-shareable-users-and-teams/",s);return{users:(n.users||[]).map((e=>({id:e.id,label:e.name||e.email,image:e.picture_url,icon:e.picture_url?null:"fa-solid fa-user",type:"user",data:e}))),teams:(n.teams||[]).map((e=>({id:e.id,label:e.name,icon:"fa-solid fa-people-group",type:"team",data:e})))}}catch(e){return{users:[],teams:[]}}}static async getWorkspaceAssistants(e,t){try{const s={slug:e,params:t};return await i.G.postData("/accounts/get-workspace-assistants/",s)}catch(e){return{}}}static async unshareAssistant(e){try{const t={assistant_id:e};return await i.G.postData("/accounts/unshare-assistant/",t)}catch(e){throw e}}static async getWorkspaceDefaultAssistantOptions(e){try{const t={slug:e};return await i.G.postData("/accounts/get-workspace-default-assistant-options/",t)}catch(e){return{}}}static async getDefaultModelOptions(e){try{const t={slug:e};return await i.G.postData("/accounts/get-default-model-options/",t)}catch(e){throw e}}static async updateDefaultModel(e,t){try{return await i.G.postData("/accounts/update-default-model",{model_id:t,slug:e})}catch(e){throw e}}static async updateDefaultAssistant(e){try{return await i.G.postData("/accounts/update-default-assistant/",e)}catch(e){throw e}}static async getWorkspaceAnalytics(e,t=30,s="day"){try{const n={workspace:e,timeRange:t,groupBy:s};return await i.G.postData("/accounts/get-workspace-analytics/",n)}catch(e){return{success:!1,error:"Failed to fetch analytics"}}}static async getLogs(e,t={}){try{const s={workspace:e,category:t.category||"",users:t.users||[],dateRange:t.dateRange||"24h",page:t.page||1};return await i.G.postData("/accounts/get-workspace-logs/",s)}catch(e){return{success:!1,error:"Failed to fetch logs",results:[],total:0,page:1,has_next:!1,has_previous:!1}}}static async getBillingData(){try{return await i.G.fetchData("/accounts/get-billing-data/")}catch(e){return{}}}static async updateAutomaticRecharge(e,t,s){try{return await i.G.postData("/accounts/update-workspace-automatic-recharge/",{enabled:e,token_plan:t,premium_plan:s})}catch(e){throw e}}static async recharge(e){try{return await i.G.postData("/accounts/workspace-recharge/",{plan_key:e})}catch(e){throw e}}static _workspace={name:window.workspace&&window.workspace.name?window.workspace.name:"Personal",brand:window.workspace&&window.workspace.image?window.workspace.image:`${window.STATIC_URL}img/meta.png`,slug:window.workspace&&window.workspace.slug?window.workspace.slug:"personal"};static set workspace(e){n._workspace=e}static get workspace(){return n._workspace}static get brandImage(){return n._workspace.brandImage}static get seats(){return n._workspace.seats}static get name(){return n._workspace.name}static hasFeatureEnabled(e){return n._workspace.features.includes(e)}}},12424:(e,t,s)=>{"use strict";var i=s(91326),n=s(57292),a=s(14574),o=s(99273),r=s(99217),l=s(2430);class c{constructor(){this.primaryContent=document.getElementById("primary-content"),this.theme=i.A.theme,this.workspace=window.workspace,window.error?this.showErrorScreen():(this.assistant=window.sharing_context.assistant,this.access_level=window.sharing_context.access_level,this.is_owner=window.sharing_context.is_owner,this.init())}init(){this.primaryContent.innerHTML="";const e=document.createElement("div");e.className="flex justify-center w-full py-8";const t=document.createElement("img");this.workspace?.image&&(t.src=this.workspace.image,t.alt=this.workspace.name,t.className="w-[70px] rounded-md",e.appendChild(t));const s=document.createElement("div");s.className="flex flex-col items-center justify-center p-4";const i=document.createElement("div");i.className=`${this.theme.modalBackground} rounded-lg shadow-lg max-w-xl w-full p-8`;const a=document.createElement("div");a.className="flex gap-6";const o=document.createElement("div");o.className="w-28 h-28 flex-shrink-0 rounded-full overflow-hidden";const c=document.createElement("img");c.src=this.assistant.img_url,c.alt=this.assistant.name,c.className="w-full h-full object-cover",o.appendChild(c);const d=document.createElement("div");d.className="flex justify-center align-middle items-center";const h=document.createElement("div");h.className="flex flex-col flex-grow";const m=document.createElement("div");if(m.className=`text-2xl font-bold ${this.theme.text} mb-0.5`,m.textContent=this.assistant.name,h.appendChild(m),this.assistant.description){const e=document.createElement("div");e.className=`${this.theme.fadedText} mb-0.5`,e.textContent=this.assistant.description,h.appendChild(e)}const u=document.createElement("div");u.className=`text-sm ${this.theme.fadedText} mb-0.5`,u.textContent=`Created by ${this.assistant.owner}`,h.appendChild(u),d.appendChild(h);const p=document.createElement("div");p.className="mt-6",a.appendChild(o),a.appendChild(d),i.appendChild(a),i.appendChild(p),s.appendChild(i);const g=document.createElement("div");g.className="flex justify-center mt-4 text-sm";const f=document.createElement("div");f.className="inline-flex items-center px-4 py-2 rounded-md cursor-default select-none "+(this.access_level.is_public||this.access_level.is_public_share?"bg-green-100 text-green-800":this.access_level.is_workspace?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800");const v=l.A.name((()=>this.access_level.is_public?"globe":this.access_level.is_workspace?"buildings":this.access_level.is_public_share?"unlock":"lock")()),y=new r.I({pathData:v.path,viewBox:v.viewBox,sizeClasses:"w-4 h-4 mr-2",colorClass:"fill-current"}),w=document.createElement("span");w.textContent=this.access_level.is_public?"Shared publicly":this.access_level.is_workspace?`Shared with everyone at ${this.workspace.name}`:this.access_level.is_public_share?"Open source":"Shared with you",f.appendChild(y.element),f.appendChild(w),g.appendChild(f),this.primaryContent.appendChild(e),this.primaryContent.appendChild(s),this.primaryContent.appendChild(g);const b=l.A.name("plus"),C={text:"Add assistant",type:"primary",size:"large",svgPathData:b.path,svgViewBox:b.viewBox,width:"full"};this.addAssistantButton=new n.$(C),this.addAssistantButton.render(p),this.addAssistantButton.onClick((()=>{this.addAssistantToWorkspace()}))}async addAssistantToWorkspace(){this.addAssistantButton.toggleLoading("Adding assistant...");try{const e=await a.G.postData("/chat/assistants/add-shared",{id:this.assistant.id});e.success?window.location.href=e.url:new o.y("Failed to add assistant","error")}catch(e){new o.y("Failed to add assistant","error")}finally{this.addAssistantButton.toggleLoading(!1)}}showErrorScreen(){this.primaryContent.innerHTML="";const e=document.createElement("div");e.className="flex justify-center w-full py-8";const t=document.createElement("img");this.workspace?.image?(t.src=this.workspace.image,t.alt=this.workspace.name,t.className="w-[70px] rounded-md"):(t.src="https://res.cloudinary.com/dimqqmfx6/image/upload/v1738751843/assets/stbrandblack_lhg8iw.svg",t.alt="Simtheory",t.className="h-8 text-black"),e.appendChild(t);const s=document.createElement("div");s.className="flex flex-col items-center justify-center p-4";const i=document.createElement("div");i.className=`${this.theme.modalBackground} rounded-lg shadow-lg max-w-xl w-full p-8 text-center`;const n=document.createElement("div");n.className="text-red-500 text-5xl mb-4";const a=l.A.name("error"),o=new r.I({pathData:a.path,viewBox:a.viewBox,sizeClasses:"w-12 h-12",colorClass:"fill-current"});n.appendChild(o.element);const c=document.createElement("h2");c.className=`text-2xl font-bold ${this.theme.text} mb-3`,c.textContent="This assistant cannot be found";const d=document.createElement("p");d.className=`${this.theme.fadedText} mb-6`,d.textContent="The assistant you are trying to access is not available. The owner may have deleted it or it may no longer be shared with you.";const h=document.createElement("div");h.className="flex justify-center",i.appendChild(n),i.appendChild(c),i.appendChild(d),i.appendChild(h),s.appendChild(i),this.primaryContent.appendChild(e),this.primaryContent.appendChild(s)}}document.addEventListener("DOMContentLoaded",(()=>{new c}))},91326:(e,t,s)=>{"use strict";s.d(t,{A:()=>c,S:()=>r});var i=s(37363),n=s(14574),a=s(99273),o=s(37131);class r{static selectedTheme=i.K.theme||"light";constructor(){this._theme=i.K.theme,this._theme?this.initializeTheme():this.setFont(this._theme.font)}async ensureThemeStyles(){if(!this._theme?.id||"light"===this._theme.id||"dark"===this._theme.id)return;const e=this._theme.id,t=`theme-${e}-styles`,s=(new Date).getTime(),i=document.getElementById(t);return i&&i.remove(),new Promise(((i,n)=>{const a=document.createElement("link");a.id=t,a.rel="stylesheet",a.href=`/accounts/themes/${e}/css/?v=${s}`,document.querySelector('link[href*="tailwind"]')?.after(a),a.onload=()=>{i()},a.onerror=e=>{n(e)},document.head.appendChild(a)}))}initializeTheme(){this.setFont(this._theme.font),this.ensureThemeStyles(),this.codeTheme=this._theme?.codeTheme||"atom-one-dark-reasonable",this.injectCodeStyleSheet(this.codeTheme),this.setDynamicCSS(),this.applyThemeStyles()}applyThemeStyles(){const e=document.querySelector("body"),t=["overflow-hidden"];this._theme.background&&t.push(this._theme.background),this._theme.text&&t.push(this._theme.text),e.className=t.join(" ");let s=document.querySelector('meta[name="theme-color"]');s||(s=document.createElement("meta"),s.name="theme-color",document.head.appendChild(s)),s.content=this._theme.backgroundHEX}setFont(e,t="400",s="450"){e||(e="Inter");const i=e.trim(),n="inter"===i.toLowerCase(),a=document.getElementById("google-fonts-link");if(n){const e="400",t="400";a&&a.remove(),document.documentElement.style.setProperty("--font-family",'-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol",sans-serif'),document.documentElement.style.setProperty("--font-weight-regular",e),document.documentElement.style.setProperty("--font-weight-bold",t),document.documentElement.setAttribute("data-font-system","true");const s=document.body.className.split(" ").filter(Boolean).map((e=>e.startsWith("font-[")||e.startsWith("font-")?"font-sans":e));return void(document.body.className=s.join(" "))}if(!a)return;const o=i.replace(/ /g,"+");a.href=`https://fonts.googleapis.com/css2?family=${o}:wght@${t};${s}&display=swap`,document.documentElement.style.setProperty("--font-family",`'${i}', sans-serif`),document.documentElement.style.setProperty("--font-weight-regular",t),document.documentElement.style.setProperty("--font-weight-bold",s),document.documentElement.removeAttribute("data-font-system");const r=document.body.className.split(" ").filter(Boolean).map((e=>e.startsWith("font-[")?`font-[${i.replace(/ /g,"_")} ]`:e.startsWith("font-")?`font-[${t}]`:e));document.body.className=r.join(" ")}setDynamicCSS(){const e=this._theme;document.documentElement.style.setProperty("--bg-color",e.backgroundHEX),document.documentElement.style.setProperty("--marked-blockquote-border-color",e.markedBlockquoteBorderColor),document.documentElement.style.setProperty("--marked-blockquote-background-color",e.markedBlockquoteBackgroundColor),document.documentElement.style.setProperty("--marked-blockquote-border-radius",e.markedBlockquoteBorderRadius),document.documentElement.style.setProperty("--marked-blockquote-padding",e.markedBlockquotePadding),document.documentElement.style.setProperty("--marked-blockquote-border-width",e.markedBlockquoteBorderWidth),document.documentElement.style.setProperty("--marked-blockquote-color",e.markedBlockquoteColor),document.documentElement.style.setProperty("--marked-link-color",e.markedLinkColor),document.documentElement.style.setProperty("--marked-link-hover-color",e.markedLinkHoverColor),document.documentElement.style.setProperty("--table-background",this._theme.background),document.documentElement.style.setProperty("--mcp-progress-bar-background",e.mcpProgressBarBackground),document.documentElement.style.setProperty("--mcp-progress-bar-background-light",e.mcpProgressBarBackgroundLight),document.documentElement.style.setProperty("--mcp-progress-bar-color",e.mcpProgressBarColor),document.documentElement.style.setProperty("--marked-link-color",e.markedLinkColor),document.documentElement.style.setProperty("--marked-link-hover-color",e.markedLinkHoverColor),document.documentElement.style.setProperty("--loading-screen-bg",e.backgroundHEX),document.documentElement.style.setProperty("--loading-screen-cursor",e.cursorHEX);const t=document.querySelector("#loading-screen .logo-cursor"),s=document.querySelector("#loading-screen .cursor");o.a.config&&o.a.config.brand&&o.a.config.brand.trim()?(t&&(t.src=o.a.config.brand,t.style.display="block",t.style.borderRadius="0.375rem",t.onerror=()=>{t.style.display="none",s&&(s.style.display="block")}),s&&(s.style.display="none")):(t&&(t.style.display="none"),s&&(s.style.display="block"))}static getThemeObject(e){return r.highlightThemes.find((t=>t.value===e))}injectCodeStyleSheet(e){e||(e="atom-one-dark-reasonable");const t=i.K.codeThemes.find((t=>t.value===e));if(t){let e=t.css;const s=document.createElement("link");s.rel="stylesheet",s.href=e,document.head.appendChild(s)}}get theme(){return this._theme}static async setTheme(e,t){try{const s={theme:e,theme_pref:t},i=await n.G.postData("/accounts/save_theme/",s);if(i&&"success"===i.status)window.theme_pref=i.theme_pref,window.theme=i.theme_object||null,window.theme&&window.theme.font&&l.setFont(window.theme.font),l.setDynamicCSS(),location.reload();else{const e=i&&i.message?i.message:"Error saving theme, please try again.";new a.y(e,"error")}}catch(e){new a.y("An unexpected error occurred while saving the theme.","error")}}static getTheme(e){return o.a.config?o.a.theme:i.K.themes.find((t=>t.id===e))}static isThemeSelected(e){return e===r.selectedTheme}}const l=new r,c=l},6153:()=>{document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("form"),t=document.querySelector("[name=csrfmiddlewaretoken]").value,s=e.querySelector('button[type="submit"]');let i;e.addEventListener("submit",(function(n){n.preventDefault();const a=e.querySelectorAll("input:not([name=csrfmiddlewaretoken]), select, textarea");let o=!0,r={};a.forEach((e=>{e.hasAttribute("required")&&!e.value.trim()?(o=!1,e.classList.add("border-red-500")):e.classList.remove("border-red-500"),r[e.name]=e.value.trim()})),o?(s.disabled=!0,i=function(e){let t=0;return setInterval((()=>{e.textContent="Sending message"+".".repeat(t),t=(t+1)%4}),500)}(s),fetch("/contactsubmission",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":t},body:JSON.stringify(r)}).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((t=>{if(clearInterval(i),"success"!==t.status)throw new Error(t.message||"An error occurred");e.innerHTML=`\n                        <div class="text-lefth-[300px]">\n                            <p>${t.message}</p>\n                        </div>\n                    `,window.scrollTo(0,0)})).catch((e=>{alert("An error occurred. Please try again later."),s.disabled=!1,s.textContent="Send Message",clearInterval(i)}))):alert("Please fill in all required fields.")}))}))},8255:()=>{document.addEventListener("DOMContentLoaded",(function(){const e=document.querySelector("form"),t=document.querySelector("[name=csrfmiddlewaretoken]").value,s=e.querySelector('button[type="submit"]');let i;const n=e.querySelectorAll("input:not([name=csrfmiddlewaretoken]), select, textarea");function a(){window.scrollTo({top:0,behavior:"smooth"})}function o(e,t){e.classList.add("border-red-500");const s=e.parentNode.querySelector(".error-message");s&&s.remove();const i=document.createElement("p");i.className="text-red-500 text-xs mt-1 error-message",i.textContent=t,e.parentNode.appendChild(i)}function r(e){e.classList.remove("border-red-500");const t=e.parentNode.querySelector(".error-message");t&&t.remove()}e.addEventListener("submit",(function(l){l.preventDefault();let c=!0,d={};document.querySelectorAll(".error-message").forEach((e=>e.remove())),n.forEach((e=>{e.hasAttribute("required")&&!e.value.trim()?(c=!1,o(e,"This field is required")):r(e),d[e.name]=e.value.trim()}));const h=document.getElementById("email");var m;if(h.value&&(m=h.value,!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(m).toLowerCase()))&&(c=!1,o(h,"Please enter a valid email address")),c)s.disabled=!0,i=function(e){let t=0;return setInterval((()=>{e.textContent="Submitting request"+".".repeat(t),t=(t+1)%4}),500)}(s),fetch("/sales_contact_submission",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":t},body:JSON.stringify(d)}).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((t=>{if(clearInterval(i),"success"!==t.status)throw new Error(t.message||"An error occurred");e.innerHTML=`\n                        <div class="text-center py-10">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />\n                            </svg>\n                            <h3 class="text-2xl font-semibold text-gray-800 mb-2">Thank You!</h3>\n                            <p class="text-gray-600 mb-6">${t.message}</p>\n                            <p class="text-gray-600">Our sales team will contact you shortly.</p>\n                        </div>\n                    `,a()})).catch((t=>{clearInterval(i);const n=document.createElement("div");n.className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6",n.innerHTML='\n                    <p class="font-medium">There was a problem submitting your request</p>\n                    <p class="text-sm">Please try again or contact us directly at sales@simtheory.ai</p>\n                ',e.insertBefore(n,e.firstChild),s.disabled=!1,s.innerHTML='\n            <span>Request Sales Consultation</span>\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />\n            </svg>\n        ',clearInterval(i),a()}));else{const t=e.querySelector(".border-red-500");t&&(t.scrollIntoView({behavior:"smooth",block:"center"}),t.focus())}})),n.forEach((e=>{e.addEventListener("input",(function(){r(e)}))}))}))},42019:()=>{const e=document.getElementById("loading"),t=document.getElementById("error"),s=document.getElementById("error-message"),i=document.getElementById("not-found"),n=document.getElementById("user-info"),a=document.getElementById("workspaces-section"),o=document.getElementById("workspaces-list"),r=document.getElementById("personal-plan-content"),l=document.getElementById("no-personal-plan"),c=document.getElementById("stripe-link");function d(e){if("N/A"===e||null==e)return"N/A";try{const t=Number(e);return isNaN(t)?"N/A":t>=1e6?(t/1e6).toFixed(1)+"M":t>=1e3?(t/1e3).toFixed(0)+"k":t.toString()}catch(e){return"N/A"}}function h(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString(void 0,{year:"numeric",month:"short",day:"numeric"})}catch(e){return"N/A"}}function m(a="Could not load data."){s.textContent=a,e.classList.add("hidden"),t.classList.remove("hidden"),i.classList.add("hidden"),n.classList.add("hidden"),HelpScout&&HelpScout.setAppHeight(t.offsetHeight+40)}function u(){e.classList.add("hidden"),t.classList.add("hidden"),i.classList.remove("hidden"),n.classList.add("hidden"),i.style.opacity=1,HelpScout&&HelpScout.setAppHeight(i.offsetHeight+40)}function p(s){if(!s||!s.found)return void u();document.getElementById("user-name").textContent=s.full_name||s.nickname||"N/A",document.getElementById("user-email").textContent=s.email||"N/A",document.getElementById("user-nickname").textContent=s.nickname||"N/A",document.getElementById("user-joined").textContent=h(s.created_at),document.getElementById("user-location").textContent=s.location||"N/A",document.getElementById("user-occupation").textContent=s.occupation||"N/A",s.stripe_customer_id?(c.href=`https://dashboard.stripe.com/customers/${s.stripe_customer_id}`,c.classList.remove("hidden")):(c.classList.add("hidden"),c.href="#");const m=s.personal_plan;if(m&&m.plan_id&&"admin"!==m.plan_id&&m.usage){r.classList.remove("hidden"),l.classList.add("hidden");let e=`${m.plan_id} (${m.plan_cycle||"N/A"})`;document.getElementById("plan-details").textContent=e;let t=m.plan_state||"N/A";m.will_cancel?t+=` (Cancels ${h(m.renewal_date)})`:m.renewal_date&&(t+=` (Renews ${h(m.renewal_date)})`),document.getElementById("plan-status").textContent=t,document.getElementById("usage-input").textContent=`${d(m.usage.frontier_input_used)} / ${d(m.usage.frontier_input_limit)}`,document.getElementById("usage-output").textContent=`${d(m.usage.frontier_output_used)} / ${d(m.usage.frontier_output_limit)}`,document.getElementById("usage-images").textContent=`${d(m.usage.premium_images_used)} / ${d(m.usage.premium_images_limit)}`}else r.classList.add("hidden"),l.classList.remove("hidden"),m&&m.plan_id&&"admin"!==m.plan_id&&m.usage;o.innerHTML="",s.workspaces&&s.workspaces.length>0?(a.classList.remove("hidden"),s.workspaces.forEach((e=>{const t=document.createElement("div");t.className="p-3 border border-gray-200 dark:border-gray-600 rounded-md bg-gray-50 dark:bg-gray-700/50 shadow-sm",t.innerHTML=`\n                <div class="flex justify-between items-center mb-1.5">\n                    <span class="font-semibold text-sm text-gray-800 dark:text-gray-100">${e.name||"N/A"}</span>\n                    <span class="text-xs px-2 py-0.5 rounded-full ${e.is_active?"bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-300":"bg-red-100 text-red-800 dark:bg-red-900 dark:text-red-300"}">${e.is_active?"Active":"Inactive"}</span>\n                </div>\n                <div class="text-xs text-gray-600 dark:text-gray-400 space-y-1">\n                    <div><strong class="font-medium text-gray-500 dark:text-gray-300">Plan:</strong> ${e.plan_type||"N/A"}</div>\n                    <div><strong class="font-medium text-gray-500 dark:text-gray-300">Role:</strong> ${e.user_role||"N/A"}</div>\n                    <div><strong class="font-medium text-gray-500 dark:text-gray-300">Members:</strong> ${e.total_members||"N/A"}/${e.total_seats||"N/A"}</div>\n                </div>\n            `,o.appendChild(t)}))):a.classList.add("hidden"),e.classList.add("hidden"),t.classList.add("hidden"),i.classList.add("hidden"),n.classList.remove("hidden"),setTimeout((()=>{if(n.style.opacity=1,HelpScout){const e=n.scrollHeight+40;HelpScout.setAppHeight(e)}}),50)}async function g(s){if(!s)return void m("Could not get customer email from Help Scout.");e.classList.remove("hidden"),t.classList.add("hidden"),i.classList.add("hidden"),n.classList.add("hidden"),n.style.opacity=0,i.style.opacity=0,HelpScout&&HelpScout.setAppHeight(100);let a=`/api/v1/helpscout/user-info/?email=${encodeURIComponent(s)}&simt1=c9d8b9b855b5a818635729cb7b6605d9`;a=`https:/simtheory.ai${a}`;try{const e=await fetch(a);if(403===e.status)throw new Error("Not authorized to fetch user data.");if(404===e.status)return void u();if(500===e.status)throw new Error("An internal server error occurred on the server.");const t=await e.json();t.found?p(t):u()}catch(e){m(e.message)}}function f(e){let t=null;t=e?.customer?.emails?.[0]?.value||e?.conversation?.customers?.[0]?.emails?.[0]?.value||null,t?g(t):u()}HelpScout?(HelpScout.getApplicationContext().then(f).catch((e=>{m("Could not get Help Scout context.")})),HelpScout.watchApplicationContext(f)):m("HelpScout SDK failed to initialize.")},31840:()=>{document.addEventListener("DOMContentLoaded",(function(){if(document.querySelector(".home-page")){const a=document.querySelectorAll("#imageContainer img");let o=0;a.length>1?(a.forEach(((e,t)=>{0===t?(e.classList.add("opacity-100"),e.classList.remove("opacity-0")):(e.classList.add("opacity-0"),e.classList.remove("opacity-100"))})),setInterval((function(){0!==a.length&&(a[o].classList.remove("opacity-100"),a[o].classList.add("opacity-0"),o=(o+1)%a.length,a[o].classList.remove("opacity-0"),a[o].classList.add("opacity-100"))}),5e3)):1===a.length&&(a[0].classList.add("opacity-100"),a[0].classList.remove("opacity-0"));const r=document.querySelectorAll("#desktopImageContainer img");let l=0;r.length>1?(r.forEach(((e,t)=>{0===t?(e.classList.add("opacity-100"),e.classList.remove("opacity-0")):(e.classList.add("opacity-0"),e.classList.remove("opacity-100"))})),setInterval((function(){0!==r.length&&(r[l].classList.remove("opacity-100"),r[l].classList.add("opacity-0"),l=(l+1)%r.length,r[l].classList.remove("opacity-0"),r[l].classList.add("opacity-100"))}),5e3)):1===r.length&&(r[0].classList.add("opacity-100"),r[0].classList.remove("opacity-0"))}const e=document.querySelectorAll(".feature-btn"),t=document.querySelector(".aspect-video");if(t&&e.length>0){function s(s,i){let n=t.querySelector(".loading-overlay");n||(n=document.createElement("div"),n.className="loading-overlay absolute inset-0 bg-white/50 flex items-center justify-center rounded-lg z-10",n.innerHTML='<div class="w-10 h-10 border-4 border-gray-200 border-t-blue-500 rounded-full animate-spin"></div>',t.appendChild(n)),n.classList.remove("hidden"),e.forEach((e=>{e.dataset.video===s?(e.classList.add("bg-blue-100"),e.classList.remove("hover:bg-gray-100")):(e.classList.remove("bg-blue-100"),e.classList.add("hover:bg-gray-100"))}));const a=document.getElementById("featureVideo");a&&(a.pause(),a.removeAttribute("src"),a.load(),a.remove());const o=document.createElement("video");o.id="featureVideo",o.className="w-full h-full rounded-lg object-cover transition-opacity duration-200 relative z-0",o.setAttribute("playsinline",""),o.setAttribute("webkit-playsinline",""),o.setAttribute("muted",""),o.muted=!0,o.setAttribute("autoplay",""),o.setAttribute("loop",""),o.setAttribute("preload","auto"),i&&o.setAttribute("poster",i);const r=document.createElement("source");r.src=s,r.type="video/mp4",o.appendChild(r),n?t.insertBefore(o,n):t.insertBefore(o,t.firstChild),o.addEventListener("canplay",(function e(){n&&n.classList.add("hidden");const t=o.play();void 0!==t&&t.catch((e=>{o.addEventListener("click",(()=>o.play()),{once:!0})})),o.removeEventListener("canplay",e)})),o.addEventListener("error",(e=>{n&&n.classList.add("hidden")})),o.addEventListener("webkitbeginfullscreen",(e=>e.preventDefault())),o.addEventListener("webkitendfullscreen",(()=>{o.setAttribute("playsinline",""),o.setAttribute("webkit-playsinline","")})),o.load()}e.forEach((e=>{e.addEventListener("click",(function(){const e=this.dataset.video,t=this.dataset.poster;e&&s(e,t)}))}));const c=e[0];if(c){const d=c.dataset.video,h=c.dataset.poster;d&&setTimeout((()=>s(d,h)),0)}if(!document.getElementById("video-fullscreen-style")){const m=document.createElement("style");m.id="video-fullscreen-style",m.textContent="\n                video::-webkit-media-controls-fullscreen-button { display: none !important; }\n                video::-webkit-media-controls-play-button { } /* Keep play if needed */\n                video::-webkit-media-controls-panel { /* display: none !important; */ } /* Hide entire panel if desired */\n                video::-webkit-media-controls { display: none !important; } /* Hide all controls for max effect */\n\n            ",document.head.appendChild(m)}}const i=document.getElementById("render-model-catalogue");function n(e){if(null==e)return"N/A";try{const t=parseInt(e,10);return isNaN(t)?"N/A":t>=1e6?`${(t/1e6).toFixed(1).replace(/\.0$/,"")}M`:t>=1e3?`${(t/1e3).toFixed(0)}K`:t.toString()}catch(e){return"N/A"}}i&&fetch("/get/model-catalogue/").then((e=>{if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);return e.json()})).then((e=>{!function(e,t){if(t.innerHTML="",!e||!e.labs||0===e.labs.length)return void(t.innerHTML='<div class="col-span-full text-center py-8"><p class="text-gray-500">No models available.</p></div>');e.labs.forEach((e=>{const s=document.createElement("div");if(s.className="col-span-1 md:col-span-2 lg:col-span-3 mt-6 first:mt-0 mb-4",s.innerHTML=`<h3 class="text-xl font-semibold text-gray-800">${e.name}</h3>`,t.appendChild(s),!e.models||0===e.models.length){const e=document.createElement("div");return e.className="col-span-1 md:col-span-2 lg:col-span-3 text-gray-500 text-sm mb-4",e.textContent="No models currently listed for this lab.",void t.appendChild(e)}e.models.forEach((e=>{const s=document.createElement("div"),i=document.createElement("a");i.href=`/model-card/${e.codename}/`,i.className="block h-full transition duration-150 ease-in-out";const a=document.createElement("div");a.className="bg-white rounded-lg border border-gray-200 p-4 hover:shadow-lg hover:border-gray-300 h-full flex flex-col";let o="";o=e.img_path?`\n                        <div class="flex-shrink-0 mb-3 h-10 w-10 flex items-center justify-center">\n                            <img src="${e.img_path}" alt="${e.name} logo" class="max-h-full max-w-full object-contain rounded-full">\n                        </div>`:'<div class="flex-shrink-0 mb-3 h-10 w-10 rounded-full bg-gray-100"></div>';let r="";e.frontier&&(r+='<span class="ml-2 px-2 py-0.5 bg-indigo-100 text-indigo-800 text-xs font-medium rounded-full">Frontier</span>'),e.supports_vision&&(r+='<span class="ml-2 px-2 py-0.5 bg-teal-100 text-teal-800 text-xs font-medium rounded-full">Vision</span>'),a.innerHTML=`\n                    ${o}\n                    <h4 class="text-base font-semibold text-gray-900">${e.name}${r}</h4>\n                    <p class="text-sm text-gray-600 mt-1 mb-3 flex-grow">${e.description||"No description available."}</p>\n                    <div class="mt-auto text-xs text-gray-500"> {/* mt-auto pushes this div to bottom */}\n                        <div class="flex flex-wrap gap-2">\n                            <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded-md">Context: ${n(e.max_context_size)}</span>\n                            <span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded-md">Output: ${n(e.max_output_size)}</span>\n                            ${e.knowledge_cutoff?`<span class="inline-flex items-center px-2 py-1 bg-gray-100 text-gray-700 rounded-md">Cutoff: ${e.knowledge_cutoff}</span>`:""}\n                        </div>\n                    </div>\n                `,i.appendChild(a),s.appendChild(i),t.appendChild(s)}))}))}(e,i)})).catch((e=>{i.innerHTML=`\n                    <div class="col-span-1 md:col-span-2 lg:col-span-3 text-center py-8">\n                        <p class="text-red-600">Could not load model catalogue. ${e.message}</p>\n                    </div>`}))}))},30049:()=>{document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("ticket-modal-overlay"),t=document.getElementById("open-ticket-modal"),s=document.getElementById("close-ticket-modal"),i=document.getElementById("cancel-ticket"),n=e.querySelector("form"),a=n.querySelector("[name=csrfmiddlewaretoken]").value,o=n.querySelector('button[type="submit"]');let r;const l=n.querySelectorAll("input:not([name=csrfmiddlewaretoken]), select, textarea");function c(){e.classList.add("hidden"),document.body.classList.remove("overflow-hidden"),n.reset(),document.querySelectorAll(".error-message").forEach((e=>e.remove())),l.forEach((e=>{e.classList.remove("border-red-500")}))}function d(){window.scrollTo({top:0,behavior:"smooth"})}function h(e,t){e.classList.add("border-red-500");const s=e.parentNode.querySelector(".error-message");s&&s.remove();const i=document.createElement("p");i.className="text-red-500 text-xs mt-1 error-message",i.textContent=t,e.parentNode.appendChild(i)}function m(e){e.classList.remove("border-red-500");const t=e.parentNode.querySelector(".error-message");t&&t.remove()}t.addEventListener("click",(function(){e.classList.remove("hidden"),document.body.classList.add("overflow-hidden"),e.classList.add("animate-fadeIn"),document.getElementById("ticket-modal").classList.add("animate-slideIn")})),s.addEventListener("click",c),i.addEventListener("click",c),e.addEventListener("click",(function(t){t.target===e&&c()})),document.addEventListener("keydown",(function(t){"Escape"!==t.key||e.classList.contains("hidden")||c()})),n.addEventListener("submit",(function(e){e.preventDefault();let t=!0,s={};document.querySelectorAll(".error-message").forEach((e=>e.remove())),l.forEach((e=>{e.hasAttribute("required")&&!e.value.trim()?(t=!1,h(e,"This field is required")):m(e),s[e.name]=e.value.trim()}));const i=document.getElementById("email");var u;if(i.value&&(u=i.value,!/^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/.test(String(u).toLowerCase()))&&(t=!1,h(i,"Please enter a valid email address")),t)o.disabled=!0,r=function(e){let t=0;return setInterval((()=>{e.textContent="Submitting ticket"+".".repeat(t),t=(t+1)%4}),500)}(o),fetch("/support_ticket_submission",{method:"POST",headers:{"Content-Type":"application/json","X-CSRFToken":a},body:JSON.stringify(s)}).then((e=>{if(!e.ok)throw new Error("Network response was not ok");return e.json()})).then((e=>{if(clearInterval(r),"success"!==e.status)throw new Error(e.message||"An error occurred");n.parentNode.innerHTML=`\n                        <div class="text-center py-10">\n                            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 text-green-500 mx-auto mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />\n                            </svg>\n                            <h3 class="text-2xl font-semibold text-gray-800 mb-2">Ticket Submitted!</h3>\n                            <p class="text-gray-600 mb-6">${e.message}</p>\n                            <button id="close-success" class="px-5 py-2.5 bg-blue-600 hover:bg-blue-700 text-white font-medium rounded-lg transition duration-300">\n                                Close\n                            </button>\n                        </div>\n                    `,document.getElementById("close-success").addEventListener("click",c),d()})).catch((e=>{clearInterval(r);const t=document.createElement("div");t.className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded mb-6",t.innerHTML='\n                    <p class="font-medium">There was a problem submitting your ticket</p>\n                    <p class="text-sm">Please try again or contact us directly at support@simtheory.ai</p>\n                ',n.insertBefore(t,n.firstChild),o.disabled=!1,o.innerHTML='\n            <span>Submit Ticket</span>\n            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ml-2" viewBox="0 0 20 20" fill="currentColor">\n                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd" />\n            </svg>\n        ',clearInterval(r),d()}));else{const e=n.querySelector(".border-red-500");e&&(e.scrollIntoView({behavior:"smooth",block:"center"}),e.focus())}})),l.forEach((e=>{e.addEventListener("input",(function(){m(e)}))}))}))},84132:(e,t,s)=>{"use strict";var i=s(53005);document.addEventListener("DOMContentLoaded",(()=>{const e=document.getElementById("primary-content");if(e){const t=e.dataset.mode||"signup",s=e.dataset.workspaceContext||null;new i.l(t,s)}}))},90189:()=>{document.addEventListener("DOMContentLoaded",(function(){const e=document.getElementById("mobile-menu-button"),t=document.getElementById("mobile-menu"),s=document.getElementById("mobile-menu-icon"),i=document.getElementById("features-menu"),n=document.getElementById("features-dropdown"),a=document.getElementById("workspace-menu"),o=document.getElementById("workspaces-dropdown"),r=document.getElementById("mobile-features-button"),l=document.getElementById("mobile-features-content"),c=document.getElementById("mobile-workspaces-button"),d=document.getElementById("mobile-workspaces-content"),h=()=>t&&!t.classList.contains("hidden");function m(e,t){e&&(e.style.transform=t?"rotate(180deg)":"rotate(0deg)")}function u(e,t){if(!e||!t||t.children.length>0)return;const s=e.querySelectorAll("a"),i=document.createDocumentFragment();s.forEach((e=>{if(e.closest(".border-t"))return;const t=e.cloneNode(!0);t.className="block py-2 text-base pl-4 text-gray-800 hover:text-[#3650E8]";const s=t.querySelector("p");s&&(s.className="text-sm text-gray-500 mt-0.5");const n=t.querySelector(".flex-shrink-0");n&&n.remove(),i.appendChild(t)})),t.appendChild(i)}function p(){const e=document.querySelector("nav"),s=e?e.offsetHeight:68,i=window.innerHeight-s;[n,o].forEach((e=>{e&&(e.style.top=`${s}px`,e.style.maxHeight=i-20+"px")})),t&&(t.style.top=`${s}px`,t.style.maxHeight=`${i}px`)}function g(e){t&&s&&(e?(p(),t.classList.remove("hidden"),s.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />\n        </svg>',document.body.style.overflow="hidden",u(n,l),u(o,d)):(t.classList.add("hidden"),s.innerHTML='\n        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />\n        </svg>',document.body.style.overflow="",l&&l.classList.add("hidden"),r&&m(r.querySelector("svg"),!1),d&&d.classList.add("hidden"),c&&m(c.querySelector("svg"),!1)))}function f(e,t){e&&t&&e.addEventListener("click",(s=>{s.preventDefault(),s.stopPropagation();const r=!t.classList.contains("hidden");n&&n.classList.add("hidden"),o&&o.classList.add("hidden"),i&&m(i.querySelector("svg"),!1),a&&m(a.querySelector("svg"),!1),r||(t.classList.remove("hidden"),m(e.querySelector("svg"),!0),p())}))}function v(e,t){e&&t&&e.addEventListener("click",(s=>{s.stopPropagation();const i=!t.classList.contains("hidden");e===r?(d&&d.classList.add("hidden"),c&&m(c.querySelector("svg"),!1)):(l&&l.classList.add("hidden"),r&&m(r.querySelector("svg"),!1)),t.classList.toggle("hidden"),m(e.querySelector("svg"),!i)}))}e&&e.addEventListener("click",(e=>{e.stopPropagation(),g(!h())})),f(i,n),f(a,o),v(r,l),v(c,d),document.addEventListener("click",(()=>{n&&n.classList.add("hidden"),o&&o.classList.add("hidden"),i&&m(i.querySelector("svg"),!1),a&&m(a.querySelector("svg"),!1),h()&&g(!1)})),[t,n,o].forEach((e=>{e&&e.addEventListener("click",(e=>e.stopPropagation()))})),window.addEventListener("resize",(()=>{p(),window.innerWidth>=1024&&h()&&g(!1)})),p()}))}},n={};function a(e){var t=n[e];if(void 0!==t)return t.exports;var s=n[e]={id:e,loaded:!1,exports:{}};return i[e].call(s.exports,s,s.exports,a),s.loaded=!0,s.exports}a.m=i,e=[],a.O=(t,s,i,n)=>{if(!s){var o=1/0;for(d=0;d<e.length;d++){for(var[s,i,n]=e[d],r=!0,l=0;l<s.length;l++)(!1&n||o>=n)&&Object.keys(a.O).every((e=>a.O[e](s[l])))?s.splice(l--,1):(r=!1,n<o&&(o=n));if(r){e.splice(d--,1);var c=i();void 0!==c&&(t=c)}}return t}n=n||0;for(var d=e.length;d>0&&e[d-1][2]>n;d--)e[d]=e[d-1];e[d]=[s,i,n]},a.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return a.d(t,{a:t}),t},a.d=(e,t)=>{for(var s in t)a.o(t,s)&&!a.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},a.f={},a.e=e=>Promise.all(Object.keys(a.f).reduce(((t,s)=>(a.f[s](e,t),t)),[])),a.u=e=>e+".js",a.miniCssF=e=>{},a.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),a.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),t={},s="simtheory:",a.l=(e,i,n,o)=>{if(t[e])t[e].push(i);else{var r,l;if(void 0!==n)for(var c=document.getElementsByTagName("script"),d=0;d<c.length;d++){var h=c[d];if(h.getAttribute("src")==e||h.getAttribute("data-webpack")==s+n){r=h;break}}r||(l=!0,(r=document.createElement("script")).charset="utf-8",r.timeout=120,a.nc&&r.setAttribute("nonce",a.nc),r.setAttribute("data-webpack",s+n),r.src=e),t[e]=[i];var m=(s,i)=>{r.onerror=r.onload=null,clearTimeout(u);var n=t[e];if(delete t[e],r.parentNode&&r.parentNode.removeChild(r),n&&n.forEach((e=>e(i))),s)return s(i)},u=setTimeout(m.bind(null,void 0,{type:"timeout",target:r}),12e4);r.onerror=m.bind(null,r.onerror),r.onload=m.bind(null,r.onload),l&&document.head.appendChild(r)}},a.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.nmd=e=>(e.paths=[],e.children||(e.children=[]),e),a.p="static/release/",(()=>{var e={9121:0,8228:0};a.f.j=(t,s)=>{var i=a.o(e,t)?e[t]:void 0;if(0!==i)if(i)s.push(i[2]);else if(8228!=t){var n=new Promise(((s,n)=>i=e[t]=[s,n]));s.push(i[2]=n);var o=a.p+a.u(t),r=new Error;a.l(o,(s=>{if(a.o(e,t)&&(0!==(i=e[t])&&(e[t]=void 0),i)){var n=s&&("load"===s.type?"missing":s.type),o=s&&s.target&&s.target.src;r.message="Loading chunk "+t+" failed.\n("+n+": "+o+")",r.name="ChunkLoadError",r.type=n,r.request=o,i[1](r)}}),"chunk-"+t,t)}else e[t]=0},a.O.j=t=>0===e[t];var t=(t,s)=>{var i,n,[o,r,l]=s,c=0;if(o.some((t=>0!==e[t]))){for(i in r)a.o(r,i)&&(a.m[i]=r[i]);if(l)var d=l(a)}for(t&&t(s);c<o.length;c++)n=o[c],a.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return a.O(d)},s=self.webpackChunksimtheory=self.webpackChunksimtheory||[];s.forEach(t.bind(null,0)),s.push=t.bind(null,s.push.bind(s))})()})();